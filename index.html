<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal Madame Solomi'na</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Solomi'na">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <meta name="theme-color" content="#3498db">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --accent-orange: #e67e22;
            --accent-red: #e74c3c;
            --accent-gradient: linear-gradient(135deg, #3498db, #2980b9);
            --header-gradient: linear-gradient(135deg, #f8f9fa, #e9ecef);
            --header-light-gradient: linear-gradient(135deg, #e3f2fd, #f0f9ff); 
            --graphite-color: #303D4F;
            --input-color: #3a506b;
            --card-shadow: rgba(0,0,0,0.06);
            --border-color: rgba(0,0,0,0.04);
            --item-border: #f0f0f0;
            --nav-bg: rgba(255, 255, 255, 0.95);
            --nav-border: rgba(255, 255, 255, 0.5);
            --nav-icon-inactive: #bdc3c7;
            --coupon-blue-bg: rgba(52, 152, 219, 0.08);
            --badge-blue-bg: rgba(52, 152, 219, 0.15);
            --badge-green-bg: rgba(46, 204, 113, 0.15);
        }
    

        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-green: #4ade80;
            --accent-yellow: #fcd34d;
            --accent-orange: #fb923c;
            --accent-red: #f87171;
            --accent-gradient: linear-gradient(135deg, #38bdf8, #0ea5e9);
            --header-gradient: linear-gradient(135deg, #1e293b, #2d3748);
            --header-light-gradient: linear-gradient(135deg, #1e293b, #334155);
            --graphite-color: #303D4F;
            --input-color: #f8fafc;
            --card-shadow: rgba(0,0,0,0.4);
            --border-color: rgba(255,255,255,0.05);
            --item-border: #334155;
            --nav-bg: rgba(30, 41, 59, 0.95);
            --nav-border: rgba(255, 255, 255, 0.1);
            --nav-icon-inactive: #475569;
            --coupon-blue-bg: rgba(56, 189, 248, 0.1);
            --badge-blue-bg: rgba(56, 189, 248, 0.15);
            --badge-green-bg: rgba(74, 222, 128, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 16px; line-height: 1.4;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 120px;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        .toast {
            position: fixed;
            top: 20px; left: 50%; transform: translateX(-50%);
            background: #2ecc71; color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 12px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .toast.show { opacity: 1; visibility: visible; }

        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .terminal-header { padding: 10px 10px 30px; text-align: left; }
        .terminal-badge {
            display: inline-flex;
            align-items: center; gap: 6px; padding: 4px 10px;
            background: var(--accent-blue); color: white; font-size: 10px; font-weight: 900;
            border-radius: 4px; text-transform: uppercase;
            margin-bottom: 12px; letter-spacing: 1px;
        }

        .market-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #ccc; }
        .dot-online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; animation: pulse 2s infinite; }
        .dot-offline { background: #e74c3c; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .home-title { font-size: 26px; font-weight: 800; margin-bottom: 15px; line-height: 1.2; }
        .home-desc { font-size: 15px; color: #8e8e93; line-height: 1.6; margin-bottom: 25px; }
        
        .market-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .market-item-modern {
            background: var(--card-bg);
            border-radius: 16px; padding: 12px 16px;
            position: relative; overflow: hidden; box-shadow: 0 6px 15px var(--card-shadow);
            border: 1px solid var(--border-color); display: flex;
            flex-direction: row; align-items: center; justify-content: space-between;
        }
        .market-item-modern::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 4px; height: 100%;
        }
        .market-item-modern.blue::before { background: var(--accent-blue); }
        .market-item-modern.green::before { background: var(--accent-green); }
        .market-item-modern.orange::before { background: #f39c12; }
        
        .mk-left { display: flex; flex-direction: column; gap: 4px; }
        .mk-label {
            font-size: 14px; font-weight: 700; color: var(--text-main); letter-spacing: 0px;
            text-transform: none; margin-bottom: 0;
        }
        .mk-val {
            font-size: 16px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px;
        }
        .mk-dynamics {
            font-size: 12px; font-weight: 700; padding: 4px 8px; border-radius: 8px;
        }
        .mk-dynamics.positive { background: var(--badge-green-bg); color: var(--accent-green); }
        .mk-dynamics.negative { background: rgba(231, 76, 60, 0.1); color: var(--accent-red); }
        .mk-dynamics.neutral { background: rgba(0,0,0,0.05); color: var(--text-secondary); }
        .dark-mode .mk-dynamics.neutral { background: rgba(255,255,255,0.1); }
        
        .rates-vertical-block {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px var(--card-shadow);
            border: 1px solid var(--border-color);
        }
        .rv-title {
            font-size: 11px; color: #8e8e93; font-weight: 700; text-transform: uppercase;
            margin-bottom: 12px; letter-spacing: 0.5px;
        }
        .rv-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .rv-item {
            display: flex; flex-direction: column; gap: 4px;
            background: rgba(0,0,0,0.02); padding: 10px; border-radius: 12px;
        }
        .dark-mode .rv-item { background: rgba(255,255,255,0.03); }
        .rv-item span { font-size: 10px; color: #8e8e93; font-weight: 600; }
        .rv-item b { font-size: 15px; color: var(--text-main); font-weight: 800; }

        .info-card {
            background: var(--card-bg);
            padding: 20px; border-radius: 20px; margin-bottom: 15px;
            border: 1px solid var(--border-color); box-shadow: 0 5px 15px var(--card-shadow); 
            position: relative; overflow: hidden; transition: transform 0.2s;
        }
        .info-card:active { transform: scale(0.99); }
        .info-card.bonds { border-left: 4px solid var(--accent-blue); background: linear-gradient(to right, rgba(52, 152, 219, 0.03), var(--card-bg)); }
        .info-card.stocks { border-left: 4px solid var(--accent-green); background: linear-gradient(to right, rgba(46, 204, 113, 0.03), var(--card-bg)); }

        .info-card-header { font-size: 18px; font-weight: 800; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .bonds .info-card-header { color: var(--accent-blue); }
        .stocks .info-card-header { color: var(--accent-green); }

        .info-card-sub-clean { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 10px 0; opacity: 0.7; }
        .bonds .info-card-sub-clean { color: var(--accent-blue); }
        .stocks .info-card-sub-clean { color: var(--accent-green); }
        
        .info-card-text { font-size: 13px; line-height: 1.6; color: var(--text-main); margin-bottom: 15px; opacity: 0.8; }
        
        .info-card-badge {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 900; letter-spacing: 0.5px;
        }
        .badge-blue { background: var(--badge-blue-bg); color: var(--accent-blue); }
        .badge-green { background: var(--badge-green-bg); color: var(--accent-green); }

        .btn-action {
            display: flex; align-items: center; justify-content: center; width: 100%; padding: 16px; margin-top: 12px;
            background: var(--coupon-blue-bg); color: var(--accent-blue);
            border: 1px solid var(--accent-blue); border-radius: 16px;
            font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; gap: 8px;
        }
        .btn-action:active { opacity: 0.7; transform: scale(0.98); }

        @keyframes shimmerBtn {
            0% { box-shadow: 0 12px 25px rgba(48, 61, 79, 0.3); transform: scale(1); }
            50% { box-shadow: 0 12px 30px rgba(48, 61, 79, 0.5); transform: scale(1.01); }
            100% { box-shadow: 0 12px 25px rgba(48, 61, 79, 0.3); transform: scale(1); }
        }

        .btn-graphite {
            position: relative;
            background: var(--graphite-color); color: white; border: none; overflow: hidden;
            box-shadow: 0 12px 25px rgba(48, 61, 79, 0.3); margin-top: 25px;
            padding: 20px; font-size: 16px; border-radius: 20px;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            width: 100%; box-sizing: border-box; font-weight: 900;
            animation: shimmerBtn 3s infinite ease-in-out;
            cursor: pointer;
        }
        .btn-graphite svg { width: 32px; height: 32px; fill: none; stroke: white; stroke-width: 2; }
        .btn-graphite:active { transform: scale(0.98); animation: none; }

        .start-expl { font-size: 11px; color: #8e8e93; text-align: center; margin-top: 15px; padding: 0 10px; line-height: 1.5; }

        .header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 20px; margin-bottom: 4px; }
        
        .calc-box {
            background: var(--card-bg); padding: 24px; border-radius: 24px;
            box-shadow: 0 15px 35px var(--card-shadow); margin-bottom: 25px; border: 1px solid var(--border-color);
        }
        .calc-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .input-container { flex: 1; }
        .input-label { font-size: 13px; color: #8e8e93; font-weight: 600; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-wrapper { display: flex; align-items: baseline; gap: 8px; }
        input#sumInput { 
            border: none; font-size: 34px; font-weight: 700; width: 100%; outline: none; 
            color: var(--input-color); background: transparent; margin: 0; padding: 0; line-height: 1;
        }
        .currency { font-size: 28px; color: #d1d1d6; font-weight: 500; }

        .usage-bar-container { margin-bottom: 20px; }
        .usage-label { font-size: 10px; color: #8e8e93; display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: bold; }
        .usage-track { height: 4px; background: #eee; border-radius: 2px; overflow: hidden; }
        #usageFill { height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s; }

        .fee-selector { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--item-border); }
        .fee-label { font-size: 11px; color: #8e8e93; font-weight: bold; margin-bottom: 8px; display: block; text-transform: uppercase; }
        .fee-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
        .fee-btn {
            padding: 6px 10px; border-radius: 8px; border: 1px solid #e1e8ed; background: var(--card-bg);
            font-size: 11px; font-weight: 600; color: #5d7185; cursor: pointer; transition: all 0.2s;
        }
        .fee-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }

        .chart-mini {
            width: 60px; height: 60px; border-radius: 18px; 
            background: conic-gradient(var(--accent-blue) 0% 50%, var(--accent-green) 50% 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.2); flex-shrink: 0; margin-left: 15px;
            transition: background 0.3s; cursor: pointer;
        }
        .chart-mini::after { content: attr(data-pct); font-size: 10px; font-weight: 900; color: white; }

        .ratio-control { padding-top: 5px; }
        .ratio-slider {
            -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px;
            background: #e0e0e0; outline: none; margin: 15px 0;
        }
        .ratio-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--accent-blue); cursor: pointer; border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .slider-hint-wrapper { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 8px; 
        }
        .slider-hint { font-size: 10px; color: #8e8e93; text-align: center; }
        .preset-dropdown-btn {
            width: 24px; height: 24px; border-radius: 50%; background: var(--accent-blue);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.3s;
        }
        .preset-dropdown-btn.open { transform: rotate(180deg); }
        .preset-dropdown-btn svg { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        
        .preset-options {
            display: none; margin-top: 15px; background: var(--card-bg);
            border-radius: 16px; padding: 12px; gap: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 20px var(--card-shadow);
        }
        .preset-options.show { display: flex; flex-direction: column; }
        
        .preset-btn-modern {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px; border-radius: 12px; border: 1px solid var(--item-border);
            background: var(--bg-color); cursor: pointer; 
            transition: transform 0.1s, border-color 0.2s; /* Removed background transition to avoid flicker */
        }
        
        .preset-btn-modern.selected-preset {
            border: 2px solid var(--accent-blue);
            background: transparent !important;
            box-shadow: none;
        }
        .preset-btn-modern.selected-preset .preset-right {
            color: var(--accent-blue);
        }
        
        /* Updated Hover/Active states to prevent flicker */
        .preset-btn-modern:hover:not(.selected-preset) {
            background: var(--accent-blue); border-color: var(--accent-blue);
        }
        .preset-btn-modern:hover:not(.selected-preset) .preset-left { color: white; }
        .preset-btn-modern:hover:not(.selected-preset) .preset-right { color: rgba(255,255,255,0.8); }
        .preset-btn-modern:hover:not(.selected-preset) .preset-icon { background: rgba(255,255,255,0.2); }
        
        /* Active state now only scales, no color change to prevent flash */
        .preset-btn-modern:active:not(.selected-preset) {
            transform: scale(0.98);
            /* No background change here to avoid flickering to blue and back */
        }

        .preset-left { display: flex; align-items: center; gap: 12px; color: var(--text-main); }
        .preset-icon {
            width: 36px; height: 36px; border-radius: 10px;
            background: var(--coupon-blue-bg); display: flex; align-items: center; justify-content: center;
            font-size: 16px;
        }
        .preset-title { font-weight: 700; font-size: 14px; }
        .preset-subtitle { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .preset-right { font-size: 18px; font-weight: 800; color: var(--accent-blue); }
        .preset-footer-hint { font-size: 10px; color: #8e8e93; text-align: center; margin-top: 8px; font-style: italic; }

        #shareContainer { background: var(--bg-color); padding: 5px 10px 20px; border-radius: 10px; }
        .asset-list { background: var(--card-bg); border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
        .asset-item {
            display: grid; grid-template-columns: 85px 1fr 75px 80px; padding: 12px; 
            border-bottom: 1px solid var(--item-border); font-size: 12px; align-items: center;
        }
        .asset-item:last-child { border-bottom: none; }
        .ticker { font-weight: bold; color: var(--text-main); }
        .asset-name { color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .qty { text-align: right; padding-right: 8px; font-weight: bold; color: var(--accent-blue); }
        .price-total { text-align: right; color: var(--text-main); font-weight: 500; }
        
        .asset-yield-badge {
            background: rgba(46, 204, 113, 0.15); color: var(--accent-green);
            font-weight: 800; font-size: 11px; padding: 4px 8px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; width: 100%;
            box-sizing: border-box;
        }
        .asset-yield-badge.blue { background: rgba(52, 152, 219, 0.15); color: var(--accent-blue); }

        .details {
            grid-column: 1 / -1; display: none; background: rgba(0,0,0,0.02);
            padding: 12px; border-top: 1px solid var(--item-border); font-size: 11px;
            color: #8e8e93; line-height: 1.8;
        }
        .asset-item.active .details { display: block; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(0,0,0,0.05); padding: 2px 0; }
        .detail-row span:last-child { color: var(--text-main); font-weight: 600; }
        
        .btn-tiny-graph {
             background: var(--accent-blue); color: white; border: none;
             padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: bold;
             margin-top: 8px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center;
             gap: 4px; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.2);
        }

        .section-header-highlight {
            margin: 25px 0 8px; padding: 12px 16px; border-radius: 16px;
            font-weight: 800; font-size: 16px; 
            background: var(--header-light-gradient); color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid rgba(52, 152, 219, 0.2);
            display: flex; align-items: center; justify-content: space-between;
        }
        .section-desc-small { font-size: 11px; color: #8e8e93; margin-bottom: 12px; padding: 0 5px; line-height: 1.4; }

        .section-header-styled {
            margin: 25px 0 12px; background: linear-gradient(135deg, #ffffff, #f0f2f5);
            padding: 14px 16px; border-radius: 16px;
            font-weight: 900; font-size: 16px; display: flex; align-items: center; justify-content: space-between;
            color: var(--graphite-color); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .dark-mode .section-header-styled {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: #f1f5f9; border-color: rgba(255,255,255,0.1);
        }
        
        .info-expanded-block {
            display: none;
            background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 15px;
            border: 1px solid var(--accent-blue); font-size: 12px; line-height: 1.5; color: var(--text-secondary);
            animation: fadeIn 0.3s ease;
        }
        .info-expanded-block.show { display: block; }
        
        .echelon-info-graphic {
            display: flex; flex-direction: column; gap: 10px; margin-top: 10px;
        }
        .eig-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px; border-radius: 16px;
            background: linear-gradient(135deg, var(--bg-color), rgba(255,255,255,0.5));
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .eig-item:active { transform: scale(0.98); }
        .eig-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0; width: 4px;
        }
        .eig-item.e1::before { background: linear-gradient(180deg, #2ecc71, #27ae60); }
        .eig-item.e2::before { background: linear-gradient(180deg, #3498db, #2980b9); }
        .eig-item.e3::before { background: linear-gradient(180deg, #f1c40f, #f39c12); }
        .eig-item.e4::before { background: linear-gradient(180deg, #e67e22, #d35400); }
        
        .eig-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .eig-item.e1 .eig-icon { background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(46,204,113,0.05)); }
        .eig-item.e2 .eig-icon { background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.05)); }
        .eig-item.e3 .eig-icon { background: linear-gradient(135deg, rgba(241,196,15,0.2), rgba(241,196,15,0.05)); }
        .eig-item.e4 .eig-icon { background: linear-gradient(135deg, rgba(230,126,34,0.2), rgba(230,126,34,0.05)); }
        
        .eig-text { flex: 1; }
        .eig-title { 
            font-weight: 800; font-size: 13px; color: var(--text-main); margin-bottom: 4px;
            display: flex; align-items: center; gap: 8px;
        }
        .eig-badge {
            font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .eig-item.e1 .eig-badge { background: rgba(46,204,113,0.15); color: #27ae60; }
        .eig-item.e2 .eig-badge { background: rgba(52,152,219,0.15); color: #2980b9; }
        .eig-item.e3 .eig-badge { background: rgba(241,196,15,0.15); color: #f39c12; }
        .eig-item.e4 .eig-badge { background: rgba(230,126,34,0.15); color: #d35400; }
        
        .eig-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        
        .eig-arrow {
            width: 24px; height: 24px; border-radius: 50%;
            background: var(--card-bg); display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); flex-shrink: 0;
        }

        .allocation-info-connected {
            display: flex; align-items: stretch; justify-content: space-between;
            margin-bottom: 12px; width: 100%;
            background: var(--card-bg); border: 1px solid var(--accent-blue);
            border-radius: 20px; padding: 0; position: relative; overflow: hidden;
        }
        .alloc-left {
            padding: 8px 16px; font-size: 13px; color: var(--text-main);
            display: flex; align-items: center; flex: 1; border: none; background: transparent;
        }
        .alloc-right {
            background: var(--accent-blue); color: white; padding: 8px 16px;
            font-weight: 800; font-size: 11px; display: flex; align-items: center;
            white-space: nowrap; border-radius: 20px; margin: 2px;
        }
        
        .section-transition {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin: 15px 0 25px; opacity: 1; position: relative;
        }
        .st-line { height: 1px; flex: 1; background: linear-gradient(90deg, transparent, var(--accent-blue)); }
        .st-line.rev { background: linear-gradient(90deg, var(--accent-blue), transparent); }
        .st-icon {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--card-bg); color: var(--accent-blue);
            border: 1px solid var(--accent-blue); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); z-index: 5; font-size: 20px; line-height: 1;
        }
        
        .echelon-separator-modern {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; margin-top: 15px; margin-bottom: 5px;
            border-bottom: 2px solid var(--item-border);
        }
        .esm-left { display: flex; align-items: center; gap: 8px; }
        .esm-dot { width: 8px; height: 8px; border-radius: 50%; }
        .esm-title { font-weight: 800; font-size: 12px; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }

        .echelon-separator-modern.echelon-1 .esm-dot { background-color: var(--accent-green); }
        .echelon-separator-modern.echelon-2 .esm-dot { background-color: var(--accent-blue); }
        .echelon-separator-modern.echelon-3 .esm-dot { background-color: var(--accent-yellow); }
        .echelon-separator-modern.echelon-4 .esm-dot { background-color: var(--accent-orange); }

        .esm-info-btn-light {
            width: 18px; height: 18px; border-radius: 50%; 
            background: rgba(255,255,255,0.8); color: var(--accent-blue); /* Light style */
            font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .esm-info-btn-light:hover { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        
        .esm-pct { 
            font-size: 12px; font-weight: normal; color: var(--text-secondary); 
            display: flex; align-items: center; gap: 8px;
        }
        .esm-sum { color: var(--accent-blue); font-weight: 300; font-size: 13px; }
        .esm-divider { color: var(--item-border); font-weight: 300; }
        .esm-percent {
            background: rgba(52,152,219,0.1); padding: 4px 10px; border-radius: 8px; 
            color: var(--accent-blue); font-weight: 800; display: flex; align-items: center;
        }
        
        .echelon-tip {
            display: none; 
            background: #3a506b; color: white; padding: 10px; border-radius: 8px;
            font-size: 11px; font-weight: normal; line-height: 1.3;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 10px;
        }
        .echelon-tip.show { display: block; animation: fadeIn 0.2s ease; }

        .coupon-box {
            background: var(--card-bg); border-radius: 16px; margin-top: 10px;
            border: 1px solid var(--accent-blue); overflow: hidden; margin-bottom: 10px;
            position: relative; z-index: 2;
        }
        .coupon-header {
            padding: 12px 14px; background: var(--coupon-blue-bg); color: var(--accent-blue);
            font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; cursor: pointer; align-items: center;
            position: relative;
        }
        .coupon-title-wrapper { display: flex; align-items: flex-start; gap: 10px; }
        .coupon-icon-lg { font-size: 20px; line-height: 1.2; }
        .coupon-text-col { display: flex; flex-direction: column; line-height: 1.1; }
        .coupon-main-text { font-size: 14px; font-weight: 800; }
        .coupon-preview-mini { font-size: 9px; opacity: 0.7; font-weight: normal; margin-top: 2px; }
        .coupon-content { display: none; padding: 0 12px 12px; }
        .coupon-content.active { display: block; }
        
        .coupon-table-head {
            display: grid; grid-template-columns: 85px 1fr 50px 70px; gap: 5px;
            padding: 8px 0; font-size: 9px; font-weight: 800; color: #95a5a6;
            border-bottom: 2px solid var(--item-border); margin-top: 10px; margin-bottom: 5px;
        }
        .coupon-row {
            display: grid; grid-template-columns: 85px 1fr 50px 70px; gap: 5px;
            padding: 10px 0; border-bottom: 1px solid var(--item-border); font-size: 11px; align-items: center;
        }
        .coupon-row:last-child { border-bottom: none; }
        .coupon-row b { color: var(--text-main); }
        .arrow-icon { width: 14px; height: 14px; fill: currentColor; transition: transform 0.3s; }
        .coupon-content.active + .coupon-header .arrow-icon, 
        .coupon-header[onclick*="toggle"] .arrow-icon.rotated { transform: rotate(180deg); }

        .tax-selector-ui { display: flex; background: var(--bg-color); border-radius: 10px; padding: 3px; margin: 12px 0; gap: 2px; }
        .tax-ui-btn {
            flex: 1; border: none; background: transparent; padding: 6px;
            font-size: 11px; font-weight: bold; color: #8e8e93; border-radius: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .tax-ui-btn.active { background: var(--card-bg); color: var(--accent-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .footer-disclaimer-important {
            margin-top: 15px; margin-bottom: 25px; text-align: left; 
            color: var(--text-main); 
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(46, 204, 113, 0.15));
            padding: 20px; border-radius: 20px; 
            border: 1px solid rgba(46, 204, 113, 0.2);
            font-size: 13px; line-height: 1.6;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.1);
        }
        .footer-disclaimer-important::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--accent-green);
        }
        .footer-disclaimer { text-align: center; font-size: 11px; color: #99aab5; margin-top: 30px; padding: 0 20px; }

        .nav-wrapper {
            position: fixed; bottom: 25px; left: 0; width: 100%; 
            display: flex; justify-content: center; gap: 10px;
            padding: 0 15px; box-sizing: border-box; z-index: 900;
        }
        .nav-dock {
            background: var(--nav-bg); backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 25px; display: flex; align-items: center; padding: 8px 15px; gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--nav-border);
            transition: opacity 0.3s;
        }
        .nav-dock.hidden { opacity: 0; pointer-events: none; position: absolute; }
        
        .nav-search-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--nav-bg); backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--nav-border);
            cursor: pointer; color: var(--nav-icon-inactive); transition: all 0.2s; position: relative;
        }
        .nav-search-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .nav-search-btn:active { transform: scale(0.9); }
        
        .nav-search-expanded {
            position: absolute; bottom: 0; left: 15px; right: 15px;
            height: 66px;
            background: var(--nav-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 25px;
            display: flex; align-items: center; padding: 0 5px; gap: 5px; /* Less padding */
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            border: none;
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 910;
        }
        .nav-search-expanded.active { transform: translateY(0); }
        
        .nav-search-input-bar {
            flex: 1; border: none; background: rgba(0,0,0,0.05);
            height: 44px; border-radius: 22px; padding: 0 15px;
            font-size: 14px; outline: none; color: var(--text-main);
            box-shadow: none; -webkit-appearance: none;
        }
        .dark-mode .nav-search-input-bar { background: rgba(255,255,255,0.1); }
        .nav-search-input-bar:focus { outline: none; }

        .nav-item {
            display: flex; align-items: center; justify-content: center; width: 44px; height: 44px;
            border-radius: 15px; cursor: pointer; transition: all 0.2s; color: var(--nav-icon-inactive);
        }
        .nav-item.active { color: var(--accent-blue); background: rgba(52, 152, 219, 0.1); }
        .nav-item svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .nav-item:active { transform: scale(0.9); }
        
        .nav-back-island {
            width: 44px; height: 44px; border-radius: 15px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .nav-back-island svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2; }

        .theme-toggle-mini {
            width: 24px; height: 24px; border-radius: 50%;
            background: var(--card-bg); color: var(--text-main); 
            border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: absolute; top: -10px; right: -12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 910;
        }
        .theme-toggle-mini svg { width: 14px; height: 14px; stroke: currentColor; fill: none; }

        .list-header-row {
            display: grid; padding: 0 16px; margin-bottom: 5px;
            font-size: 9px; font-weight: 700; color: #95a5a6; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .list-header-row.ofz-cols {
            grid-template-columns: 1fr 60px 60px 70px; gap: 8px; text-align: right;
        }
        .list-header-row.ofz-cols span:first-child { text-align: left; }
        .list-header-row.ofz-cols span:nth-child(2), .list-header-row.ofz-cols span:nth-child(3) { text-align: center; }
        
        .list-header-row.calc-cols {
            /* Updated Grid for shifting right */
            display: grid; grid-template-columns: 1fr 70px 100px; gap: 8px;
            text-align: right; margin-bottom: 8px;
        }
        .list-header-row.calc-cols span:first-child { text-align: left; }
        
        .ofz-card-modern {
            background: var(--card-bg); border-radius: 16px;
            padding: 14px 16px; margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: grid; grid-template-columns: 1fr 60px 60px 70px; 
            align-items: center; gap: 8px;
            box-shadow: 0 4px 10px var(--card-shadow);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
        }
        .ofz-card-modern::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent-blue); }
        .ofz-card-modern:active { transform: scale(0.98); }
        .ofz-main-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .ofz-name-lg { font-weight: 700; font-size: 13px; color: var(--text-main); line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ofz-ticker-sm { font-size: 10px; color: #8e8e93; font-weight: 600; text-transform: uppercase; }
        
        .ofz-nkd-badge {
            font-size: 12px; font-weight: 700; color: #7f8c8d; text-align: center;
            background: rgba(0,0,0,0.04); padding: 4px 8px; border-radius: 8px;
        }
        .ofz-price { 
            font-size: 12px; font-weight: 700; color: #7f8c8d; text-align: center; 
            background: rgba(0,0,0,0.04); padding: 4px 8px; border-radius: 8px;
        }
        
        .ofz-yield-badge { 
            font-weight: 800; font-size: 13px; color: var(--accent-green); 
            background: rgba(46, 204, 113, 0.1); padding: 6px 8px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; gap: 2px;
        }
        .ofz-arrow { width: 10px; height: 10px; fill: currentColor; }
        
        .ofz-details-panel {
            display: none; background: rgba(0,0,0,0.02);
            padding: 12px; border-radius: 0 0 16px 16px; margin-top: -10px; margin-bottom: 10px;
            border: 1px solid var(--border-color); border-top: none; font-size: 11px; color: var(--text-secondary);
        }
        .ofz-details-panel.active { display: block; animation: fadeIn 0.3s; }
        .ofz-detail-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed rgba(0,0,0,0.05); padding: 2px 0; }
        .ofz-detail-val { font-weight: bold; color: var(--text-main); }

        .calc-badge-modern {
            font-size: 10px; background: linear-gradient(135deg, #34495e, #2c3e50); color: white; 
            padding: 4px 10px; border-radius: 20px; font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); letter-spacing: 0.5px;
        }

        .monthly-calc-box {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .monthly-calc-box .input-wrapper input {
            font-size: 28px;
        }

        .calc-expl-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.5;
            padding: 0 10px;
            margin: 15px 0;
        }

        .calc-bond-row {
            display: grid; grid-template-columns: 1fr 70px 100px; align-items: center;
            padding: 10px 0; border-bottom: 1px dashed var(--item-border); gap: 8px;
        }
        .calc-bond-row:last-child { border-bottom: none; }
        .unified-badge-container { display: flex; align-items: center; width: 100%; overflow: hidden; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .ub-name {
            background: #ffffff; color: var(--text-main); padding: 4px 8px; border: 1px solid #dfe6e9;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-radius: 6px; width: 100%;
        }
        .ub-price {
            background: #dfe6e9; color: #636e72; padding: 4px 8px; border-radius: 6px;
            white-space: nowrap; font-size: 11px; text-align: center;
        }
        .ub-yield {
            background: rgba(46, 204, 113, 0.2); color: #27ae60; padding: 4px 8px; white-space: nowrap;
            border-radius: 6px; font-size: 11px; text-align: center; width: 100%;
        }
        .dark-mode .ub-name { background: #1e293b; color: #f1f5f9; border-color: #334155; }
        .dark-mode .ub-price { background: #475569; color: #94a3b8; }

        .qty-controls { display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
        .qty-btn { 
            width: 28px; height: 28px; border-radius: 6px; background: var(--card-bg); 
            display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--accent-blue);
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 16px;
            border: 1px solid var(--border-color);
        }
        .qty-btn:active { transform: scale(0.9); background: #eee; }
        .calc-input {
            width: 44px; /* Increased width for 10000 */
            border: none;
            font-size: 12px; /* Adjusted font size */
            font-weight: bold; text-align: center;
            background: transparent; color: var(--text-main); outline: none; padding: 0;
            -moz-appearance: textfield;
        }
        .calc-input::-webkit-outer-spin-button,
        .calc-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn-row-reset {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            color: #e74c3c; cursor: pointer; opacity: 0.7;
        }
        
        .result-list-container { margin-top: 15px; background: rgba(0,0,0,0.02); border-radius: 8px; padding: 10px; }
        .dark-mode .result-list-container { background: rgba(255,255,255,0.03); }

        .info-i-blue {
            display: inline-flex; width: 24px; height: 24px; border-radius: 50%; color: var(--accent-blue);
            font-size: 14px; font-weight: bold; align-items: center; justify-content: center; margin-left: 6px; cursor: pointer;
        }
        
        /* Yield Info Preview Box */
        .info-preview-box {
            display: none;
            background: var(--coupon-blue-bg);
            color: var(--accent-blue);
            padding: 12px 16px;
            border-radius: 12px;
            margin: -5px 0 15px 0;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.5;
            border: 1px solid rgba(52, 152, 219, 0.2);
            animation: fadeIn 0.3s;
        }
        .info-preview-box.show { display: block; }
        
        .search-container { padding: 10px 0; }
        .search-result-item { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--item-border); cursor: pointer; }
        .search-result-item:active { background: rgba(0,0,0,0.02); }
        
        .btn-reset-wide {
            width: 100%; box-sizing: border-box;
            padding: 12px; border: none; background: #f1f2f6; color: #7f8c8d;
            border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;
        }
        .btn-reset-wide:active { background: #e0e0e0; }
        .dark-mode .btn-reset-wide { background: #2d3748; color: #cbd5e0; }
        
        .rebalance-intro-modern {
            background: linear-gradient(135deg, var(--card-bg), var(--bg-color));
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 12px;
            color: var(--text-secondary);
            border-left: 4px solid var(--accent-blue);
            box-shadow: 0 8px 20px var(--card-shadow);
            position: relative;
        }
        .rebalance-intro-modern b { color: var(--text-main); font-weight: 800; }
        
        /* Removed ::before, using .ri-icon instead */
        .ri-icon {
            position: absolute; top: -12px; right: 20px;
            width: 32px; height: 32px;
            background: var(--card-bg);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px var(--card-shadow);
            color: var(--accent-blue);
        }
        .ri-icon svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }

        .echelon-header-pill {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
            color: #555; border: 1px solid rgba(0,0,0,0.1);
            border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 800; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin: 0 auto;
        }
        .dark-mode .echelon-header-pill { background: rgba(30,41,59,0.8); color: #ccc; border-color: rgba(255,255,255,0.1); }
        
        th:nth-child(1) .echelon-header-pill { color: #27ae60; border-color: #2ecc71; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2); }
        th:nth-child(2) .echelon-header-pill { color: #2980b9; border-color: #3498db; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2); }
        th:nth-child(3) .echelon-header-pill { color: var(--accent-yellow); border-color: var(--accent-yellow); box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2); }
        th:nth-child(4) .echelon-header-pill { color: var(--accent-orange); border-color: var(--accent-orange); box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2); }

        .echelon-table-styled { width: 100%; border-collapse: separate; border-spacing: 0; }
        .echelon-table-styled th { padding-bottom: 15px; vertical-align: bottom; }
        .echelon-table-styled td { padding: 12px 6px; border-bottom: 1px solid var(--item-border); text-align: center; vertical-align: middle; }
        .echelon-table-styled tr:last-child td { border-bottom: none; }
        .echelon-table-styled tr:nth-child(even) { background-color: rgba(0,0,0,0.015); }
        .dark-mode .echelon-table-styled tr:nth-child(even) { background-color: rgba(255,255,255,0.015); }
        
        .et-ticker { font-weight: 800; font-size: 11px; color: var(--text-main); display: block; margin-bottom: 4px; }
        .et-target {
            display: inline-block; font-size: 10px; font-weight: 700; color: var(--accent-green);
            background: rgba(46, 204, 113, 0.1); padding: 2px 6px; border-radius: 6px;
        }

        .echelon-wrapper {
            position: relative; border-radius: 16px; 
            padding: 20px 5px; overflow: hidden; 
            transition: max-height 0.4s ease;
        }
        .echelon-wrapper.collapsed { max-height: 240px; }
        
        #ofz-wrapper { padding: 0; }
        #ofz-wrapper.collapsed { max-height: 180px; }
        
        .echelon-wrapper.collapsed::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(to bottom, transparent, var(--bg-color));
            pointer-events: none;
        }
        .expand-arrow-btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 0; margin-top: -16px; cursor: pointer;
            position: relative; z-index: 5; height: 32px;
        }
        #ofz-wrapper + .expand-arrow-btn { margin-top: 10px; }
        .eab-line { flex: 1; height: 1px; background: var(--item-border); }
        .eab-icon-box {
            width: 28px; height: 28px; border-radius: 50%; background: var(--card-bg);
            border: 1px solid var(--accent-blue); color: var(--accent-blue);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.3s;
        }
        .expand-arrow-btn:active .eab-icon-box { transform: scale(0.95); }
        .expand-arrow-btn.open .eab-icon-box { transform: rotate(180deg); }

        .portfolio-empty { padding: 40px 20px; text-align: center; color: var(--text-secondary); }
        .portfolio-empty-icon { font-size: 40px; margin-bottom: 15px; opacity: 0.5; }
        
        .summary-card {
            background: linear-gradient(135deg, var(--card-bg), #f8fafd);
            border-radius: 20px; padding: 20px; margin-bottom: 25px;
            box-shadow: 0 8px 25px var(--card-shadow); border: 1px solid var(--border-color);
            position: relative; overflow: hidden;
        }
        .dark-mode .summary-card { background: linear-gradient(135deg, var(--card-bg), #2c3a50); }

        .summary-card::before {
            content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(52,152,219,0.1) 0%, transparent 70%);
            border-radius: 50%; transform: translate(30%, -30%);
        }
        
        .summary-top-modern {
            padding-bottom: 15px; border-bottom: 1px dashed var(--item-border);
        }
        .stm-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            margin-top: 10px; /* moved lower */
        }
        .stm-header-label { font-size: 11px; color: #95a5a6; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .stm-val-big { font-size: 26px; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stm-header-icon {
            width: 44px; height: 44px;
            border-radius: 14px;
            background: var(--coupon-blue-bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stm-header-icon svg {
            width: 24px; height: 24px;
            stroke-width: 2;
            color: var(--accent-blue);
        }
        
        .stm-bar-container { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: #eee; width: 100%; }
        .dark-mode .stm-bar-container { background: rgba(0,0,0,0.2); }
        .stm-bar-bonds { background: var(--accent-blue); transition: width 0.3s; }
        .stm-bar-stocks { background: var(--accent-green); transition: width 0.3s; }
        
        .stm-meta-row { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .stm-fee-lozenge { 
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            background: var(--bg-color);
            padding: 6px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        .stm-pct-labels { display: flex; flex-direction: column; gap: 5px; font-size: 10px; font-weight: 700; }
        .stm-pl-bond { color: var(--accent-blue); }
        .stm-pl-stock { color: var(--accent-green); }
        
        .summary-prediction { background: rgba(46, 204, 113, 0.05); border-radius: 12px; padding: 12px; border: 1px solid rgba(46, 204, 113, 0.1); margin-top: 15px; }
        .dark-mode .summary-prediction { background: rgba(74, 222, 128, 0.05); border-color: rgba(74, 222, 128, 0.1); }
        .pred-title { font-size: 10px; color: #27ae60; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .pred-total { font-size: 18px; font-weight: 800; color: #27ae60; margin-bottom: 8px; }
        .pred-breakdown { font-size: 11px; color: var(--text-main); }
        .pb-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .dot-bond { color: var(--accent-blue); font-size: 10px; margin-right: 4px; }
        .dot-stock { color: var(--accent-green); font-size: 10px; margin-right: 4px; }
        
        .company-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { width: 36px; height: 36px; border-radius: 12px; background: var(--card-bg); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; color: var(--text-main); }
        .company-title { font-size: 20px; font-weight: 800; line-height: 1.2; }
        
        .company-card-v2 {
            background: var(--card-bg); border-radius: 20px; padding: 20px; 
            box-shadow: 0 8px 25px var(--card-shadow); border: 1px solid var(--border-color); 
            margin-bottom: 20px;
        }
        .cc-v2-header { display: flex; align-items: center; gap: 14px; margin-bottom: 20px; }
        .cc-v2-logo { 
            width: 48px; height: 48px; border-radius: 14px; background: var(--bg-color); 
            display: flex; align-items: center; justify-content: center; font-weight: 800;
            font-size: 12px; color: var(--text-secondary);
        }
        .cc-v2-name { font-size: 16px; font-weight: 800; color: var(--text-main); }
        .cc-v2-type { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .cc-v2-price-block { display: flex; align-items: baseline; gap: 8px; margin-bottom: 15px; }
        .cc-v2-price { font-size: 34px; font-weight: 800; color: var(--text-main); }
        .cc-v2-change { font-size: 14px; font-weight: 700; }
        .cc-v2-change.positive { color: var(--accent-green); }
        .cc-v2-change.negative { color: var(--accent-red); }
        .cc-v2-change.neutral { color: var(--text-secondary); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: var(--bg-color); border-radius: 12px; padding: 12px; }
        .stat-label { font-size: 10px; color: #8e8e93; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }
        .stat-val { font-size: 14px; font-weight: 800; color: var(--text-main); }
        
        .news-header { font-size: 16px; font-weight: 800; margin-bottom: 10px; }
        .news-item { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 10px; border: 1px solid var(--item-border); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .news-date { font-size: 10px; color: var(--accent-blue); font-weight: bold; margin-bottom: 4px; }
        .news-title { font-size: 13px; font-weight: bold; line-height: 1.4; margin-bottom: 6px; }
        .news-snippet { font-size: 11px; color: #8e8e93; line-height: 1.5; }
        
        .search-empty-state {
            text-align: center; padding: 40px 20px; color: var(--text-secondary);
        }
        .search-empty-state .icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        .search-empty-state .title { font-size: 16px; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .search-empty-state .desc { font-size: 12px; line-height: 1.5; }

        
        
    </style>
</head>
<body onclick="hideAllTips(event)">

<div id="toast" class="toast">!</div>

    <div id="screen-home" class="screen active">
        <div class="terminal-header">
            <div class="terminal-badge">
                <span id="market-status-dot" class="market-dot"></span>
                <span>MADAME SOLOMI'NA: TERMINAL</span>
            </div>
            
            <div class="home-title"> ! </div>
            <div class="home-desc"> -    .   ! </div>
            
            <div class="info-card bonds">
               <div class="info-card-header"> </div>
                <div class="info-card-sub-clean"> " "</div>
                <div class="info-card-text">     .       .       .</div>
                <div class="info-card-badge badge-blue">: </div>
            </div>

            <div class="info-card stocks">
                <div class="info-card-header"> </div>
                <div class="info-card-sub-clean"> " "</div>
                <div class="info-card-text">   ,    .          .</div>
                <div class="info-card-badge badge-green">: </div>
            </div>
            
            <div id="start-calculation-block">
                <button class="btn-graphite" onclick="startCalculation()">
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                     
                </button>
                <p class="start-expl">
                     ,           .
                </p>
            </div>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div class="header">
            <h1>   ?</h1>
            <p id="dynamicSubtitle" style="font-size: 13px; color: #666;">  50/50:    .</p>
        </div>

        <div class="calc-box" id="calcSection">
            <div class="calc-top">
                <div class="input-container" onclick="event.stopPropagation(); document.getElementById('sumInput').focus()">
                    <span class="input-label"> </span>
                    <div class="input-wrapper">
                        <input type="number" id="sumInput" value="100000" oninput="draw()" onclick="event.stopPropagation(); this.select()" onkeyup="if(event.keyCode===13) this.blur()" inputmode="numeric" pattern="[0-9]*" enterkeyhint="done">
                        <span class="currency"></span>
                    </div>
                </div>
                <div id="mainChart" class="chart-mini" data-pct="50/50" onclick="resetRatio()"></div>
            </div>
            
            <div class="usage-bar-container">
                <div class="usage-label">
                    <span> </span>
                    <span id="usageLabelText">0 </span>
                </div>
                <div class="usage-track">
                    <div id="usageFill"></div>
                </div>
            </div>

            <div class="fee-selector">
                <span class="fee-label"> </span>
                <div class="fee-buttons" id="feeGroup">
                    <button class="fee-btn" onclick="setFee(0.0001, this)">0.01%</button>
                    <button class="fee-btn active" onclick="setFee(0.0003, this)">0.03%</button>
                    <button class="fee-btn" onclick="setFee(0.0005, this)">0.05%</button>
                    <button class="fee-btn" onclick="setFee(0.001, this)">0.1%</button>
                    <button class="fee-btn" onclick="setFee(0.003, this)">0.3%</button>
                    <button class="fee-btn" onclick="setFee(0.004, this)">0.4%</button>
                    <button class="fee-btn" onclick="setFee(0.005, this)">0.5%</button>
                </div>
            </div>

            <div class="ratio-control">
                <div style="display:flex; justify-content: space-between; font-size: 11px; font-weight: bold; color: #8e8e93; text-transform: uppercase;">
                    <span> <span id="labelBondsPct">50</span>%</span>
                    <span> <span id="labelStocksPct">50</span>%</span>
                </div>
                <input type="range" id="ratioSlider" class="ratio-slider" min="0" max="100" value="50" oninput="draw()">
                <div class="slider-hint-wrapper">
                    <span class="slider-hint">     </span>
                    <div class="preset-dropdown-btn" id="presetDropdownBtn" onclick="togglePresetDropdown()">
                        <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                </div>
                
                <div class="preset-options" id="presetOptions">
                    <div class="preset-btn-modern" onclick="setPresetRatio(80, this)">
                        <div class="preset-left">
                            <div class="preset-icon"></div>
                            <div>
                                <div class="preset-title"></div>
                                <div class="preset-subtitle">  </div>
                            </div>
                        </div>
                        <div class="preset-right">80/20</div>
                    </div>
                    <div class="preset-btn-modern" onclick="setPresetRatio(60, this)">
                        <div class="preset-left">
                            <div class="preset-icon"></div>
                            <div>
                                <div class="preset-title"></div>
                                <div class="preset-subtitle">  + </div>
                            </div>
                        </div>
                        <div class="preset-right">60/40</div>
                    </div>
                    <div class="preset-btn-modern" onclick="setPresetRatio(40, this)">
                        <div class="preset-left">
                            <div class="preset-icon"></div>
                            <div>
                                <div class="preset-title"></div>
                                <div class="preset-subtitle">   </div>
                            </div>
                        </div>
                        <div class="preset-right">40/60</div>
                    </div>
                    <div class="preset-btn-modern" onclick="setPresetRatio(20, this)">
                        <div class="preset-left">
                            <div class="preset-icon"></div>
                            <div>
                                <div class="preset-title"></div>
                                <div class="preset-subtitle">  </div>
                            </div>
                        </div>
                        <div class="preset-right">20/80</div>
                    </div>
                    <div class="preset-footer-hint">: 60/40  60%   40% </div>
                </div>
            </div>
        </div>

        <button class="btn-graphite" style="margin-bottom: 25px;" onclick="calculateAndShowPortfolio()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2 6.4 4.5 5 7zM19.5 15.4L22 14l-2.5-1.4L21 10l-2.5 1.4L16 10l1.4 2.6L16 14l2.5 1.4zM22 2l-2.5 1.4L21 6l-1.5-2.6L16 2l1.4 2.5L16 7l2.5-1.4L21 7 19.5 4.6z M2 22l6-6-1.5-1.5-6 6V22h1.5z m11-11l-2.5-2.5-6.5 6.5 2.5 2.5 6.5-6.5z"/>
            </svg>
             
        </button>
        <p class="start-expl">
                      8     12     
        </p>
    </div>

    <div id="screen-portfolio" class="screen">
        <div class="header"><h1></h1></div>
        
        <div id="portfolio-empty" class="portfolio-empty">
            <div class="portfolio-empty-icon"></div>
            <div>   .<br>     .</div>
            <button class="btn-action" style="margin-top:20px; border-style:dashed;" onclick="showScreen('screen-app')">  </button>
        </div>

        <div id="portfolio-content" style="display:none;">
            <div id="shareContainer">
                <div class="summary-card">
                    <div class="summary-top-modern">
                        <div class="stm-header">
                            <div class="stm-header-left">
                                <div class="stm-header-label"></div>
                                <div class="stm-val-big" id="summ-invested">0 </div>
                            </div>
                            <div class="stm-header-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <rect height="14" rx="2" ry="2" width="20" x="2" y="7"></rect>
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                </svg>
                            </div>
                        </div>

                        <div class="stm-bar-container">
                            <div id="bar-bond-fill" class="stm-bar-bonds" style="width:50%"></div>
                            <div id="bar-stock-fill" class="stm-bar-stocks" style="width:50%"></div>
                        </div>

                        <div class="stm-meta-row">
                            <div class="stm-pct-labels">
                                <span class="stm-pl-bond"> <span id="srl-bond-pct">50%</span></span>
                                <span class="stm-pl-stock"> <span id="srl-stock-pct">50%</span></span>
                            </div>
                            <div class="stm-fee-lozenge">: <span id="summ-fee">0.03%</span></div>
                        </div>
                    </div>
                    
                    <div class="summary-prediction">
                        <div class="pred-title">  3  ():</div>
                        <div class="pred-total" id="summ-total-3y">0 </div>
                        <div style="height:1px; background:rgba(0,0,0,0.05); margin:8px 0;"></div>
                        <div class="pred-breakdown">
                            <div class="pb-row">
                                <span><span class="dot-bond"></span>    :</span>
                                <b id="summ-bond-income">0 </b>
                            </div>
                            <div class="pb-row">
                                <span><span class="dot-stock"></span>   :</span>
                                <b id="summ-stock-growth">0 </b>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; padding: 10px; display: none;" id="shareBrand">
                    <h2 style="margin: 0; color: #3498db; font-size: 18px;">  50/50</h2>
                    <div id="shareDate" style="font-size: 10px; color: #888;"></div>
                </div>
                
                <div id="section-bonds">
                    <div class="section-header-highlight hl-blue">1.  </div>
                    <div class="section-desc-small">
                              8      ,   16    .
                    </div>
                    
                    <div class="allocation-info-connected" id="alloc-bonds">
                        <div class="alloc-left">: &nbsp;<b id="valBonds">0</b>&nbsp;</div>
                        <div class="alloc-right"><span class="bond-pct-text">50</span>%  </div>
                    </div>
                    <div id="listBonds" class="asset-list"></div>
                </div>

                <div class="coupon-box" id="couponBox">
                    <div class="coupon-header" id="rainSection" onclick="toggleCouponSection()">
                        <div class="coupon-title-wrapper">
                            <div class="coupon-icon-lg"></div>
                            <div class="coupon-text-col">
                                <span class="coupon-main-text"> </span>
                                <span class="coupon-preview-mini">   </span>
                            </div>
                        </div>
                        <svg class="arrow-icon" id="couponArrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                    </div>
                    <div class="coupon-content" id="couponContent">
                        <div class="tax-selector-ui" id="taxGroup">
                            <button class="tax-ui-btn" onclick="setTax(0, this)"> </button>
                            <button class="tax-ui-btn active" onclick="setTax(0.13, this)"> 13%</button>
                            <button class="tax-ui-btn" onclick="setTax(0.15, this)"> 15%</button>
                        </div>
                        <div class="coupon-table-head">
                            <span></span> <span></span> <span style="text-align:center">-</span> <span style="text-align:right"></span>
                        </div>
                        <div id="couponList"> ...</div>
                        <div style="text-align:right; margin-top:10px; font-weight:bold; font-size:12px; padding-top:5px; border-top:1px dashed #eee;">
                             : <span id="couponTotalHeader">0 </span>
                        </div>
                    </div>
                </div>
                
                <div class="section-transition" id="section-separator">
                    <div class="st-line"></div>
                    <div class="st-icon"></div>
                    <div class="st-line rev"></div>
                </div>

                <div id="section-stocks">
                    <div class="section-header-highlight hl-blue" id="header-stocks">2.  </div>
                    <div class="section-desc-small">
                               4       .
                    </div>
                    <div class="allocation-info-connected" id="alloc-stocks">
                        <div class="alloc-left">: &nbsp;<b id="valStocks">0</b>&nbsp;</div>
                        <div class="alloc-right"><span class="stock-pct-text">50</span>%  </div>
                    </div>
                    <div id="echelonContainer"></div>
                </div>
                
                <div class="footer-disclaimer-important" id="footer-important">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; font-weight:800; font-size:14px; color:var(--accent-green); text-transform:uppercase; letter-spacing:0.5px;">
                        <svg style="width:18px;height:18px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        
                    </div>
                       70%       ,         .
                </div>
            </div>

            <button class="btn-action" id="btnShare" onclick="shareAsPDF()">
                <svg style="width:16px;height:16px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                 PDF ()
            </button>
            <div class="footer-disclaimer">   .      ,    .</div>
        </div>
    </div>

    <div id="screen-assets" class="screen">
        <div class="header"><h1></h1></div>
        <div class="rebalance-intro-modern">
            <div class="ri-icon">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            </div>
            <b></b>        .   ,         ,     .   ,      .
        </div>
        
        <div class="section-header-styled" onclick="toggleOfzTable(document.getElementById('expandArrowOfz'))">
            <span>   </span>
            <span class="info-i-blue" onclick="showYieldInfo(event)">
                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            </span>
        </div>
        <div class="info-preview-box" id="yield-info-box">
            <b>   </b>    ,   ,      .
        </div>
        
        <div id="ofz-list-headers" class="list-header-row ofz-cols">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
        
        <div id="ofz-wrapper" class="echelon-wrapper collapsed">
             <div id="ofz-list"></div>
        </div>

        <div class="expand-arrow-btn" id="expandArrowOfz" onclick="toggleOfzTable(this)">
            <div class="eab-line"></div>
            <div class="eab-icon-box">
                <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <div class="eab-line"></div>
        </div>

        <div class="section-header-styled" onclick="toggleInfoBlock(this)">
            <span>   </span>
            <span class="info-i-blue">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </span>
        </div>
        
        <div class="info-expanded-block" style="margin-top:10px;">
            <div class="echelon-info-graphic">
                <div class="eig-item e1">
                    <div class="eig-icon"></div>
                    <div class="eig-text">
                        <div class="eig-title">I  <span class="eig-badge"></span></div>
                        <div class="eig-desc">,         </div>
                    </div>
                    <div class="eig-arrow"></div>
                </div>
                <div class="eig-item e2">
                    <div class="eig-icon"></div>
                    <div class="eig-text">
                        <div class="eig-title">II  <span class="eig-badge"></span></div>
                        <div class="eig-desc">,   ,     </div>
                    </div>
                    <div class="eig-arrow"></div>
                </div>
                <div class="eig-item e3">
                    <div class="eig-icon"></div>
                    <div class="eig-text">
                        <div class="eig-title">III  <span class="eig-badge"></span></div>
                        <div class="eig-desc">   ,     </div>
                    </div>
                    <div class="eig-arrow"></div>
                </div>
                <div class="eig-item e4">
                    <div class="eig-icon"></div>
                    <div class="eig-text">
                        <div class="eig-title">IV  <span class="eig-badge"></span></div>
                        <div class="eig-desc"> ,     </div>
                    </div>
                    <div class="eig-arrow"></div>
                </div>
            </div>
        </div>
        
        <div id="echelon-wrapper" class="echelon-wrapper collapsed">
            <table class="echelon-table-styled">
                <thead>
                    <tr>
                        <th><div class="echelon-header-pill">I</div></th>
                        <th><div class="echelon-header-pill">II</div></th>
                        <th><div class="echelon-header-pill">III</div></th>
                        <th><div class="echelon-header-pill">IV</div></th>
                    </tr>
                </thead>
                <tbody id="echelon-tickers-body"></tbody>
            </table>
        </div>
        
        <div class="expand-arrow-btn" id="expandArrowBtn" onclick="toggleEchelonTable(this)">
            <div class="eab-line"></div>
            <div class="eab-icon-box">
                <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <div class="eab-line"></div>
        </div>
    </div>

    <div id="screen-interesting" class="screen">
        <div class="header"><h1></h1></div>
        
        <div class="market-grid">
            <div class="market-item-modern blue">
                <div class="mk-left">
                    <div class="mk-label">IMOEX</div>
                    <div class="mk-val" id="val-imoex">---</div>
                </div>
                <div class="mk-dynamics neutral" id="dyn-imoex">--%</div>
            </div>
            <div class="market-item-modern green">
                <div class="mk-left">
                    <div class="mk-label">USD/RUB</div>
                    <div class="mk-val" id="val-usdrub">---</div>
                </div>
                <div class="mk-dynamics neutral" id="dyn-usdrub">--%</div>
            </div>
            <div class="market-item-modern orange">
                <div class="mk-left">
                    <div class="mk-label">BTC/USD</div>
                    <div class="mk-val" id="val-btc">---</div>
                </div>
                <div class="mk-dynamics neutral" id="dyn-btc">--%</div>
            </div>
        </div>

        <div class="rates-vertical-block">
            <div class="rv-title"> </div>
            <div class="rv-grid">
                <div class="rv-item">
                 <span>  </span>
                 <b id="val-key-rate">21.0%</b>
            </div>
                 <div class="rv-item">
                 <span>.   </span>
                 <b id="val-deposit-rate">21.5%</b>
           </div>
                <div class="rv-item">
                <span> (/)</span>
                <b id="val-inflation">9.1%</b>
             </div>
                <div class="rv-item">
                <span> 10 </span>
                <b id="val-ofz10">---%</b>
              </div>
            </div>
        </div>

        <div class="coupon-box" style="margin-top:20px;">
            <div class="coupon-header" onclick="toggleAccordion('calc-income-wrapper')">
                <span>  </span>
                <span class="calc-badge-modern"></span>
            </div>
            <div class="coupon-content" id="calc-income-wrapper" style="padding: 10px; display:block;">
                
                <div class="monthly-calc-box">
                    <div class="input-container">
                        <span class="input-label"> </span>
                        <div class="input-wrapper">
                            <input type="number" id="monthlySumInput" value="100000" oninput="distributeMonthlyInvestment()" onclick="event.stopPropagation(); this.select()" onkeyup="if(event.keyCode===13) this.blur()" inputmode="numeric" pattern="[0-9]*" enterkeyhint="done" style="background: transparent; border: none; color: var(--input-color); width: 100%; font-weight: 700;">
                            <span class="currency" style="font-size: 24px;"></span>
                        </div>
                    </div>
                </div>
                
                <p class="calc-expl-text">     ,        .</p>

                <div class="tax-selector-ui">
                    <button class="tax-ui-btn" id="tax-custom-0" onclick="setCustomTax(0, this)"> </button>
                    <button class="tax-ui-btn active" id="tax-custom-13" onclick="setCustomTax(0.13, this)"> 13%</button>
                    <button class="tax-ui-btn" id="tax-custom-15" onclick="setCustomTax(0.15, this)"> 15%</button>
                </div>
                
                <div style="font-size:10px; color:#8e8e93; margin-bottom:5px; text-transform:uppercase;">.</div>
                
                <div class="list-header-row calc-cols">
                    <span></span>
                    <span style="text-align: center;"></span>
                    <span style="text-align: center;"></span>
                </div>
                
                <div id="calc-bonds-input-list"></div>
                
                <button class="btn-reset-wide" onclick="resetCustomCalc()">
                    <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                      
                </button>

                <div class="result-list-container">
                    <div style="font-weight:bold; font-size:12px; margin-bottom:8px; color:var(--accent-blue);">:</div>
                    <div class="coupon-table-head">
                        <span></span> <span></span> <span style="text-align:center">-</span> <span style="text-align:right"></span>
                    </div>
                    <div id="calc-results-list" style="font-size:11px; color:#666;">   ...</div>
                    <div id="calc-results-footer" style="text-align:right; margin-top:10px; font-weight:bold; font-size:12px; border-top:1px dashed #ccc; padding-top:5px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="screen-company" class="screen">
        <div class="company-header">
            <div class="back-btn" onclick="goBackFromCompany()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="company-title"> </div>
        </div>
        
        <div id="company-content"></div>
    </div>

    <div class="nav-wrapper" id="navWrapper">
        <div class="nav-dock" id="standardNav">
            <div class="nav-item active" id="nav-home" onclick="showScreen('screen-home')">
                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </div>
            <div class="nav-item" id="nav-app" onclick="showScreen('screen-app')">
                <svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
            </div>
            <div class="nav-item" id="nav-portfolio" onclick="showScreen('screen-portfolio')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            </div>
            <div class="nav-item" id="nav-assets" onclick="showScreen('screen-assets')">
                <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            </div>
        </div>

        <div class="nav-search-btn" id="nav-search" onclick="expandSearch()">
            <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:2;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <button class="theme-toggle-mini" onclick="event.stopPropagation(); toggleTheme()" id="themeBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
        </div>

        <div class="nav-search-expanded" id="expandedNav">
            <div class="nav-back-island" onclick="collapseSearch()">
                 <!-- Icon will be injected here by JS -->
            </div>
            <input type="text" class="nav-search-input-bar" id="tickerSearchInput" placeholder=",   ISIN..." onkeyup="handleSearchKeyup(event)">
            <div class="nav-item" onclick="collapseSearch()">
                <svg viewBox="0 0 24 24" style="width:24px;height:24px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

<script>
        const SHEET_ID = '1SFV5dBIsvfX5HKbXBuXHFVvBfw1p1MPPx2uK209ajLM';
        const GID = '1213653337'; 
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

        let bonds = [];
        let monthlyIncomeBonds = []; // New list for the specific calculator
        let allScheduledPayments = [];
        let brokerFee = 0.0003; 
        let currentTax = 0.13;
        let customTax = 0.13;
        let bondCouponsMap = {}; 
        let bondDetailsMap = {};
        let currentScreen = 'screen-home';
        let lastNavScreen = 'screen-home';
        let isPortfolioCalculated = false;
        let isFirstVisit = true;
        let isUpdatingProgrammatically = false;
        //    
        let ratesData = {
           keyRate: '21.0%',
           depositRate: '21.5%',
           inflation: '9.1%',
           ofz10: '---'
        };
    

        let echelons = [
            { title: 'I ', weight: 0.30, assets: [], info: ',       ' },
            { title: 'II ', weight: 0.40, assets: [], info: ',   ,   ' },
            { title: 'III ', weight: 0.15, assets: [], info: ',   ,   ' },
            { title: 'IV ', weight: 0.15, assets: [], info: ',    ' }
        ];
        let echelonTableData = [[], [], [], []];
        
        // Swipe navigation removed

        function checkFirstVisit() {
            const visited = localStorage.getItem('user_visited');
            const startBlock = document.getElementById('start-calculation-block');
            if (visited) {
                isFirstVisit = false;
                if(startBlock) startBlock.style.display = 'none';
                document.getElementById('navWrapper').style.display = 'flex';
                showScreen('screen-app');
            } else {
                isFirstVisit = true;
                if(startBlock) startBlock.style.display = 'block';
                document.getElementById('navWrapper').style.display = 'none';
            }
        }

        function startCalculation() {
            localStorage.setItem('user_visited', 'true');
            isFirstVisit = false;
            const startBlock = document.getElementById('start-calculation-block');
            if(startBlock) startBlock.style.display = 'none';
            document.getElementById('navWrapper').style.display = 'flex';
            showScreen('screen-app');
        }

        function updateMarketStatus() {
            const now = new Date();
            const day = now.getDay(); const hour = now.getHours(); const min = now.getMinutes();
            const dot = document.getElementById('market-status-dot');
            const isWeekday = day >= 1 && day <= 5;
            const isWorkingHours = (hour > 10 || (hour === 10 && min >= 0)) && (hour < 18 || (hour === 18 && min <= 50));
            dot.className = (isWeekday && isWorkingHours) ? 'market-dot dot-online' : 'market-dot dot-offline';
        }

    function updateRatesDisplay() {
    document.getElementById('val-key-rate').innerText = ratesData.keyRate;
    document.getElementById('val-deposit-rate').innerText = ratesData.depositRate;
    document.getElementById('val-inflation').innerText = ratesData.inflation;
    document.getElementById('val-ofz10').innerText = ratesData.ofz10;  // <---  
}

        async function updateMarketData() {
            const setDynamics = (el, change) => {
                el.classList.remove('positive', 'negative', 'neutral');
                if (change > 0.01) {
                    el.classList.add('positive');
                    el.innerText = `+${change.toFixed(2)}%`;
                } else if (change < -0.01) {
                    el.classList.add('negative');
                    el.innerText = `${change.toFixed(2)}%`;
                } else {
                    el.classList.add('neutral');
                    el.innerText = `${Math.abs(change).toFixed(2)}%`;
                }
            };
            
            // Bitcoin
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
                const data = await res.json();
                if(data && data.lastPrice) {
                    document.getElementById('val-btc').innerText = '$' + Math.round(parseFloat(data.lastPrice)).toLocaleString();
                    setDynamics(document.getElementById('dyn-btc'), parseFloat(data.priceChangePercent));
                }
            } catch(e) { console.log("BTC fetch error:", e); }

            // MOEX data
            const fetchMoex = (url, valEl, dynEl) => {
                fetch(url)
                    .then(r => r.json())
                    .then(d => {
                        const marketdata = (d.marketdata && d.marketdata.data.length > 0) ? d.marketdata : ((d.marketdata_yields && d.marketdata_yields.data.length > 0) ? d.marketdata_yields : null);
                        
                        let last, open, prev;
                        let changePercent = 0;

                        const getVal = (block, colName) => {
                            if(!block || !block.columns || !block.data || block.data.length === 0) return null;
                            const idx = block.columns.indexOf(colName);
                            return idx !== -1 ? block.data[0][idx] : null;
                        };

                        if (marketdata) {
                            last = getVal(marketdata, 'LAST') || getVal(marketdata, 'CURRENTVALUE') || getVal(marketdata, 'YIELD');
                            open = getVal(marketdata, 'OPEN');
                        }

                        if ((!last || !open) && d.securities && d.securities.data.length > 0) {
                             prev = getVal(d.securities, 'PREVPRICE');
                             if(!last) last = prev; 
                             if(!open) open = prev; 
                        }
                        
                        if(last && open && open > 0) {
                            changePercent = ((last - open) / open) * 100;
                        } else if (last && prev && prev > 0) {
                             changePercent = ((last - prev) / prev) * 100;
                        }
                        
                        if(last) valEl.innerText = last.toFixed(2).replace('.00', '') + (url.includes('USD') ? ' ' : '');
                        setDynamics(dynEl, changePercent);
                    }).catch(e => {
                        console.log("MOEX error for:", valEl.id, e);
                        valEl.innerText = "---";
                    });
            };

            fetchMoex('https://iss.moex.com/iss/engines/stock/markets/index/securities/IMOEX.json?iss.meta=off&iss.only=securities,marketdata', document.getElementById('val-imoex'), document.getElementById('dyn-imoex'));
            fetchMoex('https://iss.moex.com/iss/engines/currency/markets/selt/boards/CETS/securities/USD000UTSTOM.json?iss.meta=off&iss.only=securities,marketdata', document.getElementById('val-usdrub'), document.getElementById('dyn-usdrub'));
            
             fetch('https://iss.moex.com/iss/engines/stock/markets/bonds/securities/SU26244RMFS2.json?iss.meta=off&iss.only=securities,marketdata')
                .then(r => r.json())
                .then(d => {
                     const md = d.marketdata || d.marketdata_yields;
                     if(md && md.data.length > 0) {
                         const yIdx = md.columns.indexOf('YIELD');
                         const y = md.data[0][yIdx];
                         if(y) document.getElementById('val-ofz10').innerText = y.toFixed(2) + '%';
                     }
                }).catch(e => console.log('OFZ fetch error'));
        }

        setInterval(updateMarketData, 30000);
        setInterval(updateMarketStatus, 60000);
        
        function showScreen(screenId) {
            if(screenId !== 'screen-interesting' && screenId !== 'screen-company') {
                lastNavScreen = screenId;
                collapseSearch(false);
            }
            
            if (currentScreen === 'screen-home' && !isFirstVisit) {
                 const startBlock = document.getElementById('start-calculation-block');
                 if (startBlock) startBlock.style.display = 'none';
            }

            if (currentScreen === 'screen-assets' && screenId !== 'screen-assets') {
                const inc = document.getElementById('calc-income-wrapper');
                if(inc) inc.style.display = 'none';
            }
            currentScreen = screenId;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('nav-search').classList.remove('active');
            
            const navId = `nav-${screenId.split('-')[1]}`;
            const navBtn = document.getElementById(navId);
            if (navBtn) navBtn.classList.add('active');
            
            if(screenId === 'screen-interesting' || screenId === 'screen-company') {
                document.getElementById('nav-search').classList.add('active');
            }
            
            window.scrollTo({top: 0, behavior: 'smooth'});
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        
        function expandSearch() {
            const backBtn = document.querySelector('#expandedNav .nav-back-island');
            const activeNavId = `nav-${lastNavScreen.split('-')[1]}`;
            const activeNav = document.getElementById(activeNavId);

            if (activeNav && backBtn) {
                const iconSvg = activeNav.querySelector('svg').cloneNode(true);
                backBtn.innerHTML = '';
                backBtn.appendChild(iconSvg);
            }
            
            document.getElementById('standardNav').classList.add('hidden');
            document.getElementById('nav-search').style.display = 'none';
            document.getElementById('expandedNav').classList.add('active');
            showScreen('screen-interesting');
            setTimeout(() => {
                document.getElementById('tickerSearchInput').focus();
            }, 300);
        }

        function collapseSearch(goBack = true) {
            document.getElementById('expandedNav').classList.remove('active');
            document.getElementById('standardNav').classList.remove('hidden');
            document.getElementById('nav-search').style.display = 'flex';
            document.getElementById('tickerSearchInput').blur();
            document.getElementById('tickerSearchInput').value = '';
            
            if(goBack) showScreen(lastNavScreen);
        }

        function goBackFromCompany() {
            showScreen('screen-interesting');
        }

        function handleSearchKeyup(event) {
            if(event.keyCode === 13) {
                performSearch(event.target.value);
            }
        }

        function togglePresetDropdown() {
            const btn = document.getElementById('presetDropdownBtn');
            const options = document.getElementById('presetOptions');
            btn.classList.toggle('open');
            options.classList.toggle('show');
        }

        function setPresetRatio(bondPct, btnElement) {
            document.getElementById('ratioSlider').value = bondPct;
            
            document.querySelectorAll('.preset-btn-modern').forEach(b => b.classList.remove('selected-preset'));
            if(btnElement) btnElement.classList.add('selected-preset');
            
            draw();
        }

        function calculateAndShowPortfolio() {
            draw();
            isPortfolioCalculated = true;
            document.getElementById('portfolio-empty').style.display = 'none';
            document.getElementById('portfolio-content').style.display = 'block';
            showScreen('screen-portfolio');
        }

        function toggleAccordion(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        }

        function toggleCouponSection() {
            const content = document.getElementById('couponContent');
            const arrow = document.getElementById('couponArrow');
            content.classList.toggle('active');
            arrow.classList.toggle('rotated');
        }

        function toggleEchelonTable(btn) {
            const wrapper = document.getElementById('echelon-wrapper');
            wrapper.classList.toggle('collapsed');
            if(btn && btn.classList) btn.classList.toggle('open');
        }

        function toggleOfzTable(btn) {
            const wrapper = document.getElementById('ofz-wrapper');
            wrapper.classList.toggle('collapsed');
            if(btn && btn.classList) btn.classList.toggle('open');
        }
        
        function toggleOfzDetails(id) {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('active');
        }
        
        function toggleInfoBlock(headerElement) {
            event.stopPropagation();
            let nextEl = headerElement.nextElementSibling;
            while(nextEl) {
                if (nextEl.classList.contains('info-expanded-block')) {
                    nextEl.classList.toggle('show');
                    break;
                }
                nextEl = nextEl.nextElementSibling;
            }
        }

        function toggleEchelonTip(event, tipId) {
            event.stopPropagation();
            const allTips = document.querySelectorAll('.echelon-tip');
            allTips.forEach(t => {
                if(t.id !== tipId) t.classList.remove('show');
            });
            const tip = document.getElementById(tipId);
            if(tip) tip.classList.toggle('show');
        }

        function showYieldInfo(event) {
            event.stopPropagation();
            const infoBox = document.getElementById('yield-info-box');
            if (infoBox) {
                infoBox.classList.toggle('show');
            }
        }
        
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeBtn');
            const sunIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
            const moonIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode'); body.classList.add('light-mode');
                btn.innerHTML = moonIcon; localStorage.setItem('user_theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode'); btn.innerHTML = sunIcon; localStorage.setItem('user_theme', 'dark');
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('user_theme');
            const btn = document.getElementById('themeBtn');
            const sunIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
            const moonIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
            if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); btn.innerHTML = sunIcon; }
            else { document.body.classList.add('light-mode'); btn.innerHTML = moonIcon; }
        }

        function saveSettings() {
            const settings = { sum: document.getElementById('sumInput').value, ratio: document.getElementById('ratioSlider').value, fee: brokerFee, tax: currentTax };
            localStorage.setItem('invest_settings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('invest_settings');
            if (saved) {
                const s = JSON.parse(saved);
                document.getElementById('sumInput').value = s.sum || 100000;
                document.getElementById('ratioSlider').value = s.ratio || 50;
                brokerFee = parseFloat(s.fee) || 0.0003; currentTax = parseFloat(s.tax) || 0.13;
                document.querySelectorAll('.fee-btn').forEach(btn => btn.classList.toggle('active', parseFloat(btn.getAttribute('onclick').match(/[\d.]+/)) === brokerFee));
                document.querySelectorAll('.tax-ui-btn').forEach(btn => {
                    if(!btn.id.includes('tax-custom')) {
                        btn.classList.toggle('active', parseFloat(btn.getAttribute('onclick').match(/[\d.]+/)) === currentTax);
                    }
                });
            }
        }

        function resetRatio() {
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            document.getElementById('ratioSlider').value = 50; draw();
        }

        function setFee(val, btn) {
            brokerFee = val;
            document.querySelectorAll('.fee-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); draw();
        }

        function setTax(val, btn) {
            currentTax = val;
            document.querySelectorAll('#taxGroup .tax-ui-btn').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
            draw();
        }
        
        function setCustomTax(val, btn) {
            customTax = val;
            document.getElementById('tax-custom-0').classList.remove('active');
            document.getElementById('tax-custom-13').classList.remove('active');
            document.getElementById('tax-custom-15').classList.remove('active');
            btn.classList.add('active');
            distributeMonthlyInvestment();
        }

        function shortenTicker(t) { return t.length > 7 ? t.substring(0, 7) : t; }
        function limitName(n) { return n.length > 18 ? n.substring(0, 16) + '...' : n; }
        function hideAllTips(event) { 
            document.querySelectorAll('.echelon-tip, .info-preview-box').forEach(el => {
                if(!el.contains(event.target) && !event.target.closest('.section-header-styled')) {
                    el.classList.remove('show')
                }
            });
            if(event && event.target.tagName !== 'INPUT') { 
                if(document.getElementById('sumInput')) document.getElementById('sumInput').blur();
                if(document.getElementById('monthlySumInput')) document.getElementById('monthlySumInput').blur();
            } 
        }
        function toggleRow(el) { el.classList.toggle('active'); }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.innerText = `: ${text}`;
                toast.className = "toast show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
            });
        }
        
        function copyTicker(e, text) {
            e.stopPropagation();
            copyToClipboard(text);
        }
        
        function openTradingView(e, ticker) {
            e.stopPropagation();
            const url = `https://ru.tradingview.com/chart/?symbol=MOEX:${ticker}`;
            window.open(url, '_blank');
        }

        async function fetchBondData(code) {
            //    , 
            if (!code) return { nkd: 0, matDate: '', price: 0 };
            try {
                const res = await fetch(`https://iss.moex.com/iss/engines/stock/markets/bonds/securities/${code}.json?iss.meta=off&iss.only=securities,marketdata`);
                const data = await res.json(); 
                
                const sec_cols = data.securities.columns; 
                const sec_row = data.securities.data[0];
                
                let lastPrice = 0;
                
                //     marketdata (LAST  PREVPRICE)
                if (data.marketdata && data.marketdata.data.length > 0) {
                     const m_cols = data.marketdata.columns;
                     const m_row = data.marketdata.data[0];
                     const lastIdx = m_cols.indexOf('LAST');
                     const prevIdx = m_cols.indexOf('PREVPRICE');

                     //   LAST
                     if (lastIdx !== -1 && m_row[lastIdx]) {
                        lastPrice = m_row[lastIdx];
                     } 
                     //  LAST ,   PREVPRICE
                     else if (prevIdx !== -1 && m_row[prevIdx]) {
                        lastPrice = m_row[prevIdx];
                     }
                }
                
                //   marketdata  ,  PREVPRICE  securities
                if (!lastPrice && sec_row) {
                     const prevPriceIdx = sec_cols.indexOf('PREVPRICE');
                     if (prevPriceIdx !== -1 && sec_row[prevPriceIdx]) {
                         lastPrice = sec_row[prevPriceIdx];
                     }
                }

                bondCouponsMap[code] = { date: sec_row[sec_cols.indexOf('NEXTCOUPON')], value: parseFloat(sec_row[sec_cols.indexOf('COUPONVALUE')]) || 0 };
                
                const couponPeriod = parseFloat(sec_row[sec_cols.indexOf('COUPONPERIOD')]) || 0;
                const freq = couponPeriod > 0 ? Math.round(365 / couponPeriod) : 0;
                bondDetailsMap[code] = {
                    matDate: sec_row[sec_cols.indexOf('MATDATE')] || '',
                    couponValue: parseFloat(sec_row[sec_cols.indexOf('COUPONVALUE')]) || 0,
                    nextCoupon: sec_row[sec_cols.indexOf('NEXTCOUPON')] || '',
                    couponYield: sec_row[sec_cols.indexOf('COUPONPERCENT')] || '',
                    freq: freq
                };

                return { 
                    nkd: parseFloat(sec_row[sec_cols.indexOf('ACCRUEDINT')]) || 0, 
                    matDate: sec_row[sec_cols.indexOf('MATDATE')] || '', 
                    price: lastPrice //    (  )
                };
            } catch (e) { 
                console.error(`Failed to fetch data for ticker: ${code}`, e);
                return { nkd: 0, matDate: '', price: 0 }; 
            }
        }

        async function loadData() {
            initTheme();
            loadSettings();
            checkFirstVisit();
            updateMarketData();
            updateMarketStatus();
            
            try {
                const response = await fetch(CSV_URL);
                const text = await response.text();
                const rows = text.split('\n').map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim()));

                //       AQ2-AQ5
// AQ   43 (0-based index = 42)
if (rows.length > 1 && rows[1].length > 42) {
    // AQ2 -  
    const keyRateVal = rows[1][42]; //  2,  AQ
    if (keyRateVal) ratesData.keyRate = keyRateVal.includes('%') ? keyRateVal : keyRateVal + '%';
}
if (rows.length > 2 && rows[2].length > 42) {
    // AQ3 -    
    const depositRateVal = rows[2][42]; //  3,  AQ
    if (depositRateVal) ratesData.depositRate = depositRateVal.includes('%') ? depositRateVal : depositRateVal + '%';
}
if (rows.length > 3 && rows[3].length > 42) {
    // AQ4 - 
    const inflationVal = rows[3][42]; //  4,  AQ
    if (inflationVal) ratesData.inflation = inflationVal.includes('%') ? inflationVal : inflationVal + '%';
}
if (rows.length > 4 && rows[4].length > 42) {  
    const ofz10Val = rows[4][42]; //  5,  AQ (AQ5)
    if (ofz10Val) ratesData.ofz10 = ofz10Val.includes('%') ? ofz10Val : ofz10Val + '%';
}

//  
updateRatesDisplay();
                
                // ---  50/50 ( ) ---
                let bondList = [];
                for (let i = 2; i <= 9; i++) { if (rows[i] && rows[i].length > 13 && rows[i][10]) bondList.push({ t: rows[i][10], n: rows[i][11], p: parseFloat(rows[i][12].replace(',', '.')) || 0, y: rows[i][13] || '0%' }); }
                const bondPromises = bondList.map(async (b) => { const extra = await fetchBondData(b.t); return { ...b, nkd: extra.nkd, matDate: extra.matDate }; });
                bonds = await Promise.all(bondPromises);

                // --- :     ---
                
                allScheduledPayments = []; 
                let uniqueBondsForCalc = new Map();

                //   3-  14-  ( 2-13)
                for (let i = 2; i <= 13; i++) {
                    if (!rows[i] || rows[i].length < 34) continue;
                    
                    // 1.     ( )
                    const ticker = rows[i][31]; // AF
                    if (ticker) { //        
                        if (!uniqueBondsForCalc.has(ticker)) {
                            uniqueBondsForCalc.set(ticker, {
                                t: ticker,          // AF3:AF14
                                n: rows[i][32],     // AG3:AG14
                                y: rows[i][33]      // AH3:AH14
                            });
                        }
                    }

                    // 2.    12  ( )
                    allScheduledPayments.push({
                        dateStr: rows[i][27] || "---",       // AB3:AB14
                        displayName: rows[i][28] || "---",  // AC3:AC14
                        //    AF    
                        paymentTicker: rows[i][31] || ""    // AF3:AF14
                    });
                }
                
                // 3.   API    
                let uniqueBondsList = Array.from(uniqueBondsForCalc.values());
                const monthlyBondsPromises = uniqueBondsList.map(async (b) => {
                    const extra = await fetchBondData(b.t);
                    //     10
                    const price = (extra.price > 0) ? extra.price * 10 : 0; 
                    return { ...b, p: price, nkd: extra.nkd };
                });
                
                monthlyIncomeBonds = await Promise.all(monthlyBondsPromises);
                
                // ---    ---

                let allStocks = [];
                for (let i = 11; i <= 22; i++) { if (rows[i] && rows[i].length > 13 && rows[i][10]) allStocks.push({ t: rows[i][10], n: rows[i][11], p: parseFloat(rows[i][12].replace(',', '.')) || 0, target: rows[i][13] || '' });
                }
                if (allStocks.length > 0) { 
                    echelons[0].assets = allStocks.slice(0, 3);
                    echelons[1].assets = allStocks.slice(3, 6); 
                    echelons[2].assets = allStocks.slice(6, 9); 
                    echelons[3].assets = allStocks.slice(9, 12);
                }

                echelonTableData = [[], [], [], []];
                for (let i = 2; i <= 13; i++) {
                     if (rows[i] && rows[i].length > 23) {
                        if(rows[i][16]) echelonTableData[0].push({ t: rows[i][16], target: rows[i][17] || '' });
                        if(rows[i][18]) echelonTableData[1].push({ t: rows[i][18], target: rows[i][19] || '' });
                        if(rows[i][20]) echelonTableData[2].push({ t: rows[i][20], target: rows[i][21] || '' });
                        if(rows[i][22]) echelonTableData[3].push({ t: rows[i][22], target: rows[i][23] || '' });
                    }
                }
                
                renderCustomBondCalc();
                distributeMonthlyInvestment();
                updateRatesDisplay();
                draw();
            } catch (e) { 
                console.error("Error in loadData:", e); 
            }
        }

        // --- MONTHLY INCOME CALCULATOR LOGIC ---
        
        const mInput = document.getElementById('monthlySumInput');
        if(mInput) {
            mInput.addEventListener('focus', () => {
                document.getElementById('navWrapper').style.display = 'none';
                document.querySelector('.header').style.display = 'none';
            });
            mInput.addEventListener('blur', () => {
                document.getElementById('navWrapper').style.display = 'flex';
                document.querySelector('.header').style.display = 'block';
            });
        }

        function changeQty(ticker, delta) {
            const input = document.getElementById(`input-${ticker}`);
            if(input) {
                let val = parseInt(input.value) || 0;
                val = Math.max(0, val + delta);
                input.value = val;
                updateMonthlySumFromQuantities();
            }
        }
        
        function resetOne(ticker) {
             const input = document.getElementById(`input-${ticker}`);
             if(input) {
                 input.value = 0;
                 updateMonthlySumFromQuantities();
             }
        }
        
        function updateMonthlySumFromQuantities() {
            if (isUpdatingProgrammatically) return;
            let totalSum = 0;
            monthlyIncomeBonds.forEach(bond => {
                const input = document.getElementById(`input-${bond.t}`);
                if (input) {
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0) {
                        const fullCost = (bond.p + bond.nkd); // No tax on input sum
                        totalSum += qty * fullCost;
                    }
                }
            });

            isUpdatingProgrammatically = true;
            document.getElementById('monthlySumInput').value = Math.round(totalSum);
            isUpdatingProgrammatically = false;

            recalcCustomCoupons();
        }

        function distributeMonthlyInvestment() {
            if (isUpdatingProgrammatically) return;

            const sumInput = document.getElementById('monthlySumInput');
            const totalSum = parseFloat(sumInput.value) || 0;
            
            if (monthlyIncomeBonds.length === 0 || totalSum <= 0) {
                 monthlyIncomeBonds.forEach(bond => {
                    const input = document.getElementById(`input-${bond.t}`);
                    if(input) input.value = 0;
                });
                recalcCustomCoupons();
                return;
            };

            const budgetPerBond = totalSum / monthlyIncomeBonds.length;
            let currentTotalSpent = 0;
            
            let calcList = monthlyIncomeBonds.map(b => {
                let yieldNum = parseFloat(b.y.replace(/[^\d.-]/g, '')) || 0;
                let fullPrice = b.p + b.nkd;
                return { ...b, yieldNum, fullPrice, qty: 0, cost: 0 };
            });

            calcList.forEach(bond => {
                if (bond.fullPrice > 0) {
                    bond.qty = Math.floor(budgetPerBond / bond.fullPrice);
                    bond.cost = bond.qty * bond.fullPrice;
                    currentTotalSpent += bond.cost;
                }
            });

            let remainder = totalSum - currentTotalSpent;

            if (remainder > 0) {
                calcList.sort((a,b) => b.yieldNum - a.yieldNum);
                
                for (const bond of calcList) {
                    if (bond.fullPrice > 0 && remainder >= bond.fullPrice) {
                        const extraQty = Math.floor(remainder / bond.fullPrice);
                        if (extraQty > 0) {
                            bond.qty += extraQty;
                            remainder -= extraQty * bond.fullPrice;
                        }
                    }
                }
            }

            isUpdatingProgrammatically = true; 
            calcList.forEach(bond => {
                const input = document.getElementById(`input-${bond.t}`);
                if(input) input.value = bond.qty;
            });
            isUpdatingProgrammatically = false;

            recalcCustomCoupons();
        }

        function renderCustomBondCalc() {
            const container = document.getElementById('calc-bonds-input-list');
            if(!container) return;
            
            let html = '';
            
            monthlyIncomeBonds.forEach(b => {
                html += `
                <div class="calc-bond-row">
                    <div class="unified-badge-container" style="flex-direction:column; align-items:flex-start; gap: 3px;">
                        <div class="ub-name" style="width:100%">${limitName(b.n)}</div>
                        <div style="font-size:9px; color:#888; margin-top:2px; padding-left:2px;">
                           (: ${b.p.toFixed(2)} + : ${b.nkd.toFixed(2)})
                        </div>
                    </div>
                    
                    <div class="ub-yield">${b.y.replace('%', '')}%</div>
                    
                    <div class="qty-controls">
                        <div class="qty-btn" onclick="changeQty('${b.t}', -1)"></div>
                        <input type="number" id="input-${b.t}" class="calc-input" data-ticker="${b.t}" value="0" min="0" oninput="updateMonthlySumFromQuantities()">
                        <div class="qty-btn" onclick="changeQty('${b.t}', 1)">+</div>
                        
                        <div class="btn-row-reset" onclick="resetOne('${b.t}')">
                            <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function resetCustomCalc() {
            isUpdatingProgrammatically = true;
            document.getElementById('monthlySumInput').value = 0;
            isUpdatingProgrammatically = false;
            const inputs = document.querySelectorAll('.calc-input');
            inputs.forEach(input => input.value = 0);
            recalcCustomCoupons();
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        function recalcCustomCoupons() {
    const resultList = document.getElementById('calc-results-list');
    const resultFooter = document.getElementById('calc-results-footer');
    if (!resultList || !resultFooter) return;
    
    let html = '';
    let totalAmount = 0;

    if (typeof allScheduledPayments === 'undefined' || allScheduledPayments.length === 0) {
         resultList.innerHTML = "  ...";
         return;
    }
    
    //      
    const tickerQuantities = {};
    allScheduledPayments.forEach(payment => {
        if (payment.paymentTicker) {
            const cleanTicker = payment.paymentTicker.trim();
            if (!tickerQuantities.hasOwnProperty(cleanTicker)) {
                const input = document.getElementById(`input-${cleanTicker}`);
                tickerQuantities[cleanTicker] = input ? (parseInt(input.value) || 0) : 0;
            }
        }
    });
    
    //   HTML      
    allScheduledPayments.forEach(payment => {
        let qty = 0;
        if (payment.paymentTicker) {
            const cleanTicker = payment.paymentTicker.trim();
            qty = tickerQuantities[cleanTicker] || 0;
        }
        
        const grossAmount = (payment.staticCouponVal || 0) * qty;
        const netAmount = grossAmount * (1 - customTax);
        totalAmount += netAmount;

        html += `
        <div class="coupon-row">
            <div><b>${payment.dateStr}</b></div>
            <div style="color:#8e8e93; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${limitName(payment.displayName)}</div>
            <div style="text-align:center">${qty} .</div>
            <div style="text-align:right"><b>${Math.round(netAmount).toLocaleString()} </b></div>
        </div>`;
    });

    resultList.innerHTML = html;

    const yearTotal = Math.round(totalAmount).toLocaleString();
    const monthAvg = Math.round(totalAmount / 12).toLocaleString();
    
    resultFooter.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
            <span>  :</span>
            <span>${yearTotal} </span>
        </div>
        <div style="display:flex; justify-content:space-between; color:var(--accent-green);">
            <span>  :</span>
            <span style="font-size:14px; font-weight:800;">${monthAvg} </span>
        </div>
    `;
}


        // --- END OF MONTHLY CALC LOGIC ---

        function updateEchelonTable() {
            const body = document.getElementById('echelon-tickers-body');
            if(!body) return;
            let html = '';
            const maxRows = Math.max(...echelonTableData.map(col => col.length));
            for(let i=0; i<maxRows; i++) {
                html += '<tr>';
                for(let j=0; j<4; j++) {
                    const asset = echelonTableData[j][i];
                    if(asset) html += `<td onclick="copyToClipboard('${asset.t}')"><span class="et-ticker">${asset.t}</span><span class="et-target">${asset.target.replace(' ','')}</span></td>`;
                    else html += `<td></td>`;
                }
                html += '</tr>';
            }
            body.innerHTML = html;
        }

        function performSearch(query) {
            if(!query || query.length < 2) {
                openCompanyPage(null, query);
                return;
            }
            
            const q = query.toUpperCase();
            let results = [];
            echelons.forEach(e => {
                e.assets.forEach(a => {
                    if(a.t.toUpperCase().includes(q) || a.n.toUpperCase().includes(q)) results.push({...a, type: ''});
                });
            });
            bonds.forEach(b => {
                if(b.t.toUpperCase().includes(q) || b.n.toUpperCase().includes(q)) results.push({...b, type: ''});
            });
            
            const input = document.getElementById('tickerSearchInput');
            input.value = '';
            input.blur();
            
            openCompanyPage(results[0] || null, query);
        }
        
        async function openCompanyPage(item, searchQuery = '') {
            const content = document.getElementById('company-content');
            
            if(!item) {
                content.innerHTML = `
                    <div class="search-empty-state">
                        <div class="icon"></div>
                        <div class="title">  </div>
                        <div class="desc">  "${searchQuery}"   .<br>  .</div>
                    </div>
                `;
                showScreen('screen-company');
                return;
            }
            
            const isStock = item.type === '';
            const target = isStock ? item.target : '-';
            const yieldVal = isStock ? '. ' : item.y;
            
            let changeHtml = '<div class="cc-v2-change neutral">--</div>';
            
            try {
                const url = `https://iss.moex.com/iss/engines/stock/markets/${isStock ? 'shares' : 'bonds'}/securities/${item.t}.json?iss.meta=off&iss.only=securities,marketdata`;
                const res = await fetch(url);
                const data = await res.json();
                const marketdata = data.marketdata.data[0];
                const marketcols = data.marketdata.columns;
                const last = marketdata[marketcols.indexOf('LAST')];
                const open = marketdata[marketcols.indexOf('OPEN')];
                
                if (last && open && open > 0) {
                    const change = last - open;
                    const changePct = (change / open) * 100;
                    const sign = change > 0 ? '+' : '';
                    const colorClass = change > 0 ? 'positive' : (change < 0 ? 'negative' : 'neutral');
                    changeHtml = `<div class="cc-v2-change ${colorClass}">${sign}${change.toFixed(2)} (${sign}${changePct.toFixed(2)}%)</div>`;
                }
            } catch (e) { console.log('Error fetching company details'); }

            let html = `
                <div class="company-card-v2">
                    <div class="cc-v2-header">
                        <div class="cc-v2-logo">${item.t}</div>
                        <div>
                            <div class="cc-v2-name">${item.n}</div>
                            <div class="cc-v2-type">${item.type}</div>
                        </div>
                    </div>
                    <div class="cc-v2-price-block">
                         <div class="cc-v2-price">${item.p} </div>
                         ${changeHtml}
                    </div>
                    <button class="btn-action" onclick="openTradingView(event, '${item.t}')">  TradingView</button>
                </div>
                
                <div class="news-header"></div>
                <div class="stat-grid">
                     <div class="stat-item">
                        <div class="stat-label">${isStock ? '' : ''}</div>
                        <div class="stat-val" style="color:var(--accent-green)">${isStock ? target : yieldVal}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label"></div>
                        <div class="stat-val">${isStock ? (echelons.findIndex(e => e.assets.some(a => a.t === item.t)) + 1) : 'N/A'}</div>
                    </div>
                </div>
                
                <div class="news-header"> </div>
                <div id="company-news-list">
                    <div class="news-item">
                         <div class="news-date"></div>
                         <div class="news-title">    ${item.t}</div>
                         <div class="news-snippet">      .     ...</div>
                    </div>
                     <div class="news-item">
                         <div class="news-date"></div>
                         <div class="news-title"> </div>
                         <div class="news-snippet">     .    ...</div>
                    </div>
                </div>
            `;
            content.innerHTML = html;
            showScreen('screen-company');
        }

        function draw() {
            saveSettings();
            const inputSum = parseFloat(document.getElementById('sumInput').value) || 0;
            const bondPct = parseInt(document.getElementById('ratioSlider').value);
            const stockPct = 100 - bondPct;
            
            // Check Presets (for visual matching, but class removal handled by setPresetRatio)
            // Just ensure consistent visual state if slider dragged manually
            const presets = document.querySelectorAll('.preset-btn-modern');
            presets.forEach(p => {
                 const pct = parseInt(p.getAttribute('onclick').match(/\d+/)[0]);
                 if(pct !== bondPct) p.classList.remove('selected-preset');
                 else p.classList.add('selected-preset');
            });


            const bondBudget = (inputSum * bondPct) / 100;
            const stockBudget = (inputSum * stockPct) / 100;
            const feeVal = inputSum * brokerFee;

            if(document.getElementById('labelBondsPct')) {
                document.getElementById('labelBondsPct').innerText = bondPct;
                document.getElementById('labelStocksPct').innerText = stockPct;
                document.getElementById('dynamicSubtitle').innerText = ` ${bondPct}/${stockPct}:    .`;
                document.querySelectorAll('.bond-pct-text').forEach(el => el.innerText = bondPct);
                document.querySelectorAll('.stock-pct-text').forEach(el => el.innerText = stockPct);
                document.getElementById('mainChart').style.background = `conic-gradient(var(--accent-blue) 0% ${bondPct}%, var(--accent-green) ${bondPct}% 100%)`;
                document.getElementById('mainChart').setAttribute('data-pct', `${bondPct}/${stockPct}`);
            }

            const bondSection = document.getElementById('section-bonds');
            const couponBox = document.getElementById('couponBox');
            const separator = document.getElementById('section-separator');
            const stockSection = document.getElementById('section-stocks');
            const stockHeader = document.getElementById('header-stocks');
            const footerImportant = document.getElementById('footer-important');
            
            if(bondSection && stockSection) {
                bondSection.style.display = 'block'; couponBox.style.display = 'block';
                separator.style.display = 'flex'; stockSection.style.display = 'block';
                footerImportant.style.display = 'block'; stockHeader.innerText = "2.  ";
                if (bondPct === 0) {
                    bondSection.style.display = 'none'; couponBox.style.display = 'none';
                    separator.style.display = 'none'; stockHeader.innerText = "1.  ";
                } else if (bondPct === 100) {
                    stockSection.style.display = 'none'; footerImportant.style.display = 'none';
                    separator.style.display = 'none';
                }
            }

            let actualSpentTotal = 0; let bondQuantities = {};
            let totalBondProjectedIncome = 0;
            let rainData = [];
            
            let bHtml = '';
            if (bonds.length > 0) {
                const perBondBudget = bondBudget / bonds.length;
                let bondCalculations = bonds.map(b => { const fullCostPerUnit = (b.p + b.nkd) * (1 + brokerFee); let qty = fullCostPerUnit > 0 ? Math.floor(perBondBudget / fullCostPerUnit) : 0; return { ...b, qty, fullCostPerUnit }; });
                let leftover = bondBudget - bondCalculations.reduce((acc, b) => acc + (b.qty * b.fullCostPerUnit), 0);
                if (bondCalculations.length > 0 && leftover >= bondCalculations[0].fullCostPerUnit && bondCalculations[0].fullCostPerUnit > 0) {
                    bondCalculations[0].qty += Math.floor(leftover / bondCalculations[0].fullCostPerUnit);
                }
                bondCalculations.forEach(b => {
                    actualSpentTotal += (b.qty * b.fullCostPerUnit); bondQuantities[b.t] = b.qty;
                    const bondYieldVal = parseFloat(b.y.replace('%', '')) || 0;
                    const investedInBond = b.qty * b.p;
                    totalBondProjectedIncome += (investedInBond * (bondYieldVal / 100) * 3);
                    if(b.qty > 0 && bondCouponsMap[b.t]) {
                         const info = bondCouponsMap[b.t];
                         const netAmount = (info.value * b.qty) * (1 - currentTax);
                         rainData.push({ date: info.date, name: b.n, qty: b.qty, amount: netAmount });
                    }
                    bHtml += `
                    <div class="asset-item" onclick="toggleRow(this)">
                        <span class="ticker" style="font-weight:700; font-size:11px;">${limitName(b.n)}</span>
                        <span class="asset-name"><span class="asset-yield-badge">${b.y}</span></span>
                        <span class="qty">${b.qty} .</span>
                        <span class="price-total">${Math.round(b.qty * b.p).toLocaleString()} </span>
                        <div class="details">
                            <div class="detail-row"><span> :</span> <span>${b.n}</span></div>
                            <div class="detail-row"><span>:</span> <span>${b.t}</span></div>
                            <div class="detail-row"><span> :</span> <span>${b.matDate}</span></div>
                            <div class="detail-row"><span>:</span> <span>${b.p} </span></div>
                            <div class="detail-row"><span>:</span> <span>${b.nkd.toFixed(2)} </span></div>
                            <div class="detail-row"><span>   :</span> <span>${b.y.replace(' ','')}</span></div>
                            <button class="btn-tiny-graph" onclick="openTradingView(event, '${b.t}')">
                                <svg style="width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                                 
                            </button>
                        </div>
                    </div>`;
                });
            }
            if(document.getElementById('listBonds')) { document.getElementById('listBonds').innerHTML = bHtml;
            document.getElementById('valBonds').innerText = Math.round(bondBudget).toLocaleString(); }
            
            if(document.getElementById('couponList')) {
                rainData.sort((a,b) => new Date(a.date) - new Date(b.date));
                let couponHtml = ''; let couponTotal = 0;
                if(rainData.length === 0) { 
                    couponHtml = '<div style="text-align:center; padding:15px; color:#aaa; font-size:12px;">     .</div>';
                } else { 
                    rainData.forEach(r => { 
                        couponTotal += r.amount; 
                        couponHtml += `
                        <div class="coupon-row">
                            <div><b>${new Date(r.date).toLocaleDateString('ru-RU')}</b></div>
                            <div style="color:#8e8e93">${limitName(r.name)}</div>
                            <div style="text-align:center">${r.qty}.</div>
                            <div style="text-align:right"><b>${Math.round(r.amount).toLocaleString()}</b></div>
                        </div>`; 
                    }); 
                }
                document.getElementById('couponList').innerHTML = couponHtml;
                document.getElementById('couponTotalHeader').innerText = Math.round(couponTotal).toLocaleString() + ' ';
            }
            
            let ofzHtml = '';
            bonds.forEach(b => {
                const details = bondDetailsMap[b.t] || { matDate:'', couponValue:0, nextCoupon:'', couponYield:'', freq:0 };
                const calculatedCY = (b.p > 0 && details.couponValue && details.freq) ? ((details.couponValue * details.freq) / b.p * 100).toFixed(2) : '0.00';
                ofzHtml += `
                <div class="ofz-card-modern" onclick="toggleOfzDetails('details-${b.t}')">
                    <div class="ofz-main-info">
                        <div class="ofz-name-lg">${limitName(b.n)}</div>
                        <div class="ofz-ticker-sm">${b.t}</div>
                    </div>
                    <div class="ofz-price">${b.p}</div>
                    <div class="ofz-nkd-badge">${Math.round(b.nkd*10)/10}</div>
                    <div class="ofz-yield-badge" title="  ">
                        ${b.y} <svg class="ofz-arrow" viewBox="0 0 24 24"><path d="M7 17l9.2-9.2M17 17V7H7"/></svg>
                    </div>
                </div>
                <div id="details-${b.t}" class="ofz-details-panel">
                    <div class="ofz-detail-row"><span>:</span> <span class="ofz-detail-val">${b.t}</span></div>
                    <div class="ofz-detail-row"><span>:</span> <span class="ofz-detail-val">${b.nkd.toFixed(2)} </span></div>
                    <div class="ofz-detail-row"><span> :</span> <span class="ofz-detail-val">${details.matDate}</span></div>
                    <div class="ofz-detail-row"><span> :</span> <span class="ofz-detail-val">${details.couponValue} </span></div>
                    <div class="ofz-detail-row"><span>  :</span> <span class="ofz-detail-val">${details.nextCoupon}</span></div>
                    <div class="ofz-detail-row"><span>  :</span> <span class="ofz-detail-val">${calculatedCY}%</span></div>
                    <div class="ofz-detail-row"><span>  :</span> <span class="ofz-detail-val">${details.freq}</span></div>
                </div>`;
            });
            if(document.getElementById('ofz-list')) document.getElementById('ofz-list').innerHTML = ofzHtml;

            let eHtml = '';
            let totalStockProjectedGrowth = 0;
            let echelonIndex = 0;
            echelons.forEach(e => {
                const echelonBudget = stockBudget * e.weight; const perAssetBudget = e.assets.length > 0 ? echelonBudget / e.assets.length : 0;
                let stockCalculations = e.assets.map(a => { const fullCostPerUnit = a.p * (1 + brokerFee); let qty = fullCostPerUnit > 0 ? Math.floor(perAssetBudget / fullCostPerUnit) : 0; return { ...a, qty, fullCostPerUnit }; });
                let currentEchelonSpent = stockCalculations.reduce((acc, s) => acc + (s.qty * s.fullCostPerUnit), 0);
                if (stockCalculations.length > 0 && (echelonBudget - currentEchelonSpent) >= stockCalculations[0].fullCostPerUnit) {
                    stockCalculations[0].qty += Math.floor((echelonBudget - currentEchelonSpent) / stockCalculations[0].fullCostPerUnit);
                }
                const tipId = `echelon-tip-${echelonIndex}`;
                const echelonClass = `echelon-${echelonIndex + 1}`;
                eHtml += `
                <div class="echelon-separator-modern ${echelonClass}">
                    <div class="esm-left">
                        <div class="esm-dot"></div>
                        <span class="esm-title">${e.title}</span>
                        <div class="esm-info-btn-light" onclick="toggleEchelonTip(event, '${tipId}')">
                             <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        </div>
                    </div>
                    <div class="esm-pct">
                        <span class="esm-sum">${Math.round(echelonBudget).toLocaleString()} </span>
                        <span class="esm-divider">|</span>
                        <span class="esm-percent">${Math.round(e.weight*100)}%</span>
                    </div>
                </div>
                <div class="echelon-tip" id="${tipId}">${e.info}</div>
                <div class="asset-list">`;
                stockCalculations.forEach(s => {
                    actualSpentTotal += (s.qty * s.fullCostPerUnit);
                    const targetPrice = parseFloat(s.target.replace(/[^\d.]/g,'')) || s.p;
                    if(targetPrice > s.p) totalStockProjectedGrowth += (s.qty * (targetPrice - s.p));
                    eHtml += `
                    <div class="asset-item" onclick="toggleRow(this)">
                        <span class="ticker">${s.t}</span>
                        <span class="asset-name"><span class="asset-yield-badge blue">${s.target.replace(' ','')}</span></span>
                        <span class="qty">${s.qty} .</span>
                        <span class="price-total">${Math.round(s.qty*s.p).toLocaleString()} </span>
                        <div class="details">
                            <div class="detail-row"><span>:</span> <span>${s.n}</span></div>
                            <div class="detail-row"><span>:</span> <span style="cursor:pointer; color:var(--accent-blue); font-weight:bold;" onclick="copyTicker(event, '${s.t}')">${s.t} </span></div>
                            <div class="detail-row"><span>:</span> <span>${s.p} </span></div>
                            <div class="detail-row"><span>:</span> <span>${s.target.replace(' ','')}</span></div>
                            <div style="font-size:10px; color:#aaa; margin:5px 0 8px;">[     36 . ]</div>
                            <button class="btn-tiny-graph" onclick="openTradingView(event, '${s.t}')">
                                <svg style="width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                                 
                            </button>
                        </div>
                    </div>`;
                });
                eHtml += `</div>`;
                echelonIndex++;
            });
            if(document.getElementById('echelonContainer')) {
                document.getElementById('echelonContainer').innerHTML = eHtml;
                document.getElementById('valStocks').innerText = Math.round(stockBudget).toLocaleString();
                document.getElementById('usageFill').style.width = Math.min((actualSpentTotal / inputSum) * 100, 100) + '%';
                document.getElementById('usageLabelText').innerText = Math.round(actualSpentTotal).toLocaleString() + ' ';
                document.getElementById('summ-invested').innerText = Math.round(inputSum).toLocaleString() + ' ';
                document.getElementById('srl-bond-pct').innerText = bondPct + '%';
                document.getElementById('srl-stock-pct').innerText = stockPct + '%';
                document.getElementById('bar-bond-fill').style.width = bondPct + '%';
                document.getElementById('bar-stock-fill').style.width = stockPct + '%';
                const activeFeeBtn = document.querySelector('.fee-btn.active');
                document.getElementById('summ-fee').innerText = activeFeeBtn ? activeFeeBtn.innerText : '0.03%';
                document.getElementById('summ-bond-income').innerText = '+' + Math.round(totalBondProjectedIncome).toLocaleString() + ' ';
                document.getElementById('summ-stock-growth').innerText = '+' + Math.round(totalStockProjectedGrowth).toLocaleString() + ' ';
                const projectedTotal = inputSum + totalBondProjectedIncome + totalStockProjectedGrowth - feeVal;
                let percentageChange = (inputSum > 0) ? ((projectedTotal - inputSum) / inputSum) * 100 : 0;
                const changeSign = percentageChange >= 0 ? '+' : '';
                const changeColor = percentageChange >= 0 ? '#27ae60' : '#e74c3c';
                const changeHtml = ` <span style="font-size: 14px; color: ${changeColor}; font-weight: 500;">(${changeSign}${percentageChange.toFixed(1)}%)</span>`;
                document.getElementById('summ-total-3y').innerHTML = Math.round(projectedTotal).toLocaleString() + ' ' + changeHtml;
            }
            updateEchelonTable();
        }

        async function shareAsPDF() {
            const btn = document.getElementById('btnShare');
            const container = document.getElementById('shareContainer');
            const brand = document.getElementById('shareBrand'); 
            const dateEl = document.getElementById('shareDate');
            const originalText = btn.innerHTML;
            btn.innerText = "  PDF..."; btn.disabled = true; 
            brand.style.display = 'block'; dateEl.innerText = new Date().toLocaleString();
            try {
                const canvas = await html2canvas(container, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color'), scale: 2, logging: false, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                doc.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                const pdfBlob = doc.output('blob');
                if (navigator.share && navigator.canShare) {
                    const file = new File([pdfBlob], "Madame_Solomina_Portfolio.pdf", { type: "application/pdf" });
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: ' ', text: '  Madame Solomi\'na' });
                        btn.innerHTML = originalText; btn.disabled = false; brand.style.display = 'none'; return;
                    }
                }
                doc.save('Solomina_Portfolio.pdf');
                setTimeout(() => { btn.innerHTML = `  `; setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000); }, 500);
            } catch(e) {
                console.error(e); alert("    .   .");
                btn.innerHTML = originalText; btn.disabled = false;
            } finally { brand.style.display = 'none'; }
        }

    //  Service Worker  PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(function(registration) {
                    console.log('Service Worker :', registration);
                })
                .catch(function(error) {
                    console.log('  Service Worker:', error);
                });
        }


        loadData(); 
        if(window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready(); 
            window.Telegram.WebApp.expand();
            
            //      
            window.Telegram.WebApp.disableVerticalSwipes();
        }

       
        
        
    </script>
</body>
</html>
