<script>
    // Конфигурация
    const SHEET_ID = '1SFV5dBIsvfX5HKbXBuXHFVvBfw1p1MPPx2uK209ajLM';
    const GID = '1213653337'; // Ваш GID листа TELEGRAMBOT
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

    let bonds = [];
    let echelons = [
        { title: 'I Эшелон', weight: 0.30, assets: [] },
        { title: 'II Эшелон', weight: 0.40, assets: [] },
        { title: 'III Эшелон', weight: 0.15, assets: [] },
        { title: 'IV Эшелон', weight: 0.15, assets: [] }
    ];

    async function loadData() {
        try {
            const response = await fetch(CSV_URL);
            if (!response.ok) throw new Error('Ошибка сети');
            const text = await response.text();
            
            // Разбиваем CSV на строки и ячейки
            const rows = text.split('\n').map(row => 
                row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim())
            );

            // Очищаем данные перед заполнением
            bonds = [];
            let allStocks = [];

            // Парсим облигации (Строки 3-10 в таблице -> индексы 2-9)
            // K=10, L=11, M=12
            for (let i = 2; i <= 9; i++) {
                if (rows[i] && rows[i][10]) {
                    const rawPrice = rows[i][12] || "0";
                    bonds.push({
                        t: rows[i][10],
                        n: rows[i][11] || '',
                        p: parseFloat(rawPrice.replace(',', '.')) || 0
                    });
                }
            }

            // Парсим акции (Строки 12-23 в таблице -> индексы 11-22)
            for (let i = 11; i <= 22; i++) {
                if (rows[i] && rows[i][10]) {
                    const rawPrice = rows[i][12] || "0";
                    allStocks.push({
                        t: rows[i][10],
                        n: rows[i][11] || '',
                        p: parseFloat(rawPrice.replace(',', '.')) || 0
                    });
                }
            }

            // Распределяем по эшелонам (по 3 актива)
            if (allStocks.length > 0) {
                echelons[0].assets = allStocks.slice(0, 3);
                echelons[1].assets = allStocks.slice(3, 6);
                echelons[2].assets = allStocks.slice(6, 9);
                echelons[3].assets = allStocks.slice(9, 12);
            }

            draw();
        } catch (e) {
            console.error(e);
            document.getElementById('listBonds').innerHTML = 
                `<div style="color:red; padding:20px; text-align:center;">Ошибка загрузки. Проверьте публикацию листа TELEGRAMBOT.</div>`;
        }
    }

    function draw() {
        const total = parseFloat(document.getElementById('sumInput').value) || 0;
        const half = total / 2;

        document.getElementById('valBonds').innerText = Math.round(half).toLocaleString();
        document.getElementById('valStocks').innerText = Math.round(half).toLocaleString();

        // Облигации
        let bHtml = '';
        if (bonds.length > 0) {
            const bPart = half / bonds.length;
            bonds.forEach(b => {
                const q = b.p > 0 ? Math.floor(bPart / b.p) : 0;
                bHtml += `<div class="asset-item"><span class="ticker">${b.t}</span><span>${b.n}</span><span class="qty">${q} шт.</span><span class="price">${Math.round(q*b.p).toLocaleString()} ₽</span></div>`;
            });
        }
        document.getElementById('listBonds').innerHTML = bHtml || 'Данные не найдены';

        // Акции
        let eHtml = '';
        echelons.forEach(e => {
            eHtml += `<div class="echelon-title"><span>${e.title}</span><span>${e.weight*100}%</span></div><div class="asset-list">`;
            const ePart = e.assets.length > 0 ? (half * e.weight) / e.assets.length : 0;
            e.assets.forEach(a => {
                const q = a.p > 0 ? Math.floor(ePart / a.p) : 0;
                eHtml += `<div class="asset-item"><span class="ticker">${a.t}</span><span>${a.n}</span><span class="qty">${q} шт.</span><span class="price">${Math.round(q*a.p).toLocaleString()} ₽</span></div>`;
            });
            eHtml += `</div>`;
        });
        document.getElementById('echelonContainer').innerHTML = eHtml;
    }

    loadData();
    
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();
</script>
