<script>
    // 1. Константы для подключения к таблице
    const SHEET_ID = '1SFV5dBIsvfX5HKbXBuXHFVvBfw1p1MPPx2uK209ajLM';
    const SHEET_NAME = 'TELEGRAMBOT';
    // Ссылка для получения данных в формате CSV
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

    let bonds = [];
    let echelons = [
        { title: 'I Эшелон (Консервативный)', weight: 0.30, assets: [] },
        { title: 'II Эшелон (Умеренный)', weight: 0.40, assets: [] },
        { title: 'III Эшелон (Активный)', weight: 0.15, assets: [] },
        { title: 'IV Эшелон (Венчурный)', weight: 0.15, assets: [] }
    ];

    // 2. Функция загрузки данных
    async function loadDataFromSheet() {
        try {
            const response = await fetch(CSV_URL);
            const data = await response.text();
            const rows = data.split('\n').map(row => row.split(',').map(cell => cell.replace(/"/g, '')));

            // Парсим Облигации (K3:M10 -> индексы столбцов 10, 11, 12; строки 2-9)
            bonds = [];
            for (let i = 2; i <= 9; i++) {
                if (rows[i] && rows[i][10]) {
                    bonds.push({
                        t: rows[i][10], // Код
                        n: rows[i][11], // Название
                        p: parseFloat(rows[i][12].replace(/\s/g, '')) // Цена
                    });
                }
            }

            // Парсим Акции (K12:M23 -> строки 11-22)
            // Распределяем по эшелонам (в примере просто по порядку, можно добавить логику секторов)
            const allStocks = [];
            for (let i = 11; i <= 22; i++) {
                if (rows[i] && rows[i][10]) {
                    allStocks.push({
                        t: rows[i][10], // Тикер
                        n: rows[i][11], // Название
                        p: parseFloat(rows[i][12].replace(/\s/g, '')) // Цена
                    });
                }
            }

            // Пример распределения акций: по 3 штуки в каждый эшелон
            echelons[0].assets = allStocks.slice(0, 3);
            echelons[1].assets = allStocks.slice(3, 6);
            echelons[2].assets = allStocks.slice(6, 9);
            echelons[3].assets = allStocks.slice(9, 12);

            draw(); // Перерисовываем интерфейс с новыми данными
        } catch (e) {
            console.error("Ошибка загрузки данных:", e);
        }
    }

    // Остальные функции (hideKeyboard, draw) остаются как в твоем коде, 
    // только убери вызов draw() в самом конце и замени на:
    
    loadDataFromSheet();

    // Telegram JS
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();
</script>