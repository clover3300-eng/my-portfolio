<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal Madame Solomi'na</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Solomi'na">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <meta name="theme-color" content="#3498db">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --accent-orange: #e67e22;
            --accent-red: #e74c3c;
            --accent-gradient: linear-gradient(135deg, #3498db, #2980b9);
            --header-gradient: linear-gradient(135deg, #f8f9fa, #e9ecef);
            --header-light-gradient: linear-gradient(135deg, #e3f2fd, #f0f9ff); 
            --graphite-color: #303D4F;
            --input-color: #3a506b;
            --card-shadow: rgba(0,0,0,0.06);
            --border-color: rgba(0,0,0,0.04);
            --item-border: #f0f0f0;
            --nav-bg: rgba(255, 255, 255, 0.95);
            --nav-border: rgba(255, 255, 255, 0.5);
            --nav-icon-inactive: #bdc3c7;
            --coupon-blue-bg: rgba(52, 152, 219, 0.08);
            --badge-blue-bg: rgba(52, 152, 219, 0.15);
            --badge-green-bg: rgba(46, 204, 113, 0.15);
            --terminal-gradient: linear-gradient(90deg, #F1F6FB 0%, #F9FAFC 100%);
            --graphite-btn: #2C364C;
            --bg-gradient-start: #F1F6FB;
            --bg-gradient-end: #F9FAFC;
            --bonds-color: #5B7C99;
            --stocks-color: #94A8B8;
            /* === Claude AI Glassmorphism Variables === */
            --claude-bg-base: #F7F5F3;
            --claude-glass: rgba(255, 255, 255, 0.65);
            --claude-glass-border: rgba(255, 255, 255, 0.8);
            --claude-glass-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.04);
            --claude-accent: #D97757;
            --claude-accent-subtle: rgba(217, 119, 87, 0.1);
            --claude-text-primary: #1a1a1a;
            --claude-text-secondary: #6b6b6b;
            
            /* === AURORA DESIGN TOKENS === */
            --bg-base: #F3F4F6;
            --aurora-blue: rgba(59, 130, 246, 0.15);
            --aurora-green: rgba(16, 185, 129, 0.1);
            --aurora-orange: rgba(249, 115, 22, 0.08);
            --text-deep: #0F172A;
            --text-slate: #64748B;
            --text-muted: #94A3B8;
            --card-glass-aurora: rgba(255, 255, 255, 0.65);
            --card-border-aurora: rgba(255, 255, 255, 0.4);
            --shadow-luxury: 0 20px 40px -10px rgba(15, 23, 42, 0.05);
            --accent-purple: #8B5CF6;
        }

                /* ========== ОТКЛЮЧЕНИЕ ЭФФЕКТА РЕЗИНКИ ========== */
        html {
            overscroll-behavior: none;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        body {
            overscroll-behavior: none;
            min-height: 100%;
        }
        /* ================================================= */

    

        body.dark-mode {
            --bg-color: #0f172a;
            background: linear-gradient(180deg, #0f172a 0%, #1a2234 100%);
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-green: #4ade80;
            --accent-yellow: #fcd34d;
            --accent-orange: #fb923c;
            --accent-red: #f87171;
            --accent-gradient: linear-gradient(135deg, #38bdf8, #0ea5e9);
            --header-gradient: linear-gradient(135deg, #1e293b, #2d3748);
            --header-light-gradient: linear-gradient(135deg, #1e293b, #334155);
            --graphite-color: #303D4F;
            --input-color: #f8fafc;
            --card-shadow: rgba(0,0,0,0.4);
            --border-color: rgba(255,255,255,0.05);
            --item-border: #334155;
            --nav-bg: rgba(30, 41, 59, 0.95);
            --nav-border: rgba(255, 255, 255, 0.1);
            --nav-icon-inactive: #475569;
            --coupon-blue-bg: rgba(56, 189, 248, 0.1);
            --badge-blue-bg: rgba(56, 189, 248, 0.15);
            --badge-green-bg: rgba(74, 222, 128, 0.15);
            /* === Claude AI Dark Mode Variables === */
            --claude-bg-base: #1a1a2e;
            --claude-glass: rgba(30, 41, 59, 0.75);
            --claude-glass-border: rgba(255, 255, 255, 0.1);
            --claude-glass-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.3);
            --claude-accent: #E8956A;
            --claude-accent-subtle: rgba(232, 149, 106, 0.15);
            --claude-text-primary: #f1f5f9;
            --claude-text-secondary: #94a3b8;
            
            /* === AURORA DARK MODE TOKENS === */
            --bg-base: #0f172a;
            --aurora-blue: rgba(59, 130, 246, 0.12);
            --aurora-green: rgba(16, 185, 129, 0.08);
            --aurora-orange: rgba(249, 115, 22, 0.06);
            --text-deep: #f1f5f9;
            --text-slate: #94a3b8;
            --text-muted: #64748B;
            --card-glass-aurora: rgba(30, 41, 59, 0.75);
            --card-border-aurora: rgba(255, 255, 255, 0.1);
            --shadow-luxury: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
            --accent-purple: #A78BFA;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(180deg, #F1F6FB 0%, #F9FAFC 100%);
            color: var(--text-main);
            margin: 0; padding: 16px; line-height: 1.4;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 40px;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        .toast {
            position: fixed;
            top: 20px; left: 50%; transform: translateX(-50%);
            background: #2ecc71; color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 12px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .toast.show { opacity: 1; visibility: visible; }

        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        .screen.no-animate,
        .screen.no-animate * { animation: none !important; }
        .screen.swipe-prev,
        .screen.swipe-prev * { animation: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== SKELETON LOADER SYSTEM ========== */
        @keyframes skeletonShimmer {
            0% { background-position: -400px 0; }
            100% { background-position: 400px 0; }
        }
        @keyframes skeletonPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }

        .skeleton-bone {
            background: linear-gradient(90deg, 
                rgba(0,0,0,0.04) 25%, 
                rgba(0,0,0,0.08) 50%, 
                rgba(0,0,0,0.04) 75%);
            background-size: 800px 100%;
            animation: skeletonShimmer 1.8s ease-in-out infinite;
            border-radius: 8px;
        }
        body.dark-mode .skeleton-bone {
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.04) 25%, 
                rgba(255,255,255,0.08) 50%, 
                rgba(255,255,255,0.04) 75%);
            background-size: 800px 100%;
        }

        /* Skeleton для market tiles */
        .skeleton-tile {
            background: var(--card-glass-aurora, rgba(255,255,255,0.65));
            border: 1px solid var(--card-border-aurora, rgba(255,255,255,0.4));
            border-radius: 16px;
            padding: 14px 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(12px);
        }
        .skeleton-tile .s-label { width: 60%; height: 10px; border-radius: 4px; }
        .skeleton-tile .s-value { width: 80%; height: 18px; border-radius: 6px; }
        .skeleton-tile .s-change { width: 50%; height: 14px; border-radius: 10px; }

        /* Skeleton для rates */
        .skeleton-rate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 13px 0;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        body.dark-mode .skeleton-rate-row { border-color: rgba(255,255,255,0.04); }
        .skeleton-rate-row:last-child { border-bottom: none; }
        .skeleton-rate-row .s-label { width: 55%; height: 12px; border-radius: 4px; }
        .skeleton-rate-row .s-value { width: 22%; height: 16px; border-radius: 6px; }

        /* Skeleton для списка ОФЗ/облигаций */
        .skeleton-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--card-glass-aurora, rgba(255,255,255,0.65));
            border: 1px solid var(--card-border-aurora, rgba(255,255,255,0.4));
            border-radius: 14px;
            margin-bottom: 8px;
            backdrop-filter: blur(8px);
        }
        .skeleton-list-item .s-left { display: flex; flex-direction: column; gap: 6px; flex: 1; }
        .skeleton-list-item .s-title { width: 65%; height: 13px; border-radius: 5px; }
        .skeleton-list-item .s-sub { width: 40%; height: 10px; border-radius: 4px; }
        .skeleton-list-item .s-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
        .skeleton-list-item .s-price { width: 60px; height: 14px; border-radius: 5px; }
        .skeleton-list-item .s-yield { width: 40px; height: 12px; border-radius: 4px; }

        /* Skeleton для таблицы акций (4 колонки) */
        .skeleton-stocks-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
        }
        .skeleton-stock-cell {
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            background: var(--card-glass-aurora, rgba(255,255,255,0.65));
        }
        .skeleton-stock-cell .s-ticker { width: 70%; height: 13px; border-radius: 4px; }
        .skeleton-stock-cell .s-sector { width: 50%; height: 9px; border-radius: 3px; margin-top: 2px; }

        /* Skeleton для карточки портфеля */
        .skeleton-portfolio-card {
            background: var(--card-glass-aurora, rgba(255,255,255,0.65));
            border: 1px solid var(--card-border-aurora, rgba(255,255,255,0.4));
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 12px;
            backdrop-filter: blur(12px);
        }
        .skeleton-portfolio-card .s-header { display: flex; justify-content: space-between; margin-bottom: 16px; }
        .skeleton-portfolio-card .s-capital-label { width: 100px; height: 11px; border-radius: 4px; }
        .skeleton-portfolio-card .s-capital-value { width: 140px; height: 24px; border-radius: 6px; }
        .skeleton-portfolio-card .s-badge { width: 50px; height: 20px; border-radius: 8px; }
        .skeleton-portfolio-card .s-bar { width: 100%; height: 8px; border-radius: 4px; margin: 12px 0; }
        .skeleton-portfolio-card .s-labels { display: flex; justify-content: space-between; }
        .skeleton-portfolio-card .s-label-item { width: 70px; height: 10px; border-radius: 4px; }
        .skeleton-portfolio-card .s-divider { width: 100%; height: 1px; background: rgba(0,0,0,0.04); margin: 16px 0; }
        body.dark-mode .skeleton-portfolio-card .s-divider { background: rgba(255,255,255,0.06); }
        .skeleton-portfolio-card .s-forecast { display: flex; gap: 12px; align-items: center; }
        .skeleton-portfolio-card .s-forecast-icon { width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0; }
        .skeleton-portfolio-card .s-forecast-lines { display: flex; flex-direction: column; gap: 6px; flex: 1; }
        .skeleton-portfolio-card .s-forecast-title { width: 130px; height: 11px; border-radius: 4px; }
        .skeleton-portfolio-card .s-forecast-value { width: 100px; height: 18px; border-radius: 6px; }

        /* Skeleton для company page */
        .skeleton-company {
            padding: 20px 16px;
        }
        .skeleton-company .s-back { width: 36px; height: 36px; border-radius: 12px; margin-bottom: 24px; }
        .skeleton-company .s-name { width: 70%; height: 22px; border-radius: 6px; margin-bottom: 10px; }
        .skeleton-company .s-price-big { width: 50%; height: 30px; border-radius: 8px; margin-bottom: 8px; }
        .skeleton-company .s-change { width: 35%; height: 16px; border-radius: 10px; margin-bottom: 24px; }
        .skeleton-company .s-trend { width: 100%; height: 50px; border-radius: 10px; margin-bottom: 24px; }
        .skeleton-company .s-actions { display: flex; gap: 10px; margin-bottom: 24px; }
        .skeleton-company .s-action-btn { flex: 1; height: 44px; border-radius: 14px; }
        .skeleton-company .s-section-title { width: 40%; height: 14px; border-radius: 5px; margin-bottom: 14px; }
        .skeleton-company .s-analytics { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .skeleton-company .s-analytics-tile { height: 80px; border-radius: 16px; }

        /* Skeleton для monthly income cards */
        .skeleton-income-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--card-glass-aurora, rgba(255,255,255,0.65));
            border: 1px solid var(--card-border-aurora, rgba(255,255,255,0.4));
            border-radius: 14px;
            margin-bottom: 8px;
            backdrop-filter: blur(8px);
        }
        .skeleton-income-card .s-icon { width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0; }
        .skeleton-income-card .s-info { display: flex; flex-direction: column; gap: 6px; flex: 1; }
        .skeleton-income-card .s-name { width: 70%; height: 13px; border-radius: 5px; }
        .skeleton-income-card .s-yield { width: 40%; height: 10px; border-radius: 4px; }
        .skeleton-income-card .s-controls { width: 80px; height: 28px; border-radius: 8px; }

        /* Skeleton для news */
        .skeleton-news-item {
            padding: 14px 0;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }
        body.dark-mode .skeleton-news-item { border-color: rgba(255,255,255,0.04); }
        .skeleton-news-item:last-child { border-bottom: none; }
        .skeleton-news-item .s-news-title { width: 90%; height: 13px; border-radius: 4px; margin-bottom: 8px; }
        .skeleton-news-item .s-news-date { width: 30%; height: 10px; border-radius: 4px; }

        /* Fade-out transition для скелетонов */
        .skeleton-container {
            transition: opacity 0.3s ease;
        }
        .skeleton-container.hiding {
            opacity: 0;
        }
        /* ========== END: SKELETON LOADER SYSTEM ========== */

         /* Фон с цветным свечением для эффекта стекла */
        #screen-app {
            background: var(--bg-base);
            margin: -16px;
            padding: 16px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        /* Фон для темной темы */
        body.dark-mode #screen-app {
            background: var(--bg-base);
        }

        /* ========== NEW: Welcome Screen Styles ========== */
.welcome-screen {
    min-height: calc(100vh - 32px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: transparent;
    margin: -16px;
    padding: 60px 30px;
    text-align: center;
    animation: welcomeFadeIn 0.8s ease-out;
    box-sizing: border-box;
}

@keyframes welcomeFadeIn {
    from {
        opacity: 0;
        transform: scale(0.98);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.welcome-logo-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-bottom: 80px;
}

.welcome-supratitle {
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 600;
    color: #94A3B8;
    text-transform: uppercase;
    letter-spacing: 0.3em;
}

.welcome-title {
    font-family: 'Inter', sans-serif;
    font-size: 32px;
    color: #2C364C;
    line-height: 1.2;
    margin: 0;
}

.welcome-title-light {
    font-weight: 300;
}

.welcome-title-bold {
    font-weight: 800;
}

.welcome-divider {
    width: 50px;
    height: 1px;
    background: rgba(44, 54, 76, 0.2);
    margin: 8px 0;
}

.welcome-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: #8A9AB0;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    line-height: 1.8;
}

.welcome-cta-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    width: 100%;
    max-width: 280px;
}

.btn-welcome {
    width: 100%;
    padding: 18px 32px;
    background: #2C364C;
    color: white;
    border: none;
    border-radius: 16px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    cursor: pointer;
    box-shadow: 0 12px 35px rgba(44, 54, 76, 0.25);
    transition: all 0.2s ease;
}

.btn-welcome:active {
    transform: scale(0.97);
    box-shadow: 0 6px 20px rgba(44, 54, 76, 0.3);
}

.welcome-secure-text {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 500;
    color: #A0AEC0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.welcome-secure-text svg {
    width: 11px;
    height: 11px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.dark-mode .welcome-screen {
    background: linear-gradient(90deg, #1a2234 0%, #0f172a 100%);
}

.dark-mode .welcome-supratitle {
    color: #64748B;
}

.dark-mode .welcome-title {
    color: #F1F5F9;
}

.dark-mode .welcome-divider {
    background: rgba(255, 255, 255, 0.15);
}

.dark-mode .welcome-subtitle {
    color: #64748B;
}

.dark-mode .btn-welcome {
    background: #2C364C;
    color: #ffffff;
}

.dark-mode .welcome-secure-text {
    color: #64748B;
}
/* ========== END: Welcome Screen Styles ========== */

/* ========== REGISTRATION SCREEN ========== */
#screen-register {
    background: var(--bg-base);
    margin: -16px;
    padding: 0 0 120px 0;
    min-height: 100vh;
    position: relative;
    z-index: 1;
    overflow-x: hidden;
}
/* Force hide ALL navigation on register screen */
body.register-mode .nav-wrapper,
body.register-mode #navWrapper,
body.register-mode #portfolioModeSwitcher {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
}
#screen-register > *:not(.aurora-container):not(.noise-overlay) {
    position: relative;
}

.reg-header {
    padding: 50px 24px 20px;
    text-align: center;
}
.reg-supratitle {
    font-family: 'Inter', sans-serif;
    font-size: 9px; font-weight: 600;
    color: #94A3B8; text-transform: uppercase;
    letter-spacing: 0.3em; margin-bottom: 10px;
}
.reg-title {
    font-family: 'Inter', sans-serif;
    font-size: 26px; font-weight: 800;
    color: #2C364C; line-height: 1.2; margin: 0 0 6px;
}
.dark-mode .reg-title { color: #F1F5F9; }
.reg-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 12px; font-weight: 500;
    color: #8A9AB0; letter-spacing: 0.3px;
}
.dark-mode .reg-subtitle { color: #64748B; }

.reg-form { padding: 0 20px; }

.reg-section {
    margin-bottom: 24px;
}
.reg-section-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.1em;
    color: #94A3B8; margin-bottom: 10px;
    padding-left: 4px;
}
.dark-mode .reg-section-label { color: #64748B; }

.reg-input-group {
    display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px;
}
.reg-input {
    width: 100%; padding: 14px 16px;
    background: rgba(255,255,255,0.65);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius: 14px; font-size: 15px;
    font-family: 'Inter', sans-serif; font-weight: 500;
    color: var(--text-main); outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
    box-sizing: border-box;
}
.reg-input:focus {
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}
.reg-input::placeholder { color: #B0BEC5; font-weight: 400; }
.dark-mode .reg-input {
    background: rgba(30, 41, 59, 0.65);
    border-color: rgba(255,255,255,0.08);
    color: #F1F5F9;
}
.dark-mode .reg-input::placeholder { color: #475569; }

/* --- Broker Accordion Cards --- */
.broker-accordion { display: flex; flex-direction: column; gap: 8px; }

.broker-card {
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(10px);
    border-radius: 16px; padding: 14px 18px;
    border: 1.5px solid rgba(0,0,0,0.05);
    display: flex; align-items: center;
    justify-content: space-between;
    cursor: pointer; transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    opacity: 0;
    transform: translateY(-20px) scale(0.97);
    filter: blur(4px);
}
.broker-card.visible {
    opacity: 1; transform: translateY(0) scale(1); filter: blur(0);
}
.broker-card:nth-child(1) { transition-delay: 0.05s; }
.broker-card:nth-child(2) { transition-delay: 0.1s; }
.broker-card:nth-child(3) { transition-delay: 0.15s; }
.broker-card:nth-child(4) { transition-delay: 0.2s; }
.broker-card:nth-child(5) { transition-delay: 0.25s; }

.dark-mode .broker-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255,255,255,0.05);
}

.broker-card.selected {
    background: #fff;
    border-color: var(--accent-blue);
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.15);
}
.dark-mode .broker-card.selected {
    background: #2d3748;
    border-color: var(--accent-blue);
}

.broker-card-left {
    display: flex; align-items: center; gap: 14px;
}
.broker-logo {
    width: 42px; height: 42px; border-radius: 13px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; font-weight: 800;
    color: white; flex-shrink: 0;
    position: relative;
    overflow: hidden;
}
/* Inner glow */
.broker-logo::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 13px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.25), inset 0 -1px 0 rgba(0,0,0,0.1);
    pointer-events: none;
}
.broker-logo.t-invest { 
    background: linear-gradient(145deg, #FFDD2D, #E8C400); 
    color: #1A1A1A; 
    box-shadow: 0 4px 12px -2px rgba(255,221,45,0.35);
}
.broker-logo.alor { 
    background: linear-gradient(145deg, #E31E24, #B81318); 
    box-shadow: 0 4px 12px -2px rgba(227,30,36,0.35);
}
.broker-logo.finam { 
    background: linear-gradient(145deg, #2A5082, #0D2240); 
    box-shadow: 0 4px 12px -2px rgba(30,58,95,0.35);
}
.broker-logo.bcs { 
    background: linear-gradient(145deg, #00B85C, #007A3D); 
    box-shadow: 0 4px 12px -2px rgba(0,166,81,0.35);
}
.broker-logo.alfa { 
    background: linear-gradient(145deg, #EF1C25, #B50A12); 
    box-shadow: 0 4px 12px -2px rgba(239,28,37,0.35);
}
/* SVG inside broker logos */
.broker-logo svg {
    width: 20px; height: 20px;
    fill: none; stroke: currentColor;
    stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}

.broker-logo-placeholder {
    width: 40px; height: 40px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    background: rgba(52, 152, 219, 0.08);
    color: #94A3B8;
    transition: all 0.3s;
}
.dark-mode .broker-logo-placeholder {
    background: rgba(56, 189, 248, 0.1);
    color: #64748B;
}

.broker-info { display: flex; flex-direction: column; gap: 2px; }
.broker-name {
    font-family: 'Inter', sans-serif; font-size: 14px;
    font-weight: 700; color: var(--text-main);
}
.broker-api-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; font-weight: 500; color: #94A3B8;
    letter-spacing: 0.02em;
}
.dark-mode .broker-api-label { color: #64748B; }

.broker-check {
    width: 22px; height: 22px; border-radius: 50%;
    border: 2px solid #D1D5DB;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
}
.broker-card.selected .broker-check {
    background: var(--accent-blue); border-color: var(--accent-blue);
}
.dark-mode .broker-check { border-color: #475569; }

/* --- Broker Main Card (Strategy Accordion style) --- */
.broker-main-card {
    background: #ffffff;
    border-radius: 18px;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    border: 1.5px solid rgba(0,0,0,0.06);
    position: relative;
    z-index: 20;
    cursor: pointer;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.broker-main-card:active { transform: scale(0.98); }
.dark-mode .broker-main-card {
    background: #1e293b;
    border-color: rgba(255,255,255,0.08);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}
.broker-main-card.has-selection {
    border-color: var(--accent-blue);
}
.broker-main-arrow {
    color: #94A3B8;
    transition: transform 0.3s;
}
.broker-main-arrow.open {
    transform: rotate(180deg);
}

/* Broker waterfall cards use existing strategy-option-card styles */
#brokerWaterfall .strategy-option-card {
    padding: 14px 18px;
}
#brokerWaterfall .strategy-option-card .broker-check {
    width: 22px; height: 22px; border-radius: 50%;
    border: 2px solid #D1D5DB;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
}
.dark-mode #brokerWaterfall .strategy-option-card .broker-check { border-color: #475569; }
#brokerWaterfall .strategy-option-card.selected-in-list .broker-check {
    background: var(--accent-blue); border-color: var(--accent-blue);
}

/* --- Subscription Plan Cards — REVOLUTIONARY TIER DESIGN --- */
.plan-cards { 
    display: flex; 
    flex-direction: column; 
    gap: 10px;
}

.plan-card {
    background: rgba(255,255,255,0.55);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px; 
    padding: 0;
    border: 1.5px solid rgba(255,255,255,0.5);
    cursor: pointer; 
    transition: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
    position: relative; 
    overflow: hidden;
}
.dark-mode .plan-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255,255,255,0.06);
}
.plan-card.selected {
    border-color: transparent;
    box-shadow: 0 8px 32px -4px rgba(59, 130, 246, 0.18),
                0 2px 8px rgba(59, 130, 246, 0.08);
}
.dark-mode .plan-card.selected { 
    background: rgba(30, 41, 59, 0.85);
    box-shadow: 0 8px 32px -4px rgba(59, 130, 246, 0.25);
}

/* Gradient accent border for selected */
.plan-card.selected::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 20px;
    padding: 1.5px;
    background: linear-gradient(135deg, #3B82F6, #8B5CF6, #EC4899);
    -webkit-mask: 
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
}

/* Inner layout */
.plan-card-inner {
    padding: 18px 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
}

.plan-card-top { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    margin-bottom: 0;
}
.plan-name {
    font-family: 'Inter', sans-serif; 
    font-size: 15px;
    font-weight: 700; 
    color: var(--text-main);
    flex: 1;
}
.plan-badge {
    font-family: 'JetBrains Mono', monospace; 
    font-size: 8px;
    font-weight: 700; 
    text-transform: uppercase;
    letter-spacing: 0.1em; 
    padding: 3px 8px;
    border-radius: 6px;
}
.plan-badge.free { background: rgba(16, 185, 129, 0.12); color: #10B981; }
.plan-badge.popular { background: rgba(59, 130, 246, 0.12); color: #3B82F6; }
.plan-badge.best { background: rgba(249, 115, 22, 0.12); color: #F97316; }

/* Price row */
.plan-price-row {
    display: flex;
    align-items: baseline;
    gap: 6px;
}
.plan-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 24px; 
    font-weight: 800; 
    color: var(--text-main);
    margin-bottom: 0;
    line-height: 1;
    letter-spacing: -0.03em;
}
.plan-price span {
    font-size: 12px; 
    font-weight: 400; 
    color: #94A3B8;
    letter-spacing: 0;
}
.plan-detail {
    font-family: 'Inter', sans-serif; 
    font-size: 11px;
    color: #94A3B8; 
    font-weight: 500;
    line-height: 1.4;
}
.dark-mode .plan-detail { color: #64748B; }

/* Custom radio — animated check */
.plan-radio {
    width: 22px; 
    height: 22px; 
    border-radius: 50%;
    border: 2px solid #D1D5DB; 
    transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    flex-shrink: 0;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}
.plan-card.selected .plan-radio {
    background: linear-gradient(135deg, #3B82F6, #8B5CF6); 
    border-color: transparent;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}
.plan-card.selected .plan-radio::after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: white;
    animation: radioPopIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes radioPopIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}
.dark-mode .plan-radio { border-color: #475569; }

/* Feature pills for each plan */
.plan-features {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 2px;
}
.plan-feature-pill {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 3px 8px;
    border-radius: 6px;
    background: rgba(0,0,0,0.03);
    color: #94A3B8;
}
.dark-mode .plan-feature-pill {
    background: rgba(255,255,255,0.05);
    color: #64748B;
}

/* Savings highlight for yearly */
.plan-savings {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    color: #F97316;
    margin-top: 2px;
}
.plan-savings svg {
    width: 12px; height: 12px;
    stroke: #F97316; fill: none;
    stroke-width: 2.5;
}

/* Stagger entrance */
.plan-card {
    animation: planSlideUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) backwards;
}
.plan-card:nth-child(1) { animation-delay: 0.1s; }
.plan-card:nth-child(2) { animation-delay: 0.2s; }
.plan-card:nth-child(3) { animation-delay: 0.3s; }
@keyframes planSlideUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- Register Button --- */
.reg-submit-wrapper {
    padding: 20px 20px 40px;
}
.btn-register {
    width: 100%; padding: 18px;
    background: #2C364C; color: white;
    border: none; border-radius: 16px;
    font-family: 'Inter', sans-serif;
    font-size: 14px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.12em;
    cursor: pointer;
    box-shadow: 0 12px 35px rgba(44, 54, 76, 0.25);
    transition: all 0.2s; position: relative; overflow: hidden;
}
.btn-register:active { transform: scale(0.97); }
.btn-register:disabled {
    opacity: 0.4; pointer-events: none;
}
.dark-mode .btn-register { background: #2C364C; }

.reg-back-btn {
    position: absolute; top: 50px; left: 20px;
    width: 38px; height: 38px; border-radius: 12px;
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.4);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-main); z-index: 5;
}
.dark-mode .reg-back-btn {
    background: rgba(30, 41, 59, 0.65);
    border-color: rgba(255,255,255,0.08);
    color: #F1F5F9;
}

/* ========== DASHBOARD SCREEN — REVOLUTIONARY BENTO ========== */
#screen-dashboard {
    background: var(--bg-base);
    margin: -16px;
    padding: 0 0 120px 0;
    min-height: 100vh;
    position: relative;
    z-index: 1;
    overflow-x: hidden;
}
#screen-dashboard > *:not(.aurora-container):not(.noise-overlay) {
    position: relative;
}

/* ===== HERO: Compact Identity Bar ===== */
.dash-hero {
    padding: 10px 20px 8px;
    padding-top: calc(100px + env(safe-area-inset-top));
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 12px;
}
@supports not (padding-top: env(safe-area-inset-top)) {
    .dash-hero { padding-top: 70px; }
}
.dash-hero-left {
    flex: 1;
    min-width: 0;
}
.dash-greeting {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; font-weight: 500;
    color: #94A3B8; text-transform: uppercase;
    letter-spacing: 0.2em; margin-bottom: 4px;
}
.dark-mode .dash-greeting { color: #64748B; }
.dash-user-name {
    font-family: 'Inter', sans-serif;
    font-size: 26px; line-height: 1.15; margin: 0;
    color: #0F172A;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.dash-user-name .light { font-weight: 300; }
.dash-user-name .bold { font-weight: 800; }
.dark-mode .dash-user-name { color: #F1F5F9; }
.dash-divider { display: none; }

.dash-status-pill {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 5px 12px; border-radius: 20px;
    background: rgba(46, 204, 113, 0.1);
    flex-shrink: 0;
    margin-bottom: 4px;
}
.dash-status-dot {
    width: 5px; height: 5px; border-radius: 50%;
    background: #10B981;
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
    animation: pulse 2s infinite;
}
.dash-status-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; font-weight: 600;
    color: #10B981; text-transform: uppercase;
    letter-spacing: 0.05em;
}
.dash-status-pill.expired { background: rgba(239, 68, 68, 0.1); }
.dash-status-pill.expired .dash-status-dot { background: #EF4444; box-shadow: 0 0 6px rgba(239,68,68,0.6); }
.dash-status-pill.expired .dash-status-text { color: #EF4444; }

/* ===== BENTO GRID SYSTEM ===== */
.dash-content { padding: 0 14px; }

.bento-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 16px;
}

/* ===== BENTO CELL BASE ===== */
.bento-cell {
    background: rgba(255,255,255,0.55);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 20px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
    box-shadow: 0 2px 12px -2px rgba(0,0,0,0.04), 
                0 1px 3px rgba(0,0,0,0.02);
}
.bento-cell:active {
    transform: scale(0.97);
    box-shadow: 0 1px 6px rgba(0,0,0,0.06);
}
.dark-mode .bento-cell {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255,255,255,0.08);
    box-shadow: 0 2px 16px -2px rgba(0,0,0,0.2);
}

/* Spanning cells */
.bento-cell.span-2 { grid-column: span 2; }

/* ===== MARKET PULSE WIDGET (full-width ticker) ===== */
.bento-market-pulse {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 0;
}
.bento-market-pulse .market-items {
    display: flex;
    width: 100%;
    justify-content: space-between;
    align-items: center;
}
.bento-market-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    flex: 1;
    position: relative;
}
.bento-market-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0; top: 4px; bottom: 4px;
    width: 1px;
    background: rgba(0,0,0,0.06);
}
.dark-mode .bento-market-item:not(:last-child)::after {
    background: rgba(255,255,255,0.06);
}
.bento-market-ticker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px; font-weight: 600;
    color: #94A3B8;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}
.bento-market-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px; font-weight: 700;
    color: var(--text-main);
    letter-spacing: -0.02em;
}
.bento-market-delta {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; font-weight: 600;
    padding: 1px 5px; border-radius: 4px;
}
.bento-market-delta.up {
    color: #10B981;
    background: rgba(16, 185, 129, 0.1);
}
.bento-market-delta.down {
    color: #EF4444;
    background: rgba(239, 68, 68, 0.1);
}

/* ===== ACTION CELLS ===== */
.bento-action {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 110px;
    position: relative;
}
.bento-action-icon {
    width: 38px; height: 38px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 8px;
}
.bento-action-icon svg {
    width: 18px; height: 18px; stroke: white;
    fill: none; stroke-width: 2;
    stroke-linecap: round; stroke-linejoin: round;
}
.bento-action-icon.blue { background: linear-gradient(135deg, #3B82F6, #2563EB); }
.bento-action-icon.green { background: linear-gradient(135deg, #10B981, #059669); }
.bento-action-icon.orange { background: linear-gradient(135deg, #F97316, #EA580C); }
.bento-action-icon.purple { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }

.bento-action-label {
    font-family: 'Inter', sans-serif;
    font-size: 14px; font-weight: 700;
    color: var(--text-main);
    margin-bottom: 2px;
}
.bento-action-sub {
    font-family: 'Inter', sans-serif;
    font-size: 10px; font-weight: 500;
    color: #94A3B8;
    line-height: 1.3;
}
.dark-mode .bento-action-sub { color: #64748B; }

/* Corner glow for action cells */
.bento-action::before {
    content: '';
    position: absolute;
    top: -20px; right: -20px;
    width: 80px; height: 80px;
    border-radius: 50%;
    opacity: 0.07;
    pointer-events: none;
    transition: opacity 0.3s;
}
.bento-action:active::before { opacity: 0.12; }
.bento-action.glow-blue::before { background: #3B82F6; }
.bento-action.glow-green::before { background: #10B981; }
.bento-action.glow-orange::before { background: #F97316; }
.bento-action.glow-purple::before { background: #8B5CF6; }

/* ===== PORTFOLIO RING WIDGET ===== */
.bento-portfolio-ring {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 130px;
    padding: 16px 12px;
}
.bento-ring-wrap {
    position: relative;
    width: 80px; height: 80px;
    margin-bottom: 10px;
}
.bento-ring-wrap canvas {
    width: 80px; height: 80px;
}
.bento-ring-center {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}
.bento-ring-pct {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px; font-weight: 700;
    color: var(--text-main);
    line-height: 1;
}
.bento-ring-label {
    font-family: 'Inter', sans-serif;
    font-size: 7px; font-weight: 600;
    color: #94A3B8;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
.bento-ring-legend {
    display: flex; gap: 10px; justify-content: center;
}
.bento-legend-item {
    display: flex; align-items: center; gap: 4px;
}
.bento-legend-dot {
    width: 6px; height: 6px; border-radius: 2px;
}
.bento-legend-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; font-weight: 500;
    color: #94A3B8;
}

/* ===== SUBSCRIPTION MINI CARD ===== */
.bento-sub-mini {
    background: linear-gradient(135deg, #1E293B, #0F172A);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 16px;
    min-height: 110px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.dark-mode .bento-sub-mini {
    background: linear-gradient(135deg, #1a2744, #0d1529);
    border-color: rgba(255,255,255,0.08);
}
.bento-sub-top {
    display: flex; justify-content: space-between; align-items: flex-start;
}
.bento-sub-plan {
    font-family: 'Inter', sans-serif;
    font-size: 14px; font-weight: 800;
    color: #F1F5F9;
    text-transform: uppercase;
}
.bento-sub-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px; font-weight: 600;
    padding: 3px 7px; border-radius: 6px;
    background: rgba(16, 185, 129, 0.2);
    color: #4ADE80;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.bento-sub-badge.expired {
    background: rgba(239, 68, 68, 0.2); color: #F87171;
}
.bento-sub-bottom {
    display: flex; justify-content: space-between; align-items: flex-end;
}
.bento-sub-date-col {
    display: flex; flex-direction: column; gap: 1px;
}
.bento-sub-date-lbl {
    font-family: 'JetBrains Mono', monospace;
    font-size: 7px; font-weight: 500;
    color: rgba(148, 163, 184, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.08em;
}
.bento-sub-date-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; font-weight: 600;
    color: #CBD5E1;
}
.bento-sub-arrow {
    width: 24px; height: 24px;
    border-radius: 8px;
    background: rgba(255,255,255,0.06);
    display: flex; align-items: center; justify-content: center;
}
.bento-sub-arrow svg {
    width: 12px; height: 12px; stroke: #64748B;
    fill: none; stroke-width: 2.5;
    stroke-linecap: round; stroke-linejoin: round;
}

/* ===== SECTION LABELS ===== */
.dash-section {
    margin-bottom: 0;
    margin-top: 20px;
}
.dash-section-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px; padding: 0 6px;
}
.dash-section-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.15em;
    color: #94A3B8;
}
.dark-mode .dash-section-title { color: #64748B; }

/* ===== REVOLUTIONARY SETTINGS — GROUPED CARD ===== */
.dash-settings-group {
    background: rgba(255,255,255,0.55);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 22px;
    overflow: hidden;
    box-shadow: 0 2px 12px -2px rgba(0,0,0,0.04),
                0 1px 3px rgba(0,0,0,0.02);
}
.dark-mode .dash-settings-group {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255,255,255,0.08);
    box-shadow: 0 2px 16px -2px rgba(0,0,0,0.2);
}

/* Settings Row */
.dash-settings-row {
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    transition: background 0.15s;
    position: relative;
}
.dash-settings-row:active {
    background: rgba(0,0,0,0.02);
}
.dark-mode .dash-settings-row:active {
    background: rgba(255,255,255,0.03);
}

/* Separator between rows */
.dash-settings-row + .dash-settings-row::before {
    content: '';
    position: absolute;
    top: 0; left: 62px; right: 18px;
    height: 1px;
    background: rgba(0,0,0,0.05);
}
.dark-mode .dash-settings-row + .dash-settings-row::before {
    background: rgba(255,255,255,0.05);
}

/* Icon circle */
.ds-icon {
    width: 36px; height: 36px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.ds-icon svg {
    width: 17px; height: 17px;
    fill: none; stroke-width: 2;
    stroke-linecap: round; stroke-linejoin: round;
}
.ds-icon.blue {
    background: linear-gradient(135deg, #3B82F6, #2563EB);
}
.ds-icon.blue svg { stroke: white; }
.ds-icon.orange {
    background: linear-gradient(135deg, #F97316, #EA580C);
}
.ds-icon.orange svg { stroke: white; }
.ds-icon.slate {
    background: linear-gradient(135deg, #64748B, #475569);
}
.ds-icon.slate svg { stroke: white; }
.ds-icon.red {
    background: linear-gradient(135deg, #EF4444, #DC2626);
}
.ds-icon.red svg { stroke: white; }

/* Row content */
.ds-row-content {
    flex: 1;
    min-width: 0;
}
.ds-row-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px; font-weight: 600;
    color: var(--text-main);
    line-height: 1.2;
}
.ds-row-subtitle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; font-weight: 500;
    color: #94A3B8;
    margin-top: 1px;
    letter-spacing: 0.01em;
}
.dark-mode .ds-row-subtitle { color: #64748B; }

/* Right side value/badge/arrow */
.ds-row-right {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}
.ds-row-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; font-weight: 600;
    color: #94A3B8;
}
.dark-mode .ds-row-value { color: #64748B; }
.ds-row-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px; font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 3px 8px;
    border-radius: 6px;
    background: rgba(16, 185, 129, 0.12);
    color: #10B981;
}
.ds-row-badge.expired {
    background: rgba(239, 68, 68, 0.12);
    color: #EF4444;
}
.ds-chevron {
    width: 16px; height: 16px;
    color: #C8CCD0;
    transition: transform 0.3s;
}
.dark-mode .ds-chevron { color: #475569; }
.ds-chevron svg {
    width: 16px; height: 16px;
    stroke: currentColor; fill: none;
    stroke-width: 2.5;
    stroke-linecap: round; stroke-linejoin: round;
}

/* ===== EXPANDABLE PANEL (replaces accordion body) ===== */
.ds-expand-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.45s cubic-bezier(0.4, 0, 0.2, 1),
                padding 0.3s ease;
    padding: 0 18px;
    background: rgba(0,0,0,0.01);
}
.dark-mode .ds-expand-panel {
    background: rgba(0,0,0,0.08);
}
.ds-expand-panel.open {
    max-height: 700px;
    padding: 0 18px 18px;
}

/* Rotate chevron when open */
.dash-settings-row.ds-open .ds-chevron {
    transform: rotate(90deg);
}

/* ===== SUBSCRIPTION CARD INSIDE PANEL ===== */
.dash-sub-card {
    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
    border-radius: 16px; padding: 16px;
    color: white; margin-bottom: 12px;
    margin-top: 12px;
    position: relative;
    overflow: hidden;
}
/* Subtle pattern dots on sub card */
.dash-sub-card::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 120px; height: 120px;
    background: radial-gradient(circle, rgba(59,130,246,0.12) 1px, transparent 1px);
    background-size: 10px 10px;
    opacity: 0.6;
    pointer-events: none;
}
.dash-sub-card-row {
    display: flex; justify-content: space-between; align-items: center;
}
.dash-sub-plan {
    font-family: 'Inter', sans-serif; font-size: 16px;
    font-weight: 800; text-transform: uppercase;
}
.dash-sub-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; font-weight: 600;
    padding: 4px 10px; border-radius: 8px;
    background: rgba(16, 185, 129, 0.2); color: #4ade80;
}
.dash-sub-badge.expired {
    background: rgba(239, 68, 68, 0.2); color: #f87171;
}
.dash-sub-dates {
    display: flex; justify-content: space-between;
    margin-top: 14px; padding-top: 14px;
    border-top: 1px solid rgba(255,255,255,0.08);
}
.dash-sub-date-block { display: flex; flex-direction: column; gap: 2px; }
.dash-sub-date-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.08em;
    color: rgba(255,255,255,0.4);
}
.dash-sub-date-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px; font-weight: 600;
}

/* ===== PLAN CHANGE OPTIONS IN PANEL ===== */
.dash-plan-options { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
.dash-plan-option {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 14px; border-radius: 14px;
    background: rgba(0,0,0,0.02); border: 1.5px solid transparent;
    cursor: pointer; transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
}
.dark-mode .dash-plan-option { background: rgba(255,255,255,0.03); }
.dash-plan-option:active { transform: scale(0.98); }
.dash-plan-option.current {
    border-color: #3B82F6;
    background: rgba(59, 130, 246, 0.06);
    box-shadow: 0 2px 8px -2px rgba(59, 130, 246, 0.15);
}
.dash-plan-option-name {
    font-family: 'Inter', sans-serif;
    font-size: 13px; font-weight: 600; color: var(--text-main);
}
.dash-plan-option-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px; font-weight: 600; color: var(--text-main);
}

/* ===== TOKEN INPUT ===== */
.dash-token-input-wrap {
    display: flex; gap: 8px; margin-top: 12px;
}
.dash-token-input {
    flex: 1; padding: 12px 14px;
    background: rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 14px; font-size: 13px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-main); outline: none;
    -webkit-appearance: none;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.dark-mode .dash-token-input {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.08);
    color: #F1F5F9;
}
.dash-token-input:focus {
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08);
}
.dash-token-save-btn {
    padding: 12px 18px; border-radius: 14px;
    background: linear-gradient(135deg, #3B82F6, #2563EB);
    color: white;
    border: none; font-size: 12px; font-weight: 700;
    font-family: 'Inter', sans-serif; cursor: pointer;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    transition: transform 0.2s, box-shadow 0.2s;
}
.dash-token-save-btn:active { 
    transform: scale(0.96); 
    box-shadow: 0 1px 4px rgba(59, 130, 246, 0.2);
}

/* Instruction card */
.dash-instruction {
    background: rgba(59, 130, 246, 0.04);
    border: 1px solid rgba(59, 130, 246, 0.08);
    border-radius: 14px; padding: 14px;
    margin-top: 12px;
}
.dark-mode .dash-instruction {
    background: rgba(59, 130, 246, 0.06);
    border-color: rgba(59, 130, 246, 0.1);
}
.dash-instruction-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px; font-weight: 700;
    color: #3B82F6; margin-bottom: 8px;
    text-transform: uppercase; letter-spacing: 0.1em;
}
.dash-instruction-step {
    font-family: 'Inter', sans-serif;
    font-size: 12px; color: var(--text-main);
    line-height: 1.7; opacity: 0.75;
}
.dash-instruction-step strong {
    font-weight: 700; color: var(--text-main); opacity: 1;
}

.dash-plan-expires {
    margin-top: 8px; padding: 10px 14px;
    background: rgba(0,0,0,0.02); border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 11px; color: #94A3B8;
    text-align: center;
}
.dark-mode .dash-plan-expires { background: rgba(255,255,255,0.03); color: #64748B; }

/* ===== THEME TOGGLE SWITCH ===== */
.ds-theme-toggle {
    width: 44px; height: 26px;
    background: #D1D5DB;
    border-radius: 13px;
    position: relative;
    transition: background 0.3s;
    flex-shrink: 0;
    cursor: pointer;
}
.dark-mode .ds-theme-toggle {
    background: #3B82F6;
}
.ds-theme-toggle-knob {
    width: 22px; height: 22px;
    background: white;
    border-radius: 11px;
    position: absolute;
    top: 2px; left: 2px;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.dark-mode .ds-theme-toggle-knob {
    transform: translateX(18px);
}

/* === Legacy compat: hide old settings-item if present === */
.dash-settings-item { display: none; }

/* ===== STAGGER ENTRANCE ANIMATIONS ===== */
@keyframes bentoFadeUp {
    from { opacity: 0; transform: translateY(18px) scale(0.97); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.bento-cell, .dash-settings-item {
    animation: bentoFadeUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) backwards;
}
.bento-cell:nth-child(1) { animation-delay: 0.05s; }
.bento-cell:nth-child(2) { animation-delay: 0.1s; }
.bento-cell:nth-child(3) { animation-delay: 0.15s; }
.bento-cell:nth-child(4) { animation-delay: 0.2s; }
.bento-cell:nth-child(5) { animation-delay: 0.25s; }
.bento-cell:nth-child(6) { animation-delay: 0.3s; }
.dash-section { animation: bentoFadeUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) 0.35s backwards; }

/* ===== QUICK DATE PILL ===== */
.dash-date-pill {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 500;
    color: #94A3B8;
    letter-spacing: 0.06em;
    margin-top: 2px;
}
.dark-mode .dash-date-pill { color: #64748B; }

/* ===== HERO CTA — Main Action Button ===== */
.dash-hero-cta {
    margin-top: 16px;
    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
    border-radius: 20px;
    padding: 18px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 8px 28px -4px rgba(15, 23, 42, 0.25),
                0 2px 6px rgba(15, 23, 42, 0.08);
    position: relative;
    overflow: hidden;
    animation: bentoFadeUp 0.45s cubic-bezier(0.22, 1, 0.36, 1) 0.05s backwards;
}
.dash-hero-cta:active {
    transform: scale(0.98);
    box-shadow: 0 4px 16px -4px rgba(15, 23, 42, 0.25);
}
/* Subtle shimmer */
.dash-hero-cta::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.04) 50%, transparent 100%);
    animation: ctaShimmer 4s ease-in-out infinite;
}
@keyframes ctaShimmer {
    0%, 100% { left: -100%; }
    50% { left: 100%; }
}
/* Dot pattern accent */
.dash-hero-cta::after {
    content: '';
    position: absolute;
    top: -10px; right: -10px;
    width: 100px; height: 100px;
    background: radial-gradient(circle, rgba(59,130,246,0.15) 1px, transparent 1px);
    background-size: 8px 8px;
    pointer-events: none;
    opacity: 0.8;
}
.dark-mode .dash-hero-cta {
    background: linear-gradient(135deg, #1a2744 0%, #0d1529 100%);
    box-shadow: 0 8px 28px -4px rgba(0, 0, 0, 0.4);
}
.dash-hero-cta-left {
    display: flex;
    align-items: center;
    gap: 14px;
    position: relative; z-index: 1;
}
.dash-hero-cta-icon {
    width: 44px; height: 44px;
    border-radius: 13px;
    background: linear-gradient(135deg, #3B82F6, #2563EB);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 4px 12px -2px rgba(59, 130, 246, 0.4);
}
.dash-hero-cta-icon svg {
    width: 20px; height: 20px;
    stroke: white; fill: none;
    stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}
.dash-hero-cta-title {
    font-family: 'Inter', sans-serif;
    font-size: 15px; font-weight: 700;
    color: #F1F5F9;
    letter-spacing: -0.01em;
}
.dash-hero-cta-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; font-weight: 500;
    color: #64748B;
    margin-top: 2px;
}
.dash-hero-cta-arrow {
    width: 28px; height: 28px;
    border-radius: 8px;
    background: rgba(255,255,255,0.06);
    display: flex; align-items: center; justify-content: center;
    position: relative; z-index: 1;
}
.dash-hero-cta-arrow svg {
    width: 14px; height: 14px;
    stroke: #64748B; fill: none;
    stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round;
}

/* Loading spinner for registration */
.reg-loading {
    display: none; align-items: center;
    justify-content: center; gap: 8px;
    padding: 16px;
}
.reg-loading.active { display: flex; }
.reg-spinner {
    width: 20px; height: 20px;
    border: 2px solid rgba(52, 152, 219, 0.2);
    border-top-color: var(--accent-blue);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.reg-loading-text {
    font-family: 'Inter', sans-serif;
    font-size: 12px; color: #94A3B8; font-weight: 500;
}

/* Toast for dashboard */
.dash-toast {
    position: fixed; top: 20px; left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: rgba(16, 185, 129, 0.92);
    backdrop-filter: blur(12px);
    color: white; font-family: 'Inter', sans-serif;
    font-size: 13px; font-weight: 600;
    padding: 10px 24px; border-radius: 14px;
    opacity: 0; pointer-events: none;
    transition: all 0.3s ease; z-index: 1000;
}
.dash-toast.show {
    opacity: 1; transform: translateX(-50%) translateY(0);
}
.dash-toast.error {
    background: rgba(239, 68, 68, 0.92);
}

/* Subscription status card in dashboard (inside accordion) */
.dash-sub-card {
    background: linear-gradient(135deg, #2C364C, #1a2234);
    border-radius: 18px; padding: 18px;
    color: white; margin-bottom: 14px;
}
.dash-sub-card-row {
    display: flex; justify-content: space-between; align-items: center;
}
.dash-sub-plan {
    font-family: 'Inter', sans-serif; font-size: 16px;
    font-weight: 800; text-transform: uppercase;
}
.dash-sub-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px; font-weight: 600;
    padding: 4px 10px; border-radius: 8px;
    background: rgba(46, 204, 113, 0.2); color: #4ade80;
}
.dash-sub-badge.expired {
    background: rgba(239, 68, 68, 0.2); color: #f87171;
}
.dash-sub-dates {
    display: flex; justify-content: space-between;
    margin-top: 14px; padding-top: 14px;
    border-top: 1px solid rgba(255,255,255,0.1);
}
.dash-sub-date-block { display: flex; flex-direction: column; gap: 2px; }
.dash-sub-date-label {
    font-family: 'Inter', sans-serif;
    font-size: 9px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.05em;
    color: rgba(255,255,255,0.5);
}
.dash-sub-date-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px; font-weight: 600;
}

/* Blocked / deleted user screen */
.user-blocked-screen {
    min-height: 100vh; display: flex;
    flex-direction: column; justify-content: center;
    align-items: center; text-align: center;
    padding: 40px;
}
.user-blocked-icon {
    width: 60px; height: 60px; border-radius: 20px;
    background: rgba(231, 76, 60, 0.1);
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 20px;
}
.user-blocked-icon svg {
    width: 28px; height: 28px; stroke: #e74c3c;
    fill: none; stroke-width: 2;
}
.user-blocked-title {
    font-family: 'Inter', sans-serif;
    font-size: 20px; font-weight: 800;
    color: var(--text-main); margin-bottom: 8px;
}
.user-blocked-text {
    font-family: 'Inter', sans-serif;
    font-size: 13px; color: #94A3B8;
    line-height: 1.6; margin-bottom: 20px;
}
/* ========== END: Registration & Dashboard Styles ========== */

.terminal-header { padding: 10px 10px 30px; text-align: left; }

        /* ========== NEW: Terminal Header V2 для 2й вкладки ========== */
.terminal-header-v2 {
            background: transparent; /* Прозрачный фон */
            padding: 40px 10px 10px 10px; /* Отступ сверху побольше */
            margin: 0; /* Убираем старые margin -16px */
            text-align: left;
        }

.terminal-title-main {
    font-family: 'Inter', sans-serif;
    font-weight: 800;
    font-size: 32px;
    color: #2C364C;
    letter-spacing: -0.5px;
    margin-bottom: 6px;
    line-height: 1.1;
}

.terminal-subtitle {
    font-family: 'Inter', sans-serif;
    font-weight: 500;
    font-size: 12px;
    color: #8A9AB0;
    letter-spacing: 0.5px;
    text-transform: none;
}

.dark-mode .terminal-header-v2 {
    background: linear-gradient(90deg, #1a2234 0%, #1e293b 100%);
}

.dark-mode .terminal-title-main {
    color: #f1f5f9;
}

.dark-mode .terminal-subtitle {
    color: #64748b;
}
/* ========== END: Terminal Header V2 ========== */

        
        .terminal-badge {
            display: inline-flex;
            align-items: center; gap: 6px; padding: 4px 10px;
            background: var(--accent-blue); color: white; font-size: 10px; font-weight: 900;
            border-radius: 4px; text-transform: uppercase;
            margin-bottom: 12px; letter-spacing: 1px;
        }

        .market-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #ccc; }
        .dot-online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; animation: pulse 2s infinite; }
        .dot-offline { background: #e74c3c; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .home-title { font-size: 26px; font-weight: 800; margin-bottom: 15px; line-height: 1.2; }
        .home-desc { font-size: 15px; color: #8e8e93; line-height: 1.6; margin-bottom: 25px; }
        
        .market-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .market-item-modern {
            background: var(--card-bg);
            border-radius: 16px; padding: 12px 16px;
            position: relative; overflow: hidden; box-shadow: 0 6px 15px var(--card-shadow);
            border: 1px solid var(--border-color); display: flex;
            flex-direction: row; align-items: center; justify-content: space-between;
        }
        .market-item-modern::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 4px; height: 100%;
        }
        .market-item-modern.blue::before { background: var(--accent-blue); }
        .market-item-modern.green::before { background: var(--accent-green); }
        .market-item-modern.orange::before { background: #f39c12; }
        
        .mk-left { display: flex; flex-direction: column; gap: 4px; }
        .mk-label {
            font-size: 14px; font-weight: 700; color: var(--text-main); letter-spacing: 0px;
            text-transform: none; margin-bottom: 0;
        }
        .mk-val {
            font-size: 16px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px;
        }
        .mk-dynamics {
            font-size: 12px; font-weight: 700; padding: 4px 8px; border-radius: 8px;
        }
        .mk-dynamics.positive { background: var(--badge-green-bg); color: var(--accent-green); }
        .mk-dynamics.negative { background: rgba(231, 76, 60, 0.1); color: var(--accent-red); }
        .mk-dynamics.neutral { background: rgba(0,0,0,0.05); color: var(--text-secondary); }
        .dark-mode .mk-dynamics.neutral { background: rgba(255,255,255,0.1); }
        
        .rates-vertical-block {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px var(--card-shadow);
            border: 1px solid var(--border-color);
        }
        .rv-title {
            font-size: 11px; color: #8e8e93; font-weight: 700; text-transform: uppercase;
            margin-bottom: 12px; letter-spacing: 0.5px;
        }
        .rv-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .rv-item {
            display: flex; flex-direction: column; gap: 4px;
            background: rgba(0,0,0,0.02); padding: 10px; border-radius: 12px;
        }
        .dark-mode .rv-item { background: rgba(255,255,255,0.03); }
        .rv-item span { font-size: 10px; color: #8e8e93; font-weight: 600; }
        .rv-item b { font-size: 15px; color: var(--text-main); font-weight: 800; }

        .info-card {
            background: var(--card-bg);
            padding: 20px; border-radius: 20px; margin-bottom: 15px;
            border: 1px solid var(--border-color); box-shadow: 0 5px 15px var(--card-shadow); 
            position: relative; overflow: hidden; transition: transform 0.2s;
        }
        .info-card:active { transform: scale(0.99); }
        .info-card.bonds { border-left: 4px solid var(--accent-blue); background: linear-gradient(to right, rgba(52, 152, 219, 0.03), var(--card-bg)); }
        .info-card.stocks { border-left: 4px solid var(--accent-green); background: linear-gradient(to right, rgba(46, 204, 113, 0.03), var(--card-bg)); }

        .info-card-header { font-size: 18px; font-weight: 800; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .bonds .info-card-header { color: var(--accent-blue); }
        .stocks .info-card-header { color: var(--accent-green); }

        .info-card-sub-clean { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 10px 0; opacity: 0.7; }
        .bonds .info-card-sub-clean { color: var(--accent-blue); }
        .stocks .info-card-sub-clean { color: var(--accent-green); }
        
        .info-card-text { font-size: 13px; line-height: 1.6; color: var(--text-main); margin-bottom: 15px; opacity: 0.8; }
        
        .info-card-badge {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 900; letter-spacing: 0.5px;
        }
        .badge-blue { background: var(--badge-blue-bg); color: var(--accent-blue); }
        .badge-green { background: var(--badge-green-bg); color: var(--accent-green); }

        .btn-action {
            display: flex; align-items: center; justify-content: center; width: 100%; padding: 16px; margin-top: 12px;
            background: var(--coupon-blue-bg); color: var(--accent-blue);
            border: 1px solid var(--accent-blue); border-radius: 16px;
            font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; gap: 8px;
        }
        .btn-action:active { opacity: 0.7; transform: scale(0.98); }

        @keyframes shimmerBtn {
    0% { box-shadow: 0 10px 25px rgba(44, 54, 76, 0.2); transform: scale(1); }
    50% { box-shadow: 0 12px 30px rgba(44, 54, 76, 0.28); transform: scale(1.003); }
    100% { box-shadow: 0 10px 25px rgba(44, 54, 76, 0.2); transform: scale(1); }
}

.btn-graphite {
    position: relative;
    background: #2C364C; 
    color: white; 
    border: none; 
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(44, 54, 76, 0.2);
    margin-top: 15px;
    padding: 20px; 
    font-family: 'Inter', sans-serif;
    font-size: 17px; 
    border-radius: 16px;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 12px;
    width: 100%; 
    box-sizing: border-box; 
    font-weight: 700;
    animation: shimmerBtn 4.5s infinite ease-in-out;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-graphite svg { 
    width: 28px; 
    height: 28px; 
    fill: none; 
    stroke: white; 
    stroke-width: 2; 
}

.btn-graphite:active { 
    transform: scale(0.98); 
    opacity: 0.9;
    animation: none; 
}

/* Обновленная панель кнопки: теперь она идет просто после списка, без фиксации */
.bottom-sticky-panel {
    position: relative; /* Убираем fixed */
    background: transparent; /* Убираем белый фон */
    backdrop-filter: none; /* Убираем размытие */
    -webkit-backdrop-filter: none;
    padding: 20px 0; /* Оставляем только небольшие отступы сверху и снизу */
    z-index: 800;
    border-top: none; /* Убираем рамку сверху */
    margin-top: 10px;
}
        /* ========== NEW: Скрытие элементов при фокусе на вводе ========== */
body.input-focused .nav-wrapper {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

body.input-focused .bottom-sticky-panel {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.nav-wrapper,
.bottom-sticky-panel {
    transition: opacity 0.2s ease;
}
/* ========== END: Скрытие элементов при фокусе ========== */

.dark-mode .bottom-sticky-panel {
    background: rgba(15, 23, 42, 0.92);
    border-top-color: rgba(255, 255, 255, 0.1);
}

.bottom-sticky-panel .btn-graphite {
    margin-top: 0;
}

.sticky-hint {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: #8A9AB0;
    text-align: center;
    margin-top: 10px;
    line-height: 1.5;
    padding: 0 10px;
}

        .start-expl { font-size: 11px; color: #8e8e93; text-align: center; margin-top: 8px; padding: 0 10px; line-height: 1.5; }

        .header { text-align: center; margin-bottom: 20px; }
h1 { 
    font-family: 'Inter', sans-serif;
    font-size: 20px; 
    font-weight: 800;
    margin-bottom: 4px; 
}

#dynamicSubtitle {
    font-family: 'Inter', sans-serif;
    font-weight: 400;
}
        
       .calc-box {
    background: transparent; 
    padding: 0; 
    border-radius: 0;
    box-shadow: none; 
    margin-bottom: 25px; 
    border: none;
}

.calc-top { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    margin-bottom: 10px; 
}

.input-container { flex: 1; }

.input-label { 
    font-family: 'Inter', sans-serif;
    font-size: 11px; 
    color: #8A9AB0; 
    font-weight: 700; 
    margin-bottom: 12px; 
    display: block; 
    text-transform: uppercase; 
    letter-spacing: 1.5px; 
}

.input-wrapper { 
    display: flex; 
    align-items: center; 
    justify-content: center;
    gap: 0; /* ИЗМЕНЕНО: убираем gap */
    padding: 10px 0 20px 0;
    position: relative;
}

.input-wrapper::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0 auto;
    width: fit-content;
    min-width: 200px;
    max-width: 90%;
    height: 1px;
    background: rgba(44, 54, 76, 0.2);
    transition: all 0.3s ease;
}

.input-wrapper:focus-within::after {
    width: 80%;
    background: rgba(44, 54, 76, 0.4);
}

input#sumInput { 
    border: none; 
    font-family: 'JetBrains Mono', monospace;
    font-size: 42px; 
    font-weight: 500; 
    width: 200px; /* Начальная ширина */
    max-width: 85%;
    outline: none; 
    color: #2C364C;
    background: transparent; 
    margin: 0; 
    padding: 0;
    line-height: 1.2;
    text-align: center;
    transition: width 0.2s ease, font-size 0.15s ease; /* ДОБАВЛЕНО: анимация ширины */
    letter-spacing: -0.02em;
}
/* Убираем стрелочки для числового поля */
input#sumInput::-webkit-outer-spin-button,
input#sumInput::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input#sumInput[type=number] {
    -moz-appearance: textfield;
}

input#sumInput.size-large {
    font-size: 42px;
}

input#sumInput.size-medium {
    font-size: 32px;
}

input#sumInput.size-small {
    font-size: 24px;
}

input#sumInput.size-xsmall {
    font-size: 20px;
}

.currency { 
    font-family: 'JetBrains Mono', monospace;
    font-size: 42px; 
    color: #94A3B8; 
    font-weight: 400;
    opacity: 0.6;
    margin-left: 4px; /* Небольшой отступ */
    flex-shrink: 0;
}

.dark-mode input#sumInput {
    color: #f1f5f9;
}

.dark-mode .currency {
    color: #475569;
}

.dark-mode .input-wrapper {
    border-bottom-color: #334155;
}

        .usage-bar-container { margin-bottom: 20px; }
        .usage-label { font-size: 10px; color: #8e8e93; display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: bold; }
        .usage-track { height: 4px; background: #eee; border-radius: 2px; overflow: hidden; }
        #usageFill { height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s; }


        /* ========== NEW: Dropdown для тарифа комиссии ========== */
        /* Белая карточка начинается с тарифа */
         .calc-box-white-section {
            /* Делаем фон более прозрачным (0.4 вместо 0.65) */
            background: rgba(255, 255, 255, 0.4);
            
            /* Сильное размытие фона под карточкой */
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            
            padding: 20px 24px 24px 24px;
            border-radius: 24px;
            
            /* Тонкая белая рамка усиливает эффект стекла */
            border: 1px solid rgba(255, 255, 255, 0.5);
            
            /* Мягкая тень */
            box-shadow: 0 20px 40px rgba(0,0,0,0.03);
            
            margin-top: 25px;
        }

        /* Настройка для темной темы */
        body.dark-mode .calc-box-white-section {
            background: rgba(30, 41, 59, 0.5); /* Тоже прозрачнее */
            border-color: rgba(255, 255, 255, 0.1);
        }
.fee-selector {
    margin-bottom: 20px;
}
      




        
        

      
        
     
/* ========== END: Карточки инвестиционных стратегий V2 ========== */
        
     
        
        
        

        #shareContainer { background: var(--bg-color); padding: 5px 10px 20px; border-radius: 10px; }
        .asset-list { background: var(--card-bg); border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
        .asset-item {
            display: grid; grid-template-columns: 85px 1fr 75px 80px; padding: 12px; 
            border-bottom: 1px solid var(--item-border); font-size: 12px; align-items: center;
        }
        .asset-item:last-child { border-bottom: none; }
        .ticker { font-weight: bold; color: var(--text-main); }
        .asset-name { color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .qty { text-align: right; padding-right: 8px; font-weight: bold; color: var(--accent-blue); }
        .price-total { text-align: right; color: var(--text-main); font-weight: 500; }
        
        .asset-yield-badge {
            background: rgba(46, 204, 113, 0.15); color: var(--accent-green);
            font-weight: 800; font-size: 11px; padding: 4px 8px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; width: 100%;
            box-sizing: border-box;
        }
        .asset-yield-badge.blue { background: rgba(52, 152, 219, 0.15); color: var(--accent-blue); }

        .details {
            grid-column: 1 / -1; display: none; background: rgba(0,0,0,0.02);
            padding: 12px; border-top: 1px solid var(--item-border); font-size: 11px;
            color: #8e8e93; line-height: 1.8;
        }
        .asset-item.active .details { display: block; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(0,0,0,0.05); padding: 2px 0; }
        .detail-row span:last-child { color: var(--text-main); font-weight: 600; }
        
        .btn-tiny-graph {
             background: var(--accent-blue); color: white; border: none;
             padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: bold;
             margin-top: 8px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center;
             gap: 4px; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.2);
        }

        .section-header-highlight {
            margin: 25px 0 8px; padding: 12px 16px; border-radius: 16px;
            font-weight: 800; font-size: 16px; 
            background: var(--header-light-gradient); color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid rgba(52, 152, 219, 0.2);
            display: flex; align-items: center; justify-content: space-between;
        }
        .section-desc-small { font-size: 11px; color: #8e8e93; margin-bottom: 12px; padding: 0 5px; line-height: 1.4; }

        .section-header-styled {
            margin: 25px 0 12px; background: linear-gradient(135deg, #ffffff, #f0f2f5);
            padding: 14px 16px; border-radius: 16px;
            font-weight: 900; font-size: 16px; display: flex; align-items: center; justify-content: space-between;
            color: var(--graphite-color); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .dark-mode .section-header-styled {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: #f1f5f9; border-color: rgba(255,255,255,0.1);
        }
        
        .info-expanded-block {
            display: none;
            background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 15px;
            border: 1px solid var(--accent-blue); font-size: 12px; line-height: 1.5; color: var(--text-secondary);
            animation: fadeIn 0.3s ease;
        }
        .info-expanded-block.show { display: block; }
        
        .echelon-info-graphic {
            display: flex; flex-direction: column; gap: 10px; margin-top: 10px;
        }
        .eig-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px; border-radius: 16px;
            background: linear-gradient(135deg, var(--bg-color), rgba(255,255,255,0.5));
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .eig-item:active { transform: scale(0.98); }
        .eig-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0; width: 4px;
        }
        .eig-item.e1::before { background: linear-gradient(180deg, #2ecc71, #27ae60); }
        .eig-item.e2::before { background: linear-gradient(180deg, #3498db, #2980b9); }
        .eig-item.e3::before { background: linear-gradient(180deg, #f1c40f, #f39c12); }
        .eig-item.e4::before { background: linear-gradient(180deg, #e67e22, #d35400); }
        
        .eig-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .eig-item.e1 .eig-icon { background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(46,204,113,0.05)); }
        .eig-item.e2 .eig-icon { background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.05)); }
        .eig-item.e3 .eig-icon { background: linear-gradient(135deg, rgba(241,196,15,0.2), rgba(241,196,15,0.05)); }
        .eig-item.e4 .eig-icon { background: linear-gradient(135deg, rgba(230,126,34,0.2), rgba(230,126,34,0.05)); }
        
        .eig-text { flex: 1; }
        .eig-title { 
            font-weight: 800; font-size: 13px; color: var(--text-main); margin-bottom: 4px;
            display: flex; align-items: center; gap: 8px;
        }
        .eig-badge {
            font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .eig-item.e1 .eig-badge { background: rgba(46,204,113,0.15); color: #27ae60; }
        .eig-item.e2 .eig-badge { background: rgba(52,152,219,0.15); color: #2980b9; }
        .eig-item.e3 .eig-badge { background: rgba(241,196,15,0.15); color: #f39c12; }
        .eig-item.e4 .eig-badge { background: rgba(230,126,34,0.15); color: #d35400; }
        
        .eig-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        
        .eig-arrow {
            width: 24px; height: 24px; border-radius: 50%;
            background: var(--card-bg); display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); flex-shrink: 0;
        }

        .allocation-info-connected {
            display: flex; align-items: stretch; justify-content: space-between;
            margin-bottom: 12px; width: 100%;
            background: var(--card-bg); border: 1px solid var(--accent-blue);
            border-radius: 20px; padding: 0; position: relative; overflow: hidden;
        }
        .alloc-left {
            padding: 8px 16px; font-size: 13px; color: var(--text-main);
            display: flex; align-items: center; flex: 1; border: none; background: transparent;
        }
        .alloc-right {
            background: var(--accent-blue); color: white; padding: 8px 16px;
            font-weight: 800; font-size: 11px; display: flex; align-items: center;
            white-space: nowrap; border-radius: 20px; margin: 2px;
        }
        
        .section-transition {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin: 15px 0 25px; opacity: 1; position: relative;
        }
        .st-line { height: 1px; flex: 1; background: linear-gradient(90deg, transparent, var(--accent-blue)); }
        .st-line.rev { background: linear-gradient(90deg, var(--accent-blue), transparent); }
        .st-icon {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--card-bg); color: var(--accent-blue);
            border: 1px solid var(--accent-blue); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); z-index: 5; font-size: 20px; line-height: 1;
        }
        
        .echelon-separator-modern {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; margin-top: 15px; margin-bottom: 5px;
            border-bottom: 2px solid var(--item-border);
        }
        .esm-left { display: flex; align-items: center; gap: 8px; }
        .esm-dot { width: 8px; height: 8px; border-radius: 50%; }
        .esm-title { font-weight: 800; font-size: 12px; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }

        .echelon-separator-modern.echelon-1 .esm-dot { background-color: var(--accent-green); }
        .echelon-separator-modern.echelon-2 .esm-dot { background-color: var(--accent-blue); }
        .echelon-separator-modern.echelon-3 .esm-dot { background-color: var(--accent-yellow); }
        .echelon-separator-modern.echelon-4 .esm-dot { background-color: var(--accent-orange); }

        .esm-info-btn-light {
            width: 18px; height: 18px; border-radius: 50%; 
            background: rgba(255,255,255,0.8); color: var(--accent-blue); /* Light style */
            font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .esm-info-btn-light:hover { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        
        .esm-pct { 
            font-size: 12px; font-weight: normal; color: var(--text-secondary); 
            display: flex; align-items: center; gap: 8px;
        }
        .esm-sum { color: var(--accent-blue); font-weight: 300; font-size: 13px; }
        .esm-divider { color: var(--item-border); font-weight: 300; }
        .esm-percent {
            background: rgba(52,152,219,0.1); padding: 4px 10px; border-radius: 8px; 
            color: var(--accent-blue); font-weight: 800; display: flex; align-items: center;
        }
        
        .echelon-tip {
            display: none; 
            background: #3a506b; color: white; padding: 10px; border-radius: 8px;
            font-size: 11px; font-weight: normal; line-height: 1.3;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 10px;
        }
        .echelon-tip.show { display: block; animation: fadeIn 0.2s ease; }

        .coupon-box {
            background: var(--card-bg); border-radius: 16px; margin-top: 10px;
            border: 1px solid var(--accent-blue); overflow: hidden; margin-bottom: 10px;
            position: relative; z-index: 2;
        }
        .coupon-header {
            padding: 12px 14px; background: var(--coupon-blue-bg); color: var(--accent-blue);
            font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; cursor: pointer; align-items: center;
            position: relative;
        }
        .coupon-title-wrapper { display: flex; align-items: flex-start; gap: 10px; }
        .coupon-icon-lg { font-size: 20px; line-height: 1.2; }
        .coupon-text-col { display: flex; flex-direction: column; line-height: 1.1; }
        .coupon-main-text { font-size: 14px; font-weight: 800; }
        .coupon-preview-mini { font-size: 9px; opacity: 0.7; font-weight: normal; margin-top: 2px; }
        .coupon-content { display: none; padding: 0 12px 12px; }
        .coupon-content.active { display: block; }
        
        .coupon-table-head {
            display: grid; grid-template-columns: 85px 1fr 50px 70px; gap: 5px;
            padding: 8px 0; font-size: 9px; font-weight: 800; color: #95a5a6;
            border-bottom: 2px solid var(--item-border); margin-top: 10px; margin-bottom: 5px;
        }
        .coupon-row {
            display: grid; grid-template-columns: 85px 1fr 50px 70px; gap: 5px;
            padding: 10px 0; border-bottom: 1px solid var(--item-border); font-size: 11px; align-items: center;
        }
        .coupon-row:last-child { border-bottom: none; }
        .coupon-row b { color: var(--text-main); }
        .arrow-icon { width: 14px; height: 14px; fill: currentColor; transition: transform 0.3s; }
        .coupon-content.active + .coupon-header .arrow-icon, 
        .coupon-header[onclick*="toggle"] .arrow-icon.rotated { transform: rotate(180deg); }

        .tax-selector-ui { display: flex; background: var(--bg-color); border-radius: 10px; padding: 3px; margin: 12px 0; gap: 2px; }
        .tax-ui-btn {
            flex: 1; border: none; background: transparent; padding: 6px;
            font-size: 11px; font-weight: bold; color: #8e8e93; border-radius: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .tax-ui-btn.active { background: var(--card-bg); color: var(--accent-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .footer-disclaimer-important {
            margin-top: 15px; margin-bottom: 25px; text-align: left; 
            color: var(--text-main); 
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(46, 204, 113, 0.15));
            padding: 20px; border-radius: 20px; 
            border: 1px solid rgba(46, 204, 113, 0.2);
            font-size: 13px; line-height: 1.6;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.1);
        }
        .footer-disclaimer-important::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--accent-green);
        }
        .footer-disclaimer { text-align: center; font-size: 11px; color: #99aab5; margin-top: 30px; padding: 0 20px; }

        .nav-wrapper {
    position: fixed; bottom: 25px; left: 0; width: 100%; 
    display: flex !important; justify-content: center; gap: 10px;
    padding: 0 15px; box-sizing: border-box; z-index: 900;
}
        .nav-dock {
            background: var(--nav-bg); backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 25px; display: flex; align-items: center; padding: 8px 15px; gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--nav-border);
            transition: opacity 0.3s;
        }
        .nav-dock.hidden { opacity: 0; pointer-events: none; position: absolute; }
        
        .nav-search-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--nav-bg); backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--nav-border);
            cursor: pointer; color: var(--nav-icon-inactive); transition: all 0.2s; position: relative;
        }
        .nav-search-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .nav-search-btn:active { transform: scale(0.9); }
        
        .nav-search-expanded {
            position: absolute; bottom: 0; left: 15px; right: 15px;
            height: 66px;
            background: var(--nav-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 25px;
            display: flex; align-items: center; padding: 0 5px; gap: 5px; /* Less padding */
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            border: none;
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 910;
        }
        .nav-search-expanded.active { transform: translateY(0); }
        
        .nav-search-input-bar {
            flex: 1; border: none; background: rgba(0,0,0,0.05);
            height: 44px; border-radius: 22px; padding: 0 15px;
            font-size: 14px; outline: none; color: var(--text-main);
            box-shadow: none; -webkit-appearance: none;
        }
        .dark-mode .nav-search-input-bar { background: rgba(255,255,255,0.1); }
        .nav-search-input-bar:focus { outline: none; }

        .nav-item {
            display: flex; align-items: center; justify-content: center; width: 44px; height: 44px;
            border-radius: 15px; cursor: pointer; transition: all 0.2s; color: var(--nav-icon-inactive);
        }
        .nav-item.active { color: var(--accent-blue); background: rgba(52, 152, 219, 0.1); }
        .nav-item svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .nav-item:active { transform: scale(0.9); }
        
        .nav-back-island {
            width: 44px; height: 44px; border-radius: 15px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .nav-back-island svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2; }

        .theme-toggle-mini {
            width: 24px; height: 24px; border-radius: 50%;
            background: var(--card-bg); color: var(--text-main); 
            border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: absolute; top: -10px; right: -12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 910;
        }
        .theme-toggle-mini svg { width: 14px; height: 14px; stroke: currentColor; fill: none; }

        .list-header-row {
            display: grid; padding: 0 16px; margin-bottom: 5px;
            font-size: 9px; font-weight: 700; color: #95a5a6; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .list-header-row.ofz-cols {
            grid-template-columns: 1fr 60px 60px 70px; gap: 8px; text-align: right;
        }
        .list-header-row.ofz-cols span:first-child { text-align: left; }
        .list-header-row.ofz-cols span:nth-child(2), .list-header-row.ofz-cols span:nth-child(3) { text-align: center; }
        
        .list-header-row.calc-cols {
            /* Updated Grid for shifting right */
            display: grid; grid-template-columns: 1fr 70px 100px; gap: 8px;
            text-align: right; margin-bottom: 8px;
        }
        .list-header-row.calc-cols span:first-child { text-align: left; }
        
        .ofz-card-modern {
            background: var(--card-bg); border-radius: 16px;
            padding: 14px 16px; margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: grid; grid-template-columns: 1fr 60px 60px 70px; 
            align-items: center; gap: 8px;
            box-shadow: 0 4px 10px var(--card-shadow);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
        }
        .ofz-card-modern::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent-blue); }
        .ofz-card-modern:active { transform: scale(0.98); }
        .ofz-main-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .ofz-name-lg { font-weight: 700; font-size: 13px; color: var(--text-main); line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ofz-ticker-sm { font-size: 10px; color: #8e8e93; font-weight: 600; text-transform: uppercase; }
        
        .ofz-nkd-badge {
            font-size: 12px; font-weight: 700; color: #7f8c8d; text-align: center;
            background: rgba(0,0,0,0.04); padding: 4px 8px; border-radius: 8px;
        }
        .ofz-price { 
            font-size: 12px; font-weight: 700; color: #7f8c8d; text-align: center; 
            background: rgba(0,0,0,0.04); padding: 4px 8px; border-radius: 8px;
        }
        
        .ofz-yield-badge { 
            font-weight: 800; font-size: 13px; color: var(--accent-green); 
            background: rgba(46, 204, 113, 0.1); padding: 6px 8px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; gap: 2px;
        }
        .ofz-arrow { width: 10px; height: 10px; fill: currentColor; }
        
        .ofz-details-panel {
            display: none; background: rgba(0,0,0,0.02);
            padding: 12px; border-radius: 0 0 16px 16px; margin-top: -10px; margin-bottom: 10px;
            border: 1px solid var(--border-color); border-top: none; font-size: 11px; color: var(--text-secondary);
        }
        .ofz-details-panel.active { display: block; animation: fadeIn 0.3s; }
        .ofz-detail-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed rgba(0,0,0,0.05); padding: 2px 0; }
        .ofz-detail-val { font-weight: bold; color: var(--text-main); }

        .calc-badge-modern {
            font-size: 10px; background: linear-gradient(135deg, #34495e, #2c3e50); color: white; 
            padding: 4px 10px; border-radius: 20px; font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); letter-spacing: 0.5px;
        }

        .monthly-calc-box {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .monthly-calc-box .input-wrapper input {
            font-size: 28px;
        }

        .calc-expl-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.5;
            padding: 0 10px;
            margin: 15px 0;
        }

        .calc-bond-row {
            display: grid; grid-template-columns: 1fr 70px 100px; align-items: center;
            padding: 10px 0; border-bottom: 1px dashed var(--item-border); gap: 8px;
        }
        .calc-bond-row:last-child { border-bottom: none; }
        .unified-badge-container { display: flex; align-items: center; width: 100%; overflow: hidden; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .ub-name {
            background: #ffffff; color: var(--text-main); padding: 4px 8px; border: 1px solid #dfe6e9;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-radius: 6px; width: 100%;
        }
        .ub-price {
            background: #dfe6e9; color: #636e72; padding: 4px 8px; border-radius: 6px;
            white-space: nowrap; font-size: 11px; text-align: center;
        }
        .ub-yield {
            background: rgba(46, 204, 113, 0.2); color: #27ae60; padding: 4px 8px; white-space: nowrap;
            border-radius: 6px; font-size: 11px; text-align: center; width: 100%;
        }
        .dark-mode .ub-name { background: #1e293b; color: #f1f5f9; border-color: #334155; }
        .dark-mode .ub-price { background: #475569; color: #94a3b8; }

        .qty-controls { display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
        .qty-btn { 
            width: 28px; height: 28px; border-radius: 6px; background: var(--card-bg); 
            display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--accent-blue);
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 16px;
            border: 1px solid var(--border-color);
        }
        .qty-btn:active { transform: scale(0.9); background: #eee; }
        .calc-input {
            width: 44px; /* Increased width for 10000 */
            border: none;
            font-size: 12px; /* Adjusted font size */
            font-weight: bold; text-align: center;
            background: transparent; color: var(--text-main); outline: none; padding: 0;
            -moz-appearance: textfield;
        }
        .calc-input::-webkit-outer-spin-button,
        .calc-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn-row-reset {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            color: #e74c3c; cursor: pointer; opacity: 0.7;
        }
        
        .result-list-container { margin-top: 15px; background: rgba(0,0,0,0.02); border-radius: 8px; padding: 10px; }
        .dark-mode .result-list-container { background: rgba(255,255,255,0.03); }

        .info-i-blue {
            display: inline-flex; width: 24px; height: 24px; border-radius: 50%; color: var(--accent-blue);
            font-size: 14px; font-weight: bold; align-items: center; justify-content: center; margin-left: 6px; cursor: pointer;
        }
        
        /* Yield Info Preview Box */
        .info-preview-box {
            display: none;
            background: var(--coupon-blue-bg);
            color: var(--accent-blue);
            padding: 12px 16px;
            border-radius: 12px;
            margin: -5px 0 15px 0;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.5;
            border: 1px solid rgba(52, 152, 219, 0.2);
            animation: fadeIn 0.3s;
        }
        .info-preview-box.show { display: block; }
        
        .search-container { padding: 10px 0; }
        .search-result-item { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--item-border); cursor: pointer; }
        .search-result-item:active { background: rgba(0,0,0,0.02); }
        
        .btn-reset-wide {
            width: 100%; box-sizing: border-box;
            padding: 12px; border: none; background: #f1f2f6; color: #7f8c8d;
            border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;
        }
        .btn-reset-wide:active { background: #e0e0e0; }
        .dark-mode .btn-reset-wide { background: #2d3748; color: #cbd5e0; }
        
     /* Компактная карточка ребалансировки */
.rebalance-intro-modern {
    background: #ffffff;
    border: 1px solid rgba(0,0,0,0.03);
    padding: 16px 20px; /* Уменьшили внутренние отступы */
    border-radius: 24px; /* Чуть менее агрессивное скругление для компактности */
    margin-bottom: 20px;
    display: flex; /* Включаем гибкий контейнер */
    flex-direction: row; /* Располагаем элементы в ряд */
    align-items: center; /* Центрируем иконку и текст по вертикали */
    gap: 16px; /* Расстояние между иконкой и текстом */
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
}

/* Маленькая иконка слева */
.ri-icon {
    width: 48px; /* Уменьшили размер */
    height: 48px;
    background: #F9F1EF;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #D97757;
    flex-shrink: 0; /* Чтобы иконка не сжималась */
}

.ri-icon svg {
    width: 24px;
    height: 24px;
}

/* Блок для текста */
.rebalance-text-block {
    display: flex;
    flex-direction: column;
    text-align: left; /* Текст теперь слева */
    gap: 2px;
}

.rebalance-card-title {
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 16px; /* Уменьшили шрифт заголовка */
    color: #2C364C;
    margin: 0;
}

.rebalance-card-desc {
    font-family: 'Inter', sans-serif;
    font-size: 12px; /* Уменьшили шрифт описания */
    color: #8A9AB0;
    margin: 0;
    line-height: 1.4;
}

/* Темная тема */
body.dark-mode .rebalance-intro-modern {
    background: rgba(30, 41, 59, 0.7);
}


        .echelon-header-pill {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
            color: #555; border: 1px solid rgba(0,0,0,0.1);
            border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 800; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin: 0 auto;
        }
        .dark-mode .echelon-header-pill { background: rgba(30,41,59,0.8); color: #ccc; border-color: rgba(255,255,255,0.1); }
        
        th:nth-child(1) .echelon-header-pill { color: #27ae60; border-color: #2ecc71; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2); }
        th:nth-child(2) .echelon-header-pill { color: #2980b9; border-color: #3498db; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2); }
        th:nth-child(3) .echelon-header-pill { color: var(--accent-yellow); border-color: var(--accent-yellow); box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2); }
        th:nth-child(4) .echelon-header-pill { color: var(--accent-orange); border-color: var(--accent-orange); box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2); }

        .echelon-table-styled { width: 100%; border-collapse: separate; border-spacing: 0; }
        .echelon-table-styled th { padding-bottom: 15px; vertical-align: bottom; }
        .echelon-table-styled td { padding: 12px 6px; border-bottom: 1px solid var(--item-border); text-align: center; vertical-align: middle; }
        .echelon-table-styled tr:last-child td { border-bottom: none; }
        .echelon-table-styled tr:nth-child(even) { background-color: rgba(0,0,0,0.015); }
        .dark-mode .echelon-table-styled tr:nth-child(even) { background-color: rgba(255,255,255,0.015); }
        
        .et-ticker { font-weight: 800; font-size: 11px; color: var(--text-main); display: block; margin-bottom: 4px; }
        .et-target {
            display: inline-block; font-size: 10px; font-weight: 700; color: var(--accent-green);
            background: rgba(46, 204, 113, 0.1); padding: 2px 6px; border-radius: 6px;
        }

        .echelon-wrapper {
            position: relative; border-radius: 16px; 
            padding: 20px 5px; overflow: hidden; 
            transition: max-height 0.4s ease;
        }
        .echelon-wrapper.collapsed { max-height: 240px; }
        
        #ofz-wrapper { padding: 0; }
        #ofz-wrapper.collapsed { max-height: 180px; }
        
        .echelon-wrapper.collapsed::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(to bottom, transparent, var(--bg-color));
            pointer-events: none;
        }
        .expand-arrow-btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 0; margin-top: -16px; cursor: pointer;
            position: relative; z-index: 5; height: 32px;
        }
        #ofz-wrapper + .expand-arrow-btn { margin-top: 10px; }
        .eab-line { flex: 1; height: 1px; background: var(--item-border); }
        .eab-icon-box {
            width: 28px; height: 28px; border-radius: 50%; background: var(--card-bg);
            border: 1px solid var(--accent-blue); color: var(--accent-blue);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.3s;
        }
        .expand-arrow-btn:active .eab-icon-box { transform: scale(0.95); }
        .expand-arrow-btn.open .eab-icon-box { transform: rotate(180deg); }

        
        
        
        

        
       
        
        .company-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { width: 36px; height: 36px; border-radius: 12px; background: var(--card-bg); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; color: var(--text-main); }
        .company-title { font-size: 20px; font-weight: 800; line-height: 1.2; }
        
        .company-card-v2 {
            background: var(--card-bg); border-radius: 20px; padding: 20px; 
            box-shadow: 0 8px 25px var(--card-shadow); border: 1px solid var(--border-color); 
            margin-bottom: 20px;
        }
        .cc-v2-header { display: flex; align-items: center; gap: 14px; margin-bottom: 20px; }
        .cc-v2-logo { 
            width: 48px; height: 48px; border-radius: 14px; background: var(--bg-color); 
            display: flex; align-items: center; justify-content: center; font-weight: 800;
            font-size: 12px; color: var(--text-secondary);
        }
        .cc-v2-name { font-size: 16px; font-weight: 800; color: var(--text-main); }
        .cc-v2-type { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .cc-v2-price-block { display: flex; align-items: baseline; gap: 8px; margin-bottom: 15px; }
        .cc-v2-price { font-size: 34px; font-weight: 800; color: var(--text-main); }
        .cc-v2-change { font-size: 14px; font-weight: 700; }
        .cc-v2-change.positive { color: var(--accent-green); }
        .cc-v2-change.negative { color: var(--accent-red); }
        .cc-v2-change.neutral { color: var(--text-secondary); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: var(--bg-color); border-radius: 12px; padding: 12px; }
        .stat-label { font-size: 10px; color: #8e8e93; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }
        .stat-val { font-size: 14px; font-weight: 800; color: var(--text-main); }
        
        .news-header { font-size: 16px; font-weight: 800; margin-bottom: 10px; }
        .news-item { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 10px; border: 1px solid var(--item-border); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .news-date { font-size: 10px; color: var(--accent-blue); font-weight: bold; margin-bottom: 4px; }
        .news-title { font-size: 13px; font-weight: bold; line-height: 1.4; margin-bottom: 6px; }
        .news-snippet { font-size: 11px; color: #8e8e93; line-height: 1.5; }
        
        .search-empty-state {
            text-align: center; padding: 40px 20px; color: var(--text-secondary);
        }
        .search-empty-state .icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        .search-empty-state .title { font-size: 16px; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .search-empty-state .desc { font-size: 12px; line-height: 1.5; }

     /* Стили для таблицы эшелонов с раскрывающимися деталями */
.echelon-table-styled td.et-cell {
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
}

.echelon-table-styled td.et-cell:hover {
    background: rgba(52, 152, 219, 0.05);
}

.et-cell-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.et-ticker {
    font-weight: 800;
    font-size: 12px;
    color: var(--text-main);
}

.et-price {
    font-size: 10px;
    color: var(--text-secondary);
}

.et-cell-empty {
    cursor: default !important;
}

.et-details-row td {
    padding: 0 !important;
    border: none !important;
    background: var(--bg-color);
}

.et-details-container {
    padding: 12px 20px;
}

.et-expanded-details {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--accent-blue);
    box-shadow: 0 4px 10px rgba(52, 152, 219, 0.1);
}

.et-details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--item-border);
}

.et-details-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.et-details-ticker {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-main);
}

.et-details-echelon {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 6px;
    background: rgba(52, 152, 219, 0.1);
    color: var(--accent-blue);
    text-transform: uppercase;
}

.et-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.et-detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.et-detail-label {
    font-size: 10px;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
}

.et-detail-value {
    font-size: 13px;
    color: var(--text-main);
    font-weight: 700;
}

.et-details-actions {
    display: flex;
    gap: 8px;
}

.et-btn-chart,
.et-btn-company {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
}

.et-btn-chart {
    background: var(--accent-blue);
    color: white;
}

.et-btn-chart:hover {
    background: #2980b9;
}

.et-btn-company {
    background: var(--bg-color);
    color: var(--accent-blue);
    border: 1px solid var(--accent-blue);
}

.et-btn-company:hover {
    background: rgba(52, 152, 219, 0.1);
}

.et-btn-chart svg,
.et-btn-company svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

        /* Стили раскрытия для 3-й вкладки (Портфель) */
.asset-item .details {
    display: none !important;
}

.asset-item.is-expanded .details {
    display: block !important;
    animation: fadeIn 0.3s ease;
}

.asset-item {
    cursor: pointer;
}

.asset-item.is-expanded {
    background: rgba(52, 152, 219, 0.05);
}

/* Единый стиль для заглушки */
input#sumInput::placeholder {
    color: #CBD5E1;
    opacity: 1;
    font-size: 1.5rem; /* 24px - увеличенный размер */
    font-family: 'JetBrains Mono', monospace;
    font-weight: 300;
    letter-spacing: 0.01em;
    text-transform: none;
}

/* Цвет для темной темы (если она у вас переключается классом .dark-mode) */
.dark-mode #sumInput::placeholder {
    color: #475569;
}

/* ========== BLOOMBERG/HUD COMPANY CARD DESIGN ========== */

/* Динамическое свечение фона для страницы компании */
#screen-company {
    position: relative;
    background: var(--bg-base);
    min-height: 100vh;
    margin: -16px;
    padding: 16px;
}

body.dark-mode #screen-company {
    background: var(--bg-base);
}

/* Динамическое свечение в зависимости от цены */
#screen-company.company-screen-active::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at 30% 20%, var(--glow-color, rgba(46, 204, 113, 0.15)) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
    animation: glowPulse 5s ease-in-out infinite;
}

@keyframes glowPulse {
    0%, 100% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 0.9; transform: scale(1.03); }
}

#screen-company > *:not(.aurora-container):not(.noise-overlay) {
    position: relative;
    z-index: 2;
}

/* Верхняя панель навигации */
.company-top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    margin-bottom: 20px;
}

.company-back-btn {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-main);
    transition: all 0.2s ease;
}

.company-back-btn:active {
    transform: scale(0.95);
    background: rgba(255, 255, 255, 0.15);
}

.company-ticker-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-main);
    letter-spacing: 0.5px;
}

.company-ticker-badge .ticker-dot {
    width: 6px;
    height: 6px;
    background: var(--accent-green);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--accent-green);
}

/* Hero секция с названием и ценой */
.company-hero {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px 0;
}

.company-hero-name {
    font-family: 'Inter', sans-serif;
    font-size: 36px;
    font-weight: 800;
    color: var(--text-main);
    letter-spacing: -0.06em;
    line-height: 1.1;
    margin-bottom: 20px;
    text-transform: uppercase;
}

.company-hero-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 56px;
    font-weight: 500;
    color: var(--text-main);
    letter-spacing: -0.02em;
    margin-bottom: 12px;
    line-height: 1;
}

.company-hero-change {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 20px;
    border-radius: 30px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 600;
}

.company-hero-change.positive {
    background: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
}

.company-hero-change.negative {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
}

.company-hero-change.neutral {
    background: rgba(127, 140, 141, 0.2);
    color: var(--text-secondary);
}

/* SVG мини-тренд */
.company-trend-svg {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.trend-line {
    stroke-dasharray: 300;
    stroke-dashoffset: 300;
    animation: drawLine 2s ease forwards;
}

@keyframes drawLine {
    to { stroke-dashoffset: 0; }
}

/* Кнопки действий */
.company-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
}

.company-action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 18px 20px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 16px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.2s ease;
}

.company-action-btn:active {
    transform: scale(0.98);
    background: rgba(255, 255, 255, 0.12);
}

.company-action-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.company-action-btn.primary {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: white;
}

/* Glassmorphism карточки */
.glass-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
}

.dark-mode .glass-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
}

/* Секция описания */
.company-deion-section {
    margin-bottom: 24px;
}

.company-section-title {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.company-section-title svg {
    width: 16px;
    height: 16px;
    stroke: var(--accent-blue);
}

.company-deion-text {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-main);
}

.company-deion-text .highlight {
    background: linear-gradient(120deg, rgba(52, 152, 219, 0.2) 0%, rgba(52, 152, 219, 0.1) 100%);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
}

/* Сетка аналитики */
.analytics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 24px;
}

.analytics-tile {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 16px;
    position: relative;
    overflow: hidden;
}

.analytics-tile::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
}

.analytics-tile.tile-forecast::before { background: linear-gradient(90deg, #3498db, #2ecc71); }
.analytics-tile.tile-dividends::before { background: linear-gradient(90deg, #2ecc71, #27ae60); }
.analytics-tile.tile-risk::before { background: linear-gradient(90deg, #f1c40f, #e67e22); }
.analytics-tile.tile-cap::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }

.analytics-tile-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.analytics-tile-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 8px;
}

.analytics-tile-sub {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--text-secondary);
}

/* Прогресс-бар для Target Forecast */
.forecast-progress {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 10px;
}

.forecast-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3498db, #2ecc71);
    border-radius: 3px;
    transition: width 1s ease;
}

/* Секция событий */
.events-section {
    margin-bottom: 24px;
}

.event-item {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 14px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.event-item:last-child {
    border-bottom: none;
}

.event-date {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 50px;
}

.event-date-day {
    font-family: 'JetBrains Mono', monospace;
    font-size: 24px;
    font-weight: 700;
    color: var(--accent-blue);
    line-height: 1;
}

.event-date-month {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.event-content {
    flex: 1;
}

.event-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 4px;
}

.event-deion {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* Dark mode адаптация */
.dark-mode .company-back-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .company-ticker-badge {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .company-action-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .analytics-tile {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.08);
}

/* ========== END: BLOOMBERG/HUD COMPANY CARD DESIGN ========== */

        /* ========================================================================
   ИНТЕРЕСНОЕ - GLASSMORPHISM REDESIGN (Claude AI Style)
   ======================================================================== */

/* ============================================
   ИНТЕРЕСНОЕ - Evolution Design System
   Quiet Luxury / Evolution Terminal
   Философия: Приборная панель из дорогого 
   матового стекла и оптики
   ============================================ */

/* === 2.1 Атмосфера и Фон === */
#screen-interesting {
    position: relative;
    background: var(--bg-base);
    min-height: 100vh;
    margin: -16px;
    padding: 0 16px 140px 16px;
    overflow: hidden;
}

body.dark-mode #screen-interesting {
    background: var(--bg-base);
}

/* Контейнер контента */
#screen-interesting > *:not(.aurora-container):not(.noise-overlay) {
    position: relative;
    z-index: 2;
}

/* === Заголовок экрана === */
#screen-interesting .header {
    padding: 30px 0 28px;
    text-align: left;
}

#screen-interesting .header h1 {
    font-family: 'Inter', sans-serif;
    font-size: 36px;
    font-weight: 600;
    letter-spacing: -0.06em;
    color: var(--text-deep, #0F172A);
    margin: 0;
}

body.dark-mode #screen-interesting .header h1 {
    color: var(--text-deep);
}

/* ============================================
   Компонент 1: Курсы Валют (Aero-Prism Tiles)
   Визуализация: Оптические призмы с внутренним 
   свечением и эффектом Underglow
   ============================================ */
#screen-interesting .market-tiles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 12px;
    margin-bottom: 32px;
}

#screen-interesting .market-tiles-grid.three-cols {
    grid-template-columns: repeat(3, 1fr);
}

/* Aero-Prism плитка - призматический эффект */
#screen-interesting .market-tile {
    background: linear-gradient(160deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.4) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 18px 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s ease;
    /* Призматические границы - блик сверху/слева, тень снизу */
    border-top: 1px solid rgba(255, 255, 255, 0.8);
    border-left: 1px solid rgba(255, 255, 255, 0.8);
    border-right: 1px solid rgba(255, 255, 255, 0.3);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
        0 4px 20px -4px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

#screen-interesting .market-tile:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 8px 32px -4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

#screen-interesting .market-tile:active {
    transform: scale(0.98);
}

/* Underglow эффект - цветной туман снизу */
#screen-interesting .market-tile::before {
    content: '';
    position: absolute;
    bottom: -30%;
    left: 10%;
    width: 80%;
    height: 80%;
    border-radius: 50%;
    filter: blur(20px);
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
    z-index: -1;
}

#screen-interesting .market-tile.positive::before {
    background: #10B981;
    opacity: 0.15;
}

#screen-interesting .market-tile.negative::before {
    background: #EF4444;
    opacity: 0.15;
}

/* Label - 10px uppercase */
#screen-interesting .market-tile-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-slate, #64748B);
    opacity: 0.8;
    text-align: center;
}

/* Value - крупное JetBrains Mono с тенью */
#screen-interesting .market-tile-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 17px;
    font-weight: 700;
    color: var(--text-deep, #0F172A);
    letter-spacing: -0.02em;
    text-align: center;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6);
}

/* Capsule (пилюля) с процентом и иконкой */
#screen-interesting .market-tile-change {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(8px);
}

#screen-interesting .market-tile-change.positive {
    color: #059669;
    background: rgba(16, 185, 129, 0.12);
}

#screen-interesting .market-tile-change.negative {
    color: #DC2626;
    background: rgba(239, 68, 68, 0.12);
}

#screen-interesting .market-tile-change.neutral {
    color: var(--text-slate, #64748B);
}

/* Иконка стрелки в capsule */
#screen-interesting .market-tile-change .trend-arrow {
    width: 10px;
    height: 10px;
}

/* Dark mode для Aero-Prism плиток */
body.dark-mode #screen-interesting .market-tile {
    background: linear-gradient(160deg, rgba(30, 41, 59, 0.7) 0%, rgba(30, 41, 59, 0.4) 100%);
    border-top-color: rgba(255, 255, 255, 0.12);
    border-left-color: rgba(255, 255, 255, 0.12);
    border-right-color: rgba(255, 255, 255, 0.05);
    border-bottom-color: rgba(255, 255, 255, 0.02);
    box-shadow: 
        0 4px 20px -4px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
}

body.dark-mode #screen-interesting .market-tile-value {
    color: var(--text-deep);
    text-shadow: none;
}

body.dark-mode #screen-interesting .market-tile-change {
    background: rgba(255, 255, 255, 0.08);
}

/* ============================================
   Компонент 2: Вертикаль Ставок (Imprinted List)
   Визуализация: Информация "выгравирована" на фоне.
   Нет карточек, нет рамок - минималистичный стиль.
   ============================================ */
#screen-interesting .rates-glass-card {
    /* Убираем карточку - делаем прозрачным */
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: none;
    border-radius: 0;
    padding: 0 12px;
    margin-bottom: 36px;
    box-shadow: none;
}

/* Заголовок с иконкой */
#screen-interesting .rates-glass-card .rv-title {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-slate, #64748B);
    opacity: 0.6;
    margin-bottom: 20px;
    padding-left: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Иконка в заголовке */
#screen-interesting .rates-glass-card .rv-title::before {
    content: '';
    display: inline-flex;
    width: 16px;
    height: 16px;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' stroke='%2364748B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 20V10'/%3E%3Cpath d='M18 20V4'/%3E%3Cpath d='M6 20v-4'/%3E%3C/svg%3E");
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 0.7;
}

/* Убираем линию после заголовка */
#screen-interesting .rates-glass-card .rv-title::after {
    display: none;
}

#screen-interesting .rates-row-list {
    display: flex;
    flex-direction: column;
}

/* Строка ставки - Imprinted стиль */
#screen-interesting .rate-row-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 24px;
    /* Тонкий разделитель */
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
}

#screen-interesting .rate-row-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

#screen-interesting .rate-row-item:first-child {
    padding-top: 0;
}

/* Текст слева - строго под буквой "В" заголовка */
#screen-interesting .rate-row-label {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-slate, #64748B);
    padding-left: 0;
}

/* Значение справа - симметричный отступ */
#screen-interesting .rate-row-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-deep, #0F172A);
    padding-right: 0;
}

body.dark-mode #screen-interesting .rate-row-item {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

body.dark-mode #screen-interesting .rate-row-value {
    color: var(--text-deep);
}

body.dark-mode #screen-interesting .rates-glass-card .rv-title::before {
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 20V10'/%3E%3Cpath d='M18 20V4'/%3E%3Cpath d='M6 20v-4'/%3E%3C/svg%3E");
}

/* ============================================
   Компонент 3: Калькулятор (Hero Card)
   Визуализация: Главный герой экрана. Плотное 
   матовое стекло, парящее над фоном.
   ============================================ */
#screen-interesting .calc-accordion {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    /* Hero Glass границы */
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 24px;
    overflow: hidden;
    margin-bottom: 20px;
    /* Глубокая тень - парящий эффект */
    box-shadow: 
        0 20px 50px -12px rgba(15, 23, 42, 0.12),
        0 8px 20px -8px rgba(15, 23, 42, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transition: 
        box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
        border-color 0.5s ease;
}

/* Свернутое состояние */
#screen-interesting .calc-accordion.collapsed {
    box-shadow: 
        0 8px 24px -6px rgba(15, 23, 42, 0.08),
        0 4px 12px -4px rgba(15, 23, 42, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

body.dark-mode #screen-interesting .calc-accordion {
    background: rgba(30, 41, 59, 0.85);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 
        0 20px 50px -12px rgba(0, 0, 0, 0.4),
        0 8px 20px -8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
}

/* Header калькулятора */
#screen-interesting .calc-accordion-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    cursor: pointer;
    transition: background 0.2s ease;
    user-select: none;
}

#screen-interesting .calc-accordion-header:hover {
    background: rgba(0, 0, 0, 0.02);
}

body.dark-mode #screen-interesting .calc-accordion-header:hover {
    background: rgba(255, 255, 255, 0.03);
}

#screen-interesting .calc-accordion-header-left {
    display: flex;
    align-items: center;
    gap: 14px;
}

/* Иконка калькулятора - центрирована относительно двух строк текста */
#screen-interesting .calc-accordion-icon {
    width: 44px;
    height: 44px;
    min-width: 44px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#screen-interesting .calc-accordion-icon svg {
    width: 22px;
    height: 22px;
    color: #10B981;
}

/* Пульсация иконки ЗЕЛЕНЫМ при свернутом состоянии */
#screen-interesting .calc-accordion.collapsed .calc-accordion-icon {
    animation: iconPulseGreen 2s ease-in-out infinite;
}

@keyframes iconPulseGreen {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
    }
    50% { 
        transform: scale(1.02);
        box-shadow: 0 0 0 8px rgba(16, 185, 129, 0.15);
    }
}

/* Дышащая рамка при свернутом состоянии */
#screen-interesting .calc-accordion.collapsed {
    animation: borderBreatheGreen 3s ease-in-out infinite;
}

@keyframes borderBreatheGreen {
    0%, 100% { border-color: rgba(255, 255, 255, 0.6); }
    50% { border-color: rgba(16, 185, 129, 0.3); }
}

body.dark-mode #screen-interesting .calc-accordion.collapsed {
    animation: borderBreatheGreenDark 3s ease-in-out infinite;
}

@keyframes borderBreatheGreenDark {
    0%, 100% { border-color: rgba(255, 255, 255, 0.1); }
    50% { border-color: rgba(16, 185, 129, 0.25); }
}

#screen-interesting .calc-accordion-title {
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--text-deep, #0F172A);
}

body.dark-mode #screen-interesting .calc-accordion-title {
    color: var(--text-deep);
}

/* Подзаголовок - ВСЕГДА виден, даже при сворачивании */
#screen-interesting .calc-accordion-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-slate, #64748B);
    margin-top: 3px;
}

/* Стрелка шеврон - поворот -90deg при сворачивании */
#screen-interesting .calc-accordion-arrow {
    width: 24px;
    height: 24px;
    color: var(--text-slate, #64748B);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

#screen-interesting .calc-accordion.collapsed .calc-accordion-arrow {
    transform: rotate(-90deg);
}

/* Плавное сворачивание через grid-template-rows (Smooth Grid) */
#screen-interesting .calc-content-wrapper {
    display: grid;
    grid-template-rows: 1fr;
    transition: grid-template-rows 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

#screen-interesting .calc-accordion.collapsed .calc-content-wrapper {
    grid-template-rows: 0fr;
}

#screen-interesting .calc-accordion-content {
    overflow: hidden;
    padding: 0 20px 24px;
}

#screen-interesting .calc-accordion.collapsed .calc-accordion-content {
    padding: 0 20px;
}

/* ============================================
   Компонент: Инфографика (скрываемый блок)
   Заглушка для будущих функций
   ============================================ */

#screen-interesting .infographic-section {
    margin-top: 8px;
    padding: 0 4px;
    animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Главная карточка "В разработке" */
#screen-interesting .future-idea-card {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.05) 100%);
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
}

body.dark-mode #screen-interesting .future-idea-card {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.08) 100%);
    border-color: rgba(99, 102, 241, 0.25);
}

#screen-interesting .future-idea-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: rgba(99, 102, 241, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

#screen-interesting .future-idea-icon svg {
    width: 22px;
    height: 22px;
    stroke: #6366F1;
}

#screen-interesting .future-idea-title {
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--text-deep, #0F172A);
    margin-bottom: 6px;
}

body.dark-mode #screen-interesting .future-idea-title {
    color: #F1F5F9;
}

#screen-interesting .future-idea-desc {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    line-height: 1.5;
    color: #64748B;
}

/* Сетка будущих функций */
#screen-interesting .future-features-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

#screen-interesting .future-feature-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.8);
    border-radius: 16px;
    padding: 20px 12px;
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
}

body.dark-mode #screen-interesting .future-feature-item {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
}

#screen-interesting .future-feature-item:active {
    transform: scale(0.98);
}

#screen-interesting .future-feature-icon {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#screen-interesting .future-feature-icon svg {
    width: 24px;
    height: 24px;
}

#screen-interesting .future-feature-icon.blue {
    background: rgba(59, 130, 246, 0.15);
}
#screen-interesting .future-feature-icon.blue svg {
    stroke: #3B82F6;
}

#screen-interesting .future-feature-icon.green {
    background: rgba(16, 185, 129, 0.15);
}
#screen-interesting .future-feature-icon.green svg {
    stroke: #10B981;
}

#screen-interesting .future-feature-icon.orange {
    background: rgba(249, 115, 22, 0.15);
}
#screen-interesting .future-feature-icon.orange svg {
    stroke: #F97316;
}

#screen-interesting .future-feature-icon.purple {
    background: rgba(139, 92, 246, 0.15);
}
#screen-interesting .future-feature-icon.purple svg {
    stroke: #8B5CF6;
}

#screen-interesting .future-feature-item span {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-deep, #0F172A);
    line-height: 1.3;
}

body.dark-mode #screen-interesting .future-feature-item span {
    color: #E2E8F0;
}

/* Подпись "Скоро" */
#screen-interesting .future-coming-soon {
    text-align: center;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: #94A3B8;
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* ============================================
   Контент калькулятора - Evolution Design
   ============================================ */

/* Поле ввода суммы - крупное, выравнивание вправо */
#screen-interesting .glass-input-wrapper {
    background: #FFFFFF;
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 16px;
    padding: 16px 20px;
    margin-bottom: 16px;
    transition: all 0.2s ease;
    box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.015);
}

body.dark-mode #screen-interesting .glass-input-wrapper {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.1);
}

#screen-interesting .glass-input-wrapper:focus-within {
    border-color: #10B981;
    box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.015), 0 0 0 3px rgba(16, 185, 129, 0.1);
}

#screen-interesting .glass-input-wrapper .input-label {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-slate, #64748B);
    margin-bottom: 8px;
    display: block;
}

#screen-interesting .glass-input-wrapper input {
    width: 100%;
    border: none;
    background: transparent;
    font-family: 'JetBrains Mono', monospace;
    font-size: 26px;
    font-weight: 700;
    color: var(--text-deep, #0F172A);
    outline: none;
    text-align: right;
}

/* Символ рубля рядом с инпутом */
#screen-interesting .glass-input-wrapper .currency-symbol {
    font-family: 'JetBrains Mono', monospace;
    font-size: 26px;
    color: #CBD5E1;
}

body.dark-mode #screen-interesting .glass-input-wrapper input {
    color: var(--text-deep);
}

#screen-interesting .glass-input-wrapper input::placeholder {
    color: #CBD5E1;
    opacity: 0.6;
}

/* Информационный текст - Blue Info */
#screen-interesting .calc-info-text {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-slate, #64748B);
    line-height: 1.6;
    padding: 14px 16px;
    background: rgba(59, 130, 246, 0.04);
    border-radius: 12px;
    margin-bottom: 16px;
    border-left: 3px solid rgba(59, 130, 246, 0.4);
}

body.dark-mode #screen-interesting .calc-info-text {
    background: rgba(59, 130, 246, 0.08);
}

/* Сегментированный переключатель налога */
#screen-interesting .tax-segmented-control {
    display: flex;
    background: rgba(0, 0, 0, 0.04);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 20px;
    gap: 4px;
}

body.dark-mode #screen-interesting .tax-segmented-control {
    background: rgba(255, 255, 255, 0.06);
}

#screen-interesting .tax-segmented-control .tax-segment {
    flex: 1;
    padding: 10px 12px;
    border: none;
    background: transparent;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-slate, #64748B);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    /* Неактивные кнопки имеют opacity: 0.5 */
    opacity: 0.5;
}

#screen-interesting .tax-segmented-control .tax-segment:hover {
    opacity: 0.7;
}

#screen-interesting .tax-segmented-control .tax-segment.active {
    background: white;
    color: var(--text-deep, #0F172A);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    opacity: 1;
}

body.dark-mode #screen-interesting .tax-segmented-control .tax-segment.active {
    background: rgba(255, 255, 255, 0.12);
    color: var(--text-deep);
}

/* Заголовки таблицы: "Облигация" слева, "Кол-во" справа */
#screen-interesting .calc-table-header {
    display: grid;
    grid-template-columns: 1fr 60px 112px;
    gap: 0 16px;
    padding: 12px 0;
    margin-bottom: 0;
}

body.dark-mode #screen-interesting .calc-table-header {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

#screen-interesting .calc-table-header span {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-slate, #64748B);
}

#screen-interesting .calc-table-header span:nth-child(2) {
    text-align: center;
}

#screen-interesting .calc-table-header span:nth-child(3) {
    text-align: center;
}

/* Строки списка облигаций - прозрачный фон */
#screen-interesting .calc-bond-row {
    display: grid;
    grid-template-columns: 1fr 60px 112px;
    gap: 0 16px;
    padding: 16px 0;
    margin-bottom: 0;
    border-radius: 0;
    background: transparent;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    align-items: center;
    transition: all 0.2s ease;
}

#screen-interesting .calc-bond-row:last-child {
    border-bottom: none;
}

body.dark-mode #screen-interesting .calc-bond-row {
    background: transparent;
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

/* Название облигации (Inter) + номер (Mono) */
#screen-interesting .calc-bond-name {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-deep, #0F172A);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#screen-interesting .calc-bond-name .bond-number {
    font-family: 'JetBrains Mono', monospace;
}

body.dark-mode #screen-interesting .calc-bond-name {
    color: var(--text-deep);
}

/* Доходность - зелёная, JetBrains Mono, под названием */
#screen-interesting .calc-bond-yield,
#screen-interesting .ub-yield {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: #10B981;
    text-align: center;
    align-self: center;
    white-space: nowrap;
}

/* Контейнер для названия + доходности */
#screen-interesting .calc-bond-info {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px;
}

/* Контроллер количества [- N +] */
#screen-interesting .calc-qty-controller,
#screen-interesting .qty-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    background: rgba(0, 0, 0, 0.04);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(0, 0, 0, 0.06);
}

body.dark-mode #screen-interesting .calc-qty-controller,
body.dark-mode #screen-interesting .qty-controls {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.1);
}

#screen-interesting .calc-qty-controller button,
#screen-interesting .qty-controls .qty-btn {
    width: 30px;
    min-width: 30px;
    flex-shrink: 0;
    height: 40px;
    border: none;
    background: transparent;
    color: var(--text-deep, #0F172A);
    font-size: 18px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

#screen-interesting .calc-qty-controller button:hover,
#screen-interesting .qty-controls .qty-btn:hover {
    background: rgba(0, 0, 0, 0.05);
}

#screen-interesting .calc-qty-controller button:active,
#screen-interesting .qty-controls .qty-btn:active {
    transform: scale(0.95);
    background: rgba(0, 0, 0, 0.08);
}

body.dark-mode #screen-interesting .qty-controls .qty-btn {
    color: #E2E8F0;
}

#screen-interesting .calc-qty-controller input,
#screen-interesting .qty-controls .calc-input {
    flex: 1;
    min-width: 0;
    width: 0;
    height: 40px;
    border: none;
    background: transparent;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-deep, #0F172A);
    text-align: center;
    outline: none;
    -moz-appearance: textfield;
}

#screen-interesting .qty-controls .calc-input::-webkit-outer-spin-button,
#screen-interesting .qty-controls .calc-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

body.dark-mode #screen-interesting .calc-qty-controller input,
body.dark-mode #screen-interesting .qty-controls .calc-input {
    color: var(--text-deep);
}

/* Кнопка сброса - Red Alert стиль */
#screen-interesting .btn-reset-glass {
    width: 112px;
    padding: 10px;
    border: none;
    background: rgba(239, 68, 68, 0.08);
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: #EF4444;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 16px;
    margin-left: auto;
    transition: all 0.2s ease;
}

#screen-interesting .btn-reset-glass:hover {
    background: rgba(239, 68, 68, 0.12);
}

#screen-interesting .btn-reset-glass:active {
    transform: scale(0.98);
}

#screen-interesting .btn-reset-glass svg {
    width: 12px;
    height: 12px;
    stroke: #EF4444;
}

body.dark-mode #screen-interesting .btn-reset-glass {
    background: rgba(239, 68, 68, 0.15);
}

/* Блок результатов - тёмный градиент с inner shine */
#screen-interesting .results-glass-container {
    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
    border-radius: 16px;
    padding: 20px;
    margin-top: 20px;
    margin-left: -8px;
    margin-right: -8px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    position: relative;
    overflow: hidden;
}

/* Inner Shine - акцент в левом верхнем углу */
#screen-interesting .results-glass-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 150px;
    height: 150px;
    background: radial-gradient(circle at 0% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
    pointer-events: none;
}

body.dark-mode #screen-interesting .results-glass-container {
    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
    border-color: rgba(255, 255, 255, 0.1);
}

#screen-interesting .results-glass-title {
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: #FFFFFF;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
}

#screen-interesting .results-glass-title svg {
    color: #10B981;
}

/* Таблица выплат - внутри тёмного блока */
#screen-interesting .coupon-table-head {
    display: grid;
    grid-template-columns: 48px 1fr 56px 80px;
    gap: 0;
    padding: 8px 0 12px;
    border-bottom: none;
    margin-bottom: 4px;
    position: relative;
    z-index: 1;
}

#screen-interesting .coupon-table-head span {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255, 255, 255, 0.3);
}

#screen-interesting .coupon-table-head span:nth-child(3) {
    text-align: center;
}

#screen-interesting .coupon-table-head span:nth-child(4) {
    text-align: right;
}

body.dark-mode #screen-interesting .coupon-table-head {
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

/* Строка выплаты - внутри тёмного блока */
#screen-interesting .coupon-result-row {
    display: grid;
    grid-template-columns: 48px 1fr auto 80px;
    gap: 0;
    padding: 10px 0;
    margin-bottom: 0;
    border-radius: 0;
    background: transparent;
    border: none;
    border-bottom: none;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    position: relative;
    z-index: 1;
    align-items: center;
}

#screen-interesting .coupon-result-row:last-child {
    border-bottom: none;
}

body.dark-mode #screen-interesting .coupon-result-row {
    background: transparent;
    border-bottom-color: rgba(255, 255, 255, 0.15);
}

/* Дата - приглушённый белый, JetBrains Mono */
#screen-interesting .coupon-result-row .coupon-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
}

/* Название облигации - чистый белый, Inter */
#screen-interesting .coupon-result-row .coupon-name {
    color: #FFFFFF;
    font-weight: 500;
    font-size: 13px;
}

#screen-interesting .coupon-result-row .coupon-name .bond-number {
    font-family: 'JetBrains Mono', monospace;
}

body.dark-mode #screen-interesting .coupon-result-row .coupon-name {
    color: #FFFFFF;
}

/* Количество - плашка с полупрозрачным фоном */
#screen-interesting .coupon-result-row .coupon-qty {
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 6px 10px;
}

/* Сумма - зелёный неон, JetBrains Mono Bold */
#screen-interesting .coupon-result-row .coupon-sum {
    text-align: right;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: #10B981;
}

body.dark-mode #screen-interesting .coupon-result-row .coupon-sum {
    color: #10B981;
}

/* Footer итогов */
#screen-interesting .results-glass-footer {
    display: flex;
    flex-direction: column;
    padding-top: 14px;
    margin-top: 14px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    z-index: 1;
}

#screen-interesting .results-glass-footer .footer-label {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.6);
}

#screen-interesting .results-glass-footer .footer-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    font-weight: 700;
    color: #10B981;
}

body.dark-mode #screen-interesting .results-glass-footer {
    border-top-color: rgba(255, 255, 255, 0.1);
}

/* Placeholder text внутри тёмного блока */
#screen-interesting #calc-results-list {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.4);
    position: relative;
    z-index: 1;
}

/* ========== END: ИНТЕРЕСНОЕ EVOLUTION DESIGN ========== */

        /* ========================================================================
   ПОРТФЕЛЬ - GLASSMORPHISM REDESIGN (Claude AI Style)
   ======================================================================== */

/* =================================================================
   PORTFOLIO V2 - EVOLUTION DESIGN (как Ребалансировка)
   ================================================================= */

/* === Переключатель страниц К ПОКУПКЕ / МОИ АКТИВЫ === */
.portfolio-page-switcher {
    display: flex;
    gap: 0;
    margin: 16px 0 24px;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 14px;
    padding: 4px;
    border: 1px solid rgba(255, 255, 255, 0.6);
}

body.dark-mode .portfolio-page-switcher {
    background: rgba(30, 41, 59, 0.5);
    border-color: rgba(255, 255, 255, 0.1);
}

.portfolio-page-btn {
    flex: 1;
    padding: 12px 16px;
    background: transparent;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-slate);
    cursor: pointer;
    border-radius: 10px;
    transition: all 0.3s ease;
    position: relative;
}

.portfolio-page-btn.active {
    background: white;
    color: var(--text-deep);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

body.dark-mode .portfolio-page-btn.active {
    background: rgba(255, 255, 255, 0.15);
    color: white;
}

/* === Компактный блок Капитал + Прогноз (Evolution Design) === */
.portfolio-capital-card {
    position: relative;
    display: flex;
    flex-direction: column;
    padding: 24px;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
    border-radius: 20px;
    margin-bottom: 24px;
    box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.3);
    overflow: hidden;
}

body.dark-mode .portfolio-capital-card {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
}

/* Декоративная линия сверху */
.portfolio-capital-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 24px;
    right: 24px;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
}

.portfolio-capital-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
        rgba(255, 255, 255, 0.08) 0%,
        transparent 50%
    );
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.portfolio-capital-card:hover::before {
    opacity: 1;
}

/* Верхняя часть: Капитал */
.capital-top-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 20px;
}

.capital-main {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.capital-label {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.7);
}

.capital-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 32px;
    font-weight: 700;
    color: #FFFFFF;
    letter-spacing: -0.02em;
    line-height: 1;
}

.capital-fee-badge {
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: rgba(148, 163, 184, 0.8);
}

/* Прогресс-бар распределения - ОБЛИГАЦИИ СЛЕВА, АКЦИИ СПРАВА */
.capital-distribution {
    margin-bottom: 20px;
}

.capital-bar {
    display: flex;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 12px;
    background: rgba(255, 255, 255, 0.06);
}

/* Облигации СЛЕВА */
.capital-bar-bonds {
    background: linear-gradient(90deg, #5E7BA3, #7B9BBF);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    order: 1;
    position: relative;
}

.capital-bar-bonds::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
}

/* Акции СПРАВА */
.capital-bar-stocks {
    background: linear-gradient(90deg, #D97757, #E8956A);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    order: 2;
    position: relative;
}

.capital-bar-stocks::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
}

.capital-labels {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.capital-label-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.capital-label-dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
}

.capital-label-dot.bonds {
    background: linear-gradient(135deg, #5E7BA3, #7B9BBF);
}

.capital-label-dot.stocks {
    background: linear-gradient(135deg, #D97757, #E8956A);
}

.capital-label-text {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(148, 163, 184, 0.6);
}

.capital-label-pct {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: #F1F5F9;
}

/* Разделитель */
.capital-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    margin: 16px 0;
}

/* Прогноз - Evolution Design */
.capital-forecast {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 16px;
    background: rgba(16, 185, 129, 0.06);
    border: 1px solid rgba(16, 185, 129, 0.12);
    border-radius: 14px;
}

.forecast-icon-mini {
    width: 44px;
    height: 44px;
    min-width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
    border: 1px solid rgba(16, 185, 129, 0.25);
    border-radius: 12px;
    color: #10B981;
}

.forecast-icon-mini svg {
    width: 22px;
    height: 22px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.forecast-content-mini {
    flex: 1;
}

.forecast-title-mini {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(16, 185, 129, 0.6);
    margin-bottom: 8px;
}

/* Главная строка с суммой и процентом */
.forecast-main-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 12px;
}

.forecast-bottom-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.forecast-total-mini {
    font-family: 'JetBrains Mono', monospace;
    font-size: 17px;
    font-weight: 700;
    color: #10B981;
    letter-spacing: -0.01em;
}

.forecast-percent-change {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: #10B981;
    padding: 7px 12px;
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 10px;
    white-space: nowrap;
    align-self: center;
}

.forecast-details-mini {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: stretch;
    flex: 1;
}

.forecast-detail-item {
    display: grid;
    grid-template-columns: 6px auto 1fr;
    align-items: center;
    gap: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.8);
    width: 100%;
}

.forecast-detail-item .detail-dot {
    width: 6px;
    height: 6px;
    border-radius: 2px;
    flex-shrink: 0;
}

.forecast-detail-item .detail-dot.bonds {
    background: #5E7BA3;
}

.forecast-detail-item .detail-dot.stocks {
    background: #D97757;
}

.forecast-detail-item .detail-label {
    color: #64748B;
    font-size: 10px;
    white-space: nowrap;
    width: 52px;
    min-width: 52px;
}

.forecast-detail-item .detail-value {
    color: #E2E8F0;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    text-align: right;
    justify-self: end;
}

/* === Переключатель Денежный поток / Растущая часть === */
.portfolio-content-tabs {
    position: sticky;
    top: 10px;
    z-index: 100;
    margin: 0 0 24px;
    padding: 0 4px;
}

.portfolio-tab-switcher {
    position: relative;
    display: flex;
    align-items: center;
    padding: 6px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 100px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.5);
}

body.dark-mode .portfolio-tab-switcher {
    background: rgba(30, 41, 59, 0.7);
    border-color: rgba(255, 255, 255, 0.1);
}

.portfolio-tab-glider {
    position: absolute;
    top: 6px;
    left: 6px;
    width: calc(50% - 6px);
    height: calc(100% - 12px);
    background: #2C364C;
    border-radius: 100px;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
    box-shadow: 0 4px 15px rgba(44, 54, 76, 0.3);
}

.portfolio-tab-switcher.show-stocks .portfolio-tab-glider {
    transform: translateX(100%);
}

body.dark-mode .portfolio-tab-glider {
    background: #38BDF8;
}

.portfolio-tab-btn {
    flex: 1;
    position: relative;
    z-index: 2;
    padding: 14px 20px;
    background: transparent;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.portfolio-tab-btn.active {
    color: white;
}

body.dark-mode .portfolio-tab-btn.active {
    color: #0F172A;
}

/* === Скрытие/показ контента вкладок === */
.portfolio-tab-content {
    display: none;
}

.portfolio-tab-content.active {
    display: block;
}

/* === Список ОФЗ в стиле Aurora === */
.portfolio-ofz-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.portfolio-ofz-item {
    background: var(--card-glass-aurora);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--card-border-aurora);
    border-radius: 16px;
    box-shadow: var(--shadow-luxury);
    transition: all 0.2s ease;
    overflow: hidden;
}

body.dark-mode .portfolio-ofz-item {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.08);
}

.portfolio-ofz-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px -8px rgba(15, 23, 42, 0.12);
}

.portfolio-ofz-summary {
    display: grid;
    grid-template-columns: 1fr 60px 50px 70px;
    align-items: center;
    gap: 8px;
    padding: 14px 16px;
    cursor: pointer;
    user-select: none;
}

.portfolio-ofz-name {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-deep);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.portfolio-ofz-yield {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: #10B981;
    text-align: center;
}

.portfolio-ofz-qty {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-slate);
    text-align: center;
}

.portfolio-ofz-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-deep);
    text-align: right;
}

/* Детали ОФЗ при раскрытии */
.portfolio-ofz-details {
    display: none;
    padding: 0 16px 16px;
}

.portfolio-ofz-item.expanded .portfolio-ofz-details {
    display: block;
    animation: accordionOpen 0.3s ease;
}

.portfolio-ofz-details-grid {
    display: flex;
    flex-direction: column;
    gap: 0;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 12px;
    overflow: hidden;
}

body.dark-mode .portfolio-ofz-details-grid {
    background: rgba(255, 255, 255, 0.03);
}

.portfolio-ofz-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
}

body.dark-mode .portfolio-ofz-detail-row {
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

.portfolio-ofz-detail-row:last-child {
    border-bottom: none;
}

.portfolio-ofz-detail-label {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-slate);
}

.portfolio-ofz-detail-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-deep);
}

/* Стили для копирования кода в портфеле */
#screen-portfolio .ofz-copy-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 4px 10px;
    background: rgba(59, 130, 246, 0.08);
    border-radius: 6px;
    transition: all 0.2s ease;
}

#screen-portfolio .ofz-copy-wrapper:hover {
    background: rgba(59, 130, 246, 0.15);
}

#screen-portfolio .ofz-copy-code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-blue);
}

#screen-portfolio .ofz-copy-icon {
    width: 14px;
    height: 14px;
    stroke: var(--accent-blue);
    opacity: 0.7;
}

/* Кнопка графика в портфеле */
#screen-portfolio .ofz-aurora-chart-btn {
    margin-top: 12px;
    padding: 14px;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border: none;
    border-radius: 12px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
}

#screen-portfolio .ofz-aurora-chart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
}

#screen-portfolio .ofz-aurora-chart-btn:active {
    transform: scale(0.98);
}

#screen-portfolio .ofz-aurora-chart-btn svg {
    width: 16px;
    height: 16px;
}

/* Заголовки списка ОФЗ */
.portfolio-list-headers {
    display: grid;
    grid-template-columns: 1fr 60px 50px 70px;
    align-items: center;
    gap: 8px;
    padding: 0 16px 12px;
    margin-bottom: 0;
}

.portfolio-list-header-text {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    color: var(--text-deep);
    opacity: 0.5;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.portfolio-list-header-text.center {
    text-align: center;
}

.portfolio-list-header-text.right {
    text-align: right;
}

/* === Купонный дождь в стиле Aurora === */
.portfolio-coupon-card {
    background: var(--card-glass-aurora);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(94, 123, 163, 0.3);
    border-radius: 20px;
    overflow: hidden;
    margin: 20px 0;
}

/* Анимация дыхания рамки когда свернуто */
.portfolio-coupon-card:not(.open) {
    animation: couponBorderBreathe 3s ease-in-out infinite;
}

@keyframes couponBorderBreathe {
    0%, 100% { border-color: rgba(94, 123, 163, 0.3); }
    50% { border-color: rgba(59, 130, 246, 0.4); }
}

.portfolio-coupon-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    background: rgba(94, 123, 163, 0.08);
    cursor: pointer;
    transition: background 0.2s ease;
}

.portfolio-coupon-header:hover {
    background: rgba(94, 123, 163, 0.12);
}

.portfolio-coupon-header-left {
    display: flex;
    align-items: center;
    gap: 14px;
}

.portfolio-coupon-icon {
    width: 44px;
    height: 44px;
    min-width: 44px;
    border-radius: 14px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
    border: 1px solid rgba(59, 130, 246, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Пульсация иконки когда свернуто */
.portfolio-coupon-card:not(.open) .portfolio-coupon-icon {
    animation: couponIconPulse 2s ease-in-out infinite;
}

@keyframes couponIconPulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
    }
    50% { 
        transform: scale(1.02);
        box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.15);
    }
}

.portfolio-coupon-icon svg {
    width: 22px;
    height: 22px;
    color: #3b82f6;
}

.portfolio-coupon-title-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.portfolio-coupon-title {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--text-deep);
}

.portfolio-coupon-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--text-slate);
}

.portfolio-coupon-arrow {
    width: 24px;
    height: 24px;
    color: #5E7BA3;
    transition: transform 0.3s ease;
}

.portfolio-coupon-card.open .portfolio-coupon-arrow {
    transform: rotate(180deg);
}

.portfolio-coupon-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    padding: 0 20px;
}

.portfolio-coupon-card.open .portfolio-coupon-content {
    max-height: 1000px;
    padding: 0 20px 20px;
}

/* === Блок Важно в стиле Aurora === */
.portfolio-important-card {
    background: linear-gradient(135deg, rgba(46, 139, 87, 0.08), rgba(46, 139, 87, 0.03));
    border: 1px solid rgba(46, 139, 87, 0.15);
    border-left: 4px solid #2E8B57;
    border-radius: 16px;
    padding: 20px;
    margin: 24px 0;
}

.portfolio-important-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.portfolio-important-header svg {
    width: 20px;
    height: 20px;
    stroke: #2E8B57;
}

.portfolio-important-title {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: #2E8B57;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.portfolio-important-text {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-deep);
}

/* === Заглушка для Активов === */
.portfolio-assets-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    text-align: center;
    padding: 40px 20px;
}

.placeholder-icon {
    width: 80px;
    height: 80px;
    border-radius: 24px;
    background: var(--card-glass-aurora);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    border: 1px solid var(--card-border-aurora);
}

.placeholder-icon svg {
    width: 40px;
    height: 40px;
    stroke: var(--text-slate);
}

.placeholder-title {
    font-family: 'Inter', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-deep);
    margin-bottom: 8px;
}

.placeholder-text {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--text-slate);
    line-height: 1.5;
    max-width: 280px;
}

/* === Контент страниц портфеля === */
.portfolio-page-content {
    display: none;
}

.portfolio-page-content.active {
    display: block;
}

/* === Заголовки таблицы эшелонов (как в Ребалансировке) === */
.portfolio-echelons-headers {
    display: flex;
    align-items: center;
    justify-content: space-between;
    
    /* Отступы — padding-right: 16px + 20px(стрелка) + 8px(gap) = 44px */
    padding: 0 44px 0 16px;       
    margin-top: 24px;      
    margin-bottom: 12px;   
    height: 24px; 
}

/* === 2. ОБЩИЙ СТИЛЬ ТЕКСТА (ИСПРАВЛЕН ЦВЕТ) === */
.portfolio-echelon-h-text {
    font-family: 'Inter', sans-serif; 
    font-size: 11px;
    font-weight: 600;              
    letter-spacing: 0.05em;        
    text-transform: uppercase;     
    
    /* ВАЖНО: Меняем цвет на переменную темы */
    color: var(--text-secondary, #9ca3af); /* Если переменной нет, будет красивый серый #9ca3af */
    
    /* Сброс стилей */
    background: transparent;
    border: none;
    padding: 0;
    
    display: flex;
    align-items: center;
    height: 100%;
}
/* === 3. НАСТРОЙКИ СТОЛБЦОВ === */

/* ЭШЕЛОН + ? */
.portfolio-echelon-h-text:nth-child(1) {
    justify-content: flex-start; 
    gap: 6px;                    
    padding-left: 28px; /* 16px padding echelon + 12px gap = 28px — центр иконки и текста */
    flex: 1;
}
/* Стиль кнопки "?" (Элегантный стиль в тон дизайну) */
.h-help-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Размеры кружка */
    width: 18px; 
    height: 18px;
    
    /* ОФОРМЛЕНИЕ: Тонкий нейтральный стиль */
    background: rgba(0, 0, 0, 0.06);
    color: rgba(100, 116, 139, 0.7);
    border: 1px solid rgba(0, 0, 0, 0.1);
    
    /* Форма */
    border-radius: 50%;
    
    /* Шрифт */
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
    animation: helpPulse 3s ease-in-out infinite;
}

@keyframes helpPulse {
    0%, 100% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.08); opacity: 1; }
}

/* Усиленная анимация для ? кнопок — привлекает внимание */
.h-help-animated {
    animation: helpAttention 3s ease-in-out infinite !important;
    position: relative;
}

@keyframes helpAttention {
    0%, 100% { transform: scale(1); opacity: 0.6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    15% { transform: scale(1.15); opacity: 1; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
    30% { transform: scale(1); opacity: 0.8; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    45% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
    60% { transform: scale(1); opacity: 0.6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

.h-help-animated:hover,
.h-help-animated:active {
    animation: none !important;
    transform: scale(1.15);
    opacity: 1;
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.3);
    color: #3B82F6;
}

body.dark-mode .h-help-animated:hover,
body.dark-mode .h-help-animated:active {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.35);
    color: #60A5FA;
}

/* Эффект при наведении */
.h-help-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    color: rgba(15, 23, 42, 0.8);
    border-color: rgba(0, 0, 0, 0.15);
    animation: none;
    transform: scale(1.1);
}

/* Эффект при нажатии */
.h-help-btn:active {
    transform: scale(0.95);
    animation: none;
}

/* Темная тема (Dark Mode) */
body.dark-mode .h-help-btn {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.12);
    color: rgba(148, 163, 184, 0.6);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
}
body.dark-mode .h-help-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    color: rgba(241, 245, 249, 0.85);
    border-color: rgba(255, 255, 255, 0.2);
}
/* ВЫДЕЛИТЬ */
.portfolio-echelon-h-text:nth-child(2) {
    justify-content: center; 
}

/* % */
.portfolio-echelon-h-text:nth-child(3) {
    justify-content: center; 
    cursor: pointer;
    transition: color 0.2s ease;
    gap: 6px;
    background: transparent !important;
    border: none !important;
}

/* === СТИЛЬ КНОПКИ ВОПРОСА (?) === */
/* Ховеры для кнопки % — убираем фон, оставляем только на h-help-btn */
.portfolio-echelon-h-text:nth-child(3):hover {
    background: transparent !important;
    transform: none;
}
.portfolio-echelon-h-text:nth-child(3):active {
    background: transparent !important;
    color: inherit;
}

/* === АДАПТАЦИЯ ДЛЯ ТЕМНОЙ ТЕМЫ === */
body.dark-mode .portfolio-echelon-h-text:nth-child(3) {
    background: transparent !important;
    border: none !important;
    color: var(--text-secondary);
}

body.dark-mode .portfolio-echelon-h-text:nth-child(3):hover {
    background: transparent !important;
    border: none !important;
    color: var(--text-secondary);
}

/* Подсказка для % - убираем */
.echelon-percent-help {
    display: none;
    margin: 0 16px 16px;
    padding: 12px 16px;
    background: rgba(59, 130, 246, 0.08);
    border: 1px solid rgba(59, 130, 246, 0.15);
    border-radius: 12px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-deep);
    line-height: 1.5;
    animation: fadeInSlide 0.3s ease;
}

.echelon-percent-help.show {
    display: block;
}

@keyframes fadeInSlide {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* === Информационная панель эшелонов === */
.echelons-info-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
}

.echelons-info-panel.show {
    max-height: 300px;
}

.echelons-info-content {
    margin: 0 16px 20px;
    padding: 16px;
    background: var(--card-glass-aurora);
    backdrop-filter: blur(10px);
    border: 1px solid var(--card-border-aurora);
    border-radius: 16px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    color: var(--text-deep);
    line-height: 1.6;
}

.echelons-info-content p {
    margin: 0 0 8px;
}

.echelons-info-content p:last-child {
    margin-bottom: 0;
}

/* === Раскрывающийся блок ЭШЕЛОНЫ (как в Ребалансировке) === */
.echelons-explainer-card {
    background: var(--card-glass-aurora);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--card-border-aurora);
    border-radius: 16px;
    margin: 20px 0;
    overflow: hidden;
}

.echelons-explainer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.echelons-explainer-header:hover {
    background: rgba(0, 0, 0, 0.02);
}

body.dark-mode .echelons-explainer-header:hover {
    background: rgba(255, 255, 255, 0.03);
}

.echelons-explainer-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.echelons-explainer-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 10px;
}

.echelons-explainer-icon svg {
    width: 18px;
    height: 18px;
    stroke: var(--accent-blue);
}

.echelons-explainer-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-deep);
}

.echelons-explainer-arrow {
    width: 20px;
    height: 20px;
    stroke: var(--text-slate);
    transition: transform 0.3s ease;
}

.echelons-explainer-card.open .echelons-explainer-arrow {
    transform: rotate(180deg);
}

.echelons-explainer-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
}

.echelons-explainer-card.open .echelons-explainer-content {
    max-height: 400px;
}

/* Элемент объяснения эшелона */
.echelon-explain-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
}

body.dark-mode .echelon-explain-item {
    border-top-color: rgba(255, 255, 255, 0.05);
}

.echelon-explain-badge {
    width: 28px;
    height: 28px;
    min-width: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 800;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0,0,0,0.1);
}

.echelon-explain-badge.e1 {
    color: #27ae60;
    border-color: #2ecc71;
}

.echelon-explain-badge.e2 {
    color: #2980b9;
    border-color: #3498db;
}

.echelon-explain-badge.e3 {
    color: #f39c12;
    border-color: #f1c40f;
}

.echelon-explain-badge.e4 {
    color: #d35400;
    border-color: #e67e22;
}

body.dark-mode .echelon-explain-badge {
    background: rgba(30, 41, 59, 0.9);
}

.echelon-explain-text {
    flex: 1;
}

.echelon-explain-name {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text-deep);
    margin-bottom: 2px;
}

.echelon-explain-desc {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-slate);
    line-height: 1.4;
}

/* === Блок Важно - Aurora Design с маркером === */
.portfolio-important-aurora {
    display: flex;
    gap: 14px;
    margin: 24px 0;
    padding: 18px;
    background: var(--card-glass-aurora);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(251, 191, 36, 0.2);
    border-radius: 16px;
}

.important-aurora-icon {
    width: 40px;
    height: 40px;
    min-width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(251, 191, 36, 0.15);
    border: 1px solid rgba(251, 191, 36, 0.25);
    border-radius: 12px;
}

.important-aurora-icon svg {
    width: 20px;
    height: 20px;
    stroke: #F59E0B;
}

.important-aurora-content {
    flex: 1;
}

.important-aurora-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-deep);
    margin-bottom: 6px;
}

.important-aurora-text {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    color: var(--text-slate);
    line-height: 1.5;
}

.important-aurora-text strong {
    color: var(--text-deep);
}

/* Выделение маркером */
.important-aurora-text .highlight-marker {
    background: linear-gradient(120deg, rgba(251, 191, 36, 0.3) 0%, rgba(251, 191, 36, 0.3) 100%);
    background-repeat: no-repeat;
    background-size: 100% 40%;
    background-position: 0 85%;
    padding: 0 2px;
    font-weight: 700;
    color: var(--text-deep);
}

/* === Динамические столбцы для ОФЗ === */
.portfolio-ofz-summary {
    display: grid;
    grid-template-columns: 1fr 50px 55px 90px;
    gap: 16px;
    align-items: center;
}

.portfolio-ofz-name {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-deep);
    /* Полное отображение названия */
    white-space: nowrap;
    word-break: break-word;
    line-height: 1.3;
}

/* Цифры в названии ОФЗ - моноширинный шрифт */
.portfolio-ofz-name .ofz-number {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    letter-spacing: -0.02em;
}

.portfolio-ofz-yield {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--accent-green);
    white-space: nowrap;
    text-align: center;
}

.portfolio-ofz-qty {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-slate);
    white-space: nowrap;
    text-align: right;
}

.portfolio-ofz-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-deep);
    white-space: nowrap;
    text-align: right;
}

/* Заголовки списка ОФЗ */
.portfolio-list-headers {
    display: grid;
    grid-template-columns: 1fr 50px 55px 90px;
    gap: 16px;
    padding: 8px 16px;
    margin-bottom: 8px;
}

.portfolio-list-header-text {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-slate);
}

.portfolio-list-header-text.center {
    text-align: center;
}

.portfolio-list-header-text.right {
    text-align: right;
}

.portfolio-list-header-text.clickable {
    cursor: pointer;
    transition: color 0.2s;
}

.portfolio-list-header-text.clickable:hover {
    color: var(--accent-blue);
}

/* Подсказка для % (Простая доходность) */
.yield-help-tooltip {
    display: none;
    margin: 0 16px 16px;
    padding: 14px 16px;
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    animation: fadeInSlide 0.3s ease;
}

.yield-help-tooltip.show {
    display: block;
}

.yield-help-title {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: #F1F5F9;
    margin-bottom: 6px;
}

.yield-help-text {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: rgba(148, 163, 184, 0.9);
    line-height: 1.5;
}

/* Подсказка для % эшелонов */
.echelon-percent-tooltip {
    display: none;
    margin: 0 16px 16px;
    padding: 14px 16px;
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: rgba(148, 163, 184, 0.9);
    line-height: 1.5;
    animation: fadeInSlide 0.3s ease;
}

.echelon-percent-tooltip.show {
    display: block;
}

/* === Action Panel V2 === */
.portfolio-action-panel-v2 {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    width: 92%;
    max-width: 400px;
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 12px;
    background: var(--card-glass-aurora);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--card-border-aurora);
    border-radius: 20px;
    box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
    z-index: 800;
}

.portfolio-action-btn {
    flex: 1;
    max-width: 160px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 16px;
    border: none;
    border-radius: 14px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
}

.portfolio-action-btn.primary {
    background: linear-gradient(135deg, #2C364C, #3a4a66);
    color: white;
    box-shadow: 0 4px 15px rgba(44, 54, 76, 0.3);
}

.portfolio-action-btn.primary:hover {
    box-shadow: 0 6px 20px rgba(44, 54, 76, 0.4);
    transform: translateY(-1px);
}

.portfolio-action-btn.primary:active {
    transform: scale(0.97);
    box-shadow: 0 2px 10px rgba(44, 54, 76, 0.3);
}

.portfolio-action-btn.secondary {
    background: rgba(255, 255, 255, 0.9);
    color: var(--text-deep);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.portfolio-action-btn.secondary:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
}

.portfolio-action-btn.secondary:active {
    transform: scale(0.97);
}

body.dark-mode .portfolio-action-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.15);
    color: white;
}

body.dark-mode .portfolio-action-btn.secondary:hover {
    background: rgba(255, 255, 255, 0.15);
}

.portfolio-action-btn svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    flex-shrink: 0;
}

/* === Эшелоны в портфеле - стиль Aurora === */
.portfolio-echelon-card {
    background: var(--card-glass-aurora);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--card-border-aurora);
    border-radius: 16px;
    margin-bottom: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.portfolio-echelon-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
}

body.dark-mode .portfolio-echelon-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.08);
}

.portfolio-echelon-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.portfolio-echelon-header:hover {
    background: rgba(0, 0, 0, 0.02);
}

body.dark-mode .portfolio-echelon-header:hover {
    background: rgba(255, 255, 255, 0.03);
}

.portfolio-echelon-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Номер эшелона - белые как в Ребалансировке */
.portfolio-echelon-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 800;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.portfolio-echelon-number.e1 {
    color: #27ae60;
    border-color: #2ecc71;
    box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2);
}

.portfolio-echelon-number.e2 {
    color: #2980b9;
    border-color: #3498db;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
}

.portfolio-echelon-number.e3 {
    color: #f39c12;
    border-color: #f1c40f;
    box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2);
}

.portfolio-echelon-number.e4 {
    color: #d35400;
    border-color: #e67e22;
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
}

body.dark-mode .portfolio-echelon-number {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(255, 255, 255, 0.1);
}

.portfolio-echelon-title {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-deep);
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.portfolio-echelon-header-right {
    display: grid;
    grid-template-columns: auto auto 20px;
    gap: 8px;
    align-items: center;
}

.portfolio-echelon-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-deep);
    text-align: right;
    white-space: nowrap;
}

.portfolio-echelon-percent {
    padding: 3px 8px;
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    background: rgba(0, 0, 0, 0.05);
    color: var(--text-slate);
    text-align: center;
    white-space: nowrap;
}

body.dark-mode .portfolio-echelon-percent {
    background: rgba(255, 255, 255, 0.1);
}

.portfolio-echelon-arrow {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    color: var(--text-slate);
    transition: transform 0.3s ease;
}

.portfolio-echelon-card.expanded .portfolio-echelon-arrow {
    transform: rotate(180deg);
}

.portfolio-echelon-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
}

.portfolio-echelon-card.expanded .portfolio-echelon-content {
    max-height: 2000px;
}

/* Заголовки столбцов - впечатаны в фон */
.portfolio-echelon-columns-header {
    display: grid;
    grid-template-columns: 1fr 75px 55px 90px;
    gap: 16px;
    padding: 10px 16px;
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-slate);
}

.portfolio-echelon-columns-header span:nth-child(2) {
    text-align: center;
}

.portfolio-echelon-columns-header span:nth-child(3),
.portfolio-echelon-columns-header span:nth-child(4) {
    text-align: right;
}

.portfolio-echelon-list {
    padding: 0 16px 16px;
}

/* Строка акции с подстроками */
.portfolio-stock-wrapper {
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
}

body.dark-mode .portfolio-stock-wrapper {
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

.portfolio-stock-wrapper:last-child {
    border-bottom: none;
}

.portfolio-stock-item {
    display: grid;
    grid-template-columns: 1fr 75px 55px 90px;
    align-items: center;
    gap: 16px;
    padding: 12px 0;
    cursor: pointer;
    transition: background 0.2s ease;
}

.portfolio-stock-item:hover {
    background: rgba(0, 0, 0, 0.02);
}

body.dark-mode .portfolio-stock-item:hover {
    background: rgba(255, 255, 255, 0.02);
}

.portfolio-stock-ticker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--text-deep);
}

.portfolio-stock-yield {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-green);
    text-align: center;
}

.portfolio-stock-qty {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-slate);
    text-align: right;
    white-space: nowrap;
}

.portfolio-stock-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-deep);
    text-align: right;
    white-space: nowrap;
}

/* Подстрока деталей акции */
.portfolio-stock-details {
    display: none;
    padding: 0 0 12px;
    animation: fadeInSlide 0.3s ease;
}

.portfolio-stock-wrapper.expanded .portfolio-stock-details {
    display: block;
}

.portfolio-stock-detail-grid {
    display: flex;
    flex-direction: column;
    gap: 0;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 10px;
}

body.dark-mode .portfolio-stock-detail-grid {
    background: rgba(255, 255, 255, 0.03);
}

.portfolio-stock-detail-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
}

body.dark-mode .portfolio-stock-detail-row {
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

.portfolio-stock-detail-row:last-child {
    border-bottom: none;
}

.portfolio-stock-detail-label {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-slate);
}

.portfolio-stock-detail-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-deep);
}

/* Кнопки График и О компании */
.portfolio-stock-buttons {
    display: flex;
    gap: 8px;
}

.portfolio-stock-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.portfolio-stock-btn.chart {
    background: linear-gradient(135deg, #1e293b, #0f172a);
    color: white;
}

.portfolio-stock-btn.info {
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent-blue);
    border: 1px solid rgba(59, 130, 246, 0.2);
}

.portfolio-stock-btn:active {
    transform: scale(0.97);
}

.portfolio-stock-btn svg {
    width: 14px;
    height: 14px;
}

.portfolio-stock-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-deep);
    text-align: right;
}

/* Заголовки столбцов эшелонов */
.portfolio-echelon-columns-header {
    display: grid;
    grid-template-columns: 1fr 75px 55px 90px;
    gap: 16px;
    padding: 8px 16px;
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-slate);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    opacity: 0.7;
}

body.dark-mode .portfolio-echelon-columns-header {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

.portfolio-echelon-columns-header span:nth-child(2) {
    text-align: center;
}

.portfolio-echelon-columns-header span:nth-child(3),
.portfolio-echelon-columns-header span:nth-child(4) {
    text-align: right;
}

/* === Основной контейнер экрана Портфель === */
#screen-portfolio {
    position: relative;
    background: var(--bg-base);
    min-height: 100vh;
    margin: -16px;
    padding: 20px 16px 140px 16px;
}

/* === Заголовок Портфель с меню три точки === */
.portfolio-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    padding: 10px 0 20px;
    padding-top: calc(80px + env(safe-area-inset-top));
    z-index: 10;
}

@supports not (padding-top: env(safe-area-inset-top)) {
    .portfolio-header-row { padding-top: 50px; }
}

.portfolio-header-row h1 {
    font-family: 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 700;
    letter-spacing: -0.03em;
    color: var(--text-deep);
    margin: 0;
}

.portfolio-dots-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 12px;
    color: var(--text-slate, #64748B);
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
}
.portfolio-dots-btn.hint-animate {
    animation: bentoHint 3s ease-in-out 2;
}
@keyframes bentoHint {
    0%, 100% { transform: rotate(0deg); }
    20% { transform: rotate(-8deg); }
    40% { transform: rotate(8deg); }
    60% { transform: rotate(-4deg); }
    80% { transform: rotate(0deg); }
}
.portfolio-dots-btn svg {
    width: 18px;
    height: 18px;
}
.portfolio-dots-btn:active {
    transform: scale(0.92);
    background: rgba(255, 255, 255, 0.7);
}

body.dark-mode .portfolio-dots-btn {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
    color: var(--text-slate);
}

/* === 3 Action Buttons === */
.portfolio-action-btns {
    display: flex;
    align-items: flex-start;
    gap: 6px;
}

.portfolio-action-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.portfolio-action-icon-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 12px;
    color: var(--text-slate, #64748B);
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
}

.portfolio-action-icon-btn.active-hint {
    background: rgba(255, 255, 255, 0.75);
    border-color: rgba(59, 130, 246, 0.3);
    color: #3B82F6;
    transform: scale(1.05);
}

.portfolio-action-icon-btn svg {
    width: 17px;
    height: 17px;
}

.portfolio-action-icon-btn:active {
    transform: scale(0.92);
}

.portfolio-action-label {
    position: absolute;
    top: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%) translateY(-4px);
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-deep, #0F172A);
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    padding: 8px 14px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    z-index: 50;
}

.portfolio-action-wrapper.show-label .portfolio-action-label {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
}

body.dark-mode .portfolio-action-icon-btn {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
    color: var(--text-slate);
}

body.dark-mode .portfolio-action-icon-btn.active-hint {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.3);
    color: #60A5FA;
}

body.dark-mode .portfolio-action-icon-btn:active {
    background: rgba(30, 41, 59, 0.8);
}

body.dark-mode .portfolio-action-label {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(255, 255, 255, 0.12);
    color: #E2E8F0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Выпадающее меню */
.portfolio-dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    min-width: 200px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.7);
    border-radius: 16px;
    padding: 6px;
    box-shadow: 0 12px 40px -8px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.05);
    z-index: 1000;
    opacity: 0;
    transform: translateY(-8px) scale(0.95);
    pointer-events: none;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}
.portfolio-dropdown-menu.open {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

body.dark-mode .portfolio-dropdown-menu {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 12px 40px -8px rgba(0, 0, 0, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.2);
}

.portfolio-dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-deep, #0F172A);
    -webkit-tap-highlight-color: transparent;
}
.portfolio-dropdown-item svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    flex-shrink: 0;
    opacity: 0.6;
}
.portfolio-dropdown-item:hover {
    background: rgba(0, 0, 0, 0.04);
}
.portfolio-dropdown-item:active {
    background: rgba(0, 0, 0, 0.08);
    transform: scale(0.98);
}

body.dark-mode .portfolio-dropdown-item {
    color: #f1f5f9;
}
body.dark-mode .portfolio-dropdown-item:hover {
    background: rgba(255, 255, 255, 0.06);
}

.portfolio-dropdown-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.08), transparent);
    margin: 2px 12px;
}
body.dark-mode .portfolio-dropdown-divider {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
}

body.dark-mode #screen-portfolio {
    background: var(--bg-base);
}

#screen-portfolio > *:not(.aurora-container):not(.noise-overlay):not(.portfolio-header-row) {
    position: relative;
    z-index: 2;
}
#screen-portfolio > .portfolio-header-row {
    position: relative;
    z-index: 100;
}

/* === Заголовок экрана === */
#screen-portfolio .header {
    padding: 10px 0 25px;
    text-align: left;
}

#screen-portfolio .header h1 {
    font-family: 'Inter', sans-serif;
    font-size: 38px;
    font-weight: 700;
    letter-spacing: -0.04em;
    color: var(--claude-text-primary);
    margin: 0;
}




/* === Section Headers (Заголовки разделов) === */
.portfolio-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    margin: 24px 0 12px;
    background: var(--claude-glass);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.portfolio-section-header:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
}

.portfolio-section-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.portfolio-section-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

/* 1. Скрываем иконку (щит) только для раздела Облигаций (Денежный поток) */
.portfolio-section-icon.bonds {
    display: none !important;
}


.portfolio-section-icon.stocks {
    background: rgba(46, 139, 87, 0.15);
}

.portfolio-section-title {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--claude-text-primary);
}

.portfolio-section-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--claude-text-secondary);
    margin-top: 2px;
}

.portfolio-section-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 20px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
}

.portfolio-section-badge.bonds {
    background: rgba(94, 123, 163, 0.12);
    color: #5E7BA3;
}

.portfolio-section-badge.stocks {
    background: rgba(46, 139, 87, 0.12);
    color: #2E8B57;
}

/* === Accordion Lists (Интерактивные списки) === */
.portfolio-list {
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 16px;
}

.portfolio-list-item {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: background 0.2s ease;
}

body.dark-mode .portfolio-list-item {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

.portfolio-list-item:last-child {
    border-bottom: none;
}

.portfolio-list-item:hover {
    background: rgba(255, 255, 255, 0.3);
}

body.dark-mode .portfolio-list-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* Свёрнутая строка */
.list-item-summary {
    display: grid;
    /* Grid-шаблон по промту: 85px, гибкая, 75px, 80px */
    grid-template-columns: 85px 1fr 75px 80px;
    align-items: center;
    gap: 0; /* Убираем gap, так как ширину задаем колонками */
    padding: 12px; /* Отступы по промту */
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.list-item-ticker {
    font-family: 'Inter', sans-serif;
    font-size: 14px; /* По промту */
    font-weight: 700; /* Bold */
    color: var(--claude-text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Троеточие */
    text-align: left;
}

.list-item-yield {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 8px; /* Внутренние отступы */
    border-radius: 8px; /* Скругление */
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; /* По промту */
    font-weight: 800; /* Extra Bold */
    justify-self: center; /* Центрирование внутри grid-ячейки */
    width: fit-content;
}

.list-item-yield.bonds {
    background: rgba(94, 123, 163, 0.15);
    color: #5E7BA3;
}

.list-item-yield.stocks {
    background: rgba(46, 139, 87, 0.15);
    color: #2E8B57;
}

.list-item-qty {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 700; /* Bold */
    color: var(--claude-accent);
    text-align: right;
    padding-right: 8px; /* Отступ справа */
}

.list-item-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 500; /* Medium */
    color: var(--claude-text-primary);
    text-align: right;
}
/* Развёрнутая детальная карточка */
.list-item-details {
            grid-column: 1 / -1; /* Занимает всю ширину */
            display: none;
            padding: 12px !important; /* Отступ 12px */
            border-top: 1px solid rgba(0,0,0,0.05) !important; /* Линия сверху */
            font-size: 11px !important;
            line-height: 1.8 !important;
            animation: slideDown 0.3s ease;
            cursor: default; /* Чтобы клик по деталям не сворачивал их случайно */
        }
body.dark-mode .list-item-details {
    background: rgba(255, 255, 255, 0.03);
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.portfolio-list-item.expanded .list-item-details {
    display: block;
}

.details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

 /* Строка данных */
        .details-row {
            display: flex !important;
            justify-content: space-between !important;
            padding: 2px 0 !important; /* Вертикальный отступ */
            border-bottom: 1px dashed rgba(0,0,0,0.05) !important; /* Пунктир снизу */
            background: transparent !important; /* Убираем фон */
            border-radius: 0 !important;
        }

body.dark-mode .details-row {
    background: rgba(255, 255, 255, 0.05);
}

/* Левая часть (Метка) */
        .details-row-label {
            font-family: 'Inter', sans-serif;
            font-weight: 400 !important; /* Обычное начертание */
            color: var(--claude-text-secondary);
        }

/* Правая часть (Значение) */
        .details-row-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600 !important; /* Semi-Bold */
            color: var(--claude-text-primary);
            text-align: right;
        }

.details-actions {
    display: flex;
    gap: 10px;
}

/* Кнопка действия */
        .details-btn {
            width: 100% !important;
            margin-top: 8px !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            font-size: 10px !important;
            font-weight: 700 !important; /* Bold */
            border: none !important;
            cursor: pointer;
            transition: opacity 0.2s;
            
            /* Цвета берем из переменных, не меняем жестко */
            background: var(--claude-accent) !important; 
            color: white !important;
        }
        
        .details-btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

.details-btn.primary {
    background: var(--claude-accent);
    color: white;
}

.details-btn.secondary {
    background: rgba(0, 0, 0, 0.05);
    color: var(--claude-text-primary);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

body.dark-mode .details-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.15);
}

.details-btn svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

                /* ========== СТИЛЬ ДЛЯ ПОДСВЕТКИ ТИКЕРА/ISIN ========== */
        .detail-ticker-highlight {
            color: var(--accent-blue) !important;
            font-weight: 700 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: flex-end !important;
            gap: 6px !important;
            cursor: pointer !important;
            transition: opacity 0.2s;
        }
        
        .detail-ticker-highlight:active {
            opacity: 0.6;
            transform: scale(0.98);
        }

        .detail-ticker-highlight svg {
            width: 12px; 
            height: 12px;
            stroke-width: 2.5;
        }
        /* ===================================================== */



/* === Echelon Headers (Заголовки эшелонов) === */
.echelon-header-new {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    margin: 20px 0 8px;
    background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(255,255,255,0.5));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

body.dark-mode .echelon-header-new {
    background: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(30,41,59,0.5));
}

.echelon-header-new:hover {
    transform: translateY(-1px);
}

.echelon-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ========== НОВЫЙ СТИЛЬ ЭШЕЛОНОВ (КАК В РЕБАЛАНСИРОВКЕ) ========== */
        .echelon-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px !important;
            font-weight: 800 !important;
            
            /* Делаем их белыми с рамкой, как "таблетки" в таблице */
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Цвета для каждого эшелона (текст + рамка + тень) */
        .echelon-number.e1 { 
            color: #27ae60 !important; 
            border-color: #2ecc71 !important; 
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2); 
        }
        
        .echelon-number.e2 { 
            color: #2980b9 !important; 
            border-color: #3498db !important; 
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2); 
        }
        
        .echelon-number.e3 { 
            color: #f39c12 !important; /* Желтый потемнее для читаемости */
            border-color: #f1c40f !important; 
            box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2); 
        }
        
        .echelon-number.e4 { 
            color: #d35400 !important; 
            border-color: #e67e22 !important; 
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2); 
        }

        /* Адаптация для темной темы */
        body.dark-mode .echelon-number {
            background: rgba(30, 41, 59, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.1);
        }
        /* ========================================================= */

.echelon-title-new {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--claude-text-primary);
}

* Правый контейнер внутри строки эшелона */
.echelon-header-right {
    display: grid;
    /* ВАЖНО: Ширина колонок один-в-один как в шапке (115px и 60px) */
    grid-template-columns: 115px 60px; 
    gap: 8px; /* Тот же gap, что в шапке */
    align-items: center;
}

/* Сама сумма */
.echelon-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    font-weight: 700;
    color: #fff;
    
    text-align: right;   /* <--- Прижимаем сумму вправо, как вы просили */
    padding-right: 12px; /* <-- ВАЖНО: Сдвигаем цифры от края ближе к центру */
    width: 100%;
    white-space: nowrap; /* Запрет переноса строк */
}

/* Бейдж с процентами */
.echelon-percent-badge {
    /* ... ваши старые настройки шрифта и цвета ... */
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    
    /* ВАЖНОЕ ИЗМЕНЕНИЕ: */
    justify-self: center; /* Было end -> Ставим center */
    
    min-width: 45px;
    text-align: center;
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: var(--text-slate);
}

.echelon-info-icon {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--claude-text-secondary);
    font-size: 12px;
    font-weight: 700;
}

/* Подсказка эшелона */
.echelon-info-tooltip {
    display: none;
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--claude-accent);
    border-radius: 14px;
    padding: 14px 18px;
    margin-bottom: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    line-height: 1.6;
    color: var(--claude-text-primary);
    animation: fadeIn 0.3s ease;
}

.echelon-info-tooltip.show {
    display: block;
}

/* Заголовки столбцов для эшелона */
.echelon-columns-header {
    display: grid;
    /* Сетка должна совпадать со строками: 85px 1fr 75px 80px */
    grid-template-columns: 85px 1fr 75px 80px;
    gap: 0;
    padding: 10px 12px; /* Паддинг как у строк */
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--claude-text-secondary);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

/* Выравнивание заголовков */
.echelon-columns-header span:nth-child(1) { text-align: left; }
.echelon-columns-header span:nth-child(2) { text-align: center; justify-self: center; }
.echelon-columns-header span:nth-child(3) { text-align: right; padding-right: 8px; }
.echelon-columns-header span:nth-child(4) { text-align: right; }

body.dark-mode .echelon-columns-header {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

.echelon-columns-header span:nth-child(2) {
    text-align: center;
}

.echelon-columns-header span:nth-child(3) {
    text-align: right;
    padding-right: 8px;
}

.echelon-columns-header span:last-child {
    text-align: right;
}

/* === Action Panel (Sticky панель действий) === */
        .portfolio-action-panel {
            position: fixed;
            bottom: 90px;
            
            /* ЖЕСТКОЕ ЦЕНТРИРОВАНИЕ */
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 92% !important; /* Ширина 92% от экрана */
            max-width: 400px !important; /* Но не шире 400px */
            right: auto !important; /* Сбрасываем right */
            
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            
            background: var(--claude-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--claude-glass-border);
            border-radius: 20px;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 800;
        }


        .action-btn {
            flex: 0 1 150px; /* Фиксированная ширина вместо растягивания */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px; /* Сделали кнопку тоньше (было 16px) */
            border: none;
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }


.action-btn.primary {
    background: linear-gradient(135deg, #2C364C, #3a4a66);
    color: white;
    box-shadow: 0 4px 15px rgba(44, 54, 76, 0.3);
}

.action-btn.secondary {
    background: rgba(255, 255, 255, 0.8);
    color: var(--claude-text-primary);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

body.dark-mode .action-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.15);
}

.action-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.action-btn:active {
    transform: scale(0.98);
}

/* === Coupon Rain Box (Купонный дождь) - обновлённый стиль === */
.coupon-box-new {
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(94, 123, 163, 0.3);
    border-radius: 20px;
    overflow: hidden;
    margin: 16px 0;
}

.coupon-header-new {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    background: rgba(94, 123, 163, 0.08);
    cursor: pointer;
    transition: background 0.2s ease;
}

.coupon-header-new:hover {
    background: rgba(94, 123, 163, 0.12);
}

.coupon-header-left {
    display: flex;
    align-items: center;
    gap: 14px;
}

.coupon-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    background: linear-gradient(135deg, #5E7BA3, #7B9BBF);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
}

.coupon-title-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.coupon-title-new {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--claude-text-primary);
}

.coupon-subtitle-new {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--claude-text-secondary);
}

.coupon-arrow-new {
    width: 24px;
    height: 24px;
    color: #5E7BA3;
    transition: transform 0.3s ease;
}

.coupon-box-new.open .coupon-arrow-new {
    transform: rotate(180deg);
}

.coupon-content-new {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    padding: 0 20px;
}

.coupon-box-new.open .coupon-content-new {
    max-height: 1000px;
    padding: 0 20px 20px;
}

/* === Footer Disclaimer (обновлённый) === */
.portfolio-disclaimer {
    background: linear-gradient(135deg, rgba(46, 139, 87, 0.08), rgba(46, 139, 87, 0.03));
    border: 1px solid rgba(46, 139, 87, 0.15);
    border-left: 4px solid #2E8B57;
    border-radius: 16px;
    padding: 20px;
    margin: 24px 0;
}

.disclaimer-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.disclaimer-header svg {
    width: 20px;
    height: 20px;
    stroke: #2E8B57;
}

.disclaimer-title {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: #2E8B57;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.disclaimer-text {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    line-height: 1.6;
    color: var(--claude-text-primary);
}

/* === Empty State === */
.portfolio-empty-new {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    text-align: center;
    padding: 40px 20px;
}

.empty-icon {
    width: 80px;
    height: 80px;
    border-radius: 24px;
    background: var(--claude-glass);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin-bottom: 24px;
    border: 1px solid var(--claude-glass-border);
}

.empty-title {
    font-family: 'Inter', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--claude-text-primary);
    margin-bottom: 8px;
}

.empty-text {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--claude-text-secondary);
    line-height: 1.6;
    margin-bottom: 24px;
}

.empty-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 32px;
    background: linear-gradient(135deg, #2C364C, #3a4a66);
    color: white;
    border: none;
    border-radius: 14px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(44, 54, 76, 0.3);
    transition: all 0.2s ease;
}

.empty-btn:active {
    transform: scale(0.98);
}

.empty-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
}
        /* =========================================
   ГЛОБАЛЬНЫЙ СТИЛЬ ДЛЯ ЦИФР (JetBrains Mono)
   ========================================= */

/* 1. Поля ввода */
input, 
.calc-input,
textarea {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 2. Рыночные данные и дашборд (Интересное) */
.mk-val, 
.mk-dynamics,
.market-tile-value,
.market-tile-change,
.rv-item b,
.rate-row-value,
.rate-item-glass b {
    font-family: 'JetBrains Mono', monospace !important;
    letter-spacing: -0.03em;
}

/* 3. Калькулятор и Стратегии */
.strategy-percent-row,
.custom-value-bonds,
.custom-value-stocks,
.custom-slider-label span, /* проценты в слайдере */
.fee-item-rate,
.fee-selected-text:not(.placeholder), /* выбранная комиссия */
#sumInput,
#monthlySumInput,
.currency {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 4. Портфель: Главная карточка и Прогноз */
.portfolio-card-value,
.portfolio-fee-badge,
.forecast-item-value,
.forecast-total-value,
.portfolio-section-badge,
#summ-invested,
#summ-total-3y,
#summ-bond-income,
#summ-stock-growth {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 5. Списки (Облигации, Акции, Купоны) */
.list-item-yield,
.list-item-qty,
.list-item-sum,
.details-row-value,
.ofz-price,
.ofz-nkd-badge,
.ofz-yield-badge,
.ofz-detail-val,
.ub-yield,
.ub-price,
.echelon-sum,
.echelon-percent-badge,
.et-price,
.et-detail-value,
.et-target {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 6. Таблицы (Купонный дождь, Выплаты) */
.coupon-row b,
.coupon-row div:nth-child(3), /* Колонка количества */
.coupon-row div:nth-child(4), /* Колонка суммы */
#couponTotalHeader,
.echelon-number {
    font-family: 'JetBrains Mono', monospace !important;
}



        /* ===== PORTFOLIO MAIN CARD - ORIGINAL DESIGN ===== */
.portfolio-main-card {
    background: var(--card-bg) !important;
    border-radius: 28px !important;
    padding: 0 !important;
    margin-bottom: 20px !important;
    box-shadow: 0 8px 25px var(--card-shadow) !important;
    border: 1px solid var(--border-color) !important;
    overflow: visible !important;
    position: relative !important;
}

.stm-header {
    padding: 24px 20px 10px !important;
    text-align: center !important;
    background: transparent !important;
    display: block !important;
}

.stm-header-label {
    font-size: 10px !important;
    color: var(--text-secondary) !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 1.2px !important;
    margin-bottom: 10px !important;
    display: block !important;
    opacity: 0.7 !important;
}

.stm-val-big {
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 36px !important;
    font-weight: 700 !important;
    color: var(--text-main) !important;
    line-height: 1 !important;
    display: block !important;
    letter-spacing: -0.02em !important;
}

.stm-bar-container {
    display: flex !important;
    height: 8px !important;
    margin: 16px 24px 0 24px !important;
    border-radius: 4px !important;
    overflow: hidden !important;
}


.stm-bar-bonds {
    background: linear-gradient(90deg, #5E7BA3, #7B9BBF) !important;
    transition: width 0.5s ease !important;
}

.stm-bar-stocks {
    background: linear-gradient(90deg, #E8956A, #D97757) !important;
    transition: width 0.5s ease !important;
}

.stm-meta-row {
    padding: 10px 24px 16px !important;
    display: block !important;
}


.stm-pct-labels {
    display: flex !important;
    justify-content: space-between !important;
    font-size: 10px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

.stm-pl-bond {
    color: #5E7BA3 !important;
    display: block !important;
}

.stm-pl-stock {
    color: #D97757 !important;
    display: block !important;
}

.portfolio-forecast {
    background: rgba(46, 139, 87, 0.06) !important;
    border: 1px solid rgba(46, 139, 87, 0.12) !important;
    border-radius: 16px !important;
    padding: 16px !important;
    margin: 0 20px 20px 20px !important;
}

.forecast-title {
    font-family: 'Inter', sans-serif !important;
    font-size: 9px !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.15em !important;
    color: #2E8B57 !important;
    margin-bottom: 12px !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    opacity: 0.8 !important;
}

.forecast-grid {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 16px !important;
    margin-bottom: 14px !important;
}

/* Цифры внутри карточек (Купоны, Переоценка) */
.forecast-item-value {
    font-family: 'JetBrains Mono', monospace !important;
    font-weight: 600 !important;
    margin-bottom: 4px !important;
    letter-spacing: -0.03em !important; /* Чуть сжимаем расстояние между буквами */
    
    /* ДИНАМИЧЕСКИЙ РАЗМЕР: */
    /* Минимум 11px, в идеале 4% от ширины экрана, Максимум 17px */
    font-size: clamp(11px, 4vw, 17px) !important;
    
    /* ЗАПРЕТ ПЕРЕНОСА СТРОК: */
    white-space: nowrap !important; 
    
    /* Если цифра всё равно гигантская, она не вылезет за рамки, а обрежется (опционально) */
    overflow: hidden; 
    text-overflow: clip; 
}

.forecast-item-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;
    color: var(--text-secondary) !important;
    margin-top: 6px !important;
    margin-bottom: 1px !important;
    font-weight: 500 !important;
}

.forecast-item-sub {
    font-family: 'Inter', sans-serif !important;
    font-size: 9px !important;
    color: var(--text-secondary) !important;
    opacity: 0.7 !important;
}

.forecast-total {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding-top: 12px !important;
    border-top: 1px dashed rgba(46, 139, 87, 0.2) !important;
}

.forecast-total-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    color: var(--text-main) !important;
}

/* Итоговая цифра "Цель" */
.forecast-total-value {
    font-family: 'JetBrains Mono', monospace !important;
    font-weight: 800 !important; /* Сделали чуть жирнее */
    color: #2E8B57 !important;
    letter-spacing: -0.03em !important;
    
    /* ДИНАМИЧЕСКИЙ РАЗМЕР: */
    /* Минимум 13px, в идеале 5% от ширины экрана, Максимум 20px */
    font-size: clamp(13px, 5vw, 20px) !important;
    
    white-space: nowrap !important;
}

                /* ========== НОВЫЕ СТИЛИ ДЛЯ ГЛАВНОЙ СТРАНИЦЫ (ВШИТОЕ МЕНЮ) ========== */

         body.home-mode {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden !important;
            padding: 0 !important; 
            margin: 0 !important;
            background: transparent !important; /* На всякий случай убираем фон у body */
        }

        /* Исправление белой полосы тут: min-height: 100vh */
        body.home-mode .welcome-screen {
            margin: 0 !important;
            width: 100% !important;
            min-height: 100vh !important; /* Растягиваем фон на ВЕСЬ экран */
            height: 100% !important;
            border-radius: 0 !important;
            box-sizing: border-box;
            padding-bottom: 0 !important; /* Убираем нижний отступ, если был */
        }

         /* --- МАГИЯ ЗДЕСЬ: ДВИГАЕМ ТОЛЬКО ВЕРХ --- */
        body.home-mode .welcome-logo-block {
            /* Поднимаем логотип вверх визуально */
            /* -15vh означает "поднять на 15% высоты экрана" */
            /* Кнопка при этом останется на месте, так как transform не толкает соседей */
            transform: translateY(-8vh) !important; 
        }

        /* Кнопку оставляем как есть */
        body.home-mode .welcome-cta-block {
            margin: 0 !important; 
            transform: none !important; /* Гарантируем, что кнопка не сдвинется */
        }
        
        /* Когда мы на главной (home-mode), убираем фон, границы и тени у "дока" с кнопками */
        body.home-mode .nav-dock {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            gap: 25px; /* Немного увеличим расстояние между кнопками для красоты */
        }

        /* То же самое для кнопки поиска (Лупы) */
        body.home-mode .nav-search-btn {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
        }

        /* Скрываем кнопку "Домик" на главной странице */
        body.home-mode #nav-home {
            display: none !important;
        }

        /* Делаем иконки чуть более явными на фоне, если нужно (опционально) */
        body.home-mode .nav-item, 
        body.home-mode .nav-search-btn {
            color: var(--text-secondary); /* Или любой цвет, который хорошо смотрится на твоем фоне */
            opacity: 0.8;
        }
        
        /* Активная иконка на главной пусть выделяется */
        body.home-mode .nav-item.active {
            background: transparent !important;
            color: var(--text-main) !important;
            transform: scale(1.1);
        }
        /* ========== КОМПАКТНОЕ МЕНЮ ДЛЯ НЕ-ГЛАВНЫХ СТРАНИЦ ========== */
        body.compact-nav .nav-wrapper {
            bottom: 30px;
            gap: 6px;
        }

        body.compact-nav .nav-dock {
            background: rgba(255, 255, 255, 0.55) !important;
            backdrop-filter: blur(16px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(16px) saturate(180%) !important;
            border: 1px solid rgba(255, 255, 255, 0.7) !important;
            border-radius: 20px !important;
            padding: 4px 10px !important;
            gap: 4px !important;
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.08), 
                        0 2px 8px rgba(0, 0, 0, 0.04) !important;
        }

        body.compact-nav .nav-item {
            width: 38px !important;
            height: 38px !important;
            border-radius: 14px !important;
            color: rgba(100, 116, 139, 0.6) !important;
        }
        body.compact-nav .nav-item svg {
            width: 19px !important;
            height: 19px !important;
        }
        body.compact-nav .nav-item.active {
            color: var(--accent-blue) !important;
            background: rgba(52, 152, 219, 0.1) !important;
        }

        body.compact-nav .nav-search-btn {
            width: 42px !important;
            height: 42px !important;
            border-radius: 16px !important;
            background: rgba(255, 255, 255, 0.55) !important;
            backdrop-filter: blur(16px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(16px) saturate(180%) !important;
            border: 1px solid rgba(255, 255, 255, 0.7) !important;
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.08),
                        0 2px 8px rgba(0, 0, 0, 0.04) !important;
            color: rgba(100, 116, 139, 0.6) !important;
        }
        body.compact-nav .nav-search-btn svg {
            width: 20px !important;
            height: 20px !important;
        }
        body.compact-nav .nav-search-btn.active {
            background: var(--accent-blue) !important;
            color: white !important;
            border-color: var(--accent-blue) !important;
        }

        body.compact-nav .theme-toggle-mini {
            top: -8px !important;
            right: -10px !important;
            width: 22px !important;
            height: 22px !important;
        }
        body.compact-nav .theme-toggle-mini svg {
            width: 12px !important;
            height: 12px !important;
        }

        /* === COMPACT NAV DARK MODE === */
        body.dark-mode.compact-nav .nav-dock {
            background: rgba(30, 41, 59, 0.65) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.3),
                        0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }

        body.dark-mode.compact-nav .nav-item {
            color: rgba(148, 163, 184, 0.5) !important;
        }
        body.dark-mode.compact-nav .nav-item.active {
            color: #38bdf8 !important;
            background: rgba(56, 189, 248, 0.12) !important;
        }

        body.dark-mode.compact-nav .nav-search-btn {
            background: rgba(30, 41, 59, 0.65) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.3),
                        0 2px 8px rgba(0, 0, 0, 0.2) !important;
            color: rgba(148, 163, 184, 0.5) !important;
        }

        /* === COMPACT NAV: EXPANDED SEARCH BAR === */
        body.compact-nav .nav-search-expanded {
            height: 50px !important;
            background: rgba(255, 255, 255, 0.55) !important;
            backdrop-filter: blur(16px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(16px) saturate(180%) !important;
            border: 1px solid rgba(255, 255, 255, 0.7) !important;
            border-radius: 20px !important;
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.08),
                        0 2px 8px rgba(0, 0, 0, 0.04) !important;
            padding: 0 4px !important;
            gap: 4px !important;
        }
        body.compact-nav .nav-search-expanded .nav-search-input-bar {
            height: 36px !important;
            border-radius: 14px !important;
            font-size: 13px !important;
            background: rgba(0, 0, 0, 0.04) !important;
        }
        body.compact-nav .nav-search-expanded .nav-back-island {
            width: 36px !important;
            height: 36px !important;
            border-radius: 12px !important;
            background: rgba(255, 255, 255, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04) !important;
        }
        body.compact-nav .nav-search-expanded .nav-back-island svg {
            width: 18px !important;
            height: 18px !important;
        }
        body.compact-nav .nav-search-expanded .nav-item {
            width: 36px !important;
            height: 36px !important;
        }
        body.compact-nav .nav-search-expanded .nav-item svg {
            width: 18px !important;
            height: 18px !important;
        }

        /* Compact search bar dark mode */
        body.dark-mode.compact-nav .nav-search-expanded {
            background: rgba(30, 41, 59, 0.65) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.3),
                        0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }
        body.dark-mode.compact-nav .nav-search-expanded .nav-search-input-bar {
            background: rgba(255, 255, 255, 0.08) !important;
        }
        body.dark-mode.compact-nav .nav-search-expanded .nav-back-island {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        /* ========== КОНЕЦ КОМПАКТНОГО МЕНЮ ========== */

        /* ========== КОНЕЦ НОВЫХ СТИЛЕЙ ========== */

         /* ========== ФОН ДЛЯ СТРАНИЦЫ РЕБАЛАНСИРОВКИ (КАК НА ГЛАВНОЙ) ========== */
        
        #screen-assets {
            /* 1. Копируем градиент с главной страницы (Светлая тема) */
            background: linear-gradient(90deg, #F5F1EE 0%, #F9FAFC 100%);
            
            /* 2. Растягиваем фон на весь экран (компенсируем отступы body) */
            margin: -16px; /* "Вылезаем" за границы стандартного отступа */
            min-height: 100vh; /* Высота на весь экран */
            
            /* 3. Добавляем внутренние отступы, чтобы контент не прилипал к краям */
            padding: 20px 16px 120px 16px; /* Сверху 20, бока 16, снизу 120 (место для меню) */
            
            /* Убеждаемся, что этот фон перекрывает всё */
            position: relative;
            z-index: 1;
        }

        /* 4. Копируем градиент для ТЕМНОЙ темы */
        body.dark-mode #screen-assets {
            background: linear-gradient(90deg, #1a2234 0%, #0f172a 100%);
        }
        
        /* ====================================================================== */

                                      /* ========== УЛЬТРА-ФИНАЛ: ЦЕНТРОВКА И РУБЛИ ========== */
        
        .input-wrapper {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            position: relative;
            width: 100% !important;
            margin: 20px 0 10px 0 !important;
        }

        /* Линия подчеркивания */
        .input-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 1px;
            background: rgba(44, 54, 76, 0.15) !important;
        }

        /* Поле ввода */
        input#sumInput {
            caret-color: transparent !important;
            color: var(--text-main) !important;
            background: transparent !important;
            border: none !important;
            outline: none !important;
            
            /* АВТО-ШИРИНА ЧЕРЕЗ GRID-ХАК */
            width: auto !important;
            min-width: 10px; 
            max-width: 200px;
            
            text-align: right !important; /* Цифры жмутся вправо к курсору */
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Плейсхолдер - выравниваем по центру */
        
        /* Плейсхолдер - центрируем */
        input#sumInput::placeholder {
            color: #bdc3c7 !important;
            font-family: 'Inter', sans-serif !important; /* Для текста Inter лучше, чем Mono */
            font-size: 18px !important; /* Уменьшим размер для длинной фразы */
            font-weight: 600;
            letter-spacing: 1px;
            opacity: 1 !important;
            text-align: center !important; /* Центрируем текст */
        }
                /* Когда начинаем вводить (плейсхолдер исчез) - жмем вправо к курсору */
        input#sumInput:not(:placeholder-shown) {
            text-align: right !important;
        }


        /* КУРСОР */
                /* 1. По умолчанию курсор скрыт */
        .custom-cursor {
            width: 3px !important;
            height: 42px !important;
            border-radius: 2px !important;
            background: linear-gradient(to bottom, #FFD700, #0ea5e9, #b5985a) !important;
            background-size: 100% 200% !important;
            margin: 0 4px 0 2px !important; 
            display: none; /* Скрыт */
            animation: shimmerBlink 1s infinite !important;
            flex-shrink: 0 !important;
        }

        /* 2. Показываем курсор, если в поле ПУСТО (виден плейсхолдер) */
        input#sumInput:placeholder-shown + #customCursor {
            display: block !important;
        }

        /* 3. Показываем курсор, если поле В ФОКУСЕ (вы нажали на него) */
        input#sumInput:focus + #customCursor {
            display: block !important;
        }


        /* ЗОЛОТОЙ РУБЛЬ (Показываем, когда есть текст) */
        .currency { 
            font-family: 'JetBrains Mono', monospace;
            font-size: 42px; 
            color: #b5985a !important;
            text-shadow: 0 0 10px rgba(181, 152, 90, 0.3);
            font-weight: 500;
            opacity: 1 !important;
            display: none; /* Изначально скрыт */
        }
        
        /* СЕРЫЙ РУБЛЬ (Показываем, когда пусто) */
        .currency-placeholder {
            font-family: 'JetBrains Mono', monospace;
            font-size: 42px; 
            color: #bdc3c7 !important;
            font-weight: 500;
            opacity: 1 !important;
            display: block; /* Изначально виден */
        }

        /* ТЕМНАЯ ТЕМА */
        body.dark-mode .currency { color: #d4af37 !important; }
        body.dark-mode .currency-placeholder { color: #475569 !important; }
        /* ===================================================== */

                /* ========== ФИКС КУРСОРА И АНИМАЦИИ ========== */
        
        /* 1. Сама анимация (должна быть обязательно) */
        @keyframes shimmerBlink {
            0% { opacity: 1; }
            40% { opacity: 1; }
            50% { opacity: 0.15; }
            60% { opacity: 0.15; }
            100% { opacity: 1; }
        }

        /* 2. Стиль курсора */
        .custom-cursor {
            width: 3px !important;
            height: 42px !important;
            border-radius: 2px !important;
            
            /* Градиент */
            background: linear-gradient(to bottom, #FFD700, #0ea5e9, #b5985a) !important;
            background-size: 100% 200% !important;
            
            /* Отступы: 0 сверху, 4px справа, 0 снизу, 2px слева */
            margin: 0 4px 0 2px !important; 
            
            /* Принудительная анимация */
            animation: shimmerBlink 1s infinite !important;
            
            /* Важно: flex-shrink, чтобы его не сжимало */
            flex-shrink: 0 !important;
            
            /* Изначально скрыт, JS его включит */
            display: none; 
        }
        
        /* 3. Центровка плейсхолдера */
        input#sumInput::placeholder {
            text-align: center !important;
            color: #bdc3c7 !important;
        }
        
        /* 4. Центровка текста при вводе (прижимаем к курсору) */
        input#sumInput:not(:placeholder-shown) {
            text-align: right !important;
        }
/* =========================================
   GHOST SLIDER & WATERFALL STYLES (NEW)
   ========================================= */

/* 1. Контейнер с перспективой для 3D эффекта */
.strategy-perspective-wrapper {
    perspective: 1000px;
    margin-top: 15px;
    position: relative;
    z-index: 10;
}

/* 2. Основная (выбранная) карточка */
.main-selected-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    border: 1.5px solid var(--accent-blue);
    position: relative;
    z-index: 20;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s ease;
    cursor: default;
}

/* Эффект нажатия на главную карточку */
.main-selected-card:active {
    transform: scale(0.98);
}

.dark-mode .main-selected-card {
    background: #1e293b;
    border-color: var(--accent-blue);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

/* 3. Контейнер для скрытых карточек (Waterfall) */
.waterfall-container {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    margin-top: 0; /* Прижато к верхней карте */
    position: relative;
}

.waterfall-container.show {
    grid-template-rows: 1fr;
    margin-top: 15px; /* Отступ когда раскрыто */
}

.waterfall-inner {
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Стили скрытых карточек */
.strategy-option-card {
    opacity: 0;
    transform: translateY(-30px) scale(0.95) rotateX(-5deg);
    filter: blur(8px);
    transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 14px 18px;
    border: 1px solid rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}

.dark-mode .strategy-option-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.05);
}

/* Активное состояние опции в списке */
.strategy-option-card.selected-in-list {
    background: #fff;
    border-color: var(--accent-blue);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
}

.dark-mode .strategy-option-card.selected-in-list {
    background: #2d3748;
}

/* Анимация появления (Waterfall delay) */
.waterfall-container.show .strategy-option-card {
    opacity: 1;
    transform: translateY(0) scale(1) rotateX(0);
    filter: blur(0);
}

/* Задержки для каждой карточки */
.waterfall-container.show .strategy-option-card:nth-child(1) { transition-delay: 0.05s; }
.waterfall-container.show .strategy-option-card:nth-child(2) { transition-delay: 0.1s; }
.waterfall-container.show .strategy-option-card:nth-child(3) { transition-delay: 0.15s; }
.waterfall-container.show .strategy-option-card:nth-child(4) { transition-delay: 0.2s; }
.waterfall-container.show .strategy-option-card:nth-child(5) { transition-delay: 0.25s; }

/* 4. GHOST SLIDER (Триггер) */
.ghost-trigger-wrapper {
    margin-top: 20px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 10px;
    transition: opacity 0.3s;
}

.ghost-trigger-wrapper:active {
    opacity: 0.6;
}

/* Линия с шиммером */
.ghost-line {
    width: 40px;
    height: 3px;
    background: #E2E8F0;
    border-radius: 2px;
    position: relative;
    overflow: hidden;
    margin-bottom: 8px;
}

.dark-mode .ghost-line { background: #334155; }

/* Анимация блика */
.ghost-line::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    transform: translateX(-100%);
    animation: ghostShimmer 2.5s infinite;
}

@keyframes ghostShimmer {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
}

.ghost-text {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px; /* Увеличенный трекинг */
    color: #94A3B8;
    margin-bottom: 4px;
    transition: color 0.3s;
}

.ghost-dots {
    display: flex;
    gap: 4px;
}

.ghost-dot {
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background: #CBD5E1;
    transition: all 0.3s;
}

/* Состояние "Открыто" для триггера */
.ghost-trigger-wrapper.open .ghost-text {
    color: var(--accent-blue);
}
.ghost-trigger-wrapper.open .ghost-dot {
    background: var(--accent-blue);
    transform: scale(1.2);
}

/* Внутренности карточек (тексты и бары) */
.card-left-part { display: flex; align-items: center; gap: 14px; }
.card-indicator { width: 4px; height: 32px; border-radius: 2px; flex-shrink: 0; }
.card-titles { display: flex; flex-direction: column; }
.card-main-title { font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 700; color: var(--text-main); }
.card-sub-title { font-family: 'Inter', sans-serif; font-size: 11px; color: #8A9AB0; margin-top: 2px; }

/* Правая часть с разделителем */
.card-right-part { 
    display: flex; 
    align-items: center; 
    gap: 12px;
}

/* Тонкий вертикальный разделитель */
.card-divider {
    width: 1px;
    height: 28px;
    background: linear-gradient(180deg, transparent 0%, rgba(148, 163, 184, 0.3) 20%, rgba(148, 163, 184, 0.3) 80%, transparent 100%);
    flex-shrink: 0;
}

/* Контейнер для процентов */
.card-pct-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 75px;
}

.card-pct-bonds { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; color: var(--bonds-color); white-space: nowrap; }
.card-pct-stocks { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; color: var(--stocks-color); white-space: nowrap; }

/* Скрытие старых элементов, если они где-то остались */
.strategy-cards-container, .strategy-expand-trigger { display: none !important; }

        /* =================================================================
   FEE SELECTOR - QUIET LUXURY DESIGN (CLEAN)
   ================================================================= */

/* 1. Основной контейнер (Слой выше стратегий) */
.fee-selector-unified {
    position: relative;
    margin-top: 20px;
    margin-bottom: 25px;
    z-index: 200; /* Достаточно, чтобы быть выше карт */
}

/* 2. Стеклянная подложка кнопки */
.fee-unified-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    
    /* Эффект дорогого стекла */
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
    transition: transform 0.2s ease;
}

.fee-unified-wrapper:active {
    transform: scale(0.995);
}

.fee-unified-label {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    color: #64748B; /* Спокойный серый */
    font-weight: 500;
}

/* 3. Триггер (сама кнопка "Выбрать") */
.fee-unified-trigger {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 14px;
    background: #FFFFFF;
    border: 1px solid rgba(0, 0, 0, 0.04);
    border-radius: 12px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}

.fee-unified-trigger:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    transform: translateY(-1px);
}

.fee-selected-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 600;
    color: #2C364C;
}

.fee-dropdown-arrow {
    color: #94A3B8;
    transition: transform 0.3s ease;
}

/* 4. Выпадающее меню (Парящее) */
/* 4. Выпадающее меню (Исправленное выравнивание) */
.fee-dropdown-menu {
    position: absolute;
    top: calc(100% + 10px);
    
    /* ИСПРАВЛЕНИЕ СМЕЩЕНИЯ */
    left: 0;
    right: 0;        /* Привязываем сразу к обоим краям */
    width: auto;     /* Автоматическая ширина вместо 100% */
    margin: 0;       /* Убираем любые внешние отступы */
    box-sizing: border-box; /* Важно: отступы внутри не расширяют блок */
    
    /* Материал */
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 24px;
    padding: 8px;
    
    /* Тень левитации */
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12), 0 5px 15px rgba(0,0,0,0.02);
    
    /* Скрыто */
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px) scale(0.98);
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    z-index: 1000;
}


/* Состояние: Открыто */
.fee-dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}

/* 5. Пункты меню */
.fee-dropdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px;
    margin-bottom: 2px;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.fee-dropdown-item:hover {
    background: rgba(44, 54, 76, 0.04);
}

/* Выбранный пункт - Белая плашка */
.fee-dropdown-item.selected {
    background: #FFFFFF;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
}

.fee-item-rate {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    font-weight: 500;
    color: #2C364C;
}

/* 6. ЛОГИКА ГАЛОЧЕК (Круги) */

/* Базовый: Пустой круг */
.fee-item-check {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    
    /* Тонкая серая линия */
    border: 1.5px solid #CBD5E1;
    background: transparent;
    
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Галочка внутри (скрыта) */
.fee-item-check svg {
    width: 14px;
    height: 14px;
    stroke: white;
    stroke-width: 2.5;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s ease;
}

/* Выбрано: Залитый круг */
.fee-dropdown-item.selected .fee-item-check {
    background: #2C364C; /* Графит */
    border-color: #2C364C;
    transform: scale(1.1);
    box-shadow: 0 4px 10px rgba(44, 54, 76, 0.2);
}

/* Выбрано: Галочка видна */
.fee-dropdown-item.selected .fee-item-check svg {
    opacity: 1;
    transform: scale(1);
}

/* 7. Темная тема */
body.dark-mode .fee-unified-wrapper {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
}
body.dark-mode .fee-unified-trigger {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}
body.dark-mode .fee-selected-text { color: #F1F5F9; }
body.dark-mode .fee-dropdown-menu {
    background: rgba(30, 41, 59, 0.95);
    border-color: rgba(255, 255, 255, 0.1);
}
body.dark-mode .fee-dropdown-item:hover { background: rgba(255, 255, 255, 0.05); }
body.dark-mode .fee-dropdown-item.selected {
    background: rgba(255, 255, 255, 0.1);
    box-shadow: none;
}
body.dark-mode .fee-item-rate { color: #F1F5F9; }
body.dark-mode .fee-item-check { border-color: #475569; }
body.dark-mode .fee-dropdown-item.selected .fee-item-check {
    background: #38BDF8;
    border-color: #38BDF8;
}
body.dark-mode .fee-dropdown-item.selected .fee-item-check svg { stroke: #0F172A; }

        /* =================================================================
   FIX FOR FULLSCREEN MODE (ОТСТУПЫ СВЕРХУ)
   ================================================================= */

/* 1. Заголовки экранов: Портфель, Ребалансировка, Интересное */
.header {
    /* calc(X + Y) складывает наши пиксели и системный отступ телефона */
    padding-top: calc(80px + env(safe-area-inset-top)) !important; 
    padding-bottom: 20px !important;
}

/* 2. Заголовок Терминала (где калькулятор) */
.terminal-header-v2 {
    /* Делаем побольше, чтобы не прилипало к статус-бару */
    padding-top: calc(80px + env(safe-area-inset-top)) !important;
}

/* 3. Экран компании (стрелка назад и тикер) */
.company-top-bar {
    /* Отступ для кнопок навигации внутри компании */
    padding-top: calc(30px + env(safe-area-inset-top)) !important;
    padding-bottom: 10px !important;
}

/* 4. На всякий случай: если на Android safe-area не сработает,
   эти стили гарантируют минимальный отступ */
@supports not (padding-top: env(safe-area-inset-top)) {
    .header { padding-top: 50px !important; }
    .terminal-header-v2 { padding-top: 60px !important; }
    .company-top-bar { padding-top: 30px !important; }
}
 /* ================================================================== */

        /* Подтягиваем нижнюю панель выше */
.bottom-sticky-panel {
    margin-top: 0 !important;   /* Убираем внешний отступ сверху */
    padding-top: 0 !important;  /* Убираем внутренний отступ сверху */
    padding-bottom: 30px !important; /* Немного отступа снизу для красоты */
}

/* Если нужно подтянуть текст подсказки ближе к кнопке */
.sticky-hint {
    margin-top: 8px !important; /* Было 10px, делаем чуть меньше */
}

        /* Стилизация заголовка "Инвестиционная стратегия" под стиль Ghost Text */
.strategy-section .fee-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;       /* Размер как у кнопки внизу */
    font-weight: 700 !important;      /* Жирность */
    text-transform: uppercase !important;
    letter-spacing: 2px !important;   /* Широкий интервал между буквами */
    color: #94A3B8 !important;        /* Цвет как у кнопки внизу */
    
    text-align: left !important;    /* Слева текст */
    display: block !important;        /* Чтобы занимал всю ширину */
    width: 100% !important;
    margin-bottom: 15px !important;   /* Отступ до карточки */
    margin-top: 5px !important;
}

        /* =================================================================
   ЕДИНЫЙ СТИЛЬ ЗАГОЛОВКОВ (КАК В ТЕРМИНАЛЕ)
   ================================================================= */

/* 1. Контейнер заголовка */
.header {
    text-align: left !important; /* Выравнивание влево */
    background: transparent !important;
    margin: 0 !important;
    
    /* Точные отступы как у .terminal-header-v2 */
    padding: 40px 10px 10px 10px !important;
    
    /* Учет "челки" телефона (как в терминале) */
    padding-top: calc(80px + env(safe-area-inset-top)) !important;
}

/* 2. Сам текст заголовка (h1) */
.header h1 {
    font-family: 'Inter', sans-serif !important;
    font-weight: 800 !important;
    font-size: 32px !important; /* Размер как у слова Terminal */
    color: #2C364C !important;
    letter-spacing: -0.5px !important;
    line-height: 1.1 !important;
    margin: 0 !important;
    margin-bottom: 6px !important;
}

/* 3. Темная тема */
body.dark-mode .header h1 {
    color: #f1f5f9 !important;
}

        /* Индивидуальный отступ только для вкладки "Интересное" */
#screen-interesting .header {
    /* Меняйте 100px на любое число - чем больше, тем ниже */
    padding-top: calc(100px + env(safe-area-inset-top)) !important;
}
 
/* =================================================================
   LUXURY NOTIFICATION PILL (REVOLUTIONARY DESIGN)
   ================================================================= */

.luxury-notify-pill {
    position: fixed;
    top: 0;
    left: 50%;
    /* Скрыто за верхней границей экрана */
    transform: translate(-50%, -150%);
    
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 10px 24px 10px 10px; /* Слева меньше отступ из-за иконки */
    
    /* Материал: Глубокий матовый графит */
    background: rgba(30, 41, 59, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    
    /* Границы и форма */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 100px; /* Идеальная капсула */
    
    /* Тень: Глубокая и мягкая */
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    
    z-index: 20000; /* Поверх всего */
    
    /* Физическая анимация (Пружина) */
    transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);

    max-width: 85%; /* Чтобы не касаться краев экрана */
    white-space: nowrap; /* Текст в одну строку */

}

/* Состояние ПОКАЗАНО (Исправленный отступ) */
.luxury-notify-pill.show {
    /* 
       env(safe-area-inset-top) = высота "челки"
       + 60px = высота кнопок Telegram + небольшой отступ
    */
    transform: translate(-50%, calc(env(safe-area-inset-top) + 85px)) !important;
}

/* Иконка в кружке */
.notify-icon-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #F87171; /* Элегантный красный */
    flex-shrink: 0;
}

/* Текстовый блок */
.notify-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 2px;
}

.notify-title {
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #94A3B8; /* Серый субитог */
}

.notify-message {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: #FFFFFF; /* Белый текст */
    white-space: nowrap;
}

/* Адаптация для Светлой темы (делаем капсулу контрастной) */
/* В светлой теме капсула остается темной для "премиум" акцента */

/* =================================================================
   АНИМАЦИЯ ОШИБКИ (LUXURY SHAKE)
   ================================================================= */

@keyframes shakeLux {
    0%, 100% { transform: translateX(0); }
    15% { transform: translateX(-6px); }
    30% { transform: translateX(6px); }
    45% { transform: translateX(-4px); }
    60% { transform: translateX(4px); }
    75% { transform: translateX(-2px); }
}

.shake-error {
    animation: shakeLux 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
    
    /* ЗОЛОТАЯ РАМКА (Цвет вашего рубля) */
    border-color: #b5985a !important; 
    
    /* Мягкое золотое свечение вокруг */
    box-shadow: 0 0 0 4px rgba(181, 152, 90, 0.2) !important;
    
    /* Легкое затемнение фона для акцента */
    background: rgba(181, 152, 90, 0.05) !important;
}

/* =================================================================
   HEAVY PHYSICS SWIPE (3D PARALLAX)
   ================================================================= */

/* 1. Контейнер всего индикатора */
.luxury-swipe-container {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 0; /* Изначально ширины нет */
    z-index: 9999; /* Поверх всего, кроме overlay */
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: flex-start;
}

/* 2. Линза (Стрелка) */
.ls-lens {
    width: 50px;
    height: 80px;
    
    /* Форма: Полуовал, выезжающий слева */
    border-radius: 0 40px 40px 0;
    
    /* Материал: "Жидкое" стекло */
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    
    /* Свечение */
    box-shadow: 10px 0 40px rgba(255, 255, 255, 0.4), inset -2px 0 5px rgba(255,255,255,0.5);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-left: none;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Изначально скрыта слева */
    transform: translateX(-100%);
    opacity: 0;
    transition: transform 0.1s linear, opacity 0.1s linear;
}

/* Стрелка внутри */
.ls-arrow {
    color: #2C364C;
    width: 28px;
    height: 28px;
    transform: scale(0.8);
    transition: transform 0.2s ease;
}

/* Темная тема */
body.dark-mode .ls-lens {
    background: rgba(30, 41, 59, 0.7);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 10px 0 40px rgba(0, 0, 0, 0.3);
}
body.dark-mode .ls-arrow { color: #FFFFFF; }

/* 3. Экраны */
.screen {
    transform-origin: center left;
    will-change: transform;
    position: relative;
}

/* Текущий экран при свайпе (скрыт) */
.screen.swipe-active {
    z-index: 100;
}

/* Предыдущий экран, показываемый на фоне */
.screen.swipe-prev {
    display: block !important;
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 99;
    padding: 16px;
    padding-bottom: 40px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    animation: none !important;
    background: var(--bg-base, #F1F6FB);
}

body.dark-mode .screen.swipe-prev {
    background: var(--bg-base, #0f172a);
}

        
/* ==================================================================== */

        /* =================================================================
   LUXURY BRAND PAPER BACKGROUND
   ================================================================= */

.luxury-depth-layer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* На заднем плане */
    
    /* Глубокий, дорогой цвет фона */
    background: radial-gradient(circle at 50% 50%, #2C364C 0%, #111827 100%);
    
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Обрезаем лишнее */
}

/* Контейнер для текста (его мы будем двигать параллаксом) */
.luxury-pattern-container {
    display: flex;
    flex-direction: column;
    gap: 40px; /* Расстояние между строками */
    
    /* Слегка наклоняем весь паттерн для динамики */
    transform: rotate(-10deg) scale(1.2); 
    
    width: 150%; /* Шире экрана, чтобы не было дырок при повороте */
    opacity: 0.6; /* Общая прозрачность текстуры */
}

/* Сама строка текста */
.pattern-line {
    font-family: 'Inter', sans-serif;
    font-weight: 800;
    font-size: 11px; /* Мелкий, аккуратный шрифт */
    text-transform: uppercase;
    letter-spacing: 4px; /* Широкая разрядка - признак люкса */
    
    /* Цвет "вдавленной" бумаги */
    color: rgba(255, 255, 255, 0.04); 
    
    white-space: nowrap; /* Текст не переносится */
    user-select: none;
}


/* =================================================================
   ХАОТИЧНЫЙ ПАТТЕРН (ЦИКЛ ИЗ 5 СТРОК)
   ================================================================= */

/* Строка 1: Чуть левее */
.pattern-line:nth-child(5n+1) {
    margin-left: -40px;
    opacity: 0.5; /* Чуть ярче */
}

/* Строка 2: Сильно влево */
.pattern-line:nth-child(5n+2) {
    margin-left: -250px;
    opacity: 0.3; /* Тусклее (глубже) */
}

/* Строка 3: Сдвиг вправо */
.pattern-line:nth-child(5n+3) {
    margin-left: 80px;
    opacity: 0.4;
}

/* Строка 4: Средний сдвиг влево */
.pattern-line:nth-child(5n+4) {
    margin-left: -120px;
    opacity: 0.6; /* Самая яркая */
}

/* Строка 5: Очень далеко влево */
.pattern-line:nth-child(5n+5) {
    margin-left: -300px;
    opacity: 0.25; /* Еле заметная */
}


/* Адаптация для Светлой темы */
body:not(.dark-mode) .luxury-depth-layer {
    /* Светлая дорогая бумага */
    background: #F1F5F9;
}
body:not(.dark-mode) .pattern-line {
    /* Текст чуть темнее фона (эффект тиснения) */
    color: rgba(44, 54, 76, 0.06);
    font-weight: 900;
}


/* ==================================================================== */

        /* =================================================================
   THE GLASS EDGE (ОБРАБОТКА ЛЕВОГО КРАЯ ПРИ СВАЙПЕ)
   ================================================================= */

/* 1. Базовый переход для границ */
.screen {
    /* Добавляем transition для радиуса и тени */
    transition: 
        transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), 
        border-radius 0.3s ease,
        box-shadow 0.3s ease !important;
}

/* 2. Стиль АКТИВНОГО СВАЙПА (Класс .swiping добавляется JS-ом) */
.screen.swiping {
    /* Скругляем левые углы, превращая экран в "Карточку" */
    border-top-left-radius: 32px !important;
    border-bottom-left-radius: 32px !important;
    
    /* Обрезаем контент, чтобы он не вылезал за скругления */
    overflow: hidden !important; 
    
    /* МАГИЯ СВЕТА И ТЕНИ */
    box-shadow: 
        /* 1. Внутренний белый блик (Торец стекла) - тонкая линия */
        inset 1px 0 0 0 rgba(255, 255, 255, 0.6),
        
        /* 2. Внутреннее мягкое свечение (Объем) */
        inset 10px 0 20px -5px rgba(255, 255, 255, 0.3),
        
        /* 3. Тень близкая (Контур) */
        -5px 0 15px rgba(0, 0, 0, 0.1),
        
        /* 4. Тень далекая (Глубина) - создает ощущение полета */
        -30px 0 60px -10px rgba(0, 0, 0, 0.3) !important;
}

/* 3. Адаптация для ТЕМНОЙ ТЕМЫ */
body.dark-mode .screen.swiping {
    box-shadow: 
        /* Тонкий светлый блик (контраст с темным фоном) */
        inset 1px 0 0 0 rgba(255, 255, 255, 0.15),
        
        /* Внутренний темный градиент */
        inset 20px 0 30px -10px rgba(0, 0, 0, 0.5),
        
        /* Глубокая черная тень */
        -30px 0 70px -5px rgba(0, 0, 0, 0.6) !important;
        
    /* Чтобы край не сливался, можно добавить едва заметную золотую кайму */
    border-left: 1px solid rgba(181, 152, 90, 0.1) !important;
}
        
/* ==================================================================== */

      /* =================================================================
   REVOLUTIONARY SWIPE EFFECTS: SHEEN & SCALE
   ================================================================= */

/* 1. Слой блика (изначально невидим) */
.screen::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 200%; /* Шире экрана, чтобы двигаться */
    height: 100%;
    
    /* Градиент: Прозрачный -> Белый луч -> Прозрачный */
    background: linear-gradient(
        110deg, 
        transparent 30%, 
        rgba(255, 255, 255, 0.4) 45%, 
        rgba(255, 255, 255, 0.0) 60%
    );
    
    transform: translateX(-100%); /* Спрятан слева */
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.2s ease;
}

/* 2. Темная тема (Блик должен быть деликатнее) */
body.dark-mode .screen::after {
    background: linear-gradient(
        110deg, 
        transparent 30%, 
        rgba(255, 255, 255, 0.1) 45%, 
        rgba(255, 255, 255, 0.0) 60%
    );
}

/* 3. Активация блика при свайпе */
.screen.swiping::after {
    opacity: 1;
    /* Позиция управляется через JS, но здесь база */
}
  /* ==================================================================== */

        /* ========== НОВЫЙ ДИЗАЙН ОФЗ (QUIET LUXURY) ========== */

        /* 1. Заголовок перед списком */
.ofz-analogs-title {
    position: relative;
    font-family: 'Inter', sans-serif;
    font-size: 18px; /* Значительный размер */
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text-main);
    margin: 50px 0 30px 10px !important;
    display: flex;
    align-items: center;
}
        /* Градиентный шлейф под заголовком */
.ofz-analogs-title::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, #3498db, transparent);
    border-radius: 2px;
}

/* "Живая" точка рядом */
.ofz-analogs-title::before {
    content: '';
    width: 8px;
    height: 8px;
    background: #3498db;
    border-radius: 50%;
    margin-right: 12px;
    box-shadow: 0 0 15px rgba(52, 152, 219, 0.6);
}
        /* 2. ИНСТРУМЕНТ И ДИНАМИЧЕСКИЙ ЗНАЧОК */
.h-label-instrument-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer; /* Делаем кликабельным */
    user-select: none;
}
       

/* Динамическая стрелочка */
.instrument-toggle-icon {
    width: 14px;
    height: 14px;
    color: #94A3B8;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Класс для поворота (будет добавляться через JS) */
.is-expanded .instrument-toggle-icon {
    transform: rotate(180deg);
    color: var(--accent-blue);
}

/* 1. Контейнер списка (убираем старые ограничения) */
#ofz-wrapper {
    transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    opacity: 1;
}

#ofz-wrapper.collapsed {
    display: none; /* Полностью скрываем, когда закрыто */
    opacity: 0;
}

/* 2. Революционный дизайн строки с "мостиком" */
.ofz-luxury-item {
    display: flex;
    align-items: baseline; /* Выравнивание по базовой линии текста */
    padding: 14px 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
}

.ofz-luxury-item:active {
    background: rgba(0,0,0,0.02);
}

.dark-mode .ofz-luxury-item {
    border-bottom-color: rgba(255,255,255,0.05);
}

.dark-mode .ofz-luxury-item:active {
    background: rgba(255,255,255,0.03);
}

/* Левая часть: Название и Тикер */
.ofz-lux-left {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.ofz-lux-name {
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
    color: var(--text-main);
    flex-shrink: 0; /* Название не сжимается */
}

        /* Тот самый "Мостик" - пунктирная линия */
.ofz-lux-bridge {
    flex-grow: 1; /* Линия забирает всё свободное место */
    border-bottom: 1px dotted rgba(0,0,0,0.15); 
    margin: 0 10px;
    position: relative;
    top: -4px; /* Приподнимаем к центру текста */
}

.dark-mode .ofz-lux-bridge {
    border-bottom-color: rgba(255,255,255,0.1);
}

.ofz-lux-ticker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    color: var(--text-secondary);
    background: rgba(0,0,0,0.04);
    padding: 2px 6px;
    border-radius: 6px;
    width: fit-content;
}

.dark-mode .ofz-lux-ticker {
    background: rgba(255,255,255,0.1);
}

/* Правая часть: Доходность и Цена */
.ofz-lux-right {
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-shrink: 0;
}

.ofz-lux-yield {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--accent-green);
}

.ofz-lux-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-secondary);
    width: 45px;
    text-align: right;
}

        /* 3. Логика скрытия строк (после 3-й) */
.ofz-row-hidden {
    display: none !important;
}

/* 4. Раскрыватель (Ghost Trigger) внизу */
.ghost-trigger-wrapper.footer-trigger {
    margin-top: 10px;
    margin-bottom: 30px;
}

/* Детали (выпадающая панель) - Стиль стекла */
.ofz-lux-details {
    display: none;
    background: rgba(52, 152, 219, 0.04); /* Легкий голубой оттенок */
    padding: 15px 20px;
    border-radius: 12px;
    margin: 0 10px 15px 10px;
    animation: fadeIn 0.3s ease;
}

.ofz-lux-details.active {
    display: block;
}

.ofz-lux-detail-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed rgba(0,0,0,0.05);
}

.ofz-lux-detail-label {
    font-size: 11px;
    color: var(--text-secondary);
}

.ofz-lux-detail-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-main);
}
        
  /* ==================================================================== */
/* --- ФИНАЛЬНЫЙ БЛОК ОФЗ (ЗАМЕНА ВСЕГО ПРЕДЫДУЩЕГО) --- */

/* 1. ПРИНУДИТЕЛЬНЫЙ ГРАДИЕНТ (Раз и навсегда) */
.force-gradient-bg {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
    color: white !important;
    border: none !important;
}
.force-gradient-bg * { color: white !important; }


/* 3. ШАПКА ТАБЛИЦЫ */
.ofz-headers-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    margin-top: 20px;
}
.h-label-instrument {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #94A3B8;
}
/* 2. ИДЕАЛЬНОЕ ЦЕНТРИРОВАНИЕ ПЛАШЕК */
.headers-right-group {
    display: flex;
    align-items: center;
    /* Теперь мы жестко привязываемся к ширине колонок данных */
    width: 135px; 
    justify-content: space-between;
    margin-right: 5px;
}
/* Стеклянные плашки теперь центрируют содержимое */
.header-glass-pill {
    width: 55px; /* Ширина плашки */
    height: 28px;
    display: flex;
    justify-content: center;
    align-items: center;
    background: rgba(255, 255, 255, 0.05); /* Эффект стекла */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; /* ТУТ РЕГУЛИРУЕТСЯ РАЗМЕР % и ₽ */
    color: #94a3b8;
    font-weight: 600;
}
.dark-mode .header-glass-pill {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

/* ========================================================================
   AURORA REBALANCE DESIGN - НОВЫЙ ДИЗАЙН ВКЛАДКИ РЕБАЛАНСИРОВКА
   ======================================================================== */

/* === УНИВЕРСАЛЬНЫЙ AURORA ФОН ДЛЯ ВСЕХ ЭКРАНОВ === */
.screen {
    position: relative;
    background: var(--bg-base);
}

.screen > .aurora-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
}

.screen > .aurora-spot {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    animation: auroraFloat 15s ease-in-out infinite;
}

.screen > .aurora-spot.blue,
.screen .aurora-container .aurora-spot.blue {
    width: 400px;
    height: 400px;
    background: var(--aurora-blue);
    top: -10%;
    right: -10%;
    animation-delay: 0s;
}

.screen > .aurora-spot.green,
.screen .aurora-container .aurora-spot.green {
    width: 350px;
    height: 350px;
    background: var(--aurora-green);
    bottom: 20%;
    left: -15%;
    animation-delay: -5s;
}

.screen > .aurora-spot.orange,
.screen .aurora-container .aurora-spot.orange {
    width: 300px;
    height: 300px;
    background: var(--aurora-orange);
    top: 40%;
    right: 10%;
    animation-delay: -10s;
}

.screen > .noise-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 256px 256px;
}

body.dark-mode .screen > .noise-overlay {
    opacity: 0.04;
}

.screen > *:not(.aurora-container):not(.noise-overlay):not(.aurora-spot) {
    position: relative;
}

/* === 1. ОСНОВНОЙ КОНТЕЙНЕР ЭКРАНА === */
#screen-assets {
    position: relative;
    background: var(--bg-base);
    min-height: 100vh;
    margin: -16px;
    padding: 20px 16px 140px 16px;
    overflow: hidden;
}

/* === 2. AURORA MESH GRADIENT BACKGROUND === */
#screen-assets::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-base);
    z-index: -2;
}

#screen-assets::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}

/* Aurora Floating Spots */
.aurora-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
}

.aurora-spot {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    animation: auroraFloat 15s ease-in-out infinite;
}

.aurora-spot.blue {
    width: 400px;
    height: 400px;
    background: var(--aurora-blue);
    top: -10%;
    right: -10%;
    animation-delay: 0s;
}

.aurora-spot.green {
    width: 350px;
    height: 350px;
    background: var(--aurora-green);
    bottom: 20%;
    left: -15%;
    animation-delay: -5s;
}

.aurora-spot.orange {
    width: 300px;
    height: 300px;
    background: var(--aurora-orange);
    top: 40%;
    right: 10%;
    animation-delay: -10s;
}

@keyframes auroraFloat {
    0%, 100% {
        transform: translate(0, 0) scale(1);
        opacity: 0.6;
    }
    25% {
        transform: translate(30px, -20px) scale(1.1);
        opacity: 0.8;
    }
    50% {
        transform: translate(-20px, 30px) scale(0.95);
        opacity: 0.7;
    }
    75% {
        transform: translate(15px, 15px) scale(1.05);
        opacity: 0.75;
    }
}

/* === 3. NOISE OVERLAY === */
.noise-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 256px 256px;
}

body.dark-mode .noise-overlay {
    opacity: 0.04;
}

/* === 4. КОНТЕНТ ПОВЕРХ ФОНА === */
#screen-assets > *:not(.aurora-container):not(.noise-overlay) {
    position: relative;
    z-index: 2;
}

/* === 5. ЗАГОЛОВОК ЭКРАНА === */
#screen-assets .header {
    padding: 10px 0 20px;
}

#screen-assets .header h1 {
    font-family: 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 700;
    letter-spacing: -0.03em;
    color: var(--text-deep);
    margin: 0;
}

/* === 6. LIQUID TAB SWITCHER (Evolution Luxury) === */
.rebalance-tabs-container {
    position: sticky;
    top: 10px;
    z-index: 100;
    margin: 20px 0 30px;
    padding: 0 4px;
}

.tab-switcher {
    position: relative;
    display: flex;
    align-items: center;
    padding: 6px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 100px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.5);
}

body.dark-mode .tab-switcher {
    background: rgba(30, 41, 59, 0.7);
    border-color: rgba(255, 255, 255, 0.1);
}

/* Глайдер (плавающий индикатор) - как кнопка расчета */
.tab-glider {
    position: absolute;
    top: 6px;
    left: 6px;
    width: calc(50% - 6px);
    height: calc(100% - 12px);
    background: #2C364C;
    border-radius: 100px;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
    box-shadow: 0 4px 15px rgba(44, 54, 76, 0.3);
}

/* Когда активна вкладка "Акции" - глайдер вправо */
.tab-switcher.show-stocks .tab-glider {
    transform: translateX(100%);
}

/* Кнопки вкладок - БЕЗ ИКОНОК */
.tab-btn {
    flex: 1;
    position: relative;
    z-index: 2;
    padding: 14px 20px;
    background: transparent;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tab-btn.active {
    color: white;
}

body.dark-mode .tab-btn {
    color: #64748b;
}

body.dark-mode .tab-btn.active {
    color: white;
}

/* === 7. КАРТОЧКА "УМНАЯ ЗАМЕНА" (Dark Premium Glass) === */
.smart-replace-card {
    position: relative;
    display: flex;
    align-items: center; /* ЦЕНТРИРОВАНИЕ ПО ВЫСОТЕ */
    gap: 16px;
    padding: 24px;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 20px;
    margin-top: 16px; /* ОТСТУП ОТ ЗАГОЛОВКА */
    margin-bottom: 24px;
    box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.3);
    overflow: hidden;
    cursor: default;
}

/* Spotlight эффект при наведении */
.smart-replace-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
        rgba(255, 255, 255, 0.1) 0%,
        transparent 50%
    );
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.smart-replace-card:hover::before {
    opacity: 1;
}

/* Иконка */
.smart-replace-icon {
    width: 52px;
    height: 52px;
    min-width: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.smart-replace-icon svg {
    width: 24px;
    height: 24px;
}

/* Текст */
.smart-replace-content {
    flex: 1;
}

.smart-replace-title {
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: white;
    margin: 0 0 6px 0;
    letter-spacing: -0.02em;
}

.smart-replace-desc {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.5;
    margin: 0;
}

/* === 8. ЗАГОЛОВКИ СПИСКА (List Headers) === */
.list-headers {
    display: grid;
    grid-template-columns: 1fr 60px 60px;
    align-items: center;
    gap: 8px;
    padding: 0 16px 12px;
    margin-bottom: 0;
}

.list-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.list-header-text {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-deep);
    opacity: 0.5;
}

.list-header-text.center {
    text-align: center;
}

.list-header-text.right {
    text-align: right;
}

/* Кликабельный заголовок процента */
.list-header-percent {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-deep);
    opacity: 0.5;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 4px 8px;
    border-radius: 4px;
    animation: headerHintPulse 3s ease-in-out infinite;
}

.list-header-percent.clicked {
    animation: none;
}

.list-header-percent:hover {
    opacity: 0.8;
    background: rgba(0, 0, 0, 0.05);
}

/* Кликабельный заголовок цены - центрируем */
.list-header-price {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-deep);
    opacity: 0.5;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 4px 8px;
    border-radius: 4px;
    animation: headerHintPulse 3s ease-in-out 0.5s infinite;
}

.list-header-price.clicked {
    animation: none;
}

.list-header-price:hover {
    opacity: 0.8;
    background: rgba(0, 0, 0, 0.05);
}

@keyframes headerHintPulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    15% { opacity: 1; transform: scale(1.12); }
    30% { opacity: 0.7; transform: scale(1); }
    45% { opacity: 1; transform: scale(1.08); }
    60% { opacity: 0.5; transform: scale(1); }
}

/* Галочка сворачивания списка - справа от ИНСТРУМЕНТ */
.list-collapse-toggle {
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 4px;
}

.list-collapse-toggle:hover {
    background: rgba(0, 0, 0, 0.05);
}

.list-collapse-toggle svg {
    width: 10px;
    height: 10px;
    stroke: var(--text-muted);
    transition: stroke 0.2s ease, transform 0.3s ease;
}

.list-collapse-toggle:hover svg {
    stroke: var(--text-deep);
}

.list-collapse-toggle.collapsed svg {
    /* Без поворота при сворачивании */
}

/* Элемент "открыть список" рядом с галочкой */
.list-open-trigger {
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 12px;
    background: rgba(59, 130, 246, 0.08);
    transition: all 0.2s ease;
    margin-left: 8px;
}

.list-open-trigger:hover {
    background: rgba(59, 130, 246, 0.15);
}

.list-open-trigger span {
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent-blue);
}

.list-open-trigger svg {
    width: 10px;
    height: 10px;
    stroke: var(--accent-blue);
    transition: transform 0.2s ease;
}

.list-open-trigger.open svg {
    transform: rotate(180deg);
}

body.dark-mode .list-open-trigger {
    background: rgba(56, 189, 248, 0.12);
}

body.dark-mode .list-open-trigger span,
body.dark-mode .list-open-trigger svg {
    color: var(--accent-blue);
    stroke: var(--accent-blue);
}

/* Общий тултип */
.header-tooltip {
    position: fixed;
    background: #2C364C;
    color: white;
    padding: 12px 16px;
    border-radius: 12px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    z-index: 1000;
    max-width: 260px;
    line-height: 1.5;
    animation: tooltipFadeIn 0.2s ease;
    pointer-events: none;
}

@keyframes tooltipFadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Раскрывающееся пояснение под заголовком (вместо всплывающего) */
.header-dropdown-tooltip {
    display: none;
    background: rgba(44, 54, 76, 0.95);
    color: white;
    padding: 12px 16px;
    border-radius: 12px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    line-height: 1.5;
    animation: dropdownOpen 0.25s ease;
    margin: 8px 0 12px 0;
    width: 100%;
    box-sizing: border-box;
}

.header-dropdown-tooltip.show {
    display: block;
}

@keyframes dropdownOpen {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

body.dark-mode .header-dropdown-tooltip {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

/* Вопросик для НКД и Текущей купонной доходности */
.ofz-help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.15);
    color: var(--accent-blue);
    font-size: 9px;
    font-weight: 700;
    cursor: pointer;
    margin-left: 4px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.ofz-help-icon:hover {
    background: rgba(59, 130, 246, 0.25);
    transform: scale(1.1);
}

body.dark-mode .ofz-help-icon {
    background: rgba(56, 189, 248, 0.2);
    color: var(--accent-blue);
}

/* Раскрывающаяся подсказка внутри подстроки */
.ofz-inline-help {
    display: none;
    background: rgba(59, 130, 246, 0.08);
    border-radius: 8px;
    padding: 10px 12px;
    margin-top: 8px;
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    line-height: 1.5;
    color: var(--text-slate);
    animation: helpSlideDown 0.25s ease;
    grid-column: 1 / -1;
}

.ofz-inline-help.show {
    display: block;
}

@keyframes helpSlideDown {
    from { opacity: 0; max-height: 0; }
    to { opacity: 1; max-height: 100px; }
}

body.dark-mode .ofz-inline-help {
    background: rgba(56, 189, 248, 0.1);
}

/* === 9. КОНТЕНТ ВКЛАДОК === */
.rebalance-tab-content {
    display: none;
    animation: tabFadeIn 0.4s ease;
}

.rebalance-tab-content.active {
    display: block;
}

@keyframes tabFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* === 10. НОВЫЙ ДИЗАЙН СПИСКА ОФЗ (отдельные боксы) === */
.ofz-aurora-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Скрытый список */
.ofz-aurora-list.collapsed {
    display: none;
}

/* Строка ОФЗ - ОТДЕЛЬНЫЙ БОКС */
.ofz-aurora-item {
    background: var(--card-glass-aurora);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--card-border-aurora);
    border-radius: 16px;
    box-shadow: var(--shadow-luxury);
    transition: all 0.2s ease;
    opacity: 0;
    transform: translateY(10px);
    animation: staggerIn 0.4s ease forwards;
    overflow: hidden;
}

body.dark-mode .ofz-aurora-item {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.08);
}

/* Stagger Animation */
@keyframes staggerIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.ofz-aurora-item:nth-child(1) { animation-delay: 0.05s; }
.ofz-aurora-item:nth-child(2) { animation-delay: 0.1s; }
.ofz-aurora-item:nth-child(3) { animation-delay: 0.15s; }
.ofz-aurora-item:nth-child(4) { animation-delay: 0.2s; }
.ofz-aurora-item:nth-child(5) { animation-delay: 0.25s; }
.ofz-aurora-item:nth-child(6) { animation-delay: 0.3s; }
.ofz-aurora-item:nth-child(7) { animation-delay: 0.35s; }
.ofz-aurora-item:nth-child(8) { animation-delay: 0.4s; }
.ofz-aurora-item:nth-child(9) { animation-delay: 0.45s; }
.ofz-aurora-item:nth-child(10) { animation-delay: 0.5s; }

/* Hover эффект */
.ofz-aurora-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px -8px rgba(15, 23, 42, 0.12);
}

/* Свернутая строка (Summary) - GRID для выравнивания */
.ofz-aurora-summary {
    display: grid;
    grid-template-columns: 1fr 60px 60px;
    align-items: center;
    gap: 8px;
    padding: 14px 16px;
    cursor: pointer;
    user-select: none;
}

.ofz-aurora-name {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-deep);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Стиль для цифр в названии ОФЗ - моношрифт */
.ofz-aurora-name .mono-digit-span,
.mono-digit-span {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
}

/* Доходность - по центру ЗЕЛЕНАЯ */
.ofz-aurora-yield {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: #10B981;
    text-align: center;
}

/* Цена - справа */
.ofz-aurora-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-slate);
    text-align: right;
}

/* Раскрытые детали (Аккордеон) - ПОСТРОЧНО */
.ofz-aurora-details {
    display: none;
    padding: 0 20px 20px;
    animation: accordionOpen 0.3s ease;
}

.ofz-aurora-item.expanded .ofz-aurora-details {
    display: block;
}

@keyframes accordionOpen {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Детали - ПОСТРОЧНО */
.ofz-aurora-details-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 12px;
    overflow: hidden;
}

body.dark-mode .ofz-aurora-details-list {
    background: rgba(255, 255, 255, 0.03);
}

.ofz-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
}

body.dark-mode .ofz-detail-row {
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

.ofz-detail-row:last-child {
    border-bottom: none;
}

.ofz-detail-label {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
}

.ofz-detail-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-deep);
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Код с иконкой копирования */
.ofz-copy-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 4px 10px;
    background: rgba(59, 130, 246, 0.08);
    border-radius: 6px;
    transition: all 0.2s ease;
}

.ofz-copy-wrapper:hover {
    background: rgba(59, 130, 246, 0.15);
}

.ofz-copy-code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-blue);
}

.ofz-copy-icon {
    width: 14px;
    height: 14px;
    stroke: var(--accent-blue);
    opacity: 0.7;
}

/* Кнопка графика - новый цвет */
.ofz-aurora-chart-btn {
    margin-top: 12px;
    padding: 14px;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border: none;
    border-radius: 12px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
}

.ofz-aurora-chart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
}

.ofz-aurora-chart-btn svg {
    width: 16px;
    height: 16px;
}

/* === 11. GHOST TRIGGER для ОФЗ и АКЦИИ === */
.rebalance-ghost-trigger {
    margin: 20px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 12px;
    transition: opacity 0.3s;
}

.rebalance-ghost-trigger:active {
    opacity: 0.6;
}

.rebalance-ghost-trigger .ghost-line {
    width: 50px;
    height: 4px;
    background: linear-gradient(90deg, #E2E8F0, #CBD5E1, #E2E8F0);
    border-radius: 2px;
    position: relative;
    overflow: hidden;
    margin-bottom: 10px;
}

body.dark-mode .rebalance-ghost-trigger .ghost-line {
    background: linear-gradient(90deg, #334155, #475569, #334155);
}

.rebalance-ghost-trigger .ghost-line::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.9) 50%, transparent 100%);
    transform: translateX(-100%);
    animation: ghostShimmerBright 1.8s infinite;
}

@keyframes ghostShimmerBright {
    0% { transform: translateX(-100%); }
    60% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
}

.rebalance-ghost-trigger .ghost-text {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #94A3B8;
    margin-bottom: 6px;
    transition: color 0.3s;
}

.rebalance-ghost-trigger.open .ghost-text {
    color: var(--accent-blue);
}

/* Точки под текстом */
.rebalance-ghost-trigger .ghost-dots {
    display: flex;
    gap: 4px;
}

.rebalance-ghost-trigger .ghost-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: #CBD5E1;
    animation: dotPulse 1.5s infinite;
}

.rebalance-ghost-trigger .ghost-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.rebalance-ghost-trigger .ghost-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes dotPulse {
    0%, 100% { opacity: 0.4; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

.rebalance-ghost-trigger.open .ghost-dot {
    background: var(--accent-blue);
}

body.dark-mode .rebalance-ghost-trigger .ghost-dot {
    background: #475569;
}

/* === 12. СКРЫТИЕ СТРОК ОФЗ === */
.ofz-aurora-item.aurora-hidden {
    display: none !important;
}

/* === 13. ВКЛАДКА АКЦИИ - НОВЫЙ ДИЗАЙН "ТИХАЯ РОСКОШЬ" === */
.stocks-aurora-container {
    /* Без белого бокса - впечатано в фон */
}

/* Заголовок ЭШЕЛОНЫ - красивый дизайн */
.echelons-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 20px 16px;
    margin-bottom: 20px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

/* Декоративные линии по бокам */
.echelons-header::before,
.echelons-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(44, 54, 76, 0.2), transparent);
    max-width: 80px;
}

body.dark-mode .echelons-header::before,
body.dark-mode .echelons-header::after {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
}

.echelons-header:hover .echelons-title {
    color: var(--text-deep);
}

.echelons-title {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--text-slate);
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Иконка вопроса - более красивая версия */
.echelons-title::after {
    content: none;
}

.echelons-help-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
    border: 1px solid rgba(59, 130, 246, 0.2);
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.echelons-help-icon svg {
    width: 12px;
    height: 12px;
    stroke: var(--accent-blue);
    stroke-width: 2.5;
}

.echelons-header:hover .echelons-help-icon {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(139, 92, 246, 0.25));
    transform: scale(1.1);
}

.echelons-header.open .echelons-help-icon {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.2);
}

.echelons-header.open .echelons-help-icon svg {
    stroke: #EF4444;
}

body.dark-mode .echelons-help-icon {
    background: linear-gradient(135deg, rgba(56, 189, 248, 0.15), rgba(167, 139, 250, 0.15));
    border-color: rgba(56, 189, 248, 0.2);
}

.echelons-toggle-icon {
    width: 14px;
    height: 14px;
    stroke: var(--text-muted);
    transition: transform 0.3s ease, stroke 0.3s ease;
}

.echelons-header:hover .echelons-toggle-icon {
    stroke: var(--text-deep);
}

.echelons-header.open .echelons-toggle-icon {
    transform: rotate(180deg);
}

/* Описания эшелонов - скрытые по умолчанию */
.stocks-echelon-info {
    max-height: 0;
    overflow: hidden;
    margin-bottom: 0;
    transition: max-height 0.4s ease, margin 0.4s ease;
}

.stocks-echelon-info.open {
    max-height: 500px;
    margin-bottom: 20px;
}

.echelon-info-card {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 12px;
    margin-bottom: 8px;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.stocks-echelon-info.open .echelon-info-card {
    opacity: 1;
    transform: translateY(0);
}

.stocks-echelon-info.open .echelon-info-card:nth-child(1) { transition-delay: 0.05s; }
.stocks-echelon-info.open .echelon-info-card:nth-child(2) { transition-delay: 0.1s; }
.stocks-echelon-info.open .echelon-info-card:nth-child(3) { transition-delay: 0.15s; }
.stocks-echelon-info.open .echelon-info-card:nth-child(4) { transition-delay: 0.2s; }

body.dark-mode .echelon-info-card {
    background: rgba(255, 255, 255, 0.04);
}

.echelon-info-icon {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.echelon-info-icon svg {
    width: 18px;
    height: 18px;
}

.echelon-info-icon.icon-e1 {
    background: rgba(16, 185, 129, 0.15);
}
.echelon-info-icon.icon-e1 svg {
    stroke: #10B981;
}

.echelon-info-icon.icon-e2 {
    background: rgba(59, 130, 246, 0.15);
}
.echelon-info-icon.icon-e2 svg {
    stroke: #3B82F6;
}

.echelon-info-icon.icon-e3 {
    background: rgba(245, 158, 11, 0.15);
}
.echelon-info-icon.icon-e3 svg {
    stroke: #F59E0B;
}

.echelon-info-icon.icon-e4 {
    background: rgba(239, 68, 68, 0.15);
}
.echelon-info-icon.icon-e4 svg {
    stroke: #EF4444;
}

.echelon-info-text {
    flex: 1;
}

.echelon-info-title {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: var(--text-deep);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.echelon-badge {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 3px 8px;
    border-radius: 20px;
}

.echelon-badge.e1 {
    background: rgba(16, 185, 129, 0.15);
    color: #10B981;
}

.echelon-badge.e2 {
    background: rgba(59, 130, 246, 0.15);
    color: #3B82F6;
}

.echelon-badge.e3 {
    background: rgba(245, 158, 11, 0.15);
    color: #F59E0B;
}

.echelon-badge.e4 {
    background: rgba(239, 68, 68, 0.15);
    color: #EF4444;
}

.echelon-info-desc {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--text-slate);
    line-height: 1.5;
}

/* Таблица эшелонов - ТИХАЯ РОСКОШЬ */
.stocks-aurora-table {
    /* Без фона - впечатана */
}

.stocks-table-header {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
    margin-bottom: 16px;
    padding: 0 2px;
}

/* Светящиеся иконки эшелонов в кружках */
.stocks-header-pill {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px;
}

.echelon-icon-circle {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 800;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid;
    transition: all 0.3s ease;
}

body.dark-mode .echelon-icon-circle {
    background: rgba(30, 41, 59, 0.9);
}

.echelon-icon-circle.e1 {
    color: #10B981;
    border-color: #10B981;
    box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
}

.echelon-icon-circle.e2 {
    color: #3B82F6;
    border-color: #3B82F6;
    box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
}

.echelon-icon-circle.e3 {
    color: #F59E0B;
    border-color: #F59E0B;
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
}

.echelon-icon-circle.e4 {
    color: #EF4444;
    border-color: #EF4444;
    box-shadow: 0 0 12px rgba(239, 68, 68, 0.4);
}

/* Подсветка столбца эшелона при клике */
.stocks-cell.column-highlight-1 {
    background: rgba(16, 185, 129, 0.12);
    border-color: rgba(16, 185, 129, 0.3);
}

.stocks-cell.column-highlight-2 {
    background: rgba(59, 130, 246, 0.12);
    border-color: rgba(59, 130, 246, 0.3);
}

.stocks-cell.column-highlight-3 {
    background: rgba(245, 158, 11, 0.12);
    border-color: rgba(245, 158, 11, 0.3);
}

.stocks-cell.column-highlight-4 {
    background: rgba(239, 68, 68, 0.12);
    border-color: rgba(239, 68, 68, 0.3);
}

body.dark-mode .stocks-cell.column-highlight-1 {
    background: rgba(16, 185, 129, 0.15);
}

body.dark-mode .stocks-cell.column-highlight-2 {
    background: rgba(59, 130, 246, 0.15);
}

body.dark-mode .stocks-cell.column-highlight-3 {
    background: rgba(245, 158, 11, 0.15);
}

body.dark-mode .stocks-cell.column-highlight-4 {
    background: rgba(239, 68, 68, 0.15);
}

/* Активный кружок эшелона */
.echelon-icon-circle.active {
    transform: scale(1.1);
    box-shadow: 0 0 20px currentColor;
}

.stocks-table-body {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.stocks-table-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2px;
    opacity: 0;
    animation: staggerIn 0.3s ease forwards;
}

.stocks-table-row:nth-child(1) { animation-delay: 0.1s; }
.stocks-table-row:nth-child(2) { animation-delay: 0.15s; }
.stocks-table-row:nth-child(3) { animation-delay: 0.2s; }
.stocks-table-row:nth-child(4) { animation-delay: 0.25s; }
.stocks-table-row:nth-child(5) { animation-delay: 0.3s; }
.stocks-table-row:nth-child(6) { animation-delay: 0.35s; }

/* Ячейка тикера - минималистичный стиль */
.stocks-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1px;
    padding: 8px 3px;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.04);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.25s ease;
}

body.dark-mode .stocks-cell {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.08);
}

.stocks-cell:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
    border-color: rgba(0, 0, 0, 0.08);
}

.stocks-cell:empty {
    background: transparent;
    border: none;
    cursor: default;
    backdrop-filter: none;
}

.stocks-cell:empty:hover {
    transform: none;
    box-shadow: none;
}

.stocks-cell-ticker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-deep);
}

.stocks-cell-change {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
}

.stocks-cell-change.positive { color: #10B981; }
.stocks-cell-change.negative { color: #EF4444; }
.stocks-cell-change.neutral { color: var(--text-muted); }

/* Ячейка активная */
.stocks-cell.active {
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

/* Карточка деталей тикера - ТИХАЯ РОСКОШЬ */
.stock-detail-card {
    display: none;
    margin: 6px 0;
    padding: 16px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: 14px;
    animation: accordionOpen 0.3s ease;
    position: relative;
}

body.dark-mode .stock-detail-card {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(255, 255, 255, 0.1);
}

.stock-detail-card.open {
    display: block;
}

/* Стрелочка закрытия карточки */
.stock-detail-close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.stock-detail-close:hover {
    background: rgba(0, 0, 0, 0.05);
}

.stock-detail-close svg {
    width: 14px;
    height: 14px;
    stroke: var(--text-muted);
    transition: stroke 0.2s ease, transform 0.2s ease;
    transform: rotate(180deg);
}

.stock-detail-close:hover svg {
    stroke: var(--text-deep);
}

.stock-detail-header {
    display: flex;
    justify-content: flex-start;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    padding-right: 30px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
}

body.dark-mode .stock-detail-header {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

.stock-detail-main {
    flex: 1;
}

.stock-detail-ticker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 800;
    color: var(--text-deep);
    margin-bottom: 4px;
}

.stock-detail-name {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-slate);
    margin-bottom: 6px;
}

.stock-detail-sector {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: var(--accent-blue);
    background: rgba(59, 130, 246, 0.1);
    padding: 4px 8px;
    border-radius: 6px;
}

.stock-detail-echelon {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 4px 10px;
    border-radius: 20px;
    white-space: nowrap;
}

.stock-detail-grid {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-bottom: 16px;
}

.stock-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
}

body.dark-mode .stock-detail-row {
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

.stock-detail-row:last-child {
    border-bottom: none;
}

.stock-detail-label {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
}

.stock-detail-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-deep);
}

.stock-detail-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.stock-btn {
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.stock-btn-chart {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
}

.stock-btn-chart:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.25);
}

.stock-btn-info {
    background: rgba(0, 0, 0, 0.04);
    color: var(--text-deep);
}

body.dark-mode .stock-btn-info {
    background: rgba(255, 255, 255, 0.08);
}

.stock-btn-info:hover {
    background: rgba(0, 0, 0, 0.08);
}

.stock-btn svg {
    width: 14px;
    height: 14px;
}

/* Ghost trigger для акций */
.stocks-ghost-trigger {
    margin: 20px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 10px;
    transition: opacity 0.3s;
}

.stocks-ghost-trigger:active {
    opacity: 0.6;
}

/* Скрытие строк */
.stocks-table-row.stocks-row-hidden {
    display: none !important;
}

        /* 3. ФИКС ПРЕВЬЮ РЕБАЛАНСИРОВКИ (Luxury Glow) */
.rebalance-preview-box, .rebalance-intro-modern {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important;
    border-radius: 20px !important;
    padding: 25px !important;
    color: white !important;
    box-shadow: 0 15px 35px rgba(30, 58, 138, 0.3) !important;
    border: none !important;
}





/* ЭЛЕГАНТНАЯ СВЯЗКА (ТОЧКИ) */
.ofz-lux-bridge {
    flex-grow: 1;
    border-bottom: 1px dotted rgba(0,0,0,0.15);
    margin: 0 12px;
    position: relative;
    top: -4px;
}
.dark-mode .ofz-lux-bridge { border-bottom-color: rgba(255,255,255,0.15); }

.ofz-lux-right {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
}
.ofz-lux-yield {
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 14px;
    font-weight: 700;
    color: var(--accent-green);
    width: 55px;
    text-align: right;
}
.ofz-price-pill {
    background: rgba(0,0,0,0.05);
    padding: 4px 10px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}
.dark-mode .ofz-price-pill { background: rgba(255,255,255,0.08); }

/* 5. ДЕТАЛИ И КНОПКА */
.copy-code-blue {
    color: #3498db;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    cursor: pointer;
}
.btn-luxury-chart {
    width: 100%;
    margin-top: 20px;
    padding: 14px;
    background: transparent;
    border: 1px solid rgba(52, 152, 219, 0.3);
    border-radius: 14px;
    color: var(--accent-blue);
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
         /* ==================================================================== */

        /* Дисплей значений - Минимализм */
.custom-value-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 0;
    background: transparent;
    margin-bottom: 0;
}

.custom-value-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.custom-value-bonds, .custom-value-stocks {
    font-family: 'JetBrains Mono', monospace;
    font-size: 48px;
    font-weight: 300; /* Тонкий шрифт = дорого */
    line-height: 1;
    letter-spacing: -0.04em;
}

.custom-value-bonds { color: #5B7C99; }
.custom-value-stocks { color: #94A8B8; }

.custom-value-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #A0AEC0;
    margin-top: 6px;
}

.custom-value-divider {
    font-size: 32px;
    font-weight: 200;
    color: #CBD5E1;
    margin-top: -15px;
}

/* Слайдер "Нить" */
.custom-slider-block {
    margin: 30px 0;
    position: relative;
    height: 30px;
    display: flex;
    align-items: center;
}

.custom-ratio-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 2px; /* Очень тонкая линия */
    background: #E2E8F0;
    outline: none;
    border-radius: 1px;
    z-index: 2;
    position: relative;
}

.custom-ratio-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #FFFFFF;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); /* Мягкая тень */
    cursor: pointer;
    transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.custom-ratio-slider::-webkit-slider-thumb:active {
    transform: scale(1.15);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

/* Кнопки +/- в стиле Soft UI */
.custom-controls-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 25px;
}

.custom-adjust-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #FFFFFF;
    border: 1px solid #F1F5F9;
    color: #2C364C;
    font-size: 24px;
    font-weight: 300;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
    transition: all 0.2s;
    margin-top: 2px; /* Центрируем по середине цифр (48px высота цифр, 44px кнопка) */
    flex-shrink: 0;
}

.custom-adjust-btn:active {
    transform: scale(0.92);
    background: #F8FAFC;
}

/* Кнопки действий - Премиум */
.custom-actions-row {
    display: flex;
    gap: 12px;
}

/* Кнопка сброса - минимализм */
.custom-reset-btn {
    flex: 1;
    padding: 16px;
    background: transparent;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 16px;
    color: #94A3B8;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.custom-reset-btn:hover {
    background: rgba(0,0,0,0.02);
    color: #64748B;
}

/* Кнопка Готово - Глубокий Графит */
.custom-done-btn {
    flex: 1.5; /* Чуть шире */
    padding: 16px;
    background: #2C364C; /* Luxury Graphite */
    border: none;
    border-radius: 16px;
    color: white;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.05em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 10px 25px rgba(44, 54, 76, 0.25); /* Тень в цвет */
    transition: all 0.2s;
}

.custom-done-btn:active {
    transform: scale(0.98);
    box-shadow: 0 5px 15px rgba(44, 54, 76, 0.2);
}

/* Развернутый блок настройки */
.custom-strategy-expanded {
    max-height: 0;
    overflow: hidden;
    background: transparent;
    border: none;
    margin-top: 10px;
    transition: max-height 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    padding: 0;
}

.custom-strategy-expanded.show {
    max-height: 400px;
}

.custom-strategy-inner {
    overflow: hidden;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
}

/* Темная тема */
.dark-mode .custom-strategy-inner {
    background: rgba(30, 41, 59, 0.4);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .custom-adjust-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #F1F5F9;
}

.dark-mode .custom-value-bonds { color: #38BDF8; }
.dark-mode .custom-value-stocks { color: #94A3B8; }
.dark-mode .custom-done-btn { background: #38BDF8; color: #0F172A; box-shadow: 0 10px 25px rgba(56, 189, 248, 0.2); }
          /* ==================================================================== */

   /* === Строка ИТОГО (Фон как у эшелонов + меньше отступ) === */
.portfolio-echelons-total-row {
    display: grid;
    grid-template-columns: 1fr 110px 60px; 
    gap: 8px;
    padding: 12px 16px;
    
    /* 1. УМЕНЬШИЛ ОТСТУП (было 35px -> стало 20px) */
    margin-top: 20px; 
    margin-bottom: 25px;
    
    /* 2. ФОН КАК У ЭШЕЛОНОВ (Стеклянный эффект) */
    background: var(--card-glass-aurora);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    
    /* Рамка Smart Replace (темно-синяя) */
    border: 1px solid #1e293b; 
    border-radius: 16px;
    
    align-items: center;
    box-shadow: 0 8px 20px rgba(30, 41, 59, 0.1);
}

/* ... (Внутренние элементы остаются без изменений, но убедитесь, что они есть) ... */
.total-left { display: flex; align-items: center; gap: 10px; overflow: hidden; }
.total-icon {
    min-width: 32px; width: 32px; height: 32px; border-radius: 8px;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); /* Фон иконки */
    display: flex; align-items: center; justify-content: center;
    color: white; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.3);
}
.total-icon svg { width: 18px; height: 18px; }
.total-label {
    font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800;
    color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px;
    white-space: nowrap;
}
.total-value-col { text-align: right; padding-right: 5px; }
.total-sum {
    font-family: 'JetBrains Mono', monospace; font-size: 13px;
    font-weight: 800; color: var(--text-main); display: block;
}
.total-percent-col { text-align: right; }
.total-percent {
    font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); /* Фон процента */
    color: white; padding: 4px 6px; border-radius: 6px;
    display: inline-block; box-shadow: 0 2px 5px rgba(15, 23, 42, 0.2);
}

/* Темная тема */
body.dark-mode .portfolio-echelons-total-row {
    /* Фон автоматически подтянется из переменной var(--card-glass-aurora) для темной темы */
    border-color: #334155; /* Светлее, чтобы рамка была видна на темном фоне */
}
        /* ==================================================================== */

        /* === Итоговая строка внутри Эшелона === */
.portfolio-echelon-total-line {
    display: flex;
    align-items: center;
    justify-content: flex-end; /* Прижимаем всё вправо */
    gap: 12px; /* Расстояние между словом ИТОГО и цифрой */
    
    padding: 12px 16px; /* Такой же отступ как у строк, чтобы выровняться */
    margin-top: 4px;
    
    /* Линия в стиле дизайна */
    border-top: 1px solid var(--item-border);
}

.echelon-total-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.echelon-total-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px; /* Чуть крупнее обычных цифр */
    font-weight: 700;
    color: var(--text-main);
    text-align: right;
    /* Мин. ширина не нужна, если выравнивание справа, но можно добавить для страховки */
}
         /* ==================================================================== */

        /* Кнопка Info в заголовке */
.info-trigger-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--text-main);
    width: 36px;
    height: 36px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transform: scale(0.8);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Класс видимости (добавляется JS) */
.info-trigger-btn.visible {
    opacity: 1;
    pointer-events: all;
    transform: scale(1);
}

.dark-mode .info-trigger-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

/* Затемнение фона (Backdrop) */
/* --- СТИЛИ ДЛЯ ШТОРКИ (Вставить в основной CSS) --- */

/* Фон шторки */
.info-modal-backdrop {
    /* Фиксируем относительно окна браузера */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw; /* На всю ширину окна */
    height: 100vh; /* На всю высоту окна */
    z-index: 999999; /* Самый высокий слой */
    
    /* Скрыто по умолчанию */
    display: none; 
    opacity: 0;
    
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    
    /* Выравнивание содержимого */
    align-items: flex-end; /* Прижать к низу */
    justify-content: center;
    
    transition: opacity 0.3s ease;
}

/* Активное состояние (когда открыто) */
.info-modal-backdrop.active {
    opacity: 1;
}

/* Сама белая/темная карточка */
.info-modal-content {
    width: 100%;
    max-width: 500px;
    background: #1c1c1e;
    border-radius: 24px 24px 0 0;
    padding: 24px;
    padding-bottom: 40px; /* Safe area снизу */
    
    /* Начальное положение - сдвинуто вниз */
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    max-height: 85vh;
    overflow-y: auto;
    color: white;
    border-top: 1px solid rgba(255,255,255,0.1);
}

/* Когда активно - карточка выезжает */
.info-modal-backdrop.active .info-modal-content {
    transform: translateY(0);
}
    * Фиксы для текста внутри */
.echelon-explain-name { color: white !important; }
.echelon-explain-desc { color: #aaa !important; }
.info-modal-header h3 { color: white !important; margin: 0; }
.close-modal-btn { background: none; border: none; font-size: 28px; color: #888; cursor: pointer;}

/* Кнопка закрытия */
.close-modal-btn {
    background: none;
    border: none;
    color: #888;
    font-size: 28px;
    padding: 0;
    cursor: pointer;
}
/* Карточки внутри */
.info-card {
    background: rgba(0,0,0,0.03);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}
.dark-mode .info-card { background: rgba(255,255,255,0.05); }

.info-icon {
    width: 40px; height: 40px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
}

.info-text h4 {
    margin: 0 0 6px 0;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
}
.info-text p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 12px;
    line-height: 1.5;
}


        /* --- Стили для контента внутри модалки --- */

/* Контейнер списка */
.echelon-explain-list {
    display: flex;
    flex-direction: column;
    gap: 16px; /* Отступ между карточками */
}

/* Карточка одного эшелона */
#rebalance-info-modal .echelon-explain-item {
    display: flex;
    align-items: flex-start; /* Выравнивание по верху */
    gap: 14px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03); /* Очень легкий фон */
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* --- ВАШИ ИКОНКИ (Строго 28px) --- */
#rebalance-info-modal .echelon-explain-badge {
    width: 28px;        /* Точный размер */
    height: 28px;       /* Точный размер */
    min-width: 28px;    /* Чтобы не сжимались */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 800;
    background: #fff;   /* Белый фон кружка */
    color: #000;        /* Черная цифра */
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    margin-top: 2px;    /* Чуть опустить для визуального центра с текстом */
}

/* Цветовые акценты (если нужно) */
/* Если у вас в CSS уже есть цвета для .e1, .e2 - они подтянутся. 
   Если нет - раскомментируйте код ниже, чтобы кружки были цветными: */

/*
#rebalance-info-modal .e1 { border: 2px solid #4CAF50; color: #4CAF50; background: #fff; }
#rebalance-info-modal .e2 { border: 2px solid #2196F3; color: #2196F3; background: #fff; }
#rebalance-info-modal .e3 { border: 2px solid #FF9800; color: #FF9800; background: #fff; }
#rebalance-info-modal .e4 { border: 2px solid #F44336; color: #F44336; background: #fff; }
*/

/* Текстовая часть */
#rebalance-info-modal .echelon-explain-name {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--text-main, #fff);
    margin-bottom: 4px;
}

#rebalance-info-modal .echelon-explain-desc {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    line-height: 1.4;
    color: var(--text-secondary, #aaa); /* Серый цвет описания */
}
         /* ==================================================================== */

    /* === НИЖНИЕ БЛОКИ В ШТОРКЕ === */

/* ==============================================
   ФИНАЛЬНЫЕ СТИЛИ ДЛЯ НИЖНИХ БЛОКОВ (FIX)
   ============================================== */

/* 1. Блок "ВАЖНО" (Зеленый) - Делаем прозрачным */
.portfolio-important-aurora {
    /* Оригинальный glassmorphism фон */
    background: var(--card-glass-aurora) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    
    /* Жёлтая рамка вокруг всего блока */
    border: 1px solid rgba(251, 191, 36, 0.2) !important;
    border-radius: 16px !important;
    
    /* Отступы */
    padding: 18px !important;
    margin-top: 24px !important;
    
    display: flex !important;
    gap: 16px !important;
    align-items: flex-start !important;
}

/* Элементы внутри блока "Важно" */
.important-aurora-icon {
    color: #F59E0B !important;
    width: 24px; 
    height: 24px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    margin-top: 2px;
}
.important-aurora-title {
    color: #F59E0B !important;
    font-weight: 700; 
    font-size: 13px; 
    text-transform: uppercase; 
    margin-bottom: 4px;
    font-family: 'Inter', sans-serif !important;
}
.important-aurora-text {
    color: #aaa !important; /* Серый текст */
    font-size: 13px !important; 
    line-height: 1.5 !important;
    font-family: 'Inter', sans-serif !important;
}


/* 2. Блок "РЕБАЛАНСИРОВКА" (Синий) - Возвращаем рамку */
.info-rebalance-block {
    margin-top: 24px !important;
    padding: 16px !important;
    
    /* Фон и РАМКА */
    background: rgba(59, 130, 246, 0.1) !important;
    border: 1px solid rgba(59, 130, 246, 0.3) !important; /* Явная рамка */
    border-radius: 16px !important;
    
    /* Текст */
    color: #fff !important;
    font-size: 12px !important;
    line-height: 1.5 !important;
    font-family: 'JetBrains Mono', monospace !important;
}

/* Жирный текст внутри синего блока */
.info-rebalance-block b {
    color: #60A5FA !important;
    font-weight: 700 !important;
}

/* 2. Блок "РЕБАЛАНСИРОВКА" (Синий) - Возвращаем его */
.info-rebalance-block {
    margin-top: 24px !important;
    padding: 16px !important;
    background: rgba(59, 130, 246, 0.1) !important; /* Синий фон */
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    border-radius: 16px !important;
    color: #fff !important;
    font-size: 12px !important;
    line-height: 1.5 !important;
    font-family: 'JetBrains Mono', monospace !important;
}
.info-rebalance-block b { color: #60A5FA !important; }

/* 3. Подсказка "%" (Растягиваем как строку) */
/* === ПОДСКАЗКА ДЛЯ % (ФИНАЛ) === */
#echelonPercentTooltip {
    /* Используем стили yield-help-tooltip */
}

#echelonPercentTooltip.show {
    display: block !important;
}
        /* ==================================================================== */

/* === ГАРАНТИРОВАННОЕ УМЕНЬШЕНИЕ (EVOLUTION V3) === */

/* 1. Сжимаем саму карточку (через ID для силы) */
#shareContainer.portfolio-capital-card {
    padding: 14px 16px !important; /* Еще компактнее */
    min-height: auto !important;
    margin-bottom: 15px !important;
}

/* 2. Верхняя часть (Цифры капитала) */
#shareContainer .capital-top-row {
    margin-bottom: 8px !important; /* Убрали лишний воздух */
    align-items: center !important;
}

#shareContainer .capital-value {
    font-size: 26px !important; /* Аккуратный размер */
    margin-top: 2px !important;
}

#shareContainer .capital-label {
    font-size: 9px !important;
    opacity: 0.6 !important;
}

#shareContainer .capital-fee-badge {
    padding: 2px 6px !important;
    font-size: 9px !important;
}

/* 3. Линия распределения (Ультра-тонкая) */
#shareContainer .capital-distribution {
    margin-bottom: 8px !important;
}

#shareContainer .capital-bar {
    height: 2px !important; /* Тонкая "лазерная" линия */
    border-radius: 1px !important;
    margin-bottom: 6px !important;
    background: rgba(255, 255, 255, 0.05) !important;
}

#shareContainer .capital-label-text {
    display: none !important; /* Скрываем слова "ОФЗ" и "Акции", оставляем точки */
}

#shareContainer .capital-label-pct {
    font-size: 10px !important;
    opacity: 0.8 !important;
}

#shareContainer .capital-labels {
    margin-top: 4px !important;
}

/* 4. Разделитель */
#shareContainer .capital-divider {
    display: none !important; /* Убираем линию-разделитель совсем */
}

/* 5. Блок Прогноза (Мини-футер) */
#shareContainer .capital-forecast {
    margin-top: 4px !important;
    padding: 8px 10px !important; /* Очень компактно */
    background: rgba(255, 255, 255, 0.03) !important; /* Едва заметный фон */
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    border-radius: 10px !important;
    flex-direction: row !important; /* В одну строку */
    align-items: center !important;
    justify-content: space-between !important;
}

/* Скрываем большую иконку прогноза */
#shareContainer .forecast-icon-mini {
    display: none !important;
}

/* Компактный текст прогноза */
#shareContainer .forecast-content-mini {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    width: 100% !important;
}

#shareContainer .forecast-title-mini {
    display: none !important; /* Скрываем заголовок "Прогноз через 3 года" */
}

#shareContainer .forecast-main-row {
    margin-bottom: 0 !important;
    gap: 8px !important;
}

#shareContainer .forecast-total-mini {
    font-size: 13px !important;
    color: var(--text-secondary) !important; /* Серый цвет для "Прогноз:" */
}
/* Добавляем слово "Прогноз" перед суммой через CSS */
#shareContainer .forecast-total-mini::before {
    content: 'Прогноз 3г: ';
    font-family: 'Inter', sans-serif;
    font-weight: 500;
    opacity: 0.7;
}

#shareContainer.sharing-mode .forecast-percent-change {
    font-size: 11px !important;
    padding: 2px 6px !important;
    background: transparent !important;
}


#shareContainer.sharing-mode .forecast-details-mini {
    display: none !important; /* Скрываем детали (купоны/рост) только при генерации PDF */
}

    
    </style>
</head>
<body class="home-mode" onclick="hideAllTips(event)">

<div id="toast" class="toast">Скопировано!</div>

<div id="screen-stub" class="screen" style="
    margin: -16px; 
    padding: 20px 16px 0 16px; 
    min-height: 100vh; 
    position: relative; 
    box-sizing: border-box;
">
    
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>

    <div class="header">
        <h1>Мои Активы</h1>
    </div>

    <div style="
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        height: 55vh; /* Чуть поднял, чтобы визуально было по центру рабочей зоны */
        text-align: center; 
        position: relative; 
        z-index: 2;
    ">
        
        <div class="empty-icon" style="margin-bottom: 20px;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
        </div>

        <div style="
            font-family: 'Inter', sans-serif; 
            font-size: 20px; 
            font-weight: 700; 
            margin-bottom: 8px; 
            color: var(--text-deep, #fff);
        ">
            Скоро здесь
        </div>
        
        <div class="empty-text" style="max-width: 300px; margin: 0 auto;">
            Реальные активы из вашего брокерского счета будут отображаться здесь автоматически
        </div>

    </div>
</div>

    <div id="screen-home" class="screen active">
    <!-- Aurora Background -->
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>
    
    <div class="welcome-screen">
        <div class="welcome-logo-block">
            <span class="welcome-supratitle">W E A L T H &nbsp; M A N A G E M E N T</span>
            <h1 class="welcome-title">
                <span class="welcome-title-light">Madame </span><span class="welcome-title-bold">Solomi'na</span>
            </h1>
            <div class="welcome-divider"></div>
            <span class="welcome-subtitle">ЧАСТНЫЙ ИНВЕСТИЦИОННЫЙ<br>TERMINAL</span>
            

        </div>
        
        <div class="welcome-cta-block">
            <button class="btn-welcome" onclick="event.stopPropagation(); openTerminalOrRegister();">
            ОТКРЫТЬ Terminal
        </button>
            <div class="welcome-secure-text">
                <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Secure Biometric Access
            </div>
        </div>
    </div>
</div>

<!-- ========== REGISTRATION SCREEN ========== -->
<div id="screen-register" class="screen">
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>

    <button class="reg-back-btn" onclick="showScreen('screen-home')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg>
    </button>

    <div class="reg-header">
        <div class="reg-supratitle">R E G I S T R A T I O N</div>
        <h1 class="reg-title">Создание аккаунта</h1>
        <p class="reg-subtitle">Заполните данные для доступа к Terminal</p>
    </div>

    <div class="reg-form">
        <!-- Имя и Фамилия -->
        <div class="reg-section">
            <div class="reg-section-label">Личные данные</div>
            <div class="reg-input-group">
                <input type="text" class="reg-input" id="regFirstName" placeholder="Имя" autocomplete="off">
            </div>
            <div class="reg-input-group">
                <input type="text" class="reg-input" id="regLastName" placeholder="Фамилия" autocomplete="off">
            </div>
        </div>

        <!-- Выбор брокера — аккордеон -->
        <div class="reg-section">
            <div class="reg-section-label">Выберите брокера</div>
            
            <!-- Главная карточка (выбранный брокер) -->
            <div class="strategy-perspective-wrapper" style="margin-top:0;">
                <div class="broker-main-card" id="brokerMainCard" onclick="toggleBrokerList()">
                    <div class="broker-card-left">
                        <div class="broker-logo-placeholder" id="brokerMainLogo">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                        </div>
                        <div class="broker-info">
                            <div class="broker-name" id="brokerMainName">Выберите брокера</div>
                        </div>
                    </div>
                    <div class="broker-main-arrow" id="brokerMainArrow">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>
                
                <!-- Waterfall dropdown -->
                <div class="waterfall-container" id="brokerWaterfall">
                    <div class="waterfall-inner">
                        <div class="strategy-option-card" data-broker="t-invest" onclick="selectBrokerWaterfall(this, 't-invest', 'Т-Инвестиции', 't-invest')">
                            <div class="broker-card-left">
                                <div class="broker-logo t-invest"><svg viewBox="0 0 24 24"><path d="M4 7h16M12 7v13" stroke="#1A1A1A"/></svg></div>
                                <div class="broker-info"><div class="broker-name">Т-Инвестиции</div></div>
                            </div>
                            <div class="broker-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                        </div>
                        <div class="strategy-option-card" data-broker="alor" onclick="selectBrokerWaterfall(this, 'alor', 'АЛОР Брокер', 'alor')">
                            <div class="broker-card-left">
                                <div class="broker-logo alor"><svg viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2z" stroke="white"/><line x1="8" y1="16" x2="16" y2="16" stroke="white"/></svg></div>
                                <div class="broker-info"><div class="broker-name">АЛОР Брокер</div></div>
                            </div>
                            <div class="broker-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                        </div>
                        <div class="strategy-option-card" data-broker="finam" onclick="selectBrokerWaterfall(this, 'finam', 'Финам', 'finam')">
                            <div class="broker-card-left">
                                <div class="broker-logo finam"><svg viewBox="0 0 24 24"><path d="M3 17l4-8 4 4 4-6 6 10" stroke="white"/></svg></div>
                                <div class="broker-info"><div class="broker-name">Финам</div></div>
                            </div>
                            <div class="broker-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                        </div>
                        <div class="strategy-option-card" data-broker="bcs" onclick="selectBrokerWaterfall(this, 'bcs', 'БКС', 'bcs')">
                            <div class="broker-card-left">
                                <div class="broker-logo bcs"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="3" stroke="white"/><path d="M9 12h6M12 9v6" stroke="white"/></svg></div>
                                <div class="broker-info"><div class="broker-name">БКС</div></div>
                            </div>
                            <div class="broker-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                        </div>
                        <div class="strategy-option-card" data-broker="alfa" onclick="selectBrokerWaterfall(this, 'alfa', 'Альфа-Инвестиции', 'alfa')">
                            <div class="broker-card-left">
                                <div class="broker-logo alfa"><svg viewBox="0 0 24 24"><path d="M12 3l-8 18h4l2-5h8l2 5h4L12 3z" stroke="white"/><line x1="9" y1="14" x2="15" y2="14" stroke="white"/></svg></div>
                                <div class="broker-info"><div class="broker-name">Альфа-Инвестиции</div></div>
                            </div>
                            <div class="broker-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Выбор подписки -->
        <div class="reg-section">
            <div class="reg-section-label">Тарифный план</div>
            <div class="plan-cards" id="planCards">
                <div class="plan-card selected" data-plan="trial" onclick="selectPlan(this)">
                    <div class="plan-card-inner">
                        <div class="plan-card-top">
                            <div class="plan-name">Пробный</div>
                            <span class="plan-badge free">Бесплатно</span>
                            <div class="plan-radio"></div>
                        </div>
                        <div class="plan-price">0 ₽ <span>/ 3 месяца</span></div>
                        <div class="plan-features">
                            <span class="plan-feature-pill">Полный доступ</span>
                            <span class="plan-feature-pill">90 дней</span>
                            <span class="plan-feature-pill">Все функции</span>
                        </div>
                        <div class="plan-detail">Полный доступ ко всем функциям терминала на 90 дней</div>
                    </div>
                </div>
                <div class="plan-card" data-plan="monthly" onclick="selectPlan(this)">
                    <div class="plan-card-inner">
                        <div class="plan-card-top">
                            <div class="plan-name">Ежемесячная</div>
                            <span class="plan-badge popular">Популярная</span>
                            <div class="plan-radio"></div>
                        </div>
                        <div class="plan-price">5 000 ₽ <span>/ месяц</span></div>
                        <div class="plan-features">
                            <span class="plan-feature-pill">Ребалансировка</span>
                            <span class="plan-feature-pill">API брокера</span>
                            <span class="plan-feature-pill">Аналитика</span>
                        </div>
                        <div class="plan-detail">Идеально если есть портфель и нужна ребалансировка</div>
                    </div>
                </div>
                <div class="plan-card" data-plan="yearly" onclick="selectPlan(this)">
                    <div class="plan-card-inner">
                        <div class="plan-card-top">
                            <div class="plan-name">Годовая</div>
                            <span class="plan-badge best">-50%</span>
                            <div class="plan-radio"></div>
                        </div>
                        <div class="plan-price">30 000 ₽ <span>/ год</span></div>
                        <div class="plan-savings">
                            <svg viewBox="0 0 24 24"><path d="M23 6l-9.5 9.5-5-5L1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                            Экономия 30 000 ₽ — всего 2 500 ₽/мес
                        </div>
                        <div class="plan-features">
                            <span class="plan-feature-pill">Всё из «Ежемесячной»</span>
                            <span class="plan-feature-pill">Приоритет</span>
                        </div>
                        <div class="plan-detail">Максимальная экономия — 2 500 ₽/мес вместо 5 000 ₽</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="reg-submit-wrapper">
        <div class="reg-loading" id="regLoading">
            <div class="reg-spinner"></div>
            <span class="reg-loading-text">Создаём аккаунт...</span>
        </div>
        <button class="btn-register" id="btnRegister" onclick="submitRegistration()">
            Создать аккаунт
        </button>
    </div>
</div>

<!-- ========== DASHBOARD SCREEN ========== -->
<div id="screen-dashboard" class="screen">
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>

    <!-- Compact Hero: Name + Status aligned left -->
    <div class="dash-hero" id="dashHero">
        <div class="dash-hero-left">
            <div class="dash-greeting">terminal solomi'na</div>
            <h1 class="dash-user-name">
                <span class="light" id="dashFirstName">—</span> <span class="bold" id="dashLastName">—</span>
            </h1>
            <div class="dash-date-pill" id="dashDatePill"></div>
        </div>
        <div class="dash-status-pill" id="dashStatusPill">
            <div class="dash-status-dot"></div>
            <span class="dash-status-text" id="dashStatusText">Active</span>
        </div>
    </div>

    <!-- DASHBOARD CONTENT — CLEAR HIERARCHY -->
    <div class="dash-content">

        <!-- 1. HERO CTA — главное действие, самый заметный элемент -->
        <div class="dash-hero-cta" onclick="showScreen('screen-app')">
            <div class="dash-hero-cta-left">
                <div class="dash-hero-cta-icon">
                    <svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                </div>
                <div class="dash-hero-cta-text">
                    <div class="dash-hero-cta-title">Рассчитать портфель</div>
                    <div class="dash-hero-cta-sub">Облигации, акции, стратегии</div>
                </div>
            </div>
            <div class="dash-hero-cta-arrow">
                <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
        </div>

        <!-- BENTO GRID -->
        <div class="bento-grid" style="margin-top:16px;">

            <!-- 1. SECONDARY ACTIONS — Активы + Ребаланс -->
            <div class="bento-cell bento-action glow-green" onclick="showScreen('screen-stub')">
                <div class="bento-action-icon green">
                    <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div>
                <div>
                    <div class="bento-action-label">Мои активы</div>
                    <div class="bento-action-sub">Портфель и позиции</div>
                </div>
            </div>

            <div class="bento-cell bento-action glow-orange" onclick="showScreen('screen-assets', true)">
                <div class="bento-action-icon orange">
                    <svg viewBox="0 0 24 24"><path d="M23 6l-9.5 9.5-5-5L1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                </div>
                <div>
                    <div class="bento-action-label">Ребаланс</div>
                    <div class="bento-action-sub">Корректировка долей</div>
                </div>
            </div>

            <!-- 2. Интересное + Подписка -->
            <div class="bento-cell bento-action glow-purple" onclick="showScreen('screen-interesting')">
                <div class="bento-action-icon purple">
                    <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                </div>
                <div>
                    <div class="bento-action-label">Интересное</div>
                    <div class="bento-action-sub">Новости и аналитика</div>
                </div>
            </div>

            <div class="bento-cell bento-sub-mini" onclick="openSubFromBento()">
                <div class="bento-sub-top">
                    <span class="bento-sub-plan" id="bentoSubPlan">Trial</span>
                    <span class="bento-sub-badge" id="bentoSubBadge">Active</span>
                </div>
                <div class="bento-sub-bottom">
                    <div class="bento-sub-date-col">
                        <span class="bento-sub-date-lbl">Действует до</span>
                        <span class="bento-sub-date-val" id="bentoSubEnd">—</span>
                    </div>
                    <div class="bento-sub-arrow">
                        <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- PORTFOLIO RING — закомментирован, для будущего раздела "Мои активы" -->
        <!--
        <div class="bento-cell bento-portfolio-ring" onclick="window.isPortfolioCalculated ? showScreen('screen-assets', true) : showScreen('screen-app')">
            <div class="bento-ring-wrap">
                <canvas id="bentoRingCanvas" width="160" height="160"></canvas>
                <div class="bento-ring-center">
                    <div class="bento-ring-pct" id="bentoRingPct">—</div>
                    <div class="bento-ring-label">облигации</div>
                </div>
            </div>
            <div class="bento-ring-legend">
                <div class="bento-legend-item">
                    <div class="bento-legend-dot" style="background:#3B82F6;"></div>
                    <span class="bento-legend-text">ОФЗ</span>
                </div>
                <div class="bento-legend-item">
                    <div class="bento-legend-dot" style="background:#10B981;"></div>
                    <span class="bento-legend-text">Акции</span>
                </div>
            </div>
        </div>
        -->

        <!-- Settings Section — Revolutionary Grouped Card -->
        <div class="dash-section">
            <div class="dash-section-header">
                <span class="dash-section-title">Настройки</span>
            </div>

            <div class="dash-settings-group">
                <!-- Row 1: Подписка -->
                <div class="dash-settings-row" id="dsRowSub" onclick="toggleSettingsPanel('dsPanelSub', this)">
                    <div class="ds-icon blue">
                        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    </div>
                    <div class="ds-row-content">
                        <div class="ds-row-title">Подписка</div>
                        <div class="ds-row-subtitle" id="dsSubHint">Управление тарифом</div>
                    </div>
                    <div class="ds-row-right">
                        <span class="ds-row-badge" id="dsSubBadge">Active</span>
                        <div class="ds-chevron">
                            <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Expandable: Subscription panel -->
                <div class="ds-expand-panel" id="dsPanelSub">
                    <div class="dash-sub-card" id="dashSubCard">
                        <div class="dash-sub-card-row">
                            <span class="dash-sub-plan" id="dashSubPlan">Trial</span>
                            <span class="dash-sub-badge" id="dashSubBadge">Active</span>
                        </div>
                        <div class="dash-sub-dates">
                            <div class="dash-sub-date-block">
                                <span class="dash-sub-date-label">Начало</span>
                                <span class="dash-sub-date-value" id="dashSubStart">—</span>
                            </div>
                            <div class="dash-sub-date-block">
                                <span class="dash-sub-date-label">Действует до</span>
                                <span class="dash-sub-date-value" id="dashSubEnd">—</span>
                            </div>
                        </div>
                    </div>
                    <div class="reg-section-label" style="margin-top:4px;">Изменить план</div>
                    <div class="dash-plan-options" id="dashPlanOptions">
                        <div class="dash-plan-option" data-plan="trial" onclick="changePlan('trial')">
                            <span class="dash-plan-option-name">Пробный</span>
                            <span class="dash-plan-option-price">0 ₽ / 3 мес</span>
                        </div>
                        <div class="dash-plan-option" data-plan="monthly" onclick="changePlan('monthly')">
                            <span class="dash-plan-option-name">Ежемесячная</span>
                            <span class="dash-plan-option-price">5 000 ₽ / мес</span>
                        </div>
                        <div class="dash-plan-option" data-plan="yearly" onclick="changePlan('yearly')">
                            <span class="dash-plan-option-name">Годовая</span>
                            <span class="dash-plan-option-price">30 000 ₽ / год</span>
                        </div>
                    </div>
                </div>

                <!-- Row 2: API Token -->
                <div class="dash-settings-row" id="dsRowToken" onclick="toggleSettingsPanel('dsPanelToken', this)">
                    <div class="ds-icon orange">
                        <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                    <div class="ds-row-content">
                        <div class="ds-row-title">API токен</div>
                        <div class="ds-row-subtitle">Подключение к брокеру</div>
                    </div>
                    <div class="ds-row-right">
                        <span class="ds-row-value" id="dsTokenStatus">Не задан</span>
                        <div class="ds-chevron">
                            <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Expandable: Token panel -->
                <div class="ds-expand-panel" id="dsPanelToken">
                    <div class="reg-section-label" style="margin-top:12px;">Ваш API токен</div>
                    <div class="dash-token-input-wrap">
                        <input type="password" class="dash-token-input" id="dashTokenInput" placeholder="Вставьте токен...">
                        <button class="dash-token-save-btn" onclick="saveApiToken()">Сохранить</button>
                    </div>

                    <div class="dash-instruction" id="brokerInstruction">
                        <div class="dash-instruction-title">Как получить токен</div>
                        <div class="dash-instruction-step" id="brokerInstructionText">
                            <strong>1.</strong> Войдите в личный кабинет вашего брокера<br>
                            <strong>2.</strong> Перейдите в раздел «Настройки» → «API»<br>
                            <strong>3.</strong> Создайте новый токен с правами «Только чтение»<br>
                            <strong>4.</strong> Скопируйте и вставьте токен выше
                        </div>
                    </div>
                </div>

                <!-- Row 3: Тёмная тема (toggle) -->
                <div class="dash-settings-row" onclick="toggleTheme(); if(window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.selectionChanged();">
                    <div class="ds-icon slate">
                        <svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </div>
                    <div class="ds-row-content">
                        <div class="ds-row-title">Тёмная тема</div>
                        <div class="ds-row-subtitle" id="dsThemeHint">Переключить оформление</div>
                    </div>
                    <div class="ds-row-right">
                        <div class="ds-theme-toggle" id="dsThemeToggle">
                            <div class="ds-theme-toggle-knob"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden profile data elements for JS -->
    <span id="dashProfileName" style="display:none"></span>
    <span id="dashProfileTg" style="display:none"></span>
    <span id="dashProfileBroker" style="display:none"></span>
    <span id="dashProfileDate" style="display:none"></span>
</div>

<!-- Toast for dashboard operations -->
<div class="dash-toast" id="dashToast">Сохранено</div>

   <div id="screen-app" class="screen">
    <!-- Aurora Background -->
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>
    
    <!-- Terminal Header -->
    <div class="terminal-header-v2">
        <div class="terminal-title-main">Расчет</div>
        <div class="terminal-subtitle">MADAME SOLOMI'NA • SMART WEALTH</div>
    </div>

    <div class="calc-box" id="calcSection">
        <!-- Ввод суммы -->
        <div class="input-container">

            
                                              <!-- ВЕСЬ БЛОК В ОДНУ СТРОКУ, ЧТОБЫ УБРАТЬ ОТСТУПЫ -->
           <div class="input-wrapper" onclick="document.getElementById('sumInput').focus()" style="display: flex; justify-content: center; align-items: center; width: 100%;"><input type="text" id="sumInput" placeholder="ВВЕДИТЕ СУММУ" oninput="formatSumInput(this)" onfocus="onSumInputFocus(this)" onblur="onSumInputBlur(this)" onclick="event.stopPropagation(); this.select()" onkeyup="if(event.keyCode===13) this.blur()" inputmode="numeric" enterkeyhint="done"><div id="customCursor" class="custom-cursor"></div><span class="currency" id="currencySymbol">₽</span><span class="currency-placeholder" id="currencyPlaceholder">₽</span></div>

            
            </div>


        
       
     <!-- Блок комиссии (Quiet Luxury Fixed) -->
<div class="fee-selector-unified" style="position: relative; z-index: 200;">
    <div class="fee-unified-wrapper">
        <span class="fee-unified-label">Комиссия Вашего Брокера</span>
        
        <div class="fee-unified-trigger" id="feeDropdownTrigger" onclick="event.stopPropagation(); toggleFeeDropdown()">
            <span class="fee-selected-text placeholder" id="feeSelectedText">Выбрать</span>
            <svg class="fee-dropdown-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </div>
    </div>
    
    <!-- Меню с принудительными стилями для теста -->
    <div class="fee-dropdown-menu" id="feeDropdownMenu">
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.0001, '0.01%', '')">
            <span class="fee-item-rate">0.01%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.0003, '0.03%', '')">
            <span class="fee-item-rate">0.03%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.0005, '0.05%', '')">
            <span class="fee-item-rate">0.05%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.001, '0.1%', '')">
            <span class="fee-item-rate">0.1%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.003, '0.3%', '')">
            <span class="fee-item-rate">0.3%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.005, '0.5%', '')">
            <span class="fee-item-rate">0.5%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
    </div>
</div>

</div>

        <!-- Белая карточка начинается здесь -->
        <div class="calc-box-white-section">
        <!-- Инвестиционная стратегия -->
<div class="strategy-section" style="margin-top: 8px;">
    <span class="fee-label">Выбор Стратегии</span>
    
    <!-- 3D Wrapper -->
    <div class="strategy-perspective-wrapper">
        
        <!-- 1. ВСЕГДА ВИДИМАЯ КАРТОЧКА (ВЫБРАННАЯ) -->
        <div class="main-selected-card" id="mainSelectedCard" onclick="toggleStrategies()">
            <div class="card-left-part">
                <!-- Цветной индикатор -->
                <div class="card-indicator" id="mainCardIndicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 50%, #94A8B8 50%, #94A8B8 100%);"></div>
                <div class="card-titles">
                    <div class="card-main-title" id="mainCardTitle">Гармония</div>
                    <div class="card-sub-title" id="mainCardSubtitle">Классический баланс</div>
                </div>
            </div>
            <div class="card-right-part">
                <div class="card-divider"></div>
                <div class="card-pct-group">
                    <div class="card-pct-bonds" id="mainCardBonds">Обл. 50%</div>
                    <div class="card-pct-stocks" id="mainCardStocks">Акц. 50%</div>
                </div>
            </div>
        </div>

                <!-- 2. WATERFALL КОНТЕЙНЕР (ОБНОВЛЕННЫЙ: ПОЛНАЯ ИНФОРМАЦИЯ) -->
        <div class="waterfall-container" id="waterfallContainer">
            <div class="waterfall-inner">
                
                <!-- Опция 50/50 -->
                <div class="waterfall-inner">
    <div class="strategy-option-card" data-bonds="50" onclick="selectStrategy(50, this, 'Гармония', 'Классический баланс')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 50%, #94A8B8 50%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Гармония</div>
                <div class="card-sub-title">Классический баланс</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-divider"></div>
            <div class="card-pct-group">
                <div class="card-pct-bonds">Обл. 50%</div>
                <div class="card-pct-stocks">Акц. 50%</div>
            </div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="80" onclick="selectStrategy(80, this, 'Депозит', 'Защита капитала')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 80%, #94A8B8 80%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Депозит</div>
                <div class="card-sub-title">Защита капитала</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-divider"></div>
            <div class="card-pct-group">
                <div class="card-pct-bonds">Обл. 80%</div>
                <div class="card-pct-stocks">Акц. 20%</div>
            </div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="60" onclick="selectStrategy(60, this, 'Баланс', 'Умеренный риск')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 60%, #94A8B8 60%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Баланс</div>
                <div class="card-sub-title">Умеренный риск</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-divider"></div>
            <div class="card-pct-group">
                <div class="card-pct-bonds">Обл. 60%</div>
                <div class="card-pct-stocks">Акц. 40%</div>
            </div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="40" onclick="selectStrategy(40, this, 'Умеренная', 'Баланс роста')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 40%, #94A8B8 40%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Умеренная</div>
                <div class="card-sub-title">Баланс роста</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-divider"></div>
            <div class="card-pct-group">
                <div class="card-pct-bonds">Обл. 40%</div>
                <div class="card-pct-stocks">Акц. 60%</div>
            </div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="20" onclick="selectStrategy(20, this, 'Агрессивная', 'Макс. рост')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 20%, #94A8B8 20%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Агрессивная</div>
                <div class="card-sub-title">Макс. рост</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-divider"></div>
            <div class="card-pct-group">
                <div class="card-pct-bonds">Обл. 20%</div>
                <div class="card-pct-stocks">Акц. 80%</div>
            </div>
        </div>
    </div>

    <div class="strategy-option-card" id="customOptionCard" data-bonds="custom" onclick="toggleCustomStrategyNew(this)">
        <div class="card-left-part">
            <div class="card-indicator" style="background: #ccc;"></div>
            <div class="card-titles">
                <div class="card-main-title">Настроить свою</div>
                <div class="card-sub-title">Выберите пропорцию</div>
            </div>
        </div>
        <div class="card-right-part">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#5B7C99" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        </div>
    </div>
                    <!-- Развернутый блок настройки -->
<div class="custom-strategy-expanded" id="customStrategyExpanded">
    <div class="custom-strategy-inner">
        
        <!-- Верхний ряд: Кнопка минус, Дисплей, Кнопка плюс -->
        <div class="custom-controls-row">
            <button class="custom-adjust-btn" onclick="event.stopPropagation(); adjustCustomRatio(-5)">−</button>
            
            <div class="custom-value-display">
                <div class="custom-value-item">
                    <span class="custom-value-bonds" id="customBondsDisplay">50</span>
                    <span class="custom-value-label">Облигации</span>
                </div>
                <span class="custom-value-divider">/</span>
                <div class="custom-value-item">
                    <span class="custom-value-stocks" id="customStocksDisplay">50</span>
                    <span class="custom-value-label">Акции</span>
                </div>
            </div>
            
            <button class="custom-adjust-btn" onclick="event.stopPropagation(); adjustCustomRatio(5)">+</button>
        </div>
        
        <!-- Слайдер-нить -->
        <div class="custom-slider-block">
            <input type="range" id="customRatioSlider" class="custom-ratio-slider" min="0" max="100" value="50" step="5" oninput="updateCustomSlider(this.value)">
        </div>
        
        <!-- Индикатор точек (для красоты) -->
        <div class="custom-dots-indicator" id="customDotsIndicator" style="margin-bottom: 25px;">
            <div class="custom-dot" data-value="0"></div>
            <div class="custom-dot" data-value="15"></div>
            <div class="custom-dot active" data-value="50"></div>
            <div class="custom-dot" data-value="85"></div>
            <div class="custom-dot" data-value="100"></div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="custom-actions-row">
            <button class="custom-reset-btn" onclick="event.stopPropagation(); resetCustomTo50()">
                Сбросить
            </button>
            <button class="custom-done-btn" onclick="event.stopPropagation(); saveCustomStrategy()">
                Готово
            </button>
        </div>
    </div>
</div>

</div>

            </div>
        </div>


    <!-- 3. GHOST SLIDER TRIGGER -->
    <div class="ghost-trigger-wrapper" id="ghostTrigger" onclick="toggleStrategies()">
        <div class="ghost-line"></div>
        <div class="ghost-text" id="ghostText">ОТКРЫТЬ СТРАТЕГИИ</div>
        <div class="ghost-dots">
            <div class="ghost-dot"></div>
            <div class="ghost-dot"></div>
            <div class="ghost-dot"></div>
        </div>
    </div>



    
    <!-- Скрытый основной ползунок для совместимости -->
    <input type="range" id="ratioSlider" class="ratio-slider" min="0" max="100" value="50" oninput="draw()" style="display: none;">
    <span id="labelBondsPct" style="display: none;">50</span>
    <span id="labelStocksPct" style="display: none;">50</span>
</div>
         </div> <!-- Закрываем calc-box-white-section -->

    <!-- Отступ для sticky кнопки -->
    <div style="height: 20px;"></div>

    <!-- Sticky Bottom Panel -->
    <div class="bottom-sticky-panel" id="stickyPanel">
        <button class="btn-graphite" onclick="calculateAndShowPortfolio()">
           Сформировать Портфель
        </button>
        <p class="sticky-hint">
            Вам будет предложен список из 8 ОФЗ и 12 Акций к покупке
        </p>
    </div>
</div> <!-- Закрываем calc-box -->
</div> <!-- Закрываем calc-box WRAPPER или input-container -->
</div> <!-- Закрываем screen-app -->

<div id="screen-portfolio" class="screen">
    <!-- Aurora Background -->
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>
    
    <!-- Заголовок с меню -->
    <div class="portfolio-header-row">
        <h1>Портфель</h1>
        <div class="portfolio-action-btns" id="portfolioActionBtns" style="display:none;">
            <div class="portfolio-action-wrapper">
                <button class="portfolio-action-icon-btn" onclick="handleActionBtn(this, openShoppingList)" title="Список к покупке">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                        <rect x="9" y="3" width="6" height="4" rx="1"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                </button>
                <div class="portfolio-action-label">Список к покупке</div>
            </div>
            <div class="portfolio-action-wrapper">
                <button class="portfolio-action-icon-btn" onclick="handleActionBtn(this, newCalculationWithHaptic)" title="Новый расчёт">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                </button>
                <div class="portfolio-action-label">Новый расчёт</div>
            </div>
            <div class="portfolio-action-wrapper">
                <button class="portfolio-action-icon-btn" onclick="handleActionBtn(this, shareWithHaptic)" title="Сохранить">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <div class="portfolio-action-label">Сохранить</div>
            </div>
        </div>
    </div>
    
    <!-- Empty State (показывается если расчёт не производился) -->
    <div id="portfolio-empty" class="portfolio-empty-new">
        <div class="empty-icon">📂</div>
        <div class="empty-title">Портфель пуст</div>
        <div class="empty-text">Расчёт ещё не производился.<br>Перейдите в терминал и сформируйте портфель.</div>
        <button class="empty-btn" onclick="showScreen('screen-app')">
            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            Перейти к расчёту
        </button>
    </div>

    <!-- Контент портфеля (скрыт до расчёта) -->
    <div id="portfolio-content" style="display:none;">
        
        <!-- ===== СТРАНИЦА "К ПОКУПКЕ" ===== -->
        <div id="portfolio-page-buy" class="portfolio-page-content active">
            
            <!-- ===== КОМПАКТНАЯ КАРТОЧКА КАПИТАЛА + ПРОГНОЗ ===== -->
            <div class="portfolio-capital-card" id="shareContainer">
                <!-- Верхняя часть: Капитал -->
                <div class="capital-top-row">
                    <div class="capital-main">
                        <div class="capital-label">Текущий капитал</div>
                        <div class="capital-value" id="summ-invested">0 ₽</div>
                    </div>
                    <div class="capital-fee-badge">
                        <span id="summ-fee">0.00%</span>
                    </div>
                </div>
                
                <!-- Прогресс-бар распределения: Облигации слева, Акции справа -->
                <div class="capital-distribution">
                    <div class="capital-bar">
                        <div class="capital-bar-bonds" id="bar-bond-fill-v2" style="width: 50%;"></div>
                        <div class="capital-bar-stocks" id="bar-stock-fill-v2" style="width: 50%;"></div>
                    </div>
                    <div class="capital-labels">
                        <div class="capital-label-item">
                            <span class="capital-label-dot bonds"></span>
                            <span class="capital-label-text">ОФЗ</span>
                            <span class="capital-label-pct" id="srl-bond-pct-v2">50%</span>
                        </div>
                        <div class="capital-label-item">
                            <span class="capital-label-dot stocks"></span>
                            <span class="capital-label-text">Акции</span>
                            <span class="capital-label-pct" id="srl-stock-pct-v2">50%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Разделитель -->
                <div class="capital-divider"></div>
                
                <!-- Прогноз с детализацией -->
                <div class="capital-forecast">
                    <div class="forecast-icon-mini">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        </svg>
                    </div>
                    <div class="forecast-content-mini">
                        <div class="forecast-title-mini">Прогноз через 3 года</div>
                        <div class="forecast-main-row">
    <span class="forecast-total-mini" id="summ-total-value-v2">~0 ₽</span>
</div>
<div class="forecast-bottom-row">
    <div class="forecast-details-mini">
        <div class="forecast-detail-item">
            <span class="detail-dot bonds"></span>
            <span class="detail-label">Купоны:</span>
            <span class="detail-value" id="summ-bond-income-mini">+0 ₽</span>
        </div>
        <div class="forecast-detail-item">
            <span class="detail-dot stocks"></span>
            <span class="detail-label">Рост:</span>
            <span class="detail-value" id="summ-stock-growth-mini">+0 ₽</span>
        </div>
    </div>
    <span class="forecast-percent-change" id="summ-total-percent-v2">+0%</span>
</div>
                    </div>
                </div>
                
                <!-- Скрытый блок для PDF -->
                <div style="text-align: center; padding: 10px; display: none;" id="shareBrand">
                    <h2 style="margin: 0; color: #D97757; font-size: 18px;">Madame Solomi'na Portfolio</h2>
                    <div id="shareDate" style="font-size: 10px; color: #888;"></div>
                </div>
            </div>
            
            <!-- ===== ПЕРЕКЛЮЧАТЕЛЬ ДЕНЕЖНЫЙ ПОТОК / РАСТУЩАЯ ЧАСТЬ ===== -->
            <div class="portfolio-content-tabs">
                <div class="portfolio-tab-switcher" id="portfolioTabSwitcher">
                    <div class="portfolio-tab-glider"></div>
                    <button class="portfolio-tab-btn active" onclick="switchPortfolioContentTab('bonds')" data-tab="bonds">Денежный поток</button>
                    <button class="portfolio-tab-btn" onclick="switchPortfolioContentTab('stocks')" data-tab="stocks">Растущая часть</button>
                </div>
            </div>
            
            <!-- ===== КОНТЕНТ: ДЕНЕЖНЫЙ ПОТОК (ОФЗ) ===== -->
            <div id="portfolio-tab-bonds" class="portfolio-tab-content active">
                <!-- Заголовки списка -->
                <div class="portfolio-list-headers">
                    <span class="portfolio-list-header-text">ОБЛИГАЦИЯ</span>
                    <span class="portfolio-list-header-text center clickable" onclick="toggleYieldHelp()" style="display:flex;align-items:center;justify-content:center;gap:4px;">%
                        <div class="h-help-btn h-help-animated" onclick="event.stopPropagation(); this.classList.remove('h-help-animated'); toggleYieldHelp()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width: 10px; height: 10px;">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                        </div>
                    </span>
                    <span class="portfolio-list-header-text right">ШТ</span>
                    <span class="portfolio-list-header-text right">РАСХОДЫ</span>
                </div>
                
                <!-- Подсказка для % (Простая доходность) -->
                <div class="yield-help-tooltip" id="yieldHelpTooltip">
                    <div class="yield-help-title">Простая доходность к погашению</div>
                    <div class="yield-help-text">
                        Показывает годовую доходность, которую вы получите, если будете держать облигацию до погашения. Учитывает купонные выплаты и разницу между текущей ценой и номиналом.
                    </div>
                </div>
                
                <!-- Список ОФЗ -->
                <div class="portfolio-ofz-list" id="listBondsV2">
                    <!-- Skeleton для облигаций портфеля -->
                    <div class="skeleton-container" id="skeleton-portfolio-bonds">
                        <div class="skeleton-list-item" style="animation-delay: 0s"><div class="s-left"><div class="skeleton-bone s-title"></div><div class="skeleton-bone s-sub"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div><div class="skeleton-bone s-yield"></div></div></div>
                        <div class="skeleton-list-item" style="animation-delay: 0.05s"><div class="s-left"><div class="skeleton-bone s-title"></div><div class="skeleton-bone s-sub"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div><div class="skeleton-bone s-yield"></div></div></div>
                        <div class="skeleton-list-item" style="animation-delay: 0.1s"><div class="s-left"><div class="skeleton-bone s-title"></div><div class="skeleton-bone s-sub"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div><div class="skeleton-bone s-yield"></div></div></div>
                    </div>
                    <!-- JS генерирует список здесь -->
                </div>

                <div class="portfolio-echelons-total-row" id="bondsTotalRow">
    <div class="total-left">
        <div class="total-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6H5a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h8l-5 5 5 5H5a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h13"/>
            </svg>
        </div>
        <span class="total-label">Итого ОФЗ</span>
    </div>
    
    <div class="total-value-col">
        <span class="total-sum" id="bondsTotalSum">0 ₽</span>
    </div>

    <div class="total-percent-col">
        <span class="total-percent" id="bondsTotalPercent">0%</span>
    </div>
</div>
                
                <!-- Купонный дождь -->
                <div class="portfolio-coupon-card" id="couponBoxV2">
                    <div class="portfolio-coupon-header" onclick="toggleCouponRain(this)">
                        <div class="portfolio-coupon-header-left">
                            <div class="portfolio-coupon-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                    <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/>
                                </svg>
                            </div>
                            <div class="portfolio-coupon-title-block">
                                <div class="portfolio-coupon-title">Купонный дождь</div>
                                <div class="portfolio-coupon-subtitle">Ближайшие выплаты по купонам</div>
                            </div>
                        </div>
                        <svg class="portfolio-coupon-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="portfolio-coupon-content">
                        <!-- Переключатель налога -->
                        <div class="tax-selector-ui" id="taxGroupV2" style="margin: 16px 0;">
                            <button class="tax-ui-btn" onclick="setTax(0, this)">Без налога</button>
                            <button class="tax-ui-btn active" onclick="setTax(0.13, this)">НДФЛ 13%</button>
                            <button class="tax-ui-btn" onclick="setTax(0.15, this)">НДФЛ 15%</button>
                        </div>
                        
                        <!-- Заголовки таблицы -->
                        <div class="coupon-table-head">
                            <span>ДАТА</span>
                            <span>НАЗВАНИЕ</span>
                            <span style="text-align:center">КОЛ-ВО</span>
                            <span style="text-align:right">СУММА</span>
                        </div>
                        
                        <!-- Список выплат -->
                        <div id="couponListV2">
                            <!-- Skeleton для купонов -->
                            <div class="skeleton-container" id="skeleton-coupons">
                                <div class="skeleton-list-item" style="padding:10px 12px"><div class="s-left"><div class="skeleton-bone s-sub" style="width:50px"></div></div><div class="skeleton-bone" style="width:80px;height:12px;border-radius:4px"></div><div class="skeleton-bone" style="width:30px;height:12px;border-radius:4px"></div><div class="skeleton-bone" style="width:50px;height:12px;border-radius:4px"></div></div>
                                <div class="skeleton-list-item" style="padding:10px 12px"><div class="s-left"><div class="skeleton-bone s-sub" style="width:50px"></div></div><div class="skeleton-bone" style="width:80px;height:12px;border-radius:4px"></div><div class="skeleton-bone" style="width:30px;height:12px;border-radius:4px"></div><div class="skeleton-bone" style="width:50px;height:12px;border-radius:4px"></div></div>
                                <div class="skeleton-list-item" style="padding:10px 12px"><div class="s-left"><div class="skeleton-bone s-sub" style="width:50px"></div></div><div class="skeleton-bone" style="width:80px;height:12px;border-radius:4px"></div><div class="skeleton-bone" style="width:30px;height:12px;border-radius:4px"></div><div class="skeleton-bone" style="width:50px;height:12px;border-radius:4px"></div></div>
                            </div>
                        </div>
                        
                        <!-- Итого -->
                        <div style="text-align:right; margin-top:12px; font-weight:bold; font-size:13px; padding-top:10px; border-top:1px dashed rgba(0,0,0,0.1);">
                            Итого ближайшие: <span id="couponTotalHeaderV2" style="color: #5E7BA3;">0 ₽</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ===== КОНТЕНТ: РАСТУЩАЯ ЧАСТЬ (АКЦИИ) ===== -->
            <div id="portfolio-tab-stocks" class="portfolio-tab-content">
                
              <div class="portfolio-echelons-headers">
    <div class="portfolio-echelon-h-text">
        <span>ЭШЕЛОН</span>
        <div class="h-help-btn h-help-animated" onclick="this.classList.remove('h-help-animated'); toggleEchelonGuide(true, 'portfolio')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width: 10px; height: 10px;">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
        </div>
    </div>

    <div class="portfolio-echelon-h-text">
        <span>ВЫДЕЛИТЬ</span>
    </div>
    <div class="portfolio-echelon-h-text clickable" onclick="toggleEchelonPercentHelp(event)">
        <span>%</span>
        <div class="h-help-btn h-help-animated" onclick="event.stopPropagation(); this.classList.remove('h-help-animated'); toggleEchelonPercentHelp(event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width: 10px; height: 10px;">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
        </div>
    </div>
</div>
                
                <!-- Подсказка для ВЫДЕЛИТЬ -->
                <div class="yield-help-tooltip" id="allocHelpTooltip">
                    <div class="yield-help-title">Выделить на эшелон</div>
                    <div class="yield-help-text">
                        Сумма, которая выделяется на покупку акций данного эшелона из общего бюджета на акции.
                    </div>
                </div>

                <!-- Подсказка для % эшелонов -->
                <div class="yield-help-tooltip" id="echelonPercentTooltip">
                    <div class="yield-help-title">Распределение по эшелонам</div>
                    <div class="yield-help-text">
                        Указан процент распределения средств на эшелон от суммы, что выделена на покупку Акций.
                    </div>
                </div>
                
                <!-- Контейнер эшелонов -->
                <div id="echelonContainerV2">
                    <!-- Skeleton для эшелонов -->
                    <div class="skeleton-container" id="skeleton-portfolio-echelons">
                        <div class="skeleton-list-item" style="animation-delay: 0s"><div class="s-left"><div class="skeleton-bone s-title" style="width: 45%"></div><div class="skeleton-bone s-sub" style="width: 80%"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div></div></div>
                        <div class="skeleton-list-item" style="animation-delay: 0.05s"><div class="s-left"><div class="skeleton-bone s-title" style="width: 45%"></div><div class="skeleton-bone s-sub" style="width: 80%"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div></div></div>
                        <div class="skeleton-list-item" style="animation-delay: 0.1s"><div class="s-left"><div class="skeleton-bone s-title" style="width: 45%"></div><div class="skeleton-bone s-sub" style="width: 80%"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div></div></div>
                        <div class="skeleton-list-item" style="animation-delay: 0.15s"><div class="s-left"><div class="skeleton-bone s-title" style="width: 45%"></div><div class="skeleton-bone s-sub" style="width: 80%"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div></div></div>
                    </div>
                    <!-- JS генерирует эшелоны здесь -->
                </div>

               <div class="portfolio-echelons-total-row">
    <div class="total-left">
        <div class="total-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6H5a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h8l-5 5 5 5H5a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h13"/>
            </svg>
        </div>
        <span class="total-label">Итого акции</span>
    </div>
    
    <div class="total-value-col">
        <span class="total-sum" id="echelonsTotalSum">0 ₽</span>
    </div>

    <div class="total-percent-col">
        <span class="total-percent" id="stocksTotalPercent">0%</span>
    </div>
</div>
                
  
                
                <!-- Блок Важно - Aurora Design -->
                <div class="portfolio-important-aurora" id="footer-important-v2">
                    <div class="important-aurora-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <div class="important-aurora-content">
                        <div class="important-aurora-title">Важно знать</div>
                        <div class="important-aurora-text">
                            В Растущей части <span class="highlight-marker">70% средств</span> мы держим в первых двух Эшелонах — они обеспечивают оптимальный баланс надёжности и потенциальной доходности.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Отступ для Action Panel -->
            <div style="height: 120px;"></div>
        </div>
        
        <!-- ===== СТРАНИЦА "АКТИВЫ" (Заглушка) ===== -->
        <div id="portfolio-page-assets" class="portfolio-page-content">
            <div class="portfolio-assets-placeholder">
                <div class="placeholder-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
                        <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
                        <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/>
                    </svg>
                </div>
                <div class="placeholder-title">Скоро здесь</div>
                <div class="placeholder-text">Реальные активы из вашего брокерского счёта будут отображаться здесь после подключения API.</div>
            </div>
        </div>
    </div>
    
    <!-- Action panel removed - moved to header dots menu -->
    
    <!-- Старые элементы для совместимости (скрытые) -->
    <div style="display:none;">
        <div class="stm-bar-container">
            <div class="stm-bar-bonds" id="bar-bond-fill" style="width: 50%;"></div>
            <div class="stm-bar-stocks" id="bar-stock-fill" style="width: 50%;"></div>
        </div>
        <div id="srl-stock-pct">50%</div>
        <div id="srl-bond-pct">50%</div>
        <div id="summ-bond-income">+0 ₽</div>
        <div id="summ-stock-growth">+0 ₽</div>
        <div id="summ-total-3y">0 ₽</div>
        <div id="badge-bonds-sum">0 ₽</div>
        <div id="badge-stocks-sum">0 ₽</div>
        <div id="listBonds"></div>
        <div id="echelonContainer"></div>
        <div id="couponList"></div>
        <div id="couponTotalHeader"></div>
        <div id="portfolioActionPanel"></div>
    </div>
    
</div>


<div id="screen-assets" class="screen">
    <!-- Aurora Background -->
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>
    
    <!-- Заголовок -->
   <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Ребалансировка</h1>
    
    <button id="stocksInfoBtn" class="info-trigger-btn" onclick="this.classList.remove('h-help-animated'); this.dataset.clicked='1'; if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium'); else if(navigator.vibrate) navigator.vibrate(10); toggleEchelonGuide(true, 'rebalance')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
    </button>
</div>
    
    <!-- Карточка "Умная замена" (Dark Premium Glass) -->
    <div class="smart-replace-card" id="smartReplaceCard">
        <div class="smart-replace-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M12 2v20M2 12h20M4.9 4.9l14.2 14.2M4.9 19.1L19.1 4.9"/>
            </svg>
        </div>
        <div class="smart-replace-content">
            <h2 class="smart-replace-title">Умная замена</h2>
            <p class="smart-replace-desc">
                Пересмотр состава активов. Продаём то, что выросло или имеет низкий потенциал, покупаем недооценённые инструменты из списков ниже.
            </p>
        </div>
    </div>

    <!-- LIQUID TAB SWITCHER (без иконок) -->
    <div class="rebalance-tabs-container">
        <div class="tab-switcher" id="tabSwitcher">
            <div class="tab-glider"></div>
            <button class="tab-btn active" onclick="switchRebalanceTab('ofz')" data-tab="ofz">ОФЗ</button>
            <button class="tab-btn" onclick="switchRebalanceTab('stocks')" data-tab="stocks">АКЦИИ</button>
        </div>
    </div>

    <!-- КОНТЕНТ ВКЛАДКИ ОФЗ -->
    <div id="rebalance-tab-ofz" class="rebalance-tab-content active">
        <!-- Заголовки списка с галочкой -->
        <div class="list-headers" id="ofzListHeaders">
            <div class="list-header-left">
                <span class="list-header-text">ИНСТРУМЕНТ</span>
                <div class="list-collapse-toggle" id="ofzCollapseToggle" onclick="toggleOfzListCollapse()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            <span class="list-header-percent" onclick="this.classList.add('clicked'); toggleYieldDropdown(event)">%</span>
            <span class="list-header-price" onclick="this.classList.add('clicked'); togglePriceDropdown(event)">₽</span>
        </div>
        <!-- Раскрывающееся пояснение для % -->
        <div class="header-dropdown-tooltip" id="yieldDropdown">
            <b>Простая доходность к погашению</b> — показывает, сколько процентов годовых вы получите, если будете держать облигацию до погашения.
        </div>
        <!-- Раскрывающееся пояснение для ₽ -->
        <div class="header-dropdown-tooltip" id="priceDropdown">
            <b>Цена формируется как:</b><br>Текущая цена + НКД (накопленный купонный доход)
        </div>
        
        <div id="ofz-aurora-list" class="ofz-aurora-list">
            <!-- Skeleton для ОФЗ -->
            <div class="skeleton-container" id="skeleton-ofz-list">
                <div class="skeleton-list-item" style="animation-delay: 0s"><div class="s-left"><div class="skeleton-bone s-title"></div><div class="skeleton-bone s-sub"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div><div class="skeleton-bone s-yield"></div></div></div>
                <div class="skeleton-list-item" style="animation-delay: 0.05s"><div class="s-left"><div class="skeleton-bone s-title"></div><div class="skeleton-bone s-sub"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div><div class="skeleton-bone s-yield"></div></div></div>
                <div class="skeleton-list-item" style="animation-delay: 0.1s"><div class="s-left"><div class="skeleton-bone s-title"></div><div class="skeleton-bone s-sub"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div><div class="skeleton-bone s-yield"></div></div></div>
                <div class="skeleton-list-item" style="animation-delay: 0.15s"><div class="s-left"><div class="skeleton-bone s-title"></div><div class="skeleton-bone s-sub"></div></div><div class="s-right"><div class="skeleton-bone s-price"></div><div class="skeleton-bone s-yield"></div></div></div>
            </div>
            <!-- Динамически заполняется через JS -->
        </div>
        
        <!-- Ghost Trigger для ОФЗ -->
        <div class="rebalance-ghost-trigger" id="ofzGhostTrigger" onclick="toggleAuroraOfzList()">
            <div class="ghost-line"></div>
            <div class="ghost-text" id="ofzGhostText">ОТКРЫТЬ СПИСОК</div>
            <div class="ghost-dots">
                <div class="ghost-dot"></div>
                <div class="ghost-dot"></div>
                <div class="ghost-dot"></div>
            </div>
        </div>
    </div>

    <!-- КОНТЕНТ ВКЛАДКИ АКЦИИ -->
    <div id="rebalance-tab-stocks" class="rebalance-tab-content">
        <div class="stocks-aurora-container">

            <!-- Таблица эшелонов -->
            <div class="stocks-aurora-table">
                <div class="stocks-table-header">
                    <div class="stocks-header-pill" onclick="toggleEchelonColumnHighlight(1, event)"><div class="echelon-icon-circle e1" id="echelonCircle1">I</div></div>
                    <div class="stocks-header-pill" onclick="toggleEchelonColumnHighlight(2, event)"><div class="echelon-icon-circle e2" id="echelonCircle2">II</div></div>
                    <div class="stocks-header-pill" onclick="toggleEchelonColumnHighlight(3, event)"><div class="echelon-icon-circle e3" id="echelonCircle3">III</div></div>
                    <div class="stocks-header-pill" onclick="toggleEchelonColumnHighlight(4, event)"><div class="echelon-icon-circle e4" id="echelonCircle4">IV</div></div>
                </div>
                <div class="stocks-table-body" id="stocks-aurora-body">
                    <!-- Skeleton для акций -->
                    <div class="skeleton-container" id="skeleton-stocks-table">
                        <div class="skeleton-stocks-grid">
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                        </div>
                        <div class="skeleton-stocks-grid" style="margin-top: 2px;">
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                        </div>
                        <div class="skeleton-stocks-grid" style="margin-top: 2px;">
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                            <div class="skeleton-stock-cell"><div class="skeleton-bone s-ticker"></div><div class="skeleton-bone s-sector"></div></div>
                        </div>
                    </div>
                    <!-- Динамически заполняется через JS -->
                </div>
            </div>
            
            <!-- Карточка деталей тикера -->
            <div class="stock-detail-card" id="stockDetailCard">
                <!-- Динамически заполняется -->
            </div>
            
            <!-- Ghost Trigger для акций -->
            <div class="rebalance-ghost-trigger" id="stocksGhostTrigger" onclick="toggleStocksTable()">
                <div class="ghost-line"></div>
                <div class="ghost-text" id="stocksGhostText">ОТКРЫТЬ СПИСОК</div>
                <div class="ghost-dots">
                    <div class="ghost-dot"></div>
                    <div class="ghost-dot"></div>
                    <div class="ghost-dot"></div>
                </div>
            </div>
     

            
        </div>
    </div>
    
    <!-- Старый код для совместимости (скрыт) -->
    <div id="ofz-list" style="display:none;"></div>
    <div id="echelon-wrapper" class="echelon-wrapper collapsed" style="display:none;">
        <table class="echelon-table-styled">
            <thead>
                <tr>
                    <th><div class="echelon-header-pill">I</div></th>
                    <th><div class="echelon-header-pill">II</div></th>
                    <th><div class="echelon-header-pill">III</div></th>
                    <th><div class="echelon-header-pill">IV</div></th>
                </tr>
            </thead>
            <tbody id="echelon-tickers-body"></tbody>
        </table>
    </div>
</div>

    <div id="screen-interesting" class="screen">
    <!-- Aurora Background -->
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>
    
    <!-- Заголовок экрана -->
    <div class="header">
        <h1>Интересное</h1>
    </div>
    
    <!-- Секция рыночных данных - Aero-Prism Tiles -->
    <div class="market-tiles-grid three-cols">
        <!-- Skeleton для тайлов -->
        <div class="skeleton-container" id="skeleton-market-tiles">
            <div class="skeleton-tile" style="animation-delay: 0s">
                <div class="skeleton-bone s-label"></div>
                <div class="skeleton-bone s-value"></div>
                <div class="skeleton-bone s-change"></div>
            </div>
            <div class="skeleton-tile" style="animation-delay: 0.1s">
                <div class="skeleton-bone s-label"></div>
                <div class="skeleton-bone s-value"></div>
                <div class="skeleton-bone s-change"></div>
            </div>
            <div class="skeleton-tile" style="animation-delay: 0.2s">
                <div class="skeleton-bone s-label"></div>
                <div class="skeleton-bone s-value"></div>
                <div class="skeleton-bone s-change"></div>
            </div>
        </div>
        <!-- IMOEX -->
        <div class="market-tile" id="tile-imoex">
            <span class="market-tile-label">IMOEX</span>
            <span class="market-tile-value" id="val-imoex">---</span>
            <span class="market-tile-change neutral" id="dyn-imoex">
                <svg class="trend-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M5 12h14"/>
                </svg>
                --%
            </span>
        </div>
        
        <!-- USD/RUB -->
        <div class="market-tile" id="tile-usdrub">
            <span class="market-tile-label">USD/RUB</span>
            <span class="market-tile-value" id="val-usdrub">---</span>
            <span class="market-tile-change neutral" id="dyn-usdrub">
                <svg class="trend-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M5 12h14"/>
                </svg>
                --%
            </span>
        </div>
        
        <!-- BTC/USD -->
        <div class="market-tile" id="tile-btc">
            <span class="market-tile-label">BTC/USD</span>
            <span class="market-tile-value" id="val-btc">---</span>
            <span class="market-tile-change neutral" id="dyn-btc">
                <svg class="trend-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M5 12h14"/>
                </svg>
                --%
            </span>
        </div>
    </div>

    <!-- Вертикаль ставок (Imprinted List) -->
    <div class="rates-glass-card">
        <div class="rv-title">Вертикаль ставок</div>
        
        <!-- Skeleton для ставок -->
        <div class="skeleton-container" id="skeleton-rates">
            <div class="skeleton-rate-row"><div class="skeleton-bone s-label"></div><div class="skeleton-bone s-value"></div></div>
            <div class="skeleton-rate-row"><div class="skeleton-bone s-label"></div><div class="skeleton-bone s-value"></div></div>
            <div class="skeleton-rate-row"><div class="skeleton-bone s-label"></div><div class="skeleton-bone s-value"></div></div>
            <div class="skeleton-rate-row"><div class="skeleton-bone s-label"></div><div class="skeleton-bone s-value"></div></div>
        </div>
        
        <div class="rates-row-list" id="ratesRowList" style="display:none;">
            <div class="rate-row-item">
                <span class="rate-row-label">Инфляция (г/г)</span>
                <span class="rate-row-value" id="val-inflation">9.1%</span>
            </div>
            
            <div class="rate-row-item">
                <span class="rate-row-label">Макс. ставка по вкладам</span>
                <span class="rate-row-value" id="val-deposit-rate">21.5%</span>
            </div>
            
            <div class="rate-row-item">
                <span class="rate-row-label">Ключевая ставка ЦБ</span>
                <span class="rate-row-value" id="val-key-rate">21.0%</span>
            </div>
            
            <div class="rate-row-item">
                <span class="rate-row-label">ОФЗ 10 лет</span>
                <span class="rate-row-value" id="val-ofz10">---%</span>
            </div>
        </div>
    </div>

    <!-- Калькулятор ежемесячного дохода (Hero Card) -->
    <div class="calc-accordion collapsed" id="calcAccordion">
        <!-- Заголовок аккордеона -->
        <div class="calc-accordion-header" onclick="toggleCalcAccordion()">
            <div class="calc-accordion-header-left">
                <div class="calc-accordion-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2v20"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                </div>
                <div>
                    <div class="calc-accordion-title">Ежемесячный доход</div>
                    <div class="calc-accordion-subtitle">Рассчитайте выплаты по ОФЗ</div>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                <svg class="calc-accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
        </div>
        
        <!-- Обертка для плавного сворачивания -->
        <div class="calc-content-wrapper">
            <!-- Контент аккордеона -->
            <div class="calc-accordion-content">
                <!-- Поле ввода суммы -->
                <div class="glass-input-wrapper">
                    <span class="input-label">Сумма инвестиций</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="monthlySumInput" value="100000" 
                               oninput="distributeMonthlyInvestment()" 
                               onclick="event.stopPropagation(); this.select()" 
                               onkeyup="if(event.keyCode===13) this.blur()" 
                               inputmode="numeric" 
                               pattern="[0-9]*" 
                               enterkeyhint="done"
                               placeholder="Введите сумму...">
                        <span class="currency-symbol">₽</span>
                    </div>
                </div>
                
                <!-- Информационный текст -->
                <div class="calc-info-text" style="display:flex;align-items:flex-start;gap:12px;border-left:none;background:linear-gradient(135deg,rgba(59,130,246,0.06),rgba(16,185,129,0.04));border:1px solid rgba(59,130,246,0.1);border-radius:14px;">
                    <div style="min-width:32px;height:32px;background:rgba(59,130,246,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    </div>
                    <span style="line-height:1.55;">Калькулятор подбирает ОФЗ с разными датами купонов, чтобы выплаты приходили каждый месяц.</span>
                </div>
                
                <!-- Переключатель налога -->
                <div class="tax-segmented-control">
                    <button class="tax-segment" id="tax-custom-0" onclick="setCustomTax(0, this)">Без налога</button>
                    <button class="tax-segment active" id="tax-custom-13" onclick="setCustomTax(0.13, this)">НДФЛ 13%</button>
                    <button class="tax-segment" id="tax-custom-15" onclick="setCustomTax(0.15, this)">НДФЛ 15%</button>
                </div>
                
                <!-- Заголовки таблицы -->
                <div class="calc-table-header">
                    <span>Облигация</span>
                    <span>%</span>
                    <span>Кол-во</span>
                </div>
                
                <!-- Список облигаций для ввода -->
                <div id="calc-bonds-input-list">
                    <!-- Skeleton для карточек ежемесячного дохода -->
                    <div class="skeleton-container" id="skeleton-income-cards">
                        <div class="skeleton-income-card"><div class="skeleton-bone s-icon"></div><div class="s-info"><div class="skeleton-bone s-name"></div><div class="skeleton-bone s-yield"></div></div><div class="skeleton-bone s-controls"></div></div>
                        <div class="skeleton-income-card"><div class="skeleton-bone s-icon"></div><div class="s-info"><div class="skeleton-bone s-name"></div><div class="skeleton-bone s-yield"></div></div><div class="skeleton-bone s-controls"></div></div>
                        <div class="skeleton-income-card"><div class="skeleton-bone s-icon"></div><div class="s-info"><div class="skeleton-bone s-name"></div><div class="skeleton-bone s-yield"></div></div><div class="skeleton-bone s-controls"></div></div>
                        <div class="skeleton-income-card"><div class="skeleton-bone s-icon"></div><div class="s-info"><div class="skeleton-bone s-name"></div><div class="skeleton-bone s-yield"></div></div><div class="skeleton-bone s-controls"></div></div>
                    </div>
                </div>
                
                <!-- Кнопка сброса -->
                <button class="btn-reset-glass" onclick="resetCustomCalc()">
                    <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Сбросить
                </button>

                <!-- Блок результатов -->
                <div class="results-glass-container">
                   <div class="results-glass-title">График выплат</div>
                    
                    <div class="coupon-table-head">
                        <span>Дата</span>
                        <span>Облигация</span>
                        <span>Шт</span>
                        <span>Сумма</span>
                    </div>
                    
                    <div id="calc-results-list">
                        Введите количество для расчета...
                    </div>
                    
                    <div id="calc-results-footer" class="results-glass-footer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ghost Trigger - Смотреть далее -->
    <div class="rebalance-ghost-trigger" id="interestingGhostTrigger" onclick="toggleInterestingMore()">
        <div class="ghost-line"></div>
        <div class="ghost-text" id="interestingGhostText">СМОТРЕТЬ ДАЛЕЕ</div>
        <div class="ghost-dots">
            <div class="ghost-dot"></div>
            <div class="ghost-dot"></div>
            <div class="ghost-dot"></div>
        </div>
    </div>

    <!-- Блок Инфографика (скрыт по умолчанию) -->
    <div class="infographic-section" id="infographicSection" style="display: none;">
        
        <!-- Карточка 1: Идеи для развития -->
        <div class="future-idea-card">
            <div class="future-idea-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4"/>
                    <path d="M12 8h.01"/>
                </svg>
            </div>
            <div class="future-idea-content">
                <div class="future-idea-title">Раздел в разработке</div>
                <div class="future-idea-desc">Здесь появятся интерактивные графики, аналитика портфеля и персональные рекомендации</div>
            </div>
        </div>

        <!-- Превью будущих функций -->
        <div class="future-features-grid">
            <div class="future-feature-item">
                <div class="future-feature-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17l-5-5-4 4-3-3"/>
                    </svg>
                </div>
                <span>Динамика портфеля</span>
            </div>
            
            <div class="future-feature-item">
                <div class="future-feature-icon green">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 2a10 10 0 0 1 10 10"/>
                        <path d="M12 12l3-3"/>
                    </svg>
                </div>
                <span>Распределение активов</span>
            </div>
            
            <div class="future-feature-item">
                <div class="future-feature-icon orange">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </div>
                <span>Календарь выплат</span>
            </div>
            
            <div class="future-feature-item">
                <div class="future-feature-icon purple">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <span>Сравнение стратегий</span>
            </div>
        </div>

        <!-- Подпись -->
        <div class="future-coming-soon">
            <span>🚀</span> Скоро в обновлениях
        </div>
    </div>
</div>
    
    <div id="screen-company" class="screen">
    <!-- Aurora Background -->
    <div class="aurora-container">
        <div class="aurora-spot blue"></div>
        <div class="aurora-spot green"></div>
        <div class="aurora-spot orange"></div>
    </div>
    <div class="noise-overlay"></div>
    
    <div id="company-content"></div>
</div>
        
        
        <div id="company-content"></div>
    </div>

    <div class="nav-wrapper" id="navWrapper" style="display: flex !important;">
        <div class="nav-dock" id="standardNav">
            <div class="nav-item active" id="nav-home" onclick="goHomeScreen()">
                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </div>
            <div class="nav-item" id="nav-app" onclick="showScreen('screen-app')">
                <svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
            </div>
            <div class="nav-item" id="nav-portfolio" onclick="showScreen('screen-portfolio')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            </div>
            <div class="nav-item" id="nav-assets" onclick="showScreen('screen-assets', true)">
                <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            </div>
        </div>

        <div class="nav-search-btn" id="nav-search" onclick="expandSearch()">
            <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:2;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <button class="theme-toggle-mini" onclick="event.stopPropagation(); toggleTheme()" id="themeBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
        </div>

        <div class="nav-search-expanded" id="expandedNav">
            <div class="nav-back-island" onclick="collapseSearch()">
                 <!-- Icon will be injected here by JS -->
            </div>
            <input type="text" class="nav-search-input-bar" id="tickerSearchInput" placeholder="Тикер, название или ISIN..." onkeyup="handleSearchKeyup(event)">
            <div class="nav-item" onclick="collapseSearch()">
                <svg viewBox="0 0 24 24" style="width:24px;height:24px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <!-- REVOLUTIONARY NOTIFICATION PILL -->
<div id="luxuryNotification" class="luxury-notify-pill">
    <div class="notify-icon-circle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
            <circle cx="12" cy="12" r="10"></circle>
        </svg>
    </div>
    <div class="notify-content">
        <span class="notify-title">Минимальный капитал</span>
        <span class="notify-message">Введите сумму от 100 000 ₽</span>
    </div>
</div>

   <!-- REVOLUTIONARY SWIPE BACK INDICATOR -->
<div id="swipeBackIndicator" class="luxury-swipe-container">
    <div class="ls-backdrop"></div>
    <div class="ls-lens">
        <svg class="ls-arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 19l-7-7 7-7" stroke-linecap="square" stroke-linejoin="miter"/>
        </svg>
    </div>
</div>

   <!-- LUXURY PATTERN BACKGROUND (BRAND PAPER) -->
<div class="luxury-depth-layer">
    <div class="luxury-pattern-container">
        <!-- Повторяющиеся строки для создания текстуры -->
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
        <div class="pattern-line">IN THE CARE OF MADAME SOLOMI'NA &nbsp;•&nbsp; IN THE CARE OF MADAME SOLOMI'NA</div>
    </div>
</div>

    



<script>
    // ========== MOEX PROXY ==========
    const MOEX_PROXY = 'https://functions.yandexcloud.net/d4ejkbncfpob68e9letn';
    const moexUrl = (path) => MOEX_PROXY + '?path=' + encodeURIComponent(path);

    // ========== SKELETON LOADER SYSTEM ==========
    function hideSkeleton(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.add('hiding');
        setTimeout(() => { el.style.display = 'none'; }, 300);
    }
    function hideSkeletonInstant(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    }
    // ========== END: SKELETON LOADER SYSTEM ==========

    // Очистка старых настроек при загрузке
        localStorage.removeItem('invest_settings');
    
        // ========== ИСПРАВЛЕННЫЙ КОД - НАЧАЛО ==========
        document.addEventListener('click', function(event) {
    const sumInput = document.getElementById('sumInput');
    const inputWrapper = document.querySelector('.input-wrapper');
    const currencySymbol = document.getElementById('currencySymbol');
    
    // Игнорируем клики по полю ввода, его обёртке, символу валюты и карточкам стратегий
    if (event.target.closest('.strategy-card') || 
        event.target.closest('.fee-dropdown-container') ||
        event.target.closest('.fee-dropdown-trigger') || // ДОБАВЛЕНО
        event.target.closest('.fee-dropdown-menu') ||    // ДОБАВЛЕНО
        event.target.closest('.custom-strategy-expanded')) {
        return; // Не закрываем клавиатуру при клике на эти элементы
    }
            
            // Если клик НЕ по полю ввода и НЕ по его обёртке - закрываем клавиатуру
            if (sumInput && 
                !sumInput.contains(event.target) && 
                !inputWrapper?.contains(event.target) &&
                !currencySymbol?.contains(event.target)) {
                sumInput.blur();
            }
        });
        // ========== ИСПРАВЛЕННЫЙ КОД - КОНЕЦ ==========

    
        
        const SHEET_ID = '1SFV5dBIsvfX5HKbXBuXHFVvBfw1p1MPPx2uK209ajLM';
        const GID = '1213653337'; 
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

           // Лист с описаниями компаний
        const GID_DESCRIPTIONS = '88183976';
        const CSV_DESCRIPTIONS_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSl8uP-rbiQbK57e9L5xxu8dHKzN05jNsJukOMclUn0wuaT2UNsnX-PIAaCctInmwDOzffdPuah4bER/pub?gid=${GID_DESCRIPTIONS}&single=true&output=csv`;
        
          // URL вашего Google Apps Script (ЗАМЕНИТЕ НА СВОЙ!)
        const NEWS_API_URL = 'https://script.google.com/macros/s/AKfycbys840HDKQ6JIt2ITZ2cNJ7FS1nlAsI-iUZyxfE9HMNrQZt-MjK7kD3uD9l4EFONSI/exec';
         // Кэш новостей чтобы не загружать повторно
          let newsCache = {};

        // Функция загрузки новостей для тикера
        async function loadNewsForTicker(ticker) {
         // Проверяем кэш 
        if (newsCache[ticker]) {
        return newsCache[ticker];
    }
    
    try {
        const response = await fetch(`${NEWS_API_URL}?ticker=${ticker}`);
        const data = await response.json();
        
        if (!data.error && data.news) {
            newsCache[ticker] = data.news;
            return data.news;
        }
        return [];
    } catch (e) {
        console.error('Ошибка загрузки новостей:', e);
        return [];
    }
}

// Функция форматирования даты новости
function formatNewsDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffHours < 1) return 'Только что';
    if (diffHours < 24) return `${diffHours} ч. назад`;
    if (diffDays < 7) return `${diffDays} дн. назад`;
    
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

    

        let bonds = [];
        let bondDataCache = {};
        let monthlyIncomeBonds = []; // New list for the specific calculator
        let bondQtyMap = {}; // Глобальная карта количеств для калькулятора
        let allScheduledPayments = [];
        let brokerFee = 0.0005; // По умолчанию Премиум 
        let currentTax = 0.13;
        let customTax = 0.13;
        let bondCouponsMap = {}; 
        let bondDetailsMap = {};
        let companyDescriptions = {};
        let currentScreen = 'screen-home';
        let lastNavScreen = 'screen-home';
        let isPortfolioCalculated = false;
        let isFirstVisit = true;
        let isUpdatingProgrammatically = false;
        let savedCustomBonds = null;
        let savedCustomStocks = null;
        // Переменные для вертикали ставок
        let ratesData = {
           keyRate: '21.0%',
           depositRate: '21.5%',
           inflation: '9.1%',
           ofz10: '---'
        };
    

                let echelons = [
            { title: 'Надежные', weight: 0.30, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ ПЛАТЯТ ДИВИДЕНДЫ И СТАРАЮТСЯ ИХ ПОВЫШАТЬ' },
            { title: 'Стабильные', weight: 0.40, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ ПЛАТЯТ ДИВИДЕНДЫ, НО ВЫПЛАТЫ РАЗНЯТСЯ' },
            { title: 'Рисковые', weight: 0.15, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ МОГУТ ПЛАТИТЬ, НО НЕ ПЛАТЯТ' },
            { title: 'Венчурные', weight: 0.15, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ НЕ ПЛАТЯТ ДИВИДЕНДОВ' }
        ];

        let echelonTableData = [[], [], [], []];
        
        // Swipe navigation removed

// !!! ВАЖНО: Замените эту ссылку на URL вашего НОВОГО Apps Script для управления пользователями !!!
// Это НЕ тот же URL что LOGGING_URL — нужно создать ОТДЕЛЬНЫЙ скрипт из файла UserManagement_GoogleAppsScript.js
// и развернуть его как веб-приложение (Развернуть → Новое развертывание → Веб-приложение)
const USERS_API_URL = "https://script.google.com/macros/s/AKfycbwm1dbotmFNjLd-HFJkKEAqcopjzwkXmuXRe0Sebnxp1Qd9q5I03eh9Lltg1ot0jy5NRA/exec";

// Проверяем настроен ли API
function isApiConfigured() {
    return USERS_API_URL && !USERS_API_URL.includes('ВСТАВЬТЕ_СЮДА');
}

// Глобальное состояние пользователя
window._currentUser = null;
window._isRegistered = false;
window._selectedBroker = '';
window._selectedPlan = 'trial';

                function checkFirstVisit() {
    // Сначала проверяем localStorage — быстрый кэш
    const cached = localStorage.getItem('user_registered');
    
    const tg = window.Telegram?.WebApp;
    const telegramId = tg?.initDataUnsafe?.user?.id;
    
    if (telegramId && isApiConfigured()) {
        // В Telegram и API настроен — проверяем в Google Sheets
        // Но сначала показываем кэш мгновенно если есть
        if (cached) {
            try {
                const cachedUser = JSON.parse(cached);
                window._currentUser = cachedUser;
                window._isRegistered = true;
                isFirstVisit = false;
                document.getElementById('navWrapper').style.display = 'flex';
                populateDashboard(cachedUser);
                showScreen('screen-dashboard');
            } catch(e) {
                showScreen('screen-home');
            }
        }
        // Затем проверяем актуальные данные с сервера (async)
        checkUserRegistration(telegramId);
    } else {
        // Не в Telegram или API не настроен — работаем через localStorage
        if (cached) {
            try {
                const cachedUser = JSON.parse(cached);
                window._currentUser = cachedUser;
                window._isRegistered = true;
                isFirstVisit = false;
                document.getElementById('navWrapper').style.display = 'flex';
                populateDashboard(cachedUser);
                showScreen('screen-dashboard');
                return;
            } catch(e) { /* corrupted cache */ }
        }
        isFirstVisit = true;
        showScreen('screen-home');
    }
}


        function startCalculation() {
    localStorage.setItem('user_visited', 'true');
    isFirstVisit = false;
    document.getElementById('navWrapper').style.display = 'flex';
    showScreen('screen-app');
    
    // Haptic feedback при открытии
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
}
    function openTerminal() {
    console.log('openTerminal called'); // для отладки
    localStorage.setItem('user_visited', 'true');
    isFirstVisit = false;
    
    // Показываем навигацию
    const navWrapper = document.getElementById('navWrapper');
    if (navWrapper) {
        navWrapper.style.display = 'flex';
    }
    
    // Переключаем экран
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const appScreen = document.getElementById('screen-app');
    if (appScreen) {
        appScreen.classList.add('active');
    }
    
    // Обновляем навигацию
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const navApp = document.getElementById('nav-app');
    if (navApp) {
        navApp.classList.add('active');
    }
    
    // Показываем sticky панель
    const stickyPanel = document.getElementById('stickyPanel');
    if (stickyPanel) {
        stickyPanel.style.display = 'block';
    }
    
    currentScreen = 'screen-app';
    
    // Скролл наверх
    window.scrollTo({top: 0, behavior: 'smooth'});
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
}

        function updateMarketStatus() {
    const now = new Date();
    const day = now.getDay(); 
    const hour = now.getHours(); 
    const min = now.getMinutes();
    const dot = document.getElementById('market-status-dot');
    
    if (!dot) {
        console.log('market-status-dot не найден');
        return;
    }
    
    const isWeekday = day >= 1 && day <= 5;
    const isWorkingHours = (hour > 10 || (hour === 10 && min >= 0)) && (hour < 18 || (hour === 18 && min <= 50));
    dot.className = (isWeekday && isWorkingHours) ? 'market-dot dot-online' : 'market-dot dot-offline';
}


    function updateRatesDisplay() {
    document.getElementById('val-key-rate').innerText = ratesData.keyRate;
    document.getElementById('val-deposit-rate').innerText = ratesData.depositRate;
    document.getElementById('val-inflation').innerText = ratesData.inflation;
    document.getElementById('val-ofz10').innerText = ratesData.ofz10;
    // Show real rates and hide skeleton
    const ratesList = document.getElementById('ratesRowList');
    if (ratesList) ratesList.style.display = '';
    hideSkeleton('skeleton-rates');
}

        async function updateMarketData() {
            const setDynamics = (el, change, tileId) => {
                el.classList.remove('positive', 'negative', 'neutral');
                const tile = document.getElementById(tileId);
                if (tile) {
                    tile.classList.remove('positive', 'negative');
                }
                
                // Иконка стрелки
                let arrowSvg = '';
                
                if (change > 0.01) {
                    el.classList.add('positive');
                    if (tile) tile.classList.add('positive');
                    arrowSvg = `<svg class="trend-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg>`;
                    el.innerHTML = `${arrowSvg}+${change.toFixed(2)}%`;
                } else if (change < -0.01) {
                    el.classList.add('negative');
                    if (tile) tile.classList.add('negative');
                    arrowSvg = `<svg class="trend-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>`;
                    el.innerHTML = `${arrowSvg}${change.toFixed(2)}%`;
                } else {
                    el.classList.add('neutral');
                    arrowSvg = `<svg class="trend-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14"/></svg>`;
                    el.innerHTML = `${arrowSvg}${Math.abs(change).toFixed(2)}%`;
                }
            };
            
            // Анимация накрутки цифр
            const animateValue = (el, endValue, prefix = '', suffix = '', decimals = 0) => {
                const startValue = 0;
                const duration = 1000;
                const startTime = performance.now();
                
                const update = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    // Easing функция для плавности
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const currentValue = startValue + (endValue - startValue) * easeOut;
                    
                    if (decimals > 0) {
                        el.innerText = prefix + currentValue.toFixed(decimals).replace('.00', '') + suffix;
                    } else {
                        el.innerText = prefix + Math.round(currentValue).toLocaleString() + suffix;
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(update);
                    }
                };
                
                requestAnimationFrame(update);
            };
            
            // Bitcoin
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
                const data = await res.json();
                if(data && data.lastPrice) {
                    const btcValue = Math.round(parseFloat(data.lastPrice));
                    animateValue(document.getElementById('val-btc'), btcValue, '$', '');
                    setDynamics(document.getElementById('dyn-btc'), parseFloat(data.priceChangePercent), 'tile-btc');
                }
            } catch(e) { console.log("BTC fetch error:", e); }

            // MOEX data
            const fetchMoex = (url, valEl, dynEl, tileId, suffix = '') => {
                fetch(url)
                    .then(r => r.json())
                    .then(d => {
                        const marketdata = (d.marketdata && d.marketdata.data.length > 0) ? d.marketdata : ((d.marketdata_yields && d.marketdata_yields.data.length > 0) ? d.marketdata_yields : null);
                        
                        let last, open, prev;
                        let changePercent = 0;

                        const getVal = (block, colName) => {
                            if(!block || !block.columns || !block.data || block.data.length === 0) return null;
                            const idx = block.columns.indexOf(colName);
                            return idx !== -1 ? block.data[0][idx] : null;
                        };

                        if (marketdata) {
                            last = getVal(marketdata, 'LAST') || getVal(marketdata, 'CURRENTVALUE') || getVal(marketdata, 'YIELD');
                            open = getVal(marketdata, 'OPEN');
                            
                            // Приоритет: LASTCHANGEPRCNT → LASTCHANGE → ручной расчёт
                            const lastChangePrcnt = getVal(marketdata, 'LASTCHANGEPRCNT');
                            const lastChange = getVal(marketdata, 'LASTCHANGE');
                            
                            if (lastChangePrcnt != null && lastChangePrcnt !== 0) {
                                changePercent = lastChangePrcnt;
                            } else if (lastChange != null && last && (last - lastChange) > 0) {
                                changePercent = (lastChange / (last - lastChange)) * 100;
                            } else if (last && open && open > 0) {
                                changePercent = ((last - open) / open) * 100;
                            }
                        }

                        if (changePercent === 0 && d.securities && d.securities.data.length > 0) {
                             prev = getVal(d.securities, 'PREVPRICE');
                             if(!last) last = prev; 
                             if(last && prev && prev > 0) {
                                 changePercent = ((last - prev) / prev) * 100;
                             }
                        }
                        
                        if(last) {
                            animateValue(valEl, last, '', suffix, suffix ? 2 : 0);
                            hideSkeleton('skeleton-market-tiles');
                        }
                        setDynamics(dynEl, changePercent, tileId);
                    }).catch(e => {
                        console.log("MOEX error for:", valEl.id, e);
                        valEl.innerText = "---";
                    });
            };

            fetchMoex(moexUrl('/iss/engines/stock/markets/index/securities/IMOEX.json?iss.meta=off&iss.only=securities,marketdata'), document.getElementById('val-imoex'), document.getElementById('dyn-imoex'), 'tile-imoex', '');
            
            // USD/RUB - берём курс ЦБ РФ
            fetch(moexUrl('/iss/statistics/engines/currency/markets/selt/rates.json?iss.meta=off'))
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(json => {
                    const valEl = document.getElementById('val-usdrub');
                    const dynEl = document.getElementById('dyn-usdrub');
                    const tileId = 'tile-usdrub';
                    
                    // Получаем индексы колонок
                    const columns = json.cbrf.columns;
                    const data = json.cbrf.data[0];
                    
                    // Текущий курс ЦБ РФ
                    const lastIdx = columns.indexOf('CBRF_USD_LAST');
                    const last = data[lastIdx];
                    
                    // Пробуем несколько источников для изменения
                    let changePercent = 0;
                    
                    // 1. Пробуем CBRF_USD_LASTCHANGEPRCNT
                    const changePrcntIdx = columns.indexOf('CBRF_USD_LASTCHANGEPRCNT');
                    if (changePrcntIdx >= 0 && data[changePrcntIdx] != null) {
                        changePercent = data[changePrcntIdx];
                    } else {
                        // 2. Пробуем wap_rates
                        const waprice = json.wap_rates?.data[0]?.[json.wap_rates.columns.indexOf('waprice')];
                        if (last && waprice && waprice > 0) {
                            changePercent = ((last - waprice) / waprice) * 100;
                        } else {
                            // 3. Пробуем CBRF_USD_LASTCHANGE для абсолютного изменения
                            const changeIdx = columns.indexOf('CBRF_USD_LASTCHANGE');
                            if (changeIdx >= 0 && data[changeIdx] != null && last) {
                                const prevRate = last - data[changeIdx];
                                if (prevRate > 0) {
                                    changePercent = (data[changeIdx] / prevRate) * 100;
                                }
                            }
                        }
                    }
                    
                    if (last) {
                        animateValue(valEl, last, '', ' ₽', 2);
                    }
                    setDynamics(dynEl, changePercent, tileId);
                })
                .catch(error => {
                    console.error('USD/RUB CBRF error:', error);
                    document.getElementById('val-usdrub').innerText = '---';
                });
            
             fetch(moexUrl('/iss/engines/stock/markets/bonds/securities/SU26244RMFS2.json?iss.meta=off&iss.only=securities,marketdata'))
                .then(r => r.json())
                .then(d => {
                     const md = d.marketdata || d.marketdata_yields;
                     if(md && md.data.length > 0) {
                         const yIdx = md.columns.indexOf('YIELD');
                         const y = md.data[0][yIdx];
                         if(y) {
                             animateValue(document.getElementById('val-ofz10'), y, '', '%', 2);
                         }
                     }
                }).catch(e => console.log('OFZ fetch error'));
        }

        setInterval(updateMarketData, 30000);
        
        
                // Глобальный флаг: пришли ли мы на screen-assets через главное меню
                var assetsFromMainNav = false;

                function showScreen(screenId, fromMainNav) {
            // Список портфельных экранов
            const portfolioScreens = ['screen-portfolio', 'screen-stub', 'screen-assets'];

            // Всегда снимаем register-mode при переходе на любой другой экран
            if (screenId !== 'screen-register') {
                document.body.classList.remove('register-mode');
            }

            // Запоминаем флаг для screen-assets
            if (screenId === 'screen-assets') {
                assetsFromMainNav = !!fromMainNav;
            } else {
                assetsFromMainNav = false;
            }

            // 1. Логика для меню: если это Главная (screen-home)
            if (screenId === 'screen-home') {
                document.body.classList.add('home-mode'); // Включаем "прозрачный" режим
                document.body.classList.remove('compact-nav');
                document.body.classList.remove('dashboard-home-mode');
                document.getElementById('navWrapper').style.display = 'flex';
                document.getElementById('stickyPanel').style.display = 'none';
            } else if (screenId === 'screen-dashboard') {
                // Dashboard — compact nav like other screens
                document.body.classList.remove('home-mode');
                document.body.classList.add('compact-nav');
                document.body.classList.remove('dashboard-home-mode');
                document.getElementById('navWrapper').style.display = 'flex';
                document.getElementById('stickyPanel').style.display = 'none';
                // Обновляем данные дашборда
                if (window._currentUser) populateDashboard(window._currentUser);
            } else if (screenId === 'screen-register') {
                // Регистрация — без навигации
                document.body.classList.remove('home-mode');
                document.body.classList.remove('compact-nav');
                document.body.classList.remove('dashboard-home-mode');
                document.body.classList.add('register-mode');
                document.getElementById('navWrapper').style.display = 'none';
                document.getElementById('stickyPanel').style.display = 'none';
            } else {
                document.body.classList.remove('home-mode');
                document.body.classList.remove('dashboard-home-mode');
                
                // Компактный режим: на всех страницах кроме главной и портфельных
                if (!portfolioScreens.includes(screenId) || (screenId === 'screen-assets' && assetsFromMainNav)) {
                    document.body.classList.add('compact-nav');
                } else {
                    document.body.classList.remove('compact-nav');
                }
                
                // Управление видимостью stickyPanel как в оригинале
                const stickyPanel = document.getElementById('stickyPanel');
                if (stickyPanel) {
                    stickyPanel.style.display = (screenId === 'screen-app') ? 'block' : 'none';
                }
            }

            // Старая логика функции (оставляем как было)
            if(screenId !== 'screen-interesting' && screenId !== 'screen-company') {
                lastNavScreen = screenId;
                collapseSearch(false);
            }
            
            currentScreen = screenId;
            
            // Показываем нужный экран
            const targetScreen = document.getElementById(screenId);
            document.querySelectorAll('.screen').forEach(s => {
                // При свайпе не убираем active/display с целевого экрана — он уже виден
                if (window._swipeNavigation && s === targetScreen) return;
                s.classList.remove('active');
            });
            if(targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Обновляем навигацию
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('nav-search').classList.remove('active');
            
            // Подсветка кнопок
            let navId = `nav-${screenId.split('-')[1]}`;
            // Dashboard использует кнопку "домик"
            if (screenId === 'screen-dashboard') navId = 'nav-home';
            const navBtn = document.getElementById(navId);
            if (navBtn) navBtn.classList.add('active');
            
            if(screenId === 'screen-interesting' || screenId === 'screen-company') {
                document.getElementById('nav-search').classList.add('active');
            }
            
            // При переходе на экран ребалансировки - рендерим таблицу акций
            if (screenId === 'screen-assets') {
                renderAuroraStocksTable();
                renderAuroraOfzList();
            }
            
            // Action Panel логика - используем новую панель V2
            const portfolioActionPanelV2 = document.getElementById('portfolioActionPanelV2');
            if (portfolioActionPanelV2) {
                if (screenId === 'screen-portfolio' && isPortfolioCalculated) {
                    portfolioActionPanelV2.style.display = 'flex';
                    // Синхронизируем данные при переключении на портфель
                    if (typeof syncPortfolioDataToV2 === 'function') {
                        syncPortfolioDataToV2();
                    }
                } else {
                    portfolioActionPanelV2.style.display = 'none';
                }
            }
            
            // Показываем/скрываем 3 иконки действий в заголовке портфеля
            const portfolioActionBtns = document.getElementById('portfolioActionBtns');
            if (portfolioActionBtns) {
                portfolioActionBtns.style.display = (screenId === 'screen-portfolio' && isPortfolioCalculated) ? 'flex' : 'none';
            }
            
            // Скрываем старую панель
            const portfolioActionPanel = document.getElementById('portfolioActionPanel');
            if (portfolioActionPanel) {
                portfolioActionPanel.style.display = 'none';
            }
            
            window.scrollTo({top: 0, behavior: window._swipeNavigation ? 'auto' : 'smooth'});
            if (!window._swipeNavigation && window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');

                    if (typeof checkMenuVisibility === 'function') {
        checkMenuVisibility(screenId);
    }
                    
        }


        
        function expandSearch() {
            const backBtn = document.querySelector('#expandedNav .nav-back-island');
            const activeNavId = `nav-${lastNavScreen.split('-')[1]}`;
            const activeNav = document.getElementById(activeNavId);

            if (activeNav && backBtn) {
                const iconSvg = activeNav.querySelector('svg').cloneNode(true);
                backBtn.innerHTML = '';
                backBtn.appendChild(iconSvg);
            }
            
            document.getElementById('standardNav').classList.add('hidden');
            document.getElementById('nav-search').style.display = 'none';
            document.getElementById('expandedNav').classList.add('active');
            showScreen('screen-interesting');
            setTimeout(() => {
                document.getElementById('tickerSearchInput').focus();
            }, 300);
        }

        function collapseSearch(goBack = true) {
            document.getElementById('expandedNav').classList.remove('active');
            document.getElementById('standardNav').classList.remove('hidden');
            document.getElementById('nav-search').style.display = 'flex';
            document.getElementById('tickerSearchInput').blur();
            document.getElementById('tickerSearchInput').value = '';
            
            if(goBack) showScreen(lastNavScreen);
        }

        function goBackFromCompany() {
            showScreen('screen-interesting');
        }

        function handleSearchKeyup(event) {
            if(event.keyCode === 13) {
                performSearch(event.target.value);
            }
        }

        // Функция показа уведомления
function showLuxuryNotification() {
    const notify = document.getElementById('luxuryNotification');
    
    // 1. Показываем (добавляем класс)
    notify.classList.add('show');
    
    // 2. Haptic Feedback (Вибрация ошибки)
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
    }
    
    // 3. Прячем через 3.5 секунды
    setTimeout(() => {
        notify.classList.remove('show');
    }, 3500);
}

// Основная функция расчета
function calculateAndShowPortfolio() {
    // 1. Проверка СУММЫ (как было)
    const sum = getSumInputValue();
    if (sum < 100000) {
        showLuxuryNotification();
        const inputBlock = document.querySelector('.input-wrapper');
        if (inputBlock) {
            inputBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
    }

    // 2. НОВАЯ ПРОВЕРКА: КОМИССИЯ
    if (!isFeeSelected) {
        // Находим блок комиссии (обертку)
        const feeBlock = document.querySelector('.fee-unified-wrapper');
        
        if (feeBlock) {
            // Прокручиваем к нему
            feeBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Добавляем класс тряски
            feeBlock.classList.add('shake-error');
            
            // Вибрация ошибки
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
            
            // Убираем класс через 0.5 сек, чтобы можно было потрясти снова
            setTimeout(() => {
                feeBlock.classList.remove('shake-error');
            }, 500);
        }
        return; // ОСТАНАВЛИВАЕМ ПЕРЕХОД
    }

    // 3. УСПЕХ (Все проверки пройдены)
    try {
        draw();
        savePortfolio();
        isPortfolioCalculated = true;
        
        document.getElementById('portfolio-empty').style.display = 'none';
        document.getElementById('portfolio-content').style.display = 'block';
        
        // Показываем 3 иконки действий
        const actionBtns = document.getElementById('portfolioActionBtns');
        if(actionBtns) actionBtns.style.display = 'flex';
        
        // Показываем новую панель действий
        const actionPanelV2 = document.getElementById('portfolioActionPanelV2');
        if(actionPanelV2) actionPanelV2.style.display = 'flex';
        
        // Скрываем старую панель (на случай если она есть)
        const actionPanel = document.getElementById('portfolioActionPanel');
        if(actionPanel) actionPanel.style.display = 'none';
        
        // Синхронизируем данные в новый дизайн
        syncPortfolioDataToV2();
        
        // Сбрасываем на страницу "К ПОКУПКЕ"
        switchPortfolioPage('buy');
        
        // Логика переключателя Денежный поток / Растущая часть
        const slider = document.getElementById('ratioSlider');
        const currentBondPct = slider ? parseInt(slider.value) : 50;
        const tabSwitcher = document.getElementById('portfolioTabSwitcher');
        
        if (currentBondPct === 0) {
            // 100% акций — показываем только Растущую часть
            if (tabSwitcher) tabSwitcher.style.display = 'none';
            switchPortfolioContentTab('stocks');
        } else if (currentBondPct === 100) {
            // 100% облигаций — показываем только Денежный поток
            if (tabSwitcher) tabSwitcher.style.display = 'none';
            switchPortfolioContentTab('bonds');
        } else {
            // Смешанный — показываем обе вкладки
            if (tabSwitcher) tabSwitcher.style.display = '';
            switchPortfolioContentTab('bonds');
        }
        
        showScreen('screen-portfolio');
    } catch(e) {
        console.error('Error calculating portfolio:', e);
    }
}


        function toggleAccordion(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        }

    /* ============================================
       6.3 Анимация Накручивания Цифр (Evolution Design)
       При загрузке страницы цифры "накручиваются" от 0 до значения
       ============================================ */
    function animateCountUp(element, targetValue, duration = 800) {
        if (!element) return;
        
        // Парсим целевое значение
        const isPercentage = targetValue.includes('%');
        const hasComma = targetValue.includes(',');
        const hasDot = targetValue.includes('.');
        
        // Извлекаем числовое значение
        let numericValue = parseFloat(targetValue.replace(/[^0-9.,\-]/g, '').replace(',', '.'));
        if (isNaN(numericValue)) {
            element.textContent = targetValue;
            return;
        }
        
        // Определяем количество десятичных знаков
        let decimals = 0;
        if (hasDot || hasComma) {
            const parts = targetValue.replace(',', '.').split('.');
            if (parts[1]) decimals = parts[1].replace(/[^0-9]/g, '').length;
        }
        
        const startTime = performance.now();
        const startValue = 0;
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing функция - easeOutExpo для плавного завершения
            const eased = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
            
            const currentValue = startValue + (numericValue - startValue) * eased;
            
            // Форматируем значение
            let formattedValue = currentValue.toFixed(decimals);
            if (hasComma) formattedValue = formattedValue.replace('.', ',');
            
            // Добавляем суффикс
            if (isPercentage) formattedValue += '%';
            
            element.textContent = formattedValue;
            
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                // Устанавливаем точное конечное значение
                element.textContent = targetValue;
            }
        }
        
        requestAnimationFrame(update);
    }
    
    // Запуск анимации для экрана Интересное
    function initInterestingAnimations() {
        // Курсы валют
        const marketValues = [
            { id: 'val-imoex', target: null },
            { id: 'val-usdrub', target: null },
            { id: 'val-btc', target: null }
        ];
        
        // Ставки
        const rateValues = [
            { id: 'val-inflation', target: '9.1%' },
            { id: 'val-deposit-rate', target: '21.5%' },
            { id: 'val-key-rate', target: '21.0%' },
            { id: 'val-ofz10', target: null }
        ];
        
        // Анимируем только значения, которые уже установлены
        rateValues.forEach((item, index) => {
            const el = document.getElementById(item.id);
            if (el && el.textContent && el.textContent !== '---' && el.textContent !== '---%') {
                const target = el.textContent;
                el.textContent = '0%';
                setTimeout(() => {
                    animateCountUp(el, target, 600 + index * 100);
                }, index * 80);
            }
        });
    }
    
    // Наблюдатель за переключением на экран Интересное
    const originalShowScreen = typeof showScreen === 'function' ? showScreen : null;
    
    // Переопределим showScreen чтобы запускать анимацию
    if (typeof window !== 'undefined') {
        const _originalShowScreen = window.showScreen;
        window.showScreenWithAnimation = function(screenId) {
            if (_originalShowScreen) _originalShowScreen(screenId);
            
            if (screenId === 'screen-interesting') {
                setTimeout(initInterestingAnimations, 100);
            }
        };
    }
    
    // Новая функция для аккордеона калькулятора в "Интересное"
// Флаг: инпут калькулятора был только что в фокусе
let _calcInputWasActive = false;

// Отслеживаем blur на инпутах калькулятора
document.addEventListener('focusout', function(e) {
    if (e.target && (e.target.id === 'monthlySumInput' || e.target.classList.contains('calc-input'))) {
        _calcInputWasActive = true;
        setTimeout(() => { _calcInputWasActive = false; }, 300);
    }
});

function toggleCalcAccordion() {
    const accordion = document.getElementById('calcAccordion');
    if (!accordion) return;
    
    // Если инпут калькулятора только что потерял фокус — не сворачиваем, клавиатура уже закрылась
    if (_calcInputWasActive) {
        _calcInputWasActive = false;
        return;
    }
    
    accordion.classList.toggle('collapsed');
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    } else if (navigator.vibrate) {
        navigator.vibrate(5);
    }
}

// Toggle для секции "Смотреть далее" на вкладке Интересное
function toggleInterestingMore() {
    const trigger = document.getElementById('interestingGhostTrigger');
    const section = document.getElementById('infographicSection');
    const text = document.getElementById('interestingGhostText');
    
    if (!trigger || !section) return;
    
    const isOpen = trigger.classList.contains('open');
    
    if (isOpen) {
        // Закрываем
        trigger.classList.remove('open');
        section.style.display = 'none';
        text.textContent = 'СМОТРЕТЬ ДАЛЕЕ';
    } else {
        // Открываем
        trigger.classList.add('open');
        section.style.display = 'block';
        text.textContent = 'СКРЫТЬ';
    }
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    } else if (navigator.vibrate) {
        navigator.vibrate(5);
    }
}

        function toggleCouponSection() {
            const content = document.getElementById('couponContent');
            const arrow = document.getElementById('couponArrow');
            content.classList.toggle('active');
            arrow.classList.toggle('rotated');
        }

        function toggleEchelonTable(btn) {
            const wrapper = document.getElementById('echelon-wrapper');
            wrapper.classList.toggle('collapsed');
            if(btn && btn.classList) btn.classList.toggle('open');
        }

        function toggleOfzTable(btn) {
            const wrapper = document.getElementById('ofz-wrapper');
            wrapper.classList.toggle('collapsed');
            if(btn && btn.classList) btn.classList.toggle('open');
        }
        
        function toggleOfzDetails(id) {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('active');
        }
        
        function toggleInfoBlock(headerElement) {
            event.stopPropagation();
            let nextEl = headerElement.nextElementSibling;
            while(nextEl) {
                if (nextEl.classList.contains('info-expanded-block')) {
                    nextEl.classList.toggle('show');
                    break;
                }
                nextEl = nextEl.nextElementSibling;
            }
        }

        function toggleEchelonTip(event, tipId) {
            event.stopPropagation();
            const allTips = document.querySelectorAll('.echelon-tip');
            allTips.forEach(t => {
                if(t.id !== tipId) t.classList.remove('show');
            });
            const tip = document.getElementById(tipId);
            if(tip) tip.classList.toggle('show');
        }

        function showYieldInfo(event) {
            event.stopPropagation();
            const infoBox = document.getElementById('yield-info-box');
            if (infoBox) {
                infoBox.classList.toggle('show');
            }
        }
        
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeBtn');
            const sunIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
            const moonIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode'); body.classList.add('light-mode');
                btn.innerHTML = moonIcon; localStorage.setItem('user_theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode'); btn.innerHTML = sunIcon; localStorage.setItem('user_theme', 'dark');
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('user_theme');
            const btn = document.getElementById('themeBtn');
            const sunIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
            const moonIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
            if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); btn.innerHTML = sunIcon; }
            else { document.body.classList.add('light-mode'); btn.innerHTML = moonIcon; }
        }

        function saveSettings() {
    // Автосохранение отключено
    // Настройки сбрасываются при каждом открытии
}

    // ========== НОВАЯ ФУНКЦИЯ - НАЧАЛО ==========
function savePortfolio() {
    try {
        const portfolioData = {
            sum: getSumInputValue(),
            ratio: parseInt(document.getElementById('ratioSlider').value),
            fee: brokerFee,
            tax: currentTax,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('portfolio_snapshot', JSON.stringify(portfolioData));
        console.log('Portfolio saved:', portfolioData);
    } catch(e) {
        console.error('Error saving portfolio:', e);
    }
}
// ========== НОВАЯ ФУНКЦИЯ - КОНЕЦ ==========

       /* ========== NEW LOGIC FOR GHOST SLIDER ========== */

// Функция переключения состояния (Открыть/Закрыть)
function toggleStrategies() {
    const container = document.getElementById('waterfallContainer');
    const trigger = document.getElementById('ghostTrigger');
    const text = document.getElementById('ghostText');
    const customBlock = document.getElementById('customStrategyExpanded');
    
    // Переключаем классы
    const isOpen = container.classList.toggle('show');
    trigger.classList.toggle('open');
    
    // Меняем текст и вибрацию
    if(isOpen) {
        text.innerText = "ЗАКРЫТЬ";
        if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    } else {
        text.innerText = "ОТКРЫТЬ СТРАТЕГИИ";
        // Если закрываем список, закрываем и кастомную настройку, если она открыта
        if(customBlock) customBlock.classList.remove('show');
    }
}

// Функция выбора стратегии (обновляет главную карточку)
function selectStrategy(bondPercent, optionCard, title, subtitle) {
    // 1. Обновляем данные слайдера
    document.getElementById('ratioSlider').value = bondPercent;
    
    // 2. Визуально обновляем ГЛАВНУЮ карточку (тексты, цвета)
    updateMainCardUI(bondPercent, title, subtitle);

    // 3. Сбрасываем кастомный режим, если выбрана стандартная стратегия
    if(title !== 'Индивидуальная') {
        savedCustomBonds = null;
        document.getElementById('customStrategyExpanded').classList.remove('show');
    }

    // 4. Закрываем список с небольшой задержкой (для красоты)
    setTimeout(() => {
        toggleStrategies(); 
    }, 150);

    // 5. Запускаем draw (он теперь сам вызовет updateStrategyCardSelection внутри себя)
    draw();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Обновление UI главной карточки
function updateMainCardUI(bondPercent, title, subtitle) {
    const stockPercent = 100 - bondPercent;
    
    // Тексты
    document.getElementById('mainCardTitle').innerText = title;
    document.getElementById('mainCardSubtitle').innerText = subtitle;
    document.getElementById('mainCardBonds').innerText = `Обл. ${bondPercent}%`;
    document.getElementById('mainCardStocks').innerText = `Акц. ${stockPercent}%`;
    
    // Градиент индикатора
    const indicator = document.getElementById('mainCardIndicator');
    indicator.style.background = `linear-gradient(180deg, #5B7C99 0%, #5B7C99 ${bondPercent}%, #94A8B8 ${bondPercent}%, #94A8B8 100%)`;
}

// Логика для кастомной стратегии (адаптированная)
function toggleCustomStrategyNew(cardElement) {
    const expanded = document.getElementById('customStrategyExpanded');
    const isOpening = !expanded.classList.contains('show');
    
    if (isOpening) {
        expanded.classList.add('show');
        // Плавно скроллим к настройкам, чтобы их было видно
        expanded.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // ЭТОТ БЛОК СРАБОТАЕТ ПРИ НАЖАТИИ "ГОТОВО"
        expanded.classList.remove('show');
        
        // ВОЗВРАЩАЕМ ЭКРАН В САМЫЙ ВЕРХ (к вводу суммы)
        // Используем setTimeout, чтобы скролл начался после того, как блок начнет скрываться
        setTimeout(() => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }, 50);
    }
}



// Переопределяем функцию сохранения кастомной стратегии
saveCustomStrategy = function() {
    const bondPct = parseInt(document.getElementById('customRatioSlider').value);
    const stockPct = 100 - bondPct;
    
    savedCustomBonds = bondPct;
    savedCustomStocks = stockPct;
    
    document.getElementById('ratioSlider').value = bondPct;
    
    // 1. Убираем фокус с любых полей (важно для iOS)
    if (document.activeElement) document.activeElement.blur();
    
    // 2. Обновляем UI
    updateMainCardUI(bondPct, 'Индивидуальная', 'Ваша настройка');
    
    // 3. Сворачиваем ВНУТРЕННИЙ блок (анимация началась)
    document.getElementById('customStrategyExpanded').classList.remove('show');
    
    // 4. ПЕРВАЯ ПРОКРУТКА (Плавная)
    // Запускаем её сразу, пока страница еще длинная
    const inputBlock = document.querySelector('.input-wrapper');
    if (inputBlock) {
        inputBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 5. ЗАКРЫВАЕМ ВНЕШНИЙ СПИСОК С ЗАДЕРЖКОЙ
    // Даем 400мс, чтобы сработал первый скролл и прошла анимация внутреннего блока
    setTimeout(() => {
        const container = document.getElementById('waterfallContainer');
        const trigger = document.getElementById('ghostTrigger');
        
        if (container && container.classList.contains('show')) {
            container.classList.remove('show');
            if (trigger) trigger.classList.remove('open');
            const text = document.getElementById('ghostText');
            if (text) text.innerText = "ОТКРЫТЬ СТРАТЕГИИ";
        }

        // 6. ВТОРАЯ ПРОКРУТКА (Мгновенная - страховка)
        // Это "лечит" залипание. Если браузер заблокировал скролл,
        // эта команда принудительно вернет его наверх после изменения высоты.
        window.scrollTo({ top: 0, behavior: 'auto' });
        
    }, 400); 
    
    draw();
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}


        

        // NEW: Dropdown для тарифа комиссии
let isFeeSelected = false;

function toggleFeeDropdown() {
    try {
        const trigger = document.getElementById('feeDropdownTrigger');
        const menu = document.getElementById('feeDropdownMenu');
        
        if (!menu) {
            console.error('Menu not found!');
            return;
        }

        // Переключаем классы
        const isNowOpen = trigger.classList.toggle('open');
        menu.classList.toggle('show'); // Этот класс активирует display: block !important
        
        // Вращаем стрелку
        const arrow = trigger.querySelector('.fee-dropdown-arrow');
        if(arrow) arrow.style.transform = isNowOpen ? 'rotate(180deg)' : 'rotate(0deg)';

        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    } catch (e) {
        console.error(e);
    }
}

function selectFee(value, rateText, nameText) {
    const sumInput = document.getElementById('sumInput');
    if (sumInput) sumInput.blur();
    
    brokerFee = value;
    
    // ВАЖНО: Запоминаем, что выбор сделан
    isFeeSelected = true; 
    
    // Обновляем текст
    const selectedText = document.getElementById('feeSelectedText');
    if (selectedText) {
        selectedText.textContent = rateText;
        selectedText.classList.remove('placeholder');
    }
    
    // Логика галочек
    document.querySelectorAll('.fee-dropdown-item').forEach(item => {
        item.classList.remove('selected');
    });
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('selected');
    }
    
    toggleFeeDropdown();
    draw();
}

// Закрытие dropdown при клике вне его
document.addEventListener('click', function(event) {
    const container = document.querySelector('.fee-selector-unified');
    const menu = document.getElementById('feeDropdownMenu');
    const trigger = document.getElementById('feeDropdownTrigger');
    
    // Если клик НЕ внутри контейнера комиссии - закрываем
    if (container && !container.contains(event.target)) {
        if(menu) menu.classList.remove('show');
        if(trigger) trigger.classList.remove('open');
        const arrow = trigger?.querySelector('.fee-dropdown-arrow');
        if(arrow) arrow.style.transform = 'rotate(0deg)';
    }
});


        function setTax(val, btn) {
            currentTax = val;
            document.querySelectorAll('#taxGroupV2 .tax-ui-btn').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.selectionChanged();
            }
            draw();
        }
        
        function setCustomTax(val, btn) {
    customTax = val;
    
    // Убираем active со всех кнопок налога
    const taxButtons = document.querySelectorAll('#screen-interesting .tax-segment, #tax-custom-0, #tax-custom-13, #tax-custom-15');
    taxButtons.forEach(b => b.classList.remove('active'));
    
    // Добавляем active на нажатую кнопку
    btn.classList.add('active');
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.selectionChanged();
    }
    
    distributeMonthlyInvestment();
}

        function shortenTicker(t) { return t.length > 7 ? t.substring(0, 7) : t; }
        function limitName(n) { return n.length > 18 ? n.substring(0, 16) + '...' : n; }
        function styledName(n) {
            const limited = limitName(n);
            return limited.replace(/(\d+)/g, '<span style="font-family:\'JetBrains Mono\',monospace">$1</span>');
        }
        function hideAllTips(event) { 
            document.querySelectorAll('.echelon-tip, .info-preview-box').forEach(el => {
                if(!el.contains(event.target) && !event.target.closest('.section-header-styled')) {
                    el.classList.remove('show')
                }
            });
            if(event && event.target.tagName !== 'INPUT') { 
                if(document.getElementById('sumInput')) document.getElementById('sumInput').blur();
                if(document.getElementById('monthlySumInput')) document.getElementById('monthlySumInput').blur();
            } 
        }

    
// NEW: Форматирование суммы с разделителями и адаптивным размером


    function adjustInputWidth(input) {
    // Создаем временный span для измерения ширины текста
    const span = document.createElement('span');
    const computedStyle = window.getComputedStyle(input);
    span.style.font = computedStyle.font;
    span.style.fontSize = computedStyle.fontSize; // Берём ТЕКУЩИЙ размер шрифта (с учётом классов)
    span.style.fontWeight = computedStyle.fontWeight;
    span.style.letterSpacing = computedStyle.letterSpacing;
    span.style.fontFamily = computedStyle.fontFamily;
    span.style.visibility = 'hidden';
    span.style.position = 'absolute';
    span.style.whiteSpace = 'nowrap';
    span.textContent = input.value || input.placeholder;
    
    document.body.appendChild(span);
    const width = span.offsetWidth;
    document.body.removeChild(span);
    
    // Устанавливаем ширину с небольшим запасом (10px вместо 20px)
    input.style.width = Math.max(200, Math.min(width + 10, window.innerWidth * 0.85)) + 'px';
}
    

// NEW: Адаптивный размер шрифта в зависимости от длины
function adjustSumInputSize(input) {
    const length = input.value.length;
    
    // Убираем все классы размера
    input.classList.remove('size-large', 'size-medium', 'size-small', 'size-xsmall');
    
    // Добавляем нужный класс
    if (length <= 7) {
        input.classList.add('size-large');      // до 999.999
    } else if (length <= 11) {
        input.classList.add('size-medium');     // до 99.999.999
    } else if (length <= 15) {
        input.classList.add('size-small');      // до 999.999.999.999
    } else {
        input.classList.add('size-xsmall');     // больше
    }
}

// NEW: Получить числовое значение из форматированного поля
function getSumInputValue() {
    const input = document.getElementById('sumInput');
    if (!input) {
        console.log('getSumInputValue: input not found');
        return 0;
    }
    
    const value = input.value;
    console.log('getSumInputValue: raw value:', value);
    
    const cleanValue = value.replace(/\./g, '');
    console.log('getSumInputValue: clean value:', cleanValue);
    
    const result = parseInt(cleanValue) || 0;
    console.log('getSumInputValue: result:', result);
    
    return result;
}

// NEW: Скрытие меню при фокусе на вводе
                function onSumInputFocus(input) {
            document.body.classList.add('input-focused');
            
            if (input.value === "0") {
                input.value = "";
            }
        }



// NEW: Показ меню при потере фокуса
                        function onSumInputBlur(input) {
            document.body.classList.remove('input-focused');
            
            if (input.value === "") {
                const currencyGold = document.getElementById('currencySymbol');
                const currencyGray = document.getElementById('currencyPlaceholder');
                
                if(currencyGold) currencyGold.style.display = 'none';
                if(currencyGray) currencyGray.style.display = 'block';
                
                input.style.width = '150px'; // Ширина для ВВЕДИТЕ СУММУ
            }
        }



            function formatSumInput(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/^0+/, '') || '';
            const numericValue = parseInt(value) || 0;
            
            const currencyGold = document.getElementById('currencySymbol');
            const currencyGray = document.getElementById('currencyPlaceholder');
            
            if (value.length > 0) {
                // ЕСТЬ ВВОД
                input.value = numericValue.toLocaleString('ru-RU').replace(/\s/g, '.');
                
                // Включаем золото, ВЫРУБАЕМ серый
                if(currencyGold) currencyGold.style.display = 'block';
                if(currencyGray) currencyGray.style.display = 'none';
                
                // Растягиваем инпут под контент
                adjustInputWidth(input);
            } else {
                // ПУСТО (Плейсхолдер)
                input.value = "";
                
                // Включаем серый, ВЫРУБАЕМ золото
                if(currencyGold) currencyGold.style.display = 'none';
                if(currencyGray) currencyGray.style.display = 'block';
                
                // Фиксируем ширину для "0.00", чтобы стояло ровно
                input.style.width = '150px'; 
            }
            
            adjustSumInputSize(input);
            draw();
        }


// NEW: Сброс соотношения на 50/50
function resetRatioTo50() {
    document.getElementById('ratioSlider').value = 50;
    
    // Обновляем выделение карточек
    updateStrategyCardSelection(50);
    
    draw();
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

    



// NEW: Обновление выделения карточки при изменении ползунка
function updateStrategyCardSelection(bondPercent) {
    const cards = document.querySelectorAll('.strategy-option-card');
    // Проверяем, включен ли режим "Своя стратегия" (через наличие сохраненных данных)
    const isCustomMode = (savedCustomBonds !== null);

    cards.forEach(card => {
        const cardBondsAttr = card.getAttribute('data-bonds');
        if (!cardBondsAttr) return;

        // ЛОГИКА ДЛЯ "НАСТРОИТЬ СВОЮ"
        if (cardBondsAttr === 'custom') {
            card.style.display = 'flex'; // Всегда видна
            if (isCustomMode) card.classList.add('selected');
            else card.classList.remove('selected');
            return;
        }

        // ЛОГИКА ДЛЯ СТАНДАРТНЫХ КАРТОЧЕК
        if (isCustomMode) {
            // Если выбрана "Своя", показываем все остальные стандартные
            card.style.display = 'flex';
            card.classList.remove('selected');
        } else {
            // Если выбрана стандартная - скрываем ту, что совпадает по процентам
            if (parseInt(cardBondsAttr) === bondPercent) {
                card.style.display = 'none'; // Убираем из списка (уже наверху)
            } else {
                card.style.display = 'flex';
                card.classList.remove('selected');
            }
        }
    });
}
    

// NEW: Обновление кастомного слайдера
function updateCustomSlider(value) {
    let bondPct = parseInt(value);
    const slider = document.getElementById('customRatioSlider');
    
    // Snap через «мёртвые зоны»: 1-14% и 86-99%
    if (bondPct > 0 && bondPct < 15) {
        bondPct = bondPct < 8 ? 0 : 15;
        if (slider) slider.value = bondPct;
    }
    if (bondPct > 85 && bondPct < 100) {
        bondPct = bondPct > 92 ? 100 : 85;
        if (slider) slider.value = bondPct;
    }
    
    updateCustomSliderDisplay(bondPct);
    
    // НЕ обновляем основной слайдер до нажатия "Готово"
}

// NEW: Обновление отображения кастомного слайдера
// Функция обновления отображения (безопасная версия)
function updateCustomSliderDisplay(bondPct) {
    const stockPct = 100 - bondPct;
    
    // Обновляем большие цифры (они есть в новом дизайне)
    const bondDisplay = document.getElementById('customBondsDisplay');
    const stockDisplay = document.getElementById('customStocksDisplay');
    
    if (bondDisplay) bondDisplay.textContent = bondPct;
    if (stockDisplay) stockDisplay.textContent = stockPct;
    
    // Пытаемся обновить старые подписи (если они вдруг остались), но не ломаем код, если их нет
    const oldBondLabel = document.getElementById('customBondsPct');
    const oldStockLabel = document.getElementById('customStocksPct');
    if (oldBondLabel) oldBondLabel.textContent = bondPct;
    if (oldStockLabel) oldStockLabel.textContent = stockPct;
    
    // Обновляем индикатор точек
    updateDotsIndicator(bondPct);
}


    // NEW: Обновление индикатора точек
function updateDotsIndicator(bondPct) {
    const dots = document.querySelectorAll('.custom-dot');
    const thresholds = [0, 25, 50, 75, 100];
    
    // Находим ближайший порог
    let closestIndex = 0;
    let minDiff = Math.abs(bondPct - thresholds[0]);
    
    thresholds.forEach((threshold, index) => {
        const diff = Math.abs(bondPct - threshold);
        if (diff < minDiff) {
            minDiff = diff;
            closestIndex = index;
        }
    });
    
    dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === closestIndex);
    });
}

    // NEW: Сохранение кастомной стратегии
function saveCustomStrategy() {
    const bondPct = parseInt(document.getElementById('customRatioSlider').value);
    const stockPct = 100 - bondPct;
    
    // Сохраняем значения
    savedCustomBonds = bondPct;
    savedCustomStocks = stockPct;
    
    // Обновляем основной слайдер
    document.getElementById('ratioSlider').value = bondPct;
    
    // Обновляем отображение кастомной карточки
    updateCustomCardDisplay(bondPct, stockPct);
    
    // Закрываем панель настройки
    const expandedBlock = document.getElementById('customStrategyExpanded');
    expandedBlock.classList.remove('show');
    
    // Оставляем карточку выбранной
    const customCard = document.getElementById('customStrategyCard');
    customCard.classList.add('selected');
    
    // Перерисовываем
    draw();
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}

    // NEW: Обновление отображения кастомной карточки после сохранения
function updateCustomCardDisplay(bondPct, stockPct) {
    const customCard = document.getElementById('customStrategyCard');
    const indicator = document.getElementById('customIndicator');
    const subtitle = document.getElementById('customSubtitle');
    const bondsText = document.getElementById('customCardBonds');
    const stocksText = document.getElementById('customCardStocks');
    
    // Добавляем класс сохранённого состояния
    customCard.classList.add('has-saved');
    
    // Устанавливаем градиент индикатора
    indicator.style.background = `linear-gradient(180deg, #5B7C99 0%, #5B7C99 ${bondPct}%, #94A8B8 ${bondPct}%, #94A8B8 100%)`;
    
    // Меняем подзаголовок
    subtitle.textContent = 'Индивидуальная';
    
    // Обновляем проценты
    bondsText.textContent = `Обл. ${bondPct}%`;
    stocksText.textContent = `Акц. ${stockPct}%`;
}

    // NEW: Сброс отображения кастомной карточки
function resetCustomCardDisplay() {
    const customCard = document.getElementById('customStrategyCard');
    const subtitle = document.getElementById('customSubtitle');
    
    // Убираем класс сохранённого состояния
    customCard.classList.remove('has-saved');
    
    // Возвращаем подзаголовок
    subtitle.textContent = 'Выберите своё соотношение';
    
    // Сбрасываем сохранённые значения
    savedCustomBonds = null;
    savedCustomStocks = null;
}

// NEW: Кнопки +/- для кастомной стратегии
function adjustCustomRatio(delta) {
    const slider = document.getElementById('customRatioSlider');
    if (!slider) return;
    
    let newValue = parseInt(slider.value) + delta;
    newValue = Math.max(0, Math.min(100, newValue));
    
    // Прыжок через «мёртвые зоны»: 1-14% и 86-99%
    // Если доля облигаций < 15% но > 0% → прыгаем на 0% или 15%
    if (newValue > 0 && newValue < 15) {
        newValue = delta > 0 ? 15 : 0; // + → 15%, − → 0%
    }
    // Если доля облигаций > 85% но < 100% → прыгаем на 85% или 100%
    if (newValue > 85 && newValue < 100) {
        newValue = delta > 0 ? 100 : 85; // + → 100%, − → 85%
    }
    
    slider.value = newValue;
    updateCustomSliderDisplay(newValue);
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}


    

// NEW: Сброс кастомной стратегии на 50/50
function resetCustomTo50() {
    document.getElementById('customRatioSlider').value = 50;
    updateCustomSliderDisplay(50);
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}
        function toggleRow(el) {
    el.classList.toggle('is-expanded');
}

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.innerText = `Скопировано: ${text}`;
                toast.className = "toast show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
            });
        }
        
        // Универсальная функция для открытия внешних ссылок без предупреждения Telegram
        function openExternalLink(url) {
            if (window.Telegram?.WebApp?.openLink) {
                // Используем Telegram API - открывает без предупреждения
                window.Telegram.WebApp.openLink(url);
            } else {
                // Fallback для браузера
                window.open(url, '_blank');
            }
        }
        
        function copyTicker(e, text) {
            e.stopPropagation();
            copyToClipboard(text);
        }
        
        function openTradingView(e, ticker) {
            e.stopPropagation();
            const url = `https://ru.tradingview.com/chart/?symbol=MOEX:${ticker}`;
            openExternalLink(url);
        }

        async function fetchBondData(code) {
    if (!code) return { nkd: 0, matDate: '—', price: 0 };
    
    // Проверяем кэш
    if (bondDataCache[code]) {
        console.log(`[CACHE] Данные из кэша для ${code}`);
        return bondDataCache[code];
    }
    
    try {
        // ПРЯМОЙ ЗАПРОС (как было раньше)
        const url = MOEX_PROXY + '?path=' + encodeURIComponent(`/iss/engines/stock/markets/bonds/securities/${code}.json?iss.meta=off&iss.only=securities,marketdata`);
        
        console.log(`[NET] Запрос к MOEX: ${code}`);
        const res = await fetch(url);
        
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        
        const data = await res.json(); 
        
        const sec_cols = data.securities.columns; 
        const sec_row = data.securities.data[0];
        
        let lastPrice = 0;
        
        // 1. Ищем цену в рыночных данных (перебираем ВСЕ строки — разные boardid)
        if (data.marketdata && data.marketdata.data.length > 0) {
             const m_cols = data.marketdata.columns;
             const lastIdx = m_cols.indexOf('LAST');
             const prevIdx = m_cols.indexOf('PREVPRICE');
             
             for (let i = 0; i < data.marketdata.data.length; i++) {
                 const m_row = data.marketdata.data[i];
                 if (lastIdx !== -1 && m_row[lastIdx]) {
                     lastPrice = m_row[lastIdx];
                     break;
                 }
             }
             
             if (!lastPrice) {
                 for (let i = 0; i < data.marketdata.data.length; i++) {
                     const m_row = data.marketdata.data[i];
                     if (prevIdx !== -1 && m_row[prevIdx]) {
                         lastPrice = m_row[prevIdx];
                         break;
                     }
                 }
             }
        }
        
        // 2. Если цены всё еще нет, ищем в SECURITIES (перебираем все строки)
        if (!lastPrice && data.securities && data.securities.data.length > 0) {
             const prevPriceIdx = sec_cols.indexOf('PREVPRICE');
             for (let i = 0; i < data.securities.data.length; i++) {
                 const row = data.securities.data[i];
                 if (prevPriceIdx !== -1 && row[prevPriceIdx]) {
                     lastPrice = row[prevPriceIdx];
                     break;
                 }
             }
        }

        // Обновляем данные для графиков (ваша старая логика)
        if (sec_row) {
            bondCouponsMap[code] = { date: sec_row[sec_cols.indexOf('NEXTCOUPON')], value: parseFloat(sec_row[sec_cols.indexOf('COUPONVALUE')]) || 0 };
            
            const couponPeriod = parseFloat(sec_row[sec_cols.indexOf('COUPONPERIOD')]) || 0;
            const freq = couponPeriod > 0 ? Math.round(365 / couponPeriod) : 0;
            
            bondDetailsMap[code] = {
                matDate: sec_row[sec_cols.indexOf('MATDATE')] || '—',
                couponValue: parseFloat(sec_row[sec_cols.indexOf('COUPONVALUE')]) || 0,
                nextCoupon: sec_row[sec_cols.indexOf('NEXTCOUPON')] || '—',
                couponYield: sec_row[sec_cols.indexOf('COUPONPERCENT')] || '—',
                freq: freq
            };
        }

        // === ВАЖНО: Умножаем на 10 (проценты -> рубли) ===
        // Если цены нет, ставим 0 (заглушки убрали, как вы просили)
        const finalPrice = lastPrice > 0 ? (lastPrice * 10) : 0; 
        
        const result = { 
            nkd: sec_row ? (parseFloat(sec_row[sec_cols.indexOf('ACCRUEDINT')]) || 0) : 0, 
            matDate: (sec_row && sec_row[sec_cols.indexOf('MATDATE')]) || '—', 
            price: finalPrice
        };
        
        // Сохраняем в кэш
        bondDataCache[code] = result;
        
        console.log(`[SUCCESS] ${code}: Цена ${result.price} (из ${lastPrice}%), НКД ${result.nkd}`);
        return result;

    } catch (e) { 
        console.error(`[ERROR] Ошибка загрузки ${code}:`, e);
        // Возвращаем нули, если сеть упала
        return { nkd: 0, matDate: '—', price: 0 }; 
    }
}

    async function loadCompanyDescriptions() {
    try {
        const response = await fetch(CSV_DESCRIPTIONS_URL);
        if (!response.ok) return;
        
        const text = await response.text();
        const rows = text.split('\n').map(row => 
            row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim())
        );
        
        for (let i = 1; i < rows.length; i++) {
            if (rows[i] && rows[i].length > 8) {
                const ticker = rows[i][4] ? String(rows[i][4]).trim() : null;
                const description = rows[i][8] ? String(rows[i][8]).trim() : '';
                if (ticker && description) {
                    companyDescriptions[ticker] = description;
                }
            }
        }
        console.log('Описания загружены:', Object.keys(companyDescriptions).length);
    } catch (e) {
        console.error('Ошибка загрузки описаний:', e);
    }
}

        async function loadData() {
            initTheme();
            checkFirstVisit();
            updateMarketData();
            loadCompanyDescriptions();
            // Init bento ring
            setTimeout(() => { syncBentoRing(); syncBentoMarketData(); }, 1500);
            //updateMarketStatus(); // Временно отключаем, т.к. элемент не существует
            
            try {
    console.log('Fetching data from:', CSV_URL);
    const response = await fetch(CSV_URL, {
        method: 'GET',
        mode: 'cors',
        cache: 'no-cache'
    });
    
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const text = await response.text();
    console.log('Data loaded successfully, length:', text.length);
                // 1. Парсим CSV в массив строк (ЭТА СТРОКА ОБЯЗАТЕЛЬНА)
                const rows = text.split('\n').map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim()));

                // 2. Вертикаль ставок (обновление данных из таблицы)
                if (rows.length > 1 && rows[1].length > 42) {
                    const keyRateVal = rows[1][42]; 
                    if (keyRateVal) ratesData.keyRate = keyRateVal.includes('%') ? keyRateVal : keyRateVal + '%';
                }
                if (rows.length > 2 && rows[2].length > 42) {
                    const depositRateVal = rows[2][42];
                    if (depositRateVal) ratesData.depositRate = depositRateVal.includes('%') ? depositRateVal : depositRateVal + '%';
                }
                if (rows.length > 3 && rows[3].length > 42) {
                    const inflationVal = rows[3][42];
                    if (inflationVal) ratesData.inflation = inflationVal.includes('%') ? inflationVal : inflationVal + '%';
                }
                if (rows.length > 4 && rows[4].length > 42) {  
                    const ofz10Val = rows[4][42];
                    if (ofz10Val) ratesData.ofz10 = ofz10Val.includes('%') ? ofz10Val : ofz10Val + '%';
                }
                updateRatesDisplay();

                // 3. Загрузка Облигаций (3 вкладка)
                let bondList = [];
                for (let i = 2; i <= 9; i++) { 
                    if (rows[i] && rows[i].length > 13 && rows[i][10]) {
                        bondList.push({ 
                            t: rows[i][10], 
                            n: rows[i][11], 
                            p: parseFloat(rows[i][12].replace(',', '.')) || 0, 
                            y: rows[i][13] || '0%',
                            nkd: 0,
                            matDate: '—'
                        }); 
                    }
                }
                bonds = bondList;
                fetchBondDetailsInBackground();

                // 4. Ежемесячный доход (Калькулятор)
                allScheduledPayments = []; 
                let uniqueBondsMap = new Map();

                for (let i = 2; i <= 13; i++) {
                    if (!rows[i]) continue;
                    const dateVal = rows[i][27] || "---"; 
                    const nameVal = rows[i][28] || "---"; 
                    const couponVal = parseFloat(String(rows[i][30]).replace(',', '.')) || 0; 
                    const ticker = rows[i][31] ? String(rows[i][31]).trim() : ''; 

                    allScheduledPayments.push({
                        dateStr: dateVal,
                        displayName: nameVal,
                        paymentTicker: ticker,
                        staticCouponVal: couponVal
                    });
                    console.log(`[COUPON SCHEDULE] row ${i}: date=${dateVal}, name=${nameVal}, coupon(AE)=${couponVal}, ticker=${ticker}, col_AD="${rows[i][29]}", col_AE="${rows[i][30]}"`);

                    if (ticker && !uniqueBondsMap.has(ticker)) {
                        uniqueBondsMap.set(ticker, {
                            t: ticker,          
                            n: rows[i][32] || ticker, 
                            y: rows[i][33] || "0%",
                            p: 1000, 
                            nkd: 0
                        });
                    }
                }

                monthlyIncomeBonds = Array.from(uniqueBondsMap.values());
                renderMonthlyIncomeCards();
                recalcCustomCoupons();
                fetchPricesForMonthlyIncome();

                // 5. Загрузка Акций (3 вкладка - Портфель)
                let allStocks = [];
                for (let i = 11; i <= 22; i++) { 
                    if (rows[i] && rows[i].length > 13 && rows[i][10]) {
                        allStocks.push({ t: rows[i][10], n: rows[i][11], p: parseFloat(rows[i][12].replace(',', '.')) || 0, target: rows[i][13] || '—' });
                    }
                }
                if (allStocks.length > 0) { 
                    echelons[0].assets = allStocks.slice(0, 3);
                    echelons[1].assets = allStocks.slice(3, 6); 
                    echelons[2].assets = allStocks.slice(6, 9); 
                    echelons[3].assets = allStocks.slice(9, 12);
                }
                
                console.log('[DATA LOADED] stocks:', allStocks.length);
                allStocks.forEach(s => console.log(`[DATA STOCK] ${s.t}: price=${s.p}, target=${s.target}`));

                // === 6. НОВАЯ ЛОГИКА: 4 Вкладка (Ребалансировка) с поиском имен ===
                
                // Шаг А: Создаем справочник из колонок F, G, H
                const tickerInfo = {};
                for (let i = 2; i < rows.length; i++) { 
                    if (rows[i] && rows[i].length > 7) {
                        const ticker = rows[i][5] ? String(rows[i][5]).trim() : null; 
                        const name = rows[i][6];       
                        const sector = rows[i][7];      
                        if(ticker) {
                            tickerInfo[ticker] = { 
                                n: name || ticker, 
                                sector: sector || '' 
                            };
                        }
                    }
                }

                // Шаг Б: Заполняем таблицу эшелонов данными из справочника
                echelonTableData = [[], [], [], []];
                for (let i = 2; i <= 13; i++) {
                     if (rows[i] && rows[i].length > 23) {
                        
                        // Функция для обработки одной ячейки (чтобы не копировать код 4 раза)
                        const processAsset = (tickerIndex, targetIndex, echelonArrIndex) => {
                            if(rows[i][tickerIndex]) {
                                const rawTicker = String(rows[i][tickerIndex]).trim();
                                // Ищем в справочнике
                                const info = tickerInfo[rawTicker] || { n: rawTicker, sector: '' };
                                
                                echelonTableData[echelonArrIndex].push({ 
                                    t: rawTicker,        
                                    n: info.n,           
                                    sector: info.sector, 
                                    target: rows[i][targetIndex] || '—' 
                                });
                            }
                        };

                        processAsset(16, 17, 0); // I Эшелон
                        processAsset(18, 19, 1); // II Эшелон
                        processAsset(20, 21, 2); // III Эшелон
                        processAsset(22, 23, 3); // IV Эшелон
                    }
                }
                
                distributeMonthlyInvestment();
                updateEchelonTable();
                renderOfzList();
                
                // Рендерим Aurora таблицу акций
                renderAuroraStocksTable();
                
                // Не вызываем draw() при первой загрузке, чтобы был виден плейсхолдер
                // draw() вызовется когда пользователь начнет вводить сумму
            } catch (e) { 
                console.error("Error in loadData:", e); 
            }
        }

        // --- MONTHLY INCOME CALCULATOR LOGIC ---
        
        const mInput = document.getElementById('monthlySumInput');
        if(mInput) {
    mInput.addEventListener('focus', () => {
        // Скрываем навигацию
        const nav = document.getElementById('navWrapper');
        if(nav) nav.style.display = 'none';
        
        // Скрываем заголовок экрана, чтобы больше места было
        const header = document.querySelector('.header');
        if(header) header.style.display = 'none';
    });

    mInput.addEventListener('blur', () => {
        // Возвращаем всё назад с небольшой задержкой
        setTimeout(() => {
            const nav = document.getElementById('navWrapper');
            if(nav) nav.style.display = 'flex';
            
            const header = document.querySelector('.header');
            if(header) header.style.display = 'block';
        }, 100);
    });
            // Автозапуск расчета при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    const mInput = document.getElementById('monthlySumInput');
    if (mInput && mInput.value) {
        // Имитируем ввод, чтобы запустить пересчет
        mInput.dispatchEvent(new Event('input'));
    }
});
}

        function adaptCalcInputFont(el) {
            const len = String(el.value || '').length;
            if (len > 8) el.style.fontSize = '7px';
            else if (len > 6) el.style.fontSize = '9px';
            else if (len > 4) el.style.fontSize = '11px';
            else el.style.fontSize = '14px';
        }

        function changeQty(ticker, delta) {
            const input = document.getElementById(`input-${ticker}`);
            if(input) {
                let val = parseInt(input.value) || 0;
                val = Math.max(0, val + delta);
                input.value = val;
                adaptCalcInputFont(input);
                updateMonthlySumFromQuantities();
            }
        }
        
        function resetOne(ticker) {
             const input = document.getElementById(`input-${ticker}`);
             if(input) {
                 input.value = 0;
                 updateMonthlySumFromQuantities();
             }
        }
        
        function updateMonthlySumFromQuantities() {
            if (isUpdatingProgrammatically) return;
            let totalSum = 0;
            monthlyIncomeBonds.forEach(bond => {
                const input = document.getElementById(`input-${bond.t}`);
                if (input) {
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0) {
                        const fullCost = (bond.p + bond.nkd); 
                        totalSum += qty * fullCost;
                    }
                }
            });

            isUpdatingProgrammatically = true;
            document.getElementById('monthlySumInput').value = Math.round(totalSum);
            isUpdatingProgrammatically = false;

            recalcCustomCoupons(); // <--- ВАЖНОЕ ДОБАВЛЕНИЕ: Обновляем нижний список
        }

        function distributeMonthlyInvestment() {
    const input = document.getElementById('monthlySumInput');
    if (!input) return;

    // Очищаем от пробелов и превращаем в число
    const totalInvestment = parseFloat(input.value.replace(/\s/g, ''));
    
    console.log(`[CALC] === НАЧАЛО РАСЧЕТА ===`); // ЛОГ
    console.log(`[CALC] Введенная сумма: ${totalInvestment}`); // ЛОГ

    if (!totalInvestment || totalInvestment <= 0) {
        renderMonthlyIncomeCards();
        recalcCustomCoupons();
        return;
    }

    // 6 бумаг в стратегии
    const perBondBudget = totalInvestment / 6;
    console.log(`[CALC] Бюджет на одну бумагу: ${perBondBudget.toFixed(2)}`); // ЛОГ

    monthlyIncomeBonds.forEach(bond => {
        // Полная стоимость покупки = Цена + НКД
        const fullPrice = bond.p + bond.nkd;
        
        let count = 0;
        if (fullPrice > 0) {
            count = Math.floor(perBondBudget / fullPrice);
        }

        // Сохраняем кол-во в карту
        bondQtyMap[bond.t] = count;

        // === ВАЖНЫЙ ЛОГ ПО КАЖДОЙ БУМАГЕ ===
        console.log(`[CALC] Бумага: ${bond.n}`);
        console.log(`       Цена (тело): ${bond.p}`);
        console.log(`       НКД: ${bond.nkd}`);
        console.log(`       Полная цена: ${fullPrice.toFixed(2)}`);
        console.log(`       Расчет: ${perBondBudget.toFixed(2)} / ${fullPrice.toFixed(2)} = ${count} шт.`);
        console.log('---');
    });

    renderMonthlyIncomeCards();
    recalcCustomCoupons();
    console.log(`[CALC] === КОНЕЦ РАСЧЕТА ===`);
}
        // ===== ФУНКЦИЯ 1: Отрисовка карточек =====
function renderMonthlyIncomeCards() {
    const container = document.getElementById('calc-bonds-input-list');
    if(!container) return;
    
    let html = '';
    
    monthlyIncomeBonds.forEach(b => {
        const qty = bondQtyMap[b.t] || 0;
        html += `
        <div class="calc-bond-row">
            <div class="calc-bond-name">${styledName(b.n)}</div>
            <div class="calc-bond-yield">${b.y.replace('%', '')}%</div>
            
            <div class="qty-controls">
                <div class="qty-btn" onclick="changeQty('${b.t}', -1)">−</div>
                <input type="number" id="input-${b.t}" class="calc-input" data-ticker="${b.t}" value="${qty}" min="0" oninput="updateMonthlySumFromQuantities(); adaptCalcInputFont(this)">
                <div class="qty-btn" onclick="changeQty('${b.t}', 1)">+</div>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
    
    // Адаптируем font-size для всех инпутов после рендера
    container.querySelectorAll('.calc-input').forEach(adaptCalcInputFont);
    hideSkeleton('skeleton-income-cards');
}

// ===== ФУНКЦИЯ 2: Загрузка цен с биржи =====
async function fetchPricesForMonthlyIncome() {
    const promises = monthlyIncomeBonds.map(async (bond) => {
        try {
            const extra = await fetchBondData(bond.t);
            // Если данные пришли, записываем их
            bond.p = extra.price;
            bond.nkd = extra.nkd;
        } catch(e) {
            console.error("Не удалось получить данные по", bond.t, e);
            // === ЗАГЛУШКИ УБРАНЫ ===
            // Раньше тут было: bond.p = 1000;
            // Теперь мы просто оставляем старое значение или undefined.
            // Если цена будет undefined, математика выдаст NaN,
            // и пользователь увидит, что данные не загрузились, вместо ложных 1000р.
        }
    });

    await Promise.all(promises);
    
    renderMonthlyIncomeCards();
    distributeMonthlyInvestment(); // Пересчет (как мы добавили ранее)
}
// ===== ФУНКЦИЯ 3: Пересчёт выплат (ИСПРАВЛЕННАЯ) =====
function recalcCustomCoupons() {
    const resultList = document.getElementById('calc-results-list');
    const footer = document.getElementById('calc-results-footer');
    if (!resultList) return;
    
    let html = '';
    bondQtyMap = {};
    let totalAmount = 0;
    
    // Собираем количества из полей ввода
    monthlyIncomeBonds.forEach(bond => {
        const input = document.getElementById(`input-${bond.t}`);
        bondQtyMap[bond.t] = input ? (parseInt(input.value) || 0) : 0;
    });

    // Выводим все 12 строк выплат
   allScheduledPayments.forEach(payment => {
    // --- НАЧАЛО БЛОКА ПОИСКА КОЛИЧЕСТВА ---
    
    // 1. Сначала пробуем найти количество по Тикеру (коду)
    let qty = bondQtyMap[payment.paymentTicker];

    // 2. Если по тикеру пусто (или 0), ищем "Родителя" среди 6 облигаций по Имени
    if (!qty) {
        // Ищем в списке monthlyIncomeBonds ту облигацию, чье имя совпадает с именем выплаты
        const parentBond = monthlyIncomeBonds.find(b => b.n === payment.displayName);
        if (parentBond) {
            // Если нашли родителя, берем его количество из карты
            qty = bondQtyMap[parentBond.t];
        }
    }

    // Если всё равно ничего не нашли, ставим 0
    qty = qty || 0;
    
    // --- КОНЕЦ БЛОКА ПОИСКА ---

    const netAmount = (payment.staticCouponVal * qty) * (1 - customTax);
    console.log(`[CALC ROW] ${payment.displayName} (${payment.paymentTicker}): coupon=${payment.staticCouponVal} × qty=${qty} × (1-${customTax}) = ${netAmount.toFixed(2)}`);
    totalAmount += netAmount;
      // Адаптивный размер шрифта для кол-ва и суммы
      const qtyStr = `${qty} шт`;
      const qtyFontSize = qtyStr.length > 11 ? 5 : qtyStr.length > 9 ? 6 : qtyStr.length > 7 ? 7 : qtyStr.length > 6 ? 8 : qtyStr.length > 4 ? 9 : 11;
      const sumStr = `+${Math.round(netAmount).toLocaleString('ru-RU')} ₽`;
      const sumFontSize = sumStr.length > 12 ? 8 : sumStr.length > 10 ? 9 : sumStr.length > 8 ? 10 : sumStr.length > 6 ? 11 : 13;
      
      html += `
    <div class="coupon-row" style="display:grid; grid-template-columns: 48px 1fr 56px 80px; gap:0; align-items:center; padding:10px 0;">
        
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:rgba(255,255,255,0.4);font-weight:500;">${payment.dateStr.slice(0, 5)}</div>

        <div style="color:#fff; font-weight:500; font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:4px; min-width:0;">
            ${styledName(payment.displayName)}
        </div>

        <div style="background:rgba(255,255,255,0.08);border-radius:6px;padding:3px 4px;font-family:'JetBrains Mono',monospace;font-size:${qtyFontSize}px;font-weight:600;color:#fff;text-align:center;white-space:nowrap;overflow:hidden;">${qtyStr}</div>

        <div style="text-align:right;font-family:'JetBrains Mono',monospace;font-size:${sumFontSize}px;font-weight:700;color:#10B981;white-space:nowrap;overflow:hidden;">
            ${sumStr}
        </div>
    </div>`;
    });

    resultList.innerHTML = html || '<div style="text-align:center; padding:15px; color:#aaa;">Введите количество для расчета...</div>';
    
    if (footer) {
        const monthlyAvg = totalAmount > 0 ? Math.round(totalAmount / 12) : 0;
        const investInput = document.getElementById('monthlySumInput');
        const investSum = investInput ? (parseFloat(investInput.value.replace(/\s/g, '')) || 0) : 0;
        const yearlyPercent = investSum > 0 ? ((totalAmount / investSum) * 100).toFixed(1) : '0.0';
        
        if (monthlyAvg > 0) {
            footer.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:10px; width:100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:12px; color:rgba(255,255,255,0.5); font-weight:500;">Средняя сумма в месяц</span>
                        <span style="color:var(--accent-green); font-family:'JetBrains Mono',monospace; font-weight:700; font-size:14px;">~${monthlyAvg.toLocaleString()} ₽</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:12px; color:rgba(255,255,255,0.5); font-weight:500;">Итого в год</span>
                        <span style="color:#3B82F6; font-family:'JetBrains Mono',monospace; font-weight:700; font-size:14px;">${Math.round(totalAmount).toLocaleString()} ₽</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-top:8px; border-top:1px solid rgba(255,255,255,0.06);">
                        <span style="font-size:12px; color:rgba(255,255,255,0.5); font-weight:500;">Доходность от суммы</span>
                        <span style="font-family:'JetBrains Mono',monospace; font-weight:700; font-size:14px; color:${parseFloat(yearlyPercent) >= 10 ? '#10B981' : parseFloat(yearlyPercent) >= 5 ? '#3B82F6' : 'rgba(255,255,255,0.7)'};">${yearlyPercent}%</span>
                    </div>
                </div>`;
        } else {
            footer.innerHTML = '';
        }
    }
}

        function resetCustomCalc() {
            isUpdatingProgrammatically = true;
            document.getElementById('monthlySumInput').value = 0;
            isUpdatingProgrammatically = false;
            const inputs = document.querySelectorAll('.calc-input');
            inputs.forEach(input => input.value = 0);
            
            recalcCustomCoupons(); // <--- ДОБАВЛЕНО
            
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

      

        // --- END OF MONTHLY CALC LOGIC ---

        function updateEchelonTable() {
    const body = document.getElementById('echelon-tickers-body');
    if(!body) return;
    let html = '';
    const maxRows = Math.max(...echelonTableData.map(col => col.length));
    
    for(let i=0; i<maxRows; i++) {
        // Основная строка с ячейками
        html += '<tr>';
        for(let j=0; j<4; j++) {
            const asset = echelonTableData[j][i];
            if(asset) {
                // Убираем знак рубля из отображения в ячейке
                const priceDisplay = asset.target.replace(' ₽', '');
                html += `
                <td class="et-cell" onclick="toggleEchelonCell('${i}-${j}')">
                    <div class="et-cell-content">
                        <span class="et-ticker">${asset.t}</span>
                        <span class="et-price">${priceDisplay}</span>
                    </div>
                </td>`;
            } else {
                html += '<td class="et-cell-empty"></td>';
            }
        }
        html += '</tr>';
        
        // Скрытая строка с деталями
        html += `<tr class="et-details-row" id="details-row-${i}" style="display:none;">
            <td colspan="4" class="et-details-container">
                <div id="details-content-${i}"></div>
            </td>
        </tr>`;
    }
    body.innerHTML = html;
}


    function toggleEchelonCell(cellId) {
    const [row, col] = cellId.split('-').map(Number);
    const detailsRow = document.getElementById(`details-row-${row}`);
    const detailsContent = document.getElementById(`details-content-${row}`);
    
    // Закрываем все остальные открытые строки
    document.querySelectorAll('.et-details-row').forEach(r => {
        if(r.id !== `details-row-${row}`) {
            r.style.display = 'none';
        }
    });
    
    // Переключаем текущую строку
    if(detailsRow.style.display === 'none') {
        // НОВОЕ: Раскрываем таблицу автоматически
        const wrapper = document.getElementById('echelon-wrapper');
        const expandBtn = document.getElementById('expandArrowBtn');
        if(wrapper && wrapper.classList.contains('collapsed')) {
            wrapper.classList.remove('collapsed');
            if(expandBtn) expandBtn.classList.add('open');
        }
        
        // Получаем данные актива
        const asset = echelonTableData[col][row];
        if(!asset) return;
        
        // Берём название компании из самого asset (уже загружено из колонки G)
const companyName = asset.n || asset.t;
        
        // Определяем эшелон
        const echelonNum = col + 1;
        const echelonName = ['I Эшелон', 'II Эшелон', 'III Эшелон', 'IV Эшелон'][col];
        
        // Формируем контент для деталей
        detailsContent.innerHTML = `
            <div class="et-expanded-details">
                <div class="et-details-header">
                    <div class="et-details-title">
                        <span class="et-details-ticker">${asset.t}</span>
                        <span class="et-details-echelon">${echelonName}</span>
                    </div>
                </div>
               <div style="margin-bottom: 16px;">
    <div style="background: linear-gradient(135deg, var(--bg-color), var(--card-bg)); padding: 16px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 12px; box-shadow: 0 2px 8px var(--card-shadow);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Компания</div>
            <div style="background: var(--accent-blue); color: white; font-size: 9px; font-weight: 700; padding: 4px 10px; border-radius: 8px; text-transform: uppercase; letter-spacing: 0.5px;">${echelonName}</div>
        </div>
        <div style="font-size: 16px; font-weight: 800; color: var(--text-main); line-height: 1.4; margin-bottom: 8px;">${companyName}</div>
        ${asset.sector ? `<div style="display: inline-flex; align-items: center; gap: 6px; background: rgba(52, 152, 219, 0.1); color: var(--accent-blue); font-size: 11px; font-weight: 600; padding: 6px 12px; border-radius: 8px; margin-top: 4px;">
            <svg style="width: 14px; height: 14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            ${asset.sector}
        </div>` : ''}
    </div>
    
    <div class="et-details-grid">
        <div class="et-detail-item">
            <span class="et-detail-label">Тикер:</span>
            <span class="et-detail-value" style="cursor:pointer; color:var(--accent-blue);" onclick="copyTicker(event, '${asset.t}')">${asset.t} 📋</span>
        </div>
        <div class="et-detail-item">
            <span class="et-detail-label">Цель:</span>
            <span class="et-detail-value">${asset.target}</span>
        </div>
        <div class="et-detail-item">
            <span class="et-detail-label">Прогноз:</span>
            <span class="et-detail-value">до 36 мес.</span>
        </div>
    </div>
</div>
                <div class="et-details-actions">
                    <button class="et-btn-chart" onclick="openTradingView(event, '${asset.t}')">
                        <svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                        График
                    </button>
                    <button class="et-btn-company" onclick="openCompanyFromTable(event, '${asset.t}', '${companyName}')">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        О компании
                    </button>
                </div>
            </div>
        `;
        detailsRow.style.display = 'table-row';
        
       // НОВОЕ: Плавная прокрутка с отступом от нижнего меню
setTimeout(() => {
    const rect = detailsRow.getBoundingClientRect();
    const offset = 150; // Высота меню + отступ
    const elementTop = rect.top + window.pageYOffset;
    const offsetPosition = elementTop - offset;
    
    window.scrollTo({
        top: offsetPosition,
        behavior: 'smooth'
    });
}, 100);
        
    } else {
        detailsRow.style.display = 'none';
    }
}

function openCompanyFromTable(event, ticker, companyName) {
    event.stopPropagation();
    // Ищем полную информацию об активе
    let foundAsset = null;
    
    // Сначала ищем в основных эшелонах
    for(let e of echelons) {
        const found = e.assets.find(a => a.t === ticker);
        if(found) {
            foundAsset = found;
            break;
        }
    }
    
    // Если не нашли, создаем минимальный объект
    if(!foundAsset) {
        for(let i = 0; i < echelonTableData.length; i++) {
            const found = echelonTableData[i].find(a => a.t === ticker);
            if(found) {
                foundAsset = {
                    t: found.t,
                    n: companyName || found.t,
                    p: 0,
                    target: found.target
                };
                break;
            }
        }
    }
    
    if(foundAsset) {
        const item = {
            ...foundAsset,
            type: 'Акция'
        };
        openCompanyPage(item);
    }
}
    
// Функция для уведомления
function showToast(message) {
    let toast = document.getElementById('copy-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'copy-toast';
        toast.className = 'copy-notification';
        document.body.appendChild(toast);
    }
    toast.innerText = message;
    toast.classList.add('show');
    
    setTimeout(() => toast.classList.remove('show'), 2000);
}

// Обновленная отрисовка
// Вспомогательная функция для оборачивания цифр в шрифт Mono
function formatNameWithMonoDigits(name) {
    if (!name) return '';
    // Ищем все группы цифр и оборачиваем их в span
    return name.replace(/(\d+)/g, '<span class="mono-digit-span">$1</span>');
}

// Функция для раскрытия/скрытия ВСЕГО списка через заголовок
// 1. Управление всем блоком ОФЗ
function toggleGlobalOfzList() {
    const headerContainer = document.querySelector('.ofz-headers-container');
    const isExpanding = !headerContainer.classList.contains('is-expanded');
    
    // Переключаем класс для стрелочки
    headerContainer.classList.toggle('is-expanded');
    
    // Если мы СВОРАЧИВАЕМ (isExpanding = false), закрываем все открытые детали
    if (!isExpanding) {
        document.querySelectorAll('.ofz-lux-details').forEach(detail => {
            detail.style.display = 'none';
        });
        // Убираем активные классы со строк
        document.querySelectorAll('.ofz-row-container').forEach(row => {
            row.classList.remove('active');
        });
    }

    // Вызываем твою функцию скрытия лишних строк (из терминала)
    if (typeof toggleOfzGhost === 'function') {
        toggleOfzGhost(); 
    }
}

// 2. Рендер списка
function renderOfzList() {
    if (typeof bonds === 'undefined' || bonds.length === 0) return;
    
    // Принудительный фикс стиля превью (убиваем "белый фон")
    const pBox = document.querySelector('.rebalance-preview-box') || document.querySelector('.rebalance-intro-modern');
    if (pBox) {
        pBox.style.cssText = "background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important; color: white !important;";
        pBox.querySelectorAll('*').forEach(child => child.style.color = 'white');
    }

   let ofzHtml = `
        <div class="ofz-headers-container">
            <div class="h-label-instrument-wrapper" onclick="toggleGlobalOfzList()" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
                <span style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase;">Инструмент</span>
                <svg id="global-ofz-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="3" style="transition:0.3s;"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <div class="headers-right-group">
                <div class="header-glass-pill">%</div>
                <div class="header-glass-pill">₽</div>
            </div>
        </div>
        <div id="ofz-items-container">
            </div>
    `;
    
    bonds.forEach((b, index) => {
        const details = bondDetailsMap[b.t] || { matDate: '—', couponValue: 0, nextCoupon: '—', freq: 0 };
        const priceFinal = parseFloat(String(b.p).replace(',', '.')).toFixed(2);
        
        let curYield = "0.00";
        if (details.couponValue > 0 && details.freq > 0) {
            curYield = ((details.couponValue * details.freq / parseFloat(priceFinal)) * 100).toFixed(2);
        }

        const hiddenClass = index > 2 ? 'ofz-row-hidden' : '';

        ofzHtml += `
        <div class="ofz-row-container ${hiddenClass}" id="container-${b.t}">
            <div class="ofz-luxury-item" onclick="toggleOfzDetails('${b.t}')">
                <div class="ofz-lux-name">${formatNameWithMonoDigits(limitName(b.n))}</div>
                <div class="ofz-lux-bridge"></div>
                <div class="ofz-lux-right">
                    <div class="ofz-lux-yield">${b.y}</div>
                    <div class="ofz-price-pill">${priceFinal} ₽</div>
                </div>
            </div>

            <div id="details-${b.t}" class="ofz-lux-details" style="display:none; padding: 20px;">
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">КОД (ISIN)</span>
                    <span class="copy-code-blue" onclick="copyTickerNew('${b.t}')">${b.t}</span>
                </div>
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">ТЕКУЩАЯ ЦЕНА</span>
                    <span class="ofz-lux-detail-value"><span class="mono-digit-span">${priceFinal}</span> ₽</span>
                </div>
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">НКД</span>
                    <span class="ofz-lux-detail-value"><span class="mono-digit-span">${b.nkd}</span> ₽</span>
                </div>
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">ДАТА ПОГАШЕНИЯ</span>
                    <span class="ofz-lux-detail-value mono-digit-span">${details.matDate}</span>
                </div>
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">РАЗМЕР КУПОНА</span>
                    <span class="ofz-lux-detail-value"><span class="mono-digit-span">${details.couponValue}</span> ₽</span>
                </div>
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">БЛИЖ. КУПОН</span>
                    <span class="ofz-lux-detail-value mono-digit-span">${details.nextCoupon}</span>
                </div>
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">ТЕКУЩАЯ КУПОННАЯ ДОХОДНОСТЬ</span>
                    <span class="ofz-lux-detail-value" style="color:#3498db; font-weight:800;">
                        <span class="mono-digit-span">${curYield}</span>%
                    </span>
                </div>
                <div class="ofz-lux-detail-row">
                    <span class="ofz-lux-detail-label">ВЫПЛАТ В ГОД</span>
                    <span class="ofz-lux-detail-value mono-digit-span">${details.freq}</span>
                </div>
                <button class="btn-luxury-chart" onclick="openTradingView(event, '${b.t}')">Открыть график TV</button>
            </div>
        </div>`;
    });
    
    document.getElementById('ofz-list').innerHTML = ofzHtml;
    
    // Также рендерим новый Aurora список
    renderAuroraOfzList();
}

// ========================================================================
// AURORA REBALANCE - НОВЫЕ ФУНКЦИИ ДЛЯ ВКЛАДОК
// ========================================================================

// Переключение вкладок ОФЗ / АКЦИИ (Liquid Tab Switcher)
function switchRebalanceTab(tabName) {
    const tabSwitcher = document.getElementById('tabSwitcher');
    const tabs = document.querySelectorAll('.tab-btn');
    
    // Убираем активный класс со всех кнопок
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Скрываем весь контент
    document.querySelectorAll('.rebalance-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Управляем глайдером
    if (tabName === 'stocks') {
        tabSwitcher.classList.add('show-stocks');
        tabs[1].classList.add('active');
    } else {
        tabSwitcher.classList.remove('show-stocks');
        tabs[0].classList.add('active');
    }
    
    // Показываем нужный контент
    document.getElementById(`rebalance-tab-${tabName}`).classList.add('active');
    
    // Скролл на верх страницы
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
    
    // Если переключились на акции — рендерим таблицу заново
    if (tabName === 'stocks') {
        // Закрываем открытую карточку
        closeStockDetail();
        // Перерендериваем таблицу
        renderAuroraStocksTable();
    }
    updateInfoBtnState(tabName);
}

// Инициализация Spotlight эффекта для карточки "Умная замена"
function initSmartReplaceSpotlight() {
    const card = document.getElementById('smartReplaceCard');
    if (!card) return;
    
    card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        card.style.setProperty('--mouse-x', x + '%');
        card.style.setProperty('--mouse-y', y + '%');
    });
}

// Вызываем инициализацию при загрузке
document.addEventListener('DOMContentLoaded', initSmartReplaceSpotlight);

// Рендер списка ОФЗ в Aurora стиле
function renderAuroraOfzList() {
    const container = document.getElementById('ofz-aurora-list');
    if (!container || typeof bonds === 'undefined' || bonds.length === 0) return;
    
    // Функция форматирования даты в день-месяц-год
    function formatDateDMY(dateStr) {
        if (!dateStr || dateStr === '—') return '—';
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        } catch (e) {
            return dateStr;
        }
    }
    
    let html = '';
    
    bonds.forEach((b, index) => {
        const details = bondDetailsMap[b.t] || { matDate: '—', couponValue: 0, nextCoupon: '—', freq: 0 };
        const priceFinal = parseFloat(String(b.p).replace(',', '.')).toFixed(2);
        const nkd = parseFloat(b.nkd || 0).toFixed(2);
        const priceWithNkd = (parseFloat(priceFinal) + parseFloat(nkd)).toFixed(2);
        
        // Доходность из Google Sheets для строки
        const sheetYield = b.y ? b.y.replace('%', '') : '—';
        
        // Рассчитанная текущая купонная доходность для подстроки
        let curYield = "0.00";
        if (details.couponValue > 0 && details.freq > 0) {
            curYield = ((details.couponValue * details.freq / parseFloat(priceFinal)) * 100).toFixed(2);
        }
        
        const hiddenClass = index > 2 ? 'aurora-hidden' : '';
        
        html += `
        <div class="ofz-aurora-item ${hiddenClass}" id="aurora-${b.t}" data-index="${index}">
            <div class="ofz-aurora-summary" onclick="toggleAuroraOfzDetails('${b.t}')">
                <span class="ofz-aurora-name">${formatNameWithMonoDigits(limitName(b.n))}</span>
                <span class="ofz-aurora-yield">${sheetYield}%</span>
                <span class="ofz-aurora-price">${priceWithNkd}</span>
            </div>
            
            <div class="ofz-aurora-details" id="aurora-details-${b.t}">
                <div class="ofz-aurora-details-list">
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Код (ISIN)</span>
                        <div class="ofz-copy-wrapper" onclick="copyTickerNew('${b.t}')">
                            <span class="ofz-copy-code">${b.t}</span>
                            <svg class="ofz-copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Текущая цена</span>
                        <span class="ofz-detail-value">${priceFinal} ₽</span>
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">НКД<span class="ofz-help-icon" onclick="toggleOfzHelp('nkdHelp-${b.t}', event)">?</span></span>
                        <span class="ofz-detail-value">${nkd} ₽</span>
                    </div>
                    <div class="ofz-inline-help" id="nkdHelp-${b.t}">
                        <b>НКД</b> — накопленный купонный доход. Это часть купона, которую вы платите продавцу облигации за дни с последней выплаты до даты покупки. При получении следующего купона вы получите его целиком.
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Итого (цена + НКД)</span>
                        <span class="ofz-detail-value" style="font-weight: 700;">${priceWithNkd} ₽</span>
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Погашение</span>
                        <span class="ofz-detail-value">${formatDateDMY(details.matDate)}</span>
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Размер купона</span>
                        <span class="ofz-detail-value">${details.couponValue} ₽</span>
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Ближайший купон</span>
                        <span class="ofz-detail-value">${formatDateDMY(details.nextCoupon)}</span>
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Текущая купонная доходность<span class="ofz-help-icon" onclick="toggleOfzHelp('yieldHelp-${b.t}', event)">?</span></span>
                        <span class="ofz-detail-value" style="color: #10B981;">${curYield}%</span>
                    </div>
                    <div class="ofz-inline-help" id="yieldHelp-${b.t}">
                        <b>Текущая купонная доходность</b> — показывает, какой процент годовых вы получаете от купонов относительно текущей цены облигации. Не учитывает выплату номинала при погашении.
                    </div>
                    <div class="ofz-detail-row">
                        <span class="ofz-detail-label">Выплат в год</span>
                        <span class="ofz-detail-value">${details.freq}</span>
                    </div>
                </div>
                <button class="ofz-aurora-chart-btn" onclick="openTradingViewDirect('${b.t}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    Открыть график
                </button>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
    hideSkeleton('skeleton-ofz-list');
}

// Раскрытие/скрытие деталей ОФЗ в Aurora стиле с прокруткой
function toggleAuroraOfzDetails(ticker) {
    const item = document.getElementById(`aurora-${ticker}`);
    if (!item) return;
    
    const isExpanded = item.classList.contains('expanded');
    
    // Закрываем все открытые
    document.querySelectorAll('.ofz-aurora-item.expanded').forEach(el => {
        el.classList.remove('expanded');
    });
    
    // Если не был открыт — открываем и прокручиваем
    if (!isExpanded) {
        item.classList.add('expanded');
        // Прокрутка чтобы карточка была видна между кнопкой телеграм (сверху) и навигацией (снизу)
        setTimeout(() => {
            const navHeight = 80; // высота навигационного меню + отступ
            const topOffset = 60; // отступ от верха (кнопка закрыть телеграм)
            const itemRect = item.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const bottomOfCard = itemRect.top + item.offsetHeight;
            const topOfCard = itemRect.top;
            
            // Если верх карточки выше зоны видимости — прокручиваем вниз
            if (topOfCard < topOffset) {
                const scrollBy = topOfCard - topOffset;
                window.scrollBy({ top: scrollBy, behavior: 'smooth' });
            }
            // Если низ карточки ниже навигации — прокручиваем вверх
            else if (bottomOfCard > viewportHeight - navHeight) {
                const scrollBy = bottomOfCard - (viewportHeight - navHeight) + 20;
                window.scrollBy({ top: scrollBy, behavior: 'smooth' });
            }
        }, 150);
    }
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Показать/скрыть все ОФЗ в Aurora стиле
let ofzListExpanded = false;

function toggleAuroraOfzList() {
    const items = document.querySelectorAll('.ofz-aurora-item');
    const trigger = document.getElementById('ofzGhostTrigger');
    const text = document.getElementById('ofzGhostText');
    
    ofzListExpanded = !ofzListExpanded;
    
    if (!ofzListExpanded) {
        // Сворачиваем — показываем только первые 3
        items.forEach((item, index) => {
            if (index > 2) {
                item.classList.add('aurora-hidden');
            }
            // Также закрываем все подстроки
            item.classList.remove('expanded');
        });
        text.innerText = 'ОТКРЫТЬ СПИСОК';
        trigger.classList.remove('open');
        
        // Прокрутка к верху страницы
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        // Разворачиваем — показываем все с анимацией
        items.forEach((item, index) => {
            item.classList.remove('aurora-hidden');
            // Перезапускаем анимацию stagger
            item.style.animation = 'none';
            item.offsetHeight; // Триггер reflow
            item.style.animation = `staggerIn 0.4s ease forwards`;
            item.style.animationDelay = `${index * 0.05}s`;
        });
        text.innerText = 'СКРЫТЬ';
        trigger.classList.add('open');
    }
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Сворачивание/разворачивание списка ОФЗ через галочку
let ofzListCollapsed = false;

function toggleOfzListCollapse() {
    const list = document.getElementById('ofz-aurora-list');
    const toggle = document.getElementById('ofzCollapseToggle');
    const ghostTrigger = document.getElementById('ofzGhostTrigger');
    const items = document.querySelectorAll('.ofz-aurora-item');
    
    // Проверяем текущее состояние - если показаны только 3 строки и ghostTrigger видим, то открываем весь список
    const hiddenItems = document.querySelectorAll('.ofz-aurora-item.aurora-hidden');
    const isPartiallyShown = hiddenItems.length > 0 && ghostTrigger && ghostTrigger.style.display !== 'none';
    
    if (isPartiallyShown && !ofzListCollapsed) {
        // Открываем весь список
        items.forEach((item, index) => {
            item.classList.remove('aurora-hidden');
            item.style.animation = 'none';
            item.offsetHeight;
            item.style.animation = `staggerIn 0.4s ease forwards`;
            item.style.animationDelay = `${index * 0.05}s`;
        });
        ghostTrigger.style.display = 'flex';
        ghostTrigger.classList.add('open');
        document.getElementById('ofzGhostText').innerText = 'СВЕРНУТЬ СПИСОК';
        ofzListExpanded = true;
        
        // Вибрация
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        return;
    }
    
    ofzListCollapsed = !ofzListCollapsed;
    
    if (ofzListCollapsed) {
        // Сворачиваем - показываем 3 первые строки + элемент "открыть список" внизу
        list.style.display = 'flex';
        items.forEach((item, index) => {
            if (index > 2) {
                item.classList.add('aurora-hidden');
            } else {
                item.classList.remove('aurora-hidden');
            }
        });
        toggle.classList.add('collapsed');
        // Показываем элемент "открыть список" внизу
        ghostTrigger.style.display = 'flex';
        ghostTrigger.classList.remove('open');
        document.getElementById('ofzGhostText').innerText = 'ОТКРЫТЬ СПИСОК';
        // Сбрасываем состояние
        ofzListExpanded = false;
        // Закрываем все подстроки
        document.querySelectorAll('.ofz-aurora-item.expanded').forEach(el => {
            el.classList.remove('expanded');
        });
    } else {
        // Разворачиваем - возвращаем к состоянию "3 строки + открыть список"
        list.style.display = 'flex';
        items.forEach((item, index) => {
            if (index > 2) {
                item.classList.add('aurora-hidden');
            } else {
                item.classList.remove('aurora-hidden');
                // Перезапускаем анимацию
                item.style.animation = 'none';
                item.offsetHeight;
                item.style.animation = `staggerIn 0.4s ease forwards`;
                item.style.animationDelay = `${index * 0.05}s`;
            }
        });
        toggle.classList.remove('collapsed');
        // Показываем элемент "открыть список" внизу
        ghostTrigger.style.display = 'flex';
        ghostTrigger.classList.remove('open');
        document.getElementById('ofzGhostText').innerText = 'ОТКРЫТЬ СПИСОК';
        ofzListExpanded = false;
    }
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Переключение описания эшелонов
function toggleEchelonsInfo() {
    const info = document.getElementById('stocksEchelonInfo');
    const header = document.getElementById('echelonsHeader');
    
    if (!info || !header) return;
    
    const isOpen = info.classList.contains('open');
    
    if (isOpen) {
        info.classList.remove('open');
        header.classList.remove('open');
    } else {
        info.classList.add('open');
        header.classList.add('open');
    }
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Подсветка столбца эшелона при клике на кружок
let activeEchelonColumn = null;

function toggleEchelonColumnHighlight(echelonNum, event) {
    event.stopPropagation();
    
    const rows = document.querySelectorAll('.stocks-table-row');
    const circle = document.getElementById(`echelonCircle${echelonNum}`);
    
    // Снимаем подсветку со всех столбцов
    for (let i = 1; i <= 4; i++) {
        const c = document.getElementById(`echelonCircle${i}`);
        if (c) c.classList.remove('active');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('.stocks-cell');
            if (cells[i - 1]) {
                cells[i - 1].classList.remove(`column-highlight-${i}`);
            }
        });
    }
    
    // Если кликнули на тот же столбец — просто выключаем
    if (activeEchelonColumn === echelonNum) {
        activeEchelonColumn = null;
        
        // Вибрация
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.selectionChanged();
        }
        return;
    }
    
    // Включаем подсветку нового столбца
    activeEchelonColumn = echelonNum;
    
    if (circle) circle.classList.add('active');
    
    // Подсвечиваем только ячейки с тикерами
    rows.forEach(row => {
        const cells = row.querySelectorAll('.stocks-cell');
        const cell = cells[echelonNum - 1];
        if (cell) {
            // Проверяем есть ли тикер в ячейке
            const ticker = cell.querySelector('.stocks-cell-ticker');
            if (ticker && ticker.textContent.trim()) {
                cell.classList.add(`column-highlight-${echelonNum}`);
            }
        }
    });
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Рендер таблицы эшелонов акций в Aurora стиле
function renderAuroraStocksTable() {
    const container = document.getElementById('stocks-aurora-body');
    if (!container) return;
    
    // Сбрасываем подсветку столбцов
    activeEchelonColumn = null;
    for (let i = 1; i <= 4; i++) {
        const c = document.getElementById(`echelonCircle${i}`);
        if (c) c.classList.remove('active');
    }
    
    // Проверяем есть ли данные в echelonTableData
    if (typeof echelonTableData === 'undefined' || 
        !echelonTableData || 
        echelonTableData.every(col => col.length === 0)) {
        // Если данных нет, ждем загрузки
        setTimeout(renderAuroraStocksTable, 500);
        return;
    }
    
    let html = '';
    const maxRows = Math.max(...echelonTableData.map(col => col.length));
    const maxVisibleRows = 3;
    
    for (let rowIndex = 0; rowIndex < maxRows; rowIndex++) {
        const hiddenClass = rowIndex >= maxVisibleRows ? 'stocks-row-hidden' : '';
        
        html += `<div class="stocks-table-row ${hiddenClass}" data-row="${rowIndex}">`;
        
        for (let colIndex = 0; colIndex < 4; colIndex++) {
            const asset = echelonTableData[colIndex][rowIndex];
            
            if (asset && asset.t) {
                const ticker = asset.t;
                const price = asset.target || '';
                const echelonNum = colIndex + 1;
                
                // Определяем изменение цены
                const changeClass = price.includes('+') ? 'positive' : (price.includes('-') ? 'negative' : 'neutral');
                
                html += `<div class="stocks-cell" onclick="openStockDetail('${ticker}', ${echelonNum}, this)">
                    <span class="stocks-cell-ticker">${ticker}</span>
                    <span class="stocks-cell-change ${changeClass}">${price}</span>
                </div>`;
            } else {
                html += `<div class="stocks-cell"></div>`;
            }
        }
        
        html += '</div>';
    }
    
    container.innerHTML = html;
    hideSkeleton('skeleton-stocks-table');
    
    // Проверяем что карточка деталей существует и в правильном месте
    let card = document.getElementById('stockDetailCard');
    if (!card) {
        // Создаем карточку если её нет
        card = document.createElement('div');
        card.className = 'stock-detail-card';
        card.id = 'stockDetailCard';
        const ghostTrigger = document.getElementById('stocksGhostTrigger');
        if (ghostTrigger) {
            ghostTrigger.before(card);
        } else {
            container.after(card);
        }
    }
    
    // Обновляем кнопку показать/скрыть
    updateStocksShowMoreButton();
}

// Открытие карточки деталей тикера
function openStockDetail(ticker, echelon, clickedCell = null) {
    const card = document.getElementById('stockDetailCard');
    if (!card || !ticker) return;
    
    // Снимаем активный класс с предыдущей ячейки
    document.querySelectorAll('.stocks-cell.active').forEach(c => c.classList.remove('active'));
    
    // Закрываем если уже открыта эта же карточка
    if (card.classList.contains('open') && card.dataset.ticker === ticker) {
        closeStockDetail();
        return;
    }
    
    // Добавляем активный класс на кликнутую ячейку
    if (clickedCell) {
        clickedCell.classList.add('active');
    }
    
    // Ищем данные о компании в echelonTableData
    let companyName = ticker;
    let companySector = '';
    
    // Для привилегированных акций (SNGSp -> SNGS) ищем сектор базового тикера
    const baseTicker = ticker.toLowerCase().endsWith('p') ? ticker.slice(0, -1) : ticker;
    
    if (typeof echelonTableData !== 'undefined') {
        // Сначала ищем точное совпадение
        for (let i = 0; i < echelonTableData.length; i++) {
            const found = echelonTableData[i].find(item => item.t === ticker);
            if (found) {
                companyName = found.n || ticker;
                companySector = found.sector || '';
                break;
            }
        }
        
        // Если сектор не найден и это привилегированная акция - ищем по базовому тикеру
        if (!companySector && ticker !== baseTicker) {
            for (let i = 0; i < echelonTableData.length; i++) {
                const found = echelonTableData[i].find(item => item.t === baseTicker || item.t === baseTicker.toUpperCase());
                if (found) {
                    companySector = found.sector || '';
                    if (!companyName || companyName === ticker) {
                        companyName = found.n || ticker;
                    }
                    break;
                }
            }
        }
    }
    
    const echelonColors = {
        1: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10B981', name: 'I Эшелон' },
        2: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3B82F6', name: 'II Эшелон' },
        3: { bg: 'rgba(245, 158, 11, 0.15)', color: '#F59E0B', name: 'III Эшелон' },
        4: { bg: 'rgba(239, 68, 68, 0.15)', color: '#EF4444', name: 'IV Эшелон' }
    };
    
    const echelonStyle = echelonColors[echelon] || echelonColors[1];
    
    // Сектор HTML
    const sectorHtml = companySector ? `
        <div class="stock-detail-sector">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
            </svg>
            ${companySector}
        </div>
    ` : '';
    
    card.innerHTML = `
        <div class="stock-detail-close" onclick="closeStockDetail()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        </div>
        <div class="stock-detail-header">
            <div class="stock-detail-main">
                <div class="stock-detail-ticker">${ticker}</div>
                <div class="stock-detail-name">${companyName}</div>
                ${sectorHtml}
            </div>
            <span class="stock-detail-echelon" style="background: ${echelonStyle.bg}; color: ${echelonStyle.color};">${echelonStyle.name}</span>
        </div>
        <div class="stock-detail-grid">
            <div class="stock-detail-row">
                <span class="stock-detail-label">Код (тикер)</span>
                <div class="ofz-copy-wrapper" onclick="copyTickerNew('${ticker}')">
                    <span class="ofz-copy-code">${ticker}</span>
                    <svg class="ofz-copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </div>
            </div>
            <div class="stock-detail-row">
                <span class="stock-detail-label">Эшелон риска</span>
                <span class="stock-detail-value">${echelonStyle.name}</span>
            </div>
        </div>
        <div class="stock-detail-actions">
            <button class="stock-btn stock-btn-chart" onclick="openTradingViewDirect('${ticker}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                График
            </button>
            <button class="stock-btn stock-btn-info" onclick="goToCompanyPageFromTicker('${ticker}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                О компании
            </button>
        </div>
    `;
    
    card.dataset.ticker = ticker;
    card.dataset.echelon = echelon;
    
    // Вставляем карточку сразу под строкой с тикером
    if (clickedCell) {
        const row = clickedCell.closest('.stocks-table-row');
        if (row && row.parentNode) {
            // Перемещаем карточку после строки (insertBefore с nextSibling)
            row.parentNode.insertBefore(card, row.nextSibling);
        }
    }
    
    card.classList.add('open');
    
    // Прокручиваем так чтобы карточка была видна между кнопкой телеграм и навигацией
    setTimeout(() => {
        const navHeight = 80;
        const topOffset = 60;
        const cardRect = card.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const bottomOfCard = cardRect.top + card.offsetHeight;
        const topOfCard = cardRect.top;
        
        // Если верх карточки выше зоны видимости — прокручиваем вниз
        if (topOfCard < topOffset) {
            const scrollBy = topOfCard - topOffset;
            window.scrollBy({ top: scrollBy, behavior: 'smooth' });
        }
        // Если низ карточки ниже навигации — прокручиваем вверх
        else if (bottomOfCard > viewportHeight - navHeight) {
            const scrollBy = bottomOfCard - (viewportHeight - navHeight) + 20;
            window.scrollBy({ top: scrollBy, behavior: 'smooth' });
        }
    }, 100);
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Закрыть карточку деталей
function closeStockDetail() {
    const card = document.getElementById('stockDetailCard');
    if (card) {
        card.classList.remove('open');
        card.dataset.ticker = '';
        
        // Возвращаем карточку на исходное место (после таблицы)
        const tableContainer = document.querySelector('.stocks-aurora-table');
        if (tableContainer && card.parentNode !== tableContainer.parentNode) {
            const ghostTrigger = document.getElementById('stocksGhostTrigger');
            if (ghostTrigger) {
                ghostTrigger.before(card);
            } else {
                tableContainer.after(card);
            }
        }
    }
    // Снимаем активный класс со всех ячеек
    document.querySelectorAll('.stocks-cell.active').forEach(c => c.classList.remove('active'));
}

// Переход на страницу компании (из карточки деталей акции)
function goToCompanyPage(ticker) {
    // Ищем данные о компании в echelonTableData
    let companyData = null;
    
    if (typeof echelonTableData !== 'undefined') {
        for (let i = 0; i < echelonTableData.length; i++) {
            const found = echelonTableData[i].find(item => item.t === ticker);
            if (found) {
                companyData = {
                    t: found.t,
                    n: found.n || ticker,
                    sector: found.sector || '',
                    target: found.target || '—',
                    type: 'Акция'
                };
                break;
            }
        }
    }
    
    if (companyData && typeof openCompanyPage === 'function') {
        openCompanyPage(companyData);
    } else {
        showToast('Информация о компании недоступна');
    }
}

// Переход на страницу компании как если бы в поиск ввели тикер
function goToCompanyPageFromTicker(ticker) {
    // Вызываем функцию поиска с тикером
    if (typeof searchCompanyInternal === 'function') {
        searchCompanyInternal(ticker);
    } else if (typeof openCompanyPage === 'function') {
        // Fallback - ищем данные и открываем страницу
        let companyData = null;
        
        // Для привилегированных акций ищем и базовый тикер
        const baseTicker = ticker.toLowerCase().endsWith('p') ? ticker.slice(0, -1).toUpperCase() : ticker;
        
        if (typeof echelonTableData !== 'undefined') {
            for (let i = 0; i < echelonTableData.length; i++) {
                let found = echelonTableData[i].find(item => item.t === ticker);
                if (!found && ticker !== baseTicker) {
                    found = echelonTableData[i].find(item => item.t === baseTicker);
                }
                if (found) {
                    companyData = {
                        t: ticker, // Используем оригинальный тикер
                        n: found.n || ticker,
                        sector: found.sector || '',
                        target: found.target || '—',
                        type: 'Акция',
                        p: 0
                    };
                    break;
                }
            }
        }
        
        if (companyData) {
            openCompanyPage(companyData, ticker);
        } else {
            // Пробуем открыть без данных
            openCompanyPage(null, ticker);
        }
    } else {
        showToast('Информация о компании недоступна');
    }
}

// Показать/скрыть все акции
let stocksExpanded = false;

function toggleStocksTable() {
    const rows = document.querySelectorAll('.stocks-table-row');
    const trigger = document.getElementById('stocksGhostTrigger');
    const text = document.getElementById('stocksGhostText');
    
    stocksExpanded = !stocksExpanded;
    
    rows.forEach((row, index) => {
        if (stocksExpanded) {
            row.classList.remove('stocks-row-hidden');
            row.style.animation = 'none';
            row.offsetHeight;
            row.style.animation = `staggerIn 0.3s ease forwards`;
            row.style.animationDelay = `${index * 0.05}s`;
        } else {
            if (index >= 3) {
                row.classList.add('stocks-row-hidden');
            }
        }
    });
    
    text.innerText = stocksExpanded ? 'СКРЫТЬ' : 'ОТКРЫТЬ СПИСОК';
    trigger.classList.toggle('open', stocksExpanded);

    // === НОВОЕ: ПРОКРУТКА К НАЧАЛУ ПРИ СКРЫТИИ ===
    if (!stocksExpanded) {
        window.scrollTo({
            top: 0,
            behavior: 'smooth' // Плавная прокрутка
        });
    }
    // ===========================================
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

function updateStocksShowMoreButton() {
    const rows = document.querySelectorAll('.stocks-table-row');
    const trigger = document.getElementById('stocksGhostTrigger');
    
    if (rows.length <= 5) {
        trigger.style.display = 'none';
    } else {
        trigger.style.display = 'flex';
    }
}

// CSS для скрытых строк акций
const stocksHiddenStyle = document.createElement('style');
stocksHiddenStyle.textContent = `
    .stocks-row-hidden {
        display: none !important;
    }
`;
document.head.appendChild(stocksHiddenStyle);

// Функция показа тултипа для цены
function showPriceTooltip(event) {
    event.stopPropagation();
    
    // Удаляем старые тултипы
    document.querySelectorAll('.header-tooltip').forEach(t => t.remove());
    
    const tooltip = document.createElement('div');
    tooltip.className = 'header-tooltip';
    tooltip.innerHTML = 'Цена формируется как:<br><b>Текущая цена + НКД</b>';
    document.body.appendChild(tooltip);
    
    const rect = event.target.getBoundingClientRect();
    tooltip.style.top = (rect.bottom + 8) + 'px';
    tooltip.style.right = (window.innerWidth - rect.right) + 'px';
    
    // Закрытие по клику в любом месте
    setTimeout(() => {
        document.addEventListener('click', function closeTooltip() {
            tooltip.remove();
            document.removeEventListener('click', closeTooltip);
        });
    }, 100);
    
    // Автозакрытие через 3 секунды
    setTimeout(() => {
        if (tooltip.parentNode) {
            tooltip.remove();
        }
    }, 3000);
}

// Функция показа тултипа для доходности
function showYieldTooltip(event) {
    event.stopPropagation();
    
    // Удаляем старые тултипы
    document.querySelectorAll('.header-tooltip').forEach(t => t.remove());
    
    const tooltip = document.createElement('div');
    tooltip.className = 'header-tooltip';
    tooltip.innerHTML = '<b>Простая доходность к погашению</b>';
    document.body.appendChild(tooltip);
    
    const rect = event.target.getBoundingClientRect();
    tooltip.style.top = (rect.bottom + 8) + 'px';
    tooltip.style.left = (rect.left) + 'px';
    
    // Закрытие по клику в любом месте
    setTimeout(() => {
        document.addEventListener('click', function closeTooltip() {
            tooltip.remove();
            document.removeEventListener('click', closeTooltip);
        });
    }, 100);
    
    // Автозакрытие через 3 секунды
    setTimeout(() => {
        if (tooltip.parentNode) {
            tooltip.remove();
        }
    }, 3000);
}

// Новые функции для раскрывающихся пояснений
function toggleYieldDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('yieldDropdown');
    const priceDropdown = document.getElementById('priceDropdown');
    
    // Закрываем другой dropdown
    if (priceDropdown) priceDropdown.classList.remove('show');
    
    // Переключаем текущий
    if (dropdown) {
        dropdown.classList.toggle('show');
        
        // Закрытие по клику вне
        if (dropdown.classList.contains('show')) {
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
    }
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

function togglePriceDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('priceDropdown');
    const yieldDropdown = document.getElementById('yieldDropdown');
    
    // Закрываем другой dropdown
    if (yieldDropdown) yieldDropdown.classList.remove('show');
    
    // Переключаем текущий
    if (dropdown) {
        dropdown.classList.toggle('show');
        
        // Закрытие по клику вне
        if (dropdown.classList.contains('show')) {
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
    }
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Функция показа/скрытия подсказки для НКД и текущей купонной доходности
function toggleOfzHelp(helpId, event) {
    event.stopPropagation();
    const help = document.getElementById(helpId);
    if (help) {
        help.classList.toggle('show');
    }
    
    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Функция прямого открытия TradingView без предупреждения
function openTradingViewDirect(ticker) {
    const tvUrl = `https://ru.tradingview.com/chart/?symbol=MOEX%3A${ticker}`;
    openExternalLink(tvUrl);
}

// ========================================================================
// КОНЕЦ AURORA REBALANCE ФУНКЦИЙ
// ========================================================================
    
// Исправленная функция копирования
function copyTicker(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast("Скопировано!");
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
    });
}

// Исправленная функция раскрытия
function toggleOfzDetails(ticker) {
    const detailEl = document.getElementById(`details-${ticker}`);
    const container = document.getElementById(`container-${ticker}`);
    
    const isOpen = detailEl.style.display === 'block';
    
    // Закрываем все остальные (опционально, для чистоты дизайна)
    // document.querySelectorAll('.ofz-lux-details').forEach(el => el.style.display = 'none');
    // document.querySelectorAll('.ofz-row-container').forEach(el => el.classList.remove('active'));

    if (isOpen) {
        detailEl.style.display = 'none';
        container.classList.remove('active');
    } else {
        detailEl.style.display = 'block';
        container.classList.add('active');
    }
}

    // Функция для нового триггера ОФЗ
function toggleOfzGhost() {
    const hiddenRows = document.querySelectorAll('.ofz-row-hidden');
    const allRows = document.querySelectorAll('.ofz-row-container');
    const trigger = document.getElementById('ghostTriggerOfz');
    const text = document.getElementById('ghostTextOfz');

    // Если у нас есть скрытые строки — значит нужно раскрыть
    if (hiddenRows.length > 0) {
        hiddenRows.forEach(row => {
            row.classList.remove('ofz-row-hidden');
            row.style.animation = 'fadeIn 0.4s ease forwards';
        });
        text.innerText = "СКРЫТЬ";
        trigger.classList.add('open');
    } else {
        // Если скрытых нет — значит нужно скрыть всё после 3-й строки
        allRows.forEach((row, index) => {
            if (index > 2) {
                row.classList.add('ofz-row-hidden');
            }
        });
        text.innerText = "ПОКАЗАТЬ ВСЕ";
        trigger.classList.remove('open');
        
        // Скроллим чуть выше, чтобы пользователь не потерялся
        document.querySelector('.ofz-analogs-title').scrollIntoView({ behavior: 'smooth' });
    }

    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

    // НОВАЯ ФУНКЦИЯ КОПИРОВАНИЯ
function copyTickerNew(text) {
    navigator.clipboard.writeText(text).then(() => {
        showLuxuryToast("СКОПИРОВАНО", text);
        
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
    });
}

// Функция управления люксовой капсулой (универсальная)
function showLuxuryToast(title, message) {
    const notify = document.getElementById('luxuryNotification');
    if (!notify) return;

    // 1. Меняем контент
    const titleEl = notify.querySelector('.notify-title');
    const msgEl = notify.querySelector('.notify-message');
    const iconContainer = notify.querySelector('.notify-icon-circle');
    
    // Сохраняем исходное состояние (для ошибки)
    const oldTitle = titleEl.innerText;
    const oldMsg = msgEl.innerText;
    const oldIcon = iconContainer.innerHTML;
    const oldColor = iconContainer.style.color;

    // Ставим галочку успеха
    titleEl.innerText = title;
    msgEl.innerText = message;
    iconContainer.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';
    iconContainer.style.color = "#2ecc71"; // Зеленый цвет

    // 2. Показываем
    notify.classList.add('show');

    // 3. Скрываем и возвращаем как было
    setTimeout(() => {
        notify.classList.remove('show');
        // Возвращаем через 500мс (после анимации скрытия), чтобы вернуть состояние "Ошибки"
        setTimeout(() => {
            titleEl.innerText = "Минимальный капитал"; // или верните исходное
            msgEl.innerText = "Введите сумму от 100 000 ₽";
            iconContainer.innerHTML = oldIcon;
            iconContainer.style.color = "";
        }, 500);
    }, 2000);
}

    async function fetchBondDetailsInBackground() {
    const promises = bonds.map(async (b) => {
        try {
            const extra = await fetchBondData(b.t);
            b.nkd = extra.nkd || 0;
            b.matDate = extra.matDate || '—';
        } catch(e) {
            console.log("Error fetching", b.t);
        }
    });
    
    await Promise.all(promises);
    
    // Лог загруженных данных
    console.log('[DATA LOADED] bonds:', bonds.length, 'bondDetailsMap keys:', Object.keys(bondDetailsMap).length);
    bonds.forEach(b => {
        const d = bondDetailsMap[b.t] || {};
        console.log(`[DATA] ${b.t}: p=${b.p}, nkd=${b.nkd}, couponValue=${d.couponValue}, freq=${d.freq}, matDate=${d.matDate}`);
    });
    
    // После загрузки обновляем отображение
    renderOfzList();
    draw();
}

// Функция поиска компании по тикеру (вызывается из карточки акции)
function searchCompanyInternal(ticker) {
    performSearch(ticker);
}

        function performSearch(query) {
    if(!query || query.length < 2) {
        openCompanyPage(null, query);
        return;
    }
    
    const q = query.toUpperCase();
    let results = [];
    
    // 1. Ищем в акциях портфеля (12 шт)
    echelons.forEach(e => {
        e.assets.forEach(a => {
            if(a.t.toUpperCase().includes(q) || a.n.toUpperCase().includes(q)) {
                results.push({...a, type: 'Акция'});
            }
        });
    });
    
    // 2. Ищем в ОФЗ портфеля (8 шт)
    bonds.forEach(b => {
        if(b.t.toUpperCase().includes(q) || b.n.toUpperCase().includes(q)) {
            results.push({...b, type: 'Облигация'});
        }
    });
    
    // 3. НОВОЕ: Ищем в таблице эшелонов (до 48 акций)
    echelonTableData.forEach((column, echelonIndex) => {
        column.forEach(asset => {
            // Проверяем, что актив ещё не добавлен
            const alreadyAdded = results.some(r => r.t === asset.t);
            if (!alreadyAdded && (asset.t.toUpperCase().includes(q) || asset.n.toUpperCase().includes(q))) {
                results.push({
                    ...asset,
                    type: 'Акция',
                    p: 0 // Цена будет загружена в openCompanyPage
                });
            }
        });
    });
    
    const input = document.getElementById('tickerSearchInput');
    input.value = '';
    input.blur();
    
    openCompanyPage(results[0] || null, query);
}
        
        async function openCompanyPage(item, searchQuery = '') {
    const content = document.getElementById('company-content');
    const screenCompany = document.getElementById('screen-company');
    
    // Убираем класс активности при закрытии
    screenCompany.classList.remove('company-screen-active');
    
    if(!item) {
        content.innerHTML = `
            <div class="search-empty-state">
                <div class="icon">🔍</div>
                <div class="title">Ничего не найдено</div>
                <div class="desc">По запросу "${searchQuery}" не найдено результатов.<br>Попробуйте изменить запрос.</div>
            </div>
        `;
        showScreen('screen-company');
        return;
    }
    
    // Показываем skeleton пока грузятся данные
    content.innerHTML = `
        <div class="skeleton-company">
            <div class="skeleton-bone s-back"></div>
            <div class="skeleton-bone s-name"></div>
            <div class="skeleton-bone s-price-big"></div>
            <div class="skeleton-bone s-change"></div>
            <div class="skeleton-bone s-trend"></div>
            <div class="s-actions"><div class="skeleton-bone s-action-btn"></div><div class="skeleton-bone s-action-btn"></div></div>
            <div class="skeleton-bone s-section-title"></div>
            <div class="s-analytics">
                <div class="skeleton-bone s-analytics-tile"></div>
                <div class="skeleton-bone s-analytics-tile"></div>
                <div class="skeleton-bone s-analytics-tile"></div>
                <div class="skeleton-bone s-analytics-tile"></div>
            </div>
            <div class="skeleton-bone s-section-title" style="margin-top:16px"></div>
            <div class="skeleton-news-item"><div class="skeleton-bone s-news-title"></div><div class="skeleton-bone s-news-date"></div></div>
            <div class="skeleton-news-item"><div class="skeleton-bone s-news-title"></div><div class="skeleton-bone s-news-date"></div></div>
            <div class="skeleton-news-item"><div class="skeleton-bone s-news-title"></div><div class="skeleton-bone s-news-date"></div></div>
        </div>
    `;
    showScreen('screen-company');
    
    const isStock = item.type === 'Акция';
    const target = isStock ? item.target : '-';
    
    // Определяем цвет свечения в зависимости от профита
    let glowColor = 'rgba(46, 204, 113, 0.15)'; // зелёный по умолчанию
    let changeClass = 'neutral';
    let changeText = '--';
    let changePercent = 0;
    
    // Загружаем данные о цене и изменении
    try {
        const url = MOEX_PROXY + '?path=' + encodeURIComponent(`/iss/engines/stock/markets/${isStock ? 'shares' : 'bonds'}/securities/${item.t}.json?iss.meta=off&iss.only=securities,marketdata`);
        const res = await fetch(url);
        const data = await res.json();
        const marketdata = data.marketdata.data[0];
        const marketcols = data.marketdata.columns;
        const last = marketdata[marketcols.indexOf('LAST')];
        const open = marketdata[marketcols.indexOf('OPEN')];
        
        if (last && open && open > 0) {
            const change = last - open;
            changePercent = (change / open) * 100;
            const sign = change > 0 ? '+' : '';
            
            if (change > 0) {
                changeClass = 'positive';
                glowColor = 'rgba(46, 204, 113, 0.15)';
                changeText = `${sign}${change.toFixed(2)} ₽ (${sign}${changePercent.toFixed(2)}%)`;
            } else if (change < 0) {
                changeClass = 'negative';
                glowColor = 'rgba(231, 76, 60, 0.15)';
                changeText = `${change.toFixed(2)} ₽ (${changePercent.toFixed(2)}%)`;
            } else {
                changeClass = 'neutral';
                changeText = '0.00 ₽ (0.00%)';
            }
        }
    } catch (e) { 
        console.log('Error fetching company details'); 
    }
    
    // Устанавливаем цвет свечения
    screenCompany.style.setProperty('--glow-color', glowColor);
    screenCompany.classList.add('company-screen-active');
    
    // Определяем эшелон для акций
    let echelonNum = 0;
    let echelonName = '';
    if (isStock) {
        echelonNum = echelons.findIndex(e => e.assets.some(a => a.t === item.t)) + 1;
        if (echelonNum > 0) {
            echelonName = ['I Эшелон', 'II Эшелон', 'III Эшелон', 'IV Эшелон'][echelonNum - 1];
        }
    }
    
    // Рассчитываем прогресс к цели (для акций)
    let progressPercent = 0;
    if (isStock && item.target) {
        const targetPrice = parseFloat(item.target.replace(/[^\d.]/g, '')) || 0;
        if (targetPrice > 0 && item.p > 0) {
            progressPercent = Math.min((item.p / targetPrice) * 100, 100);
        }
    }
    
    // Определяем уровень риска
    const riskLevels = ['Низкий', 'Умеренный', 'Средний', 'Высокий'];
    const riskLevel = isStock ? riskLevels[Math.min(echelonNum - 1, 3)] || 'Н/Д' : 'Низкий';
    
    // Генерируем SVG мини-тренд (случайный для демо)
    const trendPoints = generateTrendLine(changePercent >= 0);
    const trendColor = changePercent >= 0 ? '#2ecc71' : '#e74c3c';
    
    // Формируем HTML
    let html = `
        <!-- Верхняя панель -->
        <div class="company-top-bar">
            <div class="company-back-btn" onclick="goBackFromCompany()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </div>
            <div class="company-ticker-badge">
                <span class="ticker-dot"></span>
                <span>${item.t}</span>
                <span style="opacity: 0.5;">•</span>
                <span style="opacity: 0.7;">MOEX</span>
            </div>
        </div>
        
        <!-- Hero секция -->
        <div class="company-hero">
            <div class="company-hero-name">${item.n}</div>
            <div class="company-hero-price">${item.p.toLocaleString('ru-RU')} ₽</div>
            <div class="company-hero-change ${changeClass}">
                ${changeClass === 'positive' ? '↑' : changeClass === 'negative' ? '↓' : '→'} ${changeText}
            </div>
            
            <!-- SVG мини-тренд -->
            <div class="company-trend-svg">
                <svg width="200" height="50" viewBox="0 0 200 50">
                    <defs>
                        <linearGradient id="trendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:${trendColor};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${trendColor};stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <polyline class="trend-line" fill="none" stroke="url(#trendGradient)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="${trendPoints}" />
                </svg>
            </div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="company-actions">
            <button class="company-action-btn primary" onclick="openTradingView(event, '${item.t}')">
                <svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                График
            </button>
            <button class="company-action-btn" onclick="copyTicker(event, '${item.t}')">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                История див.
            </button>
        </div>
        
        <!-- Описание актива -->
        ${companyDescriptions[item.t] ? `
        <div class="glass-card company-description-section">
            <div class="company-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                Описание актива
            </div>
            <div class="company-description-text">
                ${highlightKeywords(companyDescriptions[item.t])}
            </div>
        </div>
        ` : ''}
        
        <!-- Аналитика -->
        <div class="company-section-title" style="padding: 0 4px; margin-bottom: 12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
            </svg>
            Аналитика
        </div>
        <div class="analytics-grid">
            <div class="analytics-tile tile-forecast">
                <div class="analytics-tile-label">Target Forecast</div>
                <div class="analytics-tile-value">${isStock ? target.replace(' ₽', '') : item.y}</div>
                <div class="analytics-tile-sub">${isStock ? 'Целевая цена' : 'Доходность к погашению'}</div>
                ${isStock ? `
                <div class="forecast-progress">
                    <div class="forecast-progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                ` : ''}
            </div>
            
            <div class="analytics-tile tile-dividends">
                <div class="analytics-tile-label">Dividends</div>
                <div class="analytics-tile-value">${isStock ? (echelonNum <= 2 ? 'Да' : 'Нет') : 'Купоны'}</div>
                <div class="analytics-tile-sub">${isStock ? 'Выплата дивидендов' : 'Регулярные выплаты'}</div>
            </div>
            
            <div class="analytics-tile tile-risk">
                <div class="analytics-tile-label">Risk Tier</div>
                <div class="analytics-tile-value">${riskLevel}</div>
                <div class="analytics-tile-sub">${isStock ? echelonName || 'Не определён' : 'ОФЗ - гос. гарантия'}</div>
            </div>
            
            <div class="analytics-tile tile-cap">
                <div class="analytics-tile-label">Market Cap</div>
                <div class="analytics-tile-value">${isStock ? 'Large' : 'Gov'}</div>
                <div class="analytics-tile-sub">${isStock ? 'Капитализация' : 'Государственная'}</div>
            </div>
        </div>
        
       <!-- События терминала (новости) -->
        <div class="glass-card events-section">
            <div class="company-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Новости Smart-Lab
            </div>
            
            <div id="company-news-list">
                <div class="skeleton-container">
                    <div class="skeleton-news-item"><div class="skeleton-bone s-news-title"></div><div class="skeleton-bone s-news-date"></div></div>
                    <div class="skeleton-news-item"><div class="skeleton-bone s-news-title" style="width:75%"></div><div class="skeleton-bone s-news-date"></div></div>
                    <div class="skeleton-news-item"><div class="skeleton-bone s-news-title" style="width:85%"></div><div class="skeleton-bone s-news-date"></div></div>
                </div>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
            // Загружаем новости асинхронно после отрисовки страницы
    loadAndDisplayNews(item.t);
    showScreen('screen-company');
}

    // Функция загрузки и отображения новостей
async function loadAndDisplayNews(ticker) {
    const newsContainer = document.getElementById('company-news-list');
    if (!newsContainer) return;
    
    // Показываем skeleton для новостей
    newsContainer.innerHTML = `
        <div class="skeleton-container">
            <div class="skeleton-news-item"><div class="skeleton-bone s-news-title"></div><div class="skeleton-bone s-news-date"></div></div>
            <div class="skeleton-news-item"><div class="skeleton-bone s-news-title" style="width:75%"></div><div class="skeleton-bone s-news-date"></div></div>
            <div class="skeleton-news-item"><div class="skeleton-bone s-news-title" style="width:85%"></div><div class="skeleton-bone s-news-date"></div></div>
        </div>
    `;
    
    // Загружаем новости
    const news = await loadNewsForTicker(ticker);
    
    // Если новостей нет
    if (!news || news.length === 0) {
        newsContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <div style="font-size: 24px; margin-bottom: 10px;">📭</div>
                Новостей по ${ticker} пока нет
            </div>
        `;
        return;
    }
    
    // Формируем HTML для новостей
    let html = '';
    news.forEach((item) => {
        // Парсим реальную дату из ответа API
        const newsDate = new Date(item.date);
        
        // Проверяем валидность даты
        const isValidDate = !isNaN(newsDate.getTime());
        const displayDate = isValidDate ? newsDate : new Date();
        
        // Форматируем относительную дату для описания
        const relativeDate = getRelativeDateText(displayDate);
        
        html += `
            <div class="event-item" onclick="openExternalLink('${item.link}')" style="cursor: pointer;">
                <div class="event-date">
                    <span class="event-date-day">${displayDate.getDate()}</span>
                    <span class="event-date-month">${getMonthShort(displayDate.getMonth())}</span>
                </div>
                <div class="event-content">
                    <div class="event-title">${item.title.substring(0, 60)}${item.title.length > 60 ? '...' : ''}</div>
                    <div class="event-description" style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: var(--accent-blue);">Smart-Lab</span>
                        <span>•</span>
                        <span>${relativeDate}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    newsContainer.innerHTML = html;
}

// Функция для получения относительной даты (сегодня, вчера, 3 дня назад и т.д.)
function getRelativeDateText(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    if (diffMinutes < 60) {
        return diffMinutes <= 1 ? 'Только что' : `${diffMinutes} мин. назад`;
    }
    
    if (diffHours < 24) {
        return `${diffHours} ${getHoursWord(diffHours)} назад`;
    }
    
    if (diffDays === 0) return 'Сегодня';
    if (diffDays === 1) return 'Вчера';
    if (diffDays < 7) return `${diffDays} ${getDaysWord(diffDays)} назад`;
    
    // Для более старых новостей показываем полную дату
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
}

// Склонение слова "час"
function getHoursWord(n) {
    if (n === 1 || n === 21) return 'час';
    if (n >= 2 && n <= 4 || n >= 22 && n <= 24) return 'часа';
    return 'часов';
}

// Склонение слова "день"
function getDaysWord(n) {
    if (n === 1) return 'день';
    if (n >= 2 && n <= 4) return 'дня';
    return 'дней';
}

// Вспомогательная функция: генерация точек для SVG тренда
function generateTrendLine(isPositive) {
    let points = [];
    let y = 25;
    
    for (let x = 0; x <= 200; x += 20) {
        // Добавляем случайность, но с общим трендом вверх или вниз
        const randomDelta = (Math.random() - 0.5) * 15;
        const trendDelta = isPositive ? -1.5 : 1.5;
        y = Math.max(5, Math.min(45, y + randomDelta + trendDelta));
        points.push(`${x},${y}`);
    }
    
    return points.join(' ');
}

// Вспомогательная функция: получить короткое название месяца
function getMonthShort(monthIndex) {
    const months = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
    return months[monthIndex];
}

// Вспомогательная функция: выделение ключевых слов в описании
function highlightKeywords(text) {
    // Список ключевых слов для выделения
    const keywords = ['нефтегазовый', 'банк', 'ритейл', 'телеком', 'металлургия', 'энергетика', 'IT', 'технологии', 'добыча', 'производство', 'экспорт', 'дивиденды', 'лидер', 'крупнейший'];
    
    let result = text;
    keywords.forEach(keyword => {
        const regex = new RegExp(`(${keyword})`, 'gi');
        result = result.replace(regex, '<span class="highlight">$1</span>');
    });
    
    return result;
}

      function draw() {
    console.log('draw() called');
    
    // 1. Получаем текущее значение слайдера
    const slider = document.getElementById('ratioSlider');
    if (!slider) return;
    const bondPct = parseInt(slider.value);
    const stockPct = 100 - bondPct;
    
    // 2. СРАЗУ обновляем видимость карточек в списке (скрываем дубликаты)
    updateStrategyCardSelection(bondPct);

    // 3. Получаем введенную сумму
    const inputSum = getSumInputValue();

    // 4. Если сумма 0, обновляем только проценты в центре и выходим
    if (inputSum === 0) {
        if(document.getElementById('labelBondsPct')) {
             document.getElementById('labelBondsPct').innerText = bondPct;
             document.getElementById('labelStocksPct').innerText = stockPct;
        }
        return;
    }
    
    // Дальше идет твоя логика расчетов...
    console.log('Drawing with sum:', inputSum);

    // Обновляем визуальное выделение кнопок-пресетов под кругом
    const presets = document.querySelectorAll('.preset-btn-modern');
    presets.forEach(p => {
         const match = p.getAttribute('onclick').match(/\d+/);
         if(match) {
             const pct = parseInt(match[0]);
             if(pct !== bondPct) p.classList.remove('selected-preset');
             else p.classList.add('selected-preset');
         }
    });


            const bondBudget = (inputSum * bondPct) / 100;
            const stockBudget = (inputSum * stockPct) / 100;
            const feeVal = inputSum * brokerFee;

            if(document.getElementById('labelBondsPct')) {
    document.getElementById('labelBondsPct').innerText = bondPct;
    document.getElementById('labelStocksPct').innerText = stockPct;
    
    const dynamicSubtitle = document.getElementById('dynamicSubtitle');
    if(dynamicSubtitle) {
        dynamicSubtitle.innerText = `Система ${bondPct}/${stockPct}: Денежный Поток и Рост.`;
    }
    
    document.querySelectorAll('.bond-pct-text').forEach(el => el.innerText = bondPct);
                document.querySelectorAll('.stock-pct-text').forEach(el => el.innerText = stockPct);
                const mainChart = document.getElementById('mainChart');
    if(mainChart) {
        mainChart.style.background = `conic-gradient(var(--accent-blue) 0% ${bondPct}%, var(--accent-green) ${bondPct}% 100%)`;
        mainChart.setAttribute('data-pct', `${bondPct}/${stockPct}`);
    }
}

            const bondSection = document.getElementById('section-bonds');
            const couponBox = document.getElementById('couponBox');
            const separator = document.getElementById('section-separator');
            const stockSection = document.getElementById('section-stocks');
            const stockHeader = document.getElementById('header-stocks');
            const footerImportant = document.getElementById('footer-important');
            
            if(bondSection && stockSection) {
                bondSection.style.display = 'block'; couponBox.style.display = 'block';
                separator.style.display = 'flex'; stockSection.style.display = 'block';
                footerImportant.style.display = 'block'; stockHeader.innerText = "2. Растущая часть";
                if (bondPct === 0) {
                    bondSection.style.display = 'none'; couponBox.style.display = 'none';
                    separator.style.display = 'none'; stockHeader.innerText = "1. Растущая часть";
                } else if (bondPct === 100) {
                    stockSection.style.display = 'none'; footerImportant.style.display = 'none';
                    separator.style.display = 'none';
                }
            }

            let actualSpentTotal = 0; let bondQuantities = {};
            let totalBondProjectedIncome = 0;
            let rainData = [];
            let bondCalculations = [];
            
       // === ГЕНЕРАЦИЯ СПИСКА ОБЛИГАЦИЙ (С ПОДСВЕТКОЙ ISIN) ===
            let bHtml = '';
            if (bonds.length > 0 && bondBudget > 0) {
                // Считаем полную стоимость каждой облигации
                bondCalculations = bonds.map(b => { 
                    const fullCostPerUnit = (b.p + b.nkd) * (1 + brokerFee); 
                    return { ...b, qty: 0, fullCostPerUnit }; 
                });
                
                // Фильтруем: оставляем только те облигации, на которые хватает бюджета (хотя бы 1 шт)
                let affordableBonds = bondCalculations.filter(b => b.fullCostPerUnit > 0 && b.fullCostPerUnit <= bondBudget);
                
                if (affordableBonds.length > 0) {
                    // 1. Равномерно распределяем бюджет по всем облигациям
                    const perBondBudget = bondBudget / affordableBonds.length;
                    affordableBonds.forEach(b => {
                        b.qty = Math.floor(perBondBudget / b.fullCostPerUnit);
                    });
                    
                    // 2. Суммируем остаток от каждой и распределяем на первые (лучшие)
                    let leftover = bondBudget - affordableBonds.reduce((acc, b) => acc + (b.qty * b.fullCostPerUnit), 0);
                    
                    // Идём по порядку (первые = лучшие), добавляем по 1 шт пока хватает
                    let distributed = true;
                    while (distributed) {
                        distributed = false;
                        for (const bond of affordableBonds) {
                            if (leftover >= bond.fullCostPerUnit) {
                                bond.qty += 1;
                                leftover -= bond.fullCostPerUnit;
                                distributed = true;
                            }
                        }
                    }
                    
                    // Убираем облигации с qty=0 (не влезли даже по 1 шт)
                    affordableBonds = affordableBonds.filter(b => b.qty > 0);
                }
                
                // Объединяем: показываем только купленные облигации
                bondCalculations = affordableBonds;
                
                bondCalculations.forEach(b => {
                    actualSpentTotal += (b.qty * b.fullCostPerUnit); 
                    bondQuantities[b.t] = b.qty;
                    
                    // === ПРАВИЛЬНЫЙ РАСЧЁТ КУПОННОГО ДОХОДА ===
                    // couponValue × кол-во_оставшихся_купонов × qty
                    const details = bondDetailsMap[b.t] || {};
                    const couponVal = details.couponValue || 0;
                    const freq = details.freq || 2; // частота купонов в год (по умолчанию 2)
                    const matDateStr = details.matDate || '';
                    
                    let remainingCoupons = freq * 3; // fallback: 3 года × частота
                    if (matDateStr && matDateStr !== '—') {
                        const matDate = new Date(matDateStr);
                        const now = new Date();
                        if (matDate > now) {
                            const daysRemaining = (matDate - now) / (1000 * 60 * 60 * 24);
                            const couponPeriodDays = freq > 0 ? 365 / freq : 182;
                            remainingCoupons = Math.floor(daysRemaining / couponPeriodDays);
                        } else {
                            remainingCoupons = 0; // облигация уже погашена
                        }
                    }
                    
                    const bondCouponIncome = couponVal * remainingCoupons * b.qty;
                    totalBondProjectedIncome += bondCouponIncome;
                    
                    console.log(`[FORECAST BONDS] ${b.t}: couponVal=${couponVal}, freq=${freq}, matDate=${matDateStr}, remainCoupons=${remainingCoupons}, qty=${b.qty}, income=${bondCouponIncome}`);
                    
                    if(b.qty > 0 && bondCouponsMap[b.t]) {
                        const info = bondCouponsMap[b.t];
                        const netAmount = (info.value * b.qty) * (1 - currentTax);
                        rainData.push({ date: info.date, name: b.n, qty: b.qty, amount: netAmount });
                    }
                    
                    // Данные для деталей (используем уже объявленный details)
                    const detailsFull = bondDetailsMap[b.t] || { matDate:'—', couponValue:0, nextCoupon:'—', couponYield:'—', freq:0 };
                    const calculatedCY = (b.p > 0 && detailsFull.couponValue && detailsFull.freq) ? ((detailsFull.couponValue * detailsFull.freq) / b.p * 100).toFixed(2) : '0.00';
                    
                    bHtml += `
                    <div class="portfolio-list-item" onclick="this.classList.toggle('expanded')">
                        <div class="list-item-summary">
                            <span class="list-item-ticker">${limitName(b.n)}</span>
                            <span class="list-item-yield bonds">${b.y}</span>
                            <span class="list-item-qty">${b.qty} шт.</span>
                            <span class="list-item-sum">${Math.round(b.qty * b.p).toLocaleString()} ₽</span>
                        </div>
                        <div class="list-item-details" onclick="event.stopPropagation()">
                            <div class="details-row">
                                <span class="details-row-label">Полное Наименование</span>
                                <span class="details-row-value">${b.n}</span>
                            </div>
                            
                            <!-- ОБНОВЛЕНО: ISIN с подсветкой и иконкой -->
                            <div class="details-row">
                                <span class="details-row-label">ISIN/Код</span>
                                <span class="details-row-value detail-ticker-highlight" onclick="copyTicker(event, '${b.t}')">
                                    ${b.t}
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                </span>
                            </div>
                            
                            <div class="details-row">
                                <span class="details-row-label">Дата погашения</span>
                                <span class="details-row-value">${details.matDate}</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Цена</span>
                                <span class="details-row-value">${b.p} ₽</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">НКД</span>
                                <span class="details-row-value">${b.nkd.toFixed(2)} ₽</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Простая Доходность</span>
                                <span class="details-row-value">${calculatedCY}%</span>
                            </div>
                            
                            <button class="details-btn" onclick="openTradingView(event, '${b.t}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                Открыть график
                            </button>
                        </div>
                    </div>`;
                });
            }



if(document.getElementById('listBonds')) { 
    document.getElementById('listBonds').innerHTML = bHtml;
    
    // Обновляем бейдж суммы облигаций
    const badgeBonds = document.getElementById('badge-bonds-sum');
    if(badgeBonds) badgeBonds.innerText = Math.round(bondBudget).toLocaleString() + ' ₽';
}
          
// === ОБНОВЛЕНИЕ ИТОГО ОФЗ + % ИСПОЛНЕНИЯ БЮДЖЕТА ===
    const bondsTotalRow = document.getElementById('bondsTotalSum');
    const bondsPercentBadge = document.getElementById('bondsTotalPercent');
    
    // 1. Берем видимые суммы из списка (как мы уже сделали, это работает верно)
    const bondSumItems = document.querySelectorAll('#listBondsV2 .portfolio-ofz-sum');

    if(bondsTotalRow) {
        let totalVisibleSum = 0;
        
        // Складываем все строки расходов
        bondSumItems.forEach(el => {
            const val = parseInt(el.innerText.replace(/\D/g, ''), 10) || 0;
            totalVisibleSum += val;
        });

        // Выводим сумму
        bondsTotalRow.innerText = totalVisibleSum.toLocaleString() + ' ₽';

        // 2. Считаем процент ОТ БЮДЖЕТА НА ОБЛИГАЦИИ
        if(bondsPercentBadge && typeof bondBudget !== 'undefined' && bondBudget > 0) {
            
            const percent = (totalVisibleSum / bondBudget) * 100;
            
            // Логика красивого отображения 100%
            // Если процент между 99.9 и 100.1 (погрешность на копейки), пишем 100%
            if (percent > 99.9 && percent < 100.1) {
                 bondsPercentBadge.innerText = '100%';
            } else {
                 // Иначе показываем 1 знак после запятой (например, 99.8%)
                 bondsPercentBadge.innerText = percent.toFixed(1) + '%';
            }
        }
    }
            
            if(document.getElementById('couponList')) {
                rainData.sort((a,b) => new Date(a.date) - new Date(b.date));
                let couponHtml = ''; let couponTotal = 0;
                if(rainData.length === 0) { 
                    couponHtml = '<div style="text-align:center; padding:15px; color:#aaa; font-size:12px;">Нет ближайших выплат для выбранных активов.</div>';
                } else { 
                    rainData.forEach(r => { 
                        couponTotal += r.amount; 
                        couponHtml += `
                        <div class="coupon-row">
                            <div><b>${new Date(r.date).toLocaleDateString('ru-RU')}</b></div>
                            <div style="color:#8e8e93">${limitName(r.name)}</div>
                            <div style="text-align:center">${r.qty}шт.</div>
                            <div style="text-align:right"><b>${Math.round(r.amount).toLocaleString()}₽</b></div>
                        </div>`; 
                    }); 
                }
                document.getElementById('couponList').innerHTML = couponHtml;
                document.getElementById('couponTotalHeader').innerText = Math.round(couponTotal).toLocaleString() + ' ₽';
            }
            
            let ofzHtml = '';
            bonds.forEach(b => {
                const details = bondDetailsMap[b.t] || { matDate:'—', couponValue:0, nextCoupon:'—', couponYield:'—', freq:0 };
                const calculatedCY = (b.p > 0 && details.couponValue && details.freq) ? ((details.couponValue * details.freq) / b.p * 100).toFixed(2) : '0.00';
                ofzHtml += `
                <div class="ofz-card-modern" onclick="toggleOfzDetails('details-${b.t}')">
                    <div class="ofz-main-info">
                        <div class="ofz-name-lg">${limitName(b.n)}</div>
                        <div class="ofz-ticker-sm">${b.t}</div>
                    </div>
                    <div class="ofz-price">${b.p}</div>
                    <div class="ofz-nkd-badge">${Math.round(b.nkd*10)/10}</div>
                    <div class="ofz-yield-badge" title="Доходность к погашению">
                        ${b.y} <svg class="ofz-arrow" viewBox="0 0 24 24"><path d="M7 17l9.2-9.2M17 17V7H7"/></svg>
                    </div>
                </div>
                <div id="details-${b.t}" class="ofz-details-panel">
                    <div class="ofz-detail-row"><span>Код:</span> <span class="ofz-detail-val">${b.t}</span></div>
                    <div class="ofz-detail-row"><span>НКД:</span> <span class="ofz-detail-val">${b.nkd.toFixed(2)} ₽</span></div>
                    <div class="ofz-detail-row"><span>Дата погашения:</span> <span class="ofz-detail-val">${details.matDate}</span></div>
                    <div class="ofz-detail-row"><span>Размер купона:</span> <span class="ofz-detail-val">${details.couponValue} ₽</span></div>
                    <div class="ofz-detail-row"><span>Дата ближайшего купона:</span> <span class="ofz-detail-val">${details.nextCoupon}</span></div>
                    <div class="ofz-detail-row"><span>Текущая купонная доходность:</span> <span class="ofz-detail-val">${calculatedCY}%</span></div>
                    <div class="ofz-detail-row"><span>Выплат в год:</span> <span class="ofz-detail-val">${details.freq}</span></div>
                </div>`;
            });
            if(document.getElementById('ofz-list')) document.getElementById('ofz-list').innerHTML = ofzHtml;

                                // === ГЕНЕРАЦИЯ ЭШЕЛОНОВ АКЦИЙ (ФИНАЛЬНЫЙ ВАРИАНТ) ===
            let eHtml = '';
            let totalStockProjectedGrowth = 0;
            let echelonIndex = 0;

            echelons.forEach(e => {
                const echelonBudget = stockBudget * e.weight; 
                const perAssetBudget = e.assets.length > 0 ? echelonBudget / e.assets.length : 0;
                
                let stockCalculations = e.assets.map(a => { 
                    const fullCostPerUnit = a.p * (1 + brokerFee); 
                    let qty = fullCostPerUnit > 0 ? Math.floor(perAssetBudget / fullCostPerUnit) : 0; 
                    return { ...a, qty, fullCostPerUnit }; 
                });
                
                let currentEchelonSpent = stockCalculations.reduce((acc, s) => acc + (s.qty * s.fullCostPerUnit), 0);
                if (stockCalculations.length > 0 && (echelonBudget - currentEchelonSpent) >= stockCalculations[0].fullCostPerUnit) {
                    stockCalculations[0].qty += Math.floor((echelonBudget - currentEchelonSpent) / stockCalculations[0].fullCostPerUnit);
                }
                
                const tipId = `echelon-tip-new-${echelonIndex}`;
                const echelonNum = echelonIndex + 1;
                const echelonLabel = ['I', 'II', 'III', 'IV'][echelonIndex];

                // Цвета для плашек (Зеленый, Синий, Желтый, Оранжевый)
                const colors = [
                    { bg: 'rgba(46, 204, 113, 0.15)', txt: '#27ae60' },
                    { bg: 'rgba(52, 152, 219, 0.15)', txt: '#2980b9' },
                    { bg: 'rgba(241, 196, 15, 0.15)', txt: '#f39c12' },
                    { bg: 'rgba(231, 76, 60, 0.15)', txt: '#d35400' }
                ];
                const c = colors[echelonIndex];
                
                eHtml += `
    <div class="echelon-header-new" onclick="toggleEchelonTip(event, '${tipId}')">
        <div class="echelon-header-left">
            <div class="echelon-number e${echelonNum}">${echelonLabel}</div>
            <span class="echelon-title-new" style="color: var(--text-slate); font-family: 'Inter', sans-serif !important; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; background: transparent; padding: 0;"> ${e.title} </span>
            <div class="h-help-btn h-help-animated" style="width:16px;height:16px;font-size:9px;margin-left:2px;" onclick="event.stopPropagation(); this.classList.remove('h-help-animated');">ⓘ</div>
        </div>
        <div class="echelon-header-right">
            <span class="echelon-sum">${Math.round(echelonBudget).toLocaleString()} ₽</span>
            <span class="echelon-percent-badge" style="color: var(--text-slate); font-family: 'Inter', sans-serif !important; font-size: 10px; font-weight: 700; background: transparent; padding: 0; letter-spacing: 0.08em;">${Math.round(e.weight*100)}%</span>
        </div>
    </div>
                
                <div class="echelon-info-tooltip" id="${tipId}">${e.info}</div>
                
                <div class="portfolio-list">
                    <!-- Заголовки таблицы -->
                    <div class="echelon-columns-header">
                        <span>Компания</span>
                        <span>Цель</span>
                        <span>Кол-во</span>
                        <span>Сумма</span>
                    </div>`;
                
                stockCalculations.forEach(s => {
                    actualSpentTotal += (s.qty * s.fullCostPerUnit);
                    const targetPct = parseFloat(s.target.replace(/[^\d.\-]/g,'')) || 0; // target — это % роста
                    
                    // Рост = qty * price * (targetPct / 100)
                    if (s.qty > 0 && targetPct > 0) {
                        const growth = s.qty * s.p * (targetPct / 100);
                        totalStockProjectedGrowth += growth;
                        console.log(`[FORECAST STOCK] ${s.t}: price=${s.p}, target=${targetPct}%, qty=${s.qty}, growth=+${growth.toFixed(0)}`);
                    } else if (s.qty > 0) {
                        console.log(`[FORECAST STOCK] ${s.t}: price=${s.p}, target=${targetPct}%, qty=${s.qty}, growth=0 (цель ≤ 0%)`);
                    }
                    
                    eHtml += `
                    <div class="portfolio-list-item" onclick="this.classList.toggle('expanded')">
                        <div class="list-item-summary">
                            <span class="list-item-ticker">${s.t}</span>
                            <span class="list-item-yield stocks">${s.target.replace(' ₽','')}</span>
                            <span class="list-item-qty">${s.qty} шт.</span>
                            <span class="list-item-sum">${Math.round(s.qty * s.p).toLocaleString()} ₽</span>
                        </div>
                        <div class="list-item-details" onclick="event.stopPropagation()">
                            <div class="details-row">
                                <span class="details-row-label">Компания</span>
                                <span class="details-row-value">${s.n}</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Тикер</span>
                                <span class="details-row-value detail-ticker-highlight" onclick="copyTicker(event, '${s.t}')">
                                    ${s.t} 
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                </span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Цена</span>
                                <span class="details-row-value">${s.p} ₽</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Цель</span>
                                <span class="details-row-value">${s.target}</span>
                            </div>
                            <!-- Примечание статичное -->
                            <div class="details-row" style="border-bottom:none !important; justify-content:center !important; padding-top:6px !important;">
                                <span style="font-size:10px; color:var(--claude-text-secondary); opacity:0.7;">[ Прогноз на период до 36 мес. ]</span>
                            </div>
                            <button class="details-btn" onclick="openTradingView(event, '${s.t}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                Открыть график
                            </button>
                        </div>
                    </div>`;
                });
                
                eHtml += `</div>`; // Закрываем div.portfolio-list
                echelonIndex++;
            });

            console.log(`[FORECAST TOTAL] inputSum=${inputSum}, bonds=${totalBondProjectedIncome}, stocks=${totalStockProjectedGrowth}, fee=${inputSum * brokerFee}, total=${inputSum + totalBondProjectedIncome + totalStockProjectedGrowth - inputSum * brokerFee}`);

            // === ОБНОВЛЕНИЕ ИНТЕРФЕЙСА (ОДИН РАЗ, БЕЗ ДУБЛЕЙ) ===
            if(document.getElementById('echelonContainer')) {
                document.getElementById('echelonContainer').innerHTML = eHtml;
                
                // 1. Обновляем бейдж суммы акций (ИСПРАВЛЕНО)
                const badgeStocks = document.getElementById('badge-stocks-sum');
            if(badgeStocks) {
               badgeStocks.innerText = Math.round(stockBudget).toLocaleString() + ' ₽';
               badgeStocks.style.display = 'flex'; // Принудительно
              }
                // === ОБНОВЛЕНИЕ ИТОГО ПО ЭШЕЛОНАМ ===
const totalRow = document.getElementById('echelonsTotalSum');
if(totalRow) {
    // stockBudget - это переменная, в которой хранится общая сумма на акции
    totalRow.innerText = Math.round(stockBudget).toLocaleString() + ' ₽';
}

                // 2. Обновляем все остальные цифры
                const valStocks = document.getElementById('valStocks');
                if(valStocks) valStocks.innerText = Math.round(stockBudget).toLocaleString();
                
                const usageFill = document.getElementById('usageFill');
                if(usageFill) usageFill.style.width = Math.min((actualSpentTotal / inputSum) * 100, 100) + '%';
                
                const usageLabelText = document.getElementById('usageLabelText');
                if(usageLabelText) usageLabelText.innerText = Math.round(actualSpentTotal).toLocaleString() + ' ₽';
                
                document.getElementById('summ-invested').innerText = Math.round(inputSum).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                document.getElementById('srl-bond-pct').innerText = bondPct + '%';
                document.getElementById('srl-stock-pct').innerText = stockPct + '%';
                document.getElementById('bar-bond-fill').style.width = bondPct + '%';
                document.getElementById('bar-stock-fill').style.width = stockPct + '%';
                
                const feePercent = (brokerFee * 100).toFixed(2);
                document.getElementById('summ-fee').innerText = feePercent + '%';
                
                document.getElementById('summ-bond-income').innerText = '+' + Math.round(totalBondProjectedIncome).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                document.getElementById('summ-stock-growth').innerText = '+' + Math.round(totalStockProjectedGrowth).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                
                const projectedTotal = inputSum + totalBondProjectedIncome + totalStockProjectedGrowth - feeVal;
                let percentageChange = (inputSum > 0) ? ((projectedTotal - inputSum) / inputSum) * 100 : 0;
                const changeSign = percentageChange >= 0 ? '+' : '';
                const changeColor = percentageChange >= 0 ? '#27ae60' : '#e74c3c';
                const changeHtml = ` <span style="font-size: 14px; color: ${changeColor}; font-weight: 500;">(${changeSign}${percentageChange.toFixed(1)}%)</span>`;
                
                document.getElementById('summ-total-3y').innerHTML = Math.round(projectedTotal).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽' + changeHtml;
                
                // === ОБНОВЛЕНИЕ НОВОГО ДИЗАЙНА V2 ===
                // Синхронизируем распределение в новую карточку
                const barStockV2 = document.getElementById('bar-stock-fill-v2');
                const barBondV2 = document.getElementById('bar-bond-fill-v2');
                if (barStockV2) barStockV2.style.width = stockPct + '%';
                if (barBondV2) barBondV2.style.width = bondPct + '%';
                
                const stockPctV2 = document.getElementById('srl-stock-pct-v2');
                const bondPctV2 = document.getElementById('srl-bond-pct-v2');
                if (stockPctV2) stockPctV2.textContent = stockPct + '%';
                if (bondPctV2) bondPctV2.textContent = bondPct + '%';
                
                // Прогноз в новом формате - сумма + процент + детализация
                const totalValueV2 = document.getElementById('summ-total-value-v2');
                const totalPercentV2 = document.getElementById('summ-total-percent-v2');
                const bondIncomeMini = document.getElementById('summ-bond-income-mini');
                const stockGrowthMini = document.getElementById('summ-stock-growth-mini');
                
                if (totalValueV2) {
                    totalValueV2.textContent = '~' + Math.round(projectedTotal).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                }
                if (totalPercentV2) {
                    totalPercentV2.textContent = changeSign + percentageChange.toFixed(1) + '%';
                    totalPercentV2.style.background = percentageChange >= 0 ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';
                    totalPercentV2.style.color = percentageChange >= 0 ? '#10B981' : '#EF4444';
                }
                if (bondIncomeMini) {
                    bondIncomeMini.textContent = '+' + Math.round(totalBondProjectedIncome).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                }
                if (stockGrowthMini) {
                    stockGrowthMini.textContent = '+' + Math.round(totalStockProjectedGrowth).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                }
                
                // Рендерим список облигаций в новый контейнер V2
                const listBondsV2 = document.getElementById('listBondsV2');
                if (listBondsV2) {
                    let bondsHtmlV2 = '';
                    if (bondCalculations.length > 0) {
                        bondCalculations.forEach(b => {
                            const qty = b.qty;
                            const details = bondDetailsMap[b.t] || { matDate:'—', couponValue:0, nextCoupon:'—' };
                            
                            // Форматируем название с цифрами в моноширинном стиле
                            const formattedName = b.n.replace(/(\d+)/g, '<span class="ofz-number">$1</span>');
                            
                            bondsHtmlV2 += `
                            <div class="portfolio-ofz-item" onclick="this.classList.toggle('expanded')">
                                <div class="portfolio-ofz-summary">
                                    <div class="portfolio-ofz-name">${formattedName}</div>
                                    <div class="portfolio-ofz-yield">${b.y}</div>
                                    <div class="portfolio-ofz-qty">${qty}</div>
                                    <div class="portfolio-ofz-sum">${Math.round(qty * b.fullCostPerUnit).toLocaleString()} ₽</div>
                                </div>
                                <div class="portfolio-ofz-details">
                                    <div class="portfolio-ofz-details-grid">
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">Код (ISIN)</span>
                                            <div class="ofz-copy-wrapper" onclick="event.stopPropagation(); copyTickerNew('${b.t}')">
                                                <span class="ofz-copy-code">${b.t}</span>
                                                <svg class="ofz-copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">Текущая цена</span>
                                            <span class="portfolio-ofz-detail-value">${b.p} ₽</span>
                                        </div>
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">НКД</span>
                                            <span class="portfolio-ofz-detail-value">${b.nkd.toFixed(2)} ₽</span>
                                        </div>
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">Итого (цена + НКД)</span>
                                            <span class="portfolio-ofz-detail-value" style="font-weight: 700;">${(b.p + b.nkd).toFixed(2)} ₽</span>
                                        </div>
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">Погашение</span>
                                            <span class="portfolio-ofz-detail-value">${details.matDate}</span>
                                        </div>
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">Размер купона</span>
                                            <span class="portfolio-ofz-detail-value">${details.couponValue} ₽</span>
                                        </div>
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">Ближайший купон</span>
                                            <span class="portfolio-ofz-detail-value">${details.nextCoupon || '—'}</span>
                                        </div>
                                        <div class="portfolio-ofz-detail-row">
                                            <span class="portfolio-ofz-detail-label">Выплат в год</span>
                                            <span class="portfolio-ofz-detail-value">${details.freq || 2}</span>
                                        </div>
                                    </div>
                                    <button class="ofz-aurora-chart-btn" onclick="event.stopPropagation(); openTradingViewDirect('${b.t}')">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                        </svg>
                                        Открыть график
                                    </button>
                                </div>
                            </div>`;
                        });
                    }
                    listBondsV2.innerHTML = bondsHtmlV2;
                    hideSkeletonInstant('skeleton-portfolio-bonds');
                }
                
                // Копируем купонный дождь в новый контейнер
                const couponListV2 = document.getElementById('couponListV2');
                const couponTotalV2 = document.getElementById('couponTotalHeaderV2');
                const couponListOld = document.getElementById('couponList');
                const couponTotalOld = document.getElementById('couponTotalHeader');
                if (couponListV2 && couponListOld) { couponListV2.innerHTML = couponListOld.innerHTML; hideSkeletonInstant('skeleton-coupons'); }
                if (couponTotalV2 && couponTotalOld) couponTotalV2.textContent = couponTotalOld.textContent;
                
                // Рендерим эшелоны в новый контейнер V2
                const echelonContainerV2 = document.getElementById('echelonContainerV2');
                if (echelonContainerV2) {
                    let echelonsHtmlV2 = '';
                    let grandTotalStocks = 0;
                    // Новые названия эшелонов
                    const echelonNames = ['НАДЁЖНЫЙ', 'СТАБИЛЬНЫЙ', 'РИСКОВЫЙ', 'ВЕНЧУРНЫЙ'];
                    // Римские цифры
                    const romanNumerals = ['I', 'II', 'III', 'IV'];
                    const echelonClasses = ['e1', 'e2', 'e3', 'e4'];
                    
                    echelons.forEach((e, idx) => {
                        const echelonBudget = stockBudget * e.weight;
                        const perAssetBudget = e.assets.length > 0 ? echelonBudget / e.assets.length : 0;
                        
                        let stocksInEchelon = e.assets.map(a => {
                            const fullCostPerUnit = a.p * (1 + brokerFee);
                            const qty = fullCostPerUnit > 0 ? Math.floor(perAssetBudget / fullCostPerUnit) : 0;
                            const targetPrice = parseFloat(a.target.replace(/[^\d.]/g,'')) || a.p;
                            const yieldPercent = a.p > 0 ? (((targetPrice - a.p) / a.p) * 100).toFixed(0) : '0';
                            return { ...a, qty, sum: qty * a.p, yieldPercent };
                        });
                        
                        const percent = Math.round(e.weight * 100);

                        // === ВСТАВИТЬ ЭТОТ БЛОК (Подсчет суммы эшелона) ===
                        const echelonTotalSum = stocksInEchelon.reduce((acc, item) => acc + item.sum, 0);
                        grandTotalStocks += echelonTotalSum;
                        // ==================================================
                        
                        echelonsHtmlV2 += `
                        <div class="portfolio-echelon-card" onclick="togglePortfolioEchelon(this, event)">
                            <div class="portfolio-echelon-header">
                                <div class="portfolio-echelon-header-left">
                                    <div class="portfolio-echelon-number ${echelonClasses[idx]}">${romanNumerals[idx]}</div>
                                    <div class="portfolio-echelon-title">${echelonNames[idx]}</div>
                                </div>
                                <div class="portfolio-echelon-header-right">
                                    <span class="portfolio-echelon-sum">${Math.round(echelonBudget).toLocaleString()} ₽</span>
                                    <span class="portfolio-echelon-percent">${percent}%</span>
                                    <svg class="portfolio-echelon-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="portfolio-echelon-content">
                                <div class="portfolio-echelon-columns-header">
                                    <span>ТИКЕР</span>
                                    <span>ЦЕЛЬ</span>
                                    <span>ШТ</span>
                                    <span>РАСХОДЫ</span>
                                </div>
                                <div class="portfolio-echelon-list">
                                    ${stocksInEchelon.map(s => `
                                        <div class="portfolio-stock-wrapper" onclick="event.stopPropagation(); this.classList.toggle('expanded')">
                                            <div class="portfolio-stock-item">
                                                <div class="portfolio-stock-ticker">${s.t}</div>
                                                <div class="portfolio-stock-yield">${s.target.replace(' ₽', '')}</div>
                                                <div class="portfolio-stock-qty">${s.qty}</div>
                                                <div class="portfolio-stock-sum">${Math.round(s.sum).toLocaleString()} ₽</div>
                                            </div>
                                            <div class="portfolio-stock-details">
                                                <div class="portfolio-stock-detail-grid">
                                                    <div class="portfolio-stock-detail-row">
                                                        <span class="portfolio-stock-detail-label">Компания</span>
                                                        <span class="portfolio-stock-detail-value">${s.n || s.t}</span>
                                                    </div>
                                                    <div class="portfolio-stock-detail-row">
                                                        <span class="portfolio-stock-detail-label">Текущая цена</span>
                                                        <span class="portfolio-stock-detail-value">${s.p} ₽</span>
                                                    </div>
                                                    <div class="portfolio-stock-detail-row">
                                                        <span class="portfolio-stock-detail-label">Цель</span>
                                                        <span class="portfolio-stock-detail-value" style="color: #10B981;">${s.target}</span>
                                                    </div>
                                                    <div class="portfolio-stock-detail-row">
                                                        <span class="portfolio-stock-detail-label">Прогноз</span>
                                                        <span class="portfolio-stock-detail-value" style="font-size:10px; color:var(--text-slate);">до 36 мес.</span>
                                                    </div>
                                                </div>
                                                <div class="portfolio-stock-buttons">
                                                    <button class="portfolio-stock-btn chart" onclick="event.stopPropagation(); openTradingViewDirect('${s.t}')">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                                        График
                                                    </button>
                                                    <button class="portfolio-stock-btn info" onclick="event.stopPropagation(); openCompanyInfo('${s.t}')">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                                        О компании
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="portfolio-echelon-total-line">
                               <span class="echelon-total-label">ИТОГО</span>
                               <span class="echelon-total-value">${Math.round(echelonTotalSum).toLocaleString()} ₽</span>
                              </div>
                            </div>
                        </div>`;
                    });
                    
                    echelonContainerV2.innerHTML = echelonsHtmlV2;
                    hideSkeletonInstant('skeleton-portfolio-echelons');
                    // === ВСТАВЛЯЕМ СЮДА (ШАГ 3) ===
const totalStocksRow = document.getElementById('echelonsTotalSum');
const totalStocksPctBadge = document.getElementById('stocksTotalPercent');

if(totalStocksRow) {
    // Выводим сумму
    totalStocksRow.innerText = Math.round(grandTotalStocks).toLocaleString() + ' ₽';

    // Считаем процент
    if(totalStocksPctBadge && typeof stockBudget !== 'undefined' && stockBudget > 0) {
        const percent = (grandTotalStocks / stockBudget) * 100;
        
        // Если больше 99.9%, но меньше 100% (из-за копеек), ставим 100%
        // Иначе показываем 1 знак после запятой
        if (percent > 99.9 && percent < 100.1) {
             totalStocksPctBadge.innerText = '100%';
        } else {
             totalStocksPctBadge.innerText = percent.toFixed(1) + '%';
        }
    }
}
// =============================
                }
            }
            
            updateEchelonTable();
            renderOfzList();
            
            // Сохраняем данные для списка к покупке
            window._shoppingListData = { bonds: [], stocks: [] };
            if (bondCalculations.length > 0) {
                bondCalculations.forEach(b => {
                    if (b.qty > 0) window._shoppingListData.bonds.push({ ticker: b.t, name: b.n, qty: b.qty, price: b.p, sum: Math.round(b.qty * b.fullCostPerUnit) });
                });
            }
            echelons.forEach((e, idx) => {
                const eBudget = stockBudget * e.weight;
                const perA = e.assets.length > 0 ? eBudget / e.assets.length : 0;
                let calcs = e.assets.map(a => {
                    const fc = a.p * (1 + brokerFee);
                    return { ...a, qty: fc > 0 ? Math.floor(perA / fc) : 0, fc };
                });
                let left = eBudget - calcs.reduce((acc, s) => acc + (s.qty * s.fc), 0);
                if (calcs.length > 0 && left >= calcs[0].fc && calcs[0].fc > 0) calcs[0].qty += Math.floor(left / calcs[0].fc);
                calcs.forEach(s => {
                    if (s.qty > 0) window._shoppingListData.stocks.push({ ticker: s.t, name: s.n, qty: s.qty, price: s.p, sum: Math.round(s.qty * s.p), echelon: idx + 1 });
                });
            });
        } // Закрытие функции draw

/* =================================================================
   PORTFOLIO V2 - ФУНКЦИИ ПЕРЕКЛЮЧЕНИЯ
   ================================================================= */

// Переключение страниц К ПОКУПКЕ / МОИ АКТИВЫ
function switchPortfolioPage(page) {
    // Обновляем кнопки
    document.querySelectorAll('.portfolio-page-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === page);
    });
    
    // Скрываем/показываем страницы
    document.querySelectorAll('.portfolio-page-content').forEach(content => {
        content.classList.remove('active');
    });
    
    const targetPage = document.getElementById(`portfolio-page-${page}`);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    
    // Показываем action panel только на странице "К покупке"
    const actionPanel = document.getElementById('portfolioActionPanelV2');
    if (actionPanel) {
        actionPanel.style.display = (page === 'buy') ? 'flex' : 'none';
    }
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Переключение вкладок Денежный поток / Растущая часть
function switchPortfolioContentTab(tab) {
    const switcher = document.getElementById('portfolioTabSwitcher');
    if (!switcher) return;
    
    // Обновляем кнопки
    document.querySelectorAll('#portfolioTabSwitcher .portfolio-tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    // Двигаем глайдер
    if (tab === 'stocks') {
        switcher.classList.add('show-stocks');
    } else {
        switcher.classList.remove('show-stocks');
    }
    
    // Скрываем/показываем контент
    document.querySelectorAll('.portfolio-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    const targetTab = document.getElementById(`portfolio-tab-${tab}`);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }
}

// Раскрытие купонного дождя с вибрацией
function toggleCouponRain(element) {
    const card = element.parentElement;
    card.classList.toggle('open');
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Новый расчёт с вибрацией - переход на вкладку Расчёт
function newCalculationWithHaptic() {
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
    showScreen('screen-app');
}

// Поделиться с вибрацией
function shareWithHaptic() {
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
    shareAsPDF();
}

// === Обработчик кнопок с подтверждением (показ названия → второй тап = действие) ===
let _activeActionWrapper = null;

function handleActionBtn(btn, actionFn) {
    const wrapper = btn.closest('.portfolio-action-wrapper');
    
    // Вибрация при нажатии
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.selectionChanged();
    }
    
    // Если эта кнопка уже активна — выполняем действие
    if (wrapper.classList.contains('show-label')) {
        closeAllActionLabels();
        actionFn();
        return;
    }
    
    // Иначе — показываем название, скрываем остальные
    closeAllActionLabels();
    wrapper.classList.add('show-label');
    btn.classList.add('active-hint');
    _activeActionWrapper = wrapper;
    
    // Закрытие при тапе вне кнопки
    setTimeout(() => {
        document.addEventListener('click', _closeActionLabelsOnOutsideClick, { once: true });
    }, 10);
}

function closeAllActionLabels() {
    document.querySelectorAll('.portfolio-action-wrapper.show-label').forEach(w => {
        w.classList.remove('show-label');
        w.querySelector('.portfolio-action-icon-btn')?.classList.remove('active-hint');
    });
    _activeActionWrapper = null;
}

function _closeActionLabelsOnOutsideClick(e) {
    if (_activeActionWrapper && !_activeActionWrapper.contains(e.target)) {
        closeAllActionLabels();
    } else if (_activeActionWrapper) {
        // Если кликнули внутри — переставляем слушатель
        setTimeout(() => {
            document.addEventListener('click', _closeActionLabelsOnOutsideClick, { once: true });
        }, 10);
    }
}

// Выпадающее меню портфеля (три точки)
function togglePortfolioMenu(e) {
    e.stopPropagation();
    const menu = document.getElementById('portfolioDropdownMenu');
    if (menu) {
        menu.classList.toggle('open');
        if (menu.classList.contains('open')) {
            // Закрытие при клике вне меню
            setTimeout(() => {
                document.addEventListener('click', closePortfolioMenuOnClick, { once: true });
            }, 10);
        }
    }
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

function closePortfolioMenu() {
    const menu = document.getElementById('portfolioDropdownMenu');
    if (menu) menu.classList.remove('open');
}

function closePortfolioMenuOnClick(e) {
    const menu = document.getElementById('portfolioDropdownMenu');
    const btn = document.getElementById('portfolioDotsBtn');
    if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('open');
    }
}

// === ТЕРМИНАЛ (Список к покупке) ===
let _slTotalSum = 0;
let _slExecutedSum = 0;

function openShoppingList() {
    const overlay = document.getElementById('shoppingListOverlay');
    const body = document.getElementById('shoppingListBody');
    if (!overlay || !body) return;
    
    const data = window._shoppingListData;
    if (!data || (data.bonds.length === 0 && data.stocks.length === 0)) {
        body.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#64748B;font-size:14px;">Сначала рассчитайте портфель</div>';
        overlay.style.display = 'flex';
        return;
    }
    
    const roman = ['I','II','III','IV'];
    const svgCheck = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;"><polyline points="20 6 9 17 4 12"/></svg>';
    
    let html = '';
    _slTotalSum = 0;
    _slExecutedSum = 0;
    
    // Облигации
    if (data.bonds.length > 0) {
        const bondsTotal = data.bonds.reduce((a, b) => a + b.sum, 0);
        _slTotalSum += bondsTotal;
        
        html += `<div class="sl-section-label">Облигации / OFZ</div>`;
        html += `<div class="sl-card-group">`;
        data.bonds.forEach(b => {
            html += `
            <div class="sl-item" data-sum="${b.sum}" onclick="toggleShopItem(this)">
                <div class="sl-checkbox"></div>
                <div class="sl-info">
                    <div class="sl-info-top">
                        <span class="sl-badge sl-badge-ofz">OFZ</span>
                        <span class="sl-ticker">${b.ticker}</span>
                    </div>
                    <div class="sl-name">${b.name}</div>
                </div>
                <div class="sl-right">
                    <div class="sl-qty">${b.qty} шт</div>
                    <div class="sl-sum">${b.sum.toLocaleString('ru-RU')} ₽</div>
                </div>
            </div>`;
        });
        html += `<div class="sl-group-total">
            <span class="sl-group-total-label">Итого ОФЗ</span>
            <span class="sl-group-total-value">${bondsTotal.toLocaleString('ru-RU')} ₽</span>
        </div></div>`;
    }
    
    // Акции
    if (data.stocks.length > 0) {
        const stocksTotal = data.stocks.reduce((a, s) => a + s.sum, 0);
        _slTotalSum += stocksTotal;
        
        html += `<div class="sl-section-label">Акции / Stocks</div>`;
        html += `<div class="sl-card-group">`;
        data.stocks.forEach(s => {
            const tier = s.echelon || 1;
            const badgeClass = tier <= 3 ? `sl-badge-t${tier}` : 'sl-badge-t3';
            html += `
            <div class="sl-item" data-sum="${s.sum}" onclick="toggleShopItem(this)">
                <div class="sl-checkbox"></div>
                <div class="sl-info">
                    <div class="sl-info-top">
                        <span class="sl-badge ${badgeClass}">${roman[tier-1]}</span>
                        <span class="sl-ticker">${s.ticker}</span>
                    </div>
                    <div class="sl-name">${s.name}</div>
                </div>
                <div class="sl-right">
                    <div class="sl-qty">${s.qty} шт</div>
                    <div class="sl-sum">${s.sum.toLocaleString('ru-RU')} ₽</div>
                </div>
            </div>`;
        });
        html += `<div class="sl-group-total">
            <span class="sl-group-total-label">Итого Акции</span>
            <span class="sl-group-total-value">${stocksTotal.toLocaleString('ru-RU')} ₽</span>
        </div></div>`;
    }
    
    body.innerHTML = html;
    overlay.style.display = 'flex';
    updateSlFooter();
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

function toggleShopItem(row) {
    const checkbox = row.querySelector('.sl-checkbox');
    if (!checkbox) return;
    const sum = parseFloat(row.dataset.sum) || 0;
    const isFilled = row.classList.contains('filled');
    
    if (isFilled) {
        row.classList.remove('filled');
        checkbox.innerHTML = '';
        _slExecutedSum -= sum;
    } else {
        row.classList.add('filled');
        checkbox.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;"><polyline points="20 6 9 17 4 12"/></svg>';
        _slExecutedSum += sum;
    }
    
    _slExecutedSum = Math.max(0, _slExecutedSum);
    updateSlFooter();
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    } else if (navigator.vibrate) {
        navigator.vibrate(10);
    }
}

function updateSlFooter() {
    const remaining = _slTotalSum - _slExecutedSum;
    const percent = _slTotalSum > 0 ? Math.round((_slExecutedSum / _slTotalSum) * 100) : 0;
    
    const elRemaining = document.getElementById('slRemaining');
    const elPlan = document.getElementById('slPlan');
    const elBar = document.getElementById('slProgressBar');
    const elLabel = document.getElementById('slProgressLabel');
    
    if (elRemaining) elRemaining.textContent = remaining.toLocaleString('ru-RU') + ' ₽';
    if (elPlan) elPlan.textContent = _slTotalSum.toLocaleString('ru-RU') + ' ₽';
    if (elBar) elBar.style.width = percent + '%';
    if (elLabel) elLabel.textContent = percent + '%';
}

function closeShoppingList() {
    const overlay = document.getElementById('shoppingListOverlay');
    if (overlay) overlay.style.display = 'none';
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

function copyShoppingList() {
    const data = window._shoppingListData;
    if (!data) return;
    
    const roman = ['I','II','III','IV'];
    let text = '📋 ПЛАН ПОКУПОК:\n\n';
    
    // Собираем статусы из DOM
    const items = document.querySelectorAll('.sl-item');
    let idx = 0;
    
    if (data.bonds.length > 0) {
        data.bonds.forEach(b => {
            const filled = items[idx] && items[idx].classList.contains('filled');
            text += `${filled ? '✅' : '⚪️'} ${b.ticker} — ${b.qty} шт\n`;
            idx++;
        });
    }
    
    if (data.stocks.length > 0) {
        data.stocks.forEach(s => {
            const filled = items[idx] && items[idx].classList.contains('filled');
            text += `${filled ? '✅' : '⚪️'} ${s.ticker} — ${s.qty} шт\n`;
            idx++;
        });
    }
    
    text += `\n💰 Всего к исполнению: ${_slTotalSum.toLocaleString('ru-RU')} ₽`;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('slToast');
            if (toast) {
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }
        });
    }
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}

// Переключение раскрытия эшелона
function togglePortfolioEchelon(card, event) {
    // Не раскрываем если клик был по stock-wrapper
    if (event.target.closest('.portfolio-stock-wrapper')) return;
    
    card.classList.toggle('expanded');
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Переключение информации об эшелонах
function togglePortfolioEchelonsInfo() {
    const card = document.getElementById('portfolioEchelonsExplainer');
    if (card) {
        card.classList.toggle('open');
    }
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Переключение подсказки для % в ОФЗ
function toggleYieldHelp() {
    const tooltip = document.getElementById('yieldHelpTooltip');
    if (tooltip) {
        tooltip.classList.toggle('show');
    }
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

/* --- Правильная функция для % Эшелонов --- */
function toggleEchelonPercentHelp(event) {
    // Если передали событие (клик), останавливаем его всплытие, 
    // чтобы не срабатывали другие клики на странице (если они есть)
    if (event) event.stopPropagation();

    // Мы ищем элемент именно с ID "echelonPercentTooltip", как в вашем HTML
    const tooltip = document.getElementById('echelonPercentTooltip');
    
    if (tooltip) {
        // Переключаем класс (убедитесь, что в CSS есть .echelon-percent-tooltip.show)
        tooltip.classList.toggle('show');
    } else {
        console.error('Ошибка: Не найден блок с id="echelonPercentTooltip"');
    }

    // Вибрация
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}
    
// Открыть информацию о компании
function openCompanyInfo(ticker) {
    // Открываем на SmartLab
    window.open(`https://smart-lab.ru/q/${ticker}/`, '_blank');
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Синхронизация данных между старым и новым UI
function syncPortfolioDataToV2() {
    // Синхронизируем распределение из слайдера
    const slider = document.getElementById('ratioSlider');
    if (slider) {
        const bondPercent = parseInt(slider.value);
        const stockPercent = 100 - bondPercent;
        
        // Обновляем новый прогресс-бар
        const stockBar = document.getElementById('bar-stock-fill-v2');
        const bondBar = document.getElementById('bar-bond-fill-v2');
        if (stockBar) stockBar.style.width = stockPercent + '%';
        if (bondBar) bondBar.style.width = bondPercent + '%';
        
        // Обновляем лейблы
        const stockPct = document.getElementById('srl-stock-pct-v2');
        const bondPct = document.getElementById('srl-bond-pct-v2');
        if (stockPct) stockPct.textContent = stockPercent + '%';
        if (bondPct) bondPct.textContent = bondPercent + '%';
    }
    
    // Синхронизируем прогноз
    const total3y = document.getElementById('summ-total-3y');
    if (total3y) {
        // Обновляем компактный прогноз с процентами
        const totalText = total3y.textContent || total3y.innerText;
    }
    
    // Копируем список купонов в новый контейнер
    const oldCouponList = document.getElementById('couponList');
    const newCouponList = document.getElementById('couponListV2');
    if (oldCouponList && newCouponList) {
        newCouponList.innerHTML = oldCouponList.innerHTML;
    }
    
    const oldCouponTotal = document.getElementById('couponTotalHeader');
    const newCouponTotal = document.getElementById('couponTotalHeaderV2');
    if (oldCouponTotal && newCouponTotal) {
        newCouponTotal.textContent = oldCouponTotal.textContent;
    }
}


        async function shareAsPDF() {
            let btn = document.getElementById('btnShare');
            if (!btn) btn = document.querySelector('.portfolio-action-btn.primary');
            const container = document.getElementById('shareContainer');
            const brand = document.getElementById('shareBrand'); 
            const dateEl = document.getElementById('shareDate');
            if (!container) { console.error('Required elements not found for PDF'); return; }
            
            const originalText = btn ? btn.innerHTML : '';
            if (btn) { btn.innerHTML = "⏳ Генерация..."; btn.disabled = true; }
            if (brand) brand.style.display = 'block'; 
            if (dateEl) dateEl.innerText = new Date().toLocaleString();
            container.classList.add('sharing-mode');
            
            try {
                const { jsPDF } = window.jspdf;
                
                // 1. Рендерим карточку капитала
                const canvas1 = await html2canvas(container, { backgroundColor: '#0f172a', scale: 2, logging: false, useCORS: true });
                
                // 2. Рендерим список к покупке через временный DOM элемент
                const shopData = window._shoppingListData;
                const hasShopData = shopData && (shopData.bonds.length > 0 || shopData.stocks.length > 0);
                let canvas2 = null;
                
                if (hasShopData) {
                    const roman = ['I','II','III','IV'];
                    const badgeColors = {1:'#2ecc71', 2:'#3498db', 3:'#f1c40f', 4:'#e74c3c'};
                    
                    let shopHtml = `
                        <div style="padding:24px;font-family:'Inter',system-ui,sans-serif;">
                            <div style="text-align:center;font-size:16px;font-weight:800;color:#F1F5F9;margin-bottom:20px;letter-spacing:0.08em;">СПИСОК К ПОКУПКЕ</div>
                            <div style="border-top:1px solid rgba(255,255,255,0.15);margin-bottom:16px;"></div>
                    `;
                    
                    if (shopData.bonds.length > 0) {
                        let bondsTotal = 0;
                        shopHtml += `<div style="font-size:10px;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px;">Облигации (ОФЗ)</div>`;
                        shopData.bonds.forEach(b => {
                            bondsTotal += b.sum;
                            shopHtml += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
                                <span style="font-weight:700;color:#F1F5F9;font-size:13px;">${b.ticker}</span>
                                <div style="display:flex;gap:16px;align-items:center;">
                                    <span style="color:#10B981;font-weight:600;font-size:12px;">${b.qty} шт</span>
                                    <span style="color:#94A3B8;font-size:12px;min-width:80px;text-align:right;">${b.sum.toLocaleString('ru-RU')} ₽</span>
                                </div>
                            </div>`;
                        });
                        shopHtml += `<div style="display:flex;justify-content:space-between;padding:10px 0 16px;border-top:1px solid rgba(255,255,255,0.1);margin-top:4px;">
                            <span style="font-size:11px;font-weight:600;color:#64748B;">Итого ОФЗ</span>
                            <span style="font-size:13px;font-weight:700;color:#F1F5F9;">${bondsTotal.toLocaleString('ru-RU')} ₽</span>
                        </div>`;
                    }
                    
                    if (shopData.stocks.length > 0) {
                        let stocksTotal = 0;
                        shopHtml += `<div style="font-size:10px;font-weight:700;color:#64748B;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px;">Акции</div>`;
                        shopData.stocks.forEach(s => {
                            stocksTotal += s.sum;
                            shopHtml += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:${badgeColors[s.echelon]}30;color:${badgeColors[s.echelon]};">${roman[s.echelon-1]}</span>
                                    <span style="font-weight:700;color:#F1F5F9;font-size:13px;">${s.ticker}</span>
                                </div>
                                <div style="display:flex;gap:16px;align-items:center;">
                                    <span style="color:#10B981;font-weight:600;font-size:12px;">${s.qty} шт</span>
                                    <span style="color:#94A3B8;font-size:12px;min-width:80px;text-align:right;">${s.sum.toLocaleString('ru-RU')} ₽</span>
                                </div>
                            </div>`;
                        });
                        shopHtml += `<div style="display:flex;justify-content:space-between;padding:10px 0 16px;border-top:1px solid rgba(255,255,255,0.1);margin-top:4px;">
                            <span style="font-size:11px;font-weight:600;color:#64748B;">Итого Акции</span>
                            <span style="font-size:13px;font-weight:700;color:#F1F5F9;">${stocksTotal.toLocaleString('ru-RU')} ₽</span>
                        </div>`;
                    }
                    
                    const grandTotal = shopData.bonds.reduce((a,b) => a + b.sum, 0) + shopData.stocks.reduce((a,s) => a + s.sum, 0);
                    shopHtml += `<div style="display:flex;justify-content:space-between;padding:14px 16px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.15);border-radius:12px;margin-top:8px;">
                        <span style="font-size:12px;font-weight:700;color:#10B981;">ВСЕГО К ПОКУПКЕ</span>
                        <span style="font-size:16px;font-weight:800;color:#10B981;">${grandTotal.toLocaleString('ru-RU')} ₽</span>
                    </div>`;
                    
                    shopHtml += `<div style="text-align:center;padding-top:20px;">
                        <div style="font-size:14px;font-weight:700;color:#D97757;">Madame Solomi'na Portfolio</div>
                        <div style="font-size:9px;color:#64748B;margin-top:4px;">${new Date().toLocaleString()}</div>
                    </div></div>`;
                    
                    // Создаем временный элемент
                    const tempDiv = document.createElement('div');
                    tempDiv.style.cssText = `position:fixed;left:-9999px;top:0;width:${canvas1.width / 2}px;background:#0f172a;`;
                    tempDiv.innerHTML = shopHtml;
                    document.body.appendChild(tempDiv);
                    
                    canvas2 = await html2canvas(tempDiv, { backgroundColor: '#0f172a', scale: 2, logging: false });
                    document.body.removeChild(tempDiv);
                }
                
                // Собираем PDF
                const pageWidth = canvas1.width;
                let totalHeight = canvas1.height;
                if (canvas2) totalHeight += canvas2.height + 30;
                
                const doc = new jsPDF({ orientation: 'p', unit: 'px', format: [pageWidth, totalHeight] });
                doc.setFillColor(15, 23, 42);
                doc.rect(0, 0, pageWidth, totalHeight, 'F');
                
                let yPos = 0;
                doc.addImage(canvas1.toDataURL('image/png'), 'PNG', 0, yPos, canvas1.width, canvas1.height);
                yPos += canvas1.height + 30;
                
                if (canvas2) {
                    const scale2 = pageWidth / canvas2.width;
                    doc.addImage(canvas2.toDataURL('image/png'), 'PNG', 0, yPos, canvas2.width * scale2, canvas2.height * scale2);
                }

                const pdfBlob = doc.output('blob');
                const pdfFile = new File([pdfBlob], "Madame_Solomina_Portfolio.pdf", { type: "application/pdf" });

                if (navigator.share && navigator.canShare) {
                    try {
                        if (navigator.canShare({ files: [pdfFile] })) {
                            await navigator.share({ files: [pdfFile], title: 'Мой портфель', text: 'Расчёт от Madame Solomi\'na' });
                            if (btn) { btn.innerHTML = originalText; btn.disabled = false; }
                            if (brand) brand.style.display = 'none'; container.classList.remove('sharing-mode'); return;
                        }
                    } catch(shareErr) { console.log('Web Share cancelled or failed:', shareErr); }
                }

                const blobUrl = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a'); a.href = blobUrl; a.download = 'Madame_Solomina_Portfolio.pdf';
                a.style.display = 'none'; document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(blobUrl); }, 1000);
                if (btn) { btn.innerHTML = '✅ PDF скачан'; setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000); }
            } catch(e) {
                console.error(e); alert("Не удалось создать PDF: " + e.message);
                if (btn) { btn.innerHTML = originalText; btn.disabled = false; }
            } finally { if (brand) brand.style.display = 'none'; container.classList.remove('sharing-mode'); }
        }
    function resetAndGoToTerminal() {
    // Сбрасываем поле ввода суммы
    const sumInput = document.getElementById('sumInput');
    if (sumInput) {
        sumInput.value = '';
    }
    
    // Скрываем символ рубля
    const currencySymbol = document.getElementById('currencySymbol');
    if (currencySymbol) {
        currencySymbol.style.display = 'none';
    }
    
    // Сбрасываем стратегию на Гармонию 50/50
    document.getElementById('ratioSlider').value = 50;
    
    // Убираем selected со всех карточек
    document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('selected'));
    
    // Выбираем Гармонию
    const harmonyCard = document.querySelector('.strategy-card[data-bonds="50"]');
    if (harmonyCard) {
        harmonyCard.classList.add('selected');
    }
    
    // Сбрасываем кастомную стратегию
    resetCustomCardDisplay();
    
    // Скрываем скрытые карточки стратегий
    const hiddenCards = document.getElementById('strategyCardsHidden');
    const trigger = document.getElementById('strategyExpandTrigger');
    if (hiddenCards) hiddenCards.classList.remove('show');
    if (trigger) {
        trigger.classList.remove('open');
        const textEl = trigger.querySelector('.strategy-expand-text');
        if (textEl) textEl.textContent = 'Другие стратегии';
    }
    
    // Скрываем контент портфеля
    document.getElementById('portfolio-content').style.display = 'none';
    document.getElementById('portfolio-empty').style.display = 'flex';
    document.getElementById('portfolioActionPanel').style.display = 'none';
    
    // Скрываем 3 иконки действий
    const actionBtns = document.getElementById('portfolioActionBtns');
    if(actionBtns) actionBtns.style.display = 'none';
    
    isPortfolioCalculated = false;
    
    // Переходим на экран терминала
    showScreen('screen-app');
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}

    // Регистрация Service Worker для PWA
        if ('serviceWorker' in navigator && location.protocol === 'https:') {
    navigator.serviceWorker.register('./service-worker.js')
        .then(function(registration) {
            console.log('Service Worker зарегистрирован:', registration);
        })
        .catch(function(error) {
            console.log('Ошибка регистрации Service Worker:', error);
        });
} else {
    console.log('Service Worker not registered: not HTTPS or not supported');
}

             // Показываем навигацию принудительно для отладки
             document.getElementById('navWrapper').style.display = 'flex';
        loadData(); 
        if(window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            
            // Сообщаем Telegram что приложение готово
            tg.ready();
            
            // Раскрываем на максимальную высоту
            tg.expand();
            
            // Отключаем свайп вниз для закрытия приложения
            tg.disableVerticalSwipes();
            
            // Запрашиваем полноэкранный режим (Telegram Bot API 7.7+)
            if (tg.requestFullscreen) {
                tg.requestFullscreen();
            }
            
            // Блокируем сворачивание приложения (Telegram Bot API 7.7+)
            if (tg.lockOrientation) {
                tg.lockOrientation();
            }
            
            // Устанавливаем цвет хедера в цвет фона для бесшовности
            if (tg.setHeaderColor) {
                tg.setHeaderColor('#F3F4F6');
            }
            
            // Устанавливаем цвет нижней панели
            if (tg.setBackgroundColor) {
                tg.setBackgroundColor('#F3F4F6');
            }
            
            // Скрываем кнопку "Назад" в хедере Telegram если она не нужна
            if (tg.BackButton) {
                tg.BackButton.hide();
            }
            
            // Повторный вызов expand через небольшую задержку (на случай если первый не сработал)
            setTimeout(() => {
                tg.expand();
                if (tg.requestFullscreen) {
                    tg.requestFullscreen();
                }
            }, 100);
            
            // И ещё раз для надёжности
            setTimeout(() => {
                tg.expand();
            }, 500);
        }

        // NEW: Скрыть sticky панель при начальной загрузке если не на screen-app
        setTimeout(() => {
            const stickyPanel = document.getElementById('stickyPanel');
            if (stickyPanel && currentScreen !== 'screen-app') {
                stickyPanel.style.display = 'none';
            }
        }, 100);
 
      /* =================================================================
   SWIPE TO DISMISS (С БЛОКИРОВКОЙ СКРОЛЛА СТРАНИЦЫ)
   ================================================================= */
function initNotificationSwipe() {
    const notify = document.getElementById('luxuryNotification');
    if (!notify) return;

    let startY = 0;
    let diffY = 0;

    // 1. Начало касания
    notify.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
        diffY = 0;
        // Отключаем плавность для мгновенного отклика
        notify.style.transition = 'none';
    }, { passive: false }); // Важно: passive: false

    // 2. Движение пальца
    notify.addEventListener('touchmove', (e) => {
        // === ГЛАВНОЕ ИЗМЕНЕНИЕ ===
        // Запрещаем странице прокручиваться, пока тянем уведомление
        if (e.cancelable) e.preventDefault(); 
        
        const currentY = e.touches[0].clientY;
        diffY = currentY - startY;

        // Разрешаем двигать ТОЛЬКО вверх
        if (diffY < 0) {
            // 60px - это ваш отступ сверху (из CSS)
            notify.style.transform = `translate(-50%, calc(env(safe-area-inset-top) + 60px + ${diffY}px))`;
        }
    }, { passive: false }); // Важно: passive: false разрешает preventDefault

    // 3. Конец касания
    notify.addEventListener('touchend', () => {
        // Возвращаем плавную анимацию
        notify.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
        
        // Сбрасываем инлайн-стиль (возвращаем управление CSS)
        notify.style.transform = ''; 

        // Если смахнули вверх более чем на 10 пикселей - скрываем
        if (diffY < -10) {
            notify.classList.remove('show');
            // Легкая вибрация
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        }
        
        startY = 0;
        diffY = 0;
    });
}

initNotificationSwipe();

   /* =================================================================
   HEAVY 3D SWIPE + SCROLL LOCK + PARALLAX
   ================================================================= */

/* =================================================================
   ULTIMATE SWIPE: HEAVY PHYSICS + 3D + SHEEN + PARALLAX
   ================================================================= */

function initSwipeBack() {
    let startX = 0;
    let startY = 0;
    let isDragging = false;
    let isAxisLocked = false; 
    let _swipePrevScreen = null;
    let _swipeActiveScreen = null;
    
    const container = document.getElementById('swipeBackIndicator');
    const lens = container.querySelector('.ls-lens');
    const arrow = container.querySelector('.ls-arrow');
    const triggerZone = 35; 
    
    function getBackTarget() {
        const home = window._isRegistered ? 'screen-dashboard' : 'screen-home';
        if (currentScreen === 'screen-home') return null;
        if (currentScreen === 'screen-dashboard') return null;
        if (currentScreen === 'screen-register') return 'screen-home';
        if (currentScreen === 'screen-company') return 'screen-interesting';
        if (currentScreen === 'screen-app') return home;
        if (currentScreen === 'screen-interesting') return home;
        if (currentScreen === 'screen-portfolio') return home;
        if (currentScreen === 'screen-assets') return home;
        if (currentScreen === 'screen-stub') return home;
        return home; 
    }

    // 1. TOUCH START
    document.addEventListener('touchstart', (e) => {
        isDragging = false;
        isAxisLocked = false;
        _swipePrevScreen = null;
        _swipeActiveScreen = null;
        if (!getBackTarget()) return;

        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        
        if (startX <= triggerZone) {
            isDragging = true;
        }
    }, { passive: false });

    // 2. TOUCH MOVE
    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;

        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;
        const deltaX = x - startX;
        const deltaY = Math.abs(y - startY);

        if (!isAxisLocked) {
            if (deltaY > Math.abs(deltaX)) {
                isDragging = false;
                return; 
            } else if (Math.abs(deltaX) > 5) {
                isAxisLocked = true;
                
                // === МГНОВЕННО: скрываем текущий, показываем предыдущий ===
                const targetId = getBackTarget();
                if (targetId) {
                    _swipeActiveScreen = document.querySelector('.screen.active');
                    _swipePrevScreen = document.getElementById(targetId);
                    
                    if (_swipePrevScreen && _swipeActiveScreen) {
                        // Предыдущий экран — показываем полностью
                        _swipePrevScreen.classList.add('swipe-prev');
                        // Текущий экран — мгновенно прячем
                        _swipeActiveScreen.style.opacity = '0';
                        _swipeActiveScreen.style.pointerEvents = 'none';
                    }
                }
                
                // Линза — сразу показываем
                lens.style.transition = 'none';
                lens.style.transform = 'translateX(0)';
                lens.style.opacity = '1';
                arrow.style.transform = 'scale(1.2)';
                
                // Вибрация при начале
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.selectionChanged();
                }
            }
        }

        if (isAxisLocked && e.cancelable) e.preventDefault();
        
        // Обновляем линзу по ходу свайпа
        if (isAxisLocked && deltaX > 0) {
            const progress = Math.min(deltaX / 120, 1);
            arrow.style.transform = `scale(${1 + progress * 0.3})`;
            
            // При достижении порога — усиленная вибрация
            if (progress >= 1 && !container.dataset.vibrated) {
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }
                container.dataset.vibrated = "true";
                arrow.style.strokeWidth = "3";
            } else if (progress < 1) {
                container.dataset.vibrated = "";
                arrow.style.strokeWidth = "2";
            }
        }
    }, { passive: false });

    // 3. TOUCH END
    document.addEventListener('touchend', (e) => {
        if (!isDragging || !isAxisLocked) {
            cleanupSwipe();
            return;
        }
        
        isDragging = false;
        isAxisLocked = false;

        const endX = e.changedTouches[0].clientX;
        const deltaX = endX - startX;
        const threshold = 80; 

        // Прячем линзу
        lens.style.transition = 'transform 0.25s ease, opacity 0.25s ease';
        lens.style.transform = 'translateX(-100%)';
        lens.style.opacity = '0';

        if (deltaX > threshold && _swipeActiveScreen && _swipePrevScreen) {
            // === УСПЕХ: переходим на предыдущую страницу ===
            const prevScreen = _swipePrevScreen;
            const activeScreen = _swipeActiveScreen;
            const targetId = getBackTarget();
            
            // Убираем текущий
            activeScreen.style.opacity = '';
            activeScreen.style.pointerEvents = '';
            
            const targetEl = document.getElementById(targetId);
            if (targetEl) targetEl.classList.add('no-animate');
            if (prevScreen) prevScreen.classList.remove('swipe-prev');
            
            window._swipeNavigation = true;
            showScreen(targetId);
            window._swipeNavigation = false;
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if (targetEl) targetEl.classList.remove('no-animate');
                });
            });
            
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            }
            
        } else {
            // === ОТМЕНА: возвращаем текущий экран ===
            if (_swipeActiveScreen) {
                _swipeActiveScreen.style.transition = 'opacity 0.2s ease';
                _swipeActiveScreen.style.opacity = '1';
                _swipeActiveScreen.style.pointerEvents = '';
                
                const activeScreen = _swipeActiveScreen;
                setTimeout(() => {
                    activeScreen.style.transition = '';
                    activeScreen.style.opacity = '';
                }, 200);
            }
            if (_swipePrevScreen) {
                _swipePrevScreen.classList.remove('swipe-prev');
            }
        }
        
        _swipePrevScreen = null;
        _swipeActiveScreen = null;
        container.dataset.vibrated = "";
    });

    function cleanupSwipe() {
        if (_swipePrevScreen) _swipePrevScreen.classList.remove('swipe-prev');
        if (_swipeActiveScreen) {
            _swipeActiveScreen.style.opacity = '';
            _swipeActiveScreen.style.pointerEvents = '';
            _swipeActiveScreen.style.transition = '';
        }
        lens.style.transition = 'transform 0.2s ease, opacity 0.2s ease';
        lens.style.transform = 'translateX(-100%)';
        lens.style.opacity = '0';
        _swipePrevScreen = null;
        _swipeActiveScreen = null;
        isDragging = false;
        isAxisLocked = false;
    }
}

initSwipeBack();


/* === ФИНАЛ: ВАШИ СТИЛИ (Aurora Yellow + Marker) === */
/* === ФИНАЛ: Стиль "Silver Aurora" (Серебряное стекло) === */
 /* === FINAL: "Silver Aurora" Style === */
 function toggleEchelonGuide(show, context = 'rebalance') {
            let oldModal = document.getElementById('rebalance-info-modal');
            if (oldModal && show) oldModal.remove(); 

            let modal = document.getElementById('rebalance-info-modal');

            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'rebalance-info-modal';
                
                modal.innerHTML = `
                    <div class="info-modal-content" onclick="event.stopPropagation()">
                        <div class="info-modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                            <h3 style="margin:0; color:#0F172A; font-size:20px; font-weight:800; font-family:'Inter', sans-serif;">Стратегия Эшелонов</h3>
                            <button onclick="toggleEchelonGuide(false)" style="background:none; border:none; color:#94a3b8; font-size:28px; cursor:pointer; transition: color 0.2s;">×</button>
                        </div>
                        <div class="info-scroll-area">
                            <div style="display:flex; flex-direction:column; gap:12px;">
                                ${createEchelonItem('I', 'Надёжный', 'Компании, которые платят дивиденды и стараются их повышать', 'e1')}
                                ${createEchelonItem('II', 'Стабильный', 'Компании, которые платят дивиденды, но выплаты разнятся', 'e2')}
                                ${createEchelonItem('III', 'Рисковый', 'Компании, которые могут платить, но не платят, так как предпочитают реинвестировать средства в рост', 'e3')}
                                ${createEchelonItem('IV', 'Венчурный', 'Компании, которые не платят дивидендов, но имеют большой потенциал', 'e4')}
                            </div>
                            
                            <!-- Bottom Block -->
                            <div id="info-dynamic-footer"></div>
                        </div>
                    </div>
                `;

                // Backdrop styles
                Object.assign(modal.style, {
                    position: 'fixed', top: '0', left: '0', width: '100%', height: '100%',
                    zIndex: '9999999', display: 'flex', alignItems: 'flex-end', justifyContent: 'center',
                    background: 'rgba(0,0,0,0.7)', backdropFilter: 'blur(8px)', webkitBackdropFilter: 'blur(8px)',
                    opacity: '0', transition: 'opacity 0.3s ease', pointerEvents: 'none'
                });
                document.body.appendChild(modal);

                // CSS styles injection - AURORA DESIGN (как главная страница)
                if (!document.getElementById('base-modal-styles')) {
                    const style = document.createElement('style');
                    style.id = 'base-modal-styles';
                    style.innerHTML = `
                        /* Aurora Modal Background - стиль главной страницы */
                        .info-modal-content { 
                            width: 100%; 
                            max-width: 500px; 
                            /* Aurora gradient background */
                            background: linear-gradient(180deg, #F3F4F6 0%, #F9FAFC 100%);
                            border-radius: 28px 28px 0 0; 
                            padding: 28px; 
                            padding-bottom: 40px; 
                            transform: translateY(100%); 
                            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
                            color: #0F172A; /* Dark text for light bg */
                            border-top: 1px solid rgba(255,255,255,0.8);
                            max-height: 85vh; 
                            overflow-y: auto; 
                            box-sizing: border-box; 
                            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
                            position: relative;
                        }
                        
                        /* Aurora spots inside modal */
                        .info-modal-content::before {
                            content: '';
                            position: absolute;
                            top: 0; left: 0; right: 0; bottom: 0;
                            background: 
                                radial-gradient(ellipse 50% 30% at 20% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 70%),
                                radial-gradient(ellipse 40% 35% at 80% 60%, rgba(16, 185, 129, 0.06) 0%, transparent 70%),
                                radial-gradient(ellipse 35% 25% at 60% 90%, rgba(249, 115, 22, 0.05) 0%, transparent 70%);
                            pointer-events: none;
                            border-radius: 28px 28px 0 0;
                        }
                        
                        .info-modal-content > * {
                            position: relative;
                            z-index: 1;
                        }
                        
                        .info-modal-backdrop-active .info-modal-content { transform: translateY(0); }
                        
                        /* Modal Header for light theme */
                        .info-modal-header h3 {
                            color: #0F172A !important;
                            background: linear-gradient(90deg, #1e293b 0%, #334155 100%);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                        }
                        
                        /* Close button for light theme */
                        .info-modal-header button {
                            color: #64748B !important;
                        }
                        .info-modal-header button:hover {
                            color: #0F172A !important;
                        }
                        
                        /* Updated Badge Styles - Glass effect for light bg */
                        .modal-badge { 
                            width: 28px !important; 
                            height: 28px !important; 
                            min-width: 28px !important; 
                            border-radius: 50% !important; 
                            display: flex !important; 
                            align-items: center !important; 
                            justify-content: center !important; 
                            background: rgba(255, 255, 255, 0.8) !important; 
                            backdrop-filter: blur(8px) !important;
                            font-family: 'JetBrains Mono', monospace !important; 
                            font-size: 12px !important; 
                            font-weight: 800 !important; 
                            border: 2px solid !important; 
                            box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important; 
                            margin-top: 2px !important; 
                        }
                        
                        .modal-badge.e1 { color: #10B981 !important; border-color: #10B981 !important; }
                        .modal-badge.e2 { color: #3B82F6 !important; border-color: #3B82F6 !important; }
                        .modal-badge.e3 { color: #F59E0B !important; border-color: #F59E0B !important; }
                        .modal-badge.e4 { color: #EF4444 !important; border-color: #EF4444 !important; }
                        
                        /* Aurora Animation */
                        @keyframes aurora-shift {
                            0% { background-position: 0% 50%; }
                            50% { background-position: 100% 50%; }
                            100% { background-position: 0% 50%; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            // === BOTTOM BLOCK (LIGHT AURORA / ICE) ===
            const footer = document.getElementById('info-dynamic-footer');
            if (footer) {
                // Убираем блок "Важно знать" из шторки - теперь footer всегда пустой
                footer.innerHTML = '';
                footer.style.display = 'none';
            }

            if (show) {
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.style.pointerEvents = 'all';
                    modal.classList.add('info-modal-backdrop-active');
                }, 10);
            } else {
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
                modal.classList.remove('info-modal-backdrop-active');
                setTimeout(() => { modal.style.display = 'none'; }, 300);
            }
        }
    
// Генератор строки - AURORA LIGHT DESIGN
function createEchelonItem(num, title, desc, colorClass) {
    return `
    <div style="display:flex; gap:14px; padding:12px; background: rgba(255,255,255,0.6); backdrop-filter: blur(8px); border-radius:16px; align-items: flex-start; border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div class="modal-badge ${colorClass}">${num}</div>
        <div>
            <div style="font-weight:700; font-size:15px; margin-bottom:4px; color:#0F172A;">${title}</div>
            <div style="font-size:13px; color:#64748B; line-height:1.4;">${desc}</div>
        </div>
    </div>`;
}



// Функция управления видимостью кнопки
function updateInfoBtnState(tabName) {
    const btn = document.getElementById('stocksInfoBtn');
    if (!btn) return;
    
    if (tabName === 'stocks') {
        btn.classList.add('visible');
        // Добавляем анимацию только если ещё не кликали
        if (!btn.dataset.clicked) {
            setTimeout(() => btn.classList.add('h-help-animated'), 350);
        }
    } else {
        btn.classList.remove('visible');
        btn.classList.remove('h-help-animated');
    }
}

    
document.addEventListener("DOMContentLoaded", function() {
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. ПРОВЕРКА: Если данных нет, покажем ошибку
    if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
        // alert("Нет данных пользователя (вы не в Телеграм?)"); 
        return;
    }

    const user = tg.initDataUnsafe.user;
    
    // ВРЕМЕННЫЙ ALERT ДЛЯ ОТЛАДКИ (Удалите, когда заработает)
    // alert("Отправляем лог для: " + user.first_name);

    // 2. ИСПОЛЬЗУЕМ FormData (Это работает надежнее чем JSON)
    const formData = new FormData();
    formData.append("action", "webapp_log");
    formData.append("id", user.id);
    formData.append("username", user.username ? "@" + user.username : "No Username");
    formData.append("first_name", user.first_name);

    // 3. ВАША ССЫЛКА НА СКРИПТ (Проверьте, что она правильная!)
    const LOGGING_URL = "https://script.google.com/macros/s/AKfycbwOnMSCahe3R53CoooNzUxdB8XbSHvXKgxg53iZN7PXIUYLeIJkpfkEaZgh7HUMJ7Ql/exec";

    // 4. ОТПРАВКА
    
    fetch(LOGGING_URL, {
        method: "POST",
        mode: "no-cors", // Разрешаем отправку без ожидания ответа
        body: formData   // Отправляем как форму, а не как JSON текст
    })
    .then(() => {
        console.log("Запрос отправлен");
    })
    .catch(err => {
        alert("Ошибка отправки: " + err);
    });
});


// =============================================
// USERS API — Registration & Dashboard System
// =============================================

// USERS_API_URL и isApiConfigured перенесены выше (до checkFirstVisit)

// =============================================
// ПРОВЕРКА РЕГИСТРАЦИИ ПРИ ЗАПУСКЕ
// =============================================
async function checkUserRegistration(telegramId) {
    // Сначала проверяем localStorage (быстрый кэш)
    const cached = localStorage.getItem('user_registered');
    
    if (!isApiConfigured()) {
        // API не настроен — работаем только через localStorage
        if (cached) {
            try {
                window._currentUser = JSON.parse(cached);
                window._isRegistered = true;
                isFirstVisit = false;
                document.getElementById('navWrapper').style.display = 'flex';
                populateDashboard(window._currentUser);
                showScreen('screen-dashboard');
                return;
            } catch(e) { /* corrupted cache */ }
        }
        isFirstVisit = true;
        showScreen('screen-home');
        return;
    }
    
    try {
        const url = `${USERS_API_URL}?action=check_user&telegram_id=${telegramId}`;
        const response = await fetch(url, { redirect: 'follow', mode: 'cors' });
        
        // Google Apps Script может вернуть HTML вместо JSON если что-то не так
        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch(parseErr) {
            console.error('API returned non-JSON:', text.substring(0, 200));
            throw new Error('Invalid API response');
        }
        
        // Проверяем что ответ от правильного API (должен иметь поле 'registered')
        if (!('registered' in data)) {
            console.error('API response missing "registered" field — wrong endpoint?');
            throw new Error('Wrong API endpoint');
        }
        
        if (data.success && data.registered) {
            const user = data.user;
            
            if (user.status === 'deleted' || user.status === 'blocked') {
                window._isRegistered = false;
                window._currentUser = null;
                localStorage.removeItem('user_registered');
                localStorage.removeItem('user_visited');
                isFirstVisit = true;
                showScreen('screen-home');
                return;
            }
            
            window._currentUser = user;
            window._isRegistered = true;
            isFirstVisit = false;
            localStorage.setItem('user_registered', JSON.stringify(user));
            
            document.getElementById('navWrapper').style.display = 'flex';
            populateDashboard(user);
            showScreen('screen-dashboard');
        } else {
            window._isRegistered = false;
            localStorage.removeItem('user_registered');
            localStorage.removeItem('user_visited');
            isFirstVisit = true;
            showScreen('screen-home');
        }
    } catch (err) {
        console.error('Error checking user:', err);
        if (cached) {
            try {
                window._currentUser = JSON.parse(cached);
                window._isRegistered = true;
                isFirstVisit = false;
                document.getElementById('navWrapper').style.display = 'flex';
                populateDashboard(window._currentUser);
                showScreen('screen-dashboard');
            } catch(e) {
                isFirstVisit = true;
                showScreen('screen-home');
            }
        } else {
            isFirstVisit = true;
            showScreen('screen-home');
        }
    }
}

// =============================================
// ОТКРЫТЬ TERMINAL ИЛИ РЕГИСТРАЦИЮ
// =============================================
function openTerminalOrRegister() {
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
    
    if (window._isRegistered && window._currentUser) {
        // Уже зарегистрирован — сразу на дашборд, регистрация недоступна
        document.getElementById('navWrapper').style.display = 'flex';
        showScreen('screen-dashboard');
    } else {
        // Предзаполняем имя из Telegram
        const tg = window.Telegram?.WebApp;
        const user = tg?.initDataUnsafe?.user;
        if (user) {
            const fn = document.getElementById('regFirstName');
            const ln = document.getElementById('regLastName');
            if (fn && user.first_name) fn.value = user.first_name;
            if (ln && user.last_name) ln.value = user.last_name || '';
        }
        showScreen('screen-register');
    }
}

// =============================================
// ВЫБОР БРОКЕРА
// =============================================
function selectBroker(card) {
    // Legacy fallback — redirect to waterfall
}

// =============================================
// BROKER WATERFALL ACCORDION
// =============================================
function toggleBrokerList() {
    const container = document.getElementById('brokerWaterfall');
    const arrow = document.getElementById('brokerMainArrow');
    if (!container) return;
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.selectionChanged();
    }
    
    container.classList.toggle('show');
    arrow.classList.toggle('open');
}

function selectBrokerWaterfall(card, brokerId, brokerName, logoClass) {
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.selectionChanged();
    }
    
    // Убираем selected у всех
    document.querySelectorAll('#brokerWaterfall .strategy-option-card').forEach(c => c.classList.remove('selected-in-list'));
    card.classList.add('selected-in-list');
    
    window._selectedBroker = brokerId;
    
    // Обновляем главную карточку
    const mainCard = document.getElementById('brokerMainCard');
    const mainName = document.getElementById('brokerMainName');
    const mainLogoWrap = document.getElementById('brokerMainLogo');
    
    if (mainName) mainName.textContent = brokerName;
    if (mainLogoWrap) {
        const letters = {'t-invest':'Т','alor':'A','finam':'F','bcs':'Б','alfa':'A'};
        // Заменяем placeholder на обычный broker-logo
        mainLogoWrap.className = 'broker-logo ' + logoClass;
        mainLogoWrap.innerHTML = letters[brokerId] || '?';
    }
    if (mainCard) mainCard.classList.add('has-selection');
    
    // Закрываем waterfall
    setTimeout(() => {
        document.getElementById('brokerWaterfall').classList.remove('show');
        document.getElementById('brokerMainArrow').classList.remove('open');
    }, 200);
}

// =============================================
// ВЫБОР ПЛАНА
// =============================================
function selectPlan(card) {
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.selectionChanged();
    }
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    window._selectedPlan = card.dataset.plan;
}

// =============================================
// ОТПРАВКА РЕГИСТРАЦИИ
// =============================================
async function submitRegistration() {
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    
    if (!firstName) { showDashToast('Введите имя', true); return; }
    if (!window._selectedBroker) { showDashToast('Выберите брокера', true); return; }
    
    const tg = window.Telegram?.WebApp;
    const telegramUser = tg?.initDataUnsafe?.user;
    
    document.getElementById('regLoading').classList.add('active');
    document.getElementById('btnRegister').disabled = true;
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
    
    // Формируем объект пользователя
    const now = new Date();
    const planDays = { trial: 90, monthly: 30, yearly: 365 };
    const endDate = new Date(now.getTime() + (planDays[window._selectedPlan] || 90) * 86400000);
    
    const localUser = {
        telegram_id: telegramUser ? telegramUser.id : 'local_' + Date.now(),
        username: telegramUser?.username ? '@' + telegramUser.username : '',
        first_name: firstName,
        last_name: lastName,
        broker: window._selectedBroker,
        plan: window._selectedPlan,
        plan_start: now.toISOString().split('T')[0],
        plan_end: endDate.toISOString().split('T')[0],
        status: 'active',
        registered_at: now.toISOString().split('T')[0]
    };
    
    if (!isApiConfigured()) {
        // API не настроен — регистрация только локально
        window._currentUser = localUser;
        window._isRegistered = true;
        isFirstVisit = false;
        localStorage.setItem('user_registered', JSON.stringify(localUser));
        localStorage.setItem('user_visited', 'true');
        
        if (window.Telegram?.WebApp?.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        
        document.getElementById('regLoading').classList.remove('active');
        document.getElementById('btnRegister').disabled = false;
        document.getElementById('navWrapper').style.display = 'flex';
        populateDashboard(localUser);
        showScreen('screen-dashboard');
        return;
    }
    
    if (!telegramUser) { 
        showDashToast('Откройте через Telegram', true); 
        document.getElementById('regLoading').classList.remove('active');
        document.getElementById('btnRegister').disabled = false;
        return; 
    }
    
    try {
        const params = new URLSearchParams({
            action: 'register',
            telegram_id: telegramUser.id,
            username: telegramUser.username ? '@' + telegramUser.username : '',
            first_name: firstName,
            last_name: lastName,
            broker: window._selectedBroker,
            plan: window._selectedPlan
        });
        
        const response = await fetch(`${USERS_API_URL}?${params.toString()}`, { redirect: 'follow', mode: 'cors' });
        const regText = await response.text();
        let data;
        try { data = JSON.parse(regText); } catch(pe) { throw new Error('Invalid API response'); }
        
        if (data.success) {
            window._currentUser = data.user;
            window._isRegistered = true;
            isFirstVisit = false;
            
            localStorage.setItem('user_registered', JSON.stringify(data.user));
            localStorage.setItem('user_visited', 'true');
            
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
            
            document.getElementById('navWrapper').style.display = 'flex';
            populateDashboard(data.user);
            showScreen('screen-dashboard');
        } else {
            showDashToast(data.error || 'Ошибка регистрации', true);
        }
    } catch (err) {
        console.error('Registration error:', err);
        // При ошибке сети — сохраняем локально
        window._currentUser = localUser;
        window._isRegistered = true;
        isFirstVisit = false;
        localStorage.setItem('user_registered', JSON.stringify(localUser));
        localStorage.setItem('user_visited', 'true');
        
        if (window.Telegram?.WebApp?.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        
        document.getElementById('navWrapper').style.display = 'flex';
        populateDashboard(localUser);
        showScreen('screen-dashboard');
    } finally {
        document.getElementById('regLoading').classList.remove('active');
        document.getElementById('btnRegister').disabled = false;
    }
}

// =============================================
// ЗАПОЛНЕНИЕ ДАШБОРДА
// =============================================
function populateDashboard(user) {
    if (!user) return;
    
    document.getElementById('dashFirstName').textContent = user.first_name || '—';
    document.getElementById('dashLastName').textContent = user.last_name || '—';
    
    const statusPill = document.getElementById('dashStatusPill');
    const statusText = document.getElementById('dashStatusText');
    if (user.status === 'active') {
        statusPill.classList.remove('expired');
        statusText.textContent = 'Active';
    } else {
        statusPill.classList.add('expired');
        statusText.textContent = user.status === 'expired' ? 'Expired' : 'Inactive';
    }
    
    document.getElementById('dashProfileName').textContent = 
        (user.first_name || '') + ' ' + (user.last_name || '');
    document.getElementById('dashProfileTg').textContent = user.username || '—';
    
    const brokerNames = { 't-invest': 'Т-Инвестиции', 'alor': 'АЛОР Брокер', 'finam': 'Финам', 'bcs': 'БКС', 'alfa': 'Альфа-Инвестиции' };
    document.getElementById('dashProfileBroker').textContent = brokerNames[user.broker] || user.broker || '—';
    document.getElementById('dashProfileDate').textContent = user.registered_at || '—';
    
    const planNames = { 'trial': 'Пробный', 'monthly': 'Ежемесячная', 'yearly': 'Годовая' };
    document.getElementById('dashSubPlan').textContent = planNames[user.plan] || user.plan;
    
    const subBadge = document.getElementById('dashSubBadge');
    if (user.status === 'active') {
        subBadge.textContent = 'Active';
        subBadge.classList.remove('expired');
    } else {
        subBadge.textContent = 'Expired';
        subBadge.classList.add('expired');
    }
    
    document.getElementById('dashSubStart').textContent = formatDateRu(user.plan_start);
    document.getElementById('dashSubEnd').textContent = formatDateRu(user.plan_end);
    
    document.querySelectorAll('.dash-plan-option').forEach(opt => {
        opt.classList.remove('current');
        if (opt.dataset.plan === user.plan) opt.classList.add('current');
    });
    
    if (user.api_token) document.getElementById('dashTokenInput').value = user.api_token;
    updateBrokerInstructions(user.broker);
    
    // Sync bento widgets
    syncBentoSub(user);
    syncBentoRing();
    syncBentoMarketData();
    updateDashDatePill();
    syncSettingsBadges(user);
}

function formatDateRu(dateStr) {
    if (!dateStr) return '—';
    try {
        const d = new Date(dateStr);
        const months = ['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'];
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    } catch(e) { return dateStr; }
}

function updateBrokerInstructions(broker) {
    const instructions = {
        't-invest': `<strong>Т-Инвестиции (T-Invest API):</strong><br><strong>1.</strong> Откройте <strong>tinkoff.ru/invest</strong> → Настройки<br><strong>2.</strong> Раздел «Токен для API»<br><strong>3.</strong> Нажмите «Выпустить токен» → «Только чтение»<br><strong>4.</strong> Скопируйте и вставьте выше`,
        'alor': `<strong>АЛОР Брокер (ALOR OpenAPI):</strong><br><strong>1.</strong> Войдите в <strong>lk.alor.ru</strong><br><strong>2.</strong> Настройки → API<br><strong>3.</strong> Создайте Refresh Token<br><strong>4.</strong> Скопируйте и вставьте выше`,
        'finam': `<strong>Финам (Trading API):</strong><br><strong>1.</strong> Войдите в <strong>my.finam.ru</strong><br><strong>2.</strong> Настройки → Торговые API<br><strong>3.</strong> Создайте ключ с правами чтения<br><strong>4.</strong> Скопируйте и вставьте выше`,
        'bcs': `<strong>БКС (BCS Trade API):</strong><br><strong>1.</strong> Войдите в <strong>bcs.ru/trade-api</strong><br><strong>2.</strong> Зарегистрируйтесь в API<br><strong>3.</strong> Получите токен доступа<br><strong>4.</strong> Скопируйте и вставьте выше`,
        'alfa': `<strong>Альфа-Инвестиции:</strong><br><strong>1.</strong> Войдите в <strong>Альфа-Инвестиции</strong> в личный кабинет<br><strong>2.</strong> Перейдите в Настройки → API<br><strong>3.</strong> Создайте токен с правами чтения<br><strong>4.</strong> Скопируйте и вставьте выше`
    };
    const el = document.getElementById('brokerInstructionText');
    if (el && instructions[broker]) el.innerHTML = instructions[broker];
}

// =============================================
// СМЕНА ПОДПИСКИ
// =============================================
async function changePlan(newPlan) {
    if (!window._currentUser || window._currentUser.plan === newPlan) return;
    if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.selectionChanged();
    
    try {
        const params = new URLSearchParams({
            action: 'update_subscription',
            telegram_id: window._currentUser.telegram_id,
            plan: newPlan
        });
        const response = await fetch(`${USERS_API_URL}?${params.toString()}`);
        const data = await response.json();
        
        if (data.success) {
            window._currentUser.plan = newPlan;
            window._currentUser.plan_start = data.plan_start;
            window._currentUser.plan_end = data.plan_end;
            window._currentUser.status = 'active';
            localStorage.setItem('user_registered', JSON.stringify(window._currentUser));
            populateDashboard(window._currentUser);
            showDashToast('Подписка обновлена');
            if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        } else { showDashToast(data.error || 'Ошибка', true); }
    } catch (err) { showDashToast('Ошибка сети', true); }
}

// =============================================
// СОХРАНЕНИЕ API ТОКЕНА
// =============================================
async function saveApiToken() {
    if (!window._currentUser) return;
    const token = document.getElementById('dashTokenInput').value.trim();
    
    try {
        const params = new URLSearchParams({
            action: 'update_token',
            telegram_id: window._currentUser.telegram_id,
            api_token: token
        });
        const response = await fetch(`${USERS_API_URL}?${params.toString()}`);
        const data = await response.json();
        
        if (data.success) {
            window._currentUser.api_token = token;
            localStorage.setItem('user_registered', JSON.stringify(window._currentUser));
            showDashToast('Токен сохранён');
            if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        } else { showDashToast('Ошибка сохранения', true); }
    } catch (err) { showDashToast('Ошибка сети', true); }
}

// =============================================
// DASHBOARD SETTINGS ACCORDION
// =============================================
// =============================================
// BENTO DASHBOARD WIDGETS
// =============================================

// Date pill
function updateDashDatePill() {
    const el = document.getElementById('dashDatePill');
    if (!el) return;
    const now = new Date();
    const months = ['янв','фев','мар','апр','май','июн','июл','авг','сен','окт','ноя','дек'];
    const days = ['вс','пн','вт','ср','чт','пт','сб'];
    el.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
}
updateDashDatePill();

// Portfolio Ring Chart (canvas donut)
function drawBentoRing(bondsPct) {
    const canvas = document.getElementById('bentoRingCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2, r = 62, lw = 14;
    ctx.clearRect(0, 0, w, h);
    
    if (bondsPct === null) {
        // No calculation yet — draw placeholder ring
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        const isDark = document.body.classList.contains('dark-mode');
        ctx.strokeStyle = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.05)';
        ctx.lineWidth = lw;
        ctx.lineCap = 'round';
        ctx.stroke();
        
        // Dashed hint segments  
        ctx.setLineDash([8, 20]);
        ctx.beginPath();
        ctx.arc(cx, cy, r, -Math.PI/2, -Math.PI/2 + Math.PI * 1.2);
        ctx.strokeStyle = isDark ? 'rgba(59,130,246,0.15)' : 'rgba(59,130,246,0.12)';
        ctx.lineWidth = lw;
        ctx.stroke();
        
        ctx.beginPath();
        ctx.arc(cx, cy, r, -Math.PI/2 + Math.PI * 1.3, -Math.PI/2 + Math.PI * 2);
        ctx.strokeStyle = isDark ? 'rgba(16,185,129,0.15)' : 'rgba(16,185,129,0.12)';
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Update labels
        const pctEl = document.getElementById('bentoRingPct');
        const lblEl = document.querySelector('.bento-ring-label');
        if (pctEl) pctEl.textContent = '—';
        if (lblEl) lblEl.textContent = 'расчёт';
        return;
    }
    
    const stocksPct = 100 - bondsPct;
    const bondRad = (bondsPct / 100) * Math.PI * 2;
    const gap = 0.04; // small gap between segments
    
    // Bonds arc (blue)
    ctx.beginPath();
    ctx.arc(cx, cy, r, -Math.PI/2 + gap/2, -Math.PI/2 + bondRad - gap/2);
    ctx.strokeStyle = '#3B82F6';
    ctx.lineWidth = lw;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Stocks arc (green)
    ctx.beginPath();
    ctx.arc(cx, cy, r, -Math.PI/2 + bondRad + gap/2, -Math.PI/2 + Math.PI*2 - gap/2);
    ctx.strokeStyle = '#10B981';
    ctx.lineWidth = lw;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Update label
    const pctEl = document.getElementById('bentoRingPct');
    const lblEl = document.querySelector('.bento-ring-label');
    if (pctEl) pctEl.textContent = bondsPct + '%';
    if (lblEl) lblEl.textContent = 'облигации';
}

// Sync ring with portfolio data
function syncBentoRing() {
    // Check if portfolio was ever calculated
    const slider = document.getElementById('bondsSlider');
    const hasCalculation = window.isPortfolioCalculated || 
                           (window._lastCalcResult && window._lastCalcResult.bonds);
    
    if (hasCalculation && slider) {
        drawBentoRing(parseInt(slider.value) || 60);
    } else {
        drawBentoRing(null); // placeholder
    }
}

// Sync market data to bento cells
function syncBentoMarketData() {
    // IMOEX
    const imoexSrc = document.getElementById('val-imoex');
    const imoexDst = document.getElementById('bento-val-imoex');
    if (imoexSrc && imoexDst && imoexSrc.textContent !== '---') {
        imoexDst.textContent = imoexSrc.textContent;
    }
    const dynImoexSrc = document.getElementById('dyn-imoex');
    const dynImoexDst = document.getElementById('bento-dyn-imoex');
    if (dynImoexSrc && dynImoexDst && dynImoexSrc.textContent) {
        dynImoexDst.textContent = dynImoexSrc.textContent;
        dynImoexDst.className = 'bento-market-delta ' + 
            (dynImoexSrc.textContent.includes('-') ? 'down' : 'up');
    }
    
    // USD/RUB
    const usdSrc = document.getElementById('val-usdrub');
    const usdDst = document.getElementById('bento-val-usdrub');
    if (usdSrc && usdDst && usdSrc.textContent !== '---') {
        usdDst.textContent = usdSrc.textContent;
    }
    const dynUsdSrc = document.getElementById('dyn-usdrub');
    const dynUsdDst = document.getElementById('bento-dyn-usdrub');
    if (dynUsdSrc && dynUsdDst && dynUsdSrc.textContent) {
        dynUsdDst.textContent = dynUsdSrc.textContent;
        dynUsdDst.className = 'bento-market-delta ' + 
            (dynUsdSrc.textContent.includes('-') ? 'down' : 'up');
    }
    
    // OFZ 10Y
    const ofzSrc = document.getElementById('val-ofz10');
    const ofzDst = document.getElementById('bento-val-ofz');
    if (ofzSrc && ofzDst && ofzSrc.textContent !== '---%') {
        ofzDst.textContent = ofzSrc.textContent;
    }
}

// Sync subscription mini card  
function syncBentoSub(user) {
    if (!user) return;
    const planNames = { 'trial': 'Trial', 'monthly': 'Monthly', 'yearly': 'Yearly' };
    const planEl = document.getElementById('bentoSubPlan');
    const badgeEl = document.getElementById('bentoSubBadge');
    const endEl = document.getElementById('bentoSubEnd');
    
    if (planEl) planEl.textContent = planNames[user.plan] || user.plan;
    if (badgeEl) {
        if (user.status === 'active') {
            badgeEl.textContent = 'Active';
            badgeEl.classList.remove('expired');
        } else {
            badgeEl.textContent = 'Expired';
            badgeEl.classList.add('expired');
        }
    }
    if (endEl) endEl.textContent = formatDateRu(user.plan_end);
}

// Market data sync interval
setInterval(syncBentoMarketData, 2000);

// Hook into populateDashboard to sync bento widgets
const _origPopulateDashboard = typeof populateDashboard === 'function' ? populateDashboard : null;

// New settings panel toggle
function toggleSettingsPanel(panelId, rowEl) {
    if (window.Telegram?.WebApp?.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.selectionChanged();
    }
    const panel = document.getElementById(panelId);
    if (!panel) return;
    
    const isOpen = panel.classList.contains('open');
    
    // Close all panels first
    document.querySelectorAll('.ds-expand-panel').forEach(p => p.classList.remove('open'));
    document.querySelectorAll('.dash-settings-row').forEach(r => r.classList.remove('ds-open'));
    
    // Toggle current
    if (!isOpen) {
        panel.classList.add('open');
        if (rowEl) rowEl.classList.add('ds-open');
    }
}

// Sync new settings badge with user data
function syncSettingsBadges(user) {
    if (!user) return;
    const badge = document.getElementById('dsSubBadge');
    if (badge) {
        badge.textContent = user.status === 'active' ? 'Active' : 'Expired';
        badge.className = 'ds-row-badge' + (user.status !== 'active' ? ' expired' : '');
    }
    const hint = document.getElementById('dsSubHint');
    const planNames = { 'trial': 'Пробный', 'monthly': 'Ежемесячная', 'yearly': 'Годовая' };
    if (hint) hint.textContent = planNames[user.plan] || 'Управление тарифом';
    
    const tokenStatus = document.getElementById('dsTokenStatus');
    if (tokenStatus) {
        tokenStatus.textContent = user.api_token ? 'Задан' : 'Не задан';
    }
}

// Also update bento sub mini card to open new panel
function openSubFromBento() {
    const row = document.getElementById('dsRowSub');
    toggleSettingsPanel('dsPanelSub', row);
    // Scroll to settings
    setTimeout(() => {
        const section = document.querySelector('.dash-settings-group');
        if (section) section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function toggleDashSettings(id) {
    const item = document.getElementById(id);
    if (!item) return;
    if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.selectionChanged();
    document.querySelectorAll('.dash-settings-item').forEach(el => {
        if (el.id !== id) el.classList.remove('open');
    });
    item.classList.toggle('open');
}

// =============================================
// НАВИГАЦИЯ: ДОМОЙ
// =============================================
function goHomeScreen() {
    if (window._isRegistered) {
        showScreen('screen-dashboard');
    } else {
        showScreen('screen-home');
    }
}

// =============================================
// TOAST УВЕДОМЛЕНИЯ
// =============================================
function showDashToast(message, isError) {
    const toast = document.getElementById('dashToast');
    if (!toast) return;
    toast.textContent = message;
    toast.classList.toggle('error', !!isError);
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
}


       
        
    </script>
  <style>
/* === ФИНАЛЬНЫЙ РЕМОНТ: ПРАВИЛЬНЫЕ ЦВЕТА + СТРУКТУРА === */

    /* 1. Основная карточка: ВОЗВРАЩАЕМ РОДНОЙ ГРАДИЕНТ */
    div#shareContainer.portfolio-capital-card {
        padding: 16px 20px !important;
        /* Возвращаем оригинальный синий градиент */
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
        margin-bottom: 16px !important;
        gap: 0 !important;
        min-height: auto !important;
        border: none !important; /* Убираем лишние рамки */
    }

    /* 2. Верхняя часть (Капитал) */
    div#shareContainer .capital-top-row { margin-bottom: 6px !important; }
    div#shareContainer .capital-value { 
        font-size: 28px !important; 
        line-height: 1.1 !important;
        color: #ffffff !important; /* Чистый белый */
    }
    
    /* Тонкая линия */
    div#shareContainer .capital-distribution { margin-bottom: 8px !important; margin-top: 6px !important; }
    div#shareContainer .capital-bar { height: 3px !important; margin-bottom: 6px !important; background: rgba(255,255,255,0.15) !important;}
    
    /* Подписи (Акции/Облигации) */
    div#shareContainer .capital-labels { margin-top: 4px !important; }
    div#shareContainer .capital-label-text { 
        display: block !important; 
        font-size: 10px !important; 
        opacity: 0.7 !important; 
    }

    /* Разделитель убираем */
    div#shareContainer .capital-divider { display: none !important; }

    /* === 3. БЛОК ПРОГНОЗА: ЗЕЛЕНЫЙ ФОН + ВЕРТИКАЛЬНАЯ СТРУКТУРА === */
    div#shareContainer .capital-forecast {
        /* Возвращаем зеленый фон, но делаем блок компактным */
        background: rgba(16, 185, 129, 0.08) !important; 
        border: 1px solid rgba(16, 185, 129, 0.15) !important;
        border-radius: 12px !important;
        padding: 10px 14px !important;
        margin-top: 8px !important;
        
        display: flex !important;
        flex-direction: column !important; /* Строго вертикально */
        gap: 8px !important;
    }

    /* Скрываем иконку и заголовок для экономии места */
    div#shareContainer .forecast-icon-mini { display: none !important; }
    div#shareContainer .forecast-title-mini { display: none !important; }

    div#shareContainer .forecast-content-mini {
        width: 100% !important;
        margin: 0 !important;
        display: block !important;
    }

    /* --- ГЛАВНАЯ СТРОКА (ИТОГО) --- */
    div#shareContainer .forecast-main-row {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        margin-bottom: 8px !important; /* Отступ до деталей */
        padding-bottom: 8px !important;
        border-bottom: 1px dashed rgba(16, 185, 129, 0.2) !important; /* Зеленая пунктирная линия */
    }

    /* Надпись "Прогноз" слева */
    div#shareContainer .forecast-total-mini::before {
        content: "Прогноз (3 года)";
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        color: rgba(255,255,255,0.7);
        font-weight: 500;
        float: left;
    }

    /* Сумма справа */
    div#shareContainer .forecast-total-mini {
        font-family: 'JetBrains Mono', monospace !important;
        font-size: 15px !important;
        font-weight: 700 !important;
        color: #ffffff !important;
        text-align: right !important;
        display: block !important;
        width: 100% !important;
    }

    /* Проценты скрываем только при PDF генерации */
    div#shareContainer.sharing-mode .forecast-percent-change { display: none !important; }

    /* --- ДЕТАЛИ (КУПОНЫ, РОСТ) --- */
    div#shareContainer .forecast-details-mini {
        display: flex !important;
        flex-direction: column !important;
        width: 100% !important;
        padding: 0 !important; /* Убираем любые внутренние отступы */
        margin: 0 !important;
    }

    /* 3. Прижимаем к левому краю */
    div#shareContainer .forecast-detail-item {
        display: flex !important;
        justify-content: flex-start !important;
        gap: 6px !important;
        width: 100% !important;
        margin-bottom: 4px !important;
    }

    /* 2. Подписи (Купоны, Рост) */
    div#shareContainer .detail-label {
        color: rgba(255, 255, 255, 0.5) !important;
        text-align: left !important; /* Строго слева */
        width: auto !important;
    }

/* 1. Цифры в деталях (Купоны, Рост) */
    div#shareContainer .detail-value {
        color: #4ade80 !important; /* Яркий зеленый цвет (Neon Green) */
        font-family: 'JetBrains Mono', monospace !important;
        font-weight: 500 !important;
        text-align: right !important; /* Строго справа */
    }

    /* 5. Выравниваем заголовок "Прогноз" так же, как и детали */
    div#shareContainer .forecast-main-row {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
      div#shareContainer .forecast-total-mini::before {
        margin-left: 0 !important; 
        padding-left: 0 !important;
    }
</style>
<div id="portfolioModeSwitcher" class="mode-switcher-container" style="display: none;">
    <div class="mode-switcher">
        
        <button class="mode-btn-side" onclick="closePortfolioMode()">
            <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>

        <div class="mode-divider-vertical"></div>

        <div class="mode-indicator" id="modeIndicator"></div>

        <button class="mode-btn active" onclick="switchMode(this, 0)">
            <span class="mode-text">Купить</span>
        </button>

        <button class="mode-btn" onclick="switchMode(this, 1)">
            <span class="mode-text">Активы</span>
        </button>

        <button class="mode-btn" onclick="switchMode(this, 2)">
            <span class="mode-text">Ребаланс</span>
        </button>

        <div class="mode-divider-vertical"></div>

        <button class="mode-btn-side" onclick="openSearchFromPortfolio()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>

    </div>
</div>

<style>
    /* Стиль контейнера (висит внизу) */
    .mode-switcher-container {
        position: fixed;
        bottom: 30px; 
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999; /* Поверх всего */
        width: 94%; /* Чуть шире, чтобы все влезло */
        max-width: 380px;
    }

    /* Сам пульт */
    .mode-switcher {
        position: relative;
        display: flex;
        align-items: center;
        background: rgba(15, 23, 42, 0.9); /* Плотный темный фон */
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 4px 0; /* Отступы только вертикальные */
        box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.6);
        transition: background 0.3s, border-color 0.3s, box-shadow 0.3s;
    }
    
    /* Светлый режим локального меню (до расчёта портфеля) */
    .mode-switcher.mode-light {
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .mode-switcher.mode-light .mode-btn {
        color: rgba(100, 116, 139, 0.7);
    }
    .mode-switcher.mode-light .mode-btn.active {
        color: #0F172A;
    }
    .mode-switcher.mode-light .mode-indicator {
        background: rgba(0, 0, 0, 0.06);
        border-color: rgba(0, 0, 0, 0.04);
    }
    .mode-switcher.mode-light .mode-btn-side {
        color: rgba(100, 116, 139, 0.5);
    }
    .mode-switcher.mode-light .mode-divider-vertical {
        background: rgba(0, 0, 0, 0.08);
    }
    
    /* Тёмный режим mode-light для dark-mode */
    body.dark-mode .mode-switcher.mode-light {
        background: rgba(30, 41, 59, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.3);
    }
    body.dark-mode .mode-switcher.mode-light .mode-btn {
        color: rgba(148, 163, 184, 0.6);
    }
    body.dark-mode .mode-switcher.mode-light .mode-btn.active {
        color: #fff;
    }

    /* Бегающая подсветка (активный фон) */
    .mode-indicator {
        position: absolute;
        top: 4px;
        bottom: 4px;
        left: 4px;
        width: calc(33.33% - 5px); /* Треть ширины */
        background: rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        border: 1px solid rgba(255,255,255,0.05);
    }

   /* Боковые кнопки (Выход и Поиск) */
    .mode-btn-side {
        width: 44px; /* Фиксированная ширина боковых кнопок */
        height: 100%;
        background: transparent;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.5);
        flex-shrink: 0; /* Не сжиматься */
    }
    .mode-btn-side svg {
        width: 20px;
        height: 20px;
    }
    .mode-btn-side:active {
        color: #fff;
        transform: scale(0.9);
    }

    /* Вертикальные разделители */
    .mode-divider-vertical {
        width: 1px;
        height: 16px;
        background: rgba(255, 255, 255, 0.1);
    }

    /* Центральные кнопки (Табы) */
    .mode-btn {
        flex: 1; /* Растягиваются равномерно */
        background: none;
        border: none;
        padding: 12px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 2;
        color: rgba(255, 255, 255, 0.5);
        transition: color 0.2s;
        font-family: 'Inter', sans-serif;
        font-size: 11px; /* Чуть меньше шрифт, чтобы влезли длинные слова */
        font-weight: 600;
        white-space: nowrap;
    }
    .mode-btn.active {
        color: #fff;
    }

    /* --- ГЛАВНОЕ: ИНДИКАТОР --- */
    .mode-indicator {
        position: absolute;
        top: 4px;
        bottom: 4px;
        /* МАТЕМАТИКА: */
        /* Отступ слева = Ширина кнопки выхода (44px) + Разделитель (1px) */
        left: 45px; 
        
        /* Ширина индикатора = (Вся ширина - Боковые кнопки (88px) - Разделители (2px)) / 3 таба */
        width: calc((100% - 92px) / 3);
        
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 14px;
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        z-index: 1;
    }

/* === ТЕРМИНАЛ (Список к покупке) === */
.sl-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 99999;
    background: #0F172A;
    flex-direction: column;
    overflow: hidden;
}
.sl-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    padding-top: calc(100px + env(safe-area-inset-top, 20px));
    position: sticky;
    top: 0;
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    z-index: 10;
    border-bottom: 1px solid rgba(255,255,255,0.06);
}
.sl-header-btn {
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    color: #94A3B8;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: all 0.2s;
}
.sl-header-btn svg { width: 20px; height: 20px; }
.sl-header-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.1); }
.sl-header-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: #F1F5F9;
    letter-spacing: 0.12em;
}
.sl-body {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 16px;
    padding-bottom: 140px;
}
.sl-section-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #64748B;
    margin-bottom: 10px;
    padding-left: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.sl-section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(255,255,255,0.06);
}
.sl-card-group {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
}
.sl-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: all 0.25s ease;
}
.sl-item:last-of-type { border-bottom: none; }
.sl-item.filled {
    background: rgba(16, 185, 129, 0.04);
}
.sl-item.filled .sl-ticker { text-decoration: line-through; color: #64748B; }
.sl-item.filled .sl-name { color: #475569; }
.sl-item.filled .sl-qty { color: #475569; }
.sl-item.filled .sl-sum { color: #475569; }
.sl-checkbox {
    width: 22px; height: 22px;
    min-width: 22px;
    border-radius: 7px;
    border: 2px solid rgba(255,255,255,0.15);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s ease;
}
.sl-item.filled .sl-checkbox {
    border-color: #10B981;
    background: #10B981;
}
.sl-info { flex: 1; min-width: 0; }
.sl-info-top { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
.sl-ticker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: #F1F5F9;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.25s;
}
.sl-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 5px;
    flex-shrink: 0;
    letter-spacing: 0.02em;
}
.sl-badge-ofz { background: rgba(52,152,219,0.2); color: #3498db; }
.sl-badge-t1 { background: rgba(52,152,219,0.2); color: #3498db; }
.sl-badge-t2 { background: rgba(245,158,11,0.2); color: #f59e0b; }
.sl-badge-t3 { background: rgba(239,68,68,0.2); color: #ef4444; }
.sl-name {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: #64748B;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.25s;
}
.sl-right { display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; gap: 2px; }
.sl-qty {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: #10B981;
    white-space: nowrap;
    transition: color 0.25s;
}
.sl-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 500;
    color: #94A3B8;
    white-space: nowrap;
    transition: color 0.25s;
}
.sl-group-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255,255,255,0.02);
    border-top: 1px solid rgba(255,255,255,0.06);
}
.sl-group-total-label {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: #64748B;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.sl-group-total-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    font-weight: 700;
    color: #F1F5F9;
}
/* Footer */
.sl-footer {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: linear-gradient(180deg, rgba(30, 41, 59, 0.95) 0%, rgba(22, 33, 50, 0.98) 100%);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border-top: 1px solid rgba(255,255,255,0.12);
    padding: 16px 20px;
    padding-bottom: calc(16px + env(safe-area-inset-bottom, 10px));
    z-index: 10;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
}
.sl-footer-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}
.sl-footer-block { display: flex; flex-direction: column; gap: 3px; }
.sl-footer-block:last-child { align-items: flex-end; }
.sl-footer-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: #94A3B8;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}
.sl-footer-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    color: #F1F5F9;
}
.sl-footer-plan { font-size: 14px; color: #CBD5E1; }
.sl-footer-divider {
    width: 1px;
    height: 32px;
    background: rgba(255,255,255,0.12);
}
.sl-progress-track {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,0.08);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
}
.sl-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #3498db, #10B981);
    border-radius: 3px;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
}
.sl-progress-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: #94A3B8;
    text-align: center;
}
.sl-toast {
    position: fixed;
    bottom: 160px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: rgba(16, 185, 129, 0.9);
    backdrop-filter: blur(10px);
    color: white;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 12px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 20;
}
.sl-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}
</style>
    <script>
    // === ГЛАВНЫЙ КОНТРОЛЛЕР МЕНЮ ===

    // Функция, которую нужно вызывать при переходе на экран
    // Например: showScreen('screen-portfolio') -> вызываем checkMenuVisibility('screen-portfolio')
   function checkMenuVisibility(screenId) {
        const mainMenu = document.getElementById('navWrapper'); // Старое меню
        const portfolioMenu = document.getElementById('portfolioModeSwitcher'); // Новый пульт

        // Список экранов, которые относятся к "Портфельному режиму"
        const portfolioScreens = ['screen-portfolio', 'screen-stub', 'screen-assets'];

        // Если screen-assets открыт через главное меню (иконку $) — показываем главное меню
        if (screenId === 'screen-assets' && assetsFromMainNav) {
            if (mainMenu) mainMenu.style.setProperty('display', 'flex', 'important');
            if (portfolioMenu) portfolioMenu.style.display = 'none';
            return;
        }

        if (portfolioScreens.includes(screenId)) { 
            // === МЫ ВНУТРИ ПОРТФЕЛЯ ===
            if (mainMenu) mainMenu.style.setProperty('display', 'none', 'important');
            if (portfolioMenu) portfolioMenu.style.display = 'block';
            
            // Светлое меню если портфель ещё не сформирован, тёмное после
            const modeSwitcher = portfolioMenu ? portfolioMenu.querySelector('.mode-switcher') : null;
            if (modeSwitcher) {
                if (isPortfolioCalculated) {
                    modeSwitcher.classList.remove('mode-light');
                } else {
                    modeSwitcher.classList.add('mode-light');
                }
            }

            // Обновляем подсветку кнопок на пульте в зависимости от экрана
            updatePortfolioTabs(screenId);

        } else {
            // === ОБЫЧНЫЙ РЕЖИМ ===
            // Не показываем меню на странице регистрации
            if (screenId === 'screen-register') {
                if (mainMenu) mainMenu.style.setProperty('display', 'none', 'important');
            } else {
                if (mainMenu) mainMenu.style.setProperty('display', 'flex', 'important');
            }
            if (portfolioMenu) portfolioMenu.style.display = 'none';
        }
    }

        // Вспомогательная функция: Синхронизирует кнопку пульта с текущим экраном
    function updatePortfolioTabs(screenId) {
        const switcher = document.getElementById('portfolioModeSwitcher');
        if (!switcher) return;
        
        const btns = switcher.querySelectorAll('.mode-btn');
        const indicator = document.getElementById('modeIndicator');
        let activeIndex = 0;

        btns.forEach(b => b.classList.remove('active'));

        if (screenId === 'screen-portfolio') activeIndex = 0; // Купить
        if (screenId === 'screen-stub') activeIndex = 1;      // Активы
        if (screenId === 'screen-assets') activeIndex = 2;    // Ребаланс

        btns[activeIndex].classList.add('active');
        indicator.style.transform = `translateX(${activeIndex * 100}%)`;
    }

    // 2. ФУНКЦИЯ ВЫХОДА (Стрелочка)
    function closePortfolioMode() {
        goHomeScreen(); // Возврат на домашний экран (dashboard или home)
    }

    // 3. ФУНКЦИЯ ПОИСКА (Лупа)
    function openSearchFromPortfolio() {
        // Показываем главное меню (нужно для expandedNav)
        const mainMenu = document.getElementById('navWrapper');
        const portfolioMenu = document.getElementById('portfolioModeSwitcher');
        
        if (mainMenu) mainMenu.style.setProperty('display', 'flex', 'important');
        if (portfolioMenu) portfolioMenu.style.display = 'none';
        
        // Добавляем compact-nav для светлого стиля
        document.body.classList.add('compact-nav');
        
        // Открываем поиск как из главного меню
        expandSearch();
    }

    // 4. ПЕРЕКЛЮЧЕНИЕ ТАБОВ (Купить / Активы / Ребаланс)
  function switchMode(btn, index) {
        // Вибрация
        if (window.Telegram?.WebApp?.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.selectionChanged();
        }

        // ПЕРЕХОД НА НУЖНЫЙ ЭКРАН
        if (index === 0) {
            // КУПИТЬ -> Идем на screen-portfolio
            // (Логика "пусто/густо" уже внутри самого экрана)
            showScreen('screen-portfolio');
        } 
        else if (index === 1) {
            // АКТИВЫ -> Идем на заглушку
            showScreen('screen-stub');
        } 
        else if (index === 2) {
            // РЕБАЛАНС -> Идем на screen-assets (Таблица Аврора)
            showScreen('screen-assets');
        }
    }
</script>


<!-- Overlay: Список к покупке — ПОСЛЕДНИЙ элемент в body для максимального z-index -->
<div id="shoppingListOverlay" class="sl-overlay">
    <!-- Sticky Header -->
    <div class="sl-header">
        <button class="sl-header-btn" onclick="closeShoppingList()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg>
        </button>
        <div class="sl-header-title">СПИСОК К ПОКУПКЕ</div>
        <button class="sl-header-btn" onclick="copyShoppingList()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>
    </div>
    <!-- Scrollable Body -->
    <div id="shoppingListBody" class="sl-body"></div>
    <!-- Floating Footer -->
    <div class="sl-footer" id="slFooter">
        <div class="sl-footer-row">
            <div class="sl-footer-block">
                <span class="sl-footer-label">Осталось купить</span>
                <span class="sl-footer-value" id="slRemaining">0 ₽</span>
            </div>
            <div class="sl-footer-divider"></div>
            <div class="sl-footer-block">
                <span class="sl-footer-label">План</span>
                <span class="sl-footer-value sl-footer-plan" id="slPlan">0 ₽</span>
            </div>
        </div>
        <div class="sl-progress-track">
            <div class="sl-progress-bar" id="slProgressBar"></div>
        </div>
        <div class="sl-progress-label" id="slProgressLabel">0%</div>
    </div>
    <!-- Toast -->
    <div class="sl-toast" id="slToast">Скопировано ✓</div>
</div>

</body>
</html>
