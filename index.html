
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal Madame Solomi'na</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Solomi'na">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <meta name="theme-color" content="#3498db">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --accent-orange: #e67e22;
            --accent-red: #e74c3c;
            --accent-gradient: linear-gradient(135deg, #3498db, #2980b9);
            --header-gradient: linear-gradient(135deg, #f8f9fa, #e9ecef);
            --header-light-gradient: linear-gradient(135deg, #e3f2fd, #f0f9ff); 
            --graphite-color: #303D4F;
            --input-color: #3a506b;
            --card-shadow: rgba(0,0,0,0.06);
            --border-color: rgba(0,0,0,0.04);
            --item-border: #f0f0f0;
            --nav-bg: rgba(255, 255, 255, 0.95);
            --nav-border: rgba(255, 255, 255, 0.5);
            --nav-icon-inactive: #bdc3c7;
            --coupon-blue-bg: rgba(52, 152, 219, 0.08);
            --badge-blue-bg: rgba(52, 152, 219, 0.15);
            --badge-green-bg: rgba(46, 204, 113, 0.15);
            --terminal-gradient: linear-gradient(90deg, #F1F6FB 0%, #F9FAFC 100%);
            --graphite-btn: #2C364C;
            --bg-gradient-start: #F1F6FB;
            --bg-gradient-end: #F9FAFC;
            --bonds-color: #5B7C99;
            --stocks-color: #94A8B8;
            /* === Claude AI Glassmorphism Variables === */
            --claude-bg-base: #F7F5F3;
            --claude-glass: rgba(255, 255, 255, 0.65);
            --claude-glass-border: rgba(255, 255, 255, 0.8);
            --claude-glass-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.04);
            --claude-accent: #D97757;
            --claude-accent-subtle: rgba(217, 119, 87, 0.1);
            --claude-text-primary: #1a1a1a;
            --claude-text-secondary: #6b6b6b;
        }

                /* ========== ОТКЛЮЧЕНИЕ ЭФФЕКТА РЕЗИНКИ ========== */
        html {
            overscroll-behavior: none; /* Главная команда отключения пружины */
            height: 100%; /* Фиксируем высоту */
            -webkit-overflow-scrolling: touch; /* Для плавности на айфонах */
        }
        
        body {
            overscroll-behavior: none; /* Дублируем для надежности */
            min-height: 100%;
        }
        /* ================================================= */

    

        body.dark-mode {
            --bg-color: #0f172a;
            background: linear-gradient(180deg, #0f172a 0%, #1a2234 100%);
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-green: #4ade80;
            --accent-yellow: #fcd34d;
            --accent-orange: #fb923c;
            --accent-red: #f87171;
            --accent-gradient: linear-gradient(135deg, #38bdf8, #0ea5e9);
            --header-gradient: linear-gradient(135deg, #1e293b, #2d3748);
            --header-light-gradient: linear-gradient(135deg, #1e293b, #334155);
            --graphite-color: #303D4F;
            --input-color: #f8fafc;
            --card-shadow: rgba(0,0,0,0.4);
            --border-color: rgba(255,255,255,0.05);
            --item-border: #334155;
            --nav-bg: rgba(30, 41, 59, 0.95);
            --nav-border: rgba(255, 255, 255, 0.1);
            --nav-icon-inactive: #475569;
            --coupon-blue-bg: rgba(56, 189, 248, 0.1);
            --badge-blue-bg: rgba(56, 189, 248, 0.15);
            --badge-green-bg: rgba(74, 222, 128, 0.15);
            /* === Claude AI Dark Mode Variables === */
            --claude-bg-base: #1a1a2e;
            --claude-glass: rgba(30, 41, 59, 0.75);
            --claude-glass-border: rgba(255, 255, 255, 0.1);
            --claude-glass-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.3);
            --claude-accent: #E8956A;
            --claude-accent-subtle: rgba(232, 149, 106, 0.15);
            --claude-text-primary: #f1f5f9;
            --claude-text-secondary: #94a3b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(180deg, #F1F6FB 0%, #F9FAFC 100%);
            color: var(--text-main);
            margin: 0; padding: 16px; line-height: 1.4;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 40px;
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        .toast {
            position: fixed;
            top: 20px; left: 50%; transform: translateX(-50%);
            background: #2ecc71; color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 12px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .toast.show { opacity: 1; visibility: visible; }

        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

         /* Фон с цветным свечением для эффекта стекла */
        #screen-app {
            background: linear-gradient(90deg, #F5F1EE 0%, #F9FAFC 100%);
            margin: -16px;
            padding: 16px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            overflow: hidden; /* Чтобы пятна не вылезали */
        }

        /* Добавляем цветные пятна на фон */
        #screen-app::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: 
                radial-gradient(circle at 80% 20%, rgba(52, 152, 219, 0.08) 0%, transparent 40%), /* Голубое пятно */
                radial-gradient(circle at 20% 80%, rgba(217, 119, 87, 0.06) 0%, transparent 40%); /* Оранжевое пятно */
            z-index: -1; /* Убираем назад */
            pointer-events: none;
        }

        /* Фон для темной темы */
        body.dark-mode #screen-app {
            background: linear-gradient(90deg, #1a2234 0%, #0f172a 100%);
        }

        /* ========== NEW: Welcome Screen Styles ========== */
.welcome-screen {
    min-height: calc(100vh - 32px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(90deg, #F5F1EE 0%, #F9FAFC 100%);
    margin: -16px;
    padding: 60px 30px;
    text-align: center;
    animation: welcomeFadeIn 0.8s ease-out;
    box-sizing: border-box;
}

@keyframes welcomeFadeIn {
    from {
        opacity: 0;
        transform: scale(0.98);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.welcome-logo-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-bottom: 80px;
}

.welcome-supratitle {
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 600;
    color: #94A3B8;
    text-transform: uppercase;
    letter-spacing: 0.3em;
}

.welcome-title {
    font-family: 'Inter', sans-serif;
    font-size: 32px;
    color: #2C364C;
    line-height: 1.2;
    margin: 0;
}

.welcome-title-light {
    font-weight: 300;
}

.welcome-title-bold {
    font-weight: 800;
}

.welcome-divider {
    width: 50px;
    height: 1px;
    background: rgba(44, 54, 76, 0.2);
    margin: 8px 0;
}

.welcome-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: #8A9AB0;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    line-height: 1.8;
}

.welcome-cta-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    width: 100%;
    max-width: 280px;
}

.btn-welcome {
    width: 100%;
    padding: 18px 32px;
    background: #2C364C;
    color: white;
    border: none;
    border-radius: 16px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    cursor: pointer;
    box-shadow: 0 12px 35px rgba(44, 54, 76, 0.25);
    transition: all 0.2s ease;
}

.btn-welcome:active {
    transform: scale(0.97);
    box-shadow: 0 6px 20px rgba(44, 54, 76, 0.3);
}

.welcome-secure-text {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 500;
    color: #A0AEC0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.welcome-secure-text svg {
    width: 11px;
    height: 11px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.dark-mode .welcome-screen {
    background: linear-gradient(90deg, #1a2234 0%, #0f172a 100%);
}

.dark-mode .welcome-supratitle {
    color: #64748B;
}

.dark-mode .welcome-title {
    color: #F1F5F9;
}

.dark-mode .welcome-divider {
    background: rgba(255, 255, 255, 0.15);
}

.dark-mode .welcome-subtitle {
    color: #64748B;
}

.dark-mode .btn-welcome {
    background: #2C364C;
    color: #ffffff;
}

.dark-mode .welcome-secure-text {
    color: #64748B;
}
/* ========== END: Welcome Screen Styles ========== */

.terminal-header { padding: 10px 10px 30px; text-align: left; }

        /* ========== NEW: Terminal Header V2 для 2й вкладки ========== */
.terminal-header-v2 {
            background: transparent; /* Прозрачный фон */
            padding: 40px 10px 10px 10px; /* Отступ сверху побольше */
            margin: 0; /* Убираем старые margin -16px */
            text-align: left;
        }

.terminal-title-main {
    font-family: 'Inter', sans-serif;
    font-weight: 800;
    font-size: 32px;
    color: #2C364C;
    letter-spacing: -0.5px;
    margin-bottom: 6px;
    line-height: 1.1;
}

.terminal-subtitle {
    font-family: 'Inter', sans-serif;
    font-weight: 500;
    font-size: 12px;
    color: #8A9AB0;
    letter-spacing: 0.5px;
    text-transform: none;
}

.dark-mode .terminal-header-v2 {
    background: linear-gradient(90deg, #1a2234 0%, #1e293b 100%);
}

.dark-mode .terminal-title-main {
    color: #f1f5f9;
}

.dark-mode .terminal-subtitle {
    color: #64748b;
}
/* ========== END: Terminal Header V2 ========== */

        
        .terminal-badge {
            display: inline-flex;
            align-items: center; gap: 6px; padding: 4px 10px;
            background: var(--accent-blue); color: white; font-size: 10px; font-weight: 900;
            border-radius: 4px; text-transform: uppercase;
            margin-bottom: 12px; letter-spacing: 1px;
        }

        .market-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #ccc; }
        .dot-online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; animation: pulse 2s infinite; }
        .dot-offline { background: #e74c3c; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .home-title { font-size: 26px; font-weight: 800; margin-bottom: 15px; line-height: 1.2; }
        .home-desc { font-size: 15px; color: #8e8e93; line-height: 1.6; margin-bottom: 25px; }
        
        .market-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .market-item-modern {
            background: var(--card-bg);
            border-radius: 16px; padding: 12px 16px;
            position: relative; overflow: hidden; box-shadow: 0 6px 15px var(--card-shadow);
            border: 1px solid var(--border-color); display: flex;
            flex-direction: row; align-items: center; justify-content: space-between;
        }
        .market-item-modern::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 4px; height: 100%;
        }
        .market-item-modern.blue::before { background: var(--accent-blue); }
        .market-item-modern.green::before { background: var(--accent-green); }
        .market-item-modern.orange::before { background: #f39c12; }
        
        .mk-left { display: flex; flex-direction: column; gap: 4px; }
        .mk-label {
            font-size: 14px; font-weight: 700; color: var(--text-main); letter-spacing: 0px;
            text-transform: none; margin-bottom: 0;
        }
        .mk-val {
            font-size: 16px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px;
        }
        .mk-dynamics {
            font-size: 12px; font-weight: 700; padding: 4px 8px; border-radius: 8px;
        }
        .mk-dynamics.positive { background: var(--badge-green-bg); color: var(--accent-green); }
        .mk-dynamics.negative { background: rgba(231, 76, 60, 0.1); color: var(--accent-red); }
        .mk-dynamics.neutral { background: rgba(0,0,0,0.05); color: var(--text-secondary); }
        .dark-mode .mk-dynamics.neutral { background: rgba(255,255,255,0.1); }
        
        .rates-vertical-block {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px var(--card-shadow);
            border: 1px solid var(--border-color);
        }
        .rv-title {
            font-size: 11px; color: #8e8e93; font-weight: 700; text-transform: uppercase;
            margin-bottom: 12px; letter-spacing: 0.5px;
        }
        .rv-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .rv-item {
            display: flex; flex-direction: column; gap: 4px;
            background: rgba(0,0,0,0.02); padding: 10px; border-radius: 12px;
        }
        .dark-mode .rv-item { background: rgba(255,255,255,0.03); }
        .rv-item span { font-size: 10px; color: #8e8e93; font-weight: 600; }
        .rv-item b { font-size: 15px; color: var(--text-main); font-weight: 800; }

        .info-card {
            background: var(--card-bg);
            padding: 20px; border-radius: 20px; margin-bottom: 15px;
            border: 1px solid var(--border-color); box-shadow: 0 5px 15px var(--card-shadow); 
            position: relative; overflow: hidden; transition: transform 0.2s;
        }
        .info-card:active { transform: scale(0.99); }
        .info-card.bonds { border-left: 4px solid var(--accent-blue); background: linear-gradient(to right, rgba(52, 152, 219, 0.03), var(--card-bg)); }
        .info-card.stocks { border-left: 4px solid var(--accent-green); background: linear-gradient(to right, rgba(46, 204, 113, 0.03), var(--card-bg)); }

        .info-card-header { font-size: 18px; font-weight: 800; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .bonds .info-card-header { color: var(--accent-blue); }
        .stocks .info-card-header { color: var(--accent-green); }

        .info-card-sub-clean { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 10px 0; opacity: 0.7; }
        .bonds .info-card-sub-clean { color: var(--accent-blue); }
        .stocks .info-card-sub-clean { color: var(--accent-green); }
        
        .info-card-text { font-size: 13px; line-height: 1.6; color: var(--text-main); margin-bottom: 15px; opacity: 0.8; }
        
        .info-card-badge {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 900; letter-spacing: 0.5px;
        }
        .badge-blue { background: var(--badge-blue-bg); color: var(--accent-blue); }
        .badge-green { background: var(--badge-green-bg); color: var(--accent-green); }

        .btn-action {
            display: flex; align-items: center; justify-content: center; width: 100%; padding: 16px; margin-top: 12px;
            background: var(--coupon-blue-bg); color: var(--accent-blue);
            border: 1px solid var(--accent-blue); border-radius: 16px;
            font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; gap: 8px;
        }
        .btn-action:active { opacity: 0.7; transform: scale(0.98); }

        @keyframes shimmerBtn {
    0% { box-shadow: 0 10px 25px rgba(44, 54, 76, 0.2); transform: scale(1); }
    50% { box-shadow: 0 12px 30px rgba(44, 54, 76, 0.3); transform: scale(1.005); }
    100% { box-shadow: 0 10px 25px rgba(44, 54, 76, 0.2); transform: scale(1); }
}

.btn-graphite {
    position: relative;
    background: #2C364C; 
    color: white; 
    border: none; 
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(44, 54, 76, 0.2);
    margin-top: 15px;
    padding: 20px; 
    font-family: 'Inter', sans-serif;
    font-size: 17px; 
    border-radius: 16px;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 12px;
    width: 100%; 
    box-sizing: border-box; 
    font-weight: 700;
    animation: shimmerBtn 3s infinite ease-in-out;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-graphite svg { 
    width: 28px; 
    height: 28px; 
    fill: none; 
    stroke: white; 
    stroke-width: 2; 
}

.btn-graphite:active { 
    transform: scale(0.98); 
    opacity: 0.9;
    animation: none; 
}

/* Обновленная панель кнопки: теперь она идет просто после списка, без фиксации */
.bottom-sticky-panel {
    position: relative; /* Убираем fixed */
    background: transparent; /* Убираем белый фон */
    backdrop-filter: none; /* Убираем размытие */
    -webkit-backdrop-filter: none;
    padding: 20px 0; /* Оставляем только небольшие отступы сверху и снизу */
    z-index: 800;
    border-top: none; /* Убираем рамку сверху */
    margin-top: 10px;
}
        /* ========== NEW: Скрытие элементов при фокусе на вводе ========== */
body.input-focused .nav-wrapper {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

body.input-focused .bottom-sticky-panel {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.nav-wrapper,
.bottom-sticky-panel {
    transition: opacity 0.2s ease;
}
/* ========== END: Скрытие элементов при фокусе ========== */

.dark-mode .bottom-sticky-panel {
    background: rgba(15, 23, 42, 0.92);
    border-top-color: rgba(255, 255, 255, 0.1);
}

.bottom-sticky-panel .btn-graphite {
    margin-top: 0;
}

.sticky-hint {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: #8A9AB0;
    text-align: center;
    margin-top: 10px;
    line-height: 1.5;
    padding: 0 10px;
}

        .start-expl { font-size: 11px; color: #8e8e93; text-align: center; margin-top: 8px; padding: 0 10px; line-height: 1.5; }

        .header { text-align: center; margin-bottom: 20px; }
h1 { 
    font-family: 'Inter', sans-serif;
    font-size: 20px; 
    font-weight: 800;
    margin-bottom: 4px; 
}

#dynamicSubtitle {
    font-family: 'Inter', sans-serif;
    font-weight: 400;
}
        
       .calc-box {
    background: transparent; 
    padding: 0; 
    border-radius: 0;
    box-shadow: none; 
    margin-bottom: 25px; 
    border: none;
}

.calc-top { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    margin-bottom: 10px; 
}

.input-container { flex: 1; }

.input-label { 
    font-family: 'Inter', sans-serif;
    font-size: 11px; 
    color: #8A9AB0; 
    font-weight: 700; 
    margin-bottom: 12px; 
    display: block; 
    text-transform: uppercase; 
    letter-spacing: 1.5px; 
}

.input-wrapper { 
    display: flex; 
    align-items: center; 
    justify-content: center;
    gap: 0; /* ИЗМЕНЕНО: убираем gap */
    padding: 10px 0 20px 0;
    position: relative;
}

.input-wrapper::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0 auto;
    width: fit-content;
    min-width: 200px;
    max-width: 90%;
    height: 1px;
    background: rgba(44, 54, 76, 0.2);
    transition: all 0.3s ease;
}

.input-wrapper:focus-within::after {
    width: 80%;
    background: rgba(44, 54, 76, 0.4);
}

input#sumInput { 
    border: none; 
    font-family: 'JetBrains Mono', monospace;
    font-size: 42px; 
    font-weight: 500; 
    width: 200px; /* Начальная ширина */
    max-width: 85%;
    outline: none; 
    color: #2C364C;
    background: transparent; 
    margin: 0; 
    padding: 0;
    line-height: 1.2;
    text-align: center;
    transition: width 0.2s ease, font-size 0.15s ease; /* ДОБАВЛЕНО: анимация ширины */
    letter-spacing: -0.02em;
}
/* Убираем стрелочки для числового поля */
input#sumInput::-webkit-outer-spin-button,
input#sumInput::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input#sumInput[type=number] {
    -moz-appearance: textfield;
}

input#sumInput.size-large {
    font-size: 42px;
}

input#sumInput.size-medium {
    font-size: 32px;
}

input#sumInput.size-small {
    font-size: 24px;
}

input#sumInput.size-xsmall {
    font-size: 20px;
}

.currency { 
    font-family: 'JetBrains Mono', monospace;
    font-size: 42px; 
    color: #94A3B8; 
    font-weight: 400;
    opacity: 0.6;
    margin-left: 4px; /* Небольшой отступ */
    flex-shrink: 0;
}

.dark-mode input#sumInput {
    color: #f1f5f9;
}

.dark-mode .currency {
    color: #475569;
}

.dark-mode .input-wrapper {
    border-bottom-color: #334155;
}

        .usage-bar-container { margin-bottom: 20px; }
        .usage-label { font-size: 10px; color: #8e8e93; display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: bold; }
        .usage-track { height: 4px; background: #eee; border-radius: 2px; overflow: hidden; }
        #usageFill { height: 100%; width: 0%; background: var(--accent-green); transition: width 0.3s; }


        /* ========== NEW: Dropdown для тарифа комиссии ========== */
        /* Белая карточка начинается с тарифа */
         .calc-box-white-section {
            /* Делаем фон более прозрачным (0.4 вместо 0.65) */
            background: rgba(255, 255, 255, 0.4);
            
            /* Сильное размытие фона под карточкой */
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            
            padding: 20px 24px 24px 24px;
            border-radius: 24px;
            
            /* Тонкая белая рамка усиливает эффект стекла */
            border: 1px solid rgba(255, 255, 255, 0.5);
            
            /* Мягкая тень */
            box-shadow: 0 20px 40px rgba(0,0,0,0.03);
            
            margin-top: 25px;
        }

        /* Настройка для темной темы */
        body.dark-mode .calc-box-white-section {
            background: rgba(30, 41, 59, 0.5); /* Тоже прозрачнее */
            border-color: rgba(255, 255, 255, 0.1);
        }
.fee-selector {
    margin-bottom: 20px;
}
      




        
        .chart-mini {
            width: 60px; height: 60px; border-radius: 18px; 
            background: conic-gradient(var(--accent-blue) 0% 50%, var(--accent-green) 50% 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.2); flex-shrink: 0; margin-left: 15px;
            transition: background 0.3s; cursor: pointer;
        }
        .chart-mini::after { content: attr(data-pct); font-size: 10px; font-weight: 900; color: white; }

        .ratio-control { padding-top: 5px; }
        .ratio-slider {
            -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px;
            background: #e0e0e0; outline: none; margin: 15px 0;
        }
        .ratio-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--accent-blue); cursor: pointer; border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .slider-hint-wrapper { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 8px; 
        }
        
        /* ========== NEW: Карточки инвестиционных стратегий V2 ========== */
.strategy-cards-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}

.strategy-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--card-bg);
    border: 1px solid var(--border-subtle, #E2E8F0);
    border-radius: 10px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    -webkit-tap-highlight-color: transparent;
}

.strategy-card:hover {
    background: rgba(255, 255, 255, 0.7);
    border-color: #CBD5E1;
}

.strategy-card.selected {
    background: linear-gradient(135deg, #F1F6FB 0%, #F9FAFC 100%);
    border-color: #5B7C99;
    border-width: 2px;
    box-shadow: 0 4px 16px rgba(91, 124, 153, 0.15);
    transform: scale(1.01);
    transition: all 0.3s ease;
}

.strategy-card-left {
    display: flex;
    align-items: center;
    gap: 14px;
}

/* Вертикальный индикатор с градиентом */
.strategy-indicator {
    width: 4px;
    height: 40px;
    border-radius: 2px;
    flex-shrink: 0;
}

.strategy-card-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.strategy-card-title {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary, #1F1F1F);
    line-height: 1.2;
}

.strategy-card-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 400;
    color: var(--text-secondary, #6B6B6B);
}

.strategy-card-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Разделитель между левой и правой частью */
.strategy-divider {
    width: 1px;
    height: 24px;
    background: #E2E8F0;
}

.strategy-percent-col {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
    text-align: right;
}

.strategy-percent-row {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 500;
    line-height: 1.4;
}

.strategy-percent-bonds {
    color: var(--bonds-color, #5B7C99);
}

.strategy-percent-stocks {
    color: var(--stocks-color, #94A8B8);
}

/* Карточка "Настроить свою" - дефолтное состояние */
.strategy-card-custom {
    border-style: dashed;
    border-color: #E2E8F0;
}

.strategy-card-custom:hover {
    border-color: #CBD5E1;
}

.strategy-card-custom.selected {
    border-style: solid;
    border-color: #94A3B8;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

/* Иконка настроек */
.strategy-custom-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: rgba(91, 124, 153, 0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s ease;
}

.strategy-custom-icon svg {
    width: 20px;
    height: 20px;
    stroke: var(--bonds-color, #5B7C99);
    fill: none;
    stroke-width: 2;
}

/* Скрытие иконки когда сохранено */
.strategy-card-custom.has-saved .strategy-custom-icon {
    display: none;
}

/* Показываем индикатор когда сохранено */
.strategy-card-custom .strategy-indicator {
    display: none;
}

.strategy-card-custom.has-saved .strategy-indicator {
    display: block;
}

/* Стрелка вниз */
.strategy-custom-arrow {
    transition: transform 0.3s ease;
}

.strategy-card-custom.selected .strategy-custom-arrow {
    transform: rotate(180deg);
}

.strategy-card-custom.has-saved .strategy-custom-arrow {
    display: none;
}

/* Скрываем проценты по умолчанию, показываем когда сохранено */
.strategy-card-custom .strategy-divider,
.strategy-card-custom .strategy-percent-col {
    display: none;
}

.strategy-card-custom.has-saved .strategy-divider,
.strategy-card-custom.has-saved .strategy-percent-col {
    display: flex;
}

/* Развернутый блок настройки */
/* --- 2. LUXURY Custom Strategy Box --- */

.custom-strategy-expanded {
    display: grid;
    grid-template-rows: 0fr;
    /* Полностью прозрачный фон контейнера, стекло внутри */
    background: transparent;
    border: none;
    margin-top: 10px;
    overflow: hidden;
    transition: grid-template-rows 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    padding: 0;
}

.custom-strategy-expanded.show {
    grid-template-rows: 1fr;
}

.custom-strategy-inner {
    overflow: hidden;
    /* Карточка настроек в стиле "Тихая роскошь" */
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
}

/* Дисплей значений - Минимализм */
.custom-value-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 0;
    background: transparent;
    margin-bottom: 10px;
}

.custom-value-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.custom-value-bonds, .custom-value-stocks {
    font-family: 'JetBrains Mono', monospace;
    font-size: 48px;
    font-weight: 300; /* Тонкий шрифт = дорого */
    line-height: 1;
    letter-spacing: -0.04em;
}

.custom-value-bonds { color: #5B7C99; }
.custom-value-stocks { color: #94A8B8; }

.custom-value-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #A0AEC0;
    margin-top: 6px;
}

.custom-value-divider {
    font-size: 32px;
    font-weight: 200;
    color: #CBD5E1;
    margin-top: -15px;
}

/* Слайдер "Нить" */
.custom-slider-block {
    margin: 30px 0;
    position: relative;
    height: 30px;
    display: flex;
    align-items: center;
}

.custom-ratio-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 2px; /* Очень тонкая линия */
    background: #E2E8F0;
    outline: none;
    border-radius: 1px;
    z-index: 2;
    position: relative;
}

.custom-ratio-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #FFFFFF;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); /* Мягкая тень */
    cursor: pointer;
    transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.custom-ratio-slider::-webkit-slider-thumb:active {
    transform: scale(1.15);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

/* Кнопки +/- в стиле Soft UI */
.custom-controls-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 25px;
}

.custom-adjust-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%; /* Круглые */
    background: #FFFFFF;
    border: 1px solid #F1F5F9;
    color: #2C364C;
    font-size: 24px;
    font-weight: 300;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
    transition: all 0.2s;
}

.custom-adjust-btn:active {
    transform: scale(0.92);
    background: #F8FAFC;
}

/* Кнопки действий - Премиум */
.custom-actions-row {
    display: flex;
    gap: 12px;
}

/* Кнопка сброса - минимализм */
.custom-reset-btn {
    flex: 1;
    padding: 16px;
    background: transparent;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 16px;
    color: #94A3B8;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.custom-reset-btn:hover {
    background: rgba(0,0,0,0.02);
    color: #64748B;
}

/* Кнопка Готово - Глубокий Графит */
.custom-done-btn {
    flex: 1.5; /* Чуть шире */
    padding: 16px;
    background: #2C364C; /* Luxury Graphite */
    border: none;
    border-radius: 16px;
    color: white;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.05em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 10px 25px rgba(44, 54, 76, 0.25); /* Тень в цвет */
    transition: all 0.2s;
}

.custom-done-btn:active {
    transform: scale(0.98);
    box-shadow: 0 5px 15px rgba(44, 54, 76, 0.2);
}

/* Темная тема */
.dark-mode .fee-unified-wrapper,
.dark-mode .custom-strategy-inner {
    background: rgba(30, 41, 59, 0.4);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .fee-unified-trigger,
.dark-mode .custom-adjust-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #F1F5F9;
}

.dark-mode .fee-selector-unified .fee-dropdown-menu {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .custom-value-bonds { color: #38BDF8; }
.dark-mode .custom-value-stocks { color: #94A3B8; }
.dark-mode .custom-done-btn { background: #38BDF8; color: #0F172A; box-shadow: 0 10px 25px rgba(56, 189, 248, 0.2); }
        /* ========== NEW: Сворачиваемый блок стратегий ========== */
.strategy-cards-hidden {
    display: none;
}

.strategy-cards-hidden.show {
    display: flex;
    flex-direction: column;
    gap: 10px;
    animation: fadeIn 0.3s ease;
}

.strategy-expand-trigger {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 18px;
    margin-top: 10px;
    background: transparent;
    border: 1px dashed #CBD5E1;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.strategy-expand-trigger:hover {
    border-color: #94A3B8;
    background: rgba(91, 124, 153, 0.03);
}

.strategy-expand-trigger.open {
    border-color: #5B7C99;
    background: rgba(91, 124, 153, 0.05);
}

.strategy-expand-text {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: #64748B;
}

.strategy-expand-arrow {
    width: 20px;
    height: 20px;
    color: #94A3B8;
    transition: transform 0.3s ease;
}

.strategy-expand-trigger.open .strategy-expand-arrow {
    transform: rotate(180deg);
}

.dark-mode .strategy-expand-trigger {
    border-color: #475569;
}

.dark-mode .strategy-expand-trigger:hover {
    border-color: #64748B;
    background: rgba(255, 255, 255, 0.03);
}

.dark-mode .strategy-expand-text {
    color: #94A3B8;
}
/* ========== END: Сворачиваемый блок стратегий ========== */
/* ========== END: Карточки инвестиционных стратегий V2 ========== */
        
        .slider-hint { font-size: 10px; color: #8e8e93; text-align: center; }
        
        
        

        #shareContainer { background: var(--bg-color); padding: 5px 10px 20px; border-radius: 10px; }
        .asset-list { background: var(--card-bg); border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
        .asset-item {
            display: grid; grid-template-columns: 85px 1fr 75px 80px; padding: 12px; 
            border-bottom: 1px solid var(--item-border); font-size: 12px; align-items: center;
        }
        .asset-item:last-child { border-bottom: none; }
        .ticker { font-weight: bold; color: var(--text-main); }
        .asset-name { color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .qty { text-align: right; padding-right: 8px; font-weight: bold; color: var(--accent-blue); }
        .price-total { text-align: right; color: var(--text-main); font-weight: 500; }
        
        .asset-yield-badge {
            background: rgba(46, 204, 113, 0.15); color: var(--accent-green);
            font-weight: 800; font-size: 11px; padding: 4px 8px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; width: 100%;
            box-sizing: border-box;
        }
        .asset-yield-badge.blue { background: rgba(52, 152, 219, 0.15); color: var(--accent-blue); }

        .details {
            grid-column: 1 / -1; display: none; background: rgba(0,0,0,0.02);
            padding: 12px; border-top: 1px solid var(--item-border); font-size: 11px;
            color: #8e8e93; line-height: 1.8;
        }
        .asset-item.active .details { display: block; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(0,0,0,0.05); padding: 2px 0; }
        .detail-row span:last-child { color: var(--text-main); font-weight: 600; }
        
        .btn-tiny-graph {
             background: var(--accent-blue); color: white; border: none;
             padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: bold;
             margin-top: 8px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center;
             gap: 4px; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.2);
        }

        .section-header-highlight {
            margin: 25px 0 8px; padding: 12px 16px; border-radius: 16px;
            font-weight: 800; font-size: 16px; 
            background: var(--header-light-gradient); color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid rgba(52, 152, 219, 0.2);
            display: flex; align-items: center; justify-content: space-between;
        }
        .section-desc-small { font-size: 11px; color: #8e8e93; margin-bottom: 12px; padding: 0 5px; line-height: 1.4; }

        .section-header-styled {
            margin: 25px 0 12px; background: linear-gradient(135deg, #ffffff, #f0f2f5);
            padding: 14px 16px; border-radius: 16px;
            font-weight: 900; font-size: 16px; display: flex; align-items: center; justify-content: space-between;
            color: var(--graphite-color); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .dark-mode .section-header-styled {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: #f1f5f9; border-color: rgba(255,255,255,0.1);
        }
        
        .info-expanded-block {
            display: none;
            background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 15px;
            border: 1px solid var(--accent-blue); font-size: 12px; line-height: 1.5; color: var(--text-secondary);
            animation: fadeIn 0.3s ease;
        }
        .info-expanded-block.show { display: block; }
        
        .echelon-info-graphic {
            display: flex; flex-direction: column; gap: 10px; margin-top: 10px;
        }
        .eig-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px; border-radius: 16px;
            background: linear-gradient(135deg, var(--bg-color), rgba(255,255,255,0.5));
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .eig-item:active { transform: scale(0.98); }
        .eig-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0; width: 4px;
        }
        .eig-item.e1::before { background: linear-gradient(180deg, #2ecc71, #27ae60); }
        .eig-item.e2::before { background: linear-gradient(180deg, #3498db, #2980b9); }
        .eig-item.e3::before { background: linear-gradient(180deg, #f1c40f, #f39c12); }
        .eig-item.e4::before { background: linear-gradient(180deg, #e67e22, #d35400); }
        
        .eig-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .eig-item.e1 .eig-icon { background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(46,204,113,0.05)); }
        .eig-item.e2 .eig-icon { background: linear-gradient(135deg, rgba(52,152,219,0.2), rgba(52,152,219,0.05)); }
        .eig-item.e3 .eig-icon { background: linear-gradient(135deg, rgba(241,196,15,0.2), rgba(241,196,15,0.05)); }
        .eig-item.e4 .eig-icon { background: linear-gradient(135deg, rgba(230,126,34,0.2), rgba(230,126,34,0.05)); }
        
        .eig-text { flex: 1; }
        .eig-title { 
            font-weight: 800; font-size: 13px; color: var(--text-main); margin-bottom: 4px;
            display: flex; align-items: center; gap: 8px;
        }
        .eig-badge {
            font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .eig-item.e1 .eig-badge { background: rgba(46,204,113,0.15); color: #27ae60; }
        .eig-item.e2 .eig-badge { background: rgba(52,152,219,0.15); color: #2980b9; }
        .eig-item.e3 .eig-badge { background: rgba(241,196,15,0.15); color: #f39c12; }
        .eig-item.e4 .eig-badge { background: rgba(230,126,34,0.15); color: #d35400; }
        
        .eig-desc { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }
        
        .eig-arrow {
            width: 24px; height: 24px; border-radius: 50%;
            background: var(--card-bg); display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); flex-shrink: 0;
        }

        .allocation-info-connected {
            display: flex; align-items: stretch; justify-content: space-between;
            margin-bottom: 12px; width: 100%;
            background: var(--card-bg); border: 1px solid var(--accent-blue);
            border-radius: 20px; padding: 0; position: relative; overflow: hidden;
        }
        .alloc-left {
            padding: 8px 16px; font-size: 13px; color: var(--text-main);
            display: flex; align-items: center; flex: 1; border: none; background: transparent;
        }
        .alloc-right {
            background: var(--accent-blue); color: white; padding: 8px 16px;
            font-weight: 800; font-size: 11px; display: flex; align-items: center;
            white-space: nowrap; border-radius: 20px; margin: 2px;
        }
        
        .section-transition {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin: 15px 0 25px; opacity: 1; position: relative;
        }
        .st-line { height: 1px; flex: 1; background: linear-gradient(90deg, transparent, var(--accent-blue)); }
        .st-line.rev { background: linear-gradient(90deg, var(--accent-blue), transparent); }
        .st-icon {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--card-bg); color: var(--accent-blue);
            border: 1px solid var(--accent-blue); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); z-index: 5; font-size: 20px; line-height: 1;
        }
        
        .echelon-separator-modern {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; margin-top: 15px; margin-bottom: 5px;
            border-bottom: 2px solid var(--item-border);
        }
        .esm-left { display: flex; align-items: center; gap: 8px; }
        .esm-dot { width: 8px; height: 8px; border-radius: 50%; }
        .esm-title { font-weight: 800; font-size: 12px; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }

        .echelon-separator-modern.echelon-1 .esm-dot { background-color: var(--accent-green); }
        .echelon-separator-modern.echelon-2 .esm-dot { background-color: var(--accent-blue); }
        .echelon-separator-modern.echelon-3 .esm-dot { background-color: var(--accent-yellow); }
        .echelon-separator-modern.echelon-4 .esm-dot { background-color: var(--accent-orange); }

        .esm-info-btn-light {
            width: 18px; height: 18px; border-radius: 50%; 
            background: rgba(255,255,255,0.8); color: var(--accent-blue); /* Light style */
            font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .esm-info-btn-light:hover { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        
        .esm-pct { 
            font-size: 12px; font-weight: normal; color: var(--text-secondary); 
            display: flex; align-items: center; gap: 8px;
        }
        .esm-sum { color: var(--accent-blue); font-weight: 300; font-size: 13px; }
        .esm-divider { color: var(--item-border); font-weight: 300; }
        .esm-percent {
            background: rgba(52,152,219,0.1); padding: 4px 10px; border-radius: 8px; 
            color: var(--accent-blue); font-weight: 800; display: flex; align-items: center;
        }
        
        .echelon-tip {
            display: none; 
            background: #3a506b; color: white; padding: 10px; border-radius: 8px;
            font-size: 11px; font-weight: normal; line-height: 1.3;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 10px;
        }
        .echelon-tip.show { display: block; animation: fadeIn 0.2s ease; }

        .coupon-box {
            background: var(--card-bg); border-radius: 16px; margin-top: 10px;
            border: 1px solid var(--accent-blue); overflow: hidden; margin-bottom: 10px;
            position: relative; z-index: 2;
        }
        .coupon-header {
            padding: 12px 14px; background: var(--coupon-blue-bg); color: var(--accent-blue);
            font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; cursor: pointer; align-items: center;
            position: relative;
        }
        .coupon-title-wrapper { display: flex; align-items: flex-start; gap: 10px; }
        .coupon-icon-lg { font-size: 20px; line-height: 1.2; }
        .coupon-text-col { display: flex; flex-direction: column; line-height: 1.1; }
        .coupon-main-text { font-size: 14px; font-weight: 800; }
        .coupon-preview-mini { font-size: 9px; opacity: 0.7; font-weight: normal; margin-top: 2px; }
        .coupon-content { display: none; padding: 0 12px 12px; }
        .coupon-content.active { display: block; }
        
        .coupon-table-head {
            display: grid; grid-template-columns: 85px 1fr 50px 70px; gap: 5px;
            padding: 8px 0; font-size: 9px; font-weight: 800; color: #95a5a6;
            border-bottom: 2px solid var(--item-border); margin-top: 10px; margin-bottom: 5px;
        }
        .coupon-row {
            display: grid; grid-template-columns: 85px 1fr 50px 70px; gap: 5px;
            padding: 10px 0; border-bottom: 1px solid var(--item-border); font-size: 11px; align-items: center;
        }
        .coupon-row:last-child { border-bottom: none; }
        .coupon-row b { color: var(--text-main); }
        .arrow-icon { width: 14px; height: 14px; fill: currentColor; transition: transform 0.3s; }
        .coupon-content.active + .coupon-header .arrow-icon, 
        .coupon-header[onclick*="toggle"] .arrow-icon.rotated { transform: rotate(180deg); }

        .tax-selector-ui { display: flex; background: var(--bg-color); border-radius: 10px; padding: 3px; margin: 12px 0; gap: 2px; }
        .tax-ui-btn {
            flex: 1; border: none; background: transparent; padding: 6px;
            font-size: 11px; font-weight: bold; color: #8e8e93; border-radius: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .tax-ui-btn.active { background: var(--card-bg); color: var(--accent-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .footer-disclaimer-important {
            margin-top: 15px; margin-bottom: 25px; text-align: left; 
            color: var(--text-main); 
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(46, 204, 113, 0.15));
            padding: 20px; border-radius: 20px; 
            border: 1px solid rgba(46, 204, 113, 0.2);
            font-size: 13px; line-height: 1.6;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.1);
        }
        .footer-disclaimer-important::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--accent-green);
        }
        .footer-disclaimer { text-align: center; font-size: 11px; color: #99aab5; margin-top: 30px; padding: 0 20px; }

        .nav-wrapper {
    position: fixed; bottom: 25px; left: 0; width: 100%; 
    display: flex !important; justify-content: center; gap: 10px;
    padding: 0 15px; box-sizing: border-box; z-index: 900;
}
        .nav-dock {
            background: var(--nav-bg); backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 25px; display: flex; align-items: center; padding: 8px 15px; gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--nav-border);
            transition: opacity 0.3s;
        }
        .nav-dock.hidden { opacity: 0; pointer-events: none; position: absolute; }
        
        .nav-search-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--nav-bg); backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--nav-border);
            cursor: pointer; color: var(--nav-icon-inactive); transition: all 0.2s; position: relative;
        }
        .nav-search-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .nav-search-btn:active { transform: scale(0.9); }
        
        .nav-search-expanded {
            position: absolute; bottom: 0; left: 15px; right: 15px;
            height: 66px;
            background: var(--nav-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 25px;
            display: flex; align-items: center; padding: 0 5px; gap: 5px; /* Less padding */
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            border: none;
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 910;
        }
        .nav-search-expanded.active { transform: translateY(0); }
        
        .nav-search-input-bar {
            flex: 1; border: none; background: rgba(0,0,0,0.05);
            height: 44px; border-radius: 22px; padding: 0 15px;
            font-size: 14px; outline: none; color: var(--text-main);
            box-shadow: none; -webkit-appearance: none;
        }
        .dark-mode .nav-search-input-bar { background: rgba(255,255,255,0.1); }
        .nav-search-input-bar:focus { outline: none; }

        .nav-item {
            display: flex; align-items: center; justify-content: center; width: 44px; height: 44px;
            border-radius: 15px; cursor: pointer; transition: all 0.2s; color: var(--nav-icon-inactive);
        }
        .nav-item.active { color: var(--accent-blue); background: rgba(52, 152, 219, 0.1); }
        .nav-item svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .nav-item:active { transform: scale(0.9); }
        
        .nav-back-island {
            width: 44px; height: 44px; border-radius: 15px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .nav-back-island svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2; }

        .theme-toggle-mini {
            width: 24px; height: 24px; border-radius: 50%;
            background: var(--card-bg); color: var(--text-main); 
            border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: absolute; top: -10px; right: -12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 910;
        }
        .theme-toggle-mini svg { width: 14px; height: 14px; stroke: currentColor; fill: none; }

        .list-header-row {
            display: grid; padding: 0 16px; margin-bottom: 5px;
            font-size: 9px; font-weight: 700; color: #95a5a6; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .list-header-row.ofz-cols {
            grid-template-columns: 1fr 60px 60px 70px; gap: 8px; text-align: right;
        }
        .list-header-row.ofz-cols span:first-child { text-align: left; }
        .list-header-row.ofz-cols span:nth-child(2), .list-header-row.ofz-cols span:nth-child(3) { text-align: center; }
        
        .list-header-row.calc-cols {
            /* Updated Grid for shifting right */
            display: grid; grid-template-columns: 1fr 70px 100px; gap: 8px;
            text-align: right; margin-bottom: 8px;
        }
        .list-header-row.calc-cols span:first-child { text-align: left; }
        
        .ofz-card-modern {
            background: var(--card-bg); border-radius: 16px;
            padding: 14px 16px; margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: grid; grid-template-columns: 1fr 60px 60px 70px; 
            align-items: center; gap: 8px;
            box-shadow: 0 4px 10px var(--card-shadow);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
        }
        .ofz-card-modern::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent-blue); }
        .ofz-card-modern:active { transform: scale(0.98); }
        .ofz-main-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .ofz-name-lg { font-weight: 700; font-size: 13px; color: var(--text-main); line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ofz-ticker-sm { font-size: 10px; color: #8e8e93; font-weight: 600; text-transform: uppercase; }
        
        .ofz-nkd-badge {
            font-size: 12px; font-weight: 700; color: #7f8c8d; text-align: center;
            background: rgba(0,0,0,0.04); padding: 4px 8px; border-radius: 8px;
        }
        .ofz-price { 
            font-size: 12px; font-weight: 700; color: #7f8c8d; text-align: center; 
            background: rgba(0,0,0,0.04); padding: 4px 8px; border-radius: 8px;
        }
        
        .ofz-yield-badge { 
            font-weight: 800; font-size: 13px; color: var(--accent-green); 
            background: rgba(46, 204, 113, 0.1); padding: 6px 8px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; gap: 2px;
        }
        .ofz-arrow { width: 10px; height: 10px; fill: currentColor; }
        
        .ofz-details-panel {
            display: none; background: rgba(0,0,0,0.02);
            padding: 12px; border-radius: 0 0 16px 16px; margin-top: -10px; margin-bottom: 10px;
            border: 1px solid var(--border-color); border-top: none; font-size: 11px; color: var(--text-secondary);
        }
        .ofz-details-panel.active { display: block; animation: fadeIn 0.3s; }
        .ofz-detail-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed rgba(0,0,0,0.05); padding: 2px 0; }
        .ofz-detail-val { font-weight: bold; color: var(--text-main); }

        .calc-badge-modern {
            font-size: 10px; background: linear-gradient(135deg, #34495e, #2c3e50); color: white; 
            padding: 4px 10px; border-radius: 20px; font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); letter-spacing: 0.5px;
        }

        .monthly-calc-box {
            background: var(--bg-color);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .monthly-calc-box .input-wrapper input {
            font-size: 28px;
        }

        .calc-expl-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.5;
            padding: 0 10px;
            margin: 15px 0;
        }

        .calc-bond-row {
            display: grid; grid-template-columns: 1fr 70px 100px; align-items: center;
            padding: 10px 0; border-bottom: 1px dashed var(--item-border); gap: 8px;
        }
        .calc-bond-row:last-child { border-bottom: none; }
        .unified-badge-container { display: flex; align-items: center; width: 100%; overflow: hidden; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .ub-name {
            background: #ffffff; color: var(--text-main); padding: 4px 8px; border: 1px solid #dfe6e9;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-radius: 6px; width: 100%;
        }
        .ub-price {
            background: #dfe6e9; color: #636e72; padding: 4px 8px; border-radius: 6px;
            white-space: nowrap; font-size: 11px; text-align: center;
        }
        .ub-yield {
            background: rgba(46, 204, 113, 0.2); color: #27ae60; padding: 4px 8px; white-space: nowrap;
            border-radius: 6px; font-size: 11px; text-align: center; width: 100%;
        }
        .dark-mode .ub-name { background: #1e293b; color: #f1f5f9; border-color: #334155; }
        .dark-mode .ub-price { background: #475569; color: #94a3b8; }

        .qty-controls { display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
        .qty-btn { 
            width: 28px; height: 28px; border-radius: 6px; background: var(--card-bg); 
            display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--accent-blue);
            cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 16px;
            border: 1px solid var(--border-color);
        }
        .qty-btn:active { transform: scale(0.9); background: #eee; }
        .calc-input {
            width: 44px; /* Increased width for 10000 */
            border: none;
            font-size: 12px; /* Adjusted font size */
            font-weight: bold; text-align: center;
            background: transparent; color: var(--text-main); outline: none; padding: 0;
            -moz-appearance: textfield;
        }
        .calc-input::-webkit-outer-spin-button,
        .calc-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn-row-reset {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            color: #e74c3c; cursor: pointer; opacity: 0.7;
        }
        
        .result-list-container { margin-top: 15px; background: rgba(0,0,0,0.02); border-radius: 8px; padding: 10px; }
        .dark-mode .result-list-container { background: rgba(255,255,255,0.03); }

        .info-i-blue {
            display: inline-flex; width: 24px; height: 24px; border-radius: 50%; color: var(--accent-blue);
            font-size: 14px; font-weight: bold; align-items: center; justify-content: center; margin-left: 6px; cursor: pointer;
        }
        
        /* Yield Info Preview Box */
        .info-preview-box {
            display: none;
            background: var(--coupon-blue-bg);
            color: var(--accent-blue);
            padding: 12px 16px;
            border-radius: 12px;
            margin: -5px 0 15px 0;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.5;
            border: 1px solid rgba(52, 152, 219, 0.2);
            animation: fadeIn 0.3s;
        }
        .info-preview-box.show { display: block; }
        
        .search-container { padding: 10px 0; }
        .search-result-item { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--item-border); cursor: pointer; }
        .search-result-item:active { background: rgba(0,0,0,0.02); }
        
        .btn-reset-wide {
            width: 100%; box-sizing: border-box;
            padding: 12px; border: none; background: #f1f2f6; color: #7f8c8d;
            border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;
        }
        .btn-reset-wide:active { background: #e0e0e0; }
        .dark-mode .btn-reset-wide { background: #2d3748; color: #cbd5e0; }
        
        .rebalance-intro-modern {
            background: linear-gradient(135deg, var(--card-bg), var(--bg-color));
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 12px;
            color: var(--text-secondary);
            border-left: 4px solid var(--accent-blue);
            box-shadow: 0 8px 20px var(--card-shadow);
            position: relative;
        }
        .rebalance-intro-modern b { color: var(--text-main); font-weight: 800; }
        
        /* Removed ::before, using .ri-icon instead */
        .ri-icon {
            position: absolute; top: -12px; right: 20px;
            width: 32px; height: 32px;
            background: var(--card-bg);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px var(--card-shadow);
            color: var(--accent-blue);
        }
        .ri-icon svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }

        .echelon-header-pill {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
            color: #555; border: 1px solid rgba(0,0,0,0.1);
            border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 800; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin: 0 auto;
        }
        .dark-mode .echelon-header-pill { background: rgba(30,41,59,0.8); color: #ccc; border-color: rgba(255,255,255,0.1); }
        
        th:nth-child(1) .echelon-header-pill { color: #27ae60; border-color: #2ecc71; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2); }
        th:nth-child(2) .echelon-header-pill { color: #2980b9; border-color: #3498db; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2); }
        th:nth-child(3) .echelon-header-pill { color: var(--accent-yellow); border-color: var(--accent-yellow); box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2); }
        th:nth-child(4) .echelon-header-pill { color: var(--accent-orange); border-color: var(--accent-orange); box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2); }

        .echelon-table-styled { width: 100%; border-collapse: separate; border-spacing: 0; }
        .echelon-table-styled th { padding-bottom: 15px; vertical-align: bottom; }
        .echelon-table-styled td { padding: 12px 6px; border-bottom: 1px solid var(--item-border); text-align: center; vertical-align: middle; }
        .echelon-table-styled tr:last-child td { border-bottom: none; }
        .echelon-table-styled tr:nth-child(even) { background-color: rgba(0,0,0,0.015); }
        .dark-mode .echelon-table-styled tr:nth-child(even) { background-color: rgba(255,255,255,0.015); }
        
        .et-ticker { font-weight: 800; font-size: 11px; color: var(--text-main); display: block; margin-bottom: 4px; }
        .et-target {
            display: inline-block; font-size: 10px; font-weight: 700; color: var(--accent-green);
            background: rgba(46, 204, 113, 0.1); padding: 2px 6px; border-radius: 6px;
        }

        .echelon-wrapper {
            position: relative; border-radius: 16px; 
            padding: 20px 5px; overflow: hidden; 
            transition: max-height 0.4s ease;
        }
        .echelon-wrapper.collapsed { max-height: 240px; }
        
        #ofz-wrapper { padding: 0; }
        #ofz-wrapper.collapsed { max-height: 180px; }
        
        .echelon-wrapper.collapsed::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(to bottom, transparent, var(--bg-color));
            pointer-events: none;
        }
        .expand-arrow-btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 0; margin-top: -16px; cursor: pointer;
            position: relative; z-index: 5; height: 32px;
        }
        #ofz-wrapper + .expand-arrow-btn { margin-top: 10px; }
        .eab-line { flex: 1; height: 1px; background: var(--item-border); }
        .eab-icon-box {
            width: 28px; height: 28px; border-radius: 50%; background: var(--card-bg);
            border: 1px solid var(--accent-blue); color: var(--accent-blue);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.3s;
        }
        .expand-arrow-btn:active .eab-icon-box { transform: scale(0.95); }
        .expand-arrow-btn.open .eab-icon-box { transform: rotate(180deg); }

        
        
        
        

        
       
        
        .company-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { width: 36px; height: 36px; border-radius: 12px; background: var(--card-bg); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; color: var(--text-main); }
        .company-title { font-size: 20px; font-weight: 800; line-height: 1.2; }
        
        .company-card-v2 {
            background: var(--card-bg); border-radius: 20px; padding: 20px; 
            box-shadow: 0 8px 25px var(--card-shadow); border: 1px solid var(--border-color); 
            margin-bottom: 20px;
        }
        .cc-v2-header { display: flex; align-items: center; gap: 14px; margin-bottom: 20px; }
        .cc-v2-logo { 
            width: 48px; height: 48px; border-radius: 14px; background: var(--bg-color); 
            display: flex; align-items: center; justify-content: center; font-weight: 800;
            font-size: 12px; color: var(--text-secondary);
        }
        .cc-v2-name { font-size: 16px; font-weight: 800; color: var(--text-main); }
        .cc-v2-type { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .cc-v2-price-block { display: flex; align-items: baseline; gap: 8px; margin-bottom: 15px; }
        .cc-v2-price { font-size: 34px; font-weight: 800; color: var(--text-main); }
        .cc-v2-change { font-size: 14px; font-weight: 700; }
        .cc-v2-change.positive { color: var(--accent-green); }
        .cc-v2-change.negative { color: var(--accent-red); }
        .cc-v2-change.neutral { color: var(--text-secondary); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: var(--bg-color); border-radius: 12px; padding: 12px; }
        .stat-label { font-size: 10px; color: #8e8e93; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }
        .stat-val { font-size: 14px; font-weight: 800; color: var(--text-main); }
        
        .news-header { font-size: 16px; font-weight: 800; margin-bottom: 10px; }
        .news-item { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 10px; border: 1px solid var(--item-border); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .news-date { font-size: 10px; color: var(--accent-blue); font-weight: bold; margin-bottom: 4px; }
        .news-title { font-size: 13px; font-weight: bold; line-height: 1.4; margin-bottom: 6px; }
        .news-snippet { font-size: 11px; color: #8e8e93; line-height: 1.5; }
        
        .search-empty-state {
            text-align: center; padding: 40px 20px; color: var(--text-secondary);
        }
        .search-empty-state .icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        .search-empty-state .title { font-size: 16px; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .search-empty-state .desc { font-size: 12px; line-height: 1.5; }

     /* Стили для таблицы эшелонов с раскрывающимися деталями */
.echelon-table-styled td.et-cell {
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
}

.echelon-table-styled td.et-cell:hover {
    background: rgba(52, 152, 219, 0.05);
}

.et-cell-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.et-ticker {
    font-weight: 800;
    font-size: 12px;
    color: var(--text-main);
}

.et-price {
    font-size: 10px;
    color: var(--text-secondary);
}

.et-cell-empty {
    cursor: default !important;
}

.et-details-row td {
    padding: 0 !important;
    border: none !important;
    background: var(--bg-color);
}

.et-details-container {
    padding: 12px 20px;
}

.et-expanded-details {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--accent-blue);
    box-shadow: 0 4px 10px rgba(52, 152, 219, 0.1);
}

.et-details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--item-border);
}

.et-details-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.et-details-ticker {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-main);
}

.et-details-echelon {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 6px;
    background: rgba(52, 152, 219, 0.1);
    color: var(--accent-blue);
    text-transform: uppercase;
}

.et-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.et-detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.et-detail-label {
    font-size: 10px;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
}

.et-detail-value {
    font-size: 13px;
    color: var(--text-main);
    font-weight: 700;
}

.et-details-actions {
    display: flex;
    gap: 8px;
}

.et-btn-chart,
.et-btn-company {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
}

.et-btn-chart {
    background: var(--accent-blue);
    color: white;
}

.et-btn-chart:hover {
    background: #2980b9;
}

.et-btn-company {
    background: var(--bg-color);
    color: var(--accent-blue);
    border: 1px solid var(--accent-blue);
}

.et-btn-company:hover {
    background: rgba(52, 152, 219, 0.1);
}

.et-btn-chart svg,
.et-btn-company svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

        /* Стили раскрытия для 3-й вкладки (Портфель) */
.asset-item .details {
    display: none !important;
}

.asset-item.is-expanded .details {
    display: block !important;
    animation: fadeIn 0.3s ease;
}

.asset-item {
    cursor: pointer;
}

.asset-item.is-expanded {
    background: rgba(52, 152, 219, 0.05);
}

/* Единый стиль для заглушки */
input#sumInput::placeholder {
    color: #CBD5E1;
    opacity: 1;
    font-size: 1.5rem; /* 24px - увеличенный размер */
    font-family: 'JetBrains Mono', monospace;
    font-weight: 300;
    letter-spacing: 0.01em;
    text-transform: none;
}

/* Цвет для темной темы (если она у вас переключается классом .dark-mode) */
.dark-mode #sumInput::placeholder {
    color: #475569;
}

/* ========== BLOOMBERG/HUD COMPANY CARD DESIGN ========== */

/* Динамическое свечение фона для страницы компании */
#screen-company.company-screen-active {
    position: relative;
}

#screen-company.company-screen-active::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at 30% 20%, var(--glow-color, rgba(46, 204, 113, 0.15)) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
    animation: glowPulse 4s ease-in-out infinite;
}

@keyframes glowPulse {
    0%, 100% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.05); }
}

/* Верхняя панель навигации */
.company-top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    margin-bottom: 20px;
}

.company-back-btn {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-main);
    transition: all 0.2s ease;
}

.company-back-btn:active {
    transform: scale(0.95);
    background: rgba(255, 255, 255, 0.15);
}

.company-ticker-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-main);
    letter-spacing: 0.5px;
}

.company-ticker-badge .ticker-dot {
    width: 6px;
    height: 6px;
    background: var(--accent-green);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--accent-green);
}

/* Hero секция с названием и ценой */
.company-hero {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px 0;
}

.company-hero-name {
    font-family: 'Inter', sans-serif;
    font-size: 36px;
    font-weight: 800;
    color: var(--text-main);
    letter-spacing: -0.06em;
    line-height: 1.1;
    margin-bottom: 20px;
    text-transform: uppercase;
}

.company-hero-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 56px;
    font-weight: 500;
    color: var(--text-main);
    letter-spacing: -0.02em;
    margin-bottom: 12px;
    line-height: 1;
}

.company-hero-change {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 20px;
    border-radius: 30px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 600;
}

.company-hero-change.positive {
    background: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
}

.company-hero-change.negative {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
}

.company-hero-change.neutral {
    background: rgba(127, 140, 141, 0.2);
    color: var(--text-secondary);
}

/* SVG мини-тренд */
.company-trend-svg {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.trend-line {
    stroke-dasharray: 300;
    stroke-dashoffset: 300;
    animation: drawLine 2s ease forwards;
}

@keyframes drawLine {
    to { stroke-dashoffset: 0; }
}

/* Кнопки действий */
.company-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
}

.company-action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 18px 20px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 16px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.2s ease;
}

.company-action-btn:active {
    transform: scale(0.98);
    background: rgba(255, 255, 255, 0.12);
}

.company-action-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.company-action-btn.primary {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: white;
}

/* Glassmorphism карточки */
.glass-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
}

.dark-mode .glass-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
}

/* Секция описания */
.company-deion-section {
    margin-bottom: 24px;
}

.company-section-title {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.company-section-title svg {
    width: 16px;
    height: 16px;
    stroke: var(--accent-blue);
}

.company-deion-text {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-main);
}

.company-deion-text .highlight {
    background: linear-gradient(120deg, rgba(52, 152, 219, 0.2) 0%, rgba(52, 152, 219, 0.1) 100%);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
}

/* Сетка аналитики */
.analytics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 24px;
}

.analytics-tile {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 16px;
    position: relative;
    overflow: hidden;
}

.analytics-tile::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
}

.analytics-tile.tile-forecast::before { background: linear-gradient(90deg, #3498db, #2ecc71); }
.analytics-tile.tile-dividends::before { background: linear-gradient(90deg, #2ecc71, #27ae60); }
.analytics-tile.tile-risk::before { background: linear-gradient(90deg, #f1c40f, #e67e22); }
.analytics-tile.tile-cap::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }

.analytics-tile-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.analytics-tile-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 8px;
}

.analytics-tile-sub {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--text-secondary);
}

/* Прогресс-бар для Target Forecast */
.forecast-progress {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 10px;
}

.forecast-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3498db, #2ecc71);
    border-radius: 3px;
    transition: width 1s ease;
}

/* Секция событий */
.events-section {
    margin-bottom: 24px;
}

.event-item {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 14px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.event-item:last-child {
    border-bottom: none;
}

.event-date {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 50px;
}

.event-date-day {
    font-family: 'JetBrains Mono', monospace;
    font-size: 24px;
    font-weight: 700;
    color: var(--accent-blue);
    line-height: 1;
}

.event-date-month {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.event-content {
    flex: 1;
}

.event-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 4px;
}

.event-deion {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* Dark mode адаптация */
.dark-mode .company-back-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .company-ticker-badge {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .company-action-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .analytics-tile {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.08);
}

/* ========== END: BLOOMBERG/HUD COMPANY CARD DESIGN ========== */

        /* ========================================================================
   ИНТЕРЕСНОЕ - GLASSMORPHISM REDESIGN (Claude AI Style)
   ======================================================================== */

/* Специальный фон для экрана Интересное */
#screen-interesting {
    position: relative;
    background: linear-gradient(180deg, var(--claude-bg-base) 0%, #EDE9E6 100%);
    min-height: 100vh;
    margin: -16px;
    padding: 0 16px 140px 16px;
}

body.dark-mode #screen-interesting {
    background: linear-gradient(180deg, #0f172a 0%, #1a1a2e 100%);
}

/* Динамическое свечение фона */
#screen-interesting::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(
        circle at 30% 30%,
        rgba(217, 119, 87, 0.02) 0%,
        transparent 50%
    ),
    radial-gradient(
        circle at 70% 70%,
        rgba(52, 152, 219, 0.015) 0%,
        transparent 50%
    );
    pointer-events: none;
    z-index: 0;
    animation: breatheGlow 8s ease-in-out infinite;
}

@keyframes breatheGlow {
    0%, 100% { 
        opacity: 0.6; 
        transform: scale(1) rotate(0deg); 
    }
    50% { 
        opacity: 1; 
        transform: scale(1.05) rotate(2deg); 
    }
}

/* Контейнер контента поверх свечения */
#screen-interesting > * {
    position: relative;
    z-index: 1;
}

/* === Заголовок экрана === */
#screen-interesting .header {
    padding: 30px 0 20px;
    text-align: left;
}

#screen-interesting .header h1 {
    font-family: 'Inter', sans-serif;
    font-size: 36px;
    font-weight: 600;
    letter-spacing: -0.06em;
    color: var(--claude-text-primary);
    margin: 0;
}

/* === Базовая стеклянная карточка === */
#screen-interesting .glass-card-claude {
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--claude-glass-shadow);
    transition: all 0.3s ease;
}

#screen-interesting .glass-card-claude:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 32px -2px rgba(0, 0, 0, 0.08);
}

/* === Секция рыночных данных === */
#screen-interesting .market-section-title {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--claude-text-secondary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

#screen-interesting .market-section-title::before {
    content: '';
    width: 4px;
    height: 4px;
    background: var(--claude-accent);
    border-radius: 50%;
}

/* Сетка рыночных плиток */
#screen-interesting .market-tiles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

#screen-interesting .market-tiles-grid.three-cols {
    grid-template-columns: repeat(3, 1fr);
}

/* Индивидуальная плитка */
#screen-interesting .market-tile {
    background: var(--claude-glass);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 16px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

#screen-interesting .market-tile::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--claude-accent), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

#screen-interesting .market-tile:hover::before {
    opacity: 1;
}

#screen-interesting .market-tile-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px; /* было 11px */
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--claude-text-secondary);
    text-align: center; /* ДОБАВЛЕНО */
}

#screen-interesting .market-tile-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px; /* было 20px */
    font-weight: 500;
    color: var(--claude-text-primary);
    letter-spacing: -0.02em;
    text-align: center; /* ДОБАВЛЕНО */
}

#screen-interesting .market-tile-change {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center; /* ДОБАВЛЕНО */
    gap: 4px;
    width: fit-content;
    margin: 0 auto; /* ДОБАВЛЕНО - центрирует элемент */
}

#screen-interesting .market-tile-change.positive {
    background: rgba(46, 204, 113, 0.15);
    color: #27ae60;
}

#screen-interesting .market-tile-change.negative {
    background: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
}

#screen-interesting .market-tile-change.neutral {
    background: rgba(127, 140, 141, 0.15);
    color: var(--claude-text-secondary);
}

/* === Вертикаль ставок === */
#screen-interesting .rates-glass-card {
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
}

#screen-interesting .rates-glass-card .rv-title {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--claude-accent);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

#screen-interesting .rates-glass-card .rv-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--claude-accent), transparent);
}

/* Построчный список ставок */
#screen-interesting .rates-row-list {
    display: flex;
    flex-direction: column;
    gap: 0;
}

#screen-interesting .rate-row-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    transition: background 0.2s ease;
}

#screen-interesting .rate-row-item:last-child {
    border-bottom: none;
}

#screen-interesting .rate-row-item:hover {
    background: rgba(255, 255, 255, 0.3);
}

#screen-interesting .rate-row-label {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: var(--claude-text-secondary);
}

#screen-interesting .rate-row-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 600;
    color: var(--claude-text-primary);
}

/* Dark mode */
body.dark-mode #screen-interesting .rate-row-item {
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

body.dark-mode #screen-interesting .rate-row-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

body.dark-mode #screen-interesting .rate-item-glass {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

#screen-interesting .rate-item-glass span {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 500;
    color: var(--claude-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

#screen-interesting .rate-item-glass b {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    font-weight: 600;
    color: var(--claude-text-primary);
}

/* === Аккордеон калькулятора === */
#screen-interesting .calc-accordion {
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 20px;
}

#screen-interesting .calc-accordion-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    cursor: pointer;
    transition: background 0.2s ease;
    user-select: none;
}

#screen-interesting .calc-accordion-header:hover {
    background: rgba(255, 255, 255, 0.3);
}

body.dark-mode #screen-interesting .calc-accordion-header:hover {
    background: rgba(255, 255, 255, 0.05);
}

#screen-interesting .calc-accordion-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

#screen-interesting .calc-accordion-icon {
    width: 40px;
    height: 40px;
    background: var(--claude-accent-subtle);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

#screen-interesting .calc-accordion-title {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 600;
    color: var(--claude-text-primary);
}

#screen-interesting .calc-accordion-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--claude-text-secondary);
    margin-top: 2px;
}

#screen-interesting .calc-accordion-badge {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: linear-gradient(135deg, #34495e, #2c3e50);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
}

#screen-interesting .calc-accordion-arrow {
    width: 24px;
    height: 24px;
    color: var(--claude-text-secondary);
    transition: transform 0.3s ease;
}

#screen-interesting .calc-accordion.open .calc-accordion-arrow {
    transform: rotate(180deg);
}

#screen-interesting .calc-accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    padding: 0 20px;
}

#screen-interesting .calc-accordion.open .calc-accordion-content {
    max-height: 2000px;
    padding: 0 20px 20px;
}

/* Поле ввода суммы в калькуляторе */
#screen-interesting .glass-input-wrapper {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.8);
    border-radius: 16px;
    padding: 16px 20px;
    margin-bottom: 16px;
    transition: all 0.2s ease;
}

body.dark-mode #screen-interesting .glass-input-wrapper {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
}

#screen-interesting .glass-input-wrapper:focus-within {
    border-color: var(--claude-accent);
    box-shadow: 0 0 0 3px var(--claude-accent-subtle);
}

#screen-interesting .glass-input-wrapper .input-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--claude-text-secondary);
    margin-bottom: 8px;
    display: block;
}

#screen-interesting .glass-input-wrapper input {
    width: 100%;
    border: none;
    background: transparent;
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    font-weight: 500;
    color: var(--claude-text-primary);
    outline: none;
}

#screen-interesting .glass-input-wrapper input::placeholder {
    color: var(--claude-text-secondary);
    opacity: 0.5;
}

/* Сегментированный переключатель налога */
#screen-interesting .tax-segmented-control {
    display: flex;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 16px;
    gap: 4px;
}

body.dark-mode #screen-interesting .tax-segmented-control {
    background: rgba(255, 255, 255, 0.08);
}

#screen-interesting .tax-segmented-control .tax-segment {
    flex: 1;
    padding: 10px 12px;
    border: none;
    background: transparent;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: var(--claude-text-secondary);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

#screen-interesting .tax-segmented-control .tax-segment.active {
    background: white;
    color: var(--claude-text-primary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

body.dark-mode #screen-interesting .tax-segmented-control .tax-segment.active {
    background: rgba(255, 255, 255, 0.15);
    color: var(--claude-text-primary);
}

/* Информационный текст */
#screen-interesting .calc-info-text {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--claude-text-secondary);
    text-align: center;
    line-height: 1.6;
    padding: 12px 16px;
    background: var(--claude-accent-subtle);
    border-radius: 12px;
    margin-bottom: 16px;
    border-left: 3px solid var(--claude-accent);
}

/* Заголовки таблицы в калькуляторе */
#screen-interesting .calc-table-header {
    display: grid;
    grid-template-columns: 1fr 70px 100px;
    gap: 8px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    margin-bottom: 8px;
}

body.dark-mode #screen-interesting .calc-table-header {
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

#screen-interesting .calc-table-header span {
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--claude-text-secondary);
}

#screen-interesting .calc-table-header span:nth-child(2),
#screen-interesting .calc-table-header span:nth-child(3) {
    text-align: center;
}

/* Кнопка сброса */
#screen-interesting .btn-reset-glass {
    width: 100%;
    padding: 14px;
    border: 1px dashed rgba(0, 0, 0, 0.15);
    background: transparent;
    border-radius: 14px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--claude-text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 16px;
    transition: all 0.2s ease;
}

#screen-interesting .btn-reset-glass:hover {
    border-color: var(--claude-accent);
    color: var(--claude-accent);
    background: var(--claude-accent-subtle);
}

body.dark-mode #screen-interesting .btn-reset-glass {
    border-color: rgba(255, 255, 255, 0.15);
}

/* Блок результатов */
#screen-interesting .results-glass-container {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 16px;
    padding: 16px;
    margin-top: 20px;
    border: 1px solid rgba(255, 255, 255, 0.6);
}

body.dark-mode #screen-interesting .results-glass-container {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

#screen-interesting .results-glass-title {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: var(--claude-accent);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

#screen-interesting .results-glass-footer {
    text-align: right;
    padding-top: 12px;
    margin-top: 12px;
    border-top: 1px dashed rgba(0, 0, 0, 0.1);
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--claude-text-primary);
}

body.dark-mode #screen-interesting .results-glass-footer {
    border-top-color: rgba(255, 255, 255, 0.1);
}

/* ========== END: ИНТЕРЕСНОЕ GLASSMORPHISM ========== */

        /* ========================================================================
   ПОРТФЕЛЬ - GLASSMORPHISM REDESIGN (Claude AI Style)
   ======================================================================== */

/* === Основной контейнер экрана Портфель === */
#screen-portfolio {
    position: relative;
    background: linear-gradient(180deg, var(--claude-bg-base) 0%, #EDE9E6 100%);
    min-height: 100vh;
    margin: -16px;
    padding: 20px 16px 140px 16px;
}

body.dark-mode #screen-portfolio {
    background: linear-gradient(180deg, #0f172a 0%, #1a1a2e 100%);
}

/* Динамическое свечение фона */
#screen-portfolio::before {
    content: '';
    position: fixed;
    top: -30%;
    left: -30%;
    width: 160%;
    height: 160%;
    background: 
        radial-gradient(circle at 25% 25%, rgba(217, 119, 87, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(94, 123, 163, 0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
    animation: portfolioGlow 10s ease-in-out infinite;
}

@keyframes portfolioGlow {
    0%, 100% { opacity: 0.5; transform: scale(1) rotate(0deg); }
    50% { opacity: 0.8; transform: scale(1.02) rotate(1deg); }
}

#screen-portfolio > * {
    position: relative;
    z-index: 1;
}

/* === Заголовок экрана === */
#screen-portfolio .header {
    padding: 10px 0 25px;
    text-align: left;
}

#screen-portfolio .header h1 {
    font-family: 'Inter', sans-serif;
    font-size: 38px;
    font-weight: 700;
    letter-spacing: -0.04em;
    color: var(--claude-text-primary);
    margin: 0;
}




/* === Section Headers (Заголовки разделов) === */
.portfolio-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    margin: 24px 0 12px;
    background: var(--claude-glass);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.portfolio-section-header:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
}

.portfolio-section-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.portfolio-section-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

/* 1. Скрываем иконку (щит) только для раздела Облигаций (Денежный поток) */
.portfolio-section-icon.bonds {
    display: none !important;
}


.portfolio-section-icon.stocks {
    background: rgba(46, 139, 87, 0.15);
}

.portfolio-section-title {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--claude-text-primary);
}

.portfolio-section-subtitle {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--claude-text-secondary);
    margin-top: 2px;
}

.portfolio-section-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 20px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
}

.portfolio-section-badge.bonds {
    background: rgba(94, 123, 163, 0.12);
    color: #5E7BA3;
}

.portfolio-section-badge.stocks {
    background: rgba(46, 139, 87, 0.12);
    color: #2E8B57;
}

/* === Accordion Lists (Интерактивные списки) === */
.portfolio-list {
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 16px;
}

.portfolio-list-item {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: background 0.2s ease;
}

body.dark-mode .portfolio-list-item {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

.portfolio-list-item:last-child {
    border-bottom: none;
}

.portfolio-list-item:hover {
    background: rgba(255, 255, 255, 0.3);
}

body.dark-mode .portfolio-list-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* Свёрнутая строка */
.list-item-summary {
    display: grid;
    /* Grid-шаблон по промту: 85px, гибкая, 75px, 80px */
    grid-template-columns: 85px 1fr 75px 80px;
    align-items: center;
    gap: 0; /* Убираем gap, так как ширину задаем колонками */
    padding: 12px; /* Отступы по промту */
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.list-item-ticker {
    font-family: 'Inter', sans-serif;
    font-size: 14px; /* По промту */
    font-weight: 700; /* Bold */
    color: var(--claude-text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Троеточие */
    text-align: left;
}

.list-item-yield {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 8px; /* Внутренние отступы */
    border-radius: 8px; /* Скругление */
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; /* По промту */
    font-weight: 800; /* Extra Bold */
    justify-self: center; /* Центрирование внутри grid-ячейки */
    width: fit-content;
}

.list-item-yield.bonds {
    background: rgba(94, 123, 163, 0.15);
    color: #5E7BA3;
}

.list-item-yield.stocks {
    background: rgba(46, 139, 87, 0.15);
    color: #2E8B57;
}

.list-item-qty {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 700; /* Bold */
    color: var(--claude-accent);
    text-align: right;
    padding-right: 8px; /* Отступ справа */
}

.list-item-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 500; /* Medium */
    color: var(--claude-text-primary);
    text-align: right;
}
/* Развёрнутая детальная карточка */
.list-item-details {
            grid-column: 1 / -1; /* Занимает всю ширину */
            display: none;
            padding: 12px !important; /* Отступ 12px */
            border-top: 1px solid rgba(0,0,0,0.05) !important; /* Линия сверху */
            font-size: 11px !important;
            line-height: 1.8 !important;
            animation: slideDown 0.3s ease;
            cursor: default; /* Чтобы клик по деталям не сворачивал их случайно */
        }
body.dark-mode .list-item-details {
    background: rgba(255, 255, 255, 0.03);
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.portfolio-list-item.expanded .list-item-details {
    display: block;
}

.details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

 /* Строка данных */
        .details-row {
            display: flex !important;
            justify-content: space-between !important;
            padding: 2px 0 !important; /* Вертикальный отступ */
            border-bottom: 1px dashed rgba(0,0,0,0.05) !important; /* Пунктир снизу */
            background: transparent !important; /* Убираем фон */
            border-radius: 0 !important;
        }

body.dark-mode .details-row {
    background: rgba(255, 255, 255, 0.05);
}

/* Левая часть (Метка) */
        .details-row-label {
            font-family: 'Inter', sans-serif;
            font-weight: 400 !important; /* Обычное начертание */
            color: var(--claude-text-secondary);
        }

/* Правая часть (Значение) */
        .details-row-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600 !important; /* Semi-Bold */
            color: var(--claude-text-primary);
            text-align: right;
        }

.details-actions {
    display: flex;
    gap: 10px;
}

/* Кнопка действия */
        .details-btn {
            width: 100% !important;
            margin-top: 8px !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            font-size: 10px !important;
            font-weight: 700 !important; /* Bold */
            border: none !important;
            cursor: pointer;
            transition: opacity 0.2s;
            
            /* Цвета берем из переменных, не меняем жестко */
            background: var(--claude-accent) !important; 
            color: white !important;
        }
        
        .details-btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

.details-btn.primary {
    background: var(--claude-accent);
    color: white;
}

.details-btn.secondary {
    background: rgba(0, 0, 0, 0.05);
    color: var(--claude-text-primary);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

body.dark-mode .details-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.15);
}

.details-btn svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

                /* ========== СТИЛЬ ДЛЯ ПОДСВЕТКИ ТИКЕРА/ISIN ========== */
        .detail-ticker-highlight {
            color: var(--accent-blue) !important;
            font-weight: 700 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: flex-end !important;
            gap: 6px !important;
            cursor: pointer !important;
            transition: opacity 0.2s;
        }
        
        .detail-ticker-highlight:active {
            opacity: 0.6;
            transform: scale(0.98);
        }

        .detail-ticker-highlight svg {
            width: 12px; 
            height: 12px;
            stroke-width: 2.5;
        }
        /* ===================================================== */



/* === Echelon Headers (Заголовки эшелонов) === */
.echelon-header-new {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    margin: 20px 0 8px;
    background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(255,255,255,0.5));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--claude-glass-border);
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

body.dark-mode .echelon-header-new {
    background: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(30,41,59,0.5));
}

.echelon-header-new:hover {
    transform: translateY(-1px);
}

.echelon-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ========== НОВЫЙ СТИЛЬ ЭШЕЛОНОВ (КАК В РЕБАЛАНСИРОВКЕ) ========== */
        .echelon-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px !important;
            font-weight: 800 !important;
            
            /* Делаем их белыми с рамкой, как "таблетки" в таблице */
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Цвета для каждого эшелона (текст + рамка + тень) */
        .echelon-number.e1 { 
            color: #27ae60 !important; 
            border-color: #2ecc71 !important; 
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.2); 
        }
        
        .echelon-number.e2 { 
            color: #2980b9 !important; 
            border-color: #3498db !important; 
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2); 
        }
        
        .echelon-number.e3 { 
            color: #f39c12 !important; /* Желтый потемнее для читаемости */
            border-color: #f1c40f !important; 
            box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2); 
        }
        
        .echelon-number.e4 { 
            color: #d35400 !important; 
            border-color: #e67e22 !important; 
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2); 
        }

        /* Адаптация для темной темы */
        body.dark-mode .echelon-number {
            background: rgba(30, 41, 59, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.1);
        }
        /* ========================================================= */

.echelon-title-new {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--claude-text-primary);
}

.echelon-header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.echelon-sum {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    color: var(--claude-text-secondary);
}

.echelon-percent-badge {
    padding: 4px 10px;
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    background: rgba(46, 139, 87, 0.12);
    color: #2E8B57;
}

.echelon-info-icon {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--claude-text-secondary);
    font-size: 12px;
    font-weight: 700;
}

/* Подсказка эшелона */
.echelon-info-tooltip {
    display: none;
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--claude-accent);
    border-radius: 14px;
    padding: 14px 18px;
    margin-bottom: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    line-height: 1.6;
    color: var(--claude-text-primary);
    animation: fadeIn 0.3s ease;
}

.echelon-info-tooltip.show {
    display: block;
}

/* Заголовки столбцов для эшелона */
.echelon-columns-header {
    display: grid;
    /* Сетка должна совпадать со строками: 85px 1fr 75px 80px */
    grid-template-columns: 85px 1fr 75px 80px;
    gap: 0;
    padding: 10px 12px; /* Паддинг как у строк */
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--claude-text-secondary);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

/* Выравнивание заголовков */
.echelon-columns-header span:nth-child(1) { text-align: left; }
.echelon-columns-header span:nth-child(2) { text-align: center; }
.echelon-columns-header span:nth-child(3) { text-align: right; padding-right: 8px; }
.echelon-columns-header span:nth-child(4) { text-align: right; }

body.dark-mode .echelon-columns-header {
    border-bottom-color: rgba(255, 255, 255, 0.08);
}

.echelon-columns-header span:nth-child(2),
.echelon-columns-header span:nth-child(3) {
    text-align: center;
}

.echelon-columns-header span:last-child {
    text-align: right;
}

/* === Action Panel (Sticky панель действий) === */
        .portfolio-action-panel {
            position: fixed;
            bottom: 90px;
            
            /* ЖЕСТКОЕ ЦЕНТРИРОВАНИЕ */
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 92% !important; /* Ширина 92% от экрана */
            max-width: 400px !important; /* Но не шире 400px */
            right: auto !important; /* Сбрасываем right */
            
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            
            background: var(--claude-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--claude-glass-border);
            border-radius: 20px;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 800;
        }


        .action-btn {
            flex: 0 1 150px; /* Фиксированная ширина вместо растягивания */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px; /* Сделали кнопку тоньше (было 16px) */
            border: none;
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }


.action-btn.primary {
    background: linear-gradient(135deg, #2C364C, #3a4a66);
    color: white;
    box-shadow: 0 4px 15px rgba(44, 54, 76, 0.3);
}

.action-btn.secondary {
    background: rgba(255, 255, 255, 0.8);
    color: var(--claude-text-primary);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

body.dark-mode .action-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.15);
}

.action-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.action-btn:active {
    transform: scale(0.98);
}

/* === Coupon Rain Box (Купонный дождь) - обновлённый стиль === */
.coupon-box-new {
    background: var(--claude-glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(94, 123, 163, 0.3);
    border-radius: 20px;
    overflow: hidden;
    margin: 16px 0;
}

.coupon-header-new {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    background: rgba(94, 123, 163, 0.08);
    cursor: pointer;
    transition: background 0.2s ease;
}

.coupon-header-new:hover {
    background: rgba(94, 123, 163, 0.12);
}

.coupon-header-left {
    display: flex;
    align-items: center;
    gap: 14px;
}

.coupon-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    background: linear-gradient(135deg, #5E7BA3, #7B9BBF);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
}

.coupon-title-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.coupon-title-new {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--claude-text-primary);
}

.coupon-subtitle-new {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: var(--claude-text-secondary);
}

.coupon-arrow-new {
    width: 24px;
    height: 24px;
    color: #5E7BA3;
    transition: transform 0.3s ease;
}

.coupon-box-new.open .coupon-arrow-new {
    transform: rotate(180deg);
}

.coupon-content-new {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    padding: 0 20px;
}

.coupon-box-new.open .coupon-content-new {
    max-height: 1000px;
    padding: 0 20px 20px;
}

/* === Footer Disclaimer (обновлённый) === */
.portfolio-disclaimer {
    background: linear-gradient(135deg, rgba(46, 139, 87, 0.08), rgba(46, 139, 87, 0.03));
    border: 1px solid rgba(46, 139, 87, 0.15);
    border-left: 4px solid #2E8B57;
    border-radius: 16px;
    padding: 20px;
    margin: 24px 0;
}

.disclaimer-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.disclaimer-header svg {
    width: 20px;
    height: 20px;
    stroke: #2E8B57;
}

.disclaimer-title {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: #2E8B57;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.disclaimer-text {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    line-height: 1.6;
    color: var(--claude-text-primary);
}

/* === Empty State === */
.portfolio-empty-new {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    text-align: center;
    padding: 40px 20px;
}

.empty-icon {
    width: 80px;
    height: 80px;
    border-radius: 24px;
    background: var(--claude-glass);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin-bottom: 24px;
    border: 1px solid var(--claude-glass-border);
}

.empty-title {
    font-family: 'Inter', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--claude-text-primary);
    margin-bottom: 8px;
}

.empty-text {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--claude-text-secondary);
    line-height: 1.6;
    margin-bottom: 24px;
}

.empty-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 32px;
    background: linear-gradient(135deg, #2C364C, #3a4a66);
    color: white;
    border: none;
    border-radius: 14px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(44, 54, 76, 0.3);
    transition: all 0.2s ease;
}

.empty-btn:active {
    transform: scale(0.98);
}

.empty-btn svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
}
        /* =========================================
   ГЛОБАЛЬНЫЙ СТИЛЬ ДЛЯ ЦИФР (JetBrains Mono)
   ========================================= */

/* 1. Поля ввода */
input, 
.calc-input,
textarea {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 2. Рыночные данные и дашборд (Интересное) */
.mk-val, 
.mk-dynamics,
.market-tile-value,
.market-tile-change,
.rv-item b,
.rate-row-value,
.rate-item-glass b {
    font-family: 'JetBrains Mono', monospace !important;
    letter-spacing: -0.03em;
}

/* 3. Калькулятор и Стратегии */
.strategy-percent-row,
.custom-value-bonds,
.custom-value-stocks,
.custom-slider-label span, /* проценты в слайдере */
.fee-item-rate,
.fee-selected-text:not(.placeholder), /* выбранная комиссия */
#sumInput,
#monthlySumInput,
.currency {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 4. Портфель: Главная карточка и Прогноз */
.portfolio-card-value,
.portfolio-fee-badge,
.forecast-item-value,
.forecast-total-value,
.portfolio-section-badge,
#summ-invested,
#summ-total-3y,
#summ-bond-income,
#summ-stock-growth {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 5. Списки (Облигации, Акции, Купоны) */
.list-item-yield,
.list-item-qty,
.list-item-sum,
.details-row-value,
.ofz-price,
.ofz-nkd-badge,
.ofz-yield-badge,
.ofz-detail-val,
.ub-yield,
.ub-price,
.echelon-sum,
.echelon-percent-badge,
.et-price,
.et-detail-value,
.et-target {
    font-family: 'JetBrains Mono', monospace !important;
}

/* 6. Таблицы (Купонный дождь, Выплаты) */
.coupon-row b,
.coupon-row div:nth-child(3), /* Колонка количества */
.coupon-row div:nth-child(4), /* Колонка суммы */
#couponTotalHeader,
.echelon-number {
    font-family: 'JetBrains Mono', monospace !important;
}



        /* ===== PORTFOLIO MAIN CARD - ORIGINAL DESIGN ===== */
.portfolio-main-card {
    background: var(--card-bg) !important;
    border-radius: 28px !important;
    padding: 0 !important;
    margin-bottom: 20px !important;
    box-shadow: 0 8px 25px var(--card-shadow) !important;
    border: 1px solid var(--border-color) !important;
    overflow: visible !important;
    position: relative !important;
}

.stm-header {
    padding: 24px 20px 10px !important;
    text-align: center !important;
    background: transparent !important;
    display: block !important;
}

.stm-header-label {
    font-size: 10px !important;
    color: var(--text-secondary) !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 1.2px !important;
    margin-bottom: 10px !important;
    display: block !important;
    opacity: 0.7 !important;
}

.stm-val-big {
    font-family: 'JetBrains Mono', monospace !important;
    font-size: 36px !important;
    font-weight: 700 !important;
    color: var(--text-main) !important;
    line-height: 1 !important;
    display: block !important;
    letter-spacing: -0.02em !important;
}

.stm-bar-container {
    display: flex !important;
    height: 8px !important;
    margin: 16px 24px 0 24px !important;
    border-radius: 4px !important;
    overflow: hidden !important;
}


.stm-bar-bonds {
    background: linear-gradient(90deg, #5E7BA3, #7B9BBF) !important;
    transition: width 0.5s ease !important;
}

.stm-bar-stocks {
    background: linear-gradient(90deg, #E8956A, #D97757) !important;
    transition: width 0.5s ease !important;
}

.stm-meta-row {
    padding: 10px 24px 16px !important;
    display: block !important;
}


.stm-pct-labels {
    display: flex !important;
    justify-content: space-between !important;
    font-size: 10px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

.stm-pl-bond {
    color: #5E7BA3 !important;
    display: block !important;
}

.stm-pl-stock {
    color: #D97757 !important;
    display: block !important;
}

.portfolio-forecast {
    background: rgba(46, 139, 87, 0.06) !important;
    border: 1px solid rgba(46, 139, 87, 0.12) !important;
    border-radius: 16px !important;
    padding: 16px !important;
    margin: 0 20px 20px 20px !important;
}

.forecast-title {
    font-family: 'Inter', sans-serif !important;
    font-size: 9px !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.15em !important;
    color: #2E8B57 !important;
    margin-bottom: 12px !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    opacity: 0.8 !important;
}

.forecast-grid {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 16px !important;
    margin-bottom: 14px !important;
}

/* Цифры внутри карточек (Купоны, Переоценка) */
.forecast-item-value {
    font-family: 'JetBrains Mono', monospace !important;
    font-weight: 600 !important;
    margin-bottom: 4px !important;
    letter-spacing: -0.03em !important; /* Чуть сжимаем расстояние между буквами */
    
    /* ДИНАМИЧЕСКИЙ РАЗМЕР: */
    /* Минимум 11px, в идеале 4% от ширины экрана, Максимум 17px */
    font-size: clamp(11px, 4vw, 17px) !important;
    
    /* ЗАПРЕТ ПЕРЕНОСА СТРОК: */
    white-space: nowrap !important; 
    
    /* Если цифра всё равно гигантская, она не вылезет за рамки, а обрежется (опционально) */
    overflow: hidden; 
    text-overflow: clip; 
}

.forecast-item-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;
    color: var(--text-secondary) !important;
    margin-top: 6px !important;
    margin-bottom: 1px !important;
    font-weight: 500 !important;
}

.forecast-item-sub {
    font-family: 'Inter', sans-serif !important;
    font-size: 9px !important;
    color: var(--text-secondary) !important;
    opacity: 0.7 !important;
}

.forecast-total {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding-top: 12px !important;
    border-top: 1px dashed rgba(46, 139, 87, 0.2) !important;
}

.forecast-total-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    color: var(--text-main) !important;
}

/* Итоговая цифра "Цель" */
.forecast-total-value {
    font-family: 'JetBrains Mono', monospace !important;
    font-weight: 800 !important; /* Сделали чуть жирнее */
    color: #2E8B57 !important;
    letter-spacing: -0.03em !important;
    
    /* ДИНАМИЧЕСКИЙ РАЗМЕР: */
    /* Минимум 13px, в идеале 5% от ширины экрана, Максимум 20px */
    font-size: clamp(13px, 5vw, 20px) !important;
    
    white-space: nowrap !important;
}

                /* ========== НОВЫЕ СТИЛИ ДЛЯ ГЛАВНОЙ СТРАНИЦЫ (ВШИТОЕ МЕНЮ) ========== */

         body.home-mode {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden !important;
            padding: 0 !important; 
            margin: 0 !important;
            background: transparent !important; /* На всякий случай убираем фон у body */
        }

        /* Исправление белой полосы тут: min-height: 100vh */
        body.home-mode .welcome-screen {
            margin: 0 !important;
            width: 100% !important;
            min-height: 100vh !important; /* Растягиваем фон на ВЕСЬ экран */
            height: 100% !important;
            border-radius: 0 !important;
            box-sizing: border-box;
            padding-bottom: 0 !important; /* Убираем нижний отступ, если был */
        }

         /* --- МАГИЯ ЗДЕСЬ: ДВИГАЕМ ТОЛЬКО ВЕРХ --- */
        body.home-mode .welcome-logo-block {
            /* Поднимаем логотип вверх визуально */
            /* -15vh означает "поднять на 15% высоты экрана" */
            /* Кнопка при этом останется на месте, так как transform не толкает соседей */
            transform: translateY(-8vh) !important; 
        }

        /* Кнопку оставляем как есть */
        body.home-mode .welcome-cta-block {
            margin: 0 !important; 
            transform: none !important; /* Гарантируем, что кнопка не сдвинется */
        }
        
        /* Когда мы на главной (home-mode), убираем фон, границы и тени у "дока" с кнопками */
        body.home-mode .nav-dock {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            gap: 25px; /* Немного увеличим расстояние между кнопками для красоты */
        }

        /* То же самое для кнопки поиска (Лупы) */
        body.home-mode .nav-search-btn {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
        }

        /* Скрываем кнопку "Домик" на главной странице */
        body.home-mode #nav-home {
            display: none !important;
        }

        /* Делаем иконки чуть более явными на фоне, если нужно (опционально) */
        body.home-mode .nav-item, 
        body.home-mode .nav-search-btn {
            color: var(--text-secondary); /* Или любой цвет, который хорошо смотрится на твоем фоне */
            opacity: 0.8;
        }
        
        /* Активная иконка на главной пусть выделяется */
        body.home-mode .nav-item.active {
            background: transparent !important;
            color: var(--text-main) !important;
            transform: scale(1.1);
        }
        /* ========== КОНЕЦ НОВЫХ СТИЛЕЙ ========== */

         /* ========== ФОН ДЛЯ СТРАНИЦЫ РЕБАЛАНСИРОВКИ (КАК НА ГЛАВНОЙ) ========== */
        
        #screen-assets {
            /* 1. Копируем градиент с главной страницы (Светлая тема) */
            background: linear-gradient(90deg, #F5F1EE 0%, #F9FAFC 100%);
            
            /* 2. Растягиваем фон на весь экран (компенсируем отступы body) */
            margin: -16px; /* "Вылезаем" за границы стандартного отступа */
            min-height: 100vh; /* Высота на весь экран */
            
            /* 3. Добавляем внутренние отступы, чтобы контент не прилипал к краям */
            padding: 20px 16px 120px 16px; /* Сверху 20, бока 16, снизу 120 (место для меню) */
            
            /* Убеждаемся, что этот фон перекрывает всё */
            position: relative;
            z-index: 1;
        }

        /* 4. Копируем градиент для ТЕМНОЙ темы */
        body.dark-mode #screen-assets {
            background: linear-gradient(90deg, #1a2234 0%, #0f172a 100%);
        }
        
        /* ====================================================================== */

                                      /* ========== УЛЬТРА-ФИНАЛ: ЦЕНТРОВКА И РУБЛИ ========== */
        
        .input-wrapper {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            position: relative;
            width: 100% !important;
            margin: 20px 0 10px 0 !important;
        }

        /* Линия подчеркивания */
        .input-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 1px;
            background: rgba(44, 54, 76, 0.15) !important;
        }

        /* Поле ввода */
        input#sumInput {
            caret-color: transparent !important;
            color: var(--text-main) !important;
            background: transparent !important;
            border: none !important;
            outline: none !important;
            
            /* АВТО-ШИРИНА ЧЕРЕЗ GRID-ХАК */
            width: auto !important;
            min-width: 10px; 
            max-width: 200px;
            
            text-align: right !important; /* Цифры жмутся вправо к курсору */
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Плейсхолдер - выравниваем по центру */
        
        /* Плейсхолдер - центрируем */
        input#sumInput::placeholder {
            color: #bdc3c7 !important;
            font-family: 'Inter', sans-serif !important; /* Для текста Inter лучше, чем Mono */
            font-size: 18px !important; /* Уменьшим размер для длинной фразы */
            font-weight: 600;
            letter-spacing: 1px;
            opacity: 1 !important;
            text-align: center !important; /* Центрируем текст */
        }
                /* Когда начинаем вводить (плейсхолдер исчез) - жмем вправо к курсору */
        input#sumInput:not(:placeholder-shown) {
            text-align: right !important;
        }


        /* КУРСОР */
                /* 1. По умолчанию курсор скрыт */
        .custom-cursor {
            width: 3px !important;
            height: 42px !important;
            border-radius: 2px !important;
            background: linear-gradient(to bottom, #FFD700, #0ea5e9, #b5985a) !important;
            background-size: 100% 200% !important;
            margin: 0 4px 0 2px !important; 
            display: none; /* Скрыт */
            animation: shimmerBlink 1s infinite !important;
            flex-shrink: 0 !important;
        }

        /* 2. Показываем курсор, если в поле ПУСТО (виден плейсхолдер) */
        input#sumInput:placeholder-shown + #customCursor {
            display: block !important;
        }

        /* 3. Показываем курсор, если поле В ФОКУСЕ (вы нажали на него) */
        input#sumInput:focus + #customCursor {
            display: block !important;
        }


        /* ЗОЛОТОЙ РУБЛЬ (Показываем, когда есть текст) */
        .currency { 
            font-family: 'JetBrains Mono', monospace;
            font-size: 42px; 
            color: #b5985a !important;
            text-shadow: 0 0 10px rgba(181, 152, 90, 0.3);
            font-weight: 500;
            opacity: 1 !important;
            display: none; /* Изначально скрыт */
        }
        
        /* СЕРЫЙ РУБЛЬ (Показываем, когда пусто) */
        .currency-placeholder {
            font-family: 'JetBrains Mono', monospace;
            font-size: 42px; 
            color: #bdc3c7 !important;
            font-weight: 500;
            opacity: 1 !important;
            display: block; /* Изначально виден */
        }

        /* ТЕМНАЯ ТЕМА */
        body.dark-mode .currency { color: #d4af37 !important; }
        body.dark-mode .currency-placeholder { color: #475569 !important; }
        /* ===================================================== */

                /* ========== ФИКС КУРСОРА И АНИМАЦИИ ========== */
        
        /* 1. Сама анимация (должна быть обязательно) */
        @keyframes shimmerBlink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* 2. Стиль курсора */
        .custom-cursor {
            width: 3px !important;
            height: 42px !important;
            border-radius: 2px !important;
            
            /* Градиент */
            background: linear-gradient(to bottom, #FFD700, #0ea5e9, #b5985a) !important;
            background-size: 100% 200% !important;
            
            /* Отступы: 0 сверху, 4px справа, 0 снизу, 2px слева */
            margin: 0 4px 0 2px !important; 
            
            /* Принудительная анимация */
            animation: shimmerBlink 1s infinite !important;
            
            /* Важно: flex-shrink, чтобы его не сжимало */
            flex-shrink: 0 !important;
            
            /* Изначально скрыт, JS его включит */
            display: none; 
        }
        
        /* 3. Центровка плейсхолдера */
        input#sumInput::placeholder {
            text-align: center !important;
            color: #bdc3c7 !important;
        }
        
        /* 4. Центровка текста при вводе (прижимаем к курсору) */
        input#sumInput:not(:placeholder-shown) {
            text-align: right !important;
        }
/* =========================================
   GHOST SLIDER & WATERFALL STYLES (NEW)
   ========================================= */

/* 1. Контейнер с перспективой для 3D эффекта */
.strategy-perspective-wrapper {
    perspective: 1000px;
    margin-top: 15px;
    position: relative;
    z-index: 10;
}

/* 2. Основная (выбранная) карточка */
.main-selected-card {
    background: #ffffff;
    border-radius: 20px;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    border: 1.5px solid var(--accent-blue);
    position: relative;
    z-index: 20;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s ease;
    cursor: default;
}

/* Эффект нажатия на главную карточку */
.main-selected-card:active {
    transform: scale(0.98);
}

.dark-mode .main-selected-card {
    background: #1e293b;
    border-color: var(--accent-blue);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

/* 3. Контейнер для скрытых карточек (Waterfall) */
.waterfall-container {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    margin-top: 0; /* Прижато к верхней карте */
    position: relative;
}

.waterfall-container.show {
    grid-template-rows: 1fr;
    margin-top: 15px; /* Отступ когда раскрыто */
}

.waterfall-inner {
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Стили скрытых карточек */
.strategy-option-card {
    opacity: 0;
    transform: translateY(-30px) scale(0.95) rotateX(-5deg);
    filter: blur(8px);
    transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 14px 18px;
    border: 1px solid rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}

.dark-mode .strategy-option-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.05);
}

/* Активное состояние опции в списке */
.strategy-option-card.selected-in-list {
    background: #fff;
    border-color: var(--accent-blue);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
}

.dark-mode .strategy-option-card.selected-in-list {
    background: #2d3748;
}

/* Анимация появления (Waterfall delay) */
.waterfall-container.show .strategy-option-card {
    opacity: 1;
    transform: translateY(0) scale(1) rotateX(0);
    filter: blur(0);
}

/* Задержки для каждой карточки */
.waterfall-container.show .strategy-option-card:nth-child(1) { transition-delay: 0.05s; }
.waterfall-container.show .strategy-option-card:nth-child(2) { transition-delay: 0.1s; }
.waterfall-container.show .strategy-option-card:nth-child(3) { transition-delay: 0.15s; }
.waterfall-container.show .strategy-option-card:nth-child(4) { transition-delay: 0.2s; }
.waterfall-container.show .strategy-option-card:nth-child(5) { transition-delay: 0.25s; }

/* 4. GHOST SLIDER (Триггер) */
.ghost-trigger-wrapper {
    margin-top: 20px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 10px;
    transition: opacity 0.3s;
}

.ghost-trigger-wrapper:active {
    opacity: 0.6;
}

/* Линия с шиммером */
.ghost-line {
    width: 40px;
    height: 3px;
    background: #E2E8F0;
    border-radius: 2px;
    position: relative;
    overflow: hidden;
    margin-bottom: 8px;
}

.dark-mode .ghost-line { background: #334155; }

/* Анимация блика */
.ghost-line::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    transform: translateX(-100%);
    animation: ghostShimmer 2.5s infinite;
}

@keyframes ghostShimmer {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
}

.ghost-text {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px; /* Увеличенный трекинг */
    color: #94A3B8;
    margin-bottom: 4px;
    transition: color 0.3s;
}

.ghost-dots {
    display: flex;
    gap: 4px;
}

.ghost-dot {
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background: #CBD5E1;
    transition: all 0.3s;
}

/* Состояние "Открыто" для триггера */
.ghost-trigger-wrapper.open .ghost-text {
    color: var(--accent-blue);
}
.ghost-trigger-wrapper.open .ghost-dot {
    background: var(--accent-blue);
    transform: scale(1.2);
}

/* Внутренности карточек (тексты и бары) */
.card-left-part { display: flex; align-items: center; gap: 14px; }
.card-indicator { width: 4px; height: 32px; border-radius: 2px; flex-shrink: 0; }
.card-titles { display: flex; flex-direction: column; }
.card-main-title { font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 700; color: var(--text-main); }
.card-sub-title { font-family: 'Inter', sans-serif; font-size: 11px; color: #8A9AB0; margin-top: 2px; }
.card-right-part { text-align: right; }
.card-pct-bonds { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; color: var(--bonds-color); }
.card-pct-stocks { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; color: var(--stocks-color); }

/* Скрытие старых элементов, если они где-то остались */
.strategy-cards-container, .strategy-expand-trigger { display: none !important; }

        /* =================================================================
   FEE SELECTOR - QUIET LUXURY DESIGN (CLEAN)
   ================================================================= */

/* 1. Основной контейнер (Слой выше стратегий) */
.fee-selector-unified {
    position: relative;
    margin-top: 20px;
    margin-bottom: 25px;
    z-index: 200; /* Достаточно, чтобы быть выше карт */
}

/* 2. Стеклянная подложка кнопки */
.fee-unified-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    
    /* Эффект дорогого стекла */
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
    transition: transform 0.2s ease;
}

.fee-unified-wrapper:active {
    transform: scale(0.995);
}

.fee-unified-label {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    color: #64748B; /* Спокойный серый */
    font-weight: 500;
}

/* 3. Триггер (сама кнопка "Выбрать") */
.fee-unified-trigger {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 14px;
    background: #FFFFFF;
    border: 1px solid rgba(0, 0, 0, 0.04);
    border-radius: 12px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}

.fee-unified-trigger:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    transform: translateY(-1px);
}

.fee-selected-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 600;
    color: #2C364C;
}

.fee-dropdown-arrow {
    color: #94A3B8;
    transition: transform 0.3s ease;
}

/* 4. Выпадающее меню (Парящее) */
/* 4. Выпадающее меню (Исправленное выравнивание) */
.fee-dropdown-menu {
    position: absolute;
    top: calc(100% + 10px);
    
    /* ИСПРАВЛЕНИЕ СМЕЩЕНИЯ */
    left: 0;
    right: 0;        /* Привязываем сразу к обоим краям */
    width: auto;     /* Автоматическая ширина вместо 100% */
    margin: 0;       /* Убираем любые внешние отступы */
    box-sizing: border-box; /* Важно: отступы внутри не расширяют блок */
    
    /* Материал */
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 24px;
    padding: 8px;
    
    /* Тень левитации */
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12), 0 5px 15px rgba(0,0,0,0.02);
    
    /* Скрыто */
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px) scale(0.98);
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    z-index: 1000;
}


/* Состояние: Открыто */
.fee-dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}

/* 5. Пункты меню */
.fee-dropdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px;
    margin-bottom: 2px;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.fee-dropdown-item:hover {
    background: rgba(44, 54, 76, 0.04);
}

/* Выбранный пункт - Белая плашка */
.fee-dropdown-item.selected {
    background: #FFFFFF;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
}

.fee-item-rate {
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    font-weight: 500;
    color: #2C364C;
}

/* 6. ЛОГИКА ГАЛОЧЕК (Круги) */

/* Базовый: Пустой круг */
.fee-item-check {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    
    /* Тонкая серая линия */
    border: 1.5px solid #CBD5E1;
    background: transparent;
    
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Галочка внутри (скрыта) */
.fee-item-check svg {
    width: 14px;
    height: 14px;
    stroke: white;
    stroke-width: 2.5;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s ease;
}

/* Выбрано: Залитый круг */
.fee-dropdown-item.selected .fee-item-check {
    background: #2C364C; /* Графит */
    border-color: #2C364C;
    transform: scale(1.1);
    box-shadow: 0 4px 10px rgba(44, 54, 76, 0.2);
}

/* Выбрано: Галочка видна */
.fee-dropdown-item.selected .fee-item-check svg {
    opacity: 1;
    transform: scale(1);
}

/* 7. Темная тема */
body.dark-mode .fee-unified-wrapper {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
}
body.dark-mode .fee-unified-trigger {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}
body.dark-mode .fee-selected-text { color: #F1F5F9; }
body.dark-mode .fee-dropdown-menu {
    background: rgba(30, 41, 59, 0.95);
    border-color: rgba(255, 255, 255, 0.1);
}
body.dark-mode .fee-dropdown-item:hover { background: rgba(255, 255, 255, 0.05); }
body.dark-mode .fee-dropdown-item.selected {
    background: rgba(255, 255, 255, 0.1);
    box-shadow: none;
}
body.dark-mode .fee-item-rate { color: #F1F5F9; }
body.dark-mode .fee-item-check { border-color: #475569; }
body.dark-mode .fee-dropdown-item.selected .fee-item-check {
    background: #38BDF8;
    border-color: #38BDF8;
}
body.dark-mode .fee-dropdown-item.selected .fee-item-check svg { stroke: #0F172A; }

        /* =================================================================
   FIX FOR FULLSCREEN MODE (ОТСТУПЫ СВЕРХУ)
   ================================================================= */

/* 1. Заголовки экранов: Портфель, Ребалансировка, Интересное */
.header {
    /* calc(X + Y) складывает наши пиксели и системный отступ телефона */
    padding-top: calc(80px + env(safe-area-inset-top)) !important; 
    padding-bottom: 20px !important;
}

/* 2. Заголовок Терминала (где калькулятор) */
.terminal-header-v2 {
    /* Делаем побольше, чтобы не прилипало к статус-бару */
    padding-top: calc(80px + env(safe-area-inset-top)) !important;
}

/* 3. Экран компании (стрелка назад и тикер) */
.company-top-bar {
    /* Отступ для кнопок навигации внутри компании */
    padding-top: calc(30px + env(safe-area-inset-top)) !important;
    padding-bottom: 10px !important;
}

/* 4. На всякий случай: если на Android safe-area не сработает,
   эти стили гарантируют минимальный отступ */
@supports not (padding-top: env(safe-area-inset-top)) {
    .header { padding-top: 50px !important; }
    .terminal-header-v2 { padding-top: 60px !important; }
    .company-top-bar { padding-top: 30px !important; }
}
 /* ================================================================== */

        /* Подтягиваем нижнюю панель выше */
.bottom-sticky-panel {
    margin-top: 0 !important;   /* Убираем внешний отступ сверху */
    padding-top: 0 !important;  /* Убираем внутренний отступ сверху */
    padding-bottom: 30px !important; /* Немного отступа снизу для красоты */
}

/* Если нужно подтянуть текст подсказки ближе к кнопке */
.sticky-hint {
    margin-top: 8px !important; /* Было 10px, делаем чуть меньше */
}

        /* Стилизация заголовка "Инвестиционная стратегия" под стиль Ghost Text */
.strategy-section .fee-label {
    font-family: 'Inter', sans-serif !important;
    font-size: 10px !important;       /* Размер как у кнопки внизу */
    font-weight: 700 !important;      /* Жирность */
    text-transform: uppercase !important;
    letter-spacing: 2px !important;   /* Широкий интервал между буквами */
    color: #94A3B8 !important;        /* Цвет как у кнопки внизу */
    
    text-align: left !important;    /* Слева текст */
    display: block !important;        /* Чтобы занимал всю ширину */
    width: 100% !important;
    margin-bottom: 15px !important;   /* Отступ до карточки */
    margin-top: 5px !important;
}

        /* =================================================================
   ЕДИНЫЙ СТИЛЬ ЗАГОЛОВКОВ (КАК В ТЕРМИНАЛЕ)
   ================================================================= */

/* 1. Контейнер заголовка */
.header {
    text-align: left !important; /* Выравнивание влево */
    background: transparent !important;
    margin: 0 !important;
    
    /* Точные отступы как у .terminal-header-v2 */
    padding: 40px 10px 10px 10px !important;
    
    /* Учет "челки" телефона (как в терминале) */
    padding-top: calc(80px + env(safe-area-inset-top)) !important;
}

/* 2. Сам текст заголовка (h1) */
.header h1 {
    font-family: 'Inter', sans-serif !important;
    font-weight: 800 !important;
    font-size: 32px !important; /* Размер как у слова Terminal */
    color: #2C364C !important;
    letter-spacing: -0.5px !important;
    line-height: 1.1 !important;
    margin: 0 !important;
    margin-bottom: 6px !important;
}

/* 3. Темная тема */
body.dark-mode .header h1 {
    color: #f1f5f9 !important;
}

        /* Индивидуальный отступ только для вкладки "Интересное" */
#screen-interesting .header {
    /* Меняйте 100px на любое число - чем больше, тем ниже */
    padding-top: calc(100px + env(safe-area-inset-top)) !important;
}
 
/* =================================================================
   LUXURY NOTIFICATION PILL (REVOLUTIONARY DESIGN)
   ================================================================= */

.luxury-notify-pill {
    position: fixed;
    top: 0;
    left: 50%;
    /* Скрыто за верхней границей экрана */
    transform: translate(-50%, -150%);
    
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 10px 24px 10px 10px; /* Слева меньше отступ из-за иконки */
    
    /* Материал: Глубокий матовый графит */
    background: rgba(30, 41, 59, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    
    /* Границы и форма */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 100px; /* Идеальная капсула */
    
    /* Тень: Глубокая и мягкая */
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    
    z-index: 20000; /* Поверх всего */
    
    /* Физическая анимация (Пружина) */
    transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);

    max-width: 85%; /* Чтобы не касаться краев экрана */
    white-space: nowrap; /* Текст в одну строку */

}

/* Состояние ПОКАЗАНО (Исправленный отступ) */
.luxury-notify-pill.show {
    /* 
       env(safe-area-inset-top) = высота "челки"
       + 60px = высота кнопок Telegram + небольшой отступ
    */
    transform: translate(-50%, calc(env(safe-area-inset-top) + 85px)) !important;
}

/* Иконка в кружке */
.notify-icon-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #F87171; /* Элегантный красный */
    flex-shrink: 0;
}

/* Текстовый блок */
.notify-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 2px;
}

.notify-title {
    font-family: 'Inter', sans-serif;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #94A3B8; /* Серый субитог */
}

.notify-message {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: #FFFFFF; /* Белый текст */
    white-space: nowrap;
}

/* Адаптация для Светлой темы (делаем капсулу контрастной) */
/* В светлой теме капсула остается темной для "премиум" акцента */

/* =================================================================
   АНИМАЦИЯ ОШИБКИ (LUXURY SHAKE)
   ================================================================= */

@keyframes shakeLux {
    0%, 100% { transform: translateX(0); }
    15% { transform: translateX(-6px); }
    30% { transform: translateX(6px); }
    45% { transform: translateX(-4px); }
    60% { transform: translateX(4px); }
    75% { transform: translateX(-2px); }
}

.shake-error {
    animation: shakeLux 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
    
    /* ЗОЛОТАЯ РАМКА (Цвет вашего рубля) */
    border-color: #b5985a !important; 
    
    /* Мягкое золотое свечение вокруг */
    box-shadow: 0 0 0 4px rgba(181, 152, 90, 0.2) !important;
    
    /* Легкое затемнение фона для акцента */
    background: rgba(181, 152, 90, 0.05) !important;
}

/* =================================================================
   SWIPE BACK INDICATOR (QUIET LUXURY)
   ================================================================= */

/* Контейнер индикатора (лежит ПОД экраном, но НАД фоном) */
.swipe-back-overlay {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 100px; /* Активная зона слева */
    z-index: 1; /* Ниже активного экрана (z-index активного экрана обычно выше) */
    
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
}

/* Круг со стрелкой */
.sbi-icon-wrapper {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    
    /* Материал: Матовое стекло */
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    
    /* Тень */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Цвет стрелки (Графит) */
    color: #2C364C;
    
    /* Начальное состояние */
    transform: scale(0.5) translateX(-20px);
    opacity: 0;
    transition: transform 0.1s linear, opacity 0.1s linear;
}

/* Активное состояние (когда тянем) */
.swipe-back-overlay.active {
    opacity: 1;
}

/* Темная тема */
body.dark-mode .sbi-icon-wrapper {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
    color: #F1F5F9;
}

/* ВАЖНО: У активного экрана должен быть высокий z-index, 
   чтобы он перекрывал индикатор, пока мы его не сдвинем */
.screen.active {
    z-index: 10 !important;
    background: var(--bg-color); /* Чтобы не просвечивал */
    box-shadow: -10px 0 30px rgba(0,0,0,0.05); /* Тень слева при сдвиге */
}
        
/* ==================================================================== */

        
    </style>
</head>
<body onclick="hideAllTips(event)">

<div id="toast" class="toast">Скопировано!</div>

    <div id="screen-home" class="screen active">
    <div class="welcome-screen">
        <div class="welcome-logo-block">
            <span class="welcome-supratitle">W E A L T H &nbsp; M A N A G E M E N T</span>
            <h1 class="welcome-title">
                <span class="welcome-title-light">Madame </span><span class="welcome-title-bold">Solomi'na</span>
            </h1>
            <div class="welcome-divider"></div>
            <span class="welcome-subtitle">ЧАСТНЫЙ ИНВЕСТИЦИОННЫЙ<br>TERMINAL</span>
            

        </div>
        
        <div class="welcome-cta-block">
            <button class="btn-welcome" onclick="event.stopPropagation(); localStorage.setItem('user_visited', 'true'); document.getElementById('navWrapper').style.display='flex'; document.getElementById('stickyPanel').style.display='block'; showScreen('screen-app');">
            ОТКРЫТЬ Terminal
        </button>
            <div class="welcome-secure-text">
                <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Secure Biometric Access
            </div>
        </div>
    </div>
</div>

   <div id="screen-app" class="screen">
    <!-- Terminal Header -->
    <div class="terminal-header-v2">
        <div class="terminal-title-main">Terminal</div>
        <div class="terminal-subtitle">MADAME SOLOMI'NA • SMART WEALTH</div>
    </div>

    <div class="calc-box" id="calcSection">
        <!-- Ввод суммы -->
        <div class="input-container">

            
                                              <!-- ВЕСЬ БЛОК В ОДНУ СТРОКУ, ЧТОБЫ УБРАТЬ ОТСТУПЫ -->
           <div class="input-wrapper" onclick="document.getElementById('sumInput').focus()" style="display: flex; justify-content: center; align-items: center; width: 100%;"><input type="text" id="sumInput" placeholder="ВВЕДИТЕ СУММУ" oninput="formatSumInput(this)" onfocus="onSumInputFocus(this)" onblur="onSumInputBlur(this)" onclick="event.stopPropagation(); this.select()" onkeyup="if(event.keyCode===13) this.blur()" inputmode="numeric" enterkeyhint="done"><div id="customCursor" class="custom-cursor"></div><span class="currency" id="currencySymbol">₽</span><span class="currency-placeholder" id="currencyPlaceholder">₽</span></div>

            
            </div>


        
       
     <!-- Блок комиссии (Quiet Luxury Fixed) -->
<div class="fee-selector-unified" style="position: relative; z-index: 200;">
    <div class="fee-unified-wrapper">
        <span class="fee-unified-label">Комиссия Вашего Брокера</span>
        
        <div class="fee-unified-trigger" id="feeDropdownTrigger" onclick="event.stopPropagation(); toggleFeeDropdown()">
            <span class="fee-selected-text placeholder" id="feeSelectedText">Выбрать</span>
            <svg class="fee-dropdown-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </div>
    </div>
    
    <!-- Меню с принудительными стилями для теста -->
    <div class="fee-dropdown-menu" id="feeDropdownMenu">
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.0001, '0.01%', '')">
            <span class="fee-item-rate">0.01%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.0003, '0.03%', '')">
            <span class="fee-item-rate">0.03%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.0005, '0.05%', '')">
            <span class="fee-item-rate">0.05%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.001, '0.1%', '')">
            <span class="fee-item-rate">0.1%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.003, '0.3%', '')">
            <span class="fee-item-rate">0.3%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
        
        <div class="fee-dropdown-item" onclick="event.stopPropagation(); selectFee(0.005, '0.5%', '')">
            <span class="fee-item-rate">0.5%</span>
            <div class="fee-item-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        </div>
    </div>
</div>

</div>

        <!-- Белая карточка начинается здесь -->
        <div class="calc-box-white-section">
        <!-- Инвестиционная стратегия -->
<div class="strategy-section" style="margin-top: 8px;">
    <span class="fee-label">Выбор Стратегии</span>
    
    <!-- 3D Wrapper -->
    <div class="strategy-perspective-wrapper">
        
        <!-- 1. ВСЕГДА ВИДИМАЯ КАРТОЧКА (ВЫБРАННАЯ) -->
        <div class="main-selected-card" id="mainSelectedCard" onclick="toggleStrategies()">
            <div class="card-left-part">
                <!-- Цветной индикатор -->
                <div class="card-indicator" id="mainCardIndicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 50%, #94A8B8 50%, #94A8B8 100%);"></div>
                <div class="card-titles">
                    <div class="card-main-title" id="mainCardTitle">Гармония</div>
                    <div class="card-sub-title" id="mainCardSubtitle">Классический баланс</div>
                </div>
            </div>
            <div class="card-right-part">
                <div class="card-pct-bonds" id="mainCardBonds">Обл. 50%</div>
                <div class="card-pct-stocks" id="mainCardStocks">Акц. 50%</div>
            </div>
        </div>

                <!-- 2. WATERFALL КОНТЕЙНЕР (ОБНОВЛЕННЫЙ: ПОЛНАЯ ИНФОРМАЦИЯ) -->
        <div class="waterfall-container" id="waterfallContainer">
            <div class="waterfall-inner">
                
                <!-- Опция 50/50 -->
                <div class="waterfall-inner">
    <div class="strategy-option-card" data-bonds="50" onclick="selectStrategy(50, this, 'Гармония', 'Классический баланс')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 50%, #94A8B8 50%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Гармония</div>
                <div class="card-sub-title">Классический баланс</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-pct-bonds">Обл. 50%</div>
            <div class="card-pct-stocks">Акц. 50%</div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="80" onclick="selectStrategy(80, this, 'Депозит', 'Защита капитала')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 80%, #94A8B8 80%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Депозит</div>
                <div class="card-sub-title">Защита капитала</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-pct-bonds">Обл. 80%</div>
            <div class="card-pct-stocks">Акц. 20%</div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="60" onclick="selectStrategy(60, this, 'Баланс', 'Умеренный риск')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 60%, #94A8B8 60%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Баланс</div>
                <div class="card-sub-title">Умеренный риск</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-pct-bonds">Обл. 60%</div>
            <div class="card-pct-stocks">Акц. 40%</div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="40" onclick="selectStrategy(40, this, 'Умеренная', 'Баланс роста')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 40%, #94A8B8 40%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Умеренная</div>
                <div class="card-sub-title">Баланс роста</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-pct-bonds">Обл. 40%</div>
            <div class="card-pct-stocks">Акц. 60%</div>
        </div>
    </div>

    <div class="strategy-option-card" data-bonds="20" onclick="selectStrategy(20, this, 'Агрессивная', 'Макс. рост')">
        <div class="card-left-part">
            <div class="card-indicator" style="background: linear-gradient(180deg, #5B7C99 0%, #5B7C99 20%, #94A8B8 20%, #94A8B8 100%);"></div>
            <div class="card-titles">
                <div class="card-main-title">Агрессивная</div>
                <div class="card-sub-title">Макс. рост</div>
            </div>
        </div>
        <div class="card-right-part">
            <div class="card-pct-bonds">Обл. 20%</div>
            <div class="card-pct-stocks">Акц. 80%</div>
        </div>
    </div>

    <div class="strategy-option-card" id="customOptionCard" data-bonds="custom" onclick="toggleCustomStrategyNew(this)">
        <div class="card-left-part">
            <div class="card-indicator" style="background: #ccc;"></div>
            <div class="card-titles">
                <div class="card-main-title">Настроить свою</div>
                <div class="card-sub-title">Выберите пропорцию</div>
            </div>
        </div>
        <div class="card-right-part">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#5B7C99" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        </div>
    </div>
                    <!-- Развернутый блок настройки -->
<div class="custom-strategy-expanded" id="customStrategyExpanded">
    <div class="custom-strategy-inner">
        
        <!-- Верхний ряд: Кнопка минус, Дисплей, Кнопка плюс -->
        <div class="custom-controls-row">
            <button class="custom-adjust-btn" onclick="event.stopPropagation(); adjustCustomRatio(-5)">−</button>
            
            <div class="custom-value-display">
                <div class="custom-value-item">
                    <span class="custom-value-bonds" id="customBondsDisplay">50</span>
                    <span class="custom-value-label">Облигации</span>
                </div>
                <span class="custom-value-divider">/</span>
                <div class="custom-value-item">
                    <span class="custom-value-stocks" id="customStocksDisplay">50</span>
                    <span class="custom-value-label">Акции</span>
                </div>
            </div>
            
            <button class="custom-adjust-btn" onclick="event.stopPropagation(); adjustCustomRatio(5)">+</button>
        </div>
        
        <!-- Слайдер-нить -->
        <div class="custom-slider-block">
            <input type="range" id="customRatioSlider" class="custom-ratio-slider" min="0" max="100" value="50" step="5" oninput="updateCustomSlider(this.value)">
        </div>
        
        <!-- Индикатор точек (для красоты) -->
        <div class="custom-dots-indicator" id="customDotsIndicator" style="margin-bottom: 25px;">
            <div class="custom-dot" data-value="0"></div>
            <div class="custom-dot" data-value="25"></div>
            <div class="custom-dot active" data-value="50"></div>
            <div class="custom-dot" data-value="75"></div>
            <div class="custom-dot" data-value="100"></div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="custom-actions-row">
            <button class="custom-reset-btn" onclick="event.stopPropagation(); resetCustomTo50()">
                Сбросить
            </button>
            <button class="custom-done-btn" onclick="event.stopPropagation(); saveCustomStrategy()">
                Готово
            </button>
        </div>
    </div>
</div>

</div>

            </div>
        </div>


    <!-- 3. GHOST SLIDER TRIGGER -->
    <div class="ghost-trigger-wrapper" id="ghostTrigger" onclick="toggleStrategies()">
        <div class="ghost-line"></div>
        <div class="ghost-text" id="ghostText">ОТКРЫТЬ СТРАТЕГИИ</div>
        <div class="ghost-dots">
            <div class="ghost-dot"></div>
            <div class="ghost-dot"></div>
            <div class="ghost-dot"></div>
        </div>
    </div>



    
    <!-- Скрытый основной ползунок для совместимости -->
    <input type="range" id="ratioSlider" class="ratio-slider" min="0" max="100" value="50" oninput="draw()" style="display: none;">
    <span id="labelBondsPct" style="display: none;">50</span>
    <span id="labelStocksPct" style="display: none;">50</span>
</div>
         </div> <!-- Закрываем calc-box-white-section -->

    <!-- Отступ для sticky кнопки -->
    <div style="height: 20px;"></div>

    <!-- Sticky Bottom Panel -->
    <div class="bottom-sticky-panel" id="stickyPanel">
        <button class="btn-graphite" onclick="calculateAndShowPortfolio()">
           Сформировать портфель
        </button>
        <p class="sticky-hint">
            Вам будет предложен список из 8 ОФЗ и 12 Акций к покупке
        </p>
    </div>
</div> <!-- Закрываем calc-box -->
</div> <!-- Закрываем calc-box WRAPPER или input-container -->
</div> <!-- Закрываем screen-app -->

<div id="screen-portfolio" class="screen">
    <!-- Заголовок -->
    <div class="header">
        <h1>Портфель</h1>
    </div>
    
    <!-- Empty State (показывается если расчёт не производился) -->
    <div id="portfolio-empty" class="portfolio-empty-new">
        <div class="empty-icon">📂</div>
        <div class="empty-title">Портфель пуст</div>
        <div class="empty-text">Расчёт ещё не производился.<br>Перейдите в терминал и сформируйте портфель.</div>
        <button class="empty-btn" onclick="showScreen('screen-app')">
            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            Перейти к расчёту
        </button>
    </div>

    <!-- Контент портфеля (скрыт до расчёта) -->
    <div id="portfolio-content" style="display:none;">
        
        <!-- ===== MAIN BALANCE CARD ===== -->
        <div class="portfolio-main-card" id="shareContainer">
    <!-- Заголовок -->
    <div class="stm-header">
        <div class="stm-header-label">ТЕКУЩИЙ КАПИТАЛ</div>
        <div class="stm-val-big" id="summ-invested">0 ₽</div>
    </div>
    
    <!-- Комиссия под суммой -->
<div style="text-align: center; margin-top: 8px; padding-bottom: 14px;">
    <div style="display: inline-block; background: rgba(52, 152, 219, 0.1); padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; color: var(--accent-blue);">
        Комиссия <span id="summ-fee">0.00%</span>
    </div>
</div>
    
    <!-- Прогресс-бар -->
    <div class="stm-bar-container">
        <div class="stm-bar-bonds" id="bar-bond-fill" style="width: 50%;"></div>
        <div class="stm-bar-stocks" id="bar-stock-fill" style="width: 50%;"></div>
    </div>
    
    <!-- Подписи под прогресс-баром -->
    <div class="stm-meta-row">
        <div class="stm-pct-labels">
            <div class="stm-pl-bond">АКЦИИ <strong id="srl-stock-pct">50%</strong></div>
            <div class="stm-pl-stock">ОБЛИГАЦИИ <strong id="srl-bond-pct">50%</strong></div>
        </div>
    </div>
    
    <!-- Блок прогноза -->
    <div class="portfolio-forecast">
        <div class="forecast-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
            </svg>
            ПРОГНОЗ ЧЕРЕЗ 3 ГОДА
        </div>
        
        <div class="forecast-grid">
    <div class="forecast-item">
        <div class="forecast-item-value bonds" id="summ-bond-income">+0 ₽</div>
        <div class="forecast-item-label">Купонный поток</div>
        <div class="forecast-item-sub">(Облигации)</div>
    </div>
    <div class="forecast-item">
        <div class="forecast-item-value stocks" id="summ-stock-growth">+0 ₽</div>
        <div class="forecast-item-label">Переоценка</div>
        <div class="forecast-item-sub">(Акции)</div>
    </div>
</div>
        
        <div class="forecast-total">
            <div class="forecast-total-label">Цель:</div>
            <div>
                <span class="forecast-total-value" id="summ-total-3y">~0 ₽</span>
            </div>
        </div>
    </div>
    
    <!-- Скрытый блок для PDF -->
    <div style="text-align: center; padding: 10px; display: none;" id="shareBrand">
        <h2 style="margin: 0; color: #D97757; font-size: 18px;">Madame Solomi'na Portfolio</h2>
        <div id="shareDate" style="font-size: 10px; color: #888;"></div>
    </div>
</div>
        
        <!-- ===== СЕКЦИЯ ОБЛИГАЦИЙ ===== -->
        <div id="section-bonds">
            <!-- Заголовок секции -->
            <div class="portfolio-section-header" onclick="this.nextElementSibling.classList.toggle('collapsed')">
                <div class="portfolio-section-header-left">
                    <div class="portfolio-section-icon bonds">🛡️</div>
                    <div>
                        <div class="portfolio-section-title">1. Денежный поток</div>
                        <div class="portfolio-section-subtitle">ОФЗ с постоянным купоном</div>
                    </div>
                </div>
                <div class="portfolio-section-badge bonds" id="badge-bonds-sum">0 ₽</div>
            </div>
            
            <!-- Описание -->
            <div style="font-size: 12px; color: var(--claude-text-secondary); padding: 0 4px 12px; line-height: 1.5;">
                Список из 8 Облигаций Федерального займа, генерирующих 16 выплат купонов в год.
            </div>

             <!-- ОБЕРНУЛИ В .portfolio-list ЧТОБЫ БЫЛА БЕЛАЯ РАМКА И ФОН -->
            <div class="portfolio-list" style="margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: none;">
                <div class="echelon-columns-header" style="border-bottom: none;">
                    <span>Название</span>
                    <span>Доходность</span>
                    <span>Кол-во</span>
                    <span>Сумма</span>
                </div>
            </div>
            
            <!-- У списка убираем верхние скругления, чтобы он слился с заголовком -->
            <div class="portfolio-list" id="listBonds" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: 1px solid rgba(0,0,0,0.05);">
                <!-- JS генерирует список здесь -->
                 </div>
        </div>
            
        
        <!-- ===== КУПОННЫЙ ДОЖДЬ ===== -->
        <div class="coupon-box-new" id="couponBox">
            <div class="coupon-header-new" onclick="this.parentElement.classList.toggle('open')">
                <div class="coupon-header-left">
                    <div class="coupon-icon">🌦️</div>
                    <div class="coupon-title-block">
                        <div class="coupon-title-new">Купонный дождь</div>
                        <div class="coupon-subtitle-new">Ближайшие выплаты по купонам</div>
                    </div>
                </div>
                <svg class="coupon-arrow-new" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div class="coupon-content-new">
                <!-- Переключатель налога -->
                <div class="tax-selector-ui" id="taxGroup" style="margin: 16px 0;">
                    <button class="tax-ui-btn" onclick="setTax(0, this)">Без налога</button>
                    <button class="tax-ui-btn active" onclick="setTax(0.13, this)">НДФЛ 13%</button>
                    <button class="tax-ui-btn" onclick="setTax(0.15, this)">НДФЛ 15%</button>
                </div>
                
                <!-- Заголовки таблицы -->
                <div class="coupon-table-head">
                    <span>ДАТА</span>
                    <span>НАЗВАНИЕ</span>
                    <span style="text-align:center">КОЛ-ВО</span>
                    <span style="text-align:right">СУММА</span>
                </div>
                
                <!-- Список выплат -->
                <div id="couponList">Загрузка данных...</div>
                
                <!-- Итого -->
                <div style="text-align:right; margin-top:12px; font-weight:bold; font-size:13px; padding-top:10px; border-top:1px dashed rgba(0,0,0,0.1);">
                    Итого ближайшие: <span id="couponTotalHeader" style="color: #5E7BA3;">0 ₽</span>
                </div>
            </div>
        </div>
        
        <!-- ===== РАЗДЕЛИТЕЛЬ ===== -->
        <div class="section-transition" id="section-separator">
            <div class="st-line"></div>
            <div class="st-icon">∞</div>
            <div class="st-line rev"></div>
        </div>
        
        <!-- ===== СЕКЦИЯ АКЦИЙ ===== -->
        <div id="section-stocks">
            <!-- Заголовок секции -->
            <div class="portfolio-section-header" id="header-stocks">
                <div class="portfolio-section-header-left">
                    <div class="portfolio-section-icon stocks">🚀</div>
                    <div>
                        <div class="portfolio-section-title">2. Растущая часть</div>
                        <div class="portfolio-section-subtitle">Акции по 4 эшелонам риска</div>
                    </div>
                </div>
               <div class="portfolio-section-badge stocks" id="badge-stocks-sum" style="display: flex !important; min-width: 60px; justify-content: center;">0 ₽</div>

            </div>
            
            <!-- Описание -->
            <div style="font-size: 12px; color: var(--claude-text-secondary); padding: 0 4px 12px; line-height: 1.5;">
                Акции публичных компаний, распределённые на 4 эшелона по уровню риска.
            </div>
            
            <!-- Контейнер для эшелонов -->
            <div id="echelonContainer">
                <!-- Здесь будут сгенерированы эшелоны через JS -->
            </div>
        </div>
        
        <!-- ===== ВАЖНОЕ ПРИМЕЧАНИЕ ===== -->
        <div class="portfolio-disclaimer" id="footer-important">
            <div class="disclaimer-header">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div class="disclaimer-title">Важно</div>
            </div>
            <div class="disclaimer-text">
                В Растущей части 70% средств мы держим в первых двух Эшелонах, так как они обеспечивают баланс надёжности и потенциальной доходности.
            </div>
        </div>
        
        <!-- ===== ОТСТУП ДЛЯ ACTION PANEL ===== -->
        <div style="height: 120px;"></div>
    </div>
    
    <!-- ===== ACTION PANEL (Sticky внизу) ===== -->
    <div class="portfolio-action-panel" id="portfolioActionPanel" style="display: none;">
        <button class="action-btn secondary" onclick="resetAndGoToTerminal()">
            <svg viewBox="0 0 24 24">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
            Новый расчёт
        </button>
        <button class="action-btn primary" onclick="shareAsPDF()">
            <svg viewBox="0 0 24 24">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                <polyline points="16 6 12 2 8 6"/>
                <line x1="12" y1="2" x2="12" y2="15"/>
            </svg>
            Поделиться
        </button>
    </div>
</div>

<div id="screen-assets" class="screen">
        <div class="header"><h1>Ребалансировка</h1></div>
        <div class="rebalance-intro-modern">
            <div class="ri-icon">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            </div>
            <b>Ребалансировка</b> — пересмотр состава активов. Продаем то, что выросло или имеет низкий потенциал, покупаем недооцененные инструменты из списков ниже.
        </div>
        
        <div class="section-header-styled" onclick="toggleOfzTable(document.getElementById('expandArrowOfz'))">
            <span>🛡️ ОФЗ для замены</span>
            <span class="info-i-blue" onclick="showYieldInfo(event)">
                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            </span>
        </div>
        <div class="info-preview-box" id="yield-info-box">
            <b>Простая Доходность к Погашению</b> — это среднегодовая доходность, которую получает инвестор, продержавший облигацию до даты ее погашения.
        </div>
        
        <div id="ofz-list-headers" class="list-header-row ofz-cols">
            <span>Название</span>
            <span>Цена</span>
            <span>НКД</span>
            <span>Доходность</span>
        </div>
        
        <div id="ofz-wrapper" class="echelon-wrapper collapsed">
             <div id="ofz-list"></div>
        </div>

        <div class="expand-arrow-btn" id="expandArrowOfz" onclick="toggleOfzTable(this)">
            <div class="eab-line"></div>
            <div class="eab-icon-box">
                <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <div class="eab-line"></div>
        </div>

        <div class="section-header-styled" onclick="toggleInfoBlock(this)">
            <span>🚀 Акции для замены</span>
            <span class="info-i-blue">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </span>
        </div>
        
        <div class="info-expanded-block" style="margin-top:10px;">
            <div class="echelon-info-graphic">
                <div class="eig-item e1">
                    <div class="eig-icon">💎</div>
                    <div class="eig-text">
                        <div class="eig-title">I Эшелон <span class="eig-badge">Надежный</span></div>
                        <div class="eig-desc">Компании, которые платят дивиденды и стараются их повышать каждый год</div>
                    </div>
                    <div class="eig-arrow">→</div>
                </div>
                <div class="eig-item e2">
                    <div class="eig-icon">📊</div>
                    <div class="eig-text">
                        <div class="eig-title">II Эшелон <span class="eig-badge">Стабильный</span></div>
                        <div class="eig-desc">Компании, которые платят дивиденды, но размер выплат может меняться</div>
                    </div>
                    <div class="eig-arrow">→</div>
                </div>
                <div class="eig-item e3">
                    <div class="eig-icon">⚡</div>
                    <div class="eig-text">
                        <div class="eig-title">III Эшелон <span class="eig-badge">Рисковый</span></div>
                        <div class="eig-desc">Компании с потенциалом выплат, но пока не платят регулярно</div>
                    </div>
                    <div class="eig-arrow">→</div>
                </div>
                <div class="eig-item e4">
                    <div class="eig-icon">🚀</div>
                    <div class="eig-text">
                        <div class="eig-title">IV Эшелон <span class="eig-badge">Венчурный</span></div>
                        <div class="eig-desc">Компании роста, которые реинвестируют прибыль вместо дивидендов</div>
                    </div>
                    <div class="eig-arrow">→</div>
                </div>
            </div>
        </div>
        
        <div id="echelon-wrapper" class="echelon-wrapper collapsed">
            <table class="echelon-table-styled">
                <thead>
                    <tr>
                        <th><div class="echelon-header-pill">I</div></th>
                        <th><div class="echelon-header-pill">II</div></th>
                        <th><div class="echelon-header-pill">III</div></th>
                        <th><div class="echelon-header-pill">IV</div></th>
                    </tr>
                </thead>
                <tbody id="echelon-tickers-body"></tbody>
            </table>
        </div>
        
        <div class="expand-arrow-btn" id="expandArrowBtn" onclick="toggleEchelonTable(this)">
            <div class="eab-line"></div>
            <div class="eab-icon-box">
                <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <div class="eab-line"></div>
        </div>
    </div>

    <div id="screen-interesting" class="screen">
    <!-- Заголовок экрана -->
    <div class="header">
        <h1>Интересное</h1>
    </div>
    
    <!-- Секция рыночных данных -->
    
    <div class="market-tiles-grid three-cols">
        <!-- IMOEX -->
        <div class="market-tile">
            <span class="market-tile-label">IMOEX</span>
            <span class="market-tile-value" id="val-imoex">---</span>
            <span class="market-tile-change neutral" id="dyn-imoex">--%</span>
        </div>
        
        <!-- USD/RUB -->
        <div class="market-tile">
            <span class="market-tile-label">USD/RUB</span>
            <span class="market-tile-value" id="val-usdrub">---</span>
            <span class="market-tile-change neutral" id="dyn-usdrub">--%</span>
        </div>
        
        <!-- BTC/USD -->
        <div class="market-tile">
            <span class="market-tile-label">BTC/USD</span>
            <span class="market-tile-value" id="val-btc">---</span>
            <span class="market-tile-change neutral" id="dyn-btc">--%</span>
        </div>
    </div>

    <!-- Вертикаль ставок (построчно) -->
<div class="rates-glass-card">
    <div class="rv-title">Вертикаль ставок</div>
    
    <div class="rates-row-list">
    <div class="rate-row-item">
        <span class="rate-row-label">Инфляция (г/г)</span>
        <span class="rate-row-value" id="val-inflation">9.1%</span>
    </div>
    
    <div class="rate-row-item">
        <span class="rate-row-label">Макс. ставка по вкладам</span>
        <span class="rate-row-value" id="val-deposit-rate">21.5%</span>
    </div>
    
    <div class="rate-row-item">
        <span class="rate-row-label">Ключевая ставка ЦБ</span>
        <span class="rate-row-value" id="val-key-rate">21.0%</span>
    </div>
    
    <div class="rate-row-item">
        <span class="rate-row-label">ОФЗ 10 лет</span>
        <span class="rate-row-value" id="val-ofz10">---%</span>
    </div>
</div>
</div>

    <!-- Калькулятор ежемесячного дохода (Аккордеон) -->
    <div class="calc-accordion" id="calcAccordion">
        <!-- Заголовок аккордеона -->
        <div class="calc-accordion-header" onclick="toggleCalcAccordion()">
    <div class="calc-accordion-header-left">
        <div class="calc-accordion-icon">📅</div>
        <div>
            <div class="calc-accordion-title">Ежемесячный доход</div>
            <div class="calc-accordion-subtitle">Рассчитайте выплаты по ОФЗ</div>
        </div>
    </div>
    <div style="display: flex; align-items: center;">
        <svg class="calc-accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </div>
</div>
        
        <!-- Контент аккордеона -->
        <div class="calc-accordion-content">
            <!-- Поле ввода суммы -->
            <div class="glass-input-wrapper">
                <span class="input-label">Сумма инвестиций</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" id="monthlySumInput" value="100000" 
                           oninput="distributeMonthlyInvestment()" 
                           onclick="event.stopPropagation(); this.select()" 
                           onkeyup="if(event.keyCode===13) this.blur()" 
                           inputmode="numeric" 
                           pattern="[0-9]*" 
                           enterkeyhint="done"
                           placeholder="Введите сумму...">
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: 24px; color: var(--claude-text-secondary);">₽</span>
                </div>
            </div>
            
            <!-- Информационный текст -->
            <div class="calc-info-text">
                Калькулятор предлагает к покупке список ОФЗ, благодаря которому Вы будете получать ежемесячно выплаты купонов.
            </div>
            
            <!-- Переключатель налога -->
            <div class="tax-segmented-control">
                <button class="tax-segment" id="tax-custom-0" onclick="setCustomTax(0, this)">Без налога</button>
                <button class="tax-segment active" id="tax-custom-13" onclick="setCustomTax(0.13, this)">НДФЛ 13%</button>
                <button class="tax-segment" id="tax-custom-15" onclick="setCustomTax(0.15, this)">НДФЛ 15%</button>
            </div>
            
            <!-- Заголовки таблицы -->
            <div class="calc-table-header">
                <span>Название</span>
                <span>Доходность</span>
                <span>Количество</span>
            </div>
            
            <!-- Список облигаций для ввода -->
            <div id="calc-bonds-input-list"></div>
            
            <!-- Кнопка сброса -->
            <button class="btn-reset-glass" onclick="resetCustomCalc()">
                <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Очистить все поля
            </button>

            <!-- Блок результатов -->
            <div class="results-glass-container">
                <div class="results-glass-title">
                    <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    Выплаты
                </div>
                
                <div class="coupon-table-head" style="margin-top: 0;">
                    <span>ДАТА</span> 
                    <span>НАЗВАНИЕ</span> 
                    <span style="text-align:center">КОЛ-ВО</span> 
                    <span style="text-align:right">СУММА</span>
                </div>
                
                <div id="calc-results-list" style="font-size:11px; color: var(--claude-text-secondary);">
                    Введите количество для расчета...
                </div>
                
                <div id="calc-results-footer" class="results-glass-footer"></div>
            </div>
        </div>
    </div>
</div>
    
    <div id="screen-company" class="screen">
    <div id="company-content"></div>
</div>
        
        
        <div id="company-content"></div>
    </div>

    <div class="nav-wrapper" id="navWrapper" style="display: flex !important;">
        <div class="nav-dock" id="standardNav">
            <div class="nav-item active" id="nav-home" onclick="showScreen('screen-home')">
                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </div>
            <div class="nav-item" id="nav-app" onclick="showScreen('screen-app')">
                <svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
            </div>
            <div class="nav-item" id="nav-portfolio" onclick="showScreen('screen-portfolio')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            </div>
            <div class="nav-item" id="nav-assets" onclick="showScreen('screen-assets')">
                <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            </div>
        </div>

        <div class="nav-search-btn" id="nav-search" onclick="expandSearch()">
            <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:2;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <button class="theme-toggle-mini" onclick="event.stopPropagation(); toggleTheme()" id="themeBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
        </div>

        <div class="nav-search-expanded" id="expandedNav">
            <div class="nav-back-island" onclick="collapseSearch()">
                 <!-- Icon will be injected here by JS -->
            </div>
            <input type="text" class="nav-search-input-bar" id="tickerSearchInput" placeholder="Тикер, название или ISIN..." onkeyup="handleSearchKeyup(event)">
            <div class="nav-item" onclick="collapseSearch()">
                <svg viewBox="0 0 24 24" style="width:24px;height:24px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <!-- REVOLUTIONARY NOTIFICATION PILL -->
<div id="luxuryNotification" class="luxury-notify-pill">
    <div class="notify-icon-circle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
            <circle cx="12" cy="12" r="10"></circle>
        </svg>
    </div>
    <div class="notify-content">
        <span class="notify-title">Минимальный капитал</span>
        <span class="notify-message">Введите сумму от 10 000 ₽</span>
    </div>
</div>

    <!-- ИНДИКАТОР СВАЙПА НАЗАД -->
<div id="swipeBackIndicator" class="swipe-back-overlay">
    <div class="sbi-icon-wrapper">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5"/>
            <path d="M12 19l-7-7 7-7"/>
        </svg>
    </div>
</div>


<script>
    // Очистка старых настроек при загрузке
        localStorage.removeItem('invest_settings');
    
        // ========== ИСПРАВЛЕННЫЙ КОД - НАЧАЛО ==========
        document.addEventListener('click', function(event) {
    const sumInput = document.getElementById('sumInput');
    const inputWrapper = document.querySelector('.input-wrapper');
    const currencySymbol = document.getElementById('currencySymbol');
    
    // Игнорируем клики по полю ввода, его обёртке, символу валюты и карточкам стратегий
    if (event.target.closest('.strategy-card') || 
        event.target.closest('.fee-dropdown-container') ||
        event.target.closest('.fee-dropdown-trigger') || // ДОБАВЛЕНО
        event.target.closest('.fee-dropdown-menu') ||    // ДОБАВЛЕНО
        event.target.closest('.custom-strategy-expanded')) {
        return; // Не закрываем клавиатуру при клике на эти элементы
    }
            
            // Если клик НЕ по полю ввода и НЕ по его обёртке - закрываем клавиатуру
            if (sumInput && 
                !sumInput.contains(event.target) && 
                !inputWrapper?.contains(event.target) &&
                !currencySymbol?.contains(event.target)) {
                sumInput.blur();
            }
        });
        // ========== ИСПРАВЛЕННЫЙ КОД - КОНЕЦ ==========

    
        
        const SHEET_ID = '1SFV5dBIsvfX5HKbXBuXHFVvBfw1p1MPPx2uK209ajLM';
        const GID = '1213653337'; 
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

           // Лист с описаниями компаний
        const GID_DESCRIPTIONS = '88183976';
        const CSV_DESCRIPTIONS_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSl8uP-rbiQbK57e9L5xxu8dHKzN05jNsJukOMclUn0wuaT2UNsnX-PIAaCctInmwDOzffdPuah4bER/pub?gid=${GID_DESCRIPTIONS}&single=true&output=csv`;
        
          // URL вашего Google Apps Script (ЗАМЕНИТЕ НА СВОЙ!)
        const NEWS_API_URL = 'https://script.google.com/macros/s/AKfycbxDEhAz8Cd9wB3Q6ln_UY_0mxPp0bqRXv0HKFVdsMUt3S0vAejpmITCWkzRdDgWqfmB/exec';
         // Кэш новостей чтобы не загружать повторно
          let newsCache = {};

        // Функция загрузки новостей для тикера
        async function loadNewsForTicker(ticker) {
         // Проверяем кэш
        if (newsCache[ticker]) {
        return newsCache[ticker];
    }
    
    try {
        const response = await fetch(`${NEWS_API_URL}?ticker=${ticker}`);
        const data = await response.json();
        
        if (!data.error && data.news) {
            newsCache[ticker] = data.news;
            return data.news;
        }
        return [];
    } catch (e) {
        console.error('Ошибка загрузки новостей:', e);
        return [];
    }
}

// Функция форматирования даты новости
function formatNewsDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffHours < 1) return 'Только что';
    if (diffHours < 24) return `${diffHours} ч. назад`;
    if (diffDays < 7) return `${diffDays} дн. назад`;
    
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

    

        let bonds = [];
        let bondDataCache = {};
        let monthlyIncomeBonds = []; // New list for the specific calculator
        let allScheduledPayments = [];
        let brokerFee = 0.0005; // По умолчанию Премиум 
        let currentTax = 0.13;
        let customTax = 0.13;
        let bondCouponsMap = {}; 
        let bondDetailsMap = {};
        let companyDescriptions = {};
        let currentScreen = 'screen-home';
        let lastNavScreen = 'screen-home';
        let isPortfolioCalculated = false;
        let isFirstVisit = true;
        let isUpdatingProgrammatically = false;
        let savedCustomBonds = null;
        let savedCustomStocks = null;
        // Переменные для вертикали ставок
        let ratesData = {
           keyRate: '21.0%',
           depositRate: '21.5%',
           inflation: '9.1%',
           ofz10: '---'
        };
    

                let echelons = [
            { title: 'Надежные', weight: 0.30, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ ПЛАТЯТ ДИВИДЕНДЫ И СТАРАЮТСЯ ИХ ПОВЫШАТЬ' },
            { title: 'Стабильные', weight: 0.40, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ ПЛАТЯТ ДИВИДЕНДЫ, НО ВЫПЛАТЫ РАЗНЯТСЯ' },
            { title: 'Рисковые', weight: 0.15, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ МОГУТ ПЛАТИТЬ, НО НЕ ПЛАТЯТ' },
            { title: 'Венчурные', weight: 0.15, assets: [], info: 'КОМПАНИИ, КОТОРЫЕ НЕ ПЛАТЯТ ДИВИДЕНДОВ' }
        ];

        let echelonTableData = [[], [], [], []];
        
        // Swipe navigation removed

                function checkFirstVisit() {
    // Мы убрали проверку localStorage
    // Теперь всегда считаем, что нужно показать приветствие
    isFirstVisit = true;
    showScreen('screen-home'); 
}


        function startCalculation() {
    localStorage.setItem('user_visited', 'true');
    isFirstVisit = false;
    document.getElementById('navWrapper').style.display = 'flex';
    showScreen('screen-app');
    
    // Haptic feedback при открытии
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
}
    function openTerminal() {
    console.log('openTerminal called'); // для отладки
    localStorage.setItem('user_visited', 'true');
    isFirstVisit = false;
    
    // Показываем навигацию
    const navWrapper = document.getElementById('navWrapper');
    if (navWrapper) {
        navWrapper.style.display = 'flex';
    }
    
    // Переключаем экран
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const appScreen = document.getElementById('screen-app');
    if (appScreen) {
        appScreen.classList.add('active');
    }
    
    // Обновляем навигацию
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const navApp = document.getElementById('nav-app');
    if (navApp) {
        navApp.classList.add('active');
    }
    
    // Показываем sticky панель
    const stickyPanel = document.getElementById('stickyPanel');
    if (stickyPanel) {
        stickyPanel.style.display = 'block';
    }
    
    currentScreen = 'screen-app';
    
    // Скролл наверх
    window.scrollTo({top: 0, behavior: 'smooth'});
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
}

        function updateMarketStatus() {
    const now = new Date();
    const day = now.getDay(); 
    const hour = now.getHours(); 
    const min = now.getMinutes();
    const dot = document.getElementById('market-status-dot');
    
    if (!dot) {
        console.log('market-status-dot не найден');
        return;
    }
    
    const isWeekday = day >= 1 && day <= 5;
    const isWorkingHours = (hour > 10 || (hour === 10 && min >= 0)) && (hour < 18 || (hour === 18 && min <= 50));
    dot.className = (isWeekday && isWorkingHours) ? 'market-dot dot-online' : 'market-dot dot-offline';
}


    function updateRatesDisplay() {
    document.getElementById('val-key-rate').innerText = ratesData.keyRate;
    document.getElementById('val-deposit-rate').innerText = ratesData.depositRate;
    document.getElementById('val-inflation').innerText = ratesData.inflation;
    document.getElementById('val-ofz10').innerText = ratesData.ofz10;  // <--- ЭТА СТРОКА
}

        async function updateMarketData() {
            const setDynamics = (el, change) => {
                el.classList.remove('positive', 'negative', 'neutral');
                if (change > 0.01) {
                    el.classList.add('positive');
                    el.innerText = `+${change.toFixed(2)}%`;
                } else if (change < -0.01) {
                    el.classList.add('negative');
                    el.innerText = `${change.toFixed(2)}%`;
                } else {
                    el.classList.add('neutral');
                    el.innerText = `${Math.abs(change).toFixed(2)}%`;
                }
            };
            
            // Bitcoin
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
                const data = await res.json();
                if(data && data.lastPrice) {
                    document.getElementById('val-btc').innerText = '$' + Math.round(parseFloat(data.lastPrice)).toLocaleString();
                    setDynamics(document.getElementById('dyn-btc'), parseFloat(data.priceChangePercent));
                }
            } catch(e) { console.log("BTC fetch error:", e); }

            // MOEX data
            const fetchMoex = (url, valEl, dynEl) => {
                fetch(url)
                    .then(r => r.json())
                    .then(d => {
                        const marketdata = (d.marketdata && d.marketdata.data.length > 0) ? d.marketdata : ((d.marketdata_yields && d.marketdata_yields.data.length > 0) ? d.marketdata_yields : null);
                        
                        let last, open, prev;
                        let changePercent = 0;

                        const getVal = (block, colName) => {
                            if(!block || !block.columns || !block.data || block.data.length === 0) return null;
                            const idx = block.columns.indexOf(colName);
                            return idx !== -1 ? block.data[0][idx] : null;
                        };

                        if (marketdata) {
                            last = getVal(marketdata, 'LAST') || getVal(marketdata, 'CURRENTVALUE') || getVal(marketdata, 'YIELD');
                            open = getVal(marketdata, 'OPEN');
                        }

                        if ((!last || !open) && d.securities && d.securities.data.length > 0) {
                             prev = getVal(d.securities, 'PREVPRICE');
                             if(!last) last = prev; 
                             if(!open) open = prev; 
                        }
                        
                        if(last && open && open > 0) {
                            changePercent = ((last - open) / open) * 100;
                        } else if (last && prev && prev > 0) {
                             changePercent = ((last - prev) / prev) * 100;
                        }
                        
                        if(last) valEl.innerText = last.toFixed(2).replace('.00', '') + (url.includes('USD') ? ' ₽' : '');
                        setDynamics(dynEl, changePercent);
                    }).catch(e => {
                        console.log("MOEX error for:", valEl.id, e);
                        valEl.innerText = "---";
                    });
            };

            fetchMoex('https://iss.moex.com/iss/engines/stock/markets/index/securities/IMOEX.json?iss.meta=off&iss.only=securities,marketdata', document.getElementById('val-imoex'), document.getElementById('dyn-imoex'));
            fetchMoex('https://iss.moex.com/iss/engines/currency/markets/selt/boards/CETS/securities/USD000UTSTOM.json?iss.meta=off&iss.only=securities,marketdata', document.getElementById('val-usdrub'), document.getElementById('dyn-usdrub'));
            
             fetch('https://iss.moex.com/iss/engines/stock/markets/bonds/securities/SU26244RMFS2.json?iss.meta=off&iss.only=securities,marketdata')
                .then(r => r.json())
                .then(d => {
                     const md = d.marketdata || d.marketdata_yields;
                     if(md && md.data.length > 0) {
                         const yIdx = md.columns.indexOf('YIELD');
                         const y = md.data[0][yIdx];
                         if(y) document.getElementById('val-ofz10').innerText = y.toFixed(2) + '%';
                     }
                }).catch(e => console.log('OFZ fetch error'));
        }

        setInterval(updateMarketData, 30000);
        //setInterval(updateMarketStatus, 60000); // Отключено
        
                function showScreen(screenId) {
            // 1. Логика для меню: если это Главная (screen-home)
            if (screenId === 'screen-home') {
                document.body.classList.add('home-mode'); // Включаем "прозрачный" режим
                document.getElementById('navWrapper').style.display = 'flex'; // Убеждаемся, что меню видно
                document.getElementById('stickyPanel').style.display = 'none'; // Скрываем нижнюю панель (где кнопка "Сформировать")
            } else {
                document.body.classList.remove('home-mode'); // Выключаем "прозрачный" режим (возвращаем как было)
                
                // Управление видимостью stickyPanel как в оригинале
                const stickyPanel = document.getElementById('stickyPanel');
                if (stickyPanel) {
                    stickyPanel.style.display = (screenId === 'screen-app') ? 'block' : 'none';
                }
            }

            // Старая логика функции (оставляем как было)
            if(screenId !== 'screen-interesting' && screenId !== 'screen-company') {
                lastNavScreen = screenId;
                collapseSearch(false);
            }
            
            currentScreen = screenId;
            
            // Показываем нужный экран
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const targetScreen = document.getElementById(screenId);
            if(targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Обновляем навигацию
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('nav-search').classList.remove('active');
            
            // Подсветка кнопок
            const navId = `nav-${screenId.split('-')[1]}`;
            const navBtn = document.getElementById(navId);
            if (navBtn) navBtn.classList.add('active');
            
            if(screenId === 'screen-interesting' || screenId === 'screen-company') {
                document.getElementById('nav-search').classList.add('active');
            }
            
            // Action Panel логика
            const portfolioActionPanel = document.getElementById('portfolioActionPanel');
            if (portfolioActionPanel) {
                if (screenId === 'screen-portfolio' && isPortfolioCalculated) {
                    portfolioActionPanel.style.display = 'flex';
                } else {
                    portfolioActionPanel.style.display = 'none';
                }
            }
            
            window.scrollTo({top: 0, behavior: 'smooth'});
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }


        
        function expandSearch() {
            const backBtn = document.querySelector('#expandedNav .nav-back-island');
            const activeNavId = `nav-${lastNavScreen.split('-')[1]}`;
            const activeNav = document.getElementById(activeNavId);

            if (activeNav && backBtn) {
                const iconSvg = activeNav.querySelector('svg').cloneNode(true);
                backBtn.innerHTML = '';
                backBtn.appendChild(iconSvg);
            }
            
            document.getElementById('standardNav').classList.add('hidden');
            document.getElementById('nav-search').style.display = 'none';
            document.getElementById('expandedNav').classList.add('active');
            showScreen('screen-interesting');
            setTimeout(() => {
                document.getElementById('tickerSearchInput').focus();
            }, 300);
        }

        function collapseSearch(goBack = true) {
            document.getElementById('expandedNav').classList.remove('active');
            document.getElementById('standardNav').classList.remove('hidden');
            document.getElementById('nav-search').style.display = 'flex';
            document.getElementById('tickerSearchInput').blur();
            document.getElementById('tickerSearchInput').value = '';
            
            if(goBack) showScreen(lastNavScreen);
        }

        function goBackFromCompany() {
            showScreen('screen-interesting');
        }

        function handleSearchKeyup(event) {
            if(event.keyCode === 13) {
                performSearch(event.target.value);
            }
        }

        // Функция показа уведомления
function showLuxuryNotification() {
    const notify = document.getElementById('luxuryNotification');
    
    // 1. Показываем (добавляем класс)
    notify.classList.add('show');
    
    // 2. Haptic Feedback (Вибрация ошибки)
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
    }
    
    // 3. Прячем через 3.5 секунды
    setTimeout(() => {
        notify.classList.remove('show');
    }, 3500);
}

// Основная функция расчета
function calculateAndShowPortfolio() {
    // 1. Проверка СУММЫ (как было)
    const sum = getSumInputValue();
    if (sum < 10000) {
        showLuxuryNotification();
        const inputBlock = document.querySelector('.input-wrapper');
        if (inputBlock) {
            inputBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
    }

    // 2. НОВАЯ ПРОВЕРКА: КОМИССИЯ
    if (!isFeeSelected) {
        // Находим блок комиссии (обертку)
        const feeBlock = document.querySelector('.fee-unified-wrapper');
        
        if (feeBlock) {
            // Прокручиваем к нему
            feeBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Добавляем класс тряски
            feeBlock.classList.add('shake-error');
            
            // Вибрация ошибки
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
            
            // Убираем класс через 0.5 сек, чтобы можно было потрясти снова
            setTimeout(() => {
                feeBlock.classList.remove('shake-error');
            }, 500);
        }
        return; // ОСТАНАВЛИВАЕМ ПЕРЕХОД
    }

    // 3. УСПЕХ (Все проверки пройдены)
    try {
        draw();
        savePortfolio();
        isPortfolioCalculated = true;
        
        document.getElementById('portfolio-empty').style.display = 'none';
        document.getElementById('portfolio-content').style.display = 'block';
        
        const actionPanel = document.getElementById('portfolioActionPanel');
        if(actionPanel) actionPanel.style.display = 'flex';
        
        showScreen('screen-portfolio');
    } catch(e) {
        console.error('Error calculating portfolio:', e);
    }
}


        function toggleAccordion(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        }
    // Новая функция для аккордеона калькулятора в "Интересное"
function toggleCalcAccordion() {
    const accordion = document.getElementById('calcAccordion');
    if (accordion) {
        accordion.classList.toggle('open');
        
        // Haptic feedback
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    }
}

        function toggleCouponSection() {
            const content = document.getElementById('couponContent');
            const arrow = document.getElementById('couponArrow');
            content.classList.toggle('active');
            arrow.classList.toggle('rotated');
        }

        function toggleEchelonTable(btn) {
            const wrapper = document.getElementById('echelon-wrapper');
            wrapper.classList.toggle('collapsed');
            if(btn && btn.classList) btn.classList.toggle('open');
        }

        function toggleOfzTable(btn) {
            const wrapper = document.getElementById('ofz-wrapper');
            wrapper.classList.toggle('collapsed');
            if(btn && btn.classList) btn.classList.toggle('open');
        }
        
        function toggleOfzDetails(id) {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('active');
        }
        
        function toggleInfoBlock(headerElement) {
            event.stopPropagation();
            let nextEl = headerElement.nextElementSibling;
            while(nextEl) {
                if (nextEl.classList.contains('info-expanded-block')) {
                    nextEl.classList.toggle('show');
                    break;
                }
                nextEl = nextEl.nextElementSibling;
            }
        }

        function toggleEchelonTip(event, tipId) {
            event.stopPropagation();
            const allTips = document.querySelectorAll('.echelon-tip');
            allTips.forEach(t => {
                if(t.id !== tipId) t.classList.remove('show');
            });
            const tip = document.getElementById(tipId);
            if(tip) tip.classList.toggle('show');
        }

        function showYieldInfo(event) {
            event.stopPropagation();
            const infoBox = document.getElementById('yield-info-box');
            if (infoBox) {
                infoBox.classList.toggle('show');
            }
        }
        
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeBtn');
            const sunIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
            const moonIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode'); body.classList.add('light-mode');
                btn.innerHTML = moonIcon; localStorage.setItem('user_theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode'); btn.innerHTML = sunIcon; localStorage.setItem('user_theme', 'dark');
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('user_theme');
            const btn = document.getElementById('themeBtn');
            const sunIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
            const moonIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
            if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); btn.innerHTML = sunIcon; }
            else { document.body.classList.add('light-mode'); btn.innerHTML = moonIcon; }
        }

        function saveSettings() {
    // Автосохранение отключено
    // Настройки сбрасываются при каждом открытии
}

    // ========== НОВАЯ ФУНКЦИЯ - НАЧАЛО ==========
function savePortfolio() {
    try {
        const portfolioData = {
            sum: getSumInputValue(),
            ratio: parseInt(document.getElementById('ratioSlider').value),
            fee: brokerFee,
            tax: currentTax,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('portfolio_snapshot', JSON.stringify(portfolioData));
        console.log('Portfolio saved:', portfolioData);
    } catch(e) {
        console.error('Error saving portfolio:', e);
    }
}
// ========== НОВАЯ ФУНКЦИЯ - КОНЕЦ ==========

       /* ========== NEW LOGIC FOR GHOST SLIDER ========== */

// Функция переключения состояния (Открыть/Закрыть)
function toggleStrategies() {
    const container = document.getElementById('waterfallContainer');
    const trigger = document.getElementById('ghostTrigger');
    const text = document.getElementById('ghostText');
    const customBlock = document.getElementById('customStrategyExpanded');
    
    // Переключаем классы
    const isOpen = container.classList.toggle('show');
    trigger.classList.toggle('open');
    
    // Меняем текст и вибрацию
    if(isOpen) {
        text.innerText = "ЗАКРЫТЬ";
        if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    } else {
        text.innerText = "ОТКРЫТЬ СТРАТЕГИИ";
        // Если закрываем список, закрываем и кастомную настройку, если она открыта
        if(customBlock) customBlock.classList.remove('show');
    }
}

// Функция выбора стратегии (обновляет главную карточку)
function selectStrategy(bondPercent, optionCard, title, subtitle) {
    // 1. Обновляем данные слайдера
    document.getElementById('ratioSlider').value = bondPercent;
    
    // 2. Визуально обновляем ГЛАВНУЮ карточку (тексты, цвета)
    updateMainCardUI(bondPercent, title, subtitle);

    // 3. Сбрасываем кастомный режим, если выбрана стандартная стратегия
    if(title !== 'Индивидуальная') {
        savedCustomBonds = null;
        document.getElementById('customStrategyExpanded').classList.remove('show');
    }

    // 4. Закрываем список с небольшой задержкой (для красоты)
    setTimeout(() => {
        toggleStrategies(); 
    }, 150);

    // 5. Запускаем draw (он теперь сам вызовет updateStrategyCardSelection внутри себя)
    draw();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Обновление UI главной карточки
function updateMainCardUI(bondPercent, title, subtitle) {
    const stockPercent = 100 - bondPercent;
    
    // Тексты
    document.getElementById('mainCardTitle').innerText = title;
    document.getElementById('mainCardSubtitle').innerText = subtitle;
    document.getElementById('mainCardBonds').innerText = `Обл. ${bondPercent}%`;
    document.getElementById('mainCardStocks').innerText = `Акц. ${stockPercent}%`;
    
    // Градиент индикатора
    const indicator = document.getElementById('mainCardIndicator');
    indicator.style.background = `linear-gradient(180deg, #5B7C99 0%, #5B7C99 ${bondPercent}%, #94A8B8 ${bondPercent}%, #94A8B8 100%)`;
}

// Логика для кастомной стратегии (адаптированная)
function toggleCustomStrategyNew(cardElement) {
    const expanded = document.getElementById('customStrategyExpanded');
    const isOpening = !expanded.classList.contains('show');
    
    if (isOpening) {
        expanded.classList.add('show');
        // Плавно скроллим к настройкам, чтобы их было видно
        expanded.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // ЭТОТ БЛОК СРАБОТАЕТ ПРИ НАЖАТИИ "ГОТОВО"
        expanded.classList.remove('show');
        
        // ВОЗВРАЩАЕМ ЭКРАН В САМЫЙ ВЕРХ (к вводу суммы)
        // Используем setTimeout, чтобы скролл начался после того, как блок начнет скрываться
        setTimeout(() => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }, 50);
    }
}

// Переопределяем функцию сохранения кастомной стратегии, чтобы она обновляла новую UI
const originalSaveCustom = saveCustomStrategy; // Сохраняем ссылку если нужно

// Переопределяем функцию сохранения кастомной стратегии
saveCustomStrategy = function() {
    const bondPct = parseInt(document.getElementById('customRatioSlider').value);
    const stockPct = 100 - bondPct;
    
    savedCustomBonds = bondPct;
    savedCustomStocks = stockPct;
    
    document.getElementById('ratioSlider').value = bondPct;
    
    // 1. Убираем фокус с любых полей (важно для iOS)
    if (document.activeElement) document.activeElement.blur();
    
    // 2. Обновляем UI
    updateMainCardUI(bondPct, 'Индивидуальная', 'Ваша настройка');
    
    // 3. Сворачиваем ВНУТРЕННИЙ блок (анимация началась)
    document.getElementById('customStrategyExpanded').classList.remove('show');
    
    // 4. ПЕРВАЯ ПРОКРУТКА (Плавная)
    // Запускаем её сразу, пока страница еще длинная
    const inputBlock = document.querySelector('.input-wrapper');
    if (inputBlock) {
        inputBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 5. ЗАКРЫВАЕМ ВНЕШНИЙ СПИСОК С ЗАДЕРЖКОЙ
    // Даем 400мс, чтобы сработал первый скролл и прошла анимация внутреннего блока
    setTimeout(() => {
        const container = document.getElementById('waterfallContainer');
        const trigger = document.getElementById('ghostTrigger');
        
        if (container && container.classList.contains('show')) {
            container.classList.remove('show');
            if (trigger) trigger.classList.remove('open');
            const text = document.getElementById('ghostText');
            if (text) text.innerText = "ОТКРЫТЬ СТРАТЕГИИ";
        }

        // 6. ВТОРАЯ ПРОКРУТКА (Мгновенная - страховка)
        // Это "лечит" залипание. Если браузер заблокировал скролл,
        // эта команда принудительно вернет его наверх после изменения высоты.
        window.scrollTo({ top: 0, behavior: 'auto' });
        
    }, 400); 
    
    draw();
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}


        

        // NEW: Dropdown для тарифа комиссии
let isFeeSelected = false;

function toggleFeeDropdown() {
    try {
        const trigger = document.getElementById('feeDropdownTrigger');
        const menu = document.getElementById('feeDropdownMenu');
        
        if (!menu) {
            console.error('Menu not found!');
            return;
        }

        // Переключаем классы
        const isNowOpen = trigger.classList.toggle('open');
        menu.classList.toggle('show'); // Этот класс активирует display: block !important
        
        // Вращаем стрелку
        const arrow = trigger.querySelector('.fee-dropdown-arrow');
        if(arrow) arrow.style.transform = isNowOpen ? 'rotate(180deg)' : 'rotate(0deg)';

        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    } catch (e) {
        console.error(e);
    }
}


    // Глобальная переменная (убедитесь, что она есть в начале скрипта, если нет - добавьте)
// let isFeeSelected = false; 

function selectFee(value, rateText, nameText) {
    const sumInput = document.getElementById('sumInput');
    if (sumInput) sumInput.blur();
    
    brokerFee = value;
    
    // ВАЖНО: Запоминаем, что выбор сделан
    isFeeSelected = true; 
    
    // Обновляем текст
    const selectedText = document.getElementById('feeSelectedText');
    if (selectedText) {
        selectedText.textContent = rateText;
        selectedText.classList.remove('placeholder');
    }
    
    // Логика галочек
    document.querySelectorAll('.fee-dropdown-item').forEach(item => {
        item.classList.remove('selected');
    });
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('selected');
    }
    
    toggleFeeDropdown();
    draw();
}



// Закрытие dropdown при клике вне его
document.addEventListener('click', function(event) {
    const container = document.querySelector('.fee-selector-unified');
    const menu = document.getElementById('feeDropdownMenu');
    const trigger = document.getElementById('feeDropdownTrigger');
    
    // Если клик НЕ внутри контейнера комиссии - закрываем
    if (container && !container.contains(event.target)) {
        if(menu) menu.classList.remove('show');
        if(trigger) trigger.classList.remove('open');
        const arrow = trigger?.querySelector('.fee-dropdown-arrow');
        if(arrow) arrow.style.transform = 'rotate(0deg)';
    }
});


        function setTax(val, btn) {
            currentTax = val;
            document.querySelectorAll('#taxGroup .tax-ui-btn').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
            draw();
        }
        
        function setCustomTax(val, btn) {
    customTax = val;
    
    // Убираем active со всех кнопок налога
    const taxButtons = document.querySelectorAll('#screen-interesting .tax-segment, #tax-custom-0, #tax-custom-13, #tax-custom-15');
    taxButtons.forEach(b => b.classList.remove('active'));
    
    // Добавляем active на нажатую кнопку
    btn.classList.add('active');
    
    distributeMonthlyInvestment();
}

        function shortenTicker(t) { return t.length > 7 ? t.substring(0, 7) : t; }
        function limitName(n) { return n.length > 18 ? n.substring(0, 16) + '...' : n; }
        function hideAllTips(event) { 
            document.querySelectorAll('.echelon-tip, .info-preview-box').forEach(el => {
                if(!el.contains(event.target) && !event.target.closest('.section-header-styled')) {
                    el.classList.remove('show')
                }
            });
            if(event && event.target.tagName !== 'INPUT') { 
                if(document.getElementById('sumInput')) document.getElementById('sumInput').blur();
                if(document.getElementById('monthlySumInput')) document.getElementById('monthlySumInput').blur();
            } 
        }

    
// NEW: Форматирование суммы с разделителями и адаптивным размером


    function adjustInputWidth(input) {
    // Создаем временный span для измерения ширины текста
    const span = document.createElement('span');
    const computedStyle = window.getComputedStyle(input);
    span.style.font = computedStyle.font;
    span.style.fontSize = computedStyle.fontSize; // Берём ТЕКУЩИЙ размер шрифта (с учётом классов)
    span.style.fontWeight = computedStyle.fontWeight;
    span.style.letterSpacing = computedStyle.letterSpacing;
    span.style.fontFamily = computedStyle.fontFamily;
    span.style.visibility = 'hidden';
    span.style.position = 'absolute';
    span.style.whiteSpace = 'nowrap';
    span.textContent = input.value || input.placeholder;
    
    document.body.appendChild(span);
    const width = span.offsetWidth;
    document.body.removeChild(span);
    
    // Устанавливаем ширину с небольшим запасом (10px вместо 20px)
    input.style.width = Math.max(200, Math.min(width + 10, window.innerWidth * 0.85)) + 'px';
}
    

// NEW: Адаптивный размер шрифта в зависимости от длины
function adjustSumInputSize(input) {
    const length = input.value.length;
    
    // Убираем все классы размера
    input.classList.remove('size-large', 'size-medium', 'size-small', 'size-xsmall');
    
    // Добавляем нужный класс
    if (length <= 7) {
        input.classList.add('size-large');      // до 999.999
    } else if (length <= 11) {
        input.classList.add('size-medium');     // до 99.999.999
    } else if (length <= 15) {
        input.classList.add('size-small');      // до 999.999.999.999
    } else {
        input.classList.add('size-xsmall');     // больше
    }
}

// NEW: Получить числовое значение из форматированного поля
function getSumInputValue() {
    const input = document.getElementById('sumInput');
    if (!input) {
        console.log('getSumInputValue: input not found');
        return 0;
    }
    
    const value = input.value;
    console.log('getSumInputValue: raw value:', value);
    
    const cleanValue = value.replace(/\./g, '');
    console.log('getSumInputValue: clean value:', cleanValue);
    
    const result = parseInt(cleanValue) || 0;
    console.log('getSumInputValue: result:', result);
    
    return result;
}

// NEW: Скрытие меню при фокусе на вводе
                function onSumInputFocus(input) {
            document.body.classList.add('input-focused');
            
            if (input.value === "0") {
                input.value = "";
            }
        }



// NEW: Показ меню при потере фокуса
                        function onSumInputBlur(input) {
            document.body.classList.remove('input-focused');
            
            if (input.value === "") {
                const currencyGold = document.getElementById('currencySymbol');
                const currencyGray = document.getElementById('currencyPlaceholder');
                
                if(currencyGold) currencyGold.style.display = 'none';
                if(currencyGray) currencyGray.style.display = 'block';
                
                input.style.width = '150px'; // Ширина для ВВЕДИТЕ СУММУ
            }
        }



            function formatSumInput(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/^0+/, '') || '';
            const numericValue = parseInt(value) || 0;
            
            const currencyGold = document.getElementById('currencySymbol');
            const currencyGray = document.getElementById('currencyPlaceholder');
            
            if (value.length > 0) {
                // ЕСТЬ ВВОД
                input.value = numericValue.toLocaleString('ru-RU').replace(/\s/g, '.');
                
                // Включаем золото, ВЫРУБАЕМ серый
                if(currencyGold) currencyGold.style.display = 'block';
                if(currencyGray) currencyGray.style.display = 'none';
                
                // Растягиваем инпут под контент
                adjustInputWidth(input);
            } else {
                // ПУСТО (Плейсхолдер)
                input.value = "";
                
                // Включаем серый, ВЫРУБАЕМ золото
                if(currencyGold) currencyGold.style.display = 'none';
                if(currencyGray) currencyGray.style.display = 'block';
                
                // Фиксируем ширину для "0.00", чтобы стояло ровно
                input.style.width = '150px'; 
            }
            
            adjustSumInputSize(input);
            draw();
        }


// NEW: Сброс соотношения на 50/50
function resetRatioTo50() {
    document.getElementById('ratioSlider').value = 50;
    
    // Обновляем выделение карточек
    updateStrategyCardSelection(50);
    
    draw();
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

    
// NEW: Выбор стратегии по карточке
// NEW: Выбор стратегии по карточке
// NEW: Выбор стратегии по карточке


// NEW: Обновление выделения карточки при изменении ползунка
function updateStrategyCardSelection(bondPercent) {
    const cards = document.querySelectorAll('.strategy-option-card');
    // Проверяем, включен ли режим "Своя стратегия" (через наличие сохраненных данных)
    const isCustomMode = (savedCustomBonds !== null);

    cards.forEach(card => {
        const cardBondsAttr = card.getAttribute('data-bonds');
        if (!cardBondsAttr) return;

        // ЛОГИКА ДЛЯ "НАСТРОИТЬ СВОЮ"
        if (cardBondsAttr === 'custom') {
            card.style.display = 'flex'; // Всегда видна
            if (isCustomMode) card.classList.add('selected');
            else card.classList.remove('selected');
            return;
        }

        // ЛОГИКА ДЛЯ СТАНДАРТНЫХ КАРТОЧЕК
        if (isCustomMode) {
            // Если выбрана "Своя", показываем все остальные стандартные
            card.style.display = 'flex';
            card.classList.remove('selected');
        } else {
            // Если выбрана стандартная - скрываем ту, что совпадает по процентам
            if (parseInt(cardBondsAttr) === bondPercent) {
                card.style.display = 'none'; // Убираем из списка (уже наверху)
            } else {
                card.style.display = 'flex';
                card.classList.remove('selected');
            }
        }
    });
}
    

// NEW: Обновление кастомного слайдера
function updateCustomSlider(value) {
    const bondPct = parseInt(value);
    updateCustomSliderDisplay(bondPct);
    
    // НЕ обновляем основной слайдер до нажатия "Готово"
}

// NEW: Обновление отображения кастомного слайдера
// Функция обновления отображения (безопасная версия)
function updateCustomSliderDisplay(bondPct) {
    const stockPct = 100 - bondPct;
    
    // Обновляем большие цифры (они есть в новом дизайне)
    const bondDisplay = document.getElementById('customBondsDisplay');
    const stockDisplay = document.getElementById('customStocksDisplay');
    
    if (bondDisplay) bondDisplay.textContent = bondPct;
    if (stockDisplay) stockDisplay.textContent = stockPct;
    
    // Пытаемся обновить старые подписи (если они вдруг остались), но не ломаем код, если их нет
    const oldBondLabel = document.getElementById('customBondsPct');
    const oldStockLabel = document.getElementById('customStocksPct');
    if (oldBondLabel) oldBondLabel.textContent = bondPct;
    if (oldStockLabel) oldStockLabel.textContent = stockPct;
    
    // Обновляем индикатор точек
    updateDotsIndicator(bondPct);
}


    // NEW: Обновление индикатора точек
function updateDotsIndicator(bondPct) {
    const dots = document.querySelectorAll('.custom-dot');
    const thresholds = [0, 25, 50, 75, 100];
    
    // Находим ближайший порог
    let closestIndex = 0;
    let minDiff = Math.abs(bondPct - thresholds[0]);
    
    thresholds.forEach((threshold, index) => {
        const diff = Math.abs(bondPct - threshold);
        if (diff < minDiff) {
            minDiff = diff;
            closestIndex = index;
        }
    });
    
    dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === closestIndex);
    });
}

    // NEW: Сохранение кастомной стратегии
function saveCustomStrategy() {
    const bondPct = parseInt(document.getElementById('customRatioSlider').value);
    const stockPct = 100 - bondPct;
    
    // Сохраняем значения
    savedCustomBonds = bondPct;
    savedCustomStocks = stockPct;
    
    // Обновляем основной слайдер
    document.getElementById('ratioSlider').value = bondPct;
    
    // Обновляем отображение кастомной карточки
    updateCustomCardDisplay(bondPct, stockPct);
    
    // Закрываем панель настройки
    const expandedBlock = document.getElementById('customStrategyExpanded');
    expandedBlock.classList.remove('show');
    
    // Оставляем карточку выбранной
    const customCard = document.getElementById('customStrategyCard');
    customCard.classList.add('selected');
    
    // Перерисовываем
    draw();
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}

    // NEW: Обновление отображения кастомной карточки после сохранения
function updateCustomCardDisplay(bondPct, stockPct) {
    const customCard = document.getElementById('customStrategyCard');
    const indicator = document.getElementById('customIndicator');
    const subtitle = document.getElementById('customSubtitle');
    const bondsText = document.getElementById('customCardBonds');
    const stocksText = document.getElementById('customCardStocks');
    
    // Добавляем класс сохранённого состояния
    customCard.classList.add('has-saved');
    
    // Устанавливаем градиент индикатора
    indicator.style.background = `linear-gradient(180deg, #5B7C99 0%, #5B7C99 ${bondPct}%, #94A8B8 ${bondPct}%, #94A8B8 100%)`;
    
    // Меняем подзаголовок
    subtitle.textContent = 'Индивидуальная';
    
    // Обновляем проценты
    bondsText.textContent = `Обл. ${bondPct}%`;
    stocksText.textContent = `Акц. ${stockPct}%`;
}

    // NEW: Сброс отображения кастомной карточки
function resetCustomCardDisplay() {
    const customCard = document.getElementById('customStrategyCard');
    const subtitle = document.getElementById('customSubtitle');
    
    // Убираем класс сохранённого состояния
    customCard.classList.remove('has-saved');
    
    // Возвращаем подзаголовок
    subtitle.textContent = 'Выберите своё соотношение';
    
    // Сбрасываем сохранённые значения
    savedCustomBonds = null;
    savedCustomStocks = null;
}

// NEW: Кнопки +/- для кастомной стратегии
function adjustCustomRatio(delta) {
    const slider = document.getElementById('customRatioSlider');
    if (!slider) return;
    
    let newValue = parseInt(slider.value) + delta;
    newValue = Math.max(0, Math.min(100, newValue));
    
    slider.value = newValue;
    updateCustomSliderDisplay(newValue); // Вызываем нашу новую безопасную функцию
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}


    

// NEW: Сброс кастомной стратегии на 50/50
function resetCustomTo50() {
    document.getElementById('customRatioSlider').value = 50;
    updateCustomSliderDisplay(50);
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}
        function toggleRow(el) {
    el.classList.toggle('is-expanded');
}

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.innerText = `Скопировано: ${text}`;
                toast.className = "toast show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
            });
        }
        
        function copyTicker(e, text) {
            e.stopPropagation();
            copyToClipboard(text);
        }
        
        function openTradingView(e, ticker) {
            e.stopPropagation();
            const url = `https://ru.tradingview.com/chart/?symbol=MOEX:${ticker}`;
            window.open(url, '_blank');
        }

        async function fetchBondData(code) {
    if (!code) return { nkd: 0, matDate: '—', price: 0 };
    
    // Проверяем кэш
    if (bondDataCache[code]) {
        return bondDataCache[code];
    }
    
    try {
        const res = await fetch(`https://iss.moex.com/iss/engines/stock/markets/bonds/securities/${code}.json?iss.meta=off&iss.only=securities,marketdata`);
        const data = await res.json(); 
        
        const sec_cols = data.securities.columns; 
        const sec_row = data.securities.data[0];
        
        let lastPrice = 0;
        
        if (data.marketdata && data.marketdata.data.length > 0) {
             const m_cols = data.marketdata.columns;
             const m_row = data.marketdata.data[0];
             const lastIdx = m_cols.indexOf('LAST');
             const prevIdx = m_cols.indexOf('PREVPRICE');

             if (lastIdx !== -1 && m_row[lastIdx]) {
                lastPrice = m_row[lastIdx];
             } 
             else if (prevIdx !== -1 && m_row[prevIdx]) {
                lastPrice = m_row[prevIdx];
             }
        }
        
        if (!lastPrice && sec_row) {
             const prevPriceIdx = sec_cols.indexOf('PREVPRICE');
             if (prevPriceIdx !== -1 && sec_row[prevPriceIdx]) {
                 lastPrice = sec_row[prevPriceIdx];
             }
        }

        bondCouponsMap[code] = { date: sec_row[sec_cols.indexOf('NEXTCOUPON')], value: parseFloat(sec_row[sec_cols.indexOf('COUPONVALUE')]) || 0 };
        
        const couponPeriod = parseFloat(sec_row[sec_cols.indexOf('COUPONPERIOD')]) || 0;
        const freq = couponPeriod > 0 ? Math.round(365 / couponPeriod) : 0;
        bondDetailsMap[code] = {
            matDate: sec_row[sec_cols.indexOf('MATDATE')] || '—',
            couponValue: parseFloat(sec_row[sec_cols.indexOf('COUPONVALUE')]) || 0,
            nextCoupon: sec_row[sec_cols.indexOf('NEXTCOUPON')] || '—',
            couponYield: sec_row[sec_cols.indexOf('COUPONPERCENT')] || '—',
            freq: freq
        };

        const result = { 
            nkd: parseFloat(sec_row[sec_cols.indexOf('ACCRUEDINT')]) || 0, 
            matDate: sec_row[sec_cols.indexOf('MATDATE')] || '—', 
            price: lastPrice
        };
        
        // Сохраняем в кэш
        bondDataCache[code] = result;
        
        return result;
    } catch (e) { 
        console.error(`Failed to fetch data for ticker: ${code}`, e);
        return { nkd: 0, matDate: '—', price: 0 }; 
    }
}

    async function loadCompanyDescriptions() {
    try {
        const response = await fetch(CSV_DESCRIPTIONS_URL);
        if (!response.ok) return;
        
        const text = await response.text();
        const rows = text.split('\n').map(row => 
            row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim())
        );
        
        for (let i = 1; i < rows.length; i++) {
            if (rows[i] && rows[i].length > 8) {
                const ticker = rows[i][4] ? String(rows[i][4]).trim() : null;
                const description = rows[i][8] ? String(rows[i][8]).trim() : '';
                if (ticker && description) {
                    companyDescriptions[ticker] = description;
                }
            }
        }
        console.log('Описания загружены:', Object.keys(companyDescriptions).length);
    } catch (e) {
        console.error('Ошибка загрузки описаний:', e);
    }
}

        async function loadData() {
            initTheme();
            checkFirstVisit();
            updateMarketData();
            loadCompanyDescriptions();
            //updateMarketStatus(); // Временно отключаем, т.к. элемент не существует
            
            try {
    console.log('Fetching data from:', CSV_URL);
    const response = await fetch(CSV_URL, {
        method: 'GET',
        mode: 'cors',
        cache: 'no-cache'
    });
    
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const text = await response.text();
    console.log('Data loaded successfully, length:', text.length);
                // 1. Парсим CSV в массив строк (ЭТА СТРОКА ОБЯЗАТЕЛЬНА)
                const rows = text.split('\n').map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim()));

                // 2. Вертикаль ставок (обновление данных из таблицы)
                if (rows.length > 1 && rows[1].length > 42) {
                    const keyRateVal = rows[1][42]; 
                    if (keyRateVal) ratesData.keyRate = keyRateVal.includes('%') ? keyRateVal : keyRateVal + '%';
                }
                if (rows.length > 2 && rows[2].length > 42) {
                    const depositRateVal = rows[2][42];
                    if (depositRateVal) ratesData.depositRate = depositRateVal.includes('%') ? depositRateVal : depositRateVal + '%';
                }
                if (rows.length > 3 && rows[3].length > 42) {
                    const inflationVal = rows[3][42];
                    if (inflationVal) ratesData.inflation = inflationVal.includes('%') ? inflationVal : inflationVal + '%';
                }
                if (rows.length > 4 && rows[4].length > 42) {  
                    const ofz10Val = rows[4][42];
                    if (ofz10Val) ratesData.ofz10 = ofz10Val.includes('%') ? ofz10Val : ofz10Val + '%';
                }
                updateRatesDisplay();

                // 3. Загрузка Облигаций (3 вкладка)
                let bondList = [];
                for (let i = 2; i <= 9; i++) { 
                    if (rows[i] && rows[i].length > 13 && rows[i][10]) {
                        bondList.push({ 
                            t: rows[i][10], 
                            n: rows[i][11], 
                            p: parseFloat(rows[i][12].replace(',', '.')) || 0, 
                            y: rows[i][13] || '0%',
                            nkd: 0,
                            matDate: '—'
                        }); 
                    }
                }
                bonds = bondList;
                fetchBondDetailsInBackground();

                // 4. Ежемесячный доход (Калькулятор)
                allScheduledPayments = []; 
                let uniqueBondsMap = new Map();

                for (let i = 2; i <= 13; i++) {
                    if (!rows[i]) continue;
                    const dateVal = rows[i][27] || "---"; 
                    const nameVal = rows[i][28] || "---"; 
                    const couponVal = parseFloat(String(rows[i][29]).replace(',', '.')) || 0; 
                    const ticker = rows[i][31] ? String(rows[i][31]).trim() : ''; 

                    allScheduledPayments.push({
                        dateStr: dateVal,
                        displayName: nameVal,
                        paymentTicker: ticker,
                        staticCouponVal: couponVal
                    });

                    if (ticker && !uniqueBondsMap.has(ticker)) {
                        uniqueBondsMap.set(ticker, {
                            t: ticker,          
                            n: rows[i][32] || ticker, 
                            y: rows[i][33] || "0%",
                            p: 1000, 
                            nkd: 0
                        });
                    }
                }

                monthlyIncomeBonds = Array.from(uniqueBondsMap.values());
                renderMonthlyIncomeCards();
                recalcCustomCoupons();
                fetchPricesForMonthlyIncome();

                // 5. Загрузка Акций (3 вкладка - Портфель)
                let allStocks = [];
                for (let i = 11; i <= 22; i++) { 
                    if (rows[i] && rows[i].length > 13 && rows[i][10]) {
                        allStocks.push({ t: rows[i][10], n: rows[i][11], p: parseFloat(rows[i][12].replace(',', '.')) || 0, target: rows[i][13] || '—' });
                    }
                }
                if (allStocks.length > 0) { 
                    echelons[0].assets = allStocks.slice(0, 3);
                    echelons[1].assets = allStocks.slice(3, 6); 
                    echelons[2].assets = allStocks.slice(6, 9); 
                    echelons[3].assets = allStocks.slice(9, 12);
                }

                // === 6. НОВАЯ ЛОГИКА: 4 Вкладка (Ребалансировка) с поиском имен ===
                
                // Шаг А: Создаем справочник из колонок F, G, H
                const tickerInfo = {};
                for (let i = 2; i < rows.length; i++) { 
                    if (rows[i] && rows[i].length > 7) {
                        const ticker = rows[i][5] ? String(rows[i][5]).trim() : null; 
                        const name = rows[i][6];       
                        const sector = rows[i][7];      
                        if(ticker) {
                            tickerInfo[ticker] = { 
                                n: name || ticker, 
                                sector: sector || '' 
                            };
                        }
                    }
                }

                // Шаг Б: Заполняем таблицу эшелонов данными из справочника
                echelonTableData = [[], [], [], []];
                for (let i = 2; i <= 13; i++) {
                     if (rows[i] && rows[i].length > 23) {
                        
                        // Функция для обработки одной ячейки (чтобы не копировать код 4 раза)
                        const processAsset = (tickerIndex, targetIndex, echelonArrIndex) => {
                            if(rows[i][tickerIndex]) {
                                const rawTicker = String(rows[i][tickerIndex]).trim();
                                // Ищем в справочнике
                                const info = tickerInfo[rawTicker] || { n: rawTicker, sector: '' };
                                
                                echelonTableData[echelonArrIndex].push({ 
                                    t: rawTicker,        
                                    n: info.n,           
                                    sector: info.sector, 
                                    target: rows[i][targetIndex] || '—' 
                                });
                            }
                        };

                        processAsset(16, 17, 0); // I Эшелон
                        processAsset(18, 19, 1); // II Эшелон
                        processAsset(20, 21, 2); // III Эшелон
                        processAsset(22, 23, 3); // IV Эшелон
                    }
                }
                
                distributeMonthlyInvestment();
                updateEchelonTable();
                renderOfzList();
                
                // Не вызываем draw() при первой загрузке, чтобы был виден плейсхолдер
                // draw() вызовется когда пользователь начнет вводить сумму
            } catch (e) { 
                console.error("Error in loadData:", e); 
            }
        }

        // --- MONTHLY INCOME CALCULATOR LOGIC ---
        
        const mInput = document.getElementById('monthlySumInput');
        if(mInput) {
            mInput.addEventListener('focus', () => {
                document.getElementById('navWrapper').style.display = 'none';
                document.querySelector('.header').style.display = 'none';
            });
            mInput.addEventListener('blur', () => {
                document.getElementById('navWrapper').style.display = 'flex';
                document.querySelector('.header').style.display = 'block';
            });
        }

        function changeQty(ticker, delta) {
            const input = document.getElementById(`input-${ticker}`);
            if(input) {
                let val = parseInt(input.value) || 0;
                val = Math.max(0, val + delta);
                input.value = val;
                updateMonthlySumFromQuantities();
            }
        }
        
        function resetOne(ticker) {
             const input = document.getElementById(`input-${ticker}`);
             if(input) {
                 input.value = 0;
                 updateMonthlySumFromQuantities();
             }
        }
        
        function updateMonthlySumFromQuantities() {
            if (isUpdatingProgrammatically) return;
            let totalSum = 0;
            monthlyIncomeBonds.forEach(bond => {
                const input = document.getElementById(`input-${bond.t}`);
                if (input) {
                    const qty = parseInt(input.value) || 0;
                    if (qty > 0) {
                        const fullCost = (bond.p + bond.nkd); 
                        totalSum += qty * fullCost;
                    }
                }
            });

            isUpdatingProgrammatically = true;
            document.getElementById('monthlySumInput').value = Math.round(totalSum);
            isUpdatingProgrammatically = false;

            recalcCustomCoupons(); // <--- ВАЖНОЕ ДОБАВЛЕНИЕ: Обновляем нижний список
        }

        function distributeMonthlyInvestment() {
            if (isUpdatingProgrammatically) return;

            const sumInput = document.getElementById('monthlySumInput');
            const totalSum = parseFloat(sumInput.value) || 0;
            
            // Если сумма 0 или пустая, обнуляем входы и пересчитываем низ
            if (monthlyIncomeBonds.length === 0 || totalSum <= 0) {
                 monthlyIncomeBonds.forEach(bond => {
                    const input = document.getElementById(`input-${bond.t}`);
                    if(input) input.value = 0;
                });
                recalcCustomCoupons(); // <--- ДОБАВЛЕНО
                return;
            };

            const budgetPerBond = totalSum / monthlyIncomeBonds.length;
            let currentTotalSpent = 0;
            
            let calcList = monthlyIncomeBonds.map(b => {
                let yieldNum = parseFloat(b.y.replace(/[^\d.-]/g, '')) || 0;
                let fullPrice = b.p + b.nkd;
                return { ...b, yieldNum, fullPrice, qty: 0, cost: 0 };
            });

            calcList.forEach(bond => {
                if (bond.fullPrice > 0) {
                    bond.qty = Math.floor(budgetPerBond / bond.fullPrice);
                    bond.cost = bond.qty * bond.fullPrice;
                    currentTotalSpent += bond.cost;
                }
            });

            let remainder = totalSum - currentTotalSpent;

            if (remainder > 0) {
                calcList.sort((a,b) => b.yieldNum - a.yieldNum);
                
                for (const bond of calcList) {
                    if (bond.fullPrice > 0 && remainder >= bond.fullPrice) {
                        const extraQty = Math.floor(remainder / bond.fullPrice);
                        if (extraQty > 0) {
                            bond.qty += extraQty;
                            remainder -= extraQty * bond.fullPrice;
                        }
                    }
                }
            }

            isUpdatingProgrammatically = true; 
            calcList.forEach(bond => {
                const input = document.getElementById(`input-${bond.t}`);
                if(input) input.value = bond.qty;
            });
            isUpdatingProgrammatically = false;

            recalcCustomCoupons(); // <--- ВАЖНОЕ ДОБАВЛЕНИЕ: Обновляем нижний список
        }

        // ===== ФУНКЦИЯ 1: Отрисовка карточек =====
function renderMonthlyIncomeCards() {
    const container = document.getElementById('calc-bonds-input-list');
    if(!container) return;
    
    let html = '';
    
    monthlyIncomeBonds.forEach(b => {
        html += `
        <div class="calc-bond-row">
            <div class="unified-badge-container" style="flex-direction:column; align-items:flex-start; gap: 3px;">
                <div class="ub-name" style="width:100%">${limitName(b.n)}</div>
                <div style="font-size:9px; color:#888; margin-top:2px; padding-left:2px;">
                   (Цена: ${b.p.toFixed(2)} + НКД: ${b.nkd.toFixed(2)})
                </div>
            </div>
            
            <div class="ub-yield">${b.y.replace('%', '')}%</div>
            
            <div class="qty-controls">
                <div class="qty-btn" onclick="changeQty('${b.t}', -1)">−</div>
                <input type="number" id="input-${b.t}" class="calc-input" data-ticker="${b.t}" value="0" min="0" oninput="updateMonthlySumFromQuantities()">
                <div class="qty-btn" onclick="changeQty('${b.t}', 1)">+</div>
                
                <div class="btn-row-reset" onclick="resetOne('${b.t}')">
                    <svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}

// ===== ФУНКЦИЯ 2: Загрузка цен с биржи =====
async function fetchPricesForMonthlyIncome() {
    const promises = monthlyIncomeBonds.map(async (bond) => {
        try {
            const extra = await fetchBondData(bond.t);
            bond.p = extra.price || 1000;
            bond.nkd = extra.nkd || 0;
        } catch(e) {
            console.log("Error fetching price for", bond.t);
        }
    });
    
    await Promise.all(promises);
    renderMonthlyIncomeCards();
}
// ===== ФУНКЦИЯ 3: Пересчёт выплат (ИСПРАВЛЕННАЯ) =====
function recalcCustomCoupons() {
    const resultList = document.getElementById('calc-results-list');
    const footer = document.getElementById('calc-results-footer');
    if (!resultList) return;
    
    let html = '';
    const bondQtyMap = {};
    let totalAmount = 0;
    
    // Собираем количества из полей ввода
    monthlyIncomeBonds.forEach(bond => {
        const input = document.getElementById(`input-${bond.t}`);
        bondQtyMap[bond.t] = input ? (parseInt(input.value) || 0) : 0;
    });

    // Выводим все 12 строк выплат
    allScheduledPayments.forEach(payment => {
        const qty = bondQtyMap[payment.paymentTicker] || 0;
        const netAmount = (payment.staticCouponVal * qty) * (1 - customTax);
        totalAmount += netAmount;

        html += `
        <div class="coupon-row">
            <div><b>${payment.dateStr}</b></div>
            <div style="color:#8e8e93">${limitName(payment.displayName)}</div>
            <div style="text-align:center">${qty} шт.</div>
            <div style="text-align:right"><b>${Math.round(netAmount)} ₽</b></div>
        </div>`;
    });

    resultList.innerHTML = html || '<div style="text-align:center; padding:15px; color:#aaa;">Введите количество для расчета...</div>';
    
    if (footer) {
        footer.innerHTML = totalAmount > 0 ? `Итого за год: <span style="color:var(--accent-green)">${Math.round(totalAmount).toLocaleString()} ₽</span>` : '';
    }
}

        function resetCustomCalc() {
            isUpdatingProgrammatically = true;
            document.getElementById('monthlySumInput').value = 0;
            isUpdatingProgrammatically = false;
            const inputs = document.querySelectorAll('.calc-input');
            inputs.forEach(input => input.value = 0);
            
            recalcCustomCoupons(); // <--- ДОБАВЛЕНО
            
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

      

        // --- END OF MONTHLY CALC LOGIC ---

        function updateEchelonTable() {
    const body = document.getElementById('echelon-tickers-body');
    if(!body) return;
    let html = '';
    const maxRows = Math.max(...echelonTableData.map(col => col.length));
    
    for(let i=0; i<maxRows; i++) {
        // Основная строка с ячейками
        html += '<tr>';
        for(let j=0; j<4; j++) {
            const asset = echelonTableData[j][i];
            if(asset) {
                // Убираем знак рубля из отображения в ячейке
                const priceDisplay = asset.target.replace(' ₽', '');
                html += `
                <td class="et-cell" onclick="toggleEchelonCell('${i}-${j}')">
                    <div class="et-cell-content">
                        <span class="et-ticker">${asset.t}</span>
                        <span class="et-price">${priceDisplay}</span>
                    </div>
                </td>`;
            } else {
                html += '<td class="et-cell-empty"></td>';
            }
        }
        html += '</tr>';
        
        // Скрытая строка с деталями
        html += `<tr class="et-details-row" id="details-row-${i}" style="display:none;">
            <td colspan="4" class="et-details-container">
                <div id="details-content-${i}"></div>
            </td>
        </tr>`;
    }
    body.innerHTML = html;
}


    function toggleEchelonCell(cellId) {
    const [row, col] = cellId.split('-').map(Number);
    const detailsRow = document.getElementById(`details-row-${row}`);
    const detailsContent = document.getElementById(`details-content-${row}`);
    
    // Закрываем все остальные открытые строки
    document.querySelectorAll('.et-details-row').forEach(r => {
        if(r.id !== `details-row-${row}`) {
            r.style.display = 'none';
        }
    });
    
    // Переключаем текущую строку
    if(detailsRow.style.display === 'none') {
        // НОВОЕ: Раскрываем таблицу автоматически
        const wrapper = document.getElementById('echelon-wrapper');
        const expandBtn = document.getElementById('expandArrowBtn');
        if(wrapper && wrapper.classList.contains('collapsed')) {
            wrapper.classList.remove('collapsed');
            if(expandBtn) expandBtn.classList.add('open');
        }
        
        // Получаем данные актива
        const asset = echelonTableData[col][row];
        if(!asset) return;
        
        // Берём название компании из самого asset (уже загружено из колонки G)
const companyName = asset.n || asset.t;
        
        // Определяем эшелон
        const echelonNum = col + 1;
        const echelonName = ['I Эшелон', 'II Эшелон', 'III Эшелон', 'IV Эшелон'][col];
        
        // Формируем контент для деталей
        detailsContent.innerHTML = `
            <div class="et-expanded-details">
                <div class="et-details-header">
                    <div class="et-details-title">
                        <span class="et-details-ticker">${asset.t}</span>
                        <span class="et-details-echelon">${echelonName}</span>
                    </div>
                </div>
               <div style="margin-bottom: 16px;">
    <div style="background: linear-gradient(135deg, var(--bg-color), var(--card-bg)); padding: 16px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 12px; box-shadow: 0 2px 8px var(--card-shadow);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Компания</div>
            <div style="background: var(--accent-blue); color: white; font-size: 9px; font-weight: 700; padding: 4px 10px; border-radius: 8px; text-transform: uppercase; letter-spacing: 0.5px;">${echelonName}</div>
        </div>
        <div style="font-size: 16px; font-weight: 800; color: var(--text-main); line-height: 1.4; margin-bottom: 8px;">${companyName}</div>
        ${asset.sector ? `<div style="display: inline-flex; align-items: center; gap: 6px; background: rgba(52, 152, 219, 0.1); color: var(--accent-blue); font-size: 11px; font-weight: 600; padding: 6px 12px; border-radius: 8px; margin-top: 4px;">
            <svg style="width: 14px; height: 14px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            ${asset.sector}
        </div>` : ''}
    </div>
    
    <div class="et-details-grid">
        <div class="et-detail-item">
            <span class="et-detail-label">Тикер:</span>
            <span class="et-detail-value" style="cursor:pointer; color:var(--accent-blue);" onclick="copyTicker(event, '${asset.t}')">${asset.t} 📋</span>
        </div>
        <div class="et-detail-item">
            <span class="et-detail-label">Цель:</span>
            <span class="et-detail-value">${asset.target}</span>
        </div>
        <div class="et-detail-item">
            <span class="et-detail-label">Прогноз:</span>
            <span class="et-detail-value">до 36 мес.</span>
        </div>
    </div>
</div>
                <div class="et-details-actions">
                    <button class="et-btn-chart" onclick="openTradingView(event, '${asset.t}')">
                        <svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                        График
                    </button>
                    <button class="et-btn-company" onclick="openCompanyFromTable(event, '${asset.t}', '${companyName}')">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        О компании
                    </button>
                </div>
            </div>
        `;
        detailsRow.style.display = 'table-row';
        
       // НОВОЕ: Плавная прокрутка с отступом от нижнего меню
setTimeout(() => {
    const rect = detailsRow.getBoundingClientRect();
    const offset = 150; // Высота меню + отступ
    const elementTop = rect.top + window.pageYOffset;
    const offsetPosition = elementTop - offset;
    
    window.scrollTo({
        top: offsetPosition,
        behavior: 'smooth'
    });
}, 100);
        
    } else {
        detailsRow.style.display = 'none';
    }
}

function openCompanyFromTable(event, ticker, companyName) {
    event.stopPropagation();
    // Ищем полную информацию об активе
    let foundAsset = null;
    
    // Сначала ищем в основных эшелонах
    for(let e of echelons) {
        const found = e.assets.find(a => a.t === ticker);
        if(found) {
            foundAsset = found;
            break;
        }
    }
    
    // Если не нашли, создаем минимальный объект
    if(!foundAsset) {
        for(let i = 0; i < echelonTableData.length; i++) {
            const found = echelonTableData[i].find(a => a.t === ticker);
            if(found) {
                foundAsset = {
                    t: found.t,
                    n: companyName || found.t,
                    p: 0,
                    target: found.target
                };
                break;
            }
        }
    }
    
    if(foundAsset) {
        const item = {
            ...foundAsset,
            type: 'Акция'
        };
        openCompanyPage(item);
    }
}
    
    function renderOfzList() {
    console.log('renderOfzList called, bonds:', bonds.length);
    if (bonds.length === 0) {
        console.log('No bonds to render');
        return;
    }
    
    let ofzHtml = '';
    bonds.forEach(b => {
        const details = bondDetailsMap[b.t] || { matDate:'—', couponValue:0, nextCoupon:'—', couponYield:'—', freq:0 };
        const calculatedCY = (b.p > 0 && details.couponValue && details.freq) ? ((details.couponValue * details.freq) / b.p * 100).toFixed(2) : '0.00';
        ofzHtml += `
        <div class="ofz-card-modern" onclick="toggleOfzDetails('details-${b.t}')">
            <div class="ofz-main-info">
                <div class="ofz-name-lg">${limitName(b.n)}</div>
                <div class="ofz-ticker-sm">${b.t}</div>
            </div>
            <div class="ofz-price">${b.p}</div>
            <div class="ofz-nkd-badge">${Math.round(b.nkd*10)/10}</div>
            <div class="ofz-yield-badge" title="Доходность к погашению">
                ${b.y} <svg class="ofz-arrow" viewBox="0 0 24 24"><path d="M7 17l9.2-9.2M17 17V7H7"/></svg>
            </div>
        </div>
        <div id="details-${b.t}" class="ofz-details-panel">
            <div class="ofz-detail-row"><span>Код:</span> <span class="ofz-detail-val">${b.t}</span></div>
            <div class="ofz-detail-row"><span>НКД:</span> <span class="ofz-detail-val">${b.nkd.toFixed(2)} ₽</span></div>
            <div class="ofz-detail-row"><span>Дата погашения:</span> <span class="ofz-detail-val">${details.matDate}</span></div>
            <div class="ofz-detail-row"><span>Размер купона:</span> <span class="ofz-detail-val">${details.couponValue} ₽</span></div>
            <div class="ofz-detail-row"><span>Дата ближайшего купона:</span> <span class="ofz-detail-val">${details.nextCoupon}</span></div>
            <div class="ofz-detail-row"><span>Текущая купонная доходность:</span> <span class="ofz-detail-val">${calculatedCY}%</span></div>
            <div class="ofz-detail-row"><span>Выплат в год:</span> <span class="ofz-detail-val">${details.freq}</span></div>
        </div>`;
    });
    
    const ofzListElement = document.getElementById('ofz-list');
    console.log('ofz-list element:', ofzListElement);
    if(ofzListElement) {
        ofzListElement.innerHTML = ofzHtml;
        console.log('ОФЗ список обновлён, элементов:', bonds.length);
    } else {
        console.error('ofz-list element not found!');
    }
}


    async function fetchBondDetailsInBackground() {
    const promises = bonds.map(async (b) => {
        try {
            const extra = await fetchBondData(b.t);
            b.nkd = extra.nkd || 0;
            b.matDate = extra.matDate || '—';
        } catch(e) {
            console.log("Error fetching", b.t);
        }
    });
    
    await Promise.all(promises);
    
    // После загрузки обновляем отображение
    renderOfzList();
    draw();
}

        function performSearch(query) {
    if(!query || query.length < 2) {
        openCompanyPage(null, query);
        return;
    }
    
    const q = query.toUpperCase();
    let results = [];
    
    // 1. Ищем в акциях портфеля (12 шт)
    echelons.forEach(e => {
        e.assets.forEach(a => {
            if(a.t.toUpperCase().includes(q) || a.n.toUpperCase().includes(q)) {
                results.push({...a, type: 'Акция'});
            }
        });
    });
    
    // 2. Ищем в ОФЗ портфеля (8 шт)
    bonds.forEach(b => {
        if(b.t.toUpperCase().includes(q) || b.n.toUpperCase().includes(q)) {
            results.push({...b, type: 'Облигация'});
        }
    });
    
    // 3. НОВОЕ: Ищем в таблице эшелонов (до 48 акций)
    echelonTableData.forEach((column, echelonIndex) => {
        column.forEach(asset => {
            // Проверяем, что актив ещё не добавлен
            const alreadyAdded = results.some(r => r.t === asset.t);
            if (!alreadyAdded && (asset.t.toUpperCase().includes(q) || asset.n.toUpperCase().includes(q))) {
                results.push({
                    ...asset,
                    type: 'Акция',
                    p: 0 // Цена будет загружена в openCompanyPage
                });
            }
        });
    });
    
    const input = document.getElementById('tickerSearchInput');
    input.value = '';
    input.blur();
    
    openCompanyPage(results[0] || null, query);
}
        
        async function openCompanyPage(item, searchQuery = '') {
    const content = document.getElementById('company-content');
    const screenCompany = document.getElementById('screen-company');
    
    // Убираем класс активности при закрытии
    screenCompany.classList.remove('company-screen-active');
    
    if(!item) {
        content.innerHTML = `
            <div class="search-empty-state">
                <div class="icon">🔍</div>
                <div class="title">Ничего не найдено</div>
                <div class="desc">По запросу "${searchQuery}" не найдено результатов.<br>Попробуйте изменить запрос.</div>
            </div>
        `;
        showScreen('screen-company');
        return;
    }
    
    const isStock = item.type === 'Акция';
    const target = isStock ? item.target : '-';
    
    // Определяем цвет свечения в зависимости от профита
    let glowColor = 'rgba(46, 204, 113, 0.15)'; // зелёный по умолчанию
    let changeClass = 'neutral';
    let changeText = '--';
    let changePercent = 0;
    
    // Загружаем данные о цене и изменении
    try {
        const url = `https://iss.moex.com/iss/engines/stock/markets/${isStock ? 'shares' : 'bonds'}/securities/${item.t}.json?iss.meta=off&iss.only=securities,marketdata`;
        const res = await fetch(url);
        const data = await res.json();
        const marketdata = data.marketdata.data[0];
        const marketcols = data.marketdata.columns;
        const last = marketdata[marketcols.indexOf('LAST')];
        const open = marketdata[marketcols.indexOf('OPEN')];
        
        if (last && open && open > 0) {
            const change = last - open;
            changePercent = (change / open) * 100;
            const sign = change > 0 ? '+' : '';
            
            if (change > 0) {
                changeClass = 'positive';
                glowColor = 'rgba(46, 204, 113, 0.15)';
                changeText = `${sign}${change.toFixed(2)} ₽ (${sign}${changePercent.toFixed(2)}%)`;
            } else if (change < 0) {
                changeClass = 'negative';
                glowColor = 'rgba(231, 76, 60, 0.15)';
                changeText = `${change.toFixed(2)} ₽ (${changePercent.toFixed(2)}%)`;
            } else {
                changeClass = 'neutral';
                changeText = '0.00 ₽ (0.00%)';
            }
        }
    } catch (e) { 
        console.log('Error fetching company details'); 
    }
    
    // Устанавливаем цвет свечения
    screenCompany.style.setProperty('--glow-color', glowColor);
    screenCompany.classList.add('company-screen-active');
    
    // Определяем эшелон для акций
    let echelonNum = 0;
    let echelonName = '';
    if (isStock) {
        echelonNum = echelons.findIndex(e => e.assets.some(a => a.t === item.t)) + 1;
        if (echelonNum > 0) {
            echelonName = ['I Эшелон', 'II Эшелон', 'III Эшелон', 'IV Эшелон'][echelonNum - 1];
        }
    }
    
    // Рассчитываем прогресс к цели (для акций)
    let progressPercent = 0;
    if (isStock && item.target) {
        const targetPrice = parseFloat(item.target.replace(/[^\d.]/g, '')) || 0;
        if (targetPrice > 0 && item.p > 0) {
            progressPercent = Math.min((item.p / targetPrice) * 100, 100);
        }
    }
    
    // Определяем уровень риска
    const riskLevels = ['Низкий', 'Умеренный', 'Средний', 'Высокий'];
    const riskLevel = isStock ? riskLevels[Math.min(echelonNum - 1, 3)] || 'Н/Д' : 'Низкий';
    
    // Генерируем SVG мини-тренд (случайный для демо)
    const trendPoints = generateTrendLine(changePercent >= 0);
    const trendColor = changePercent >= 0 ? '#2ecc71' : '#e74c3c';
    
    // Формируем HTML
    let html = `
        <!-- Верхняя панель -->
        <div class="company-top-bar">
            <div class="company-back-btn" onclick="goBackFromCompany()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </div>
            <div class="company-ticker-badge">
                <span class="ticker-dot"></span>
                <span>${item.t}</span>
                <span style="opacity: 0.5;">•</span>
                <span style="opacity: 0.7;">MOEX</span>
            </div>
        </div>
        
        <!-- Hero секция -->
        <div class="company-hero">
            <div class="company-hero-name">${item.n}</div>
            <div class="company-hero-price">${item.p.toLocaleString('ru-RU')} ₽</div>
            <div class="company-hero-change ${changeClass}">
                ${changeClass === 'positive' ? '↑' : changeClass === 'negative' ? '↓' : '→'} ${changeText}
            </div>
            
            <!-- SVG мини-тренд -->
            <div class="company-trend-svg">
                <svg width="200" height="50" viewBox="0 0 200 50">
                    <defs>
                        <linearGradient id="trendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:${trendColor};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${trendColor};stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <polyline class="trend-line" fill="none" stroke="url(#trendGradient)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="${trendPoints}" />
                </svg>
            </div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="company-actions">
            <button class="company-action-btn primary" onclick="openTradingView(event, '${item.t}')">
                <svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                График
            </button>
            <button class="company-action-btn" onclick="copyTicker(event, '${item.t}')">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                История див.
            </button>
        </div>
        
        <!-- Описание актива -->
        ${companyDescriptions[item.t] ? `
        <div class="glass-card company-description-section">
            <div class="company-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                Описание актива
            </div>
            <div class="company-description-text">
                ${highlightKeywords(companyDescriptions[item.t])}
            </div>
        </div>
        ` : ''}
        
        <!-- Аналитика -->
        <div class="company-section-title" style="padding: 0 4px; margin-bottom: 12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
            </svg>
            Аналитика
        </div>
        <div class="analytics-grid">
            <div class="analytics-tile tile-forecast">
                <div class="analytics-tile-label">Target Forecast</div>
                <div class="analytics-tile-value">${isStock ? target.replace(' ₽', '') : item.y}</div>
                <div class="analytics-tile-sub">${isStock ? 'Целевая цена' : 'Доходность к погашению'}</div>
                ${isStock ? `
                <div class="forecast-progress">
                    <div class="forecast-progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                ` : ''}
            </div>
            
            <div class="analytics-tile tile-dividends">
                <div class="analytics-tile-label">Dividends</div>
                <div class="analytics-tile-value">${isStock ? (echelonNum <= 2 ? 'Да' : 'Нет') : 'Купоны'}</div>
                <div class="analytics-tile-sub">${isStock ? 'Выплата дивидендов' : 'Регулярные выплаты'}</div>
            </div>
            
            <div class="analytics-tile tile-risk">
                <div class="analytics-tile-label">Risk Tier</div>
                <div class="analytics-tile-value">${riskLevel}</div>
                <div class="analytics-tile-sub">${isStock ? echelonName || 'Не определён' : 'ОФЗ - гос. гарантия'}</div>
            </div>
            
            <div class="analytics-tile tile-cap">
                <div class="analytics-tile-label">Market Cap</div>
                <div class="analytics-tile-value">${isStock ? 'Large' : 'Gov'}</div>
                <div class="analytics-tile-sub">${isStock ? 'Капитализация' : 'Государственная'}</div>
            </div>
        </div>
        
       <!-- События терминала (новости) -->
        <div class="glass-card events-section">
            <div class="company-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Новости Smart-Lab
            </div>
            
            <div id="company-news-list">
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                    Загрузка новостей...
                </div>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
            // Загружаем новости асинхронно после отрисовки страницы
    loadAndDisplayNews(item.t);
    showScreen('screen-company');
}

    // Функция загрузки и отображения новостей
async function loadAndDisplayNews(ticker) {
    const newsContainer = document.getElementById('company-news-list');
    if (!newsContainer) return;
    
    // Показываем загрузку
    newsContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
            <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
            Загрузка новостей для ${ticker}...
        </div>
    `;
    
    // Загружаем новости
    const news = await loadNewsForTicker(ticker);
    
    // Если новостей нет
    if (!news || news.length === 0) {
        newsContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <div style="font-size: 24px; margin-bottom: 10px;">📭</div>
                Новостей по ${ticker} пока нет
            </div>
        `;
        return;
    }
    
    // Формируем HTML для новостей
    let html = '';
    news.forEach((item) => {
        // Парсим реальную дату из ответа API
        const newsDate = new Date(item.date);
        
        // Проверяем валидность даты
        const isValidDate = !isNaN(newsDate.getTime());
        const displayDate = isValidDate ? newsDate : new Date();
        
        // Форматируем относительную дату для описания
        const relativeDate = getRelativeDateText(displayDate);
        
        html += `
            <div class="event-item" onclick="window.open('${item.link}', '_blank')" style="cursor: pointer;">
                <div class="event-date">
                    <span class="event-date-day">${displayDate.getDate()}</span>
                    <span class="event-date-month">${getMonthShort(displayDate.getMonth())}</span>
                </div>
                <div class="event-content">
                    <div class="event-title">${item.title.substring(0, 60)}${item.title.length > 60 ? '...' : ''}</div>
                    <div class="event-description" style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: var(--accent-blue);">Smart-Lab</span>
                        <span>•</span>
                        <span>${relativeDate}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    newsContainer.innerHTML = html;
}

// Функция для получения относительной даты (сегодня, вчера, 3 дня назад и т.д.)
function getRelativeDateText(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    if (diffMinutes < 60) {
        return diffMinutes <= 1 ? 'Только что' : `${diffMinutes} мин. назад`;
    }
    
    if (diffHours < 24) {
        return `${diffHours} ${getHoursWord(diffHours)} назад`;
    }
    
    if (diffDays === 0) return 'Сегодня';
    if (diffDays === 1) return 'Вчера';
    if (diffDays < 7) return `${diffDays} ${getDaysWord(diffDays)} назад`;
    
    // Для более старых новостей показываем полную дату
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
}

// Склонение слова "час"
function getHoursWord(n) {
    if (n === 1 || n === 21) return 'час';
    if (n >= 2 && n <= 4 || n >= 22 && n <= 24) return 'часа';
    return 'часов';
}

// Склонение слова "день"
function getDaysWord(n) {
    if (n === 1) return 'день';
    if (n >= 2 && n <= 4) return 'дня';
    return 'дней';
}

// Вспомогательная функция: генерация точек для SVG тренда
function generateTrendLine(isPositive) {
    let points = [];
    let y = 25;
    
    for (let x = 0; x <= 200; x += 20) {
        // Добавляем случайность, но с общим трендом вверх или вниз
        const randomDelta = (Math.random() - 0.5) * 15;
        const trendDelta = isPositive ? -1.5 : 1.5;
        y = Math.max(5, Math.min(45, y + randomDelta + trendDelta));
        points.push(`${x},${y}`);
    }
    
    return points.join(' ');
}

// Вспомогательная функция: получить короткое название месяца
function getMonthShort(monthIndex) {
    const months = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
    return months[monthIndex];
}

// Вспомогательная функция: выделение ключевых слов в описании
function highlightKeywords(text) {
    // Список ключевых слов для выделения
    const keywords = ['нефтегазовый', 'банк', 'ритейл', 'телеком', 'металлургия', 'энергетика', 'IT', 'технологии', 'добыча', 'производство', 'экспорт', 'дивиденды', 'лидер', 'крупнейший'];
    
    let result = text;
    keywords.forEach(keyword => {
        const regex = new RegExp(`(${keyword})`, 'gi');
        result = result.replace(regex, '<span class="highlight">$1</span>');
    });
    
    return result;
}

      function draw() {
    console.log('draw() called');
    
    // 1. Получаем текущее значение слайдера
    const slider = document.getElementById('ratioSlider');
    if (!slider) return;
    const bondPct = parseInt(slider.value);
    const stockPct = 100 - bondPct;
    
    // 2. СРАЗУ обновляем видимость карточек в списке (скрываем дубликаты)
    updateStrategyCardSelection(bondPct);

    // 3. Получаем введенную сумму
    const inputSum = getSumInputValue();

    // 4. Если сумма 0, обновляем только проценты в центре и выходим
    if (inputSum === 0) {
        if(document.getElementById('labelBondsPct')) {
             document.getElementById('labelBondsPct').innerText = bondPct;
             document.getElementById('labelStocksPct').innerText = stockPct;
        }
        return;
    }
    
    // Дальше идет твоя логика расчетов...
    console.log('Drawing with sum:', inputSum);

    // Обновляем визуальное выделение кнопок-пресетов под кругом
    const presets = document.querySelectorAll('.preset-btn-modern');
    presets.forEach(p => {
         const match = p.getAttribute('onclick').match(/\d+/);
         if(match) {
             const pct = parseInt(match[0]);
             if(pct !== bondPct) p.classList.remove('selected-preset');
             else p.classList.add('selected-preset');
         }
    });


            const bondBudget = (inputSum * bondPct) / 100;
            const stockBudget = (inputSum * stockPct) / 100;
            const feeVal = inputSum * brokerFee;

            if(document.getElementById('labelBondsPct')) {
    document.getElementById('labelBondsPct').innerText = bondPct;
    document.getElementById('labelStocksPct').innerText = stockPct;
    
    const dynamicSubtitle = document.getElementById('dynamicSubtitle');
    if(dynamicSubtitle) {
        dynamicSubtitle.innerText = `Система ${bondPct}/${stockPct}: Денежный Поток и Рост.`;
    }
    
    document.querySelectorAll('.bond-pct-text').forEach(el => el.innerText = bondPct);
                document.querySelectorAll('.stock-pct-text').forEach(el => el.innerText = stockPct);
                const mainChart = document.getElementById('mainChart');
    if(mainChart) {
        mainChart.style.background = `conic-gradient(var(--accent-blue) 0% ${bondPct}%, var(--accent-green) ${bondPct}% 100%)`;
        mainChart.setAttribute('data-pct', `${bondPct}/${stockPct}`);
    }
}

            const bondSection = document.getElementById('section-bonds');
            const couponBox = document.getElementById('couponBox');
            const separator = document.getElementById('section-separator');
            const stockSection = document.getElementById('section-stocks');
            const stockHeader = document.getElementById('header-stocks');
            const footerImportant = document.getElementById('footer-important');
            
            if(bondSection && stockSection) {
                bondSection.style.display = 'block'; couponBox.style.display = 'block';
                separator.style.display = 'flex'; stockSection.style.display = 'block';
                footerImportant.style.display = 'block'; stockHeader.innerText = "2. Растущая часть";
                if (bondPct === 0) {
                    bondSection.style.display = 'none'; couponBox.style.display = 'none';
                    separator.style.display = 'none'; stockHeader.innerText = "1. Растущая часть";
                } else if (bondPct === 100) {
                    stockSection.style.display = 'none'; footerImportant.style.display = 'none';
                    separator.style.display = 'none';
                }
            }

            let actualSpentTotal = 0; let bondQuantities = {};
            let totalBondProjectedIncome = 0;
            let rainData = [];
            
       // === ГЕНЕРАЦИЯ СПИСКА ОБЛИГАЦИЙ (С ПОДСВЕТКОЙ ISIN) ===
            let bHtml = '';
            if (bonds.length > 0) {
                const perBondBudget = bondBudget / bonds.length;
                let bondCalculations = bonds.map(b => { 
                    const fullCostPerUnit = (b.p + b.nkd) * (1 + brokerFee); 
                    let qty = fullCostPerUnit > 0 ? Math.floor(perBondBudget / fullCostPerUnit) : 0; 
                    return { ...b, qty, fullCostPerUnit }; 
                });
                
                let leftover = bondBudget - bondCalculations.reduce((acc, b) => acc + (b.qty * b.fullCostPerUnit), 0);
                if (bondCalculations.length > 0 && leftover >= bondCalculations[0].fullCostPerUnit && bondCalculations[0].fullCostPerUnit > 0) {
                    bondCalculations[0].qty += Math.floor(leftover / bondCalculations[0].fullCostPerUnit);
                }
                
                bondCalculations.forEach(b => {
                    actualSpentTotal += (b.qty * b.fullCostPerUnit); 
                    bondQuantities[b.t] = b.qty;
                    const bondYieldVal = parseFloat(b.y.replace('%', '')) || 0;
                    const investedInBond = b.qty * b.p;
                    totalBondProjectedIncome += (investedInBond * (bondYieldVal / 100) * 3);
                    
                    if(b.qty > 0 && bondCouponsMap[b.t]) {
                        const info = bondCouponsMap[b.t];
                        const netAmount = (info.value * b.qty) * (1 - currentTax);
                        rainData.push({ date: info.date, name: b.n, qty: b.qty, amount: netAmount });
                    }
                    
                    // Данные для деталей
                    const details = bondDetailsMap[b.t] || { matDate:'—', couponValue:0, nextCoupon:'—', couponYield:'—', freq:0 };
                    const calculatedCY = (b.p > 0 && details.couponValue && details.freq) ? ((details.couponValue * details.freq) / b.p * 100).toFixed(2) : '0.00';
                    
                    bHtml += `
                    <div class="portfolio-list-item" onclick="this.classList.toggle('expanded')">
                        <div class="list-item-summary">
                            <span class="list-item-ticker">${limitName(b.n)}</span>
                            <span class="list-item-yield bonds">${b.y}</span>
                            <span class="list-item-qty">${b.qty} шт.</span>
                            <span class="list-item-sum">${Math.round(b.qty * b.p).toLocaleString()} ₽</span>
                        </div>
                        <div class="list-item-details" onclick="event.stopPropagation()">
                            <div class="details-row">
                                <span class="details-row-label">Полное Наименование</span>
                                <span class="details-row-value">${b.n}</span>
                            </div>
                            
                            <!-- ОБНОВЛЕНО: ISIN с подсветкой и иконкой -->
                            <div class="details-row">
                                <span class="details-row-label">ISIN/Код</span>
                                <span class="details-row-value detail-ticker-highlight" onclick="copyTicker(event, '${b.t}')">
                                    ${b.t}
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                </span>
                            </div>
                            
                            <div class="details-row">
                                <span class="details-row-label">Дата погашения</span>
                                <span class="details-row-value">${details.matDate}</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Цена</span>
                                <span class="details-row-value">${b.p} ₽</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">НКД</span>
                                <span class="details-row-value">${b.nkd.toFixed(2)} ₽</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Простая Доходность</span>
                                <span class="details-row-value">${calculatedCY}%</span>
                            </div>
                            
                            <button class="details-btn" onclick="openTradingView(event, '${b.t}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                Открыть график
                            </button>
                        </div>
                    </div>`;
                });
            }



if(document.getElementById('listBonds')) { 
    document.getElementById('listBonds').innerHTML = bHtml;
    
    // Обновляем бейдж суммы облигаций
    const badgeBonds = document.getElementById('badge-bonds-sum');
    if(badgeBonds) badgeBonds.innerText = Math.round(bondBudget).toLocaleString() + ' ₽';
}
            
            if(document.getElementById('couponList')) {
                rainData.sort((a,b) => new Date(a.date) - new Date(b.date));
                let couponHtml = ''; let couponTotal = 0;
                if(rainData.length === 0) { 
                    couponHtml = '<div style="text-align:center; padding:15px; color:#aaa; font-size:12px;">Нет ближайших выплат для выбранных активов.</div>';
                } else { 
                    rainData.forEach(r => { 
                        couponTotal += r.amount; 
                        couponHtml += `
                        <div class="coupon-row">
                            <div><b>${new Date(r.date).toLocaleDateString('ru-RU')}</b></div>
                            <div style="color:#8e8e93">${limitName(r.name)}</div>
                            <div style="text-align:center">${r.qty}шт.</div>
                            <div style="text-align:right"><b>${Math.round(r.amount).toLocaleString()}₽</b></div>
                        </div>`; 
                    }); 
                }
                document.getElementById('couponList').innerHTML = couponHtml;
                document.getElementById('couponTotalHeader').innerText = Math.round(couponTotal).toLocaleString() + ' ₽';
            }
            
            let ofzHtml = '';
            bonds.forEach(b => {
                const details = bondDetailsMap[b.t] || { matDate:'—', couponValue:0, nextCoupon:'—', couponYield:'—', freq:0 };
                const calculatedCY = (b.p > 0 && details.couponValue && details.freq) ? ((details.couponValue * details.freq) / b.p * 100).toFixed(2) : '0.00';
                ofzHtml += `
                <div class="ofz-card-modern" onclick="toggleOfzDetails('details-${b.t}')">
                    <div class="ofz-main-info">
                        <div class="ofz-name-lg">${limitName(b.n)}</div>
                        <div class="ofz-ticker-sm">${b.t}</div>
                    </div>
                    <div class="ofz-price">${b.p}</div>
                    <div class="ofz-nkd-badge">${Math.round(b.nkd*10)/10}</div>
                    <div class="ofz-yield-badge" title="Доходность к погашению">
                        ${b.y} <svg class="ofz-arrow" viewBox="0 0 24 24"><path d="M7 17l9.2-9.2M17 17V7H7"/></svg>
                    </div>
                </div>
                <div id="details-${b.t}" class="ofz-details-panel">
                    <div class="ofz-detail-row"><span>Код:</span> <span class="ofz-detail-val">${b.t}</span></div>
                    <div class="ofz-detail-row"><span>НКД:</span> <span class="ofz-detail-val">${b.nkd.toFixed(2)} ₽</span></div>
                    <div class="ofz-detail-row"><span>Дата погашения:</span> <span class="ofz-detail-val">${details.matDate}</span></div>
                    <div class="ofz-detail-row"><span>Размер купона:</span> <span class="ofz-detail-val">${details.couponValue} ₽</span></div>
                    <div class="ofz-detail-row"><span>Дата ближайшего купона:</span> <span class="ofz-detail-val">${details.nextCoupon}</span></div>
                    <div class="ofz-detail-row"><span>Текущая купонная доходность:</span> <span class="ofz-detail-val">${calculatedCY}%</span></div>
                    <div class="ofz-detail-row"><span>Выплат в год:</span> <span class="ofz-detail-val">${details.freq}</span></div>
                </div>`;
            });
            if(document.getElementById('ofz-list')) document.getElementById('ofz-list').innerHTML = ofzHtml;

                                // === ГЕНЕРАЦИЯ ЭШЕЛОНОВ АКЦИЙ (ФИНАЛЬНЫЙ ВАРИАНТ) ===
            let eHtml = '';
            let totalStockProjectedGrowth = 0;
            let echelonIndex = 0;

            echelons.forEach(e => {
                const echelonBudget = stockBudget * e.weight; 
                const perAssetBudget = e.assets.length > 0 ? echelonBudget / e.assets.length : 0;
                
                let stockCalculations = e.assets.map(a => { 
                    const fullCostPerUnit = a.p * (1 + brokerFee); 
                    let qty = fullCostPerUnit > 0 ? Math.floor(perAssetBudget / fullCostPerUnit) : 0; 
                    return { ...a, qty, fullCostPerUnit }; 
                });
                
                let currentEchelonSpent = stockCalculations.reduce((acc, s) => acc + (s.qty * s.fullCostPerUnit), 0);
                if (stockCalculations.length > 0 && (echelonBudget - currentEchelonSpent) >= stockCalculations[0].fullCostPerUnit) {
                    stockCalculations[0].qty += Math.floor((echelonBudget - currentEchelonSpent) / stockCalculations[0].fullCostPerUnit);
                }
                
                const tipId = `echelon-tip-new-${echelonIndex}`;
                const echelonNum = echelonIndex + 1;
                const echelonLabel = ['I', 'II', 'III', 'IV'][echelonIndex];

                // Цвета для плашек (Зеленый, Синий, Желтый, Оранжевый)
                const colors = [
                    { bg: 'rgba(46, 204, 113, 0.15)', txt: '#27ae60' },
                    { bg: 'rgba(52, 152, 219, 0.15)', txt: '#2980b9' },
                    { bg: 'rgba(241, 196, 15, 0.15)', txt: '#f39c12' },
                    { bg: 'rgba(231, 76, 60, 0.15)', txt: '#d35400' }
                ];
                const c = colors[echelonIndex];
                
                eHtml += `
                <div class="echelon-header-new" onclick="toggleEchelonTip(event, '${tipId}')">
                    <div class="echelon-header-left">
                        <div class="echelon-number e${echelonNum}">${echelonLabel}</div>
                        <!-- ПЛАШКА С НАЗВАНИЕМ -->
                        <span class="echelon-title-new" style="
                            background: ${c.bg}; 
                            color: ${c.txt}; 
                            padding: 4px 10px; 
                            border-radius: 8px; 
                            font-family: 'Inter', sans-serif !important; 
                            font-size: 10px; 
                            font-weight: 800; 
                            text-transform: uppercase; 
                            letter-spacing: 0.5px;
                        ">
                            ${e.title}
                        </span>
                    </div>
                    <div class="echelon-header-right">
                        <span class="echelon-sum">${Math.round(echelonBudget).toLocaleString()} ₽</span>
                        <span class="echelon-percent-badge">${Math.round(e.weight*100)}%</span>
                    </div>
                </div>
                
                <div class="echelon-info-tooltip" id="${tipId}">${e.info}</div>
                
                <div class="portfolio-list">
                    <!-- Заголовки таблицы -->
                    <div class="echelon-columns-header">
                        <span>Компания</span>
                        <span>Цель</span>
                        <span>Кол-во</span>
                        <span>Сумма</span>
                    </div>`;
                
                stockCalculations.forEach(s => {
                    actualSpentTotal += (s.qty * s.fullCostPerUnit);
                    const targetPrice = parseFloat(s.target.replace(/[^\d.]/g,'')) || s.p;
                    if(targetPrice > s.p) totalStockProjectedGrowth += (s.qty * (targetPrice - s.p));
                    
                    eHtml += `
                    <div class="portfolio-list-item" onclick="this.classList.toggle('expanded')">
                        <div class="list-item-summary">
                            <span class="list-item-ticker">${s.t}</span>
                            <span class="list-item-yield stocks">${s.target.replace(' ₽','')}</span>
                            <span class="list-item-qty">${s.qty} шт.</span>
                            <span class="list-item-sum">${Math.round(s.qty * s.p).toLocaleString()} ₽</span>
                        </div>
                        <div class="list-item-details" onclick="event.stopPropagation()">
                            <div class="details-row">
                                <span class="details-row-label">Компания</span>
                                <span class="details-row-value">${s.n}</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Тикер</span>
                                <span class="details-row-value detail-ticker-highlight" onclick="copyTicker(event, '${s.t}')">
                                    ${s.t} 
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                </span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Цена</span>
                                <span class="details-row-value">${s.p} ₽</span>
                            </div>
                            <div class="details-row">
                                <span class="details-row-label">Цель</span>
                                <span class="details-row-value">${s.target}</span>
                            </div>
                            <!-- Примечание статичное -->
                            <div class="details-row" style="border-bottom:none !important; justify-content:center !important; padding-top:6px !important;">
                                <span style="font-size:10px; color:var(--claude-text-secondary); opacity:0.7;">[ Прогноз на период до 36 мес. ]</span>
                            </div>
                            <button class="details-btn" onclick="openTradingView(event, '${s.t}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                Открыть график
                            </button>
                        </div>
                    </div>`;
                });
                
                eHtml += `</div>`; // Закрываем div.portfolio-list
                echelonIndex++;
            });

            // === ОБНОВЛЕНИЕ ИНТЕРФЕЙСА (ОДИН РАЗ, БЕЗ ДУБЛЕЙ) ===
            if(document.getElementById('echelonContainer')) {
                document.getElementById('echelonContainer').innerHTML = eHtml;
                
                // 1. Обновляем бейдж суммы акций (ИСПРАВЛЕНО)
                const badgeStocks = document.getElementById('badge-stocks-sum');
            if(badgeStocks) {
               badgeStocks.innerText = Math.round(stockBudget).toLocaleString() + ' ₽';
               badgeStocks.style.display = 'flex'; // Принудительно
              }

                // 2. Обновляем все остальные цифры
                const valStocks = document.getElementById('valStocks');
                if(valStocks) valStocks.innerText = Math.round(stockBudget).toLocaleString();
                
                const usageFill = document.getElementById('usageFill');
                if(usageFill) usageFill.style.width = Math.min((actualSpentTotal / inputSum) * 100, 100) + '%';
                
                const usageLabelText = document.getElementById('usageLabelText');
                if(usageLabelText) usageLabelText.innerText = Math.round(actualSpentTotal).toLocaleString() + ' ₽';
                
                document.getElementById('summ-invested').innerText = Math.round(inputSum).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                document.getElementById('srl-bond-pct').innerText = bondPct + '%';
                document.getElementById('srl-stock-pct').innerText = stockPct + '%';
                document.getElementById('bar-bond-fill').style.width = bondPct + '%';
                document.getElementById('bar-stock-fill').style.width = stockPct + '%';
                
                const feePercent = (brokerFee * 100).toFixed(2);
                document.getElementById('summ-fee').innerText = feePercent + '%';
                
                document.getElementById('summ-bond-income').innerText = '+' + Math.round(totalBondProjectedIncome).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                document.getElementById('summ-stock-growth').innerText = '+' + Math.round(totalStockProjectedGrowth).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽';
                
                const projectedTotal = inputSum + totalBondProjectedIncome + totalStockProjectedGrowth - feeVal;
                let percentageChange = (inputSum > 0) ? ((projectedTotal - inputSum) / inputSum) * 100 : 0;
                const changeSign = percentageChange >= 0 ? '+' : '';
                const changeColor = percentageChange >= 0 ? '#27ae60' : '#e74c3c';
                const changeHtml = ` <span style="font-size: 14px; color: ${changeColor}; font-weight: 500;">(${changeSign}${percentageChange.toFixed(1)}%)</span>`;
                
                document.getElementById('summ-total-3y').innerHTML = Math.round(projectedTotal).toLocaleString('ru-RU').replace(/\s/g, '.') + ' ₽' + changeHtml;
            }
            
            updateEchelonTable();
            renderOfzList();
        } // Закрытие функции draw


        async function shareAsPDF() {
            const btn = document.getElementById('btnShare');
            const container = document.getElementById('shareContainer');
            const brand = document.getElementById('shareBrand'); 
            const dateEl = document.getElementById('shareDate');
            const originalText = btn.innerHTML;
            btn.innerText = "⏳ Генерация PDF..."; btn.disabled = true; 
            brand.style.display = 'block'; dateEl.innerText = new Date().toLocaleString();
            try {
                const canvas = await html2canvas(container, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color'), scale: 2, logging: false, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                doc.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                const pdfBlob = doc.output('blob');
                if (navigator.share && navigator.canShare) {
                    const file = new File([pdfBlob], "Madame_Solomina_Portfolio.pdf", { type: "application/pdf" });
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: 'Мой портфель', text: 'Расчет от Madame Solomi\'na' });
                        btn.innerHTML = originalText; btn.disabled = false; brand.style.display = 'none'; return;
                    }
                }
                doc.save('Solomina_Portfolio.pdf');
                setTimeout(() => { btn.innerHTML = `✅ Файл скачан`; setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000); }, 500);
            } catch(e) {
                console.error(e); alert("Не удалось открыть меню отправки. Файл будет скачан.");
                btn.innerHTML = originalText; btn.disabled = false;
            } finally { brand.style.display = 'none'; }
        }
    function resetAndGoToTerminal() {
    // Сбрасываем поле ввода суммы
    const sumInput = document.getElementById('sumInput');
    if (sumInput) {
        sumInput.value = '';
    }
    
    // Скрываем символ рубля
    const currencySymbol = document.getElementById('currencySymbol');
    if (currencySymbol) {
        currencySymbol.style.display = 'none';
    }
    
    // Сбрасываем стратегию на Гармонию 50/50
    document.getElementById('ratioSlider').value = 50;
    
    // Убираем selected со всех карточек
    document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('selected'));
    
    // Выбираем Гармонию
    const harmonyCard = document.querySelector('.strategy-card[data-bonds="50"]');
    if (harmonyCard) {
        harmonyCard.classList.add('selected');
    }
    
    // Сбрасываем кастомную стратегию
    resetCustomCardDisplay();
    
    // Скрываем скрытые карточки стратегий
    const hiddenCards = document.getElementById('strategyCardsHidden');
    const trigger = document.getElementById('strategyExpandTrigger');
    if (hiddenCards) hiddenCards.classList.remove('show');
    if (trigger) {
        trigger.classList.remove('open');
        const textEl = trigger.querySelector('.strategy-expand-text');
        if (textEl) textEl.textContent = 'Другие стратегии';
    }
    
    // Скрываем контент портфеля
    document.getElementById('portfolio-content').style.display = 'none';
    document.getElementById('portfolio-empty').style.display = 'flex';
    document.getElementById('portfolioActionPanel').style.display = 'none';
    
    isPortfolioCalculated = false;
    
    // Переходим на экран терминала
    showScreen('screen-app');
    
    // Haptic feedback
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}

    // Регистрация Service Worker для PWA
        if ('serviceWorker' in navigator && location.protocol === 'https:') {
    navigator.serviceWorker.register('./service-worker.js')
        .then(function(registration) {
            console.log('Service Worker зарегистрирован:', registration);
        })
        .catch(function(error) {
            console.log('Ошибка регистрации Service Worker:', error);
        });
} else {
    console.log('Service Worker not registered: not HTTPS or not supported');
}

             // Показываем навигацию принудительно для отладки
             document.getElementById('navWrapper').style.display = 'flex';
        loadData(); 
        if(window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready(); 
            window.Telegram.WebApp.expand();
            
            // Отключаем свайп вниз для закрытия приложения
             window.Telegram.WebApp.disableVerticalSwipes();
        }

        // NEW: Скрыть sticky панель при начальной загрузке если не на screen-app
        setTimeout(() => {
            const stickyPanel = document.getElementById('stickyPanel');
            if (stickyPanel && currentScreen !== 'screen-app') {
                stickyPanel.style.display = 'none';
            }
        }, 100);
 
      /* =================================================================
   SWIPE TO DISMISS (С БЛОКИРОВКОЙ СКРОЛЛА СТРАНИЦЫ)
   ================================================================= */
function initNotificationSwipe() {
    const notify = document.getElementById('luxuryNotification');
    if (!notify) return;

    let startY = 0;
    let diffY = 0;

    // 1. Начало касания
    notify.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
        diffY = 0;
        // Отключаем плавность для мгновенного отклика
        notify.style.transition = 'none';
    }, { passive: false }); // Важно: passive: false

    // 2. Движение пальца
    notify.addEventListener('touchmove', (e) => {
        // === ГЛАВНОЕ ИЗМЕНЕНИЕ ===
        // Запрещаем странице прокручиваться, пока тянем уведомление
        if (e.cancelable) e.preventDefault(); 
        
        const currentY = e.touches[0].clientY;
        diffY = currentY - startY;

        // Разрешаем двигать ТОЛЬКО вверх
        if (diffY < 0) {
            // 60px - это ваш отступ сверху (из CSS)
            notify.style.transform = `translate(-50%, calc(env(safe-area-inset-top) + 60px + ${diffY}px))`;
        }
    }, { passive: false }); // Важно: passive: false разрешает preventDefault

    // 3. Конец касания
    notify.addEventListener('touchend', () => {
        // Возвращаем плавную анимацию
        notify.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
        
        // Сбрасываем инлайн-стиль (возвращаем управление CSS)
        notify.style.transform = ''; 

        // Если смахнули вверх более чем на 10 пикселей - скрываем
        if (diffY < -10) {
            notify.classList.remove('show');
            // Легкая вибрация
            if (window.Telegram?.WebApp?.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        }
        
        startY = 0;
        diffY = 0;
    });
}

initNotificationSwipe();

    /* =================================================================
   GESTURE NAVIGATION: SWIPE BACK (LUXURY PHYSICS)
   ================================================================= */

function initSwipeBack() {
    let startX = 0;
    let startY = 0;
    let currentTranslate = 0;
    let isDragging = false;
    let isEdgeSwipe = false;
    
    // Элементы
    const indicator = document.getElementById('swipeBackIndicator');
    const icon = indicator.querySelector('.sbi-icon-wrapper');
    const triggerZone = 40; // Зона слева (px), где начинается свайп
    
    // Определяем, куда возвращаться
    function getBackTarget() {
        if (currentScreen === 'screen-home') return null; // Со стартовой не уходим
        if (currentScreen === 'screen-company') return 'screen-interesting';
        if (currentScreen === 'screen-app') return 'screen-home';
        // Со всех остальных вкладок возвращаемся в Терминал
        return 'screen-app'; 
    }

    // 1. TOUCH START
    document.addEventListener('touchstart', (e) => {
        const targetScreen = getBackTarget();
        if (!targetScreen) return;

        // Проверяем, что свайп от левого края (чтобы не мешать слайдерам)
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        
        if (startX <= triggerZone) {
            isEdgeSwipe = true;
            isDragging = true;
            
            // Находим активный экран
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                activeScreen.style.transition = 'none'; // Отключаем плавность для прямого управления
            }
            
            // Показываем индикатор
            indicator.classList.add('active');
        }
    }, { passive: true });

    // 2. TOUCH MOVE
    document.addEventListener('touchmove', (e) => {
        if (!isDragging || !isEdgeSwipe) return;

        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;
        const deltaX = x - startX;
        const deltaY = Math.abs(y - startY);

        // Если движение больше вертикальное - отменяем свайп
        if (deltaY > deltaX && deltaX < 20) {
            isDragging = false;
            resetSwipe();
            return;
        }

        // Двигаем экран, но с сопротивлением (logarithmic)
        // Чтобы нельзя было утащить экран слишком далеко без усилия
        const resistance = 0.6; 
        currentTranslate = Math.max(0, deltaX * resistance); 

        const activeScreen = document.querySelector('.screen.active');
        if (activeScreen) {
            // Двигаем экран вправо
            activeScreen.style.transform = `translateX(${currentTranslate}px)`;
            
            // Анимация стрелки (появление и зум)
            // Максимальный прогресс на 150px сдвига
            const progress = Math.min(currentTranslate / 150, 1); 
            
            icon.style.opacity = progress;
            icon.style.transform = `scale(${0.5 + progress * 0.5}) translateX(${-20 + progress * 20}px)`;
            
            // Вибрация при достижении порога срабатывания (один раз)
            if (progress > 0.8 && !icon.dataset.vibrated) {
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.selectionChanged();
                }
                icon.dataset.vibrated = "true";
            } else if (progress < 0.8) {
                icon.dataset.vibrated = "";
            }
        }
    }, { passive: false });

    // 3. TOUCH END
    document.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        isEdgeSwipe = false;

        const activeScreen = document.querySelector('.screen.active');
        const threshold = 100; // Сколько пикселей нужно протащить для срабатывания

        if (activeScreen) {
            // Включаем анимацию обратно
            activeScreen.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
            
            if (currentTranslate > threshold) {
                // === УСПЕШНЫЙ ПЕРЕХОД ===
                const targetId = getBackTarget();
                
                // 1. Досдвигаем экран вправо до конца
                activeScreen.style.transform = `translateX(100%)`;
                
                // 2. Ждем анимацию и переключаем
                setTimeout(() => {
                    activeScreen.style.transform = ''; // Сброс
                    showScreen(targetId); // Переход
                    
                    // Сильная вибрация успеха
                    if (window.Telegram?.WebApp?.HapticFeedback) {
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    }
                }, 200);
                
            } else {
                // === ОТМЕНА (ПРУЖИНА НАЗАД) ===
                activeScreen.style.transform = 'translateX(0)';
            }
        }
        
        // Скрываем индикатор
        indicator.classList.remove('active');
        icon.style.transform = '';
        icon.style.opacity = '';
        icon.dataset.vibrated = "";
    });

    function resetSwipe() {
        const activeScreen = document.querySelector('.screen.active');
        if (activeScreen) {
            activeScreen.style.transition = 'transform 0.3s ease';
            activeScreen.style.transform = 'translateX(0)';
        }
        indicator.classList.remove('active');
    }
}

// Запуск
initSwipeBack();




       
        
        
    </script>
</body>
</html>
